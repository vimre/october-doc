# Introduction

There are two main ways that plugins can configure the system. It is a good idea to first decide which is the best option for your requirements.

- [file-based configuration](./file-settings.md) with no user-interface, stored in the file system.
- [model-based settings](./model-settings.md) with an optional user-interface, stored in the database.

Using model-based settings with backend pages provide a better user experience, but they carry more overhead for the initial development. File-based configuration is suitable for configuration that is rarely modified and has no interface, such as policy configuration.

## Settings Page Registration

When using model-based settings, you may optionally register them with the dedicated area for managing settings and configuration, accessed by clicking the **Settings** link in the main menu.

Settings pages must be registered by overriding the `registerSettings` method inside the [plugin registration file](../extending.md). The method returns an array with a key for each settings item and the value configures the settings model or controller to appear in the settings area. The following is an example of registering a settings model.

```php
public function registerSettings()
{
    return [
        'settings' => [
            'label' => 'User Settings',
            'description' => 'Manage user based settings.',
            'category' => 'CATEGORY_USERS',
            'icon' => 'icon-cog',
            'class' => \Acme\User\Models\UserSetting::class,
        ]
    ];
}
```

### Settings Properties

The following properties are available for each key when registering settings.

Property | Description
------------- | -------------
**label** | specifies the menu label localization string key, required.
**category** | specifies a category label localization string key, for grouping settings pages together, required.
**keywords** | specifies keywords used for searching settings.
**order** | a numerical weight when determining the display order.
**icon** | an icon name from the [October CMS icon collection](../../element/available-icons.md), optional.
**iconSvg** | an SVG icon to be used in place of the standard icon, the SVG icon should be a rectangle and can support colors, optional.
**url** | the backend URL the menu item should refer to, eg. `Backend::url('author/plugin/controller/action')`.
**class** | the model class the settings item should refer to, eg. `Acme\User\Models\UserSetting::class`.
**permissions** | an array of permissions the backend user must have in order to view the menu item (Note: direct access of URLs still requires separate permission checks), optional.
**context** | specifies the placement of the settings item, either `system` or `mysettings`. Default: `system`.
**size** | the settings form size when used with a `class` definition. Supported values: `tiny`, `small`, `medium`, `large`, `huge`, `giant`, `adaptive`. Default: `large`.

For interoperability with other plugins, the following general constants are available for the `category` property.

<div class="content-list" markdown="1">

- CATEGORY_CMS
- CATEGORY_MISC
- CATEGORY_MAIL
- CATEGORY_LOGS
- CATEGORY_SHOP
- CATEGORY_TEAM
- CATEGORY_USERS
- CATEGORY_SOCIAL
- CATEGORY_SYSTEM
- CATEGORY_EVENTS
- CATEGORY_BACKEND
- CATEGORY_CUSTOMERS
- CATEGORY_MYSETTINGS
- CATEGORY_NOTIFICATIONS
- CATEGORY_GLOBALS
- CATEGORY_COLLECTIONS

</div>

The optional `keywords` parameter is used by the settings search feature. If keywords are not provided, the search uses only the settings item label and description.

## Linking to a Model Class

When linking to a model `class` specified in the settings properties, you do not need to build your own controller, and this is useful for the majority of cases. The following example creates a link to a settings model, described more in the [model settings article](./model-settings.md).

```php
public function registerSettings()
{
    return [
        'settings' => [
            'label' => 'User Settings',
            'description' => 'Manage user based settings.',
            'category' => 'Users',
            'icon' => 'icon-cog',
            'class' => \Acme\User\Models\UserSetting::class,
            'order' => 500,
            'keywords' => 'security location',
            'permissions' => ['acme.users.access_settings']
        ]
    ];
}
```

A generic backend controller is used for the form, with basic features like saving and resetting the values to default. Active navigation is configured automatically. Permissions defined are also enforced by the controller.

## Linking to a Controller Class

When specifying a page `url` in the settings properties, you have the option to build your own controller and link it in the settings area. The next example shows how to create a link to a backend page.

```php
public function registerSettings()
{
    return [
        'location' => [
            'label' => 'Locations',
            'description' => 'Manage available user countries and states.',
            'category' => 'Users',
            'icon' => 'icon-globe',
            'url' => Backend::url('acme/user/locations'),
            'order' => 500,
            'keywords' => 'geography place placement'
        ]
    ];
}
```

### Settings Page Class Definition

Settings page controllers can be any [backend controller](../system/controllers.md), except to make things easier, you may extend the `Backend\Classes\SettingsController` base class. This class registers the setting navigation context in the controller automatically. All you need to do is provide the settings code in the `$settingsItemCode` property, used to determine the active menu item.

```php
namespace Acme\Blog\Controllers;

class Posts extends \Backend\Classes\SettingsController
{
    public $settingsItemCode = 'location';

    public function index() {}
}
```

#### See Also

::: also
* [Backend Controllers](../system/controllers.md)
:::
# File Settings

File settings keep setting values stored in files and can be overriden by the environment variables or application files.

## Config File Structure

Plugins can use file-based configuration files in the **config** subdirectory of the plugin directory. Below is an example of the plugin's **config** directory.

::: dir
├── plugins
|   └── acme
|       └── todo
|           └── `config`
|               ├── config.php  _← Configuration File_
|               └── custom.php  _← Configuration File_
:::

The configuration files are PHP scripts that define and return an **array**. The following is an example configuration file **config.php**.

```php
return [
    'maxItems' => 10,
    'display' => 5
];
```

## Accessing Configuration Values

Use the `Config` facade for accessing the configuration values defined in the configuration file. The `get` method accepts the plugin and the configuration name (first argument) in the following format: **acme.demo::maxItems**. You may also define a default value (second argument) to return if the configuration parameter doesn't exist.

```php
$maxItems = Config::get('acme.demo::maxItems', 50);
```

Using a different filename for the configuration file will affects the key name. For example, a configuration file named **custom.php** will prefix the key name with `custom`, using the following format: **acme.demo::custom.maxItems**. The following example is based on a configuration file named **custom.php**.

```php
$maxItems = Config::get('acme.demo::custom.maxItems', 50);
```

## Overriding Configuration Values

A plugin configuration file can be overridden by the application by creating a local configuration file to match, for example, to override **plugins/acme/demo/config/config.php**, create a file called **config/acme/todo/config.php**.


::: dir
├── config
|   └── `acme`
|       └── `todo`
|           └── config.php  _← Override File_
:::

Inside the overridden configuration file you can return only values you want to override.

```php
return [
    'maxItems' => 20
];
```

If you want to use separate configurations across different environments (eg: **dev**, **production**), consider using the `env()` helper to pull the value from an environment variable. The `env()` function accepts the environment variable name (first argument) and an optional default value if the variable doesn't exist (second argument).

```php
<?php

return [
    'maxItems' => env('ACME_TODO_MAX_ITEMS', 25)
];
```

This will change the `maxItems` value when the environment variable `ACME_TODO_MAX_ITEMS` is set to any other value. For example, inside the **.env** file for the application. See the [configuration article](../../setup/configuration.md) to learn how to change these values depending on the environment.

```ini
ACME_TODO_MAX_ITEMS=10
```

#### See Also

::: also
* [Common Configuration](../../setup/configuration.md)
:::
# Model Settings

Model settings keep values stored in the database and can be overriden by the user interface in the backend panel.

## Database Settings

Plugins can use database-driven configuration using models for storing settings in the database by extending the `System\Models\SettingModel` base class. This model can be used directly for creating the backend settings form. You don't need to create a database table and a controller for creating the backend settings forms based on the settings model. An example of a model setting directory structure:

::: dir
├── plugins
|   └── acme
|       └── demo
|           ├── models
|           |   ├── usersetting  _← Config Directory_
|           |   |   └── fields.yaml  _← Form Fields_
|           |   └── `UserSetting.php`  _← Model Class_
|           └── Plugin.php
:::

Settings models can be registered to appear on the [settings area in the backend panel](./settings.md), but it is not a requirement - you can set and read settings values like any other model.

### Model Class Definition

The settings model classes should extend the `System\Models\SettingModel` class, and like any other model, should be defined in the **models** subdirectory of the plugin directory. The model from the next example should be defined in the **plugins/acme/demo/models/UserSetting.php** file.

```php
namespace Acme\Demo\Models;

class UserSetting extends \System\Models\SettingModel
{
    public $settingsCode = 'acme_demo_settings';

    public $settingsFields = 'fields.yaml';
}
```

The `$settingsCode` property is required for settings models. It defines the unique settings key which is used for saving the settings to the database.

The `$settingsFields` property is required if you are going to build a backend settings form based on the model. The property specifies a name of the YAML file containing the form fields definition. The form fields are described in the [form controller article](../forms/form-controller.md). The YAML file should be placed to the directory with the name matching the model class name in lowercase.

## Writing to a Settings Model

The settings model has the static `set` method that allows to save individual or multiple values. You can also use the standard model features for setting the model properties and saving the model.

```php
use Acme\Demo\Models\UserSetting;

// Set a single value
UserSetting::set('api_key', 'ABCD');

// Set an array of values
UserSetting::set(['api_key' => 'ABCD']);

// Set object values
$settings = UserSetting::instance();
$settings->api_key = 'ABCD';
$settings->save();
```

## Reading From a Settings Model

The settings model has the static `get` method that enables you to load individual properties. Also, when you instantiate a model with the `instance` method, it loads the properties from the database and you can access them directly.

```php
// Outputs: ABCD
echo UserSetting::instance()->api_key;

// Get a single value
echo UserSetting::get('api_key');

// Get a value and return a default value if it doesn't exist
echo UserSetting::get('is_activated', true);
```

## Integration with Multisite

Settings models can provide different configuration values for each site defined by [multisite configuration](../../cms/resources/multisite.md). To enable multisite, include the `October\Rain\Database\Traits\Multisite` [trait](../database/traits.md) inside the model and define a `$propagatable` property, which can specify fields that propagate across all sites.

```php
namespace Acme\Demo\Models;

class UserSetting extends \System\Models\SettingModel
{
    use \October\Rain\Database\Traits\Multisite;

    public $settingsCode = 'acme_demo_settings';

    public $settingsFields = 'fields.yaml';

    protected $propagatable = [];
}
```
# Traits

Model traits are used to implement common functionality.

## Attribute Manipulation

### Nullable

Nullable attributes are set to `NULL` when left empty. To nullify attributes in your model, apply the `October\Rain\Database\Traits\Nullable` trait and declare a `$nullable` property with an array containing the attributes to nullify.

```php
class Product extends Model
{
    use \October\Rain\Database\Traits\Nullable;

    protected $nullable = ['sku'];
}
```

### Hashable

Hashed attributes are hashed immediately when the attribute is first set on the model. To hash attributes in your model, apply the `October\Rain\Database\Traits\Hashable` trait and declare a `$hashable` property with an array containing the attributes to hash.

```php
class User extends Model
{
    use \October\Rain\Database\Traits\Hashable;

    protected $hashable = ['password'];
}
```

### Purgeable

Purged attributes will not be saved to the database when a model is created or updated. To purge attributes in your model, apply the `October\Rain\Database\Traits\Purgeable` trait and declare a `$purgeable` property with an array containing the attributes to purge.

```php
class User extends Model
{
    use \October\Rain\Database\Traits\Purgeable;

    protected $purgeable = ['password_confirmation'];
}
```

Use the `getOriginalPurgeValue` to find a value that was purged after the model was saved.

```php
return $user->getOriginalPurgeValue('password_confirmation');
```

Alternatively, use the `restorePurgedValues` method to restore all purged values.

```php
$user->restorePurgedValues();
```

### Encryptable

Similar to the `Hashable` trait, encrypted attributes are encrypted when set but also decrypted when an attribute is retrieved. To encrypt attributes in your model, apply the `October\Rain\Database\Traits\Encryptable` trait and declare a `$encryptable` property with an array containing the attributes to encrypt.

```php
class User extends Model
{
    use \October\Rain\Database\Traits\Encryptable;

    protected $encryptable = ['api_key', 'api_secret'];
}
```

::: warning
Encrypted attributes are not compatible with [jsonable attributes](../system/models.md).
:::

### Sluggable

Slugs are meaningful codes that are commonly used in page URLs. To automatically generate a unique slug for your model, apply the `October\Rain\Database\Traits\Sluggable` trait and declare a `$slugs` property.

```php
class User extends Model
{
    use \October\Rain\Database\Traits\Sluggable;

    protected $slugs = ['slug' => 'name'];
}
```

The `$slugs` property should be an array where the key is the destination column for the slug and the value is the source string used to generate the slug. In the above example, if the `name` column was set to **Cheyenne**, as a result the `slug` column would be set to **cheyenne**, **cheyenne-2**, or **cheyenne-3**, etc before the model is created.

To generate a slug from multiple sources, pass another array as the source value:

```php
protected $slugs = [
    'slug' => ['first_name', 'last_name']
];
```

Slugs are only generated when a model first created. To override or disable this functionality, simply set the slug attribute manually:

```php
$user = new User;
$user->name = 'Remy';
$user->slug = 'custom-slug';
$user->save(); // Slug will not be generated
```

Use the `slugAttributes` method to regenerate slugs when updating a model:

```php
$user = User::find(1);
$user->slug = null;
$user->slugAttributes();
$user->save();
```

## Sorting and Reordering

### Sortable

Sorted models will store a number value in `sort_order` which maintains the sort order of each individual model in a collection. To add the `sort_order` column to your table, you may use the `integer` method inside a migration.

```php
Schema::table('users', function ($table) {
    $table->integer('sort_order')->default(0);
});
```

To store a sort order for your models, apply the `October\Rain\Database\Traits\Sortable` trait and ensure that your schema has a column defined for it to use.

```php
class User extends Model
{
    use \October\Rain\Database\Traits\Sortable;
}
```

You may modify the key name used to identify the sort order by defining the `SORT_ORDER` constant.

```php
const SORT_ORDER = 'my_sort_order_column';
```

Use the `setSortableOrder` method to set the orders on multiple records. The array contains the model identifiers in the sort order that they should appear.

```php
$user->setSortableOrder([3, 2, 1]);
```

If sorting a subset of records, the second array is used to provide a reference pool of sort order values. For example, the following assigns the sort order column as 100, 200 or 300.

```php
$user->setSortableOrder([3, 2, 1], [100, 200, 300]);
```

### Simple Tree

A simple tree model will use the `parent_id` column maintain a parent and child relationship between models. To add the `parent_id` column to your table, you may use the `integer` method inside a migration.

```php
Schema::table('categories', function ($table) {
    $table->integer('parent_id')->nullable()->unsigned();
});
```

To use the simple tree, apply the `October\Rain\Database\Traits\SimpleTree` trait.

```php
class Category extends Model
{
    use \October\Rain\Database\Traits\SimpleTree;
}
```

This trait will automatically inject two [model relations](./relations.md) called `parent` and `children`, it is the equivalent of the following definitions.

```php
public $belongsTo = [
    'parent' => [Category ::class, 'key' => 'parent_id'],
];

public $hasMany = [
    'children' => [Category ::class, 'key' => 'parent_id'],
];
```

You do not need to define these relations yourself, however, you may modify the key name used to identify the parent by defining the `PARENT_ID` constant:

```php
const PARENT_ID = 'my_parent_column';
```

Collections of models that use this trait will return the type of `October\Rain\Database\TreeCollection` which adds the `toNested` method. To build an eager loaded tree structure, return the records with the relations eager loaded.

```php
Category::all()->toNested();
```

#### Rendering

In order to render all levels of items and their children, you can use recursive processing

```twig
{% macro renderChildren(item) %}
    {% if item.children is not empty %}
        <ul>
            {% for child in item.children %}
                <li>{{ child.name }}{{ _self_.renderChildren(child)|raw }}</li>
            {% endfor %}
        </ul>
    {% endif %}
{% endmacro %}

{% import _self as nav %}
{{ nav.renderChildren(category)|raw }}
```

### Nested Tree

The [nested set model](https://en.wikipedia.org/wiki/Nested_set_model) is an advanced technique for maintaining hierachies among models using `parent_id`, `nest_left`, `nest_right`, and `nest_depth` columns. To add these columns to your table, you may use these methods inside a migration.

```php
Schema::table('categories', function ($table) {
    $table->integer('parent_id')->nullable()->unsigned();
    $table->integer('nest_left')->nullable();
    $table->integer('nest_right')->nullable();
    $table->integer('nest_depth')->nullable();
});
```

To use a nested set model, apply the `October\Rain\Database\Traits\NestedTree` trait. All of the features of the `SimpleTree` trait are inherently available in this model.

```php
class Category extends Model
{
    use \October\Rain\Database\Traits\NestedTree;
}
```

#### Creating a Root Node

By default, all nodes are created as roots:

```php
$root = Category::create(['name' => 'Root category']);
```

Alternatively, you may find yourself in the need of converting an existing node into a root node:

```php
$node->makeRoot();
```

You may also nullify it's `parent_id` column which works the same as `makeRoot'.

```php
$node->parent_id = null;
$node->save();
```

#### Inserting Nodes

You can insert new nodes directly by the relation:

```php
$child1 = $root->children()->create(['name' => 'Child 1']);
```

Or use the `makeChildOf` method for existing nodes:

```php
$child2 = Category::create(['name' => 'Child 2']);
$child2->makeChildOf($root);
```

#### Deleting Nodes

When a node is deleted with the `delete` method, all descendants of the node will also be deleted. Note that the delete [model events](../system/models.md) will not be fired for the child models.

```php
$child1->delete();
```

#### Getting the Nesting Level of a Node

The `getLevel` method will return current nesting level, or depth, of a node.

```php
// 0 when root
$node->getLevel()
```

#### Moving Nodes Around

There are several methods for moving nodes around:

- `moveLeft()`: Find the left sibling and move to the left of it.
- `moveRight()`: Find the right sibling and move to the right of it.
- `moveBefore($otherNode)`: Move to the node to the left of ...
- `moveAfter($otherNode)`: Move to the node to the right of ...
- `makeChildOf($otherNode)`: Make the node a child of ...
- `makeRoot()`: Make current node a root node.

## Utility Functions

### Validation

October CMS models uses the built-in [Validator class](../services/validation.md). The validation rules are defined in the model class as a property named `$rules` and the class must use the trait `October\Rain\Database\Traits\Validation`.

```php
class User extends Model
{
    use \October\Rain\Database\Traits\Validation;

    public $rules = [
        'name' => ['required', 'between:4,16'],
        'email' => ['required', 'email'],
        'password' => ['required', 'alpha_num', 'between:4,8', 'confirmed'],
        'password_confirmation' => ['required', 'alpha_num', 'between:4,8']
    ];
}
```

You may also use [array syntax](../services/validation.md) for validation rules.

```php
public $rules = [
    'links.*.url' => ['required', 'url'],
    'links.*.anchor' => ['required']
];
```

Models validate themselves automatically when the `save` method is called.

```php
$user = new User;
$user->name = 'Actual Person';
$user->email = 'a.person@example.tld';
$user->password = 'passw0rd';

// Returns false if model is invalid
$success = $user->save();
```

::: tip
You can also validate a model at any time using the `validate` method.
:::

#### Enhanced Validation Rules

The `unique` validation rule is automatically configured and does not require a table name to be specified.

```php
public $rules = [
    'name' => ['unique'],
];
```

The `required` validation rule supports **create** and **update** modifiers to only apply when a model is created or updated respectively. The following is only required when the model does not already exist.

```php
public $rules = [
    'password' => ['required:create'],
];
```

#### Retrieving Validation Errors

When a model fails to validate, a `Illuminate\Support\MessageBag` object is attached to the model. The object which contains validation failure messages. Retrieve the validation errors message collection instance with `errors` method or `$validationErrors` property. Retrieve all validation errors with `errors()->all()`. Retrieve errors for a *specific* attribute using `validationErrors->get('attribute')`.

::: tip
The Model leverages the `MessagesBag` object which has a [simple and elegant method](../services/validation.md) of formatting errors.
:::

#### Overriding Validation

The `forceSave` method validates the model and saves regardless of whether or not there are validation errors.

```php
$user = new User;

// Creates a user without validation
$user->forceSave();
```

#### Custom Error Messages

Just like the Validator class, you can set custom error messages using the [same syntax](../services/validation.md).

```php
class User extends Model
{
    public $customMessages = [
        'required' => 'The :attribute field is required.',
        // ...
    ];
}
```

You can also add custom error messages to the array syntax for validation rules as well.

```php
class User extends Model
{
    use \October\Rain\Database\Traits\Validation;

    public $rules = [
        'links.*.url' => ['required', 'url'],
        'links.*.anchor' => ['required'],
    ];

    public $customMessages = [
        'links.*.url.required' => 'The url is required',
        'links.*.url.*' => 'The url needs to be a valid url'
        'links.*.anchor.required' => 'The anchor text is required',
    ];
}
```

In the above example you can write custom error messages to specific validation rules (here we used: `required`). Or you can use a `*` to select everything else (here we added a custom message to the `url` validation rule using the `*`).

#### Custom Attribute Names

You may also set custom attribute names with the `$attributeNames` array.

```php
class User extends Model
{
    public $attributeNames = [
        'email' => 'Email Address',
        // ...
    ];
}
```

#### Dynamic Validation Rules

You can apply rules dynamically by overriding the `beforeValidate` [model event](../system/models.md) method. Here we check if the `is_remote` attribute is `false` and then dynamically set the `latitude` and `longitude` attributes to be required fields.

```php
public function beforeValidate()
{
    if (!$this->is_remote) {
        $this->rules['latitude'] = 'required';
        $this->rules['longitude'] = 'required';
    }
}
```

#### Custom Validation Rules

You can also create custom validation rules the [same way](../services/validation.md) you would for the `Validator` service.

### Soft Deleting

When soft deleting a model, it is not actually removed from your database. Instead, a `deleted_at` timestamp is set on the record. To enable soft deletes for a model, apply the `October\Rain\Database\Traits\SoftDelete` trait to the model and add the deleted_at column to your `$dates` property:

```php
class User extends Model
{
    use \October\Rain\Database\Traits\SoftDelete;

    protected $dates = ['deleted_at'];
}
```

To add a `deleted_at` column to your table, you may use the `softDeletes` method from a migration:

```php
Schema::table('posts', function ($table) {
    $table->softDeletes();
});
```

Now, when you call the `delete` method on the model, the `deleted_at` column will be set to the current timestamp. When querying a model that uses soft deletes, the "deleted" models will not be included in query results.

To determine if a given model instance has been soft deleted, use the `trashed` method:

```php
if ($user->trashed()) {
    //
}
```

#### Querying Soft Deleted Models

##### Including Soft Deleted Models

As noted above, soft deleted models will automatically be excluded from query results. However, you may force soft deleted models to appear in a result set using the `withTrashed` method on the query:

```php
$users = User::withTrashed()->where('account_id', 1)->get();
```

The `withTrashed` method may also be used on a [relationship](./relations.md) query:

```php
$flight->history()->withTrashed()->get();
```

##### Retrieving Only Soft Deleted Models

The `onlyTrashed` method will retrieve **only** soft deleted models:

```php
$users = User::onlyTrashed()->where('account_id', 1)->get();
```

##### Restoring Soft Deleted Models

Sometimes you may wish to "un-delete" a soft deleted model. To restore a soft deleted model into an active state, use the `restore` method on a model instance:

```php
$user->restore();
```

You may also use the `restore` method in a query to quickly restore multiple models:

```php
// Restore a single model instance...
User::withTrashed()->where('account_id', 1)->restore();

// Restore all related models...
$user->posts()->restore();
```

#### Permanently Deleting Models

Sometimes you may need to truly remove a model from your database. To permanently remove a soft deleted model from the database, use the `forceDelete` method:

```php
// Force deleting a single model instance...
$user->forceDelete();

// Force deleting all related models...
$user->posts()->forceDelete();
```

#### Soft Deleting Relations

When two related models have soft deletes enabled, you can cascade the delete event by defining the `softDelete` option in the [relation definition](./relations.md). In this example, if the user model is soft deleted, the comments belonging to that user will also be soft deleted.

```php
class User extends Model
{
    use \October\Rain\Database\Traits\SoftDelete;

    public $hasMany = [
        'comments' => [\Acme\Blog\Models\Comment::class, 'softDelete' => true]
    ];
}
```

::: tip
If the related model does not use the soft delete trait, it will be treated the same as the `delete` option and deleted permanently.
:::

Under these same conditions, when the primary model is restored, all the related models that use the `softDelete` option will also be restored.

```php
// Restore the user and comments
$user->restore();
```

#### Including Soft Deleted Relations

Soft deleted records are not included as part of relation lookups, however, you may include them by adding the `withTrashed` scope to the query.

```php
class User extends Model
{
    public $hasMany = [
        'comments' => [\Acme\Blog\Models\Comment::class, 'scope' => 'withTrashed']
    ];
}
```

### Multisite

When applying multisite to a model, only records belonging to the active site are available to manage. The active site is attached to the `site_id` column set on the record. To enable multi-site for a model, apply the `October\Rain\Database\Traits\Multisite` trait and define the attributes to propagate across all records using the `$propagatable` property:

```php
class User extends Model
{
    use \October\Rain\Database\Traits\Multisite;

    protected $propagatable = ['api_code'];
}
```

::: tip
The `$propagatable` is required by the multisite trait but can be left as an empty array to disable propagation of any attribute.
:::

To add a `site_id` column to your table, you may use the `integer` method from a migration. A `site_root_id` may also be used to link records together using a root record.

```php
Schema::table('posts', function ($table) {
    $table->integer('site_id')->nullable()->index();
    $table->integer('site_root_id')->nullable()->index();
});
```

Now, when a record is created it will be assigned to the active site and switching to a different site will propagate a new record automatically. When updating a record, propagated fields are copied to every record belonging to the root record.

#### Enforcing Synchronization

In some cases, all records must exist for every site, such as categories and tags. You may force every record to exist across all sites by setting the `$propagatableSync` property to true, which is false by default. Once enabled, after a model is saved, it will create the same model for other sites if they do not already exist.

```php
protected $propagatableSync = true;
```

When using [Site Groups](../../cms/resources/multisite.md), the records will be propagated to all sites within that group. This can be controlled by setting the `$propagatableSync` property to an array containing configuration options.

Option | Description
------------- | -------------
- **sync** - logic to sync specific sites, available options: `all`, `group`, `locale`. Default: `group`
- **delete** - delete all linked records when any record is deleted, default: `true`
- **except** - provides attribute names that should not be replicated for newly synced records

```php
protected $propagatableSync = [
    'sync' => 'all',
    'delete' => false,
    'except' => [
        'description'
    ]
];
```

#### Saving Models

Models saved with the multisite trait do not propagate by default. Use the `savePropagate` method to ensure the propagation rules take effect.

```php
$model->savePropagate();
```

### Revisionable

October CMS models can record the history of changes in values by storing revisions. To store revisions for your model, apply the `October\Rain\Database\Traits\Revisionable` trait and declare a `$revisionable` property with an array containing the attributes to monitor for changes. You also need to define a `$morphMany` [model relation](./relations.md) called `revision_history` that refers to the `System\Models\Revision` class with the name `revisionable`, this is where the revision history data is stored.

```php
class User extends Model
{
    use \October\Rain\Database\Traits\Revisionable;

    protected $revisionable = ['name', 'email'];

    public $morphMany = [
        'revision_history' => [\System\Models\Revision::class, 'name' => 'revisionable']
    ];
}
```

By default a maximum number of 500 records will be kept, however, this can be modified by declaring a `$revisionableLimit` property on the model with a new limit value.

```php
/**
 * @var int revisionableLimit as the maximum number records to keep.
 */
public $revisionableLimit = 8;
```

The revision history can be accessed like any other relation:

```php
$history = User::find(1)->revision_history;

foreach ($history as $record) {
    echo $record->field . ' updated ';
    echo 'from ' . $record->old_value;
    echo 'to ' . $record->new_value;
}
```

The revision record optionally supports a user relationship using the `user_id` attribute. You may include a `getRevisionableUser` method in your model to keep track of the user that made the modification.

```php
public function getRevisionableUser()
{
    return BackendAuth::getUser()->id;
}
```
# Basic Usage

Connecting to databases and running queries is a simple process, supported by using either raw SQL, the [query builder](./query.md) or [active record models](./model.md). Managing database tables and populating seed data is handled by the [migration and seeder process](./structure.md).

Raw SQL and using the query builder will perform faster and should be used for simple tasks. Active Record is an approach used by the popular framework, Ruby On Rails. It allows an easy interface for performing repetitive tasks like creating, reading, updating and deleting database records. You can learn more about the [active record pattern on Wikipedia](http://en.wikipedia.org/wiki/Active_record_pattern).

## Running Raw SQL Queries

Once you have configured your database connection, you may run queries using the `Db` facade. The `Db` facade provides methods for each type of query: `select`, `update`, `insert`, `delete`, and `statement`.

### Selecting Records

To run a basic query, use the `select` method on the `Db` facade.

```php
$users = Db::select('select * from users where active = ?', [1]);
```

The first argument passed to the `select` method is the raw SQL query, while the second argument is any parameter bindings that need to be bound to the query. Typically, these are the values of the `where` clause constraints. Parameter binding provides protection against SQL injection.

The `select` method will always return an `array` of results. Each result within the array will be a PHP `stdClass` object, allowing you to access the values of the results:

```php
foreach ($users as $user) {
    echo $user->name;
}
```

Instead of using `?` to represent your parameter bindings, you may execute a query using named bindings.

```php
$results = Db::select('select * from users where id = :id', ['id' => 1]);
```

If database query may produces a singular value, this can be retrieved using the `scalar` method.

```php
$count = Db::scalar('select count(*) as count from menu_items');
```

### Modifying Records

To execute an `insert` statement, you may use the `insert` method on the `Db` facade. Like `select`, this method takes the raw SQL query as its first argument and bindings as the second argument.

```php
Db::insert('insert into users (id, name) values (?, ?)', [1, 'Joe']);
```

The `update` method should be used to update existing records in the database. The number of rows affected by the statement will be returned by the method:

```php
$affected = Db::update('update users set votes = 100 where name = ?', ['John']);
```

The `delete` method should be used to delete records from the database. Like `update`, the number of rows deleted will be returned:

```php
$deleted = Db::delete('delete from users');
```

### General Statements

Some database statements should not return any value. For these types of operations, you may use the `statement` method on the `Db` facade.

```php
Db::statement('drop table users');
```

## Multiple Database Connections

When [using multiple connections](../../setup/database-config.md), you may access each connection via the `connection` method on the `Db` facade. The `name` passed to the `connection` method should correspond to one of the connections listed in your `config/database.php` configuration file.

```php
$users = Db::connection('foo')->select(...);
```

You may also access the raw, underlying PDO instance using the `getPdo` method on a connection instance.

```php
$pdo = Db::connection()->getPdo();
```

## Database Transactions

To run a set of operations within a database transaction, you may use the `transaction` method on the `Db` facade. If an exception is thrown within the transaction `Closure`, the transaction will automatically be rolled back. If the `Closure` executes successfully, the transaction will automatically be committed. You don't need to worry about manually rolling back or committing while using the `transaction` method.

```php
Db::transaction(function () {
    Db::table('users')->update(['votes' => 1]);

    Db::table('posts')->delete();
});
```

If you would like to begin a transaction manually and have complete control over rollbacks and commits, you may use the `beginTransaction` method on the `Db` facade:

```php
Db::beginTransaction();
```

You can rollback the transaction via the `rollBack` method:

```php
Db::rollBack();
```

Lastly, you can commit a transaction via the `commit` method:

```php
Db::commit();
```

::: tip
Using the `Db` facade's transaction methods also controls transactions for the [query builder](./query.md) and [model queries](./model.md).
:::

## Database Events

If you would like to receive each SQL query executed by your application, you may use the `listen` method. This method is useful for logging queries or debugging.

```php
Db::listen(function($sql, $bindings, $time) {
    //
});
```

You may register your query listener in the `boot` method of a [plugin registration file](../extending.md). Alternatively, plugins can supply a file named **init.php** in the plugin directory that you can use to place this logic.

### Query Logging

When query logging is enabled, a log is kept in memory of all queries that have been run for the current request. Call the `enableQueryLog` method to enable this feature.

```php
Db::connection()->enableQueryLog();
```

To get an array of the executed queries, you may use the `getQueryLog` method:

```php
$queries = Db::getQueryLog();
```

However, in some cases, such as when inserting a large number of rows, this can cause the application to use excess memory. To disable the log, you may use the `disableQueryLog` method:

```php
Db::connection()->disableQueryLog();
```

::: tip
For quicker debugging it may be more useful to call the `trace_sql` [helper function](../services/log.md) instead.
:::
# Collections

All multi-result sets returned by a model are an instance of the `October\Rain\Database\Collection` object, including results retrieved via the `get` method or accessed via a relationship. The `Collection` object extends the [base collection](../services/collections.md), so it naturally inherits dozens of methods used to fluently work with the underlying array of models.

All collections also serve as iterators, allowing you to loop over them as if they were simple PHP arrays.

```php
$users = User::where('is_active', true)->get();

foreach ($users as $user) {
    echo $user->name;
}
```

However, collections are much more powerful than arrays and expose a variety of map / reduce operations using an intuitive interface. For example, let's filter all active models and gather the name for each filtered user.

```php
$users = User::get();

$names = $users->filter(function ($user) {
        return $user->is_active === true;
    })
    ->map(function ($user) {
        return $user->name;
    });
```

::: tip
While most model collection methods return a new instance of an `Eloquent` collection, the `pluck`, `keys`, `zip`, `collapse`, `flatten` and `flip` methods return a base collection instance. Likewise, if a `map` operation returns a collection that does not contain any models, it will be automatically cast to a base collection.
:::

## Available Methods

All model collections extend the base collection object; therefore, they inherit all of the powerful methods provided by the base collection class.

In addition, the `October\Rain\Database\Collection` class provides a superset of methods to aid with managing your model collections. Most methods return `October\Rain\Database\Collection` instances; however, some methods return a base `Illuminate\Support\Collection` instance.

**contains($key, $operator = null, $value = null)**

The `contains` method may be used to determine if a given model instance is contained by the collection. This method accepts a primary key or a model instance:

```php
$users->contains(1);

$users->contains(User::find(1));
```

**diff($items)**

The `diff` method returns all of the models that are not present in the given collection:

```php
use App\User;

$users = $users->diff(User::whereIn('id', [1, 2, 3])->get());
```

**except($keys)**

The `except` method returns all of the models that do not have the given primary keys:

```php
$users = $users->except([1, 2, 3]);
```

**find($key)**

The `find` method finds a model that has a given primary key. If `$key` is a model instance, `find` will attempt to return a model matching the primary key. If `$key` is an array of keys, find will return all models which match the `$keys` using `whereIn()`:

```php
$users = User::all();

$user = $users->find(1);
```

**fresh($with = [])**

The `fresh` method retrieves a fresh instance of each model in the collection from the database. In addition, any specified relationships will be eager loaded:

```php
$users = $users->fresh();

$users = $users->fresh('comments');
```

**intersect($items)**

The `intersect` method returns all of the models that are also present in the given collection:

```php
use App\User;

$users = $users->intersect(User::whereIn('id', [1, 2, 3])->get());
```

**load($relations)**

The `load` method eager loads the given relationships for all models in the collection:

```php
$users->load('comments', 'posts');

$users->load('comments.author');
```

**loadMissing($relations)**

The `loadMissing` method eager loads the given relationships for all models in the collection if the relationships are not already loaded:

```php
$users->loadMissing('comments', 'posts');

$users->loadMissing('comments.author');
```

**modelKeys()**

The `modelKeys` method returns the primary keys for all models in the collection:

```php
$users->modelKeys();

// [1, 2, 3, 4, 5]
```

**makeVisible($attributes)**

The `makeVisible` method makes attributes visible that are typically "hidden" on each model in the collection:

```php
$users = $users->makeVisible(['address', 'phone_number']);
```

**makeHidden($attributes)**

The `makeHidden` method hides attributes that are typically "visible" on each model in the collection:

```php
$users = $users->makeHidden(['address', 'phone_number']);
```

**only($keys)**

The `only` method returns all of the models that have the given primary keys:

```php
$users = $users->only([1, 2, 3]);
```

**unique($key = null, $strict = false)**

The `unique` method returns all of the unique models in the collection. Any models of the same type with the same primary key as another model in the collection are removed.

```php
$users = $users->unique();
```

## Custom Collections

If you need to use a custom `Collection` object with your own extension methods, you may override the `newCollection` method on your model:

```php
class User extends Model
{
    /**
     * Create a new Collection instance.
     */
    public function newCollection(array $models = [])
    {
        return new CustomCollection($models);
    }
}
```

Once you have defined a `newCollection` method, you will receive an instance of your custom collection anytime the model returns a `Collection` instance. If you would like to use a custom collection for every model in your plugin or application, you should override the `newCollection` method on a model base class that is extended by all of your models.

```php
use October\Rain\Database\Collection as CollectionBase;

class CustomCollection extends CollectionBase
{
}
```
# Migrations & Seeding

Migrations and seed files allow you to build, modify and populate database tables. They are primarily used by a [plugin update file](../system/plugins.md) and are paired with the version history of a plugin. All classes are stored in the `updates` directory of a plugin. Migrations should tell a story about your database history and this story can be played both forwards and backwards to build up and tear down the tables.

You may generate a migration file using the command line scaffolding tool. The first argument specifies the author and plugin name. The second argument specifies the migration name.

```bash
php artisan create:migration Acme.Blog CreatePostsTable
```

## Migration Structure

A migration file should define a class that extends the `October\Rain\Database\Updates\Migration` class and contains two methods: `up` and `down`. The `up` method is used to add new tables, columns, or indexes to your database, while the `down` method should simply reverse the operations performed by the `up` method. Within both of these methods you may use the schema builder to expressively create and modify tables. For example, let's look at a sample migration that creates a `october_blog_posts` table:

```php
namespace Acme\Blog\Updates;

use Schema;
use October\Rain\Database\Updates\Migration;

class CreatePostsTable extends Migration
{
    public function up()
    {
        Schema::create('october_blog_posts', function($table)
        {
            $table->engine = 'InnoDB';
            $table->increments('id');
            $table->string('title');
            $table->string('slug')->index();
            $table->text('excerpt')->nullable();
            $table->text('content');
            $table->timestamp('published_at')->nullable();
            $table->boolean('is_published')->default(false);
            $table->timestamps();
        });
    }

    public function down()
    {
        Schema::drop('october_blog_posts');
    }
}
```

## Creating Tables

::: aside
When creating the table, you may use any of the schema builder's column methods to define the table's columns (see below).
:::

To create a new database table, use the `create` method on the `Schema` facade. The `create` method accepts two arguments. The first is the name of the table, while the second is a `Closure` which receives an object used to define the new table.

```php
Schema::create('users', function ($table) {
    $table->increments('id');
});
```

You may check for the existence of a table or column using the `hasTable` and `hasColumn` methods.

```php
if (Schema::hasTable('users')) {
    //
}

if (Schema::hasColumn('users', 'email')) {
    //
}
```

### Connection & Storage Engine

If you want to perform a schema operation on a database connection that is not your default connection, use the `connection` method.

```php
Schema::connection('foo')->create('users', function ($table) {
    $table->increments('id');
});
```

To set the storage engine for a table, set the `engine` property on the schema builder.

```php
Schema::create('users', function ($table) {
    $table->engine = 'InnoDB';

    $table->increments('id');
});
```

## Renaming / Dropping Tables

To rename an existing database table, use the `rename` method.

```php
Schema::rename($from, $to);
```

To drop an existing table, you may use the `drop` or `dropIfExists` methods.

```php
Schema::drop('users');

Schema::dropIfExists('users');
```

## Creating Columns

To update an existing table, we will use the `table` method on the `Schema` facade. Like the `create` method, the `table` method accepts two arguments, the name of the table and a `Closure` that receives an object we can use to add columns to the table:

```php
Schema::table('users', function ($table) {
    $table->string('email');
});
```

### Available Column Types

Of course, the schema builder contains a variety of column types that you may use when building your tables.

Command  | Description
------------- | -------------
`$table->bigIncrements('id');`  |  Incrementing ID (primary key) using a "UNSIGNED BIG INTEGER" equivalent.
`$table->bigInteger('votes');`  |  BIGINT equivalent for the database.
`$table->binary('data');`  |  BLOB equivalent for the database.
`$table->boolean('confirmed');`  |  BOOLEAN equivalent for the database.
`$table->char('name', 4);`  |  CHAR equivalent with a length.
`$table->date('created_at');`  |  DATE equivalent for the database.
`$table->dateTime('created_at');`  |  DATETIME equivalent for the database.
`$table->decimal('amount', 5, 2);`  |  DECIMAL equivalent with a precision and scale.
`$table->double('column', 15, 8);`  |  DOUBLE equivalent with precision, 15 digits in total and 8 after the decimal point.
`$table->enum('choices', ['foo', 'bar']);` | ENUM equivalent for the database.
`$table->float('amount');`  |  FLOAT equivalent for the database.
`$table->increments('id');`  |  Incrementing ID (primary key) using a "UNSIGNED INTEGER" equivalent.
`$table->integer('votes');`  |  INTEGER equivalent for the database.
`$table->json('options');`  |  JSON equivalent for the database.
`$table->jsonb('options');`  |  JSONB equivalent for the database.
`$table->longText('description');`  |  LONGTEXT equivalent for the database.
`$table->mediumInteger('numbers');`  |  MEDIUMINT equivalent for the database.
`$table->mediumText('description');`  |  MEDIUMTEXT equivalent for the database.
`$table->morphs('taggable');`  |  Adds INTEGER `taggable_id` and STRING `taggable_type`.
`$table->nullableTimestamps();`  |  Same as `timestamps()`, except allows NULLs.
`$table->rememberToken();`  |  Adds `remember_token` as VARCHAR(100) NULL.
`$table->smallInteger('votes');`  |  SMALLINT equivalent for the database.
`$table->softDeletes();`  |  Adds `deleted_at` column for soft deletes.
`$table->string('email');`  |  VARCHAR equivalent column.
`$table->string('name', 100);`  |  VARCHAR equivalent with a length.
`$table->text('description');`  |  TEXT equivalent for the database.
`$table->time('sunrise');`  |  TIME equivalent for the database.
`$table->tinyInteger('numbers');`  |  TINYINT equivalent for the database.
`$table->timestamp('added_on');`  |  TIMESTAMP equivalent for the database.
`$table->timestamps();`  |  Adds `created_at` and `updated_at` columns.

### Column Modifiers

In addition to the column types listed above, there are several other column "modifiers" which you may use while adding the column. For example, to make the column "nullable", you may use the `nullable` method.

```php
Schema::table('users', function ($table) {
    $table->string('email')->nullable();
});
```

Below is a list of all the available column modifiers. This list does not include the index modifiers.

Modifier  | Description
------------- | -------------
`->nullable()`  |  Allow NULL values to be inserted into the column
`->default($value)`  |  Specify a "default" value for the column
`->unsigned()`  |  Set `integer` columns to `UNSIGNED`
`->first()`  |  Place the column "first" in the table (MySQL Only)
`->after('column')`  |  Place the column "after" another column (MySQL Only)
`->comment('my comment')`  |  Add a comment to a column (MySQL Only)

## Modifying Columns

The `change` method allows you to modify an existing column to a new type, or modify the column's attributes. For example, you may wish to increase the size of a string column. To see the `change` method in action, let's increase the size of the `name` column from 25 to 50.

```php
Schema::table('users', function ($table) {
    $table->string('name', 50)->change();
});
```

We could also modify a column to be nullable:

```php
Schema::table('users', function ($table) {
    $table->string('name', 50)->nullable()->change();
});
```

### Renaming Columns

To rename a column, you may use the `renameColumn` method on the Schema builder.

```php
Schema::table('users', function ($table) {
    $table->renameColumn('from', 'to');
});
```

::: info
Renaming columns in a table with a `enum` column is not currently supported.
:::

### Dropping Columns

To drop a column, use the `dropColumn` method on the Schema builder.

```php
Schema::table('users', function ($table) {
    $table->dropColumn('votes');
});
```

You may drop multiple columns from a table by passing an array of column names to the `dropColumn` method.

```php
Schema::table('users', function ($table) {
    $table->dropColumn(['votes', 'avatar', 'location']);
});
```

## Creating Indexes

The schema builder supports several types of indexes. First, let's look at an example that specifies a column's values should be unique. To create the index, we can simply chain the `unique` method onto the column definition.

```php
$table->string('email')->unique();
```

Alternatively, you may create the index after defining the column. For example:

```php
$table->unique('email');
```

You may even pass an array of columns to an index method to create a compound index.

```php
$table->index(['account_id', 'created_at']);
```

In most cases you should specify a name for the index manually as the second argument, to avoid the system automatically generating one that is too long.

```php
$table->index(['account_id', 'created_at'], 'account_created');
```

#### Available Index Types

Command  | Description
------------- | -------------
`$table->primary('id');`  |  Add a primary key.
`$table->primary(['first', 'last']);`  |  Add composite keys.
`$table->unique('email');`  |  Add a unique index.
`$table->index('state');`  |  Add a basic index.

### Renaming Indexes

To rename an index, use the `renameIndex` method provided by the schema builder blueprint. This method accepts the current index name as its first argument and the desired name as its second argument.

```php
$table->renameIndex('from', 'to')
```

### Dropping Indexes

To drop an index, you must specify the index's name. If no name was specified manually, the system will automatically generate one, simply concatenate the table name, the name of the indexed column, and the index type. Here are some examples:

Command  | Description
------------- | -------------
`$table->dropPrimary('users_id_primary');`  |  Drop a primary key from the "users" table.
`$table->dropUnique('users_email_unique');`  |  Drop a unique index from the "users" table.
`$table->dropIndex('geo_state_index');`  |  Drop a basic index from the "geo" table.

### Foreign Key Constraints

There is also support for creating foreign key constraints, which are used to force referential integrity at the database level. For example, let's define a `user_id` column on the `posts` table that references the `id` column on a `users` table:

```php
Schema::table('posts', function ($table) {
    $table->integer('user_id')->unsigned();

    $table->foreign('user_id')->references('id')->on('users');
});
```

As before, you may specify a name for the constraint manually by passing a second argument to the `foreign` method:

```php
$table->foreign('user_id', 'user_foreign')
    ->references('id')
    ->on('users');
```

You may also specify the desired action for the "on delete" and "on update" properties of the constraint:

```php
$table->foreign('user_id')
    ->references('id')
    ->on('users')
    ->onDelete('cascade');
```

To drop a foreign key, you may use the `dropForeign` method. Foreign key constraints use the same naming convention as indexes. So, if one is not specified manually, we will concatenate the table name and the columns in the constraint then suffix the name with "_foreign":

```php
$table->dropForeign('posts_user_id_foreign');
```

## Seeder Structure

Like migration files, a seeder class only contains one method by default called `run` and should extend the `Seeder` class. The `run` method is called when the update process is executed. Within this method, you may insert data into your database however you wish. You may use the [query builder](./query.md) to manually insert data or you may use your [model classes](./model.md). In the example below, we'll create a new user using the `User` model inside the `run` method.

```php
<?php namespace Acme\Users\Updates;

use Seeder;
use Acme\Users\Models\User;

class SeedUsersTable extends Seeder
{
    public function run()
    {
        $user = User::create([
            'email' => 'user@example.tld',
            'login' => 'user',
            'password' => 'password123',
            'password_confirmation' => 'password123',
            'first_name' => 'Actual',
            'last_name' => 'Person',
            'is_activated' => true
        ]);
    }
}
```

Alternatively, the same can be achieved using the `Db::table` [query builder](./query.md) method.

```php
public function run()
{
    $user = Db::table('users')->insert([
        'email' => 'user@example.tld',
        'login' => 'user',
        // ...
    ]);
}
```

### Calling Additional Seeders

Within the `DatabaseSeeder` class, you may use the `call` method to execute additional seed classes. Using the `call` method allows you to break up your database seeding into multiple files so that no single seeder class becomes overwhelmingly large. Simply pass the name of the seeder class you wish to run.

```php
public function run()
{
    $this->call(\Acme\Users\Updates\UserTableSeeder::class);
    $this->call(\Acme\Users\Updates\PostsTableSeeder::class);
    $this->call(\Acme\Users\Updates\CommentsTableSeeder::class);
}
```
# File Attachments

Models can support file attachments using a subset of the [polymorphic relationship](./relations.md). The `$attachOne` or `$attachMany` relations are designed for linking a file to a database record called "attachments". In almost all cases the `System\Models\File` model is used to safekeep this relationship where reference to the files are stored as records in the `system_files` table and have a polymorphic relation to the parent model.

In the examples below the model has a single Avatar attachment model and many Photo attachment models.

A single file attachment:

```php
public $attachOne = [
    'avatar' => \System\Models\File::class
];
```

Multiple file attachments:

```php
public $attachMany = [
    'photos' => \System\Models\File::class
];
```

::: warning
To avoid a naming collision, make sure that your model's database table does not already have an attribute that uses the same name as your attachment relationship.
:::

Protected attachments are uploaded to the application's **uploads/protected** directory which is not accessible for the direct access from the Web. A protected file attachment is defined by setting the `public` property to `false`.

```php
public $attachOne = [
    'avatar' => [\System\Models\File::class, 'public' => false]
];
```

## Creating New Attachments

For singular attach relations (`$attachOne`), you may create an attachment directly via the model relationship, by setting its value using the `files` function, which reads the file data from an input upload.

```php
$model->avatar = files('file_input');
```

To associate a new file from a local path, use the `System\Models\File` model and `fromFile` method.

```php
$model->avatar = (new File)->fromFile('/path/to/somefile.jpg');
```

To create a file directly from (raw) data, use the `fromData` method to pass the contents (first argument) and a file name (second argument).

```php
$model->avatar = (new File)->fromData('Some content', 'sometext.txt');
```

You can also add a file from a URL using the `fromUrl` method. To use this method, you need install cURL PHP Extension.

```php
$model->avatar = (new File)->fromUrl('https://example.tld/path/to/avatar.jpg');
```

Optionally, you may specify a custom file name (second argument).

```php
$model->avatar = (new File)->fromUrl('https://example.tld/avatar.jpg', 'customname.jpg');
```

### Handling Multiple Attachments

For multiple attach relations (`$attachMany`), you can pass an array of values from the `files()` function.

```php
$model->photos = (array) files('multi_file');
```

You may use the `create` method to append a file on an existing relationship instead, notice the file object is associated to the `data` attribute. This approach can be used for singular relations too, if you prefer.

```php
$model->photos()->create(['data' => files('file_input')]);
```

You may use the `add` method on the relationship to work directly with a `System\Models\File` model.

```php
$model->photos()->add(
    $model->photos()->make()->fromFile('/path/to/somefile.jpg')
);
```

Alternatively, you can prepare a File model before hand, then manually associate the relationship later. Notice the `is_public` attribute must be set explicitly using this approach.

```php
$file = new \System\Models\File;
$file->data = files('file_input');
$file->is_public = true;
$file->save();

$model->photos()->add($file);
```

## Viewing Attachments

The `getUrl` method returns the full URL of an uploaded public file. The following code would print something like **example.tld/uploads/public/path/to/avatar.jpg**.

```php
echo $model->avatar->getUrl();
```

Returning multiple attachment file paths.

```php
foreach ($model->photos as $photo) {
    echo $photo->getUrl();
}
```

Displaying a file on the page using Twig.

```twig
<img src="{{ model.avatar.url }}" alt="Description Image" />
```

### Accessing the Local Path

The `getLocalPath` method will return an absolute path of an uploaded file in the local filesystem. If using an external driver such as S3, this method will download the contents to a temporary location in the local filesystem.

```php
echo $model->avatar->getLocalPath();
```

## Resizing Thumbs

You can resize an image with the `getThumbUrl` method. The method takes 3 parameters - image width, image height and the options parameter.

The **width** and **height** parameters should be specified as a number or as the **auto** word for the automatic proportional scaling.

```php
echo $model->avatar->getThumbUrl(100, 100, ['mode' => 'crop']);
```

Displaying an image on the page using Twig.

```twig
<img src="{{ model.avatar.thumbUrl(100, 100, { mode: 'exact', quality: 80, extension: 'webp' }) }}" alt="Description Image" />
```

Read more about the available options for `getThumbUrl` on the [image resizer article](../services/resizer.md).

## Output and Download

To output the file contents directly, use the `output` method, this return a [response object](../services/response-view.md) that will include the necessary headers for displaying the file in a browser.

```php
return $model->avatar->output();
```

You can output the contents to the browser by chaining the `send` method.

```php
$model->avatar->output()->send();
```

Return the `download` method to download the file as a response.

```php
return $model->avatar->download();
```

## Usage Example

This section shows a full usage example of the model attachments feature - from defining the relation in a model to displaying the uploaded image on a page.

Inside your model define a relationship to the `System\Models\File` class, for example:

```php
class Post extends Model
{
    public $attachOne = [
        'featured_image' => \System\Models\File::class
    ];
}
```

Build a form for uploading a file:

```php
<?= Form::open(['files' => true]) ?>

    <input name="example_file" type="file">

    <button type="submit">Upload File</button>

<?= Form::close() ?>
```

Process the uploaded file on the server and attach it to a model:

```php
// Find the Blog Post model
$post = Post::find(1);

// Save the featured image of the Blog Post model
if (Input::hasFile('example_file')) {
    $post->featured_image = Input::file('example_file');
}
```

Alternatively, you can use [deferred binding](./relations.md) to defer the relationship.

```php
// Find the Blog Post model
$post = Post::find(1);

// Look for the postback data 'example_file' in the HTML form above
$fileFromPost = Input::file('example_file');

// If it exists, save it as the featured image with a deferred session key
if ($fileFromPost) {
    $post->featured_image()->create(['data' => $fileFromPost], $sessionKey);
}
```

Display the uploaded file on a page:

```php
<?php
// Find the Blog Post model again
$post = Post::find(1);

// Look for the featured image address, otherwise use a default one
if ($post->featured_image) {
    $featuredImage = $post->featured_image->getUrl();
}
else {
    $featuredImage = 'http://placehold.it/220x300';
}
?>

<img src="<?= $featuredImage ?>" alt="Featured Image" />
```

If you need to access the owner of a file, you can use the `attachment` property of the `File` model:

```php
public $morphTo = [
    'attachment' => []
];
```

Example:

```php
$user = $file->attachment;
```

For more information read the [polymorphic relationships](./relations.md#relation-polymorphic-relations)

## Validation Example

The example below uses [array validation](../services/validation.md) to validate `$attachMany` relationships.

```php
use System\Models\File;
use Model;

class Gallery extends Model
{
    use \October\Rain\Database\Traits\Validation;

    public $attachMany = [
        'photos' => File::class
    ];

    public $rules = [
        'photos' => ['required'],
        'photos.*' => ['image', 'max:1000', 'dimensions:min_width=100,min_height=100'],
    ];
}
```

For more information on the `attribute.*` syntax used above, see the [validation article](../services/validation.md) on validating arrays.
# Model Queries

When requesting data from the database the model will retrieve values primarily using the `get` or `first` methods, depending on whether you wish to retrieve multiple models or retrieve a single model respectively. Queries that derive from a Model return an instance of `October\Rain\Database\Builder`.

## Retrieving Multiple Models

Once you have created a model and [its associated database table](./structure.md), you are ready to start retrieving data from your database. Think of each model as a powerful [query builder](./query.md) allowing you to query the database table associated with the model.

```php
$flights = Flight::all();
```

### Accessing Column Values

If you have a model instance, you may access the column values of the model by accessing the corresponding property. For example, let's loop through each `Flight` instance returned by our query and echo the value of the `name` column.

```php
foreach ($flights as $flight) {
    echo $flight->name;
}
```

### Adding Additional Constraints

The `all` method will return all of the results in the model's table. Since each model serves as a [query builder](./query.md), you may also add constraints to queries, and then use the `get` method to retrieve the results:

```php
$flights = Flight::where('active', 1)
    ->orderBy('name', 'desc')
    ->take(10)
    ->get();
```

::: tip
Since models are query builders, you should familiarize yourself with all of the methods available on the [query builder](./query.md). You may use any of these methods in your model queries.
:::

### Collections

For methods like `all` and `get` which retrieve multiple results, an instance of a `Collection` will be returned. This class provides [a variety of helpful methods](./collection.md) for working with your results. Of course, you can simply loop over this collection like an array.

```php
foreach ($flights as $flight) {
    echo $flight->name;
}
```

### Chunking Results

If you need to process thousands of records, use the `chunk` command. The `chunk` method will retrieve a "chunk" of models, feeding them to a given `Closure` for processing. Using the `chunk` method will conserve memory when working with large result sets.

```php
Flight::chunk(200, function ($flights) {
    foreach ($flights as $flight) {
        //
    }
});
```

The first argument passed to the method is the number of records you wish to receive per "chunk". The Closure passed as the second argument will be called for each chunk that is retrieved from the database.

## Retrieving a Single Model

In addition to retrieving all of the records for a given table, you may also retrieve single records using `find` and `first`. Instead of returning a collection of models, these methods return a single model instance.

```php
// Retrieve a model by its primary key
$flight = Flight::find(1);

// Retrieve the first model matching the query constraints
$flight = Flight::where('active', 1)->first();
```

### Not Found Exceptions

Sometimes you may wish to throw an exception if a model is not found. This is particularly useful in routes or controllers. The `findOrFail` and `firstOrFail` methods will retrieve the first result of the query. However, if no result is found, a `Illuminate\Database\Eloquent\ModelNotFoundException` will be thrown.

```php
$model = Flight::findOrFail(1);

$model = Flight::where('legs', '>', 100)->firstOrFail();
```

When [developing an API](../system/routing.md), if the exception is not caught, a `404` HTTP response is automatically sent back to the user, so it is not necessary to write explicit checks to return `404` responses when using these methods.

```php
Route::get('/api/flights/{id}', function ($id) {
    return Flight::findOrFail($id);
});
```

### Retrieving Aggregates

You may also use `count`, `sum`, `max`, and other [aggregate functions](./query.md) provided by the query builder. These methods return the appropriate scalar value instead of a full model instance:

```php
$count = Flight::where('active', 1)->count();

$max = Flight::where('active', 1)->max('price');
```

## Inserting & Updating Models

Inserting and updating data are the cornerstone feature of models, it makes the process effortless when compared to traditional SQL statements.

### Basic Inserts

To create a new record in the database, simply create a new model instance, set attributes on the model, then call the `save` method:

```php
$flight = new Flight;
$flight->name = 'Sydney to Canberra';
$flight->save();
```

In this example, we simply create a new instance of the `Flight` model and assign the `name` attribute. When we call the `save` method, a record will be inserted into the database. The `created_at` and `updated_at` timestamps will automatically be set too, so there is no need to set them manually.

### Basic Updates

The `save` method may also be used to update models that already exist in the database. To update a model, you should retrieve it, set any attributes you wish to update, and then call the `save` method. Again, the `updated_at` timestamp will automatically be updated, so there is no need to manually set its value:

```php
$flight = Flight::find(1);
$flight->name = 'Darwin to Adelaide';
$flight->save();
```

Updates can also be performed against any number of models that match a given query. In this example, all flights that are `active` and have a `destination` of `San Diego` will be marked as delayed:

```php
Flight::where('is_active', true)
    ->where('destination', 'Perth')
    ->update(['delayed' => true]);
```

The `update` method expects an array of column and value pairs representing the columns that should be updated.

### Mass Assignment

You may also use the `create` method to save a new model in a single line. The inserted model instance will be returned to you from the method. However, before doing so, you will need to specify either a `fillable` or `guarded` attribute on the model, as all models protect against mass-assignment. Note that neither `fillable` or `guarded` affect the submission of backend forms, only the use of `create` or `fill` method.

A mass-assignment vulnerability occurs when a user passes an unexpected HTTP parameter through a request, and that parameter changes a column in your database you did not expect. For example, a malicious user might send an `is_admin` parameter through an HTTP request, which is then mapped onto your model's `create` method, allowing the user to escalate themselves to an administrator.

To get started, you should define which model attributes you want to make mass assignable. You may do this using the `$fillable` property on the model. For example, let's make the `name` attribute of our `Flight` model mass assignable:

```php
class Flight extends Model
{
    /**
     * @var array fillable attributes that are mass assignable.
     */
    protected $fillable = ['name'];
}
```

Once we have made the attributes mass assignable, we can use the `create` method to insert a new record in the database. The `create` method returns the saved model instance:

```php
$flight = Flight::create(['name' => 'Flight 10']);
```

While `$fillable` serves as an "allow list" of attributes that should be mass assignable, you may also choose to use `$guarded`. The `$guarded` property should contain an array of attributes that you do not want to be mass assignable. All other attributes not in the array will be mass assignable. So, `$guarded` functions like a "block list". Of course, you should use either `$fillable` or `$guarded` - not both:

```php
class Flight extends Model
{
    /**
     * The attributes that aren't mass assignable.
     *
     * @var array
     */
    protected $guarded = ['price'];
}
```

In the example above, all attributes **except for `price`** will be mass assignable.

### Other Creation Methods

Sometimes you may wish to only instantiate a new instance of a model. You can do this using the `make` method. The `make` method will simply return a new instance without saving or creating anything.

```php
$flight = Flight::make(['name' => 'Flight 10']);

// Functionally the same as...
$flight = new Flight;
$flight->fill(['name' => 'Flight 10']);
```

There are two other methods you may use to create models by mass assigning attributes: `firstOrCreate` and `firstOrNew`. The `firstOrCreate` method will attempt to locate a database record using the given column / value pairs. If the model can not be found in the database, a record will be inserted with the given attributes.

The `firstOrNew` method, like `firstOrCreate` will attempt to locate a record in the database matching the given attributes. However, if a model is not found, a new model instance will be returned. Note that the model returned by `firstOrNew` has not yet been persisted to the database. You will need to call `save` manually to persist it:

```php
// Retrieve the flight by the attributes, otherwise create it
$flight = Flight::firstOrCreate(['name' => 'Flight 10']);

// Retrieve the flight by the attributes, or instantiate a new instance
$flight = Flight::firstOrNew(['name' => 'Flight 10']);
```

## Deleting Models

To delete a model, call the `delete` method on a model instance:

```php
$flight = Flight::find(1);

$flight->delete();
```

In the example above, we are retrieving the model from the database before calling the `delete` method. However, if you know the primary key of the model, you may delete the model without retrieving it. To do so, call the `destroy` method:

```php
Flight::destroy(1);

Flight::destroy([1, 2, 3]);

Flight::destroy(1, 2, 3);
```

You may also run a delete query on a set of models. In this example, we will delete all flights that are marked as inactive:

```php
$deletedRows = Flight::where('active', 0)->delete();
```

::: warning
It is important to mention that [model events](../system/models.md) will not fire when deleting records directly from a query.
:::

## Query Scopes

Scopes allow you to define common sets of constraints that you may easily re-use throughout your application. For example, you may need to frequently retrieve all users that are considered "popular". To define a scope, simply prefix a model method with `scope`.

```php
class User extends Model
{
    /**
     * scopePopular query to only include popular users.
     */
    public function scopePopular($query)
    {
        return $query->where('votes', '>', 100);
    }

    /**
     * scopeActive query to only include active users.
     */
    public function scopeActive($query)
    {
        return $query->where('is_active', 1);
    }
}
```

Once the scope has been defined, you may call the scope methods when querying the model. However, you do not need to include the `scope` prefix when calling the method. You can even chain calls to various scopes, for example:

```php
$users = User::popular()->active()->orderBy('created_at')->get();
```

Sometimes you may wish to define a scope that accepts parameters. To get started, just add your additional parameters to your scope. Scope parameters should be defined after the `$query` argument:

```php
class User extends Model
{
    /**
     * Scope a query to only include users of a given type.
     */
    public function scopeApplyType($query, $type)
    {
        return $query->where('type', $type);
    }
}
```

Now you may pass the parameters when calling the scope:

```php
$users = User::applyType('admin')->get();
```

#### See Also

::: also
* [Models Article](../system/models.md)
:::
# Serialization

When building JSON APIs, you will often need to convert your models and relationships to arrays or JSON. Models includes convenient methods for making these conversions, as well as controlling which attributes are included in your serializations.

## Basic Usage

#### Converting a model to an array

To convert a model and its loaded [relationships](./relations.md) to an array, you may use the `toArray` method. This method is recursive, so all attributes and all relations (including the relations of relations) will be converted to arrays:

```php
$user = User::with('roles')->first();

return $user->toArray();
```

You may also convert [collections](./collections.md) to arrays:

```php
$users = User::all();

return $users->toArray();
```

#### Converting a model to JSON

To convert a model to JSON, you may use the `toJson` method. Like `toArray`, the `toJson` method is recursive, so all attributes and relations will be converted to JSON:

```php
$user = User::find(1);

return $user->toJson();
```

Alternatively, you may cast a model or collection to a string, which will automatically call the `toJson` method:

```php
$user = User::find(1);

return (string) $user;
```

Since models and collections are converted to JSON when cast to a string, you can return Model objects directly from your application's routes, AJAX handlers or controllers:

```php
Route::get('users', function () {
    return User::all();
});
```

## Hiding Attributes from JSON

Sometimes you may wish to limit the attributes, such as passwords, that are included in your model's array or JSON representation. To do so, add a `$hidden` property definition to your model:

```php
namespace Acme\Blog\Models;

use Model;

class User extends Model
{
    /**
     * The attributes that should be hidden for arrays.
     *
     * @var array
     */
    protected $hidden = ['password'];
}
```

Alternatively, you may use the `$visible` property to define a white-list of attributes that should be included in your model's array and JSON representation:

```php
class User extends Model
{
    /**
     * The attributes that should be visible in arrays.
     *
     * @var array
     */
    protected $visible = ['first_name', 'last_name'];
}
```

## Appending Values to JSON

Occasionally, you may need to add array attributes that do not have a corresponding column in your database. To do so, first define an [accessor](./mutators.md) for the value:

```php
class User extends Model
{
    /**
     * Get the administrator flag for the user.
     *
     * @return bool
     */
    public function getIsAdminAttribute()
    {
        return $this->attributes['admin'] == 'yes';
    }
}
```

Once you have created the accessor, add the attribute name to the `appends` property on the model:

```php
class User extends Model
{
    /**
     * The accessors to append to the model's array form.
     *
     * @var array
     */
    protected $appends = ['is_admin'];
}
```

Once the attribute has been added to the `appends` list, it will be included in both the model's array and JSON forms. Attributes in the `appends` array will also respect the `visible` and `hidden` settings configured on the model.
# Mutators

Accessors and mutators allow you to format attributes when retrieving them from a model or setting their value. For example, you may want to use the [encryption service](../services/hash-crypt.md) to encrypt a value while it is stored in the database, and then automatically decrypt the attribute when you access it on the model.

In addition to custom accessors and mutators, you can also automatically cast date fields to [Carbon](https://github.com/briannesbitt/Carbon) instances or even cast text values to JSON.

## Accessors & Mutators

#### Defining an Accessor

To define an accessor, create a `getFooAttribute` method on your model where `Foo` is the "camel" cased name of the column you wish to access. In this example, we'll define an accessor for the `first_name` attribute. The accessor will automatically be called when attempting to retrieve the value of `first_name`:

```php
namespace Acme\Blog\Models;

use Model;

class User extends Model
{
    /**
     * getFirstNameAttribute is available as `first_name` on the model
     */
    public function getFirstNameAttribute($value)
    {
        return ucfirst($value);
    }
}
```

As you can see, the original value of the column is passed to the accessor, allowing you to manipulate and return the value. To access the value of the accessor, you may simply access the `first_name` attribute.

```php
$user = User::find(1);

$firstName = $user->first_name;
```

Accessors can be defined on externally by extending the `model.getAttribute` model event.

```php
User::extend(function ($model) {
    $model->bindEvent('model.getAttribute', function ($attribute, $value) {
        if ($attribute === 'first_name') {
            return ucfirst($value);
        }
    });
});
```

#### Defining a Mutator

To define a mutator, define a `setFooAttribute` method on your model where `Foo` is the "camel" cased name of the column you wish to access. In this example, let's define a mutator for the `first_name` attribute. This mutator will be automatically called when we attempt to set the value of the `first_name` attribute on the model.

```php
namespace Acme\Blog\Models;

use Model;

class User extends Model
{
    /**
     * setFirstNameAttribute writes to the `first_name` attribute
     */
    public function setFirstNameAttribute($value)
    {
        $this->attributes['first_name'] = strtolower($value);
    }
}
```

The mutator will receive the value that is being set on the attribute, allowing you to manipulate the value and set the manipulated value on the model's internal `$attributes` property. For example, if we attempt to set the `first_name` attribute to `Sally`.

```php
$user = User::find(1);

$user->first_name = 'Sally';
```

Here the `setFirstNameAttribute` function will be called with the value `Sally`. The mutator will then apply the `strtolower` function to the name and set its value in the internal `$attributes` array.

Mutators can be defined on externally by extending the `model.setAttribute` model event.

```php
User::extend(function ($model) {
    $model->bindEvent('model.setAttribute', function ($attribute, $value) use ($model) {
        if ($attribute === 'first_name') {
            $model->attributes['first_name'] = strtolower($value);
        }
    });
});
```

## Date Mutators

By default, Models in October will convert the `created_at` and `updated_at` columns to instances of a [Carbon](https://github.com/briannesbitt/Carbon) object, which provides an assortment of helpful methods and extends the native PHP `DateTime` class.

You may customize which fields are automatically mutated, and even completely disable this mutation, by overriding the `$dates` property of your model:

```php
class User extends Model
{
    /**
     * @var array dates return as \Carbon\Carbon instances
     */
    protected $dates = ['created_at', 'updated_at', 'disabled_at'];
}
```

When a column is considered a date, you may set its value to a UNIX timestamp, date string (`Y-m-d`), date-time string, and of course a `DateTime` / `Carbon` instance, and the date's value will automatically be correctly stored in your database.

```php
$user = User::find(1);

$user->disabled_at = Carbon::now();

$user->save();
```

As noted above, when retrieving attributes that are listed in your `$dates` property, they will automatically be cast to [Carbon](https://github.com/briannesbitt/Carbon) instances, allowing you to use any of Carbon's methods on your attributes.

```php
$user = User::find(1);

return $user->disabled_at->getTimestamp();
```

By default, timestamps are formatted as `'Y-m-d H:i:s'`. If you need to customize the timestamp format, set the `$dateFormat` property on your model. This property determines how date attributes are stored in the database, as well as their format when the model is serialized to an array or JSON:

```php
class Flight extends Model
{
    /**
     * @var string dateFormat for storage of the model's date columns.
     */
    protected $dateFormat = 'U';
}
```

## Attribute Casting

The `$casts` property on your model provides a convenient method of converting attributes to common data types. The `$casts` property should be an array where the key is the name of the attribute being cast, while the value is the type you wish to cast to the column to. The supported cast types are: `integer`, `real`, `float`, `double`, `string`, `boolean`, `object` and `array`.

For example, let's cast the `is_admin` attribute, which is stored in our database as an integer (`0` or `1`) to a boolean value.

```php
class User extends Model
{
    /**
     * @var array casts attributes to native types.
     */
    protected $casts = [
        'is_admin' => 'boolean',
    ];
}
```

Now the `is_admin` attribute will always be cast to a boolean when you access it, even if the underlying value is stored in the database as an integer.

```php
$user = User::find(1);

if ($user->is_admin) {
    //
}
```

#### Array Casting

The `array` cast type is particularly useful when working with columns that are stored as serialized JSON. For example, if your database has a `TEXT` field type that contains serialized JSON, adding the `array` cast to that attribute will automatically deserialize the attribute to a PHP array when you access it on your Eloquent model:

```php
class User extends Model
{
    /**
     * @var array casts attributes to native types.
     */
    protected $casts = [
        'options' => 'array',
    ];
}
```

Once the cast is defined, you may access the `options` attribute and it will automatically be deserialized from JSON into a PHP array. When you set the value of the `options` attribute, the given array will automatically be serialized back into JSON for storage:

```php
$user = User::find(1);

$options = $user->options;

$options['key'] = 'value';

$user->options = $options;

$user->save();
```
# Pagination

## Basic usage

There are a few ways to paginate records, the most common is to call the `paginate` method on a query or model. This will return a special paginated collection that adds extra methods for displaying the results.

### Paginating Query Builder Results

There are several ways to paginate items. The simplest is by using the `paginate` method on the [query builder](./query.md) or a [model query](./model.md). The `paginate` method automatically takes care of setting the proper limit and offset based on the current page being viewed by the user. By default, the current page is detected by the value of the `?page` query string argument on the HTTP request. Of course, this value is automatically detected and automatically inserted into links generated by the paginator.

First, let's take a look at calling the `paginate` method on a query. In this example, the only argument passed to `paginate` is the number of items you would like displayed "per page". In this case, let's specify that we would like to display `15` items per page.

```php
$users = Db::table('users')->paginate(15);
```

::: warning
Currently, pagination operations that use a `groupBy` statement cannot be executed efficiently. If you need to use a `groupBy` with a paginated result set, it is recommended that you query the database and create a paginator manually.
:::

#### Simple Pagination

If you only need to display simple "Next" and "Previous" links in your pagination view, you have the option of using the `simplePaginate` method to perform a more efficient query. This is very useful for large datasets if you do not need to display a link for each page number when rendering your view.

```php
$users = Db::table('users')->simplePaginate(15);
```

#### Specify a Page Number

By default the paginator will take the current page number from the `?page` query string. You can specify a page number with the `paginateAtPage` and `simplePaginateAtPage` methods. The number of pages are supplied (first argument) along with the current page number (second argument).

```php
$recordsPerPage = 15;
$currentPage = 1;

$users = Db::table('users')->paginateAtPage($recordsPerPage, $currentPage);

$users = Db::table('users')->simplePaginateAtPage($recordsPerPage, $currentPage);
```

#### Specify a Custom Query Name

The `paginateCustom` and `simplePaginateCustom` methods are used for a custom query string name. The following will use the `?secondPage` query string to determine the page number.

```php
$recordsPerPage = 15;

$users = Db::table('users')->paginateCustom($recordsPerPage, 'secondPage');

$users = Db::table('users')->simplePaginateCustom($recordsPerPage, 'secondPage');
```

### Paginating Model Results

You may also paginate [database model](./model.md) queries. In this example, we will paginate the `User` model with `15` items per page. As you can see, the syntax is nearly identical to paginating query builder results:

```php
$users = User::paginate(15);
```

Of course, you may call `paginate` after setting other constraints on the query, such as `where` clauses:

```php
$users = User::where('votes', '>', 100)->paginate(15);
```

You may also use the `simplePaginate` method when paginating models:

```php
$users = User::where('votes', '>', 100)->simplePaginate(15);
```

You may specify the page number manually by passing a second argument, here we paginate `15` items per page, specifying that we are on page `2`:

```php
$users = User::where('votes', '>', 100)->paginate(15, 2);
```

### Manually Creating a Paginator

Sometimes you may wish to create a pagination instance manually, passing it an array of items. You may do so by creating either an `Illuminate\Pagination\Paginator` or `Illuminate\Pagination\LengthAwarePaginator` instance, depending on your needs.

The `Paginator` class does not need to know the total number of items in the result set, because of this the class does not have methods for retrieving the index of the last page. The `LengthAwarePaginator` accepts almost the same arguments as the `Paginator`, however it does require a count of the total number of items in the result set.

In other words, the `Paginator` corresponds to the `simplePaginate` method on the query builder and models, while the `LengthAwarePaginator` corresponds to the `paginate` method.

When manually creating a paginator instance, you should manually "slice" the array of results you pass to the paginator. If you're unsure how to do this, check out the [array_slice](http://php.net/manual/en/function.array-slice.php) PHP function.

## Displaying Results in a View

When you call the `paginate` or `simplePaginate` methods on a query builder or model query, you will receive a paginator instance. When calling the `paginate` method, you will receive an instance of `Illuminate\Pagination\LengthAwarePaginator`. When calling the `simplePaginate` method, you will receive an instance of `Illuminate\Pagination\Paginator`. These objects provide several methods that describe the result set. In addition to these helpers methods, the paginator instances are iterators and may be looped as an array.

So once you have retrieved the results, you may display the results and render the page links using PHP or [the Twig Pager function](../../markup/function/pager.md).

```php
<div class="container">
    <?php foreach ($users as $user): ?>
        <?= $user->name ?>
    <?php endforeach ?>
</div>

<?= $users->links() ?>
```

The `render` method will render the links to the rest of the pages in the result set. Each of these links will already contain the proper `?page` query string variable. The HTML generated by the `render` method is compatible with the [Bootstrap CSS framework](https://getbootstrap.com).

::: tip
When calling the `render` method from a Twig template, be sure to use the `|raw` filter so the HTML links are not escaped.
:::

#### Customizing the Paginator URI

The `setPath` method allows you to customize the URI used by the paginator when generating links. For example, if you want the paginator to generate links like `http://example.tld/custom/url?page=N`, you should pass `custom/url` to the `setPath` method:

```php
$users = User::paginate(15);
$users->setPath('custom/url');
echo $users->render();
```

#### Appending to Pagination Links

You may add to the query string of pagination links using the `appends` method. For example, to append `&sort=votes` to each pagination link, you should make the following call to `appends`.

```php
echo $users->appends(['sort' => 'votes'])->render();
```

If you wish to append a "hash fragment" to the paginator's URLs, you may use the `fragment` method. For example, to append `#foo` to the end of each pagination link, make the following call to the `fragment` method.

```php
echo $users->fragment('foo')->render();
```

#### Additional Helper Methods

You may also access additional pagination information via the following methods on paginator instances:

```php
$results->count()
$results->currentPage()
$results->hasMorePages()
$results->lastPage() // Not available when using simplePaginate
$results->nextPageUrl()
$results->perPage()
$results->previousPageUrl()
$results->total() // Not available when using simplePaginate
$results->url($page)
```

## Converting results to JSON

The paginator result classes implement the `Illuminate\Contracts\Support\JsonableInterface` contract and expose the `toJson` method, so it's very easy to convert your pagination results to JSON. You may also convert a paginator instance to JSON by simply returning it from a route or AJAX handler:

```php
Route::get('users', function () {
    return User::paginate();
});
```

The JSON from the paginator will include meta information such as `total`, `current_page`, `last_page`, and more. The actual result objects will be available via the `data` key in the JSON array. Here is an example of the JSON created by returning a paginator instance from a route:

#### Example Paginator JSON

```json
{
    "total": 50,
    "per_page": 15,
    "current_page": 1,
    "last_page": 4,
    "next_page_url": "http://octobercms.app?page=2",
    "prev_page_url": null,
    "from": 1,
    "to": 15,
    "data":[
        {
            // Result Object
        },
        {
            // Result Object
        }
    ]
}
```

#### See Also

::: also
* [CMS Pagination](../../cms/features/pagination.md)
* [Pager Twig function](../../markup/function/pager.md)
:::
# Query Builder

::: aside
The query builder uses PDO parameter binding to protect your application against SQL injection attacks. There is no need to clean strings being passed as bindings.
:::

The database query builder provides a convenient, fluent interface to creating and running database queries. It can be used to perform most database operations in your application, and works on all supported database systems.

### Raw SQL Example

Sometimes it makes more sense to perform a query using plain SQL, you can do this with the `Db::select` method.

```php
Db::select('select * from sometable where name = :name', ['name' => 'Charles']);
```

See the article on [running raw SQL queries](./basics.md) for more information.

## Retrieving Results

To begin a fluent query, use the `table` method on the `Db` facade. The `table` method returns a fluent query builder instance for the given table, allowing you to chain more constraints onto the query and then finally get the results. In this example, `get` will return all records from a table.

```php
$users = Db::table('users')->get();
```

Akin to [raw queries](./basics.md), the `get` method returns an `array` of results where each result is an instance of the PHP `stdClass` object. You may access each column's value by accessing the column as a property of the object.

```php
foreach ($users as $user) {
    echo $user->name;
}
```

If you just need to retrieve a single row from the database table, you may use the `first` method. This method will return a single `stdClass` object.

```php
$user = Db::table('users')->where('name', 'John')->first();

echo $user->name;
```

### Plucking Values

If you don't even need an entire row, you may extract a single value from a record using the `value` method. This method will return the value of the column directly:

```php
$email = Db::table('users')->where('name', 'John')->value('email');
```

If you would like to retrieve an array containing the values of a single column, you may use the `pluck` method. In this example, we'll retrieve an array of role titles.

```php
$titles = Db::table('roles')->pluck('title');

foreach ($titles as $title) {
    echo $title;
}
```

You may also specify a custom key column for the returned array.

```php
$roles = Db::table('roles')->pluck('title', 'name');

foreach ($roles as $name => $title) {
    echo $title;
}
```

::: warning
The result from `pluck` will return `Collection` object to behaves like an array. Use the `all()` method to convert it to a PHP array, for example, `pluck('name')->all()`.
:::

### Chunking Results

If you need to work with thousands of database records, consider using the `chunk` method. This method retrieves a small "chunk" of the results at a time, and feeds each chunk into a `Closure` for processing. This method is very useful for writing [console commands](../console-commands.md) that process thousands of records. For example, let's work with the entire `users` table in chunks of 100 records at a time.

```php
Db::table('users')->chunk(100, function($users) {
    foreach ($users as $user) {
        //
    }
});
```

You may stop further chunks from being processed by returning `false` from the `Closure`.

```php
Db::table('users')->chunk(100, function($users) {
    // Process the records...

    return false;
});
```

If you are updating database records while chunking results, your chunk results could change in unexpected ways. So, when updating records while chunking, it is always best to use the `chunkById` method instead. This method will automatically paginate the results based on the record's primary key.

```php
Db::table('users')->where('active', false)
    ->chunkById(100, function ($users) {
        foreach ($users as $user) {
            Db::table('users')
                ->where('id', $user->id)
                ->update(['active' => true]);
        }
    });
```

::: warning
When updating or deleting records inside the chunk callback, any changes to the primary key or foreign keys could affect the chunk query. This could potentially result in records not being included in the chunked results.
:::

### Aggregate Functions

The query builder also provides a variety of aggregate methods, such as `count`, `max`, `min`, `avg`, and `sum`. You may call any of these methods after constructing your query:

```php
$users = Db::table('users')->count();

$price = Db::table('orders')->max('price');
```

Of course, you may combine these methods with other clauses to build your query:

```php
$price = Db::table('orders')
    ->where('is_finalized', 1)
    ->avg('price');
```

Instead of using the `count` method to determine if any records exist that match your query's constraints, you may use the `exists` and `doesntExist` methods:

```php
return Db::table('orders')->where('finalized', 1)->exists();

return Db::table('orders')->where('finalized', 1)->doesntExist();
```

## Select Statements

In some cases you may not always want to select all columns from a database table. Using the `select` method, you can specify a custom `select` clause for the query.

```php
$users = Db::table('users')->select('name', 'email as user_email')->get();
```

The `distinct` method allows you to force the query to return distinct results.

```php
$users = Db::table('users')->distinct()->get();
```

If you already have a query builder instance and you wish to add a column to its existing select clause, you may use the `addSelect` method:

```php
$query = Db::table('users')->select('name');

$users = $query->addSelect('age')->get();
```

### Raw Expressions

Sometimes you may need to use a raw expression in a query. To create a raw expression, you may use the `Db::raw` method.

```php
$users = Db::table('users')
    ->select(Db::raw('count(*) as user_count, status'))
    ->where('status', '<>', 1)
    ->groupBy('status')
    ->get();
```

Another use might be to concatenate columns and/or strings together.

```php
Db::raw("(first_name, ' ', last_name) as full_name");
```

::: warning
Raw statements will be injected into the query as strings, so you should be extremely careful to not create SQL injection vulnerabilities.
:::

### Raw Methods

Instead of using `Db::raw`, you may also use the following methods to insert a raw expression into various parts of your query.

The `selectRaw` method can be used in place of `addSelect(Db::raw(...)).` This method accepts an optional array of bindings as its second argument:

```php
$orders = Db::table('orders')
    ->selectRaw('price * ? as price_with_tax', [1.0825])
    ->get();
```

The `whereRaw` and `orWhereRaw` methods can be used to inject a raw `where` clause into your query. These methods accept an optional array of bindings as their second argument:

```php
$orders = Db::table('orders')
    ->whereRaw('price > IF(state = "TX", ?, 100)', [200])
    ->get();
```

The `havingRaw` and `orHavingRaw` methods may be used to set a raw string as the value of the `having` clause. These methods accept an optional array of bindings as their second argument:

```php
$orders = Db::table('orders')
    ->select('department', Db::raw('SUM(price) as total_sales'))
    ->groupBy('department')
    ->havingRaw('SUM(price) > ?', [2500])
    ->get();
```

The `orderByRaw` method may be used to set a raw string as the value of the order by clause:

```php
$orders = Db::table('orders')
    ->orderByRaw('updated_at - created_at DESC')
    ->get();
```

The `groupByRaw` method may be used to set a raw string as the value of the group by clause:

```php
$orders = Db::table('orders')
    ->select('city', 'state')
    ->groupByRaw('city, state')
    ->get();
```

## Joins

The query builder may also be used to write join statements. To perform a basic SQL "inner join", you may use the `join` method on a query builder instance. The first argument passed to the `join` method is the name of the table you need to join to, while the remaining arguments specify the column constraints for the join. Of course, as you can see, you can join to multiple tables in a single query.

```php
$users = Db::table('users')
    ->join('contacts', 'users.id', '=', 'contacts.user_id')
    ->join('orders', 'users.id', '=', 'orders.user_id')
    ->select('users.*', 'contacts.phone', 'orders.price')
    ->get();
```

If you would like to perform a "left join" or "right join" instead of an "inner join", use the `leftJoin` or `rightJoin` method. The `leftJoin` and `rightJoin` methods have the same signature as the `join` method.

```php
$users = Db::table('users')
    ->leftJoin('posts', 'users.id', '=', 'posts.user_id')
    ->get();

$users = Db::table('users')
    ->rightJoin('posts', 'users.id', '=', 'posts.user_id')
    ->get();
```

To perform a "cross join" use the `crossJoin` method with the name of the table you wish to cross join to. Cross joins generate a cartesian product between the first table and the joined table.

```php
$users = Db::table('sizes')
    ->crossJoin('colors')
    ->get();
```

### Advanced Join Statements

You may also specify more advanced join clauses. To get started, pass a `Closure` as the second argument into the `join` method. The `Closure` will receive a `JoinClause` object which allows you to specify constraints on the `join` clause.

```php
Db::table('users')
    ->join('contacts', function ($join) {
        $join->on('users.id', '=', 'contacts.user_id')->orOn(...);
    })
    ->get();
```

If you would like to use a "where" style clause on your joins, you may use the `where` and `orWhere` methods on a join. Instead of comparing two columns, these methods will compare the column against a value.

```php
Db::table('users')
    ->join('contacts', function ($join) {
        $join->on('users.id', '=', 'contacts.user_id')
            ->where('contacts.user_id', '>', 5);
    })
    ->get();
```

### Subquery Joins

You may use the `joinSub`, `leftJoinSub`, and `rightJoinSub` methods to join a query to a subquery. Each of these methods receive three arguments: the subquery, its table alias, and a Closure that defines the related columns:

```php
$latestPosts = Db::table('posts')
    ->select('user_id', Db::raw('MAX(created_at) as last_post_created_at'))
    ->where('is_published', true)
    ->groupBy('user_id');

$users = Db::table('users')
    ->joinSub($latestPosts, 'latest_posts', function ($join) {
        $join->on('users.id', '=', 'latest_posts.user_id');
    })->get();
```

### Unions

The query builder also provides a quick way to "union" two queries together. For example, you may create an initial query, and then use the `union` method to union it with a second query.

```php
$first = Db::table('users')
    ->whereNull('first_name');

$users = Db::table('users')
    ->whereNull('last_name')
    ->union($first)
    ->get();
```

The `unionAll` method is also available and has the same method signature as `union`.

## Where Clauses

To add `where` clauses to the query, use the `where` method on a query builder instance. The most basic call to `where` requires three arguments. The first argument is the name of the column. The second argument is an operator, which can be any of the database's supported operators. The third argument is the value to evaluate against the column.

For example, here is a query that verifies the value of the "votes" column is equal to 100.

```php
$users = Db::table('users')->where('votes', '=', 100)->get();
```

For convenience, if you simply want to verify that a column is equal to a given value, you may pass the value directly as the second argument to the `where` method.

```php
$users = Db::table('users')->where('votes', 100)->get();
```

You may use a variety of other operators when writing a `where` clause, for example, greater than `>`, doesn't equal `<>` and `like`.

```php
$users = Db::table('users')
    ->where('votes', '>=', 100)
    ->get();

$users = Db::table('users')
    ->where('votes', '<>', 100)
    ->get();

$users = Db::table('users')
    ->where('name', 'like', 'T%')
    ->get();
```

### Or Statements

You may chain where constraints together, as well as add `or` clauses to the query. The `orWhere` method accepts the same arguments as the `where` method:

```php
$users = Db::table('users')
    ->where('votes', '>', 100)
    ->orWhere('name', 'John')
    ->get();
```

::: tip
You can also prefix `or` to any of the where statements methods below, to make the condition an "OR" condition - for example, `orWhereBetween`, `orWhereIn`, etc.
:::

### More Where Statements

The `whereBetween` method verifies that a column's value is between two values.

```php
$users = Db::table('users')
    ->whereBetween('votes', [1, 100])->get();
```

The `whereNotBetween` method verifies that a column's value lies outside of two values.

```php
$users = Db::table('users')
    ->whereNotBetween('votes', [1, 100])
    ->get();
```

The `whereIn` method verifies that a given column's value is contained within the given array.

```php
$users = Db::table('users')
    ->whereIn('id', [1, 2, 3])
    ->get();
```

The `whereNotIn` method verifies that the given column's value is **not** contained in the given array.

```php
$users = Db::table('users')
    ->whereNotIn('id', [1, 2, 3])
    ->get();
```

The `whereNull` method verifies that the value of the given column is `NULL`.

```php
$users = Db::table('users')
    ->whereNull('updated_at')
    ->get();
```

The `whereNotNull` method verifies that the column's value is **not** `NULL`.

```php
$users = Db::table('users')
    ->whereNotNull('updated_at')
    ->get();
```

### Search Statement

The `searchWhere` and `orSearchWhere` methods can be used to perform a search query on a column's value. The method will add to the query using the search term (first argument) and search columns (second argument) using a case insensitive `like` query.

```php
$pages = Db::table('posts')
    ->searchWhere('foo bar', ['title', 'content'])
    ->get();
```

The example above will produce the following SQL, where each column and value has `lower()` applied to it:

```sql
select * from users where
    (title like '%foo%' and title like '%bar%') or
    (content like '%foo%' and content like '%bar%')
```

By default each word in the search term will be searched, however, you can modify this behavior by suppling a mode (third argument), with the following modes supported.

- **all**: result must contain all words (default)
- **any**: result can contain any word
- **exact**: result must contain the exact phrase

```php
$query->searchWhere('foo bar', ['title', 'content'], 'exact');
```

The `exact` search example above will produce the following SQL:

```sql
select * from users where (title like '%foo bar%' or content like '%foo bar%')
```

## Compound Where Clauses

Sometimes you may need to create more advanced where clauses such as "where exists" or nested parameter groupings. The Laravel query builder can handle these as well. To get started, let's look at an example of grouping constraints within parenthesis:

```php
Db::table('users')
    ->where('name', '=', 'John')
    ->orWhere(function ($query) {
        $query->where('votes', '>', 100)
            ->where('title', '<>', 'Admin');
    })
    ->get();
```

As you can see, passing `Closure` into the `orWhere` method instructs the query builder to begin a constraint group. The `Closure` will receive a query builder instance which you can use to set the constraints that should be contained within the parenthesis group. The example above will produce the following SQL:

```sql
select * from users where name = 'John' or (votes > 100 and title <> 'Admin')
```

### Exists Statements

The `whereExists` method allows you to write `where exist` SQL clauses. The `whereExists` method accepts a `Closure` argument, which will receive a query builder instance allowing you to define the query that should be placed inside of the "exists" clause:

```php
Db::table('users')
    ->whereExists(function ($query) {
        $query->select(Db::raw(1))
            ->from('orders')
            ->whereRaw('orders.user_id = users.id');
    })
    ->get();
```

The query above will produce the following SQL:

```sql
select * from users where exists (
    select 1 from orders where orders.user_id = users.id
)
```

### JSON Where Statements

October CMS also supports querying JSON column types on databases that provide support for JSON column types. To query a JSON column, use the `->` operator.

```php
$users = Db::table('users')
    ->where('options->language', 'en')
    ->get();

$users = Db::table('users')
    ->where('preferences->dining->meal', 'salad')
    ->get();
```

You may use `whereJsonContains` to query JSON arrays (not supported on SQLite).

```php
$users = Db::table('users')
    ->whereJsonContains('options->languages', 'en')
    ->get();
```

MySQL and PostgreSQL support `whereJsonContains` with multiple values.

```php
$users = Db::table('users')
    ->whereJsonContains('options->languages', ['en', 'de'])
    ->get();
```

You may use `whereJsonLength` to query JSON arrays by their length.

```php
$users = Db::table('users')
    ->whereJsonLength('options->languages', 0)
    ->get();

$users = Db::table('users')
    ->whereJsonLength('options->languages', '>', 1)
    ->get();
```

### Conditional Clauses

Sometimes you may want clauses to apply to a query only when something else is true. For instance you may only want to apply a `where` statement if a given input value is present on the incoming request. You may accomplish this using the `when` method:

```php
$role = $request->input('role');

$users = Db::table('users')
    ->when($role, function ($query, $role) {
        return $query->where('role_id', $role);
    })
    ->get();
```

The `when` method only executes the given Closure when the first parameter is `true`. If the first parameter is `false`, the Closure will not be executed.

You may pass another Closure as the third parameter to the `when` method. This Closure will execute if the first parameter evaluates as false. To illustrate how this feature may be used, we will use it to configure the default sorting of a query:

```php
$sortBy = null;

$users = Db::table('users')
    ->when($sortBy, function ($query, $sortBy) {
        return $query->orderBy($sortBy);
    }, function ($query) {
        return $query->orderBy('name');
    })
    ->get();
```

## Order, Group, Limit

### Ordering

The `orderBy` method allows you to sort the result of the query by a given column. The first argument to the `orderBy` method should be the column you wish to sort by, while the second argument controls the direction of the sort and may be either `asc` or `desc`.

```php
$users = Db::table('users')
    ->orderBy('name', 'desc')
    ->get();
```

The `latest` and `oldest` methods allow you to easily order results by date. By default, result will be ordered by the `created_at` column. Or, you may pass the column name that you wish to sort by.

```php
$user = Db::table('users')
    ->latest()
    ->first();
```

The `inRandomOrder` method may be used to sort the query results randomly. For example, you may use this method to fetch a random user.

```php
$randomUser = Db::table('users')
    ->inRandomOrder()
    ->first();
```

### Grouping

The `groupBy` and `having` methods may be used to group the query results. The `having` method's signature is similar to that of the `where` method.

```php
$users = Db::table('users')
    ->groupBy('account_id')
    ->having('account_id', '>', 100)
    ->get();
```

You may pass multiple arguments to the `groupBy` method to group by multiple columns.

```php
$users = Db::table('users')
    ->groupBy('first_name', 'status')
    ->having('account_id', '>', 100)
    ->get();
```

For more advanced `having` statements, you may wish to use the `havingRaw` method.

### Limit and Offset

To limit the number of results returned from the query, or to skip a given number of results in the query (`OFFSET`), you may use the `skip` and `take` methods.

```php
$users = Db::table('users')->skip(10)->take(5)->get();
```

## Inserts

The query builder also provides an `insert` method for inserting records into the database table. The `insert` method accepts an array of column names and values to insert:

```php
Db::table('users')->insert(
    ['email' => 'john@example.tld', 'votes' => 0]
);
```

You may even insert several records into the table with a single call to `insert` by passing an array of arrays. Each array represents a row to be inserted into the table:

```php
Db::table('users')->insert([
    ['email' => 'taylor@example.tld', 'votes' => 0],
    ['email' => 'dayle@example.tld', 'votes' => 0]
]);
```

### Auto-Incrementing IDs

If the table has an auto-incrementing id, use the `insertGetId` method to insert a record and then retrieve the ID:

```php
$id = Db::table('users')->insertGetId(
    ['email' => 'john@example.tld', 'votes' => 0]
);
```

::: tip
When using the PostgreSQL database driver, the insertGetId method expects the auto-incrementing column to be named `id`. If you would like to retrieve the ID from a different "sequence", you may pass the sequence name as the second parameter to the `insertGetId` method.
:::

## Updates

In addition to inserting records into the database, the query builder can also update existing records using the `update` method. The `update` method, like the `insert` method, accepts an array of column and value pairs containing the columns to be updated. You may constrain the `update` query using `where` clauses.

```php
Db::table('users')
    ->where('id', 1)
    ->update(['votes' => 1]);
```

### Update or Insert

Sometimes you may want to update an existing record in the database or create it if no matching record exists. In this scenario, the `updateOrInsert` method may be used. The `updateOrInsert` method accepts two arguments: an array of conditions by which to find the record, and an array of column and value pairs containing the columns to be updated.

The `updateOrInsert` method will first attempt to locate a matching database record using the first argument's column and value pairs. If the record exists, it will be updated with the values in the second argument. If the record can not be found, a new record will be inserted with the merged attributes of both arguments.

```php
Db::table('users')
    ->updateOrInsert(
        ['email' => 'john@example.tld', 'name' => 'John'],
        ['votes' => '2']
    );
```

### Upsert

The `upsert` method will insert rows that do not exist and update the rows that already exist with the new values. The method's first argument consists of the values to insert or update, while the second argument lists the column(s) that uniquely identify records within the associated table. The method's third and final argument is an array of columns that should be updated if a matching record already exists in the database.

```php
Db::table('flights')->upsert([
    ['departure' => 'Oakland', 'destination' => 'San Diego', 'price' => 99],
    ['departure' => 'Chicago', 'destination' => 'New York', 'price' => 150]
], ['departure', 'destination'], ['price']);
```

::: tip
All databases except SQL Server require the columns in the second argument of the `upsert` method to have a "primary" or "unique" index.
:::

### Updating JSON columns

When updating a JSON column, you should use `->` syntax to access the appropriate key in the JSON object. This operation is supported on MySQL 5.7+ and PostgreSQL 9.5+:

```php
$affected = Db::table('users')
    ->where('id', 1)
    ->update(['options->enabled' => true]);
```

### Increment / Decrement

The query builder also provides convenient methods for incrementing or decrementing the value of a given column. This is simply a short-cut, providing a more expressive and terse interface compared to manually writing the `update` statement.

Both of these methods accept at least one argument: the column to modify. A second argument may optionally be passed to control the amount by which the column should be incremented / decremented.

```php
Db::table('users')->increment('votes');

Db::table('users')->increment('votes', 5);

Db::table('users')->decrement('votes');

Db::table('users')->decrement('votes', 5);
```

You may also specify additional columns to update during the operation:

```php
Db::table('users')->increment('votes', 1, ['name' => 'John']);
```

## Deletes

The query builder may also be used to delete records from the table via the `delete` method.

```php
Db::table('users')->delete();
```

You may constrain `delete` statements by adding `where` clauses before calling the `delete` method.

```php
Db::table('users')->where('votes', '<', 100)->delete();
```

If you wish to truncate the entire table, which will remove all rows and reset the auto-incrementing ID to zero, you may use the `truncate` method.

```php
Db::table('users')->truncate();
```

## Pessimistic Locking

The query builder also includes a few functions to help you do "pessimistic locking" on your `select` statements. To run the statement with a "shared lock", you may use the `sharedLock` method on a query. A shared lock prevents the selected rows from being modified until your transaction commits.

```php
Db::table('users')->where('votes', '>', 100)->sharedLock()->get();
```

Alternatively, you may use the `lockForUpdate` method. A "for update" lock prevents the rows from being modified or from being selected with another shared lock.

```php
Db::table('users')->where('votes', '>', 100)->lockForUpdate()->get();
```

## Caching Queries

You may easily cache the results of a query using the [Cache service](../services/cache.md). Simply chain the `remember` or `rememberForever` method when preparing the query.

```php
$users = Db::table('users')->remember(10)->get();
```

In this example, the results of the query will be cached for ten minutes. While the results are cached, the query will not be run against the database, and the results will be loaded from the default cache driver specified for your application.

## Debugging

You may use the `dd` or `dump` methods while building a query to dump the query bindings and SQL. The `dd` method will display the debug information and then stop executing the request. The `dump` method will display the debug information but allow the request to keep executing:

```php
Db::table('users')->where('votes', '>', 100)->dd();

Db::table('users')->where('votes', '>', 100)->dump();
```

#### See Also

::: also
* [Laravel Query Builder](https://laravel.com/docs/10.x/queries)
:::
# Relationships

Database tables are often related to one another. For example, a blog post may have many comments, or an order could be related to the user who placed it. October makes managing and working with these relationships easy and supports several different types of relationships.

## Defining Relationships

Model relationships are defined as properties on your model classes. An example of defining relationships:

```php
class User extends Model
{
    public $hasMany = [
        'posts' => \Acme\Blog\Models\Post::class
    ]
}
```

Relationships like models themselves, also serve as powerful [query builders](./query.md), accessing relationships as functions provides powerful method chaining and querying capabilities. For example:

```php
$user->posts()->where('is_active', true)->get();
```

Accessing a relationship as a property is also possible.

```php
$user->posts;
```

## Detailed Definitions

Each definition can be an array where the key is the relation name and the value is a detail array. The detail array's first value is always the related model class name and all other values are parameters that must have a key name.

```php
public $hasMany = [
    'posts' => [\Acme\Blog\Models\Post::class, 'delete' => true]
];
```

The following are parameters that can be used with all relations:

Argument | Description
------------- | -------------
**order** | sorting order for multiple records.
**conditions** | filters the relation using a raw where query statement.
**scope** | filters the relation using a supplied scope method.
**push** | if set to `false`, this relation will not be saved via the `push` method. Default: `true`
**delete** | if set to `true`, the related model will be deleted if the primary model is deleted or relationship is destroyed. Default: `false`
**softDelete** | if set to `true`, the related model will be soft deleted if the [primary model is soft deleted](./traits.md). Default: `false`
**replicate** | if set to true, the related model will duplicated or associated via the `replicate` method. Default: `false`.
**relationClass** | specify a custom class name for the related object.

Example filter using **order** and **conditions** parameters.

```php
public $belongsToMany = [
    'categories' => [
        \Acme\Blog\Models\Category::class,
        'order' => 'name desc',
        'conditions' => 'is_active = 1'
    ]
];
```

Example filter using the **scope** parameter.

```php
class Post extends Model
{
    public $belongsToMany = [
        'categories' => [
            \Acme\Blog\Models\Category::class,
            'scope' => 'isActive'
        ]
    ];
}

class Category extends Model
{
    public function scopeIsActive($query)
    {
        return $query->where('is_active', true)->orderBy('name', 'desc');
    }
}
```

The **scope** parameter can also refer to a static method.

```php
public $belongsToMany = [
    'categories' => [
        \Acme\Blog\Models\Category::class,
        'scope' => [self::class, 'myFilterMethod']
    ]
];

public static function myFilterMethod($query, $related, $parent)
{
    // ...
}
```

Example implementation using the **relationClass** parameter.

```php
public $belongsToMany = [
    'users' => [
        \Backend\Models\User::class,
        'relationClass' => \Backend\Classes\MyBelongsToMany::class
    ]
];
```

::: tip
The `relationClass` should inherit the class of the specified type. For example, when using `belongsTo` the class must inherit `October\Rain\Database\Relations\BelongsTo`.
:::

## Relationship Types

The following relations types are available.

- [One To One](#relation-one-to-one)
- [One To Many](#relation-one-to-many)
- [Many To Many](#relation-many-to-many)
- [Has Many Through](#relation-has-many-through)
- [Has One Through](#relation-has-one-through)
- [Polymorphic Relations](#relation-polymorphic-relations)

<a id="relation-one-to-one"></a>
### One To One

A one-to-one relationship is a very basic relation. For example, a `User` model might be associated with one `Phone`. To define this relationship, we add a `phone` entry to the `$hasOne` property on the `User` model.

```php
namespace Acme\Blog\Models;

use Model;

class User extends Model
{
    public $hasOne = [
        'phone' => \Acme\Blog\Models\Phone::class
    ];
}
```

Once the relationship is defined, we may retrieve the related record using the model property of the same name. These properties are dynamic and allow you to access them as if they were regular attributes on the model.

```php
$phone = User::find(1)->phone;
```

The model assumes the foreign key of the relationship based on the model name. In this case, the `Phone` model is automatically assumed to have a `user_id` foreign key. If you wish to override this convention, you may pass the `key` parameter to the definition.

```php
public $hasOne = [
    'phone' => [\Acme\Blog\Models\Phone::class, 'key' => 'my_user_id']
];
```

Additionally, the model assumes that the foreign key should have a value matching the `id` column of the parent. In other words, it will look for the value of the user's `id` column in the `user_id` column of the `Phone` record. If you would like the relationship to use a value other than `id`, you may pass the `otherKey` parameter to the definition:

```php
public $hasOne = [
    'phone' => [\Acme\Blog\Models\Phone::class, 'key' => 'my_user_id', 'otherKey' => 'my_id']
];
```

#### Defining the Inverse Relation

Now that we can access the `Phone` model from our `User`. Let's do the opposite and define a relationship on the `Phone` model that will let us access the `User` that owns the phone. We can define the inverse of a `hasOne` relationship using the `$belongsTo` property:

```php
class Phone extends Model
{
    public $belongsTo = [
        'user' => \Acme\Blog\Models\User::class
    ];
}
```

In the example above, the model will try to match the `user_id` from the `Phone` model to an `id` on the `User` model. It determines the default foreign key name by examining the name of the relationship definition and suffixing the name with `_id`. However, if the foreign key on the `Phone` model is not `user_id`, you may pass a custom key name using the `key` parameter on the definition:

```php
public $belongsTo = [
    'user' => [Acme\Blog\Models\User::class, 'key' => 'my_user_id']
];
```

If your parent model does not use `id` as its primary key, or you wish to join the child model to a different column, you may pass the `otherKey` parameter to the definition specifying your parent table's custom key:

```php
public $belongsTo = [
    'user' => [\Acme\Blog\Models\User::class, 'key' => 'my_user_id', 'otherKey' => 'my_id']
];
```

#### Default Models

The `belongsTo` relationship lets you define a default model that will be returned if the given relationship is `null`. This pattern is often referred to as the [Null Object pattern](https://en.wikipedia.org/wiki/Null_Object_pattern) and can help remove conditional checks in your code. In the following example, the `user` relation will return an empty `Acme\Blog\Models\User` model if no `user` is attached to the post.

```php
public $belongsTo = [
    'user' => [\Acme\Blog\Models\User::class, 'default' => true]
];
```

To populate the default model with attributes, you may pass an array to the `default` parameter.

```php
public $belongsTo = [
    'user' => [
        \Acme\Blog\Models\User::class,
        'default' => ['name' => 'Guest']
    ]
];
```

<a id="relation-one-to-many"></a>
### One To Many

A one-to-many relationship is used to define relationships where a single model owns any amount of other models. For example, a blog post may have an infinite number of comments. Like all other relationships, one-to-many relationships are defined adding an entry to the `$hasMany` property on your model:

```php
class Post extends Model
{
    public $hasMany = [
        'comments' => \Acme\Blog\Models\Comment::class
    ];
}
```

Remember, the model will automatically determine the proper foreign key column on the `Comment` model. By convention, it will take the "snake case" name of the owning model and suffix it with `_id`. So for this example, we can assume the foreign key on the `Comment` model is `post_id`.

Once the relationship has been defined, we can access the collection of comments by accessing the `comments` property. Remember, since the model provides "dynamic properties", we can access relationships as if they were defined as properties on the model:

```php
$comments = Post::find(1)->comments;

foreach ($comments as $comment) {
    //
}
```

Of course, since all relationships also serve as query builders, you can add further constraints to which comments are retrieved by calling the `comments` method and continuing to chain conditions onto the query:

```php
$comments = Post::find(1)->comments()->where('title', 'foo')->first();
```

Like the `hasOne` relation, you may also override the foreign and local keys by passing the `key` and `otherKey` parameters on the definition respectively:

```php
public $hasMany = [
    'comments' => [\Acme\Blog\Models\Comment::class, 'key' => 'my_post_id', 'otherKey' => 'my_id']
];
```

#### Defining the Inverse Relation

Now that we can access all of a post's comments, let's define a relationship to allow a comment to access its parent post. To define the inverse of a `hasMany` relationship, define the `$belongsTo` property on the child model:

```php
class Comment extends Model
{
    public $belongsTo = [
        'post' => \Acme\Blog\Models\Post::class
    ];
}
```

Once the relationship has been defined, we can retrieve the `Post` model for a `Comment` by accessing the `post` "dynamic property":

```php
$comment = Comment::find(1);

echo $comment->post->title;
```

In the example above, the model will try to match the `post_id` from the `Comment` model to an `id` on the `Post` model. It determines the default foreign key name by examining the name of the relationship  and suffixing it with `_id`. However, if the foreign key on the `Comment` model is not `post_id`, you may pass a custom key name using the `key` parameter:

```php
public $belongsTo = [
    'post' => [\Acme\Blog\Models\Post::class, 'key' => 'my_post_id']
];
```

If your parent model does not use `id` as its primary key, or you wish to join the child model to a different column, you may pass the `otherKey` parameter to the definition specifying your parent table's custom key:

```php
public $belongsTo = [
    'post' => [Acme\Blog\Models\Post::class, 'key' => 'my_post_id', 'otherKey' => 'my_id']
];
```

<a id="relation-many-to-many"></a>
### Many To Many

Many-to-many relations are slightly more complicated than `hasOne` and `hasMany` relationships. An example of such a relationship is a user with many roles, where the roles are also shared by other users. For example, many users may have the role of "Admin". To define this relationship, three database tables are needed: `users`, `roles`, and `role_user`. The `role_user` table is derived from the alphabetical order of the related model names, and contains the `user_id` and `role_id` columns.

Below is an example that shows the [database table structure](./structure.md) used to create the join table.

```php
Schema::create('role_user', function($table) {
    $table->integer('user_id')->unsigned();
    $table->integer('role_id')->unsigned();
    $table->primary(['user_id', 'role_id']);
});
```

Many-to-many relationships are defined adding an entry to the `$belongsToMany` property on your model class. For example, let's define the `roles` method on our `User` model:

```php
class User extends Model
{
    public $belongsToMany = [
        'roles' => \Acme\Blog\Models\Role::class
    ];
}
```

Once the relationship is defined, you may access the user's roles using the `roles` dynamic property:

```php
$user = User::find(1);

foreach ($user->roles as $role) {
    //
}
```

Of course, like all other relationship types, you may call the `roles` method to continue chaining query constraints onto the relationship:

```php
$roles = User::find(1)->roles()->orderBy('name')->get();
```

As mentioned previously, to determine the table name of the relationship's joining table, the model will join the two related model names in alphabetical order. However, you are free to override this convention. You may do so by passing the `table` parameter to the `belongsToMany` definition:

```php
public $belongsToMany = [
    'roles' => [\Acme\Blog\Models\Role::class, 'table' => 'acme_blog_role_user']
];
```

In addition to customizing the name of the joining table, you may also customize the column names of the keys on the table by passing additional parameters to the `belongsToMany` definition. The `key` parameter is the foreign key name of the model on which you are defining the relationship, while the `otherKey` parameter is the foreign key name of the model that you are joining to:

```php
public $belongsToMany = [
    'roles' => [
        \Acme\Blog\Models\Role::class,
        'table' => 'acme_blog_role_user',
        'key' => 'my_user_id',
        'otherKey' => 'my_role_id'
    ]
];
```

#### Defining the Inverse Relation

To define the inverse of a many-to-many relationship, you simply place another `$belongsToMany` property on your related model. To continue our user roles example, let's define the `users` relationship on the `Role` model:

```php
class Role extends Model
{
    public $belongsToMany = [
        'users' => \Acme\Blog\Models\User::class
    ];
}
```

As you can see, the relationship is defined exactly the same as its `User` counterpart, with the exception of simply referencing the `Acme\Blog\Models\User` model. Since we're reusing the `$belongsToMany` property, all of the usual table and key customization options are available when defining the inverse of many-to-many relationships.

#### Retrieving Intermediate Table Columns

As you have already learned, working with many-to-many relations requires the presence of an intermediate join table. Models provide some very helpful ways of interacting with this table. For example, let's assume our `User` object has many `Role` objects that it is related to. After accessing this relationship, we may access the intermediate table using the `pivot` attribute on the models:

```php
$user = User::find(1);

foreach ($user->roles as $role) {
    echo $role->pivot->created_at;
}
```

Notice that each `Role` model we retrieve is automatically assigned a `pivot` attribute. This attribute contains a model representing the intermediate table, and may be used like any other model.

By default, only the model keys will be present on the `pivot` object. If your pivot table contains extra attributes, you must specify them when defining the relationship:

```php
public $belongsToMany = [
    'roles' => [
        \Acme\Blog\Models\Role::class,
        'pivot' => ['column1', 'column2']
    ]
];
```

If you want your pivot table to have automatically maintained `created_at` and `updated_at` timestamps, use the `timestamps` parameter on the relationship definition:

```php
public $belongsToMany = [
    'roles' => [
        \Acme\Blog\Models\Role::class,
        'timestamps' => true
    ]
];
```

If you would like to define a custom model to represent the intermediate table of your relationship, you may use `pivotModel` attribute when defining the relationship. Custom many-to-many pivot models should extend the `October\Rain\Database\Pivot` class while custom polymorphic many-to-many pivot models should extend the `October\Rain\Database\MorphPivot` class.

```php
public $belongsToMany = [
    'roles' => [
        \Acme\Blog\Models\Role::class,
        'pivotModel' => \Acme\Blog\Models\UserRolePivot::class
    ]
];
```

#### Allowing Duplicate Relations

In some cases you may want to associate the same relationship twice or more, using different pivot data for each attached record. Below is an example that shows a [database table structure](./structure.md) that has an incrementing primary key on the join table instead of a composed primary key.

```php
Schema::create('role_user', function($table) {
    $table->increments('id');
    $table->integer('user_id')->unsigned();
    $table->integer('role_id')->unsigned();
});
```

A custom `pivotModel` must be used for this configuration, and the `pivotKey` property is set to the incrementing column name (`id`).

```php
public $belongsToMany = [
    'roles' => [
        \Acme\Blog\Models\Role::class,
        'pivotModel' => \Acme\Blog\Models\UserRolePivot::class,
        'pivotKey' => 'id'
    ]
];
```

The pivot model definition should set the `$incrementing` property to `true` to enable the incrementing primary key, which defaults to `id` like every other model.

```php
class UserRolePivot extends \October\Rain\Database\Pivot
{
    public $incrementing = true;
}
```

These are the properties supported for `belongsToMany` relations:

Property | Description
------------- | -------------
**table** | the name of the join table.
**key** | the key column name of the defining model (inside pivot table). Default value is combined from model name and `_id` suffix, i.e. `user_id`
**parentKey** | the key column name of the defining model (inside defining model table). Default: id
**otherKey** | the key column name of the related model (inside pivot table). Default value is combined from model name and `_id` suffix, i.e. `role_id`
**relatedKey** | the key column name of the related model (inside related model table). Default: id
**timestamps** | if true, the join table should contain `created_at` and `updated_at` columns. Default: `false`
**detach** | if set to false, the related model will be not be detached if the primary model is deleted or relationship is destroyed, default: true.
**pivot** | an array of pivot columns found in the join table, attributes are available via `$model->pivot`.
**pivotModel** | specify a custom model class to return when accessing the pivot relation. Defaults to `October\Rain\Database\Pivot` while for polymorphic relation `October\Rain\Database\MorphPivot`.
**pivotSortable** | specify a sort order column for the pivot table, used in combination with the `SortableRelation` [model trait](../lists/structures.md).
**pivotKey** | specify an incrementing ID column for the pivot table, must be used with a custom `pivotModel` class with a primary key used on the table.

<a id="relation-has-many-through"></a>
### Has Many Through

The has-many-through relationship provides a convenient short-cut for accessing distant relations via an intermediate relation. For example, a `Country` model might have many `Post` models through an intermediate `User` model. In this example, you could easily gather all blog posts for a given country. Let's look at the tables required to define this relationship:

```
countries
    id - integer
    name - string

users
    id - integer
    country_id - integer
    name - string

posts
    id - integer
    user_id - integer
    title - string
```

Though `posts` does not contain a `country_id` column, the `hasManyThrough` relation provides access to a country's posts via `$country->posts`. To perform this query, the model inspects the `country_id` on the intermediate `users` table. After finding the matching user IDs, they are used to query the `posts` table.

Now that we have examined the table structure for the relationship, let's define it on the `Country` model:

```php
class Country extends Model
{
    public $hasManyThrough = [
        'posts' => [
            \Acme\Blog\Models\Post::class,
            'through' => \Acme\Blog\Models\User::class
        ],
    ];
}
```

The first argument passed to the `$hasManyThrough` relation is the name of the final model we wish to access, while the `through` parameter is the name of the intermediate model.

Typical foreign key conventions will be used when performing the relationship's queries. If you would like to customize the keys of the relationship, you may pass them as the `key`, `otherKey` and `throughKey` parameters to the `$hasManyThrough` definition. The `key` parameter is the name of the foreign key on the intermediate model, the `throughKey` parameter is the name of the foreign key on the final model, while the `otherKey` is the local key.

```php
public $hasManyThrough = [
    'posts' => [
        \Acme\Blog\Models\Post::class,
        'key' => 'my_country_id',
        'through' => \Acme\Blog\Models\User::class,
        'throughKey' => 'my_user_id',
        'otherKey' => 'my_id',
        'secondOtherKey' => 'my_country_id'
    ],
];
```

<a id="relation-has-one-through"></a>
### Has One Through

The has-one-through relationship links models through a single intermediate relation. For example, if each supplier has one user, and each user is associated with one user history record, then the supplier model may access the user's history through the user. Let's look at the database tables necessary to define this relationship:

```
users
    id - integer
    supplier_id - integer

suppliers
    id - integer

history
    id - integer
    user_id - integer
```

Though the `history` table does not contain a `supplier_id` column, the `hasOneThrough` relation can provide access to the user's history to the supplier model. Now that we have examined the table structure for the relationship, let's define it on the `Supplier` model:

```php
class Supplier extends Model
{
    public $hasOneThrough = [
        'userHistory' => [
            \Acme\Supplies\Model\History::class,
            'through' => \Acme\Supplies\Model\User::class
        ],
    ];
}
```

The first array parameter passed to the `$hasOneThrough` property is the name of the final model we wish to access, while the `through` key is the name of the intermediate model.

Typical foreign key conventions will be used when performing the relationship's queries. If you would like to customize the keys of the relationship, you may pass them as the `key`, `otherKey` and `throughKey` parameters to the `$hasManyThrough` definition. The `key` parameter is the name of the foreign key on the intermediate model, the `throughKey` parameter is the name of the foreign key on the final model, while the `otherKey` is the local key.

```php
public $hasOneThrough = [
    'userHistory' => [
        \Acme\Supplies\Model\History::class,
        'key' => 'supplier_id',
        'through' => \Acme\Supplies\Model\User::class,
        'throughKey' => 'user_id',
        'otherKey' => 'id',
        'secondOtherKey' => 'my_country_id'
    ],
];
```

<a id="relation-polymorphic-relations"></a>
## Polymorphic Relations

Polymorphic relations allow a model to belong to more than one other model on a single association.

### Polymorphic One To One

#### Table Structure

A one-to-one polymorphic relation is similar to a simple one-to-one relation; however, the target model can belong to more than one type of model on a single association. For example, imagine you want to store photos for your staff members and for your products. Using polymorphic relationships, you can use a single `photos` table for both of these scenarios. First, let's examine the table structure required to build this relationship:

```
staff
    id - integer
    name - string

products
    id - integer
    price - integer

photos
    id - integer
    path - string
    imageable_id - integer
    imageable_type - string
```

Two important columns to note are the `imageable_id` and `imageable_type` columns on the `photos` table. The `imageable_id` column will contain the ID value of the owning staff or product, while the `imageable_type` column will contain the class name of the owning model. The `imageable_type` column is how the ORM determines which "type" of owning model to return when accessing the `imageable` relation.

#### Model Structure

Next, let's examine the model definitions needed to build this relationship:

```php
class Photo extends Model
{
    public $morphTo = [
        'imageable' => []
    ];
}

class Staff extends Model
{
    public $morphOne = [
        'photo' => [\Acme\Blog\Models\Photo::class, 'name' => 'imageable']
    ];
}

class Product extends Model
{
    public $morphOne = [
        'photo' => [\Acme\Blog\Models\Photo::class, 'name' => 'imageable']
    ];
}
```

#### Retrieving Polymorphic Relations

Once your database table and models are defined, you may access the relationships via your models. For example, to access the photo for a staff member, we can simply use the `photo` dynamic property:

```php
$staff = Staff::find(1);

$photo = $staff->photo
```

You may also retrieve the owner of a polymorphic relation from the polymorphic model by accessing the name of the `morphTo` relationship. In our case, that is the `imageable` definition on the `Photo` model. So, we will access it as a dynamic property:

```php
$photo = Photo::find(1);

$imageable = $photo->imageable;
```

The `imageable` relation on the `Photo` model will return either a `Staff` or `Product` instance, depending on which type of model owns the photo.

### Polymorphic One To Many

#### Table Structure

A one-to-many polymorphic relation is similar to a simple one-to-many relation; however, the target model can belong to more than one type of model on a single association. For example, imagine users of your application can "comment" on both posts and videos. Using polymorphic relationships, you may use a single `comments` table for both of these scenarios. First, let's examine the table structure required to build this relationship:

```
posts
    id - integer
    title - string
    body - text

videos
    id - integer
    title - string
    url - string

comments
    id - integer
    body - text
    commentable_id - integer
    commentable_type - string
```

#### Model Structure

Next, let's examine the model definitions needed to build this relationship:

```php
class Comment extends Model
{
    public $morphTo = [
        'commentable' => []
    ];
}

class Post extends Model
{
    public $morphMany = [
        'comments' => [\Acme\Blog\Models\Comment::class, 'name' => 'commentable']
    ];
}

class Product extends Model
{
    public $morphMany = [
        'comments' => [\Acme\Blog\Models\Comment::class, 'name' => 'commentable']
    ];
}
```

#### Retrieving The Relationship

Once your database table and models are defined, you may access the relationships via your models. For example, to access all of the comments for a post, we can use the `comments` dynamic property:

```php
$post = Author\Plugin\Models\Post::find(1);

foreach ($post->comments as $comment) {
    //
}
```

You may also retrieve the owner of a polymorphic relation from the polymorphic model by accessing the name of the `morphTo` relationship. In our case, that is the `commentable` definition on the `Comment` model. So, we will access it as a dynamic property:

```php
$comment = Author\Plugin\Models\Comment::find(1);

$commentable = $comment->commentable;
```

The `commentable` relation on the `Comment` model will return either a `Post` or `Video` instance, depending on which type of model owns the comment.

You are also able to update the owner of the related model by setting the attribute with the name of the `morphTo` relationship, in this case `commentable`.

```php
$comment = Author\Plugin\Models\Comment::find(1);
$video = Author\Plugin\Models\Video::find(1);

$comment->commentable = $video;
$comment->save()
```

### Polymorphic Many To Many

#### Table structure

In addition to "one-to-one" and "one-to-many" relations, you may also define "many-to-many" polymorphic relations. For example, a blog `Post` and `Video` model could share a polymorphic relation to a `Tag` model. Using a many-to-many polymorphic relation allows you to have a single list of unique tags that are shared across blog posts and videos. First, let's examine the table structure:

```
posts
    id - integer
    name - string

videos
    id - integer
    name - string

tags
    id - integer
    name - string

taggables
    tag_id - integer
    taggable_id - integer
    taggable_type - string
```

#### Model structure

Next, we're ready to define the relationships on the model. The `Post` and `Video` models will both have a `tags` relation defined in the `$morphToMany` property on the base model class:

```php
class Post extends Model
{
    public $morphToMany = [
        'tags' => [\Acme\Blog\Models\Tag::class, 'name' => 'taggable']
    ];
}
```

#### Defining the Inverse Relation

Next, on the `Tag` model, you should define a relation for each of its related models. So, for this example, we will define a `posts` relation and a `videos` relation:

```php
class Tag extends Model
{
    public $morphedByMany = [
        'posts'  => [\Acme\Blog\Models\Post::class, 'name' => 'taggable'],
        'videos' => [\Acme\Blog\Models\Video::class, 'name' => 'taggable']
    ];
}
```

#### Retrieving the Relationship

Once your database table and models are defined, you may access the relationships via your models. For example, to access all of the tags for a post, you can simply use the `tags` dynamic property:

```php
$post = Post::find(1);

foreach ($post->tags as $tag) {
    //
}
```

You may also retrieve the owner of a polymorphic relation from the polymorphic model by accessing the name of the relationship defined in the `$morphedByMany` property. In our case, that is the `posts` or `videos` methods on the `Tag` model. So, you will access those relations as dynamic properties:

```php
$tag = Tag::find(1);

foreach ($tag->videos as $video) {
    //
}
```

#### Custom Polymorphic Types

By default, the fully qualified class name is used to store the related model type. For instance, given the example above where a `Photo` may belong to `Staff` or a `Product`, the default `imageable_type` value is either `Acme\Blog\Models\Staff` or `Acme\Blog\Models\Product` respectively.

Using a custom polymorphic type lets you decouple your database from your application's internal structure. You may define a relationship "morph map" to provide a custom name for each model instead of the class name:

```php
use October\Rain\Database\Relations\Relation;

Relation::morphMap([
    'staff' => \Acme\Blog\Models\Staff::class,
    'product' => \Acme\Blog\Models\Product::class,
]);
```

The most common place to register the `morphMap` in the `boot` method of a [plugin registration file](../extending.md).

<a id="oc-querying-relations"></a>
## Querying Relations

Since all types of Model relationships can be called via functions, you may call those functions to obtain an instance of the relationship without actually executing the relationship queries. In addition, all types of relationships also serve as [query builders](./query.md), allowing you to continue to chain constraints onto the relationship query before finally executing the SQL against your database.

For example, imagine a blog system in which a `User` model has many associated `Post` models:

```php
class User extends Model
{
    public $hasMany = [
        'posts' => \Acme\Blog\Models\Post::class
    ];
}
```

### Access via Relationship Method

You may query the **posts** relationship and add additional constraints to the relationship using the `posts` method. This gives you the ability to chain any of the [query builder](./query.md) methods on the relationship.

```php
$user = User::find(1);

$posts = $user->posts()->where('is_active', 1)->get();

$post = $user->posts()->first();
```

### Access via Dynamic Property

If you do not need to add additional constraints to a relationship query, you may simply access the relationship as if it were a property. For example, continuing to use our `User` and `Post` example models, we may access all of a user's posts using the `$user->posts` property instead.

```php
$user = User::find(1);

foreach ($user->posts as $post) {
    // ...
}
```

Dynamic properties are "lazy loading", meaning they will only load their relationship data when you actually access them. Because of this, developers often use eager loading (see below) to preload relationships they know will be accessed after loading the model. Eager loading provides a significant reduction in SQL queries that must be executed to load a model's relations.

### Querying Relationship Existence

When accessing the records for a model, you may wish to limit your results based on the existence of a relationship. For example, imagine you want to retrieve all blog posts that have at least one comment. To do so, you may pass the name of the relationship to the `has` method:

```php
// Retrieve all posts that have at least one comment...
$posts = Post::has('comments')->get();
```

You may also specify an operator and count to further customize the query:

```php
// Retrieve all posts that have three or more comments...
$posts = Post::has('comments', '>=', 3)->get();
```

Nested `has` statements may also be constructed using "dot" notation. For example, you may retrieve all posts that have at least one comment and vote:

```php
// Retrieve all posts that have at least one comment with votes...
$posts = Post::has('comments.votes')->get();
```

If you need even more power, you may use the `whereHas` and `orWhereHas` methods to put "where" conditions on your `has` queries. These methods allow you to add customized constraints to a relationship constraint, such as checking the content of a comment:

```php
// Retrieve all posts with at least one comment containing words like foo%
$posts = Post::whereHas('comments', function ($query) {
    $query->where('content', 'like', 'foo%');
})->get();
```

#### Inline Relationship Existence Queries

To query a relationship's existence with a single condition to a relationship query, it is more convenient to use the `whereRelation`, `orWhereRelation`, `whereMorphRelation` or `orWhereMorphRelation` methods.

```php
$posts = Post::whereRelation('comments', 'is_approved', false)->get();
```

The `searchWhereRelation` or `orSearchWhereRelation` methods are available for searching relation columns. Similar to [search queries](./query.md), the method will add to the query using the search term (first argument), the relationship name (second argument) and search columns (third argument) using a case insensitive LIKE query.

```php
$posts = Post::searchWhereRelation('foo bar', 'author', ['name', 'bio'])->get();
```

#### Querying Relationship Absence

You may pass the name of the relationship to the `doesntHave` and `orDoesntHave` methods to limit your results based on the absence of a relationship.

```php
$posts = Post::doesntHave('comments')->get();
```

The `whereDoesntHave` and `orWhereDoesntHave` methods can add extra query constraints to your `doesntHave` queries.

```php
$posts = Post::whereDoesntHave('comments', function ($query) {
    $query->where('content', 'like', 'code%');
})->get();
```

### Counting Related Records

In some scenarios you may want to count the number of related records found in a given relationship definition. The `withCount` method can be used to include a `{relation}_count` column with the selected models.

```php
$users = User::withCount('roles')->get();

foreach ($users as $user) {
    echo $user->roles_count;
}
```

The `withCount` method supports multiple relations along with additional query constraints.

```php
$posts = Post::withCount(['votes', 'comments' => function ($query) {
    $query->where('content', 'like', 'foo%');
}])->get();

echo $posts[0]->votes_count;
echo $posts[0]->comments_count;
```

You may lazy load the count column with the `loadCount` method.

```php
$user = User::first();
$user->loadCount('roles');
```

Additional query constraints are also supported.

```php
$user->loadCount(['roles' => function ($query) {
    $query->where('clearance', '>', 5);
}])
```

## Eager Loading

When accessing relationships as properties, the relationship data is "lazy loaded". This means the relationship data is not actually loaded until you first access the property. However, models can "eager load" relationships at the time you query the parent model. Eager loading alleviates the N + 1 query problem. To illustrate the N + 1 query problem, consider a `Book` model that is related to `Author`.

```php
class Book extends Model
{
    public $belongsTo = [
        'author' => \Acme\Blog\Models\Author::class
    ];
}
```

Now let's retrieve all books and their authors:

```php
$books = Book::all();

foreach ($books as $book) {
    echo $book->author->name;
}
```

This loop will execute 1 query to retrieve all of the books on the table, then another query for each book to retrieve the author. So, if we have 25 books, this loop would run 26 queries: 1 for the original book, and 25 additional queries to retrieve the author of each book.

Thankfully we can use eager loading to reduce this operation to just 2 queries. When querying, you may specify which relationships should be eager loaded using the `with` method:

```php
$books = Book::with('author')->get();

foreach ($books as $book) {
    echo $book->author->name;
}
```

For this operation only two queries will be executed:

```sql
select * from books

select * from authors where id in (1, 2, 3, 4, 5, ...)
```

#### Eager Loading Multiple Relationships

Sometimes you may need to eager load several different relationships in a single operation. To do so, just pass additional arguments to the `with` method:

```php
$books = Book::with('author', 'publisher')->get();
```

#### Nested Eager Loading

To eager load nested relationships, you may use "dot" syntax. For example, let's eager load all of the book's authors and all of the author's personal contacts in one statement:

```php
$books = Book::with('author.contacts')->get();
```

### Constraining Eager Loads

Sometimes you may wish to eager load a relationship, but also specify additional query constraints for the eager loading query. Here's an example:

```php
$users = User::with([
    'posts' => function ($query) {
        $query->where('title', 'like', '%first%');
    }
])->get();
```

In this example, the model will only eager load posts if the post's `title` column contains the word `first`. Of course, you may call other [query builder](./query.md) methods to further customize the eager loading operation:

```php
$users = User::with([
    'posts' => function ($query) {
        $query->orderBy('created_at', 'desc');
    }
])->get();
```

### Lazy Eager Loading

Sometimes you may need to eager load a relationship after the parent model has already been retrieved. For example, this may be useful if you need to dynamically decide whether to load related models:

```php
$books = Book::all();

if ($someCondition) {
    $books->load('author', 'publisher');
}
```

If you need to set additional query constraints on the eager loading query, you may pass a `Closure` to the `load` method:

```php
$books->load([
    'author' => function ($query) {
        $query->orderBy('published_date', 'asc');
    }
]);
```

## Inserting Related Models

Just like you would query a relationship, October CMS supports defining a relationship using a method or dynamic property approach. For example, perhaps you need to insert a new `Comment` for a `Post` model. Instead of manually setting the `post_id` attribute on the `Comment`, you may insert the `Comment` directly from the relationship.

### Insert via Relationship Method

October provides convenient methods for adding new models to relationships. Primarily models can be added to a relationship or removed from a relationship. In each case the relationship is associated or disassociated respectively.

#### Add Method

Use the `add` method to associate a new relationship.

```php
$comment = new Comment(['message' => 'A new comment.']);

$post = Post::find(1);

$comment = $post->comments()->add($comment);
```

Notice that we did not access the `comments` relationship as a dynamic property. Instead, we called the `comments` method to obtain an instance of the relationship. The `add` method will automatically add the appropriate `post_id` value to the new `Comment` model.

If you need to save multiple related models, you may use the `addMany` method:

```php
$post = Post::find(1);

$post->comments()->addMany([
    new Comment(['message' => 'A new comment.']),
    new Comment(['message' => 'Another comment.']),
]);
```

#### Remove Method

Comparatively, the `remove` method can be used to disassociate a relationship, making it an orphaned record.

```php
$post->comments()->remove($comment);
```

In the case of many-to-many relations, the record is removed from the relationship's collection instead.

```php
$post->categories()->remove($category);
```

In the case of a "belongs to" relationship, you may use the `dissociate` method, which doesn't require the related model passed to it.

```php
$post->author()->dissociate();
```

#### Adding with Pivot Data

When working with a many-to-many relationship, the `add` method accepts an array of additional intermediate "pivot" table attributes as its second argument as an array.

```php
$user = User::find(1);

$pivotData = ['expires' => $expires];

$user->roles()->add($role, $pivotData);
```

The second argument of the `add` method can also specify the session key used by deferred binding when passed as a string. In these cases the pivot data can be provided as the third argument instead.

```php
$user->roles()->add($role, $sessionKey, $pivotData);
```

#### Create Method

While `add` and `addMany` accept a full model instance, you may also use the `create` method, that accepts a PHP array of attributes, creates a model, and inserts it into the database.

```php
$post = Post::find(1);

$comment = $post->comments()->create([
    'message' => 'A new comment.',
]);
```

Before using the `create` method, be sure to review the documentation on attribute [mass assignment](./model.md) as the attributes in the PHP array are restricted by the model's "fillable" definition.

### Insert via Dynamic Property

Relationships can be set directly via their properties in the same way you would access them. Setting a relationship using this approach will overwrite any relationship that existed previously. The model should be saved afterwards like you would with any attribute.

```php
$post->author = $author;

$post->comments = [$comment1, $comment2];

$post->save();
```

Alternatively you may set the relationship using the primary key, this is useful when working with HTML forms.

```php
// Assign to author with ID of 3
$post->author = 3;

// Assign comments with IDs of 1, 2 and 3
$post->comments = [1, 2, 3];

$post->save();
```

Relationships can be disassociated by assigning the NULL value to the property.

```php
$post->author = null;

$post->comments = null;

$post->save();
```

Similar to deferred binding, relationships defined on non-existent models are deferred in memory until they are saved. In this example the post does not exist yet, so the `post_id` attribute cannot be set on the comment via `$post->comments`. Therefore the association is deferred until the post is created by calling the `save` method.

```php
$comment = Comment::find(1);

$post = new Post;

$post->comments = [$comment];

$post->save();
```

### Many To Many Relations

#### Attaching / Detaching

When working with many-to-many relationships, Models provide a few additional helper methods to make working with related models more convenient. For example, let's imagine a user can have many roles and a role can have many users. To attach a role to a user by inserting a record in the intermediate table that joins the models, use the `attach` method:

```php
$user = User::find(1);

$user->roles()->attach($roleId);
```

When attaching a relationship to a model, you may also pass an array of additional data to be inserted into the intermediate table:

```php
$user->roles()->attach($roleId, ['expires' => $expires]);
```

Of course, sometimes it may be necessary to remove a role from a user. To remove a many-to-many relationship record, use the `detach` method. The `detach` method will remove the appropriate record out of the intermediate table; however, both models will remain in the database:

```php
// Detach a single role from the user...
$user->roles()->detach($roleId);

// Detach all roles from the user...
$user->roles()->detach();
```

For convenience, `attach` and `detach` also accept arrays of IDs as input:

```php
$user = User::find(1);

$user->roles()->detach([1, 2, 3]);

$user->roles()->attach([1 => ['expires' => $expires], 2, 3]);
```

#### Syncing For convenience

You may also use the `sync` method to construct many-to-many associations. The `sync` method accepts an array of IDs to place on the intermediate table. Any IDs that are not in the given array will be removed from the intermediate table. So, after this operation is complete, only the IDs in the array will exist in the intermediate table:

```php
$user->roles()->sync([1, 2, 3]);
```

You may also pass additional intermediate table values with the IDs:

```php
$user->roles()->sync([1 => ['expires' => true], 2, 3]);
```

### Touching Parent Timestamps

When a model `belongsTo` or `belongsToMany` another model, such as a `Comment` which belongs to a `Post`, it is sometimes helpful to update the parent's timestamp when the child model is updated. For example, when a `Comment` model is updated, you may want to automatically "touch" the `updated_at` timestamp of the owning `Post`. Just add a `touches` property containing the names of the relationships to the child model:

```php
class Comment extends Model
{
    /**
     * All of the relationships to be touched.
     */
    protected $touches = ['post'];

    /**
     * Relations
     */
    public $belongsTo = [
        'post' => \Acme\Blog\Models\Post::class
    ];
}
```

Now, when you update a `Comment`, the owning `Post` will have its `updated_at` column updated as well:

```php
$comment = Comment::find(1);

$comment->text = 'Edit to this comment!';

$comment->save();
```

## Deferred Binding

Deferred bindings allows you to postpone model relationships binding until the master record commits the changes. This is particularly useful if you need to prepare some models (such as file uploads) and associate them to another model that doesn't exist yet.

You can defer any number of **slave** models against a **master** model using a **session key**. When the master record is saved along with the session key, the relationships to slave records are updated automatically for you. Deferred bindings are supported in the back-end [Form behavior](../backend/form.md) automatically, but you may want to use this feature in other places.

### Generating a Session Key

The session key is required for deferred bindings. You can think of a session key as of a transaction identifier. The same session key should be used for binding/unbinding relationships and saving the master model. You can generate the session key with PHP `uniqid()` function. Note that the [form helper](../../markup/function/form.md) generates a hidden field containing the session key automatically.

```php
$sessionKey = uniqid('session_key', true);
```

### Defer a Relation Binding

The comment in the next example will not be added to the post unless the post is saved.

```php
$comment = new Comment;
$comment->content = "Hello world!";
$comment->save();

$post = new Post;
$post->comments()->add($comment, $sessionKey);
```

::: tip
The `$post` object has not been saved but the relationship will be created if the saving happens.
:::

### Defer a Relation Unbinding

The comment in the next example will not be deleted unless the post is saved.

```php
$comment = Comment::find(1);
$post = Post::find(1);
$post->comments()->remove($comment, $sessionKey);
```

### List All Bindings

Use the `withDeferred` method of a relation to load all records, including deferred. The results will include existing relations as well.

```php
$post->comments()->withDeferred($sessionKey)->get();
```

### Cancel All Bindings

It's a good idea to cancel deferred binding and delete the slave objects rather than leaving them as orphans.

```php
$post->cancelDeferred($sessionKey);
```

### Commit All Bindings

You can commit (bind or unbind) all deferred bindings when you save the master model by providing the session key with the second argument of the `save` method.

```php
$post = new Post;
$post->title = "First blog post";
$post->save(['sessionKey' => $sessionKey]);
```

The same approach works with the model's `create` method:

```php
$post = Post::create(['title' => 'First blog post'], $sessionKey);
```

### Lazily Commit Bindings

If you are unable to supply the `$sessionKey` when saving, you can commit the bindings at any time using the the next code:

```php
$post->commitDeferred($sessionKey);
```

### Clean Up Orphaned Bindings

Destroys all bindings that have not been committed and are older than 1 day:

```php
October\Rain\Database\Models\DeferredBinding::cleanUp(1);
```

::: tip
October CMS automatically destroys deferred bindings that are older than 5 days using garbage collection.
:::

### Disable Deferred Binding

Sometimes you might need to disable deferred binding entirely for a given model, for instance if you are loading it from a separate database connection. In order to do that, you need to make sure that the model's `sessionKey` property is `null` before the pre and post deferred binding hooks in the internal save method are run. To do that, you can bind to the model's `model.saveInternal` event.

```php
public function __construct()
{
    parent::__construct(...func_get_args());

    $this->bindEvent('model.saveInternal', function () {
        $this->sessionKey = null;
    });
}
```

::: tip
This will disable deferred binding entirely for any model's you apply this override to.
:::
---
subtitle: Create your own commands that run in the console.
---
# Building Console Commands

To build your own custom commands for working with your application, store them within the plugin **console** directory. You may generate the class file using the command line scaffolding tool. The first argument specifies the author and plugin name. The second argument specifies the command name.

```bash
php artisan create:command Acme.Blog MyCommand
```

## Building a Command

If you wanted to create a console command called `acme:mycommand`, you might create the associated class for that command in a file called **plugins/acme/blog/console/MyCommand.php** and paste the following contents to get started:

```php
namespace Acme\Blog\Console;

use Illuminate\Console\Command;
use Symfony\Component\Console\Input\InputOption;
use Symfony\Component\Console\Input\InputArgument;

class MyCommand extends Command
{
    /**
     * @var string signature for the console command.
     */
    protected $signature = 'acme:mycommand {user}';

    /**
     * @var string description for the console command.
     */
    protected $description = 'Does something cool.';

    /**
     * handle executes the console command.
     */
    public function handle()
    {
        $username = $this->argument('user');

        $this->output->writeln("Hello {$username}!");
    }
}
```

Once your class is created you should fill out the `signature` and `description` properties of the class, which will be used when displaying your command on the command `list` screen.

The `handle` method will be called when your command is executed. You may place any command logic in this method.

### Defining Arguments

All user supplied arguments and options are wrapped in curly braces in the signature. In the following example, the command defines one required argument: user:

Arguments are defined in the signature as wrapped curly braces, where you may define any arguments your command receives. For example:

```php
protected $signature = 'mail:send {user}';
```

You may also make arguments optional by placing a question mark (`?`) after the argument name.

```php
protected $signature = 'mail:send {user?}';
```

Alternatively, supply a default value with an equal sign (`=`) followed by the default value.

```php
protected $signature = 'mail:send {user=foo}';
```

### Defining Options

Options, like arguments, are another form of user input and are defined by two hyphens (`--`) in the signature. Options can can optionally receive a value, without a value, they serve as a boolean switch value. For example, a switch value named **queue**.

```php
protected $signature = 'mail:send {user} {--queue}';
```

In this example, the `--queue` switch may be specified when calling the command. If the `--queue` switch is passed, the value of the option will be `true`. Otherwise, the value will be `false`.

```bash
php artisan mail:send 1 --queue
```

When an option expects a value, you should suffix the input name with an equal sign (`=`).

```php
protected $signature = 'mail:send {user} {--queue=}';
```

In this case, the option can accept a value, otherwise the value will be `null`.

```bash
php artisan mail:send 1 --queue=default
```

You may also specify a default value with an equal sign (`=`) followed by the default value.

```php
protected $signature = 'mail:send {user} {--queue=default}';
```

Shortcuts are a shorter syntax when triggering an option.

```php
protected $signature = 'mail:send {user} {--Q|queue}';
```

There is an important difference when calling a shortcut. It should be prefixed with a single hyphen (`-`) and no equal sign is used to supply a value.

```bash
php artisan mail:send 1 -Qdefault
```

### Retrieving Input

While your command is executing, you will obviously need to access the values for the arguments and options accepted by your application. To do so, you may use the `argument` and `option` methods.

Supply a name to the `argument` method to retrieve the value of a command argument.

```php
$value = $this->argument('name');
```

Without a name, it will retrieve all arguments.

```php
$arguments = $this->argument();
```

Passing a name to the `option` method will retrieve the value of a command option.

```php
$value = $this->option('name');
```

Without a name, it will retrieve all options.

```php
$options = $this->option();
```

### Writing Output

To send output to the console, you may use the `info`, `comment`, `question` and `error` methods. Each of these methods will use the appropriate ANSI colors for their purpose.

The `info` method sends information back to the user.

```php
$this->info('Display this on the screen');
```

The `error` method is used for sending an error message.

```php
$this->error('Something went wrong!');
```

You may also use the `ask` and `confirm` methods to prompt the user for input.

```php
$name = $this->ask('What is your name?');
```

The `secret` method is used for asking the user for secret input.

```php
$password = $this->secret('What is the password?');
```

The `confirm` method asks the user for confirmation and returns `true` if the user accepts.

```php
if ($this->confirm('Do you wish to continue? [yes|no]')) {
    //
}
```

You may also specify a default value to the `confirm` method, which should be `true` or `false`.

```php
$this->confirm($question, true);
```

## Registering Commands

#### Registering a Console Command

Once your command class is finished, you need to register it so it will be available for use. This is typically done in the `register` method of a [plugin registration file](./extending.md) using the `registerConsoleCommand` helper method.

```php
class Blog extends PluginBase
{
    public function pluginDetails()
    {
        // ...
    }

    public function register()
    {
        $this->registerConsoleCommand('acme.mycommand', \Acme\Blog\Console\MyConsoleCommand::class);
    }
}
```

Alternatively, plugins can supply a file named **init.php** in the plugin directory that you can use to place command registration logic. Within this file, you may use the `Artisan::add` method to register the command.

```php
Artisan::add(new Acme\Blog\Console\MyCommand);
```

#### Registering a Command in the Application Container

If your command is registered in the [application container](./services/application.md), you may use the `Artisan::resolve` method to make it available to Artisan.

```php
Artisan::resolve('binding.name');
```

## Calling Other Commands

Sometimes you may wish to call other commands from your command. You may do so using the `call` method.

```php
$this->call('october:migrate');
```

You can also pass arguments as an array.

```php
$this->call('plugin:refresh', ['name' => 'October.Demo']);
```

As well as options.

```php
$this->call('october:update', ['--force' => true]);
```

#### See Also

::: also
* [Laravel Artisan Console Documentation](https://laravel.com/docs/10.x/artisan)
:::
---
subtitle: Manages nested form data using related records.
---
# Relation Controller

The `Backend\Behaviors\RelationController` class is a controller behavior used for easily managing complex [model](../database/model.md) relationships on a page.

Relation behavior depends on relation types specified below. In order to use the relation behavior you should add the `Backend\Behaviors\RelationController` definition to the `$implement` field of the controller class. Also, the `$relationConfig` class property should be defined and its value should refer to the YAML file used for configuring the behavior properties.

```php
namespace Acme\Projects\Controllers;

class Projects extends Controller
{
    public $implement = [
        \Backend\Behaviors\FormController::class,
        \Backend\Behaviors\RelationController::class
    ];

    public $formConfig = 'config_form.yaml';
    public $relationConfig = 'config_relation.yaml';
}
```

::: tip
Very often the relation controller is used together with the [form controller](./form-controller.md).
:::

## Configuring the Relation Behavior

The configuration file referred in the `$relationConfig` property is defined in YAML format. The file should be placed into the [controller's views directory](../system/views.md). The required configuration depends on the relationship type between the target model and the related model.

The first level field in the relation configuration file defines the relationship name in the target model. For example.

```php
class Invoice extends Model
{
    public $hasMany = [
        'items' => \Acme\Pay\Models\InvoiceItem::class,
    ];
}
```

An `Invoice` model with a relationship called `items` should define the first level field using the same relationship name.

```yaml
# config_relation.yaml
items:
    label: Invoice Line Item
    view:
        list: $/acme/pay/models/invoiceitem/columns.yaml
        toolbarButtons: create|delete
        recordsPerPage: 10
    manage:
        form: $/acme/pay/models/invoiceitem/fields.yaml
```

The following properties are then used for each relationship name definition.

Property | Description
------------- | -------------
**label** | a label for the relation, in the singular tense, required.
**view** | configuration specific to the view container, see below.
**manage** | configuration specific to the management popup, see below.
**pivot** | a reference to form field definition file, used for relations with pivot table data.
**emptyMessage** | a message to display when the relationship is empty, optional.
**readOnly** | disables the ability to add, update, delete or create relations. Default: `false`
**deferredBinding** | [defers all binding actions using a session key](../database/relations.md) when it is available. default: `false`
**popupSize** | change the size of the management popups used, either: `giant`, `huge`, `large`, `small`, `tiny` or `adaptive`. Default: `huge`
**valueFrom** | defines a custom model attribute to use for the source value. Default comes from the definition name.

These configuration values can be specified for the **view** or **manage** properties, where applicable to the render type of list, form or both.

Property | Type | Description
------------- | ------------- | -------------
**form** | Form | a reference to form field definition file, see [backend form fields](../../element/form-fields.md).
**list** | List | a reference to list column definition file, see [backend list columns](../../element/list-columns.md).
**showFlash** | Both | enables the display of flash messages after a successful action. Default: `true`
**showSearch** | List | display an input for searching the records. Default: `false`
**showSorting** | List | displays the sorting link on each column. Default: `true`
**showSetup** | List | displays a setup button to configure the list columns and records per page. Default: `false`
**defaultSort** | List | sets a default sorting column and direction when user preference is not defined. Supports a string or an array with keys `column` and `direction`. The direction can be `asc` for ascending (default) or `desc` for descending order.
**recordsPerPage** | List | maximum rows to display for each page.
**noRecordsMessage** | List | a message to display when no records are found, can refer to a [localization string](../system/localization.md).
**conditions** | List | specifies a raw where query statement to apply to the list model query.
**scope** | List | specifies a [model query scope](../database/model.md) method defined in the related form model to apply to the list query always. The model that this relationship will be attached to (i.e. the parent model) is passed to this scope method as the second parameter (`$query` is the first).
**searchMode** | List | defines the search strategy to either contain all words, any word or exact phrase. Supported options: `all`, `any`, `exact`. Default: `all`.
**searchScope** | List | specifies a [model query scope](../database/model.md) method defined in the related form model to apply to the search query, the first argument will contain the search term.
**filter** | List | a reference to a filter scopes definition file, see [backend list filters](../lists/filters.md).
**customPageName** | List | specify a custom variable name to use in the page URL for paginated records. Set to `false` to disable storing the page number in the URL.

These configuration values can be specified only for the **view** property.

Property | Type | Description
------------- | ------------- | -------------
**showCheckboxes** | List | displays checkboxes next to each record.
**recordUrl** | List | link each list record to another page. Eg: **users/update/:id**. The `:id` part is replaced with the record identifier.
**customViewPath** | List | specify a custom view path to override partials used by the list.
**recordOnClick** | List | custom JavaScript code to execute when clicking on a record.
**toolbarPartial** | Both | a reference to a controller partial file with the toolbar buttons. Eg: `_relation_toolbar.php`. This property overrides the `toolbarButtons` property.
**toolbarButtons** | Both | the set of buttons to display. This can be formatted as an array or a pipe separated string, or set to `false` to show no buttons. Available options are: `create`, `update`, `delete`, `add`, `remove`, `link`, & `unlink`. Example: `add|remove`.
**structure** | List | options to enable [sorting records](../lists/structures.md) for the list.

These configuration values can be specified only for the **manage** property.

Property | Type | Description
------------- | ------------- | -------------
**title** | Both | a popup title, can refer to a [localization string](../system/localization.md).
**context** | Form | context of the form being displayed. Can be a string or an array with keys: `create`, `update`.

### Custom Messages

Specify the `customMessages` property to override the default messages used by the Relation Controller. The values can be plain text or can refer to a [localization string](../system/localization.md).

```yaml
customMessages:
    buttonCreate: Make Thing
    buttonDelete: Destroy Thing
```

You may also modify messages in the context of the related field being displayed. The following will override the `createButton` message for the `items` relation only.

```yaml
items:
    customMessages:
        buttonCreate: New Item!
```

The following messages are available to override as custom messages.

::: details View the list of available messages
Message | Default Message
------------- | -------------
**buttonCreate** | Create :name
**buttonCreateForm** | Create
**buttonCancelForm** | Cancel
**buttonCloseForm** | Close
**buttonUpdate** | Update :name
**buttonUpdateForm** | Update
**buttonAdd** | Add :name
**buttonAddMany** | Add Selected
**buttonAddForm** | Add
**buttonLink** | Link :name
**buttonDelete** | Delete
**buttonDeleteMany** | Delete Selected
**buttonRemove** | Remove
**buttonRemoveMany** | Remove Selected
**buttonUnlink** | Unlink
**buttonUnlinkMany** | Unlink Selected
**confirmDelete** | Are you sure?
**confirmUnlink** | Are you sure?
**titlePreviewForm** | Preview :name
**titleCreateForm** | Create :name
**titleUpdateForm** | Update :name
**titleLinkForm** | Link a New :name
**titleAddForm** | Add a New :name
**titlePivotForm** | Related :name Data
**flashCreate** | :name Created
**flashUpdate** | :name Updated
**flashDelete** | :name Deleted
**flashAdd** | :name Added
**flashLink** | :name Linked
**flashRemove** | :name Removed
**flashUnlink** | :name Unlinked
:::

### Nested Definitions

The Relation Controller supports nesting relations, in other words, managing relations through relations. A nested relationship uses the standard field nesting syntax. For example, the `countries[cities]` relation definition makes the `cities` relationship available to manage through the `countries` relationship.

```yaml
countries:
    label: Country
    form: $/acme/location/models/country/fields.yaml
    list: $/acme/location/models/country/columns.yaml

countries[cities]:
    label: City
    form: $/acme/location/models/city/fields.yaml
    list: $/acme/location/models/city/columns.yaml
```

::: tip
Nested relation definitions are designed to work seamlessly with the [relation form widget](../../element/form/widget-relation.md), setting the `useController` property set to `true`.
:::

## Relationship Types

How the relation manager is displayed depends on the relationship definition in the target model. The relationship type will also determine the configuration requirements, these are shown in **bold**. The following relationship types are available:

### Has Many

1. Related records are displayed as a list (`view.list`).
1. Clicking a record will display an update form (`manage.form`).
1. Clicking **Add** will display a selection list (`manage.list`).
1. Clicking **Create** will display a create form (`manage.form`).
1. Clicking **Delete** will destroy the record(s).
1. Clicking **Remove** will orphan the relationship.

For example, if a **Blog Post** has many **Comments**, the target model is set as the blog post and a list of comments is displayed, using columns from the `list` definition. Clicking on a comment opens a popup form with the fields defined in `form` to update the comment. Comments can be created in the same way. Below is an example of the relation behavior configuration file.

```yaml
# config_relation.yaml
comments:
    label: Comment
    manage:
        form: $/acme/blog/models/comment/fields.yaml
        list: $/acme/blog/models/comment/columns.yaml
    view:
        list: $/acme/blog/models/comment/columns.yaml
        toolbarButtons: create|delete
```

### Belongs to Many

1. Related records are displayed as a list (`view.list`).
1. Clicking **Add** will display a selection list (`manage.list`).
1. Clicking **Create** will display a create form (`manage.form`).
1. Clicking **Delete** will destroy the pivot table record(s).
1. Clicking **Remove** will orphan the relationship.

For example, if a **User** belongs to many **Roles**, the target model is set as the user and a list of roles is displayed, using columns from the `list` definition. Existing roles can be added and removed from the user. Below is an example of the relation behavior configuration file.

```yaml
# config_relation.yaml
roles:
    label: Role
    view:
        list: $/acme/user/models/role/columns.yaml
        toolbarButtons: add|remove
    manage:
        list: $/acme/user/models/role/columns.yaml
        form: $/acme/user/models/role/fields.yaml
```

### Belongs to Many (with Pivot Data)

1. Related records are displayed as a list (`view.list`).
1. Clicking a record will display an update form (`pivot.form`).
1. Clicking **Add** will display a selection list (`manage.list`), then a data entry form (`pivot.form`).
1. Clicking **Remove** will destroy the pivot table record(s).

Continuing the example in **Belongs To Many** relations, if a role also carried an expiry date, clicking on a role will open a popup form with the fields defined in `pivot` to update the expiry date. Below is an example of the relation behavior configuration file.

```yaml
# config_relation.yaml
roles:
    label: Role
    view:
        list: $/acme/user/models/role/columns.yaml
    manage:
        list: $/acme/user/models/role/columns.yaml
    pivot:
        form: $/acme/user/models/role/fields.yaml
```

Pivot data is available when defining form fields and list columns via the `pivot` relation, see the example below.

```yaml
# config_relation.yaml
teams:
    label: Team
    view:
        list:
            columns:
                name:
                    label: Name
                pivot[team_color]:
                    label: Team color
    manage:
        list:
            columns:
                name:
                    label: Name
    pivot:
        form:
            fields:
                pivot[team_color]:
                    label: Team color
```

### Belongs To

1. Related record is displayed as a preview form (`view.form`).
1. Clicking **Create** will display a create form (`manage.form`).
1. Clicking **Update** will display an update form (`manage.form`).
1. Clicking **Link** will display a selection list (`manage.list`).
1. Clicking **Unlink** will orphan the relationship.
1. Clicking **Delete** will destroy the record.

For example, if a **Phone** belongs to a **Person** the relation manager will display a form with the fields defined in `form`. Clicking the Link button will display a list of People to associate with the Phone. Clicking the Unlink button will dissociate the Phone with the Person.

```yaml
# config_relation.yaml
person:
    label: Person
    view:
        form: $/acme/user/models/person/fields.yaml
        toolbarButtons: link|unlink
    manage:
        form: $/acme/user/models/person/fields.yaml
        list: $/acme/user/models/person/columns.yaml
```

### Has One

1. Related record is displayed as a preview form (`view.form`).
1. Clicking **Create** will display a create form (`manage.form`).
1. Clicking **Update** will display an update form (`manage.form`).
1. Clicking **Link** will display a selection list (`manage.list`).
1. Clicking **Unlink** will orphan the relationship.
1. Clicking **Delete** will destroy the record.

For example, if a **Person** has one **Phone** the relation manager will display form with the fields defined in `form` for the Phone. When clicking the Update button, a popup is displayed with the fields now editable. If the Person already has a Phone the fields are update, otherwise a new Phone is created for them.

```yaml
# config_relation.yaml
phone:
    label: Phone
    view:
        form: $/acme/user/models/phone/fields.yaml
        toolbarButtons: update|delete
    manage:
        form: $/acme/user/models/phone/fields.yaml
        list: $/acme/user/models/phone/columns.yaml
```

## Displaying a Relation Manager

Before relations can be managed on any page, the target model must first be initialized in the controller by calling the `initRelation` method.

```php
$post = Post::where('id', 7)->first();
$this->initRelation($post);
```

::: tip
The [form controller](./form-controller.md) will automatically initialize the model on its create, update and preview actions.
:::

The relation manager can then be displayed for a specified relation definition by calling the `relationRender` method. For example, if you want to display the relation manager on the [Preview](./form-controller.md) page, the **preview.htm** view contents could look like this.

```php
<?= $this->formRenderPreview() ?>

<?= $this->relationRender('comments') ?>
```

You may instruct the relation manager to render in read only mode by passing the property as the second argument.

```php
<?= $this->relationRender('comments', ['readOnly' => true]) ?>
```

## Extending Relation Behavior

Sometimes you may wish to modify the default relation behavior and there are several ways you can do this.

### Extending Relation Configuration

Provides an opportunity to manipulate the relation configuration. The following example can be used to inject a different columns.yaml file based on a property of your model.

```php
public function relationExtendConfig($config, $field, $model)
{
    // Make sure the model and field matches those you want to manipulate
    if (!$model instanceof MyModel || $field !== 'myField') {
        return;
    }

    // Show a different list for business customers
    if ($model->mode == 'b2b') {
        $config->view['list'] = '$/author/plugin_name/models/mymodel/b2b_columns.yaml';
    }
}
```

### Extending the View Widget

Provides an opportunity to manipulate the view widget. For example you might want to toggle showCheckboxes based on a property of your model.

```php
public function relationExtendViewWidget($widget, $field, $model)
{
    // Make sure the model and field matches those you want to manipulate
    if (!$model instanceof MyModel || $field !== 'myField') {
        return;
    }

    if ($model->constant) {
        $widget->showCheckboxes = false;
    }
}
```

#### How to Remove a Column

Since the widget has not completed initializing at this point of the runtime cycle you can't call `$widget->removeColumn()`. The `addColumns()` method as described in the [List Controller documentation](../lists/list-controller.md) will work as expected, but to remove a column we need to listen to the 'list.extendColumns' event within the `relationExtendViewWidget()` method. The following example shows how to remove a column.

```php
public function relationExtendViewWidget($widget, $field, $model)
{
    // Make sure the model and field matches those you want to manipulate
    if (!$model instanceof MyModel || $field !== 'myField') {
        return;
    }

    // This will work
    $widget->bindEvent('list.extendColumns', function () use ($widget) {
        $widget->removeColumn('my_column');
    });
}
```

### Extending the Manage Widget

Provides an opportunity to manipulate the manage widget of your relation.

```php
public function relationExtendManageWidget($widget, $field, $model)
{
    // Make sure the field is the expected one
    if ($field !== 'myField') {
        return;
    }

    // Manipulate widget as needed
}
```

### Extending the Pivot Widget

Provides an opportunity to manipulate the pivot widget of your relation.

```php
public function relationExtendPivotWidget($widget, $field, $model)
{
    // Make sure the field is the expected one
    if ($field !== 'myField') {
        return;
    }

    // Manipulate widget as needed
}
```

### Extending the Filter Widgets

There are two filter widgets that may be extended using the following methods, one for the view mode and one for the manage mode of the `RelationController`.

```php
public function relationExtendViewFilterWidget($widget, $field, $model)
{
    // Extends the view filter widget
}

public function relationExtendManageFilterWidget($widget, $field, $model)
{
    // Extends the manage filter widget
}
```

Examples on how to add or remove scopes programmatically in the filter widgets can be found in the **Extending filter scopes** section of the [List Controller documentation](../lists/list-controller.md).

### Extending the Refresh Results

The view widget is often refreshed when the manage widget makes a change, you can use this method to inject additional containers when this process occurs. Return an array with the extra values to send to the browser, eg:

```php
public function relationExtendRefreshResults($field)
{
    // Make sure the field is the expected one
    if ($field !== 'myField') {
        return;
    }

    return ['#myCounter' => 'Total records: 6'];
}
```

#### See Also

::: also
* [Relation Form Widget](../../element/form/widget-relation.md)
* [Entries Content Field](../../element/content/field-entries.md)
:::
---
subtitle: A widget specifically made for use as a form field.
---
# Form Widgets

With form widgets you can add new control types to the backend forms. They provide features that are common to supplying data for models. Form widgets must be registered in the [plugin registration file](../extending.md).

Form Widget classes reside inside the **formwidgets** directory of a plugin. The inner directory name matches the name of the widget class written in lowercase. Widgets can supply assets and partials. An example form widget directory structure looks like this.

::: dir
├── `formwidgets`
|   ├── colorpicker
|   |   ├── partials
|   |   |   └── _colorpicker.htm  _← Partial File_
|   |   └── assets
|   |       ├── js
|   |       |   └── colorpicker.js  _← JavaScript File_
|   |       └── css
|   |           └── colorpicker.css  _← StyleSheet File_
|   └── ColorPicker.php  _← Widget Class_
:::

### Class Definition

The `create:formwidget` command generates a backend form widget, view and basic asset files. The first argument specifies the author and plugin name. The second argument specifies the form widget class name.

```bash
php artisan create:formwidget Acme.Blog ColorPicker
```

The form widget classes must extend the `Backend\Classes\FormWidgetBase` class. A registered widget can be used in the backend [form field definition](../../element/form-fields.md) file. Example form widget class definition.

```php
namespace Backend\FormWidgets;

use Backend\Classes\FormWidgetBase;

class ColorPicker extends FormWidgetBase
{
    /**
     * @var string defaultAlias to identify this widget.
     */
    protected $defaultAlias = 'colorpicker';

    public function render() {}
}
```

### Form Widget Properties

Form widgets may have properties that can be set using the [form field configuration](../../element/form-fields.md). Simply define the configurable properties on the class and then call the `fillFromConfig` method to populate them inside the `init` method definition.

```php
class DatePicker extends FormWidgetBase
{
    //
    // Configurable properties
    //

    /**
     * @var string mode for display: datetime, date, time.
     */
    public $mode = 'datetime';

    /**
     * @var string minDate is the minimum/earliest date that can be selected.
     * eg: 2000-01-01
     */
    public $minDate = null;

    /**
     * @var string maxDate is the maximum/latest date that can be selected.
     * eg: 2020-12-31
     */
    public $maxDate = null;

    //
    // Object properties
    //

    /**
     * {@inheritDoc}
     */
    protected $defaultAlias = 'datepicker';

    /**
     * {@inheritDoc}
     */
    public function init()
    {
        $this->fillFromConfig([
            'mode',
            'minDate',
            'maxDate',
        ]);
    }

    // ...
}
```

The property values then become available to set from the [form field definition](../../element/form-fields.md) when using the widget.

```yaml
born_at:
    label: Date of Birth
    type: datepicker
    mode: date
    minDate: 1984-04-12
    maxDate: 2014-04-23
```

### Form Widget Registration

Plugins should register form widgets by overriding the `registerFormWidgets` method inside the [plugin registration file](../extending.md). The method returns an array containing the widget class in the keys and widget short code as the value. Example:

```php
public function registerFormWidgets()
{
    return [
        \Backend\FormWidgets\ColorPicker::class => 'colorpicker',
        \Backend\FormWidgets\DatePicker::class => 'datepicker'
    ];
}
```

The short code is optional and can be used when referencing the widget in the [form field definitions](./form-controller.md), it should be a unique value to avoid conflicts with other form fields.

### Loading Form Data

The main purpose of the form widget is to interact with your model, which means in most cases loading and saving the value via the database. When a form widget renders, it will request its stored value using the `getLoadValue` method. The `getId` and `getFieldName` methods will return a unique identifier and name for a HTML element used in the form. These values are often passed to the widget partial at render time.

```php
public function render()
{
    $this->vars['id'] = $this->getId();
    $this->vars['name'] = $this->getFieldName();
    $this->vars['value'] = $this->getLoadValue();

    return $this->makePartial('myformwidget');
}
```

At a basic level the form widget can send the user input value back using an input element. From the above example, inside the **myformwidget** partial the element can be rendered using the prepared variables.

```php
<input id="<?= $id ?>" name="<?= $name ?>" value="<?= e($value) ?>" />
```

### Saving Form Data

When the time comes to take the user input and store it in the database, the form widget will call the `getSaveValue` internally to request the value. To modify this behavior simply override the method in your form widget class.

```php
public function getSaveValue($value)
{
    return $value;
}
```

In some cases you intentionally don't want any value to be given, for example, a form widget that displays information without saving anything. Return the special constant called `FormField::NO_SAVE_DATA` derived from the `Backend\Classes\FormField` class to have the value ignored.

```php
public function getSaveValue($value)
{
    return \Backend\Classes\FormField::NO_SAVE_DATA;
}
```
---
subtitle: Adds form management features to any backend page.
---
# Form Controller

The `Backend\Behaviors\FormController` class is a controller behavior used for easily adding form functionality to a backend page. The behavior provides three pages called Create, Update and Preview. The Preview page is a read-only version of the Update page. When you use the form behavior you don't need to define the `create`, `update` and `preview` actions in the controller - the behavior does it for you. However you should provide the corresponding view files.

Form behavior depends on form [field definitions](../../element/form-fields.md) and a [model class](../database/model.md). In order to use the form behavior you should add it to the `$implement` property of the controller class. Also, the `$formConfig` class property should be defined and its value should refer to the YAML file used for configuring the behavior properties.

```php
namespace Acme\Blog\Controllers;

class Categories extends \Backend\Classes\Controller
{
    public $implement = [
        \Backend\Behaviors\FormController::class
    ];

    public $formConfig = 'config_form.yaml';
}
```

::: tip
Very often the form and [list controller](../lists/list-controller.md) are used together in a same controller.
:::

## Configuring the Form Behavior

The configuration file referred in the `$formConfig` property is defined in YAML format. The file should be placed into the [controller's view directory](../system/views.md). Below is an example of a typical form behavior configuration file.

```yaml
# config_form.yaml
name: Blog Category
form: $/acme/blog/models/post/fields.yaml
modelClass: Acme\Blog\Post

create:
    title: New Blog Post

update:
    title: Edit Blog Post

preview:
    title: View Blog Post
```

The following properties are required in the form configuration file.

Property | Description
------------- | -------------
**name** | the name of the object being managed by this form.
**form** | a configuration array or reference to a form field definition file, see [form fields](../../element/form-fields.md).
**modelClass** | a model class name, the form data is loaded and saved against this model.

The configuration properties listed below are optional. Define them if you want the form behavior to support the Create, Update or Preview pages.

Property | Description
------------- | -------------
**design** | display the form using a specific form design mode when rendering (see below).
**defaultRedirect** | used as a fallback redirection page when no specific redirect page is defined.
**create** | a configuration array or reference to a config file for the Create page.
**update** | a configuration array or reference to a config file for the Update page.
**preview** | a configuration array or reference to a config file for the Preview page.
**customMessages** | customize the messages used in the Form Controllers.
**permissions** | apply restrictions to certain actions provided by the Form Controller.

### Create Page

To support the Create page add the following configuration to the YAML file.

```yaml
create:
    title: New Blog Post
    redirect: acme/blog/posts/update/:id
    redirectClose: acme/blog/posts
```

The following properties are supported for the Create page.

Property | Description
------------- | -------------
**title** | a page title, can refer to a [localization string](../system/localization.md).
**redirect** | redirection page when record is saved.
**redirectClose** | redirection page when record is saved and the **close** post variable is sent with the request.
**form** | overrides the default form fields definitions for the create page only.

### Update Page

To support the Update page add the following configuration to the YAML file.

```yaml
update:
    title: Edit Blog Post
    redirect: acme/blog/posts
```

The following properties are supported for the Update page.

Property | Description
------------- | -------------
**title** | a page title, can refer to a [localization string](../system/localization.md).
**redirect** | redirection page when record is saved.
**redirectClose** | redirection page when record is saved and **close** post variable is sent with the request.
**form** | overrides the default form fields definitions for the update page only.

### Preview Page

To support the Preview page add the following configuration to the YAML file:

```yaml
preview:
    title: View Blog Post
```

The following properties are supported for the Preview page.

Property  | Description
------------- | -------------
**title** | a page title, can refer to a [localization string](../system/localization.md).
**form** | overrides the default form fields definitions for the preview page only.

### Custom Messages

Specify the `customMessages` property to override the default messages used by the Form Controller. The values can be plain text or can refer to a [localization string](../system/localization.md).

```yaml
customMessages:
    notFound: Did not find the thing
    flashCreate: New thing created
    flashUpdate: Updated that thing
    flashDelete: Thing is gone
```

You may also modify messages in the context of the form being displayed. The following will override the `notFound` message for the `update` context only.

```yaml
update:
    customMessages:
        notFound: Nothing found when updating
```

The following messages are available to override as custom messages.

::: details View the list of available messages
Message | Default Message
------------- | -------------
**notFound** | Form record with an ID of :id could not be found.
**flashCreate** | :name Created
**flashUpdate** | :name Updated
**flashDelete** | :name Deleted
:::

### Restricting with Permissions

Specify the `permissions` property to apply restrictions to actions provided by the Form Controller. Use [permission values](../backend/permissions.md) that the current backend user must have in order for the field to be used. Supports either a string for a single permission or an array of permissions of which only one is needed to grant access.

```yaml
permissions:
    modelCreate: admins.manage.create
    modelDelete: admins.manage.delete
```

The following properties are available to override as required permissions.

::: details View the list of available messages
Message | Default Message
------------- | -------------
**modelCreate** | required to create new records.
**modelUpdate** | required to modify existing records.
**modelPreview** | required to preview existing records.
**modelDelete** | required to delete existing records.
:::

## Defining Form Fields

::: aside
The available form field properties can be found on the [form field definitions](../../element/form-fields.md) page.
:::

Form fields are defined with the YAML file. The form fields configuration is used by the form behavior for creating the form controls and binding them to the model fields.

The file is placed to a subdirectory of the **models** directory of a plugin. The subdirectory name matches the model class name written in lowercase. The file name doesn't matter, but **fields.yaml** and **form_fields.yaml** are common names. Example form fields file location:

::: dir
├── plugins
|   └── acme
|       └── blog
|           └── `models`
|               ├── post  _← Config Directory_
|               |   └── fields.yaml  _← Config File_
|               └── Post.php  _← Model Class_
:::

Fields can be placed in three areas, the **outside area**, **primary tabs** or **secondary tabs**. The next example shows the typical contents of a form fields definition file.

```yaml
# fields.yaml
fields:
    blog_title:
        label: Blog Title
        description: The title for this blog

    published_at:
        label: Published date
        description: When this blog post was published
        type: datepicker

    # [...]

tabs:
    fields:
        # [...]

secondaryTabs:
    fields:
        # [...]
```

## Form Views

For each page your form supports Create, Update and Preview you should provide a [view file](../backend/controllers-ajax.md) with the corresponding name - **create.php**, **update.php** and **preview.php**.

The form behavior adds two methods to the controller class: `formRender`, `formRenderDesign` and `formRenderPreview`. These methods render the form controls configured with the YAML file described above.

### Create View

The **create.php** view represents the Create page that allows users to create new records. A typical Create page contains breadcrumbs, the form itself, and the form buttons. The **data-request** attribute should refer to the `onSave` AJAX handler provided by the form behavior. Below is a contents of the typical create view file.

```php
<?= Form::open(['class' => 'd-flex flex-column h-100']) ?>

    <div class="flex-grow-1">
        <?= $this->formRender() ?>
    </div>

    <div class="form-buttons">
        <div data-control="loader-container">
            <button
                type="button"
                data-request="onSave"
                data-request-data="{ close: true }"
                data-request-message="Creating Category..."
                data-hotkey="ctrl+enter, cmd+enter"
                class="btn btn-default">
                Create and Close
            </button>
            <span class="btn-text">
                or <a href="<?= Backend::url('acme/blog/categories') ?>">Cancel</a>
            </span>
        </div>
    </div>

<?= Form::close() ?>
```

To track unsaved changes and display a warning when navigating away from the form, include the `data-change-monitor` attribute on the form opening tag.

```php
<?= Form::open(['class' => '...', 'data-change-monitor' => true]) ?>
```

### Update View

The **update.php** view represents the Update page that allows users to update or delete existing records. A typical Update page contains breadcrumbs, the form itself, and the form buttons. The Update page is very similar to the Create page, but usually has the Delete button. The **data-request** attribute should refer to the `onSave` AJAX handler provided by the form behavior. Below is a contents of the typical update.php form.

```php
<?= Form::open(['class' => 'd-flex flex-column h-100']) ?>

    <div class="flex-grow-1">
        <?= $this->formRender() ?>
    </div>

    <div class="form-buttons">
        <div data-control="loader-container">
            <button
                type="button"
                data-request="onSave"
                data-request-data="{ close: true }"
                data-request-message="Saving Category..."
                data-hotkey="ctrl+enter, cmd+enter"
                class="btn btn-default">
                Save and Close
            </button>
            <button
                type="button"
                class="oc-icon-trash-o btn-icon danger pull-right"
                data-request="onDelete"
                data-request-message="Deleting Category..."
                data-request-confirm="Do you really want to delete this category?">
            </button>
            <span class="btn-text">
                or <a href="<?= Backend::url('acme/blog/categories') ?>">Cancel</a>
            </span>
        </div>
    </div>

<?= Form::close() ?>
```

### Preview View

The **preview.php** view represents the Preview page that allows users to preview existing records in the read-only mode. A typical Preview page contains breadcrumbs and the form itself. Below is a contents of the typical preview.php form.

```php
<div class="form-preview">
    <?= $this->formRenderPreview() ?>
</div>
```

## Form Designs

The `create:controller` command generates [a controller](../system/controllers.md) and supports the `--design` option to implement the desired display mode, as described below.

```bash
php artisan create:controller Acme.Blog Posts --design=popup
```

Form designs are a useful when you need to display the form without managing the HTML contents, which is less flexible but can make the process of building forms faster.

```yaml
design:
    displayMode: basic
```

The **design** property, in the behavior configuration, controls how the form is displayed. The following properties are supported.

Property | Description
------------- | -------------
**displayMode** | specifies the display mode to use, supported values: `custom`, `basic`, `survey`, `sidebar`, `popup`. Default: `basic`
**horizontalMode** | show form fields in horizontal orientation. Default: `false`
**surveyMode** | disables tabs and displays all fields on the page in sections with headers. Default: `false`
**size** | size of the page container, supported values: `50` stepped increments between `400`-`1200`, `auto`. Default: `auto`
**sidebarSize** | width of the sidebar in `sidebar` mode, supported values `50` steps between `300`-`750`. Default: `300`

Use the `formRenderDesign` method to render the form design inside the **create.php**, **update.php** and **preview.php** view files.

```php
<?= $this->formRenderDesign() ?>
```

### Display Modes

When using a **design** display mode in the behavior configuration, the view contents are generated using standard form contents provided by the system.

The following **displayMode** values are supported with their descriptions.

Display Mode | Description
------------- | -------------
**custom** | Render the form using custom view files (default)
**basic** | Basic layout with for standard forms
**survey** | Survey layout using stacked sections with headings
**sidebar** | Sidebar layout where secondary tabs are rendered in the side panel
**popup** | Form contents are managed inside popup windows

The **size** property defines the size of the page container or the popup size.

```yaml
design:
    displayMode: survey
    size: 950
```

### Popup Display Mode

If the **design** is set to use the `popup` display mode, then you don't need to create any view files at all. All the form management features are contained inside a popup window.

```yaml
design:
    displayMode: popup
    size: 750
```

When integrated with the [list controller](../lists/list-controller.md), set the **recordOnClick** property to `popup` to open the manage view when clicking a record.

```yaml
# config_list.yaml
recordOnClick: popup
```

The create view can be opened using the `onLoadPopupForm` AJAX handler in conjunction with the popup control, as in the example below.

```html
<button
    type="button"
    data-control="popup"
    data-handler="onLoadPopupForm"
    class="btn btn-primary">
    New Item
</button>
```

## Extending Form Behavior

Sometimes you may wish to modify the default form behavior and there are several ways you can do this.

### Extending the Form Configuration

You may extend the form configuration dynamically using the `formGetConfig` method.

```php
public function formGetConfig()
{
    $config = $this->asExtension('FormController')->formGetConfig();

    $config->form = $this->makeConfig($config->form);

    // Set the active tab dynamically
    $config->form->tabs['activeTab'] = 'Activities';

    return $config;
}
```

### Overriding Controller Action

You may use your own logic for the `create`, `update` or `preview` action method in the controller, then optionally call the Form behavior parent method.

```php
public function update($recordId, $context = null)
{
    //
    // Do any custom code here
    //

    // Call the FormController behavior update() method
    return $this->asExtension('FormController')->update($recordId, $context);
}
```

### Overriding Form Save Data

You may use the `formBeforeSave` override (or equivalent) to change the save values of the form before it is saved or updated. To override the save value of a field use the `formSetSaveValue(key, value)` method.

```php
public function formBeforeSave($model)
{
    // When locale dropdown is set to "custom", override with the _custom_locale text field
    if (post('MyModel[locale]') === 'custom') {
        $this->formSetSaveValue('locale', post('MyModel[_custom_locale]'));
    }
}
```

### Overriding Controller Redirect

You can specify the URL to redirect to after the model is saved by overriding the `formGetRedirectUrl` method. This method returns the location to redirect to with relative URLs being treated as backend URLs.

```php
public function formGetRedirectUrl($context = null, $model = null)
{
    return 'https://octobercms.com';
}
```

### Extending Form Model Query

The lookup query for the form [database model](../database/model.md) can be extended by overriding the `formExtendQuery` method inside the controller class. This example will ensure that soft deleted records can still be found and updated, by applying the **withTrashed** scope to the query:

```php
public function formExtendQuery($query)
{
    $query->withTrashed();
}
```

### Extending Form Fields

You may extend the fields of another controller from outside by binding to the `backend.form.extendFields` [global event](../services/event.md). The event function will take a `$form` argument that represents the `Backend\Widgets\Form` object, where you can use the `getController`, `getModel` and `getContext` methods to check the execution context.

Since this event has the potential to affect all forms, it is essential to check that the controller and model is of the correct type. Here is an example using the `addFields` method to add new fields to the mail settings form.

```php
Event::listen('backend.form.extendFields', function($form) {
    if (
        !$form->getController() instanceof \System\Controllers\Settings ||
        !$form->getModel() instanceof \System\Models\MailSetting
    ) {
        return;
    }

    $form->addFields([
        'my_field' => [
            'label' => 'My Field',
            'comment' => 'This is a custom field I have added.',
        ],
    ]);
});
```

You can also extend the form fields internally by overriding the `formExtendFields` method inside the controller class. This will only affect the form used by the `FormController` behavior.

```php
class Categories extends \Backend\Classes\Controller
{
    public $implement = [
        \Backend\Behaviors\FormController::class
    ];

    public function formExtendFields($form)
    {
        $form->addFields([...]);
    }
}
```

The following methods are available on the `$form` object.

Method | Description
------------- | -------------
**addFields** | adds new fields to the outside area
**addTabFields** | adds new fields to the tabbed area
**addSecondaryTabFields** | adds new fields to the secondary tabbed area
**removeField** | remove a field from any areas

Each method takes an array of fields similar to the [form field configuration](../../element/form-fields.md).

### Filtering Form Fields

As described in the [field dependencies section](./field-dependencies.md), you may also implement form field filtering by extension by hooking in to the `form.filterFields` event.

```php
User::extend(function ($model) {
    $model->bindEvent('model.form.filterFields', function ($formWidget, $fields, $context) use ($model) {
        if ($model->source_type === 'http') {
            $fields->source_url->hidden = false;
            $fields->git_branch->hidden = true;
        }
        elseif ($model->source_type === 'git') {
            $fields->source_url->hidden = false;
            $fields->git_branch->hidden = false;
        }
        else {
            $fields->source_url->hidden = true;
            $fields->git_branch->hidden = true;
        }
    });
});
```

## Validating Form Fields

To validate the fields of your form you can make use of the [Validation trait](../database/traits.md) in your model.
---
subtitle: Learn how fields can depend on other fields.
---
# Field Dependencies

Akin to [form field conditions](../../element/form-fields.md), form fields can declare dependencies on other fields by defining the `dependsOn` form field property. This provides a more robust server-side solution for updating fields when their dependencies are modified.

When the fields that are declared as dependencies change, the defining field will update using the AJAX framework. This provides an opportunity to interact with the field's properties using the `filterFields` methods or changing available options to be provided to the field.

```yaml
country:
    label: Country
    type: dropdown

state:
    label: State
    type: dropdown
    dependsOn: country
```

In the above example the `state` form field will refresh when the `country` field has a changed value. When this occurs, the current form data will be filled in the model so the dropdown options can use it.

```php
public function getCountryOptions()
{
    return ['au' => 'Australia', 'ca' => 'Canada'];
}

public function getStateOptions()
{
    if ($this->country == 'au') {
        return ['act' => 'Capital Territory', 'qld' => 'Queensland', ...];
    }
    elseif ($this->country == 'ca') {
        return ['bc' => 'British Columbia', 'on' => 'Ontario', ...];
    }
}
```

## Filtering Fields

You can filter the form field definitions by overriding the `filterFields` method inside the Model used. This allows you to manipulate visibility and other field properties based on the model data. The method takes two arguments **$fields** will represent an object of the fields already defined by the [field configuration](../../element/form-fields.md) and **$context** represents the active form context.

```php
public function filterFields($fields, $context = null)
{
    if ($this->source_type === 'http') {
        $fields->source_url->hidden = false;
        $fields->git_branch->hidden = true;
    }
    elseif ($this->source_type === 'git') {
        $fields->source_url->hidden = false;
        $fields->git_branch->hidden = false;
    }
    else {
        $fields->source_url->hidden = true;
        $fields->git_branch->hidden = true;
    }
}
```

The `$context` value will contain the form context (create, update, etc.) when displaying and saving the form, however, when the form is being refreshed the context will always be set to **refresh**. This is useful for populating fields with new values without forcing it to be the saved value. The following will reset the parent name value if the parent value is changed during a refresh but won't affect the save value.

```php
public function filterFields($fields, $context = null)
{
    if ($context === 'refresh' && $this->parent) {
        $fields->parent_name->value = $this->parent->name;
    }
}
```

The above logic will set the `hidden` flag on certain fields by checking the value of the Model attribute `source_type`. This logic will be applied when the form first loads and also when updated by a defined field dependency. For example, here is the associated form field definitions.

```yaml
source_type:
    label: Source Type
    type: dropdown
    options:
        git: Git
        http: Http
        upload: Upload

source_url:
    label: Source URL
    type: text
    dependsOn: source_type

git_branch:
    label: Git Branch
    type: text
    dependsOn: source_type
```

## Updating with AJAX

In some cases you may wish to run an AJAX handler manually when a field value changes. You may use the `changeHandler` property to specify an AJAX handler. The following example will call the **onChangeContent** AJAX handler when the value is changed.

```yaml
content:
    label: Content
    type: textarea
    changeHandler: onChangeContent
```

The AJAX handler can be added to the controller in the normal way. The following displays a message using the `Flash` facade when the field updates.

```php
public function onChangeContent()
{
    Flash::success('Great job!');
}
```

If you wish to update other fields, use the `formRefreshFields` method provided by the form controller.

```php
public function onChangeContent()
{
    return $this->formRefreshFields('is_positive');
}
```

You may also update multiple fields at once by passing an array.

```php
public function onChangeContent()
{
    return $this->formRefreshFields(['is_positive', 'internal_comments']);
}
```

#### See Also

::: also
* [Form Field Conditions](../../element/form-fields.md)
:::
---
subtitle: Adds list management features to any backend page.
---
# List Controller

The `Backend\Behaviors\ListController` class is a controller behavior used for easily adding a record list to a page. The behavior provides the sortable and searchable list with optional links on its records. The behavior provides the controller action `index` however the list can be rendered anywhere and multiple list definitions can be used.

List behavior depends on list [column definitions](../../element/list-columns.md) and a [model class](../database/model.md). In order to use the list behavior you should add it to the `$implement` property of the controller class. Also, the `$listConfig` class property should be defined and its value should refer to the YAML file used for configuring the behavior properties.

```php
namespace Acme\Blog\Controllers;

class Categories extends \Backend\Classes\Controller
{
    public $implement = [
        \Backend\Behaviors\ListController::class
    ];

    public $listConfig = 'config_list.yaml';
}
```

::: tip
Very often the list and [form controller](../forms/form-controller.md) are used together in a same controller.
:::

## Configuring the List Behavior

The configuration file referred in the `$listConfig` property is defined in YAML format. The file should be placed into the controller's [views directory](../system/controllers.md). Below is an example of a typical list behavior configuration file.

```yaml
# config_list.yaml
title: Blog Posts
list: ~/plugins/acme/blog/models/post/columns.yaml
modelClass: Acme\Blog\Models\Post
recordUrl: acme/blog/posts/update/:id
```

The following properties are required in the list configuration file.

Property | Description
------------- | -------------
**title** | a title for this list.
**list** | a configuration array or reference to a list column definition file, see [list columns](../../element/list-columns.md).
**modelClass** | a model class name, the list data is loaded from this model.

The configuration properties listed below are optional.

Property | Description
------------- | -------------
**filter** | filter configuration, see [list filters](./filters.md).
**recordUrl** | link each list record to another page. Eg: **users/update:id**. The `:id` part is replaced with the record identifier. This allows you to link the list behavior and the [form behavior](../forms/form-controller.md).
**recordOnClick** | custom JavaScript code to execute when clicking on a record.
**noRecordsMessage** | a message to display when no records are found, can refer to a [localization string](../system/localization.md).
**deleteMessage** | a message to display when records are bulk deleted, can refer to a [localization string](../system/localization.md).
**noRecordsDeletedMessage** | a message to display when a bulk delete action is triggered, but no records were deleted, can refer to a [localization string](../system/localization.md).
**recordsPerPage** | records to display per page, use 0 for no pages. Default: `0`
**perPageOptions** | options for number of items per page. Default: `[20, 40, 80, 100, 120]`
**showPageNumbers** | displays page numbers with pagination. Disable this to improve list performance when working with large tables. Default: `true`
**toolbar** | reference to a Toolbar Widget configuration file, or an array with configuration (see below).
**showSorting** | displays the sorting link on each column. Default: `true`
**defaultSort** | sets a default sorting column and direction when user preference is not defined. Supports a string or an array with keys `column` and `direction`. The direction can be `asc` for ascending (default) or `desc` for descending order.
**showCheckboxes** | displays checkboxes next to each record. Default: `false`.
**showSetup** | displays the list column set up button. Default: `false`.
**structure** | enables a structured list, see the [sorting records article](./structures.md) for more details.
**customViewPath** | specify a custom view path to override partials used by the list, optional.
**customPageName** | specify a custom variable name to use in the page URL for paginated records. Set to `false` to disable storing the page number in the URL. Default: `page`.

### Adding a Toolbar

To include a toolbar with the list, add the following configuration to the list configuration YAML file:

```yaml
toolbar:
    buttons: list_toolbar
    search:
        prompt: Find records
```

The toolbar configuration allows:

Property | Description
------------- | -------------
**buttons** | a reference to a controller partial file with the toolbar buttons. Eg: **_list_toolbar.htm**
**search** | reference to a Search Widget configuration file, or an array with configuration.

The search configuration supports the following properties:

Property | Description
------------- | -------------
**prompt** | a placeholder to display when there is no active search, can refer to a [localization string](../system/localization.md).
**mode** | defines the search strategy to either contain all words, any word or exact phrase. Supported options: all, any, exact. Default: all.
**scope** | specifies a [query scope method](../database/model.md) defined in the **list model** to apply to the search query. The first argument will contain the query object (as per a regular scope method), the second will contain the search term, and the third will be an array of the columns to be searched.
**searchOnEnter** | setting this to true will make the search widget wait for the Enter key to be pressed before it starts searching (the default behavior is that it starts searching automatically after someone enters something into the search field and then pauses for a short moment).  Default: false.

The toolbar buttons partial referred above should contain the toolbar control definition with some buttons. The partial could also contain a [scoreboard control](https://octobercms.com/docs/ui/scoreboard) with charts. Example of a toolbar partial with the **New Post** button referring to the **create** action provided by the [form behavior](forms.md):

```php
<div data-control="toolbar">
    <a href="<?= Backend::url('acme/blog/posts/create') ?>"
        class="btn btn-primary oc-icon-plus">
        New Post
    </a>
</div>
```

When using list checkboxes, you may toggle a button's enabled state with the `data-list-checked-trigger` attribute.

```php
<button
    type="button"
    class="btn btn-primary"
    data-list-checked-trigger>
    Delete Selected
</button>
```

You may also pass the checked values to an AJAX request using the `data-list-checked-request` attribute.

```php
<button
    type="button"
    class="btn btn-primary"
    data-request="onDelete"
    data-list-checked-request>
    Delete Selected
</button>
```

### Filtering the List

To filter a list by user defined input, add the following list configuration to the YAML file:

```yaml
filter: $/acme/blog/models/post/scopes.yaml
```

The **filter** property should make reference to a [filter configuration file](./filters.md) path or supply an array with the configuration.

## Defining List Columns

::: aside
The available list column properties can be found on the [list column definitions](../../element/list-columns.md) page.
:::

List columns are defined with the YAML file. The column configuration is used by the list behavior for creating the record table and displaying model columns in the table cells. The file is placed to a subdirectory of the **models** directory of a plugin. The subdirectory name matches the model class name written in lowercase. The file name doesn't matter, but the **columns.yaml** and **list_columns.yaml** are common names. Example list columns file location:

::: dir
├── plugins
|   └── acme
|       └── blog
|           └── `models`
|               ├── post  _← Config Directory_
|               |   └── columns.yaml  _← Config File_
|               └── Post.php  _← Model Class_
:::

The next example shows the typical contents of a list column definitions file.

```yaml
# columns.yaml
columns:
    name: Name
    email: Email
```

## Displaying the List

Usually lists are displayed in the [index view](../system/views.md) file. Since lists include the toolbar, the view file will consist solely of the single `listRender` method call.

```php
<?= $this->listRender() ?>
```

## Multiple List Definitions

The list behavior can support multiple lists in the same controller using named definitions. The `$listConfig` property can be defined as an array where the key is a definition name and the value is the configuration file.

```php
public $listConfig = [
    'templates' => 'config_templates_list.yaml',
    'layouts' => 'config_layouts_list.yaml'
];
```

Each definition can then be displayed by passing the definition name as the first argument when calling the `listRender` method.

```php
<?= $this->listRender('templates') ?>
```

## Extending List Behavior

Sometimes you may wish to modify the default list behavior and there are several ways you can do this.

### Extending the List Configuration

You may extend the list configuration dynamically using the `listGetConfig` method.

```php
public function listGetConfig($definition)
{
    $config = $this->asExtension('ListController')->listGetConfig($definition);

    // Implement structure dynamically
    $config->structure = [
        'showTree' => true
    ];

    return $config;
}
```

### Overriding Controller Action

You may use your own logic for the `index` action method in the controller, then optionally call the List behavior `index` parent method.

```php
public function index()
{
    //
    // Do any custom code here
    //

    // Call the ListController behavior index() method
    $this->asExtension('ListController')->index();
}
```

### Overriding Views

The `ListController` behavior has a main container view that you may override by creating a special file named `_list_container.php` in your controller directory. The following example will add a sidebar to the list:

```php
<?php if ($toolbar): ?>
    <?= $toolbar->render() ?>
<?php endif ?>

<?php if ($filter): ?>
    <?= $filter->render() ?>
<?php endif ?>

<div class="row row-flush">
    <div class="col-sm-3">
        [Insert sidebar here]
    </div>
    <div class="col-sm-9 list-with-sidebar">
        <?= $list->render() ?>
    </div>
</div>
```

The behavior will invoke a `Lists` widget that also contains numerous views that you may override. This is possible by specifying a `customViewPath` property as described in the list configuration options. The widget will look in this path for a view first, then fall back to the default location.

```yaml
# Custom view path
customViewPath: $/acme/blog/controllers/reviews/list
```

::: tip
It is a good idea to use a sub-directory, for example called `list`, to avoid conflicts.
:::

For example, to modify the list body row markup, create a file called `list/_list_body_row.php` in your controller directory.

```php
<tr>
    <?php foreach ($columns as $key => $column): ?>
        <td><?= $this->getColumnValue($record, $column) ?></td>
    <?php endforeach ?>
</tr>
```

### Extending Column Definitions

You may extend the columns of another controller from outside by binding to the `backend.list.extendColumns` [global event](../services/event.md). The event function will take a `$list` argument that represents the `Backend\Widgets\Lists` object, where you can use the `getController` and `getModel` methods to check the execution context.

Since this event has the potential to affect all lists, it is essential to check that the controller and model is of the correct type. Here is an example using the `addColumns` method to add new columns to the event log list, and modify an existing column.

```php
Event::listen('backend.list.extendColumns', function($list) {
    if (
        !$list->getController() instanceof \System\Controllers\EventLogs ||
        !$list->getModel() instanceof \System\Models\EventLog
    ) {
        return;
    }

    // Add a new column
    $list->addColumns([
        'my_column' => [
            'label' => 'My Column'
        ]
    ]);

    // Modify an existing column
    $list->getColumn('title')->useConfig([
        'path' => 'column_title'
    ]);
});
```

You may also extend the list columns internally by overriding the `listExtendColumns` method inside the controller class. This will only affect the list used by the `ListController` behavior.

```php
class Categories extends \Backend\Classes\Controller
{
    public $implement = [
        \Backend\Behaviors\ListController::class
    ];

    public function listExtendColumns($list)
    {
        $list->addColumns([...]);

        $list->getColumn(...);
    }
}
```

The following methods are available on the `$list` object.

Method | Description
------------- | -------------
**addColumns** | adds new columns to the list
**removeColumn** | removes a column from the list
**getColumn** | returns an existing column definition

Each method takes an array of columns similar to the [list column configuration](../../element/list-columns.md).

### Inject CSS Row Class

You may inject a custom css row class by adding a `listInjectRowClass` method on the controller class. This method can take two arguments, **$record** will represent a single model record and **$definition** contains the name of the List widget definition. You may return any string value containing your row classes. These classes will be added to the row's HTML markup.

```php
class Lessons extends \Backend\Classes\Controller
{
    // ...

    public function listInjectRowClass($lesson, $definition = null)
    {
        // Strike through past lessons
        if ($lesson->lesson_date->lt(Carbon::today())) {
            return 'strike';
        }
    }
}
```

A special CSS class `nolink` is available to force a row to be unclickable, even if the `recordUrl` or `recordOnClick` properties are defined for the list widget. Returning this class in an event will allow you to make records unclickable - for example, for soft-deleted rows or for informational rows:

```php
public function listInjectRowClass($record, $value)
{
    if ($record->trashed()) {
        return 'nolink';
    }
}
```

### Overriding Column URL

You may specify the click action for a column record by overriding the `listOverrideRecordUrl` method. This method can return a string for a new backend URL or an array with a complex definition.

```php
public function listOverrideRecordUrl($record, $definition = null)
{
    if ($record->is_active) {
        return 'acme/test/services/preview/' . $record->id;
    }
}
```

To override the onclick behavior return an array with the `onclick` key and change the `url` to null.

```php
public function listOverrideRecordUrl($record, $definition = null)
{
    if ($record->is_banned) {
        return ['onclick' => "alert('Unable to click')", 'url' => null];
    }
}
```

To make a column unclickable entirely return an array with the `clickable` key set to false.

```php
public function listOverrideRecordUrl($record, $definition = null)
{
    if ($record->is_disabled) {
        return ['clickable' => false];
    }
}
```

### Extending Filter Scopes

You may extend the filter scopes of another controller by binding to the `backend.filter.extendScopes` [global event](../services/event.md). This method can take the argument `$filter` which will represent the `Backend\Widgets\Filter` object, where you can use the `getController`, `getModel` and `getContext` methods to check the execution context.

Since this event has the potential to affect all filters, it is essential to check that the controller and model is of the correct type. Here is an example using the `addScopes` method to add new fields to the event log list, and adjust the CSS classes.

```php
Event::listen('backend.filter.extendScopes', function($filter) {
    if (
        !$filter->getController() instanceof \System\Controllers\EventLogs ||
        !$filter->getModel() instanceof \System\Models\EventLog
    ) {
        return;
    }

    // Add a new scope
    $filter->addScopes([
        'my_scope' => [
            'label' => 'My Filter Scope'
        ]
    ]);

    // Add custom CSS classes to the filter widget
    $filter->cssClasses = array_merge(
        $filter->cssClasses,
        ['my-array', 'of-classes']
    );
});
```

You may also extend the filter scopes internally to the controller class, simply override the `listFilterExtendScopes` method.

```php
class Categories extends \Backend\Classes\Controller
{
    public $implement = [
        \Backend\Behaviors\ListController::class
    ];

    public function listFilterExtendScopes($filter)
    {
        $filter->addScopes([...]);
    }
}
```

The following methods are available on the `$filter` object. The scopes available are the same as the [list filters configuration](./filters.md).

Method | Description
------------- | -------------
**addScopes** | adds new scopes to filter widget using [list filters configuration](./filters.md)
**removeScope** | remove scope from filter widget
**getScope** | returns an existing scope definition

#### Extending the Filter Response

The `listExtendRefreshResults` method can interact with the AJAX update response when the list updates, and should return an array of additional partial updates. The `listGetFilterWidget` will return the filter widget for access to the scopes.

```php
public function listExtendRefreshResults($filter, $result)
{
    $statusCode = $this->listGetFilterWidget()->getScope('status_code')->value;

    return ['#my-partial-id' => $this->makePartial(...)];
}
```

### Extending the Model Query

The lookup query for the list [database model](../database/model.md) can be extended by overriding the `listExtendQuery` method inside the controller class. This example will ensure that soft deleted records are included in the list data, by applying the **withTrashed** scope to the query:

```php
public function listExtendQuery($query)
{
    $query->withTrashed();
}
```

When dealing with multiple lists definitions in a same controller, you can use the second parameter of `listExtendQuery` which contains the name of the definition :

```php
public $listConfig = [
    'inbox' => 'config_inbox_list.yaml',
    'trashed' => 'config_trashed_list.yaml'
];

public function listExtendQuery($query, $definition)
{
    if ($definition === 'trashed') {
        $query->onlyTrashed();
    }
}
```

You may also join other tables to aid with searching and sorting. The following will join the `post_statuses` table and introduce the `status_sort_order` and `status_name` columns to the query.

```php
public function listExtendQuery($query, $definition = null)
{
    $query->leftJoin('post_statuses', 'posts.status_id', 'post_statuses.id');

    $query->addSelect(
        'post_statuses.sort_order as status_sort_order',
        'post_statuses.name as status_name'
    );
}
```

The [list filter](./filters.md) model query can also be extended by overriding the `listFilterExtendQuery` method.

```php
public function listFilterExtendQuery($query, $scope)
{
    if ($scope->scopeName == 'status') {
        $query->where('status', '<>', 'all');
    }
}
```

### Extending the Records Collection

The collection of records used by the list can be extended by overriding the `listExtendRecords` method inside the controller class. This example uses the `sort` method on the [record collection](../database/collection.md) to change the sort order of the records.

```php
public function listExtendRecords($records)
{
    return $records->sort(function ($a, $b) {
        return $a->computedVal() > $b->computedVal();
    });
}
```

### Custom Column Types

Custom list column types can be registered in the back-end with the `registerListColumnTypes` method of the [plugin registration file](../extending.md). The method should return an array where the key is the type name and the value is a callable function. The callable function receives three arguments, the native `$value`, the `$column` definition object and the model `$record` object.

```php
public function registerListColumnTypes()
{
    return [
        // A local method, i.e $this->evalUppercaseListColumn()
        'uppercase' => [$this, 'evalUppercaseListColumn'],

        // Using an inline closure
        'loveit' => function($value) { return 'I love '. $value; }
    ];
}

public function evalUppercaseListColumn($value, $column, $record)
{
    return strtoupper($value);
}
```

Using the custom list column type is as simple as calling it by name using the `type` property.

```yaml
# columns.yaml
columns:
    secret_code:
        label: Secret code
        type: uppercase
```
---
subtitle: Learn how to filter records found in a list.
---
# Filtering Records

October CMS provides features for filtering database records. For behaviors that support filters, you can define a **filter** option to enable the feature. Scopes are often stored in the model configuration directory as **scopes.yaml**.

## Configuring a Behavior

The [List Controller](./list-controller.md) and [Relation Controller](../forms/relation-controller.md) backend behaviors can be filtered by adding a **filter** property to the configuration. When defined, the available filters are shown above the list.

```yaml
# config_list.yaml

# ...

# Displays the list filter
filter: $/october/test/models/user/scopes.yaml
```

## Defining Filter Scopes

::: aside
The available filter scope properties can be found on the [filter scope definitions](../../element/filter-scopes.md) page.
:::

Similarly filters are driven by their own configuration file that contain filter **scopes**. Each scope is an aspect by which the list can be filtered. The next example shows a typical contents of the filter definition file.

```yaml
# scopes.yaml
scopes:

    category:
        label: Category
        modelClass: Acme\Blog\Models\Category
        conditions: category_id in (:value)
        nameFrom: name

    status:
        label: Status
        type: group
        conditions: status in (:value)
        options:
            pending: Pending
            active: Active
            closed: Closed

    published:
        label: Hide published
        type: checkbox
        default: 1
        conditions: is_published <> true

    approved:
        label: Approved
        type: switch
        default: 2
        conditions:
            - is_approved <> true
            - is_approved = true

    created_at:
        label: Date
        type: date
        conditions:
            after: created_at >= ':value'
            between: created_at >= ':after' AND created_at <= ':before'
```

### Filter Dependencies

Filter scopes can declare dependencies on other scopes by defining the `dependsOn` property, which provide a server-side solution for updating scopes when their dependencies are modified. When the scopes that are declared as dependencies change, the defining scope will reset and update dynamically. This provides an opportunity to change the available options to be provided to the scope.

```yaml
country:
    label: Country
    type: group
    conditions: country_id in (:value)
    modelClass: October\Test\Models\Location
    options: getCountryOptions

city:
    label: City
    type: group
    conditions: city_id in (:value)
    modelClass: October\Test\Models\Location
    options: getCityOptions
    dependsOn: country
```

In the above example, the `city` scope will refresh when the `country` scope has changed. Any scope that defines the `dependsOn` property will be passed all current scope objects for the Filter widget, including their current values, as an array that is keyed by the scope names.

```php
public function getCountryOptions()
{
    return Country::lists('name', 'id');
}

public function getCityOptions($scopes = null)
{
    if (!empty($scopes['country']->value)) {
        return City::whereIn('country_id', $scopes['country']->value)->lists('name', 'id');
    }
    else {
        return City::lists('name', 'id');
    }
}
```

You can filter the filter scope definitions by overriding the `filterScopes` method inside the Model used. This allows you to manipulate visibility and other scope properties based on other scope values. The method takes two arguments **$scopes** will represent an object of the scopes already defined by the scope configuration and **$context** represents the active filter context.

```php
public function filterScopes($scopes, $context = null)
{
    if ($scopes->disable_roles->value) {
        $scopes->roles->hidden = true;
    }
}
```

The above logic will hide the `roles` scope if the `disable_roles` value is checked. The logic will be applied when the filter first loads and also when updated by a scope dependency. For example, here is the associated filter scope definitions.

```yaml
disable_roles:
    type: checkbox
    label: Disable Roles

roles:
    type: text
    label: Role
    dependsOn: disable_roles
```
---
subtitle: A widget specifically made for use in a filter.
---
# Filter Widgets

With filter widgets you can add new scope types to the backend filters. They provide features that are common to filtering lists. Filter widgets must be registered in the [plugin registration file](../extending.md).

Filter Widget classes reside inside the **filterwidgets** directory of the plugin directory. The inner directory name matches the name of the widget class written in lowercase. Widgets can supply assets and partials. An example form widget directory structure looks like this.

::: dir
├── `filterwidgets`
|   ├── discount
|   |   ├── partials
|   |   |   └── _discount.htm  _← Partial File_
|   |   |   └── _discount_form.htm
|   |   └── assets
|   |       ├── js
|   |       |   └── discount.js  _← JavaScript File_
|   |       └── css
|   |           └── discount.css  _← StyleSheet File_
|   └── Discount.php  _← Widget Class_
:::

## Class Definition

The `create:filterwidget` command generates a backend filter widget, view and basic asset files. The first argument specifies the author and plugin name. The second argument specifies the form widget class name.

```bash
php artisan create:filterwidget Acme.Blog Discount
```

The filter widget classes must extend the `Backend\Classes\FilterWidgetBase` class. A registered widget can be used in the backend [filter field definition](../../element/filter-scopes.md) file. Example form widget class definition.

```php
namespace Backend\FilterWidgets;

use Backend\Classes\FilterWidgetBase;

class Discount extends FilterWidgetBase
{
    public function render() {}

    public function renderForm() {}
}
```

## Filter Widget Properties

Filter widgets may have properties that can be set using the [filter scope configuration](../../element/filter-scopes.md). Simply define the configurable properties on the class and then call the `fillFromConfig` method to populate them inside the `init` method definition.

```php
class Discount extends FormWidgetBase
{
    /**
     * @var bool allowSearch show the search input in the dropdown
     */
    public $allowSearch = false;

    /**
     * init the widget
     */
    public function init()
    {
        $this->fillFromConfig([
            'allowSearch',
        ]);
    }

    // ...
}
```

The property values then become available to set from the [filter scope definition](../../element/filter-scopes.md) when using the widget.

```yaml
discount:
    label: Discount
    type: discount
    allowSearch: true
```

## Filter Widget Registration

Plugins should register filter widgets by overriding the `registerFilterWidgets` method inside the [plugin registration file](../extending.md). The method returns an array containing the widget class in the keys and widget short code as the value. Example:

```php
public function registerFilterWidgets()
{
    return [
        \Backend\FilterWidgets\Discount::class => 'discount',
    ];
}
```

The short code is used when referencing the widget in the filter scope definitions and it should be a unique value to avoid conflicts with other filter fields.

## Displaying the Filter State

The main purpose of the filter widget is to apply a scope to the query of a model, which means capturing values from the user first. The `render` method is used to display the initial state of the filter and the `filterScope` property will contain active value along with other configured properties.

```php
public function render()
{
    $this->vars['scope'] = $this->filterScope;
    $this->vars['name'] = $this->getScopeName();
    $this->vars['value'] = $this->getLoadValue();

    return $this->makePartial('discount');
}
```

At a basic level the filter widget should show a label and its current state to the user. The contents are also wrapped in an anchor that is used to display the filter form.

```php
<a
    href="javascript:;"
    class="filter-scope <?= $value ? 'active' : '' ?>"
    data-scope-name="<?= $name ?>"
>
    <span class="filter-label"><?= e(trans($scope->label)) ?></span>
    <?php if ($value): ?>
        <span class="filter-setting">1</span>
    <?php endif ?>
</a>
```

## Displaying the Filter Form

When a user clicks on the filter label, a form is displayed so that they may specify how to apply the filter. The `renderForm` method is used to display the filter form and should correspond to a `_discount_form.php` partial.

```php
public function renderForm()
{
    $this->vars['allowSearch'] = $this->allowSearch;
    $this->vars['scope'] = $this->filterScope;
    $this->vars['name'] = $this->getScopeName();
    $this->vars['value'] = $this->getLoadValue();

    return $this->makePartial('discount_form');
}
```

The contents should contain the form values and buttons to apply or clear the filter. A form HTML tag is not required and all inputs should belong to the `Filter[]` input array. The most common place to store the filtered value is the `value` attribute.

```php
<div class="filter-box">
    <div class="filter-facet">
        <div class="facet-item is-grow">
            <select name="Filter[value]" class="form-control form-control-sm custom-select <?= $allowSearch ? '' : 'select-no-search' ?>">
                <option value="1" <?= $scope->value === '1' ? 'selected="selected"' : '' ?>>has a discount</option>
                <option value="0" <?= $scope->value === '0' ? 'selected="selected"' : '' ?>>does not have a discount</option>
            </select>
        </div>
    </div>
    <div class="filter-buttons">
        <button class="btn btn-sm btn-primary" data-filter-action="apply">
            Apply
        </button>
        <div class="flex-grow-1"></div>
        <button class="btn btn-sm btn-secondary" data-filter-action="clear">
            Clear
        </button>
    </div>
</div>
```

::: tip
The `$value` variable will contain an array of the selected values. This array will be merged with the `$scope` variable for convenience, so you can access the active value via `$scope->value`. In summary, use `$value` to check if a scope is applied and `$scope` to access the values.
:::

## Capturing the Filter Value

The `getActiveValue` method is used to capture the filtered form values and storing them. It should return an array (or null) and use postback data for finding the values. If the `clearScope` postback value exists, it means the scope wants to be cleared. You may use the `hasPostValue` helper method to check if the value was found and is not an empty string.

```php
public function getActiveValue()
{
    if (post('clearScope')) {
        return null;
    }

    if (!$this->hasPostValue('value')) {
        return null;
    }

    return post('Filter');
}
```

## Applying the Scope to the Query

Once a filter value has been captured it can be applied to the query with the `applyScopeToQuery` method. The value can be taken from the `filterScope->value` property where the `value` name comes from the filter form values.

```php
public function applyScopeToQuery($query)
{
    $hasDiscount = $this->filterScope->value;

    if ($hasDiscount) {
        $query->where('discount', '>', 0);
    }
    else {
        $query->where('discount', 0);
    }
}
```
---
subtitle: Learn how to sort and structure records in a list.
---
# Sorting Records

October CMS provides features for sorting and reordering database records. For behaviors that support structured lists, you can define a **structure** property to enable the feature. Various [model traits](../database/traits.md) are used to support reordering including nested sets, simple trees and sortable models.

## Configuring a Behavior

The [List Controller](./list-controller.md) and [Relation Controller](../forms/form-controller.md) backend behaviors currently support the option to reorder records using the **structure** property in the relevant definition. When defined, the page displays a list of records with a drag handle allowing them to be sorted and restructured.

```yaml
# config_list.yaml

# ...

structure:
    showTree: true
    showReorder: true
    showSorting: false
    maxDepth: 2
```

The configuration properties listed below can be used.

Property | Description
------------- | -------------
**showTree** | displays a tree hierarchy for parent/child records. Default: `true`
**treeExpanded** | if tree nodes should be expanded by default. Default: `true`
**showReorder** | displays an interface for reordering records. Default: `true`
**showSorting** | allows sorting records, disables the structure when sorted. Default: `true`
**maxDepth** | defines the maximum levels allowed for reordering. Default: `null`
**dragRow** | allow dragging the entire row in addition to the reorder handle. Default: `true`
**permissions** | the [permissions](../../extend/backend/permissions.md) that the current backend user must have to modify the structure. Supports either a string for a single permission or an array of permissions of which only one is needed to grant access.

## Supported Model Types

Depending on the requirements, a different model interface can be used for managing nested and sorted records. The behavior will adapt depending on which trait is implemented.

### Nested Set

Use the `NestedTree` trait when a fixed structure is needed. This includes parent-child relationships and when records need to be displayed in a specific order.

```php
class Category extends Model
{
    use \October\Rain\Database\Traits\NestedTree;
}
```

Read more about the `NestedTree` trait in the [database documentation](../database/traits.md).

### Simple Tree

Use the `SimpleTree` trait when a basic parent-child relationship is needed.

```php
class Category extends Model
{
    use \October\Rain\Database\Traits\SimpleTree;
}
```

Read more about the `SimpleTree` trait in the [database documentation](../database/traits.md).

### Sortable Model

Use the `Sortable` trait when records need to be displayed in a specific order.

```php
class User extends Model
{
    use \October\Rain\Database\Traits\Sortable;
}
```

Read more about the `Sortable` trait in the [database documentation](../database/traits.md).

## Sorting Related Records

Sorting related records is possible using the [Relation Controller](../forms/relation-controller.md) using the **structure** property. The supported relation types are listed below.

- [Has Many](../database/relations.md#relation-one-to-many) uses the `Sortable` trait on the related model.
- [Belongs To Many](../database/relations.md#relation-many-to-many) uses the `SortableRelation` trait on the parent model (see below).

### Sortable Relation Model Trait

Use the `SortableRelation` model trait when records need to be sorted inside a pivot table, such as a [Belongs To Many](../database/relations.md#many-to-many) relation type. This trait requires the `pivotSortable` property to be defined in the relationship where the value is the sortable column name found in the pivot table.

```php
class User extends Model
{
    use \October\Rain\Database\Traits\SortableRelation;

    /**
     * @var array belongsToMany
     */
    public $belongsToMany = [
        'roles' => [
            Role::class,
            'table' => 'users_roles',
            'pivotSortable' => 'sort_order',
        ]
    ];
}
```

Then inside your relation configuration, you should enable the `showReorder` property and disable the `showTree` property.

```yaml
roles:
    #...
    structure:
        showReorder: true
        showTree: false
```
# Publishing Packages

October CMS uses [Composer](https://getcomposer.org/) to publish packages and is fully compatible, so their documentation applies as an extension of this article.

To publish your plugin or theme on the October CMS marketplace, you will need to first become an author and choose an author code. This code will determine the name of your packages and cannot be changed later.

Your package should reside in a source control repository that can be accessed by the October CMS gateway, such as [GitHub](https://github.com/) or [BitBucket](https://bitbucket.org/). For private packages, the server can access them using the credentials you provide during the publishing process.

Be sure to start your package `name` ends with **-plugin** or **-theme** respectively, this will help others find your package and is in accordance with the [Developer Guide](https://octobercms.com/help/guidelines/developer#package-naming).

::: warning
When updating your plugins or themes to be compatible with newer versions of October CMS, it is essential to follow [Semantic Versioning](https://semver.org/) to protect older sites from breaking changes.
:::

## Publishing Plugins

When publishing your plugin the `composer.json` file should have this JSON content at a minimum. Notice that the package name must end with **-plugin** and include the `composer/installers` package as a dependency.

```json
{
    "name": "acme/blog-plugin",
    "type": "october-plugin",
    "description": "Enter a meaningful description here",
    "require": {
        "composer/installers": "~1.0"
    }
}
```

A plugin with the code **Acme.Blog** will have a composer package name of `acme/blog-plugin` and will be installed in the **plugins/acme/blog** directory.

## Publishing Themes

When publishing your theme the `composer.json` file should have this JSON content at a minimum. Notice that the package name must end with **-theme** and include the `composer/installers` package as a dependency.

```json
{
    "name": "acme/boilerplate-theme",
    "type": "october-theme",
    "description": "Enter a meaningful description here",
    "require": {
        "composer/installers": "~1.0"
    }
}
```

A plugin with the code **Acme.Boilerplate** will have a composer package name of `acme/boilerplate-theme` and be installed in the **themes/boilerplate** directory.

## Declaring Dependencies

Plugins and themes alike can require a specific version of October CMS and also depend on other packages, simply include them in your composer.json file.

### Requiring a Version of October CMS

Simply require the `october/rain` package to the desired [target version pattern](https://getcomposer.org/doc/articles/versions.md). The following will require that the platform installation uses version 3.1 of October CMS or above.

```json
"require": {
    "october/rain": ">=3.1"
}
```

### Requiring Another Plugin

Navigate to your theme or plugin directory and open the composer.json file to include a dependency and its target version. The following will include the Acme.Blog plugin with a [version range of 1.2](https://getcomposer.org/doc/articles/versions.md).

```json
"require": {
    "acme/blog-plugin": "^1.2"
}
```

You should also make sure that this package is included in the `$require` property found in the [plugin registration file](../system/plugins.md).

### Requiring Another Theme

Navigate to your theme or plugin directory and open the composer.json file to include a dependency and its target version. The following will include the Acme.Vanilla theme with a [version range of 1.2](https://getcomposer.org/doc/articles/versions.md).

```json
"require": {
    "acme/vanilla-theme": "^1.2"
}
```

Make sure that this package is included in the `require` property found in the [theme information file](../../cms/themes/settings.md).

### Developing With Third Party Packages

To create a new plugin or theme that uses an external package or library, you should install it to your root composer file and then copy the definition across to your plugin composer file. For example, if you want your plugin `acme/blog-plugin` to depend on the `aws/aws-sdk-php` package.

1. In the root directory, run `composer require aws/aws-sdk-php`. This will install the package to the root composer file and ensure that it is compatible with other packages.

2. Once completed, open the root directory **composer.json** file to locate the newly defined dependency. For example, you will see something like this:

```json
"require": {
    "aws/aws-sdk-php": "^3.158"
}
```

3. Copy this definition from the root **composer.json** file and include it in the **plugins/acme/blog/composer.json** file for your plugin. Now the dependency is available to your app and also required by the plugin for others to use.

## Tagging a Release

Packages in October CMS follow [semantic versioning](https://semver.org/) and Composer uses git to determine the stability and impact of a given release.

### Semantic Versioning

Semantic Versioning is a process that protects old sites from breaking changes. It is important to note that by default, Composer will not automatically update a major version.

The following version path will be a **manual process** to upgrade:

- Upgrading from `v1.0.0` to `v2.0.0`

Composer will **automatically update** minor and patch versions:

- Updating from `v1.2.0` to `v1.3.0`
- Updating from `v1.3.5` to `v1.3.6`

Read the composer article on [Composer Versions and Constraints](https://getcomposer.org/doc/articles/versions.md) to learn more.

### Listing Your Tags

Use the `git tag` command to list the existing tags for your package.

```bash
$ git tag
v1.0
v2.0
```

### Creating a New Tag

To create a new tag add (`-a`) the version with an optional (`-m`) message.

```bash
git tag -a v2.0.1 -m "Version 2 is here!"
```

### Incrementing the Version File

In addition to tagging, you should also increment the version file found in your [plugin version file](../system/plugins.md) or [theme settings](../../cms/themes/settings.md). This file instructs the October CMS gateway about the latest version, and contains the previous version history.

To help understand how this works:

- The gateway uses the version file found in the **default branch** of the repo.
- Composer will install and update using the **latest stable tag** of the repo.

This means the version file in the default branch should always match the latest stable tag in Git.

## Private Plugins and Themes

Composer allows you to add private repositories from GitHub and other providers to your October CMS projects. Make sure you have followed the same instructions for publishing plugins and themes respectively.

In all cases, you should have a copy of your private plugin or theme stored somewhere available to the main project. The `plugin:install` and `theme:install` commands can be used to install private plugins from either a remote or local source. This will add the location to your composer file and install it like any other package.

### Install from a Remote Source

Use the `--from` option to specify the location to your remote source when installing.

```bash
php artisan plugin:install Acme.Blog --from=git@github.com:acme/blog-plugin.git
```

To use a specific version or branch, use the `--want` option, for example to request the **develop** branch version.

```bash
php artisan plugin:install Acme.Blog --from=git@github.com:acme/blog-plugin.git --want=dev-develop
```

::: tip
If you use the `git@` address of a repository, composer will prefer the source version and clone the repository so you can continue to push updates normally.
:::

### Install from a Local Source

To install a plugin using composer from the same project source.

```bash
php artisan plugin:install Acme.Blog --from=./plugins/acme/blog
```

You may also use a source found on a local or network drive.

```bash
php artisan plugin:install Acme.Blog --from=/home/sam/private-plugins/acme-blog
```

#### See Also

::: also
* [Semantic Versioning](https://semver.org/)
* [Composer Versions and Constraints](https://getcomposer.org/doc/articles/versions.md)
:::
# Using Laravel Packages

When including Laravel packages in October CMS plugins there are a few things to take note of.

### Configuration Files

Laravel packages will often provide configuration files, you should duplicate this configuration to your plugin's directory. For example, if the file was named **purifier.php** and contained some basic configuration values.

```php
return [
    'encoding' => 'UTF-8',
    'finalize' => true,
    'cachePath' => storage_path('app/purifier'),
    'cacheFileMode' => 0755,
];
```

Copy this file to your plugin directory, for example, **plugins/acme/blog/config/purifier.php**. It is important to copy and maintain the entire file as any missing keys will not be inherited from the base configuration.

Next you should transfer the contents of your plugin's configuration to the package configuration inside the `boot()` method.

```php
public function boot()
{
    Config::set('purifier', Config::get('acme.blog::purifier'));
}
```

This will set all the package config values to be that of your plugin config values. The following values would then be equal.

```php
Config::get('purifier.encoding') === Config::get('acme.blog::purifier.encoding');
```

Now you are free to provide the packages configuration values the same way you would with regular plugin configuration values and the [standard configuration approach](../settings/file-settings.md).

### Aliases & Service Providers

If the Laravel package contains any Service Providers and Aliases, you should manually register them in your plugins using the the `App` facade in the `register()` method.

```php
public function register()
{
    // Register the aliases provided by the packages used by your plugin
    App::registerClassAlias('Purifier', \Mews\Purifier\Facades\Purifier::class);

    // Register the service providers provided by the packages used by your plugin
    App::register(\Mews\Purifier\PurifierServiceProvider::class);
}
```

### Migrations & Models

Laravel packages that interact with the database will often include their own database migrations and Eloquent models. You should duplicate these migrations and models to your plugin's directory.

Be sure to change the Model classes to extend the base `October\Rain\Database\Model` class instead of the base Laravel Eloquent model class to take advantage of the extended technology features found in October CMS.

It is also a good idea to rename the database tables and prefix them with your author code and plugin name. For example, a table with the name `posts` should be renamed to `rainlab_blog_posts`.
---
subtitle: Learn about the common methods used to extend October CMS.
---
# Extension Methodology

## Extending by Plugin Registration

In almost all situations, extending October CMS happens in the plugin registration file, which is essentially a [Laravel Service Provider](https://laravel.com/docs/10.x/providers). The registration file is called **Plugin.php** and is found in the root directory of a plugin.

The following extension methods are available to override in the plugin registration class:

Method | Description
------------- | -------------
**register()** | called when the plugin is first registered, called before `boot`.
**boot()** | called right before the request route, called after `register`.
**registerMarkupTags()** | registers [additional markup tags](./twig-tags.md) that can be used in the CMS.
**registerComponents()** | registers any [CMS components](./cms-components.md) used by this plugin.
**registerNavigation()** | registers [backend navigation menu items](./backend/navigation.md) for this plugin.
**registerPermissions()** | registers any [backend permissions](./backend/permissions.md) used by this plugin.
**registerSettings()** | registers any [backend configuration links](./settings/settings.md) used by this plugin.
**registerFormWidgets()** | registers any [backend form widgets](./forms/form-widgets.md) supplied by this plugin.
**registerReportWidgets()** | registers any [backend report widgets](./backend/report-widgets.md), including the dashboard widgets.
**registerListColumnTypes()** | registers any [custom list column types](./lists/list-controller.md) supplied by this plugin.
**registerMailTemplates()** | registers any [mail view templates](./system/sending-mail.md) supplied by this plugin.
**registerMailLayouts()** | registers any [mail view layouts](./system/sending-mail.md) supplied by this plugin.
**registerMailPartials()** | registers any [mail view partials](./system/sending-mail.md) supplied by this plugin.
**registerSchedule()** | registers [scheduled tasks](./system/scheduling.md) that are executed on a regular basis.
**registerContentFields()** | registers [content fields](../extend/tailor-fields.md) that are used by Tailor blueprints.

## Extending with Events

The [Event service](./services/event.md) is the primary way to inject or modify the functionality of core classes or other plugins. This service can be imported for use in any class by adding `use Event` to the top of your PHP file (after the namespace statement) to import the Event facade.

### Subscribing to Events

The most common place to subscribe to an event is the `boot` method of the plugin registration file. For example, when a user is first registered you might want to add them to a third party mailing list, this could be achieved by subscribing to a `rainlab.user.register` global event.

```php
class Plugin extends PluginBase
{
    // ...

    public function boot()
    {
        Event::listen('rainlab.user.register', function ($user) {
            // Code to register $user->email to mailing list
        });
    }
}
```

The same can be achieved by extending the model's constructor and using a local event.

```php
User::extend(function ($model) {
    $model->bindEvent('user.register', function () use ($model) {
        // Code to register $model->email to mailing list
    });
});
```

### Declaring / Firing Events

Fire events locally by calling `fireEvent()` on an instance of an object that implements `October\Rain\Support\Traits\Emitter`. Since local events are only fired on a specific object instance, it is not required to namespace them as it is less likely that a given project would have multiple events with the same name being fired on the same objects within a local context.

```php
$this->fireEvent('post.beforePost', [$firstParam, $secondParam]);
```

Global events are fired by calling `Event::fire()`. As these events are global across the entire application, it is best practice to namespace them by including the vendor information in the name of the event. If your plugin Author is ACME and the plugin name is Blog, then any global events provided by the ACME.Blog plugin should be prefixed with `acme.blog`.

```php
Event::fire('acme.blog.post.beforePost', [$firstParam, $secondParam]);
```

If both global and local events are provided at the same place it's best practice to fire the local event before the global event so that the local event takes priority. Additionally, the global event should provide the object instance that the local event was fired on as the first parameter.

```php
$this->fireEvent('post.beforePost', [$firstParam, $secondParam]);
Event::fire('rainlab.blog.beforePost', [$this, $firstParam, $secondParam]);
```

Once this event has been subscribed to, the parameters are available in the handler method. For example:

```php
// Global
Event::listen('acme.blog.post.beforePost', function ($post, $param1, $param2) {
    Log::info($post->name . 'posted. Parameters: ' . $param1 . ' ' . $param2);
});

// Local
$post->bindEvent('post.beforePost', function ($param1, $param2) use ($post) {
    Log::info($post->name . 'posted. Parameters: ' . $param1 . ' ' . $param2);
});
```

## Extending Backend Views

Sometimes you may wish to allow a backend view file or partial to be extended, such as a toolbar. This is possible using the `fireViewEvent` method found in all backend controllers.

Place this code in your view file:

```php
<div class="footer-area-extension">
    <?= $this->fireViewEvent('backend.auth.extendSigninView', [$firstParam]) ?>
</div>
```

This will allow other plugins to inject HTML to this area by hooking the event and returning the desired markup.

```php
Event::listen('backend.auth.extendSigninView', function ($controller, $firstParam) {
    return '<a href="#">Sign in with Google!</a>';
});
```

::: tip
The first parameter in the event handler will always be the calling object (the controller).
:::

The above example would output the following markup:

```html
<div class="footer-area-extension">
    <a href="#">Sign in with Google!</a>
</div>
```

## Usage Examples

These are some practical examples of how events can be used.

### Extending a User Model

This example will modify the `model.getAttribute` event of the `User` model by binding to its local event. This is carried out inside the `boot` method of the plugin registration file. In both cases, when the `$model->foo` attribute is accessed it will return the value **bar**.

```php
// Local event hook that affects all users
User::extend(function ($model) {
    $model->bindEvent('model.getAttribute', function ($attribute, $value) {
        if ($attribute === 'foo') {
            return 'bar';
        }
    });
});

// Double event hook that affects user #2 only
User::extend(function ($model) {
    $model->bindEvent('model.afterFetch', function () use ($model) {
        if ($model->id !== 2) {
            return;
        }

        $model->bindEvent('model.getAttribute', function ($attribute, $value) {
            if ($attribute === 'foo') {
                return 'bar';
            }
        });
    });
});
```

To add model validation for introduced fields, hook into the `beforeValidate` event and throw a `ValidationException` exception.

```php
User::extend(function ($model) {
    $model->bindEvent('model.beforeValidate', function () use ($model) {
        if (!$model->billing_first_name) {
            throw new \ValidationException(['billing_first_name' => 'First name is required']);
        }
    });
});
```

### Extending Backend Forms

::: aside
There are a number of ways to extend backend forms, see the [Backend Controller article](./forms/form-controller.md) for more information.
:::

This example will listen to the `backend.form.extendFields` global event of the `Backend\Widget\Form` widget and inject some extra fields when the Form widget is being used to modify a user. This event is also subscribed inside the `boot` method of the plugin registration file.

```php
// Extend all backend form usage
Event::listen('backend.form.extendFields', function($widget) {
    // Only apply this listener when the Users controller is being used
    if (!$widget->getController() instanceof \RainLab\User\Controllers\Users) {
        return;
    }

    // Only apply this listener when the User model is being modified
    if (!$widget->model instanceof \RainLab\User\Models\User) {
        return;
    }

    // Only apply this listener when the Form widget in question is a root-level
    // Form widget (not a repeater, nestedform, etc)
    if ($widget->isNested) {
        return;
    }

    // Add an extra birthday field
    $widget->addFields([
        'birthday' => [
            'label' => 'Birthday',
            'comment' => 'Select the users birthday',
            'type' => 'datepicker'
        ]
    ]);

    // Remove a Surname field
    $widget->removeField('surname');
});
```

::: tip
You may also use the `backend.form.extendFieldsBefore` event to add fields.
:::

### Extending a Backend List

This example will modify the `backend.list.extendColumns` global event of the `Backend\Widget\Lists` class and inject some extra columns values under the conditions that the list is being used to modify a user. This event is also subscribed inside the `boot` method of the plugin registration file.

```php
// Extend all backend list usage
Event::listen('backend.list.extendColumns', function ($widget) {
    // Only for the User controller
    if (!$widget->getController() instanceof \RainLab\User\Controllers\Users) {
        return;
    }

    // Only for the User model
    if (!$widget->model instanceof \RainLab\User\Models\User) {
        return;
    }

    // Add an extra birthday column
    $widget->addColumns([
        'birthday' => [
            'label' => 'Birthday'
        ],
    ]);

    // Remove a Surname column
    $widget->removeColumn('surname');
});
```

### Extending a Component

This example will declare a new global event `rainlab.forum.topic.post` and local event called `topic.post` inside a `Topic` component. This is carried out in the [component class definition](./cms-components.md).

```php
class Topic extends ComponentBase
{
    public function onPost()
    {
        // ...

        $this->fireEvent('topic.post', [$post, $postUrl]);

        Event::fire('rainlab.forum.topic.post', [$this, $post, $postUrl]);
    }
}
```

Next this will demonstrate how to hook this new event from inside the [Layout Execution Life Cycle](../cms/themes/layouts.md). This will write to the trace log when the `onPost` event handler is called inside the `Topic` component (above).

::: cmstemplate
```ini
[topic]
slug = "{{ :slug }}"
```
```php
<?
function onInit()
{
    $this->topic->bindEvent('topic.post', function($post, $postUrl) {
        trace_log('A post has been submitted at '.$postUrl);
    });
}
?>
```
:::

#### See Also

::: also
* [Event Service](./services/event.md)
:::
---
subtitle: Learn how to control permissions in the backend panel.
---
# Permissions

Permissions allow users to have specific privileges and functions in the backend panel. An example might be the ability to create or delete a record, or view the server logs. These permissions are based on the role assigned and can be granted on a per-user basis.

## Permission Codes

Permissions codes define a single permission and are string keys that use a "dot" notation, for example, `some.area.permission_name`. These permissions are granted to users by either direct assignment or by inheritance through their role.

When checking if a user has a specific permission, the permission for that user's role are inherited and then overridden by any permissions applied directly to that user. For example:

- If user **Bob** has role called **Genius**; and
- Role **Genius** has the `eat_cake` permission; but
- **Bob** has the `eat_cake` permission specifically set to deny; then
- **Bob** will not get to `eat_cake`.

However:

- If **Bob** has the permission `eat_vegetables` assigned directly to him, but;
- The **Genius** role does not, then;
- **Bob** still gets to `eat_vegetables`.

### Nested Permissions

Permission codes support a nested structure to provide a cleaner interface when selecting permissions. To nest a permission code the "dot" value must be a direct descendant of its parent and unlimited nesting is supported.

In the following example, the `manage_entries` permission must be granted for the `manage_entries.create` and `manage_entries.publish` codes to become available. Visually it is represented like this:

::: dir
├── manage_entries
|   ├── manage_entries.create
|   └── manage_entries.publish
└── delete_entries
:::

## Access Levels

Access to all parts of an October CMS instance is controlled by the permissions system. The `BackendAuth::userHasAccess` method is a quick way to check if the current user is logged in and has permission to a specific area.

```php
// Returns true if the user has permission
$permissionGranted = BackendAuth::userHasAccess('utilities.logs');
```

### Super Users

Administrators can be granted a special flag called a "super user" that allows access to all areas. When granted, the permission system is bypassed with access to all areas. Super users are not visible to other regular administrators.

::: warning
Any super user can create and remove other super users, so it should only be granted to the highest level administrator or owner of the application.
:::

### Roles

Roles use the `Backend\Models\UserRole` model and are groupings of permissions with a name and description used to identify the role. An administrator can only have one role assigned to them at once.

October CMS ships with two default system roles called `developer` and `publisher`. Any number of custom roles with their own combinations of permissions can be created and applied to users.

::: tip
System roles cannot change their permissions however they can be deleted if not required.
:::

### Role Hierarchy

Each role is assigned a ranked position in the backend panel, represented as the `sort_order` column in the database. This allows a basic organisational structure to be established where users can only manage roles lower than their own role.

In the following example, the **Senior Editor** can manage all the users, outranking **Staff Writer** and **Fact Checker** roles. Whereas, the **Fact Checker** role cannot see users or manage permissions above them, in the **Staff Writer** and **Senior Editor** roles.

- Senior Editor
- Staff Writer
- Fact Checker

If the **Manage Admins → Manage Roles** permission is granted, users can manage their own users, permissions and roles existing below their current role.

## Registering Permissions

Plugins can register backend user permissions by overriding the `registerPermissions` method inside the [plugin registration file](../extending.md). The permissions are defined as an array with keys corresponding the permission keys and values corresponding the permission descriptions. The permission keys consist of the author name, the plugin name and the feature name. Here is an example code.

```
acme.blog.access_categories
```

The next example shows how to register backend permission items. Permissions are defined with a permission key and description. In the backend permission management user interface permissions are displayed as a checkbox list. Back-end controllers can use permissions defined by plugins for restricting the user access to pages or features.

```php
public function registerPermissions()
{
    return [
        'acme.blog.access_posts' => [
            'label' => 'Manage the blog posts',
            'tab' => 'Blog',
            'order' => 200,
        ],
        // ...
    ];
}
```

You may also specify a `roles` option as an array with each value as a role API code. When a role is created with this code, it becomes a system role that always grants this permission to users with that role.

```php
public function registerPermissions()
{
    return [
        'acme.blog.access_categories' => [
            'label' => 'Manage the blog categories',
            'tab' => 'Blog',
            'order' => 200,
            'roles' => ['developer']
        ]
        // ...
    ];
}
```

## Restricting Access to Backend Pages

In a backend controller class you can specify which permissions are required for access the pages provided by the controller. It's done with the `$requiredPermissions` controller's property. This property should contain an array of permission keys. If the user permissions match any permission from the list, the framework will let the user to see the controller pages.

```php
namespace Acme\Blog\Controllers;

use Backend\Classes\BackendController;

class Posts extends BackendController
{
    public $requiredPermissions = ['acme.blog.access_posts'];
}
```

You can also use the **asterisk** symbol to indicate the "all permissions" condition. In the next example the controller pages are accessible for all users who has any permissions starting with the "acme.blog." string:

```php
public $requiredPermissions = ['acme.blog.*'];
```

## Restricting Access to Features

The backend user model has methods that allow determining whether the user has specific permissions. You can use this feature in order to limit the functionality of the backend user interface. The permission methods supported by the backend user are `userHasAccess` and `userHasPermission`. Both methods take two parameters: the permission key string (or an array of key strings) and an optional parameter indicating that all permissions listed with the first parameters are required.

The `userHasAccess` method returns **true** for any permission if the user is a super user. The `userHasPermission` method is more strict, only returning true if the user actually has the specified permissions either in their account or through their role. Generally, `userHasAccess` is the preferred method to use as it respects the absolute power of the super user. The following example shows how to use the methods in the controller code.

```php
if (BackendAuth::userHasAccess('acme.blog.*')) {
    // ...
}

if (BackendAuth::userHasPermission([
    'acme.blog.access_posts',
    'acme.blog.access_categories'
])) {
    // ...
}
```

You can also use the methods in the backend views for hiding user interface elements. The next example demonstrates how you can hide a button on a [backend form](../forms/form-controller.md).

```php
<?php if (BackendAuth::userHasAccess('acme.blog.delete_categories')): ?>
    <button
        type="button"
        class="oc-icon-trash-o btn-icon danger"
        data-request="onDelete"
        data-load-indicator="Deleting Category..."
        data-request-confirm="Do you really want to delete this category?">
    </button>
<?php endif ?>
```
---
subtitle: Learn how to include new menu items in the backend panel.
---
# Navigation

Plugins can extend the backend navigation menus by overriding the `registerNavigation` method of the [plugin registration file](../extending.md). This section shows you how to add menu items to the backend navigation area. The following is an example of registering a top-level navigation menu item with two sub-menu items.

```php
public function registerNavigation()
{
    return [
        'blog' => [
            'label' => 'Blog',
            'url' => Backend::url('acme/blog/posts'),
            'icon' => 'icon-pencil',
            'permissions' => ['acme.blog.*'],
            'order' => 500,

            'sideMenu' => [
                'posts' => [
                    'label' => 'Posts',
                    'icon' => 'icon-copy',
                    'url' => Backend::url('acme/blog/posts'),
                    'permissions' => ['acme.blog.access_posts'],
                ],
                'categories' => [
                    'label' => 'Categories',
                    'icon' => 'icon-copy',
                    'url' => Backend::url('acme/blog/categories'),
                    'permissions' => ['acme.blog.access_categories'],
                ]
            ]
        ]
    ];
}
```

When you register the backend navigation you can use [localization strings](../system/localization.md) for the `label` values. Backend navigation can also be controlled by the `permissions` values and correspond to defined [backend user permissions](./permissions.md). The order in which the backend navigation appears on the overall navigation menu items, is controlled by the `order` value. Higher numbers mean that the item will appear later on in the order of menu items while lower numbers mean that it will appear earlier on.

To make the sub-menu items visible, you may set the navigation context in the [backend controller](../system/controllers.md) using the `BackendMenu::setContext` method. This will make the parent menu item active and display the children in the side menu.

Property | Description
------------- | -------------
**label** | specifies the menu label localization string key, required.
**order** | a numerical weight when determining the display order.
**icon** | an icon name from the [October CMS icon collection](../../element/available-icons.md), optional.
**iconSvg** | an SVG icon to be used in place of the standard icon, the SVG icon should be a rectangle and can support colors, optional.
**url** | the URL the menu item should point to (eg. `Backend::url('author/plugin/controller/action')`, required.
**counter** | a numeric value to output near the menu icon. The value should be a number or a callable returning a number, optional.
**counterLabel** | a string value to describe the numeric reference in counter, optional.
**attributes** | an associative array of attributes and values to apply to the menu item, optional.
**permissions** | an array of permissions the backend user must have in order to view the menu item (Note: direct access of URLs still requires separate permission checks), optional.
**sideMenu** | an array of sub-menu items sharing the same configuration as parent menu items, optional.
**itemType** | specifies a display type for the item, sub-menu items only. Supported: `primary`, `link`, `ruler`, `section`. Default: `link`.

The following are system generated value and are not provided when registering the navigation items.

Key | Description
------------- | -------------
**code** | a string value that acts as an unique identifier for that menu option.
**owner** | a string value that specifies the menu items owner plugin or module in the format "Author.Plugin".

## Navigation Counters

Navigation items support specifying a counter to indicate that there are items that require attention. These properties are available to parent and child menu items alike. Use the **counter** and **counterLabel** to show a numeric counter.

```php
'blog' => [
    // ...
    'counter' => [\Author\Plugin\Classes\MyMenuCounterService::class, 'getCounterMethod'],
    'counterLabel' => 'Label describing a dynamic menu counter',
],
```

## Item Display Types

Sub-menu items support different display types using the `itemType` property, including user-interface elements. Set the type to `section` to display a navigation section. Prefixing the key name with an underscore (`_`) is a good way to communicate that it is a UI element.

```php
'_section1' => [
    'itemType' => 'section',
    'label' => 'Advanced',
],
```

It might be useful to combine a section with a navigation divider placed above it. Set the type to `ruler` to display a divider.

```php
'_ruler1' => [
    'itemType' => 'ruler',
],
```

To display a call to action, set the type to `primary` to display the link as a primary button.

```php
'people_create' => [
    'label' => 'New Person',
    'icon' => 'icon-plus',
    'url' => Backend::url('acme/blog/people/create'),
    'itemType' => 'primary',
],
```

If displaying a button for the create action of a controller, change the side-menu context using the `BackendMenu` facade before inheriting the parent logic.

```php
public function create()
{
    BackendMenu::setContextSideMenu('people_create');

    return $this->asExtension('FormController')->create();
}
```

## Extending the Backend Menu

The `backend.menu.extendItems` [event listener](../extending.md) can be used to modify the existing navigation items, after the system and plugins have registered their navigation items. The event returns a navigation `$manager` instance that supports the following methods.

Method | Description
------------- | -------------
**addMainMenuItems($owner, $definitions)** | Add or update a main menu definition
**getMainMenuItem($owner, $code)** | Retrieve an existing main menu definition
**removeMainMenuItem($owner, $code)** | Delete an existing main menu definition
**addSideMenuItems($owner, $code, $definitions)** | Add or update a side menu definition
**getSideMenuItem($owner, $code, $sideCode)** | Retrieve an existing side menu definition
**removeSideMenuItem($owner, $code, $sideCode)** | Delete an existing side menu definition

When retrieving a menu item, the object supports method chaining to update its properties. The following example will replace the label for the Editor with **Code Editor**.

```php
Event::listen('backend.menu.extendItems', function($manager) {
    $manager->getMainMenuItem('October.Editor', 'editor')->label('Code Editor');
});
```

The next example will change the label to **News** and add a **9** counter to the Acme Blog plugin.

```php
Event::listen('backend.menu.extendItems', function($manager) {
    $manager->getMainMenuItem('Acme.Blog', 'blog')
        ->getSideMenuItem('posts')
        ->label('News')
        ->counter(9);
});
```

Similarly, we can remove the menu items using the same event. The following example will remove all items, remove a single item, and remove multiple items, respectively.

```php
Event::listen('backend.menu.extendItems', function($manager) {
    $manager->removeMainMenuItem('Acme.Blog', 'blog');

    $manager->removeSideMenuItem('Acme.Blog', 'blog', 'posts');

    $manager->removeSideMenuItems('Acme.Blog', 'blog', [
        'posts',
        'categories'
    ]);
});
```
---
subtitle: Learn about user management in the backend panel.
---
# Users

The user management for the backend panel works with administrators where the `Backend\Models\User` model is the container that hold all the important information about a user. It includes features like roles, groups, permissions, password resets and sign-in throttling. Plugins can also [register permissions](./permissions.md) that control access to the features in the backend.

## Backend User Helper

The global `BackendAuth` facade can be used for managing administrative users, which primarily inherits the `October\Rain\Auth\Manager` class. To register a new administrator user account, use the `BackendAuth::register` method.

```php
$user = BackendAuth::register([
    'first_name' => 'Some',
    'last_name' => 'User',
    'login' => 'someuser',
    'email' => 'some@website.tld',
    'password' => 'changeme',
    'password_confirmation' => 'changeme'
]);
```

The `BackendAuth::check` method is a quick way to check if the user is signed in. To return the user model that is signed in, use `BackendAuth::getUser` instead. Additionally, the active user will be available as `$this->user` inside any [backend controller](../system/controllers.md).

```php
// Returns true if signed in.
$loggedIn = BackendAuth::check();

// Returns the signed in user
$user = BackendAuth::getUser();
```

You may look up a user by their login name using the `BackendAuth::findUserByLogin` method.

```php
$user = BackendAuth::findUserByLogin('someuser');
```

You may authenticate a user by providing their login and password with `BackendAuth::authenticate`. You can also authenticate as a user simply by passing the `Backend\Models\User` model along with `BackendAuth::login`.

```php
// Authenticate user by credentials
$user = BackendAuth::authenticate([
    'login' => post('login'),
    'password' => post('password')
]);

// Sign in as a specific user
BackendAuth::login($user);
```

## Groups

User groups use the `Backend\Models\UserGroup` model and are an organizational tool for grouping administrators, they are not related to [user permissions](./permissions.md) and are strictly for organizational purposes, such as notifications.

For instance, if you wanted to send an email to all users that are in the group `Head Office Staff`, you could find the user group along with the users in that group.

```php
$group = UserGroup::where('code', 'head-office-staff')->first();

Mail::sendTo($group->users, 'author.plugin:important_notification');
```

## Change Backend User Password

The `october:passwd` command allows the password of a backend administrator to be changed via the command line. This is useful if you are locked out of your October CMS install, or for changing the password for the default administrator account.

```bash
php artisan october:passwd username password
```

For the first argument you may pass either the login name or email address. For the second argument you may optionally pass the desired password, otherwise you will be prompted to enter one.
---
subtitle: A widget specifically made for use in the dashboard.
---
# Report Widgets

Report widgets can be used on the backend dashboard and in other backend report containers. Report widgets must be registered in the [plugin registration file](../extending.md).

The report widget classes reside inside the **reportwidgets** directory of a plugin. As any other plugin class, generic widget controllers should belong to the plugin namespace. Similarly to all backend widgets, report widgets use partials and a special directory layout. Example directory layout:

::: dir
├── `reportwidgets`
|   ├── trafficsources
|   |   └── partials
|   |       └── _widget.htm  _← Partial File_
|   └── TrafficSources.php  _← Widget Class_
:::

## Class Definition

The `create:reportwidget` command generates a backend report widget, view and basic asset files. The first argument specifies the author and plugin name. The second argument specifies the report widget class name.

```bash
php artisan create:reportwidget Acme.Blog TopPosts
```

The report widget classes must extend the `Backend\Classes\ReportWidgetBase` class. Example report widget class definition. The class should override the `render` method in order to render the widget itself.

```php
namespace RainLab\GoogleAnalytics\ReportWidgets;

use Backend\Classes\ReportWidgetBase;

class TrafficSources extends ReportWidgetBase
{
    public function render()
    {
        return $this->makePartial('widget');
    }
}
```

The widget partial could contain any HTML markup you want to display in the widget. The markup should be wrapped into the DIV element with the **report-widget** class. Using H3 element to output the widget header is preferable. Example widget partial:

```html
<div class="report-widget">
    <h3>Traffic sources</h3>

    <div
        class="control-chart"
        data-control="chart-pie"
        data-size="200"
        data-center-text="180">
        <ul>
            <li>Direct <span>1000</span></li>
            <li>Social networks <span>800</span></li>
        </ul>
    </div>
</div>
```

![image](https://raw.githubusercontent.com/octobercms/docs/develop/images/traffic-sources.png)

Inside report widgets you can use any [charts or indicators](https://octobercms.com/docs/ui/chart), lists or any other markup you wish. Remember that the report widgets extend the generic backend widgets and you can use any widget functionality in your report widgets. The next example shows a list report widget markup.

```html
<div class="report-widget">
    <h3>Top pages</h3>

    <div class="table-container">
        <table class="table data" data-provides="rowlink">
            <thead>
                <tr>
                    <th><span>Page URL</span></th>
                    <th><span>Pageviews</span></th>
                    <th><span>% Pageviews</span></th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>/</td>
                    <td>90</td>
                    <td>
                        <div class="progress">
                            <div class="bar" style="90%"></div>
                            <a href="/">90%</a>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>/docs</td>
                    <td>10</td>
                    <td>
                        <div class="progress">
                            <div class="bar" style="10%"></div>
                            <a href="/docs">10%</a>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>
```

## Report Widget Properties

Report widgets may have properties that users can manage with the Inspector:

![image](https://raw.githubusercontent.com/octobercms/docs/develop/images/report-widget-inspector.png)

The properties should be defined in the `defineProperties` method of the widget class. The properties are described in the [inspector types](../../element/inspector-types.md).

```php
public function defineProperties()
{
    return [
        'title' => [
            'title' => 'Widget title',
            'default' => 'Top Pages',
            'type' => 'string',
            'validation' => [
                'required' => [
                    'message' => 'The Widget Title is required.'
                ],
            ]
        ],
        'days' => [
            'title' => 'Number of days to display data for',
            'default' => '7',
            'type' => 'string',
            'validation' => [
                'regex' => [
                    'message' => 'The days property can contain only numeric symbols.',
                    'pattern' => '^[0-9]+$'
                ]
            ]
        ]
    ];
}
```

## Report Widget Registration

Plugins can register report widgets by overriding the `registerReportWidgets` method inside the [plugin registration file](../extending.md). The method should return an array containing the widget classes in the keys and widget configuration (label, context, and required permissions) in the values.

```php
public function registerReportWidgets()
{
    return [
        \RainLab\GoogleAnalytics\ReportWidgets\TrafficOverview::class => [
            'label' => 'Google Analytics traffic overview',
            'context' => 'dashboard',
            'permissions' => [
                'rainlab.googleanalytics.widgets.traffic_overview',
            ],
        ],
        \RainLab\GoogleAnalytics\ReportWidgets\TrafficSources::class => [
            'label' => 'Google Analytics traffic sources',
            'context' => 'dashboard',
            'permissions' => [
                'rainlab.googleanaltyics.widgets.traffic_sources',
            ],
        ]
    ];
}
```

The **label** element defines the widget name for the Add Widget popup window. The **context** element defines the context where the widget could be used. October's report widget system allows to host the report container on any page, and the container context name is unique. The widget container on the Dashboard page uses the **dashboard** context.
---
subtitle: Learn how to customize the import and export process.
---
# Import Export Model

Import and Export models define the logic used when processing the import or export action, extending the `Backend\Models\ImportModel` and `Backend\Models\ExportModel` models respectively. These models are designed to be used with the [Import Export Controller](./importexport-controller.md), however, it is possible to work with them directly in PHP.

## Import Model

For importing data you should create a dedicated model for this process which extends the `Backend\Models\ImportModel` class. Here is an example class definition:

```php
class SubscriberImport extends \Backend\Models\ImportModel
{
    /**
     * @var array rules to be applied to the data.
     */
    public $rules = [];

    public function importData($results, $sessionKey = null)
    {
        foreach ($results as $row => $data) {

            try {
                $subscriber = new Subscriber;
                $subscriber->fill($data);
                $subscriber->save();

                $this->logCreated();
            }
            catch (Exception $ex) {
                $this->logError($row, $ex->getMessage());
            }

        }
    }
}
```

The class must define a method called `importData` used for processing the imported data. The first parameter `$results` will contain an array containing the data to import. The second parameter `$sessionKey` will contain the session key used for the request.

Method | Description
------------- | -------------
`logUpdated()` | Called when a record is updated.
`logCreated()` | Called when a record is created.
`logError(rowIndex, message)` | Called when there is a problem with importing the record.
`logWarning(rowIndex, message)` | Used to provide a soft warning, like modifying a value.
`logSkipped(rowIndex, message)` | Used when the entire row of data was not imported (skipped).

### Importing with PHP

Use the `importFile` method process an import manually from a local file stored on the disk.

```php
$importModel = new MyImportClass;

$importModel->file_format = 'json';

$importModel->importFile('/path/to/import/file.json');
```

If the file is coming from an uploaded file use the `Input` facade to access the local path.

```php
$importModel->importFile(
    Input::file('file')->getRealPath()
);
```

## Export Model

For exporting data you should create a dedicated model which extends the `Backend\Models\ExportModel` class. Here is an example:

```php
class SubscriberExport extends \Backend\Models\ExportModel
{
    public function exportData($columns, $sessionKey = null)
    {
        $subscribers = Subscriber::all();

        $subscribers->each(function($subscriber) use ($columns) {
            $subscriber->addVisible($columns);
        });

        return $subscribers->toArray();
    }
}
```

The class must define a method called `exportData` used for returning the export data. The first parameter `$columns` is an array of column names to export. The second parameter `$sessionKey` will contain the session key used for the request.

### Exporting with PHP

Use the `exportDownload` method to process an export manually and return a download response.

```php
$exportColumns = ['id', 'title'];

$exportModel = new MyExportClass;

$exportModel->file_format = 'json';

return $exportModel->exportDownload('myexportfile.json', ['columns' => $exportColumns]);
```

## Custom Options

Both import and export forms support custom options that can be introduced using form fields, defined in the **form** option in the import or export configuration respectively. These values are then passed to the Import / Export model and are available during processing.

```yaml
# config_import_export.yaml
import:
    # ...
    form: $/acme/campaign/models/subscriberimport/fields.yaml

export:
    # ...
    form: $/acme/campaign/models/subscriberexport/fields.yaml
```

The form fields specified will appear on the import/export page. Here is an example `fields.yaml` file contents:

```yaml
# fields.yaml
fields:

    auto_create_lists:
        label: Automatically create lists
        type: checkbox
        default: true
```

The value of the form field above called **auto_create_lists** can be accessed using `$this->auto_create_lists` inside the `importData` method of the import model. If this were the export model, the value would be available inside the `exportData` method instead.

```php
class SubscriberImport extends \Backend\Models\ImportModel
{
    public function importData($results, $sessionKey = null)
    {
        if ($this->auto_create_lists) {
            // Do something
        }

        // ...
    }
}
```
---
subtitle: Adds importing and exporting features to a page.
---
# Import Export Controller

The `Backend\Behaviors\ImportExportController` class is a controller behavior that provides features for importing and exporting data. The behavior provides two pages called Import and Export. The Import page allows a user to upload a CSV file and match the columns to the database. The Export page is the opposite and allows a user to download columns from the database as a CSV file. The behavior provides the controller actions `import()` and `export()`.

The importing and exporting behavior configuration is defined in two parts, each part depends on a special model class along with a list and form field definition file. To use the behavior you should add it to the `$implement` property of the controller class. Also, the `$importExportConfig` class property should be defined and its value should refer to the YAML file used for configuring the behavior properties.

```php
namespace Acme\Shop\Controllers;

class Products extends Controller
{
    public $implement = [
        \Backend\Behaviors\ImportExportController::class
    ];

    public $importExportConfig = 'config_import_export.yaml';

    // [...]
}
```

## Configuring the Behavior

The configuration file referred in the `$importExportConfig` property is defined in YAML format. The file should be placed into the controller's [views directory](../system/views.md). Below is an example of a configuration file.

```yaml
# config_import_export.yaml
import:
    title: Import subscribers
    modelClass: Acme\Campaign\Models\SubscriberImport
    list: $/acme/campaign/models/subscriber/columns.yaml

export:
    title: Export subscribers
    modelClass: Acme\Campaign\Models\SubscriberExport
    list: $/acme/campaign/models/subscriber/columns.yaml
```

The configuration properties listed below are optional. Define them if you want the behavior to support the import page or export page, or both.

Property | Description
------------- | -------------
**defaultRedirect** | used as a fallback redirection page when no specific redirect page is defined.
**import** | a configuration array or reference to a config file for the Import page.
**export** | a configuration array or reference to a config file for the Export page.
**defaultFormatOptions** | a configuration array or reference to a config file for the default CSV format options.

### Import Page

To support the Import page add the following configuration to the YAML file.

```yaml
import:
    title: Import Subscribers
    modelClass: Acme\Campaign\Models\SubscriberImport
    list: $/acme/campaign/models/subscriberimport/columns.yaml
    redirect: acme/campaign/subscribers
```

The following configuration properties are supported for the Import page.

Property | Description
------------- | -------------
**title** | a page title, can refer to a [localization string](../system/localization.md).
**list** | defines the list columns available for importing.
**form** | provides additional fields used as import options, optional.
**redirect** | redirection page when the import is complete, optional
**permissions** | user permissions needed to perform the operation, optional

### Export Page

To support the Export page add the following configuration to the YAML file.

```yaml
export:
    title: Export Subscribers
    modelClass: Acme\Campaign\Models\SubscriberExport
    list: $/acme/campaign/models/subscriberexport/columns.yaml
    redirect: acme/campaign/subscribers
```

The following configuration properties are supported for the Export page:

Property | Description
------------- | -------------
**title** | a page title, can refer to a [localization string](../system/localization.md).
**fileName** | the file name to use for the exported file without extension. Default `export`
**list** | defines the list columns available for exporting.
**form** | provides additional fields used as export options, optional.
**redirect** | redirection page when the export is complete, optional.
**useList** | set to true or the value of a list definition to enable integration with lists. Default: `false`.

### Format Options

To override the default format options add the following configuration to the YAML file:

```yaml
defaultFormatOptions:
    fileFormat: json
```

The following configuration properties (all optional) are supported for the format options, including their applicable format type.

Property | Description | Format
-------- | ----------- | ------
**fileFormat** | File format as either `json`, `csv` or `csv_custom`, default: `json`. |
**customJson** | Use a custom format for the `json` format type. | JSON
**firstRowTitles** | First row contains headers, import only. | CSV
**delimiter** | Delimiter character. | CSV (Custom)
**enclosure** | Enclosure character. | CSV (Custom)
**escape** | Escape character. | CSV (Custom)
**encoding** | File encoding, import only. | CSV (Custom)

## Import and Export Views

For each page feature import and export you should provide a [view file](../system/views.md) with the corresponding name - **import.htm** and **export.htm**.

The import/export behavior adds two methods to the controller class: `importRender` and `exportRender`. These methods render the importing and exporting sections as per the YAML configuration file described above.

### Import View

The **import.htm** view represents the Import page that allows users to import data. A typical Import page contains breadcrumbs, the import section itself, and the submission buttons. The **data-request** attribute should refer to the `onImport` AJAX handler provided by the behavior. Below is a contents of the typical import.htm view file.

```php
<?= Form::open(['class' => 'layout']) ?>

    <div class="layout-row">
        <?= $this->importRender() ?>
    </div>

    <div class="form-buttons">
        <button
            type="submit"
            data-control="popup"
            data-handler="onImportLoadForm"
            data-keyboard="false"
            class="btn btn-primary">
            Import records
        </button>
    </div>

<?= Form::close() ?>
```

### Export View

The **export.htm** view represents the Export page that allows users to export a file from the database. A typical Export page contains breadcrumbs, the export section itself, and the submission buttons. The **data-request** attribute should refer to the `onExport` AJAX handler provided by the behavior. Below is a contents of the typical export.htm form.

```php
<?= Form::open(['class' => 'layout']) ?>

    <div class="layout-row">
        <?= $this->exportRender() ?>
    </div>

    <div class="form-buttons">
        <button
            type="submit"
            data-control="popup"
            data-handler="onExportLoadForm"
            data-keyboard="false"
            class="btn btn-primary">
            Export records
        </button>
    </div>

<?= Form::close() ?>
```

## Integration with List Behavior

There is an alternative approach to exporting data that uses the [list behavior](../lists/list-controller.md) to provide the export data. In order to use this feature you should have the `Backend\Behaviors\ListController` definition to the `$implement` field of the controller class. You do not need to use an export view and all the settings will be pulled from the list. Here is the only configuration needed:

```yaml
export:
    useList: true
```

Then simply add an export button to the [list toolbar](../lists/list-controller.md):

```php
<a
    href="<?= Backend::url('acme/campaign/subscribers/export') ?>"
    class="btn btn-default oc-icon-download">
    Export Records
</a>
```

Similarly, to add an import button, the code would look like this:

```php
<a
    href="<?= Backend::url('acme/campaign/subscribers/import') ?>"
    class="btn btn-default oc-icon-upload">
    Import Records
</a>
```


If you are using [multiple list definitions](../lists/list-controller.md), then you can supply the list definition.

```yaml
export:
    useList: orders
    fileName: orders.csv
```

The `useList` option also supports extended configuration properties.

```yaml
export:
    useList:
        definition: orders
        raw: true
```

The following configuration properties are supported:

Property | Description
------------- | -------------
**definition** | the list definition to source records from, optional.
**raw** | output the raw attribute values from the record, default: false.
---
subtitle: Extending Tailor with custom content fields.
---
# Building Tailor Fields

You can roll your own content fields by defining a field definition file and then registering it in your plugin registration file.

Content Field definition classes reside inside the **contentfields** directory of the plugin. The inner directory name matches the name of the widget class written in lowercase. Content Fields can supply assets and partials. An example directory structure looks like this.

::: dir
├── `contentfields`
|   ├── mycontentfield
|   |   ├── assets
|   |   └── partials
|   |       └── _column_content.htm  _← Partial File_
|   └── MyContentField.php  _← Field Class_
:::

### Class Definition

The `create:contentfield` command generates a content field class. The first argument specifies the author and plugin name. The second argument specifies the content field class name.

```bash
php artisan create:contentfield Acme.Blog IconPicker
```

The content field class must extend the `Backend\Classes\FormWidgetBase` class.
A registered content field can be used in [Tailor form fields](../element/form-fields.md) and blueprints.  The class defines how the field should interact with the rest of the system. For example, **plugins/acme/blog/contentfields/MyContentField.php** with the following contents.

```php
namespace Acme\Blog\ContentFields;

use Tailor\Classes\ContentFieldBase;
use October\Contracts\Element\FormElement;
use October\Contracts\Element\ListElement;
use October\Contracts\Element\FilterElement;

class MyContentField extends ContentFieldBase
{
    public function defineConfig(array $config) {}

    public function defineFormField(FormElement $form, $context = null) {}

    public function defineListColumn(ListElement $list, $context = null) {}

    public function defineFilterScope(FilterElement $filter, $context = null) {}

    public function extendModelObject($model) {}

    public function extendDatabaseTable($table) {}
}
```

### Content Field Registration

Plugins should register content fields by overriding the `registerContentFields` method inside the [plugin registration file](./extending.md). The method returns an array containing the widget class in the keys and widget short code as the value. Example:

```php
public function registerContentFields()
{
    return [
        \Acme\Blog\ContentFields\MyContentField::class => 'mycontentfield'
    ];
}
```

The short code is used when referencing the field in the [blueprint templates](introduction.md), it should be a unique value to avoid conflicts with other form fields.

## Processing Config

Assuming we want to include a field config item called `secondaryTitle`, it is first defined as a property on the class and then filled using the `defineConfig` override.

```php
class MyContentField extends ContentFieldBase
{
    /**
     * @var string secondaryTitle for the field.
     */
    public $secondaryTitle;

    /**
     * defineConfig will process the field configuration.
     */
    public function defineConfig(array $config)
    {
        if (isset($config['secondaryTitle'])) {
            $this->secondaryTitle = $config['secondaryTitle'];
        }
    }
}
```

This then becomes available:

```yaml
my_field:
    type: mycontentfield
    secondaryTitle: Custom value goes here
```

## Defining the Backend Element

The content field can define how it appears in the backend panel as a form field, list column and filter scope. The resulting object in each case is fluent configuration object that supports a method chain or an array via the `useConfig` method. See the [defining content fields article](../cms/tailor/content-fields.md) for more information.

### Form Field

The `defineFormField` method defines how a content field should appear in a form. Each field is initiated by the `addFormField` method that takes the field name and label to display to the user.

```php
public function defineFormField(FormElement $form, $context = null)
{
    $form->addFormField($this->fieldName, $this->label)->useConfig($this->config);
}
```

### List Column

The `defineListColumn` method defines how a content field should appear in a list. Each column is initiated by the `defineListColumn` method that takes the field name and label to display to the user.

```php
public function defineListColumn(ListElement $list, $context = null)
{
    $list->defineColumn($this->fieldName, $this->label)->displayAs('switch');
}
```

### Filter Scope

The `defineFilterScope` method defines how a content field should appear in a filter. Each scope is initiated by the `defineScope` method that takes the field name and label to display to the user.

```php
public function defineFilterScope(FilterElement $filter, $context = null)
{
    $filter->defineScope($this->fieldName, $this->label)->displayAs('switch');
}
```

## Extending the Model

The `extendModelObject` method allows the content field to extend the record model, such as a `Tailor\Models\EntryRecord` model class. An example might be making the field jsonable using the `addJsonable` method.

```php
public function extendModelObject($model)
{
    $model->addJsonable($this->fieldName);
}
```

Another approach could be to specify a `belongsTo` relationship.

```php
public function extendModelObject($model)
{
    $model->belongsTo[$this->fieldName] = MyOtherModel::class;
}
```

## Extending the Database Table

The `extendDatabaseTable` is used to specify what database columns are needed for this field. It uses a simplified version of the [standard migration structure](../extend/database/structure.md).

```php
public function extendDatabaseTable($table)
{
    $table->mediumText($this->fieldName)->nullable();
}
```

#### See Also

::: also
* [Tailor Content Fields](../cms/tailor/content-fields.md)
:::
---
subtitle: Extending the CMS with custom components.
---
# Building CMS Components

Components files and directories reside in the **components** subdirectory of a plugin directory. Each component has a PHP file defining the component class and an optional component partials directory. The component partials directory name matches the component class name written in lowercase. An example of a component directory structure:

::: dir
├── plugins
|   └── acme
|       └── blog
|           ├── `components`
|           |   ├── blogposts  _← Partials Directory_
|           |   |   └── default.htm  _← Default Markup (Optional)_
|           |   └── BlogPosts.php  _← Component Class_
|           └── Plugin.php
:::

Components must be [registered in the plugin registration file](../extend/extending.md) with the `registerComponents` method. Components can be configured using properties and their [inspector type definitions](../element/inspector-types.md).

## Component Class Definition

The `create:component` command creates a new component class and the default component view. The first argument specifies the author and plugin name. The second argument specifies the component class name.

```bash
php artisan create:component Acme.Blog BlogPosts
```

The component class file defines the component functionality and component properties. The component class file name should match the component class name. Component classes should extend the `Cms\Classes\ComponentBase` class. The component from the next example should be defined in the **plugins/acme/blog/components/BlogPosts.php** file.

```php
namespace Acme\Blog\Components;

class BlogPosts extends \Cms\Classes\ComponentBase
{
    public function componentDetails()
    {
        return [
            'name' => 'Blog Posts',
            'description' => 'Displays a collection of blog posts.',
            'icon' => 'icon-puzzle-piece'
        ];
    }

    /**
     * posts becomes available on the page as {{ component.posts }}
     */
    public function posts()
    {
        return ['First Post', 'Second Post', 'Third Post'];
    }
}
```

The `componentDetails` method is required. The method should return an array with two keys: `name` and `description`. The name and description are display in the CMS back-end user interface.

When this [component is attached to a page or layout](../cms/themes/components.md), the class properties and methods become available on the page through the component variable, which name matches the component short name or the alias. For example, if the BlogPost component from the previous example was defined on a page with its short name:

```ini
url = "/blog"

[blogPosts]
==
```

You would be able to access its `posts` method through the `blogPosts` variable. Note that Twig supports the property notation for methods, so that you don't need to use brackets.

```twig
{% for post in blogPosts.posts %}
    {{ post }}
{% endfor %}
```

### Component Registration

Components must be registered by overriding the `registerComponents` method inside the [plugin registration file](../extend/extending.md). This tells the CMS about the Component and provides a **short name** for using it. An example of registering a component:

```php
public function registerComponents()
{
    return [
        \October\Demo\Components\Todo::class => 'demoTodo'
    ];
}
```

This will register the Todo component class with the default alias name **demoTodo**. More information on using components can be found at the [CMS components article](../cms/themes/components.md).

## Component Properties

When you add a component to a page or layout you can configure it using properties. The properties are defined with the `defineProperties` method of the component class. The next example shows how to define a component property using a **string** inspector type.

```php
public function defineProperties()
{
    return [
        'maxItems' => [
            'title' => 'Max items',
            'description' => 'The most amount of todo items allowed',
            'default' => 10,
            'type' => 'string',
            'validation' => [
                'regex' => [
                    'message' => 'The Max Items property can contain only numeric symbols.',
                    'pattern' => '^[0-9]+$'
                ]
            ]
        ]
    ];
}
```

The method should return an array with the property keys as indexes and property parameters as values. The property keys are used for accessing the component property values inside the component class.

::: tip
The property parameters and available types are described in the [inspector types article](../element/inspector-types.md).
:::

Inside the component you can read the property value with the `property` method:

```php
$this->property('maxItems');
```

If the property value is not defined, you can supply the default value as a second parameter of the `property` method:

```php
$this->property('maxItems', 6);
```

You can also load all the properties as array:

```php
$properties = $this->getProperties();
```

To access the property from the Twig partials for the component, utilize the `__SELF__` variable which refers to the Component object:

```twig
{{ __SELF__.property('maxItems') }}
```

## Routing Parameters

Components can directly access routing parameter values defined in the [URL of the page](../cms/themes/pages.md).

```php
// Returns the URL segment value, eg: /page/:post_id
$postId = $this->param('post_id');
```

In some cases a component property may act as a hard coded value or reference the value from the URL. This hard coded example shows the blog post with an identifier `2` being used:

```ini
url = "/blog/hard-coded-page"

[blogPost]
id = "2"
```

Alternatively the value can be referenced dynamically from the page URL using an [external property value in a component](../cms/themes/components.md).

```ini
url = "/blog/:my_custom_parameter"

[blogPost]
id = "{{ :my_custom_parameter }}"
```

In both cases the value can be retrieved by using the `property` method:

```php
$this->property('id');
```

If you need to access the routing parameter name:

```php
// Returns "my_custom_parameter"
$this->paramName('id');
```

## Handling the Page Execution Cycle

Components can be involved in the Page execution cycle events by overriding the `onRun` method in the component class. The CMS controller executes this method every time when the page or layout loads. Inside the method you can inject variables to the Twig environment through the `page` property:

```php
public function onRun()
{
    // This code will be executed when the page or layout is
    // loaded and the component is attached to it.

    $this->page['var'] = 'value'; // Inject some variable to the page
}
```

### Page Execution Life Cycle Handlers

When a page loads, October executes handler functions that could be defined in the layout and page PHP section and component classes. The sequence the handlers are executed is as follows.

1. Layout `onInit()` function.
1. Page `onInit()` function.
1. Layout `onStart()` function.
1. Layout components `onRun()` method.
1. Layout `onBeforePageStart()` function.
1. Page `onStart()` function.
1. Page components `onRun()` method.
1. Page `onEnd()` function.
1. Layout `onEnd()` function.

### Component Initialization

Sometimes you may wish to execute code at the time the component class is first instantiated. You may override the `init` method in the component class to handle any initialization logic, this will execute before AJAX handlers and before the page execution life cycle. For example, this method can be used for attaching another component to the page dynamically.

```php
public function init()
{
    $this->addComponent(\Acme\Blog\Components\BlogPosts::class, 'blogPosts');
}
```

### Halting With a Response

Like all methods in the [Layout Execution Life Cycle](../cms/themes/layouts.md), if the `onRun` method in a component returns a value, this will stop the cycle at this point and return the response to the browser. Here we return an access denied message using the `Response` facade:

```php
public function onRun()
{
    if (true) {
        return Response::make('Access denied!', 403);
    }
}
```

You can also return a 404 response from the `onRun` method:

```php
public function onRun()
{
    if (true) {
        $this->setStatusCode(404);
        return $this->controller->run('404');
    }
}
```

## AJAX Handlers

Components can host AJAX event handlers. They are defined in the component class exactly like they can be defined in the [page or layout code](../cms/ajax/handlers.md). An example AJAX handler method defined in a component class:

```php
public function onAddItem()
{
    $value1 = post('value1');
    $value2 = post('value2');
    $this->page['result'] = $value1 + $value2;
}
```

If the alias for this component was *demoTodo* this handler can be accessed by `demoTodo::onAddItem`. See the [AJAX handlers article](../cms/ajax/handlers.md) to learn about using AJAX with components.

## Default Markup

All components can come with default markup that is used when including it on a page with the `{% component %}` tag, although this is optional. Default markup is kept inside the **component partials directory**, which has the same name as the component class in lower case.

The default component markup should be placed in a file named **default.htm**. For example, the default markup for the Demo ToDo component is defined in the file **/plugins/october/demo/components/todo/default.htm**. It can then be inserted anywhere on the page by using the `{% component %}` tag:

::: cmstemplate
```ini
url = "/todo"

[demoTodo]
```
```twig
{% component 'demoTodo' %}
```
:::

The default markup can also take parameters that override the component properties at the time they are rendered.

```twig
{% component 'demoTodo' maxItems="7" %}
```

These properties will not be available in the `onRun` method since they are established after the page cycle has completed. Instead they can be processed by overriding the `onRender` method in the component class. The CMS controller executes this method before the default markup is rendered.

```php
public function onRender()
{
    // This code will be executed before the default component
    // markup is rendered on the page or layout.

    $this->page['var'] = 'Maximum items allowed: ' . $this->property('maxItems');
}
```

## Component Partials

In addition to the default markup, components can also offer additional partials that can be used on the front-end or within the default markup itself. If the Demo ToDo component had a **pagination** partial, it would be located in **/plugins/october/demo/components/todo/pagination.htm** and displayed on the page using:

```twig
{% partial 'demoTodo::pagination' %}
```

A relaxed method can be used that is contextual. If called inside a component partial, it will directly refer to itself. If called inside a theme partial, it will scan all components used on the page/layout for a matching partial name and use that.

```twig
{% partial '@pagination' %}
```

Multiple components can share partials by placing the partial file in a directory called **components/partials**. The partials found in this directory are used as a fallback when the usual component partial cannot be found. For example, a shared partial located in **/plugins/acme/blog/components/partials/shared.htm** can be displayed on the page by any component using:

```twig
{% partial '@shared' %}
```

### Referencing "self"

Components can reference themselves inside their partials by using the `__SELF__` variable. By default it will return the [component's short name or alias](../cms/themes/components.md).

```twig
<form data-request="{{__SELF__}}::onEventHandler">
    [...]
</form>
```

Components can also reference their own properties.

```twig
{% for item in __SELF__.items() %}
    {{ item }}
{% endfor %}
```

If inside a component partial you need to render another component partial concatenate the `__SELF__` variable with the partial name:

```twig
{% partial __SELF__~"::screenshot-list" %}
```

### Unique Identifier

If an identical component is called twice on the same page, an `id` property can be used to reference each instance.

```twig
{{__SELF__.id}}
```

The ID is unique each time the component is displayed.

```twig
<!-- ID: demoTodo527c532e9161b -->
{% component 'demoTodo' %}

<!-- ID: demoTodo527c532ec4c33 -->
{% component 'demoTodo' %}
```

## Rendering Partials from Code

You may programmatically render component partials inside the PHP code using the `renderPartial` method. This will check the component for the partial named `component-partial.htm` and return the result as a string. The second parameter is used for passing view variables. The same path resolution logic applies when you render a component partial in PHP as it does with Twig; use the `@` prefix to refer to partials within the component itself.

```php
$content = $this->renderPartial('@component-partial.htm');

$content = $this->renderPartial('@component-partial.htm', [
    'name' => 'John Smith'
]);
```

For example, to render a partial as a response to an [AJAX handler](../cms/ajax/handlers.md):

```php
function onGetTemplate()
{
    return ['#someDiv' => $this->renderPartial('@component-partial.htm')];
}
```

Another example could be overriding the entire page view response by returning a value from the `onRun` page execution cycle. This code will specifically return an XML response using the `Response` facade:

```php
public function onRun()
{
    $content = $this->renderPartial('@default.htm');
    return Response::make($content)->header('Content-Type', 'text/xml');
}
```

## Injecting Page Assets with Components

Components can inject assets (CSS and JavaScript files) to pages or layouts they're attached to. Use the controller's `addCss` and `addJs` methods to add assets to the CMS controllers. It could be done in the component's `onRun` method.

```php
public function onRun()
{
    $this->addJs('/plugins/acme/blog/assets/javascript/blog-controls.js');
}
```

If the path specified in the `addCss` and `addJs` method argument begins with a slash (`/`) then it will be relative to the website root. If the asset path does not begin with a slash then it is relative to the component directory.

The `addCss` and `addJs` methods provide a second argument that defines the attributes of your injected asset as an array.

```php
public function onRun()
{
    $this->addJs('/plugins/acme/blog/assets/javascript/blog-controls.js', ['defer' => true]);
}
```

#### See Also

::: also
* [Inspector Types](../element/inspector-types.md)
:::
---
subtitle: Useful for defining fixed APIs and endpoints.
---
# Routing & Middleware

While routing is handled automatically for the [backend controllers](../system/controllers.md) and CMS pages define their own URL routes in their [page configuration](../../cms/themes/pages.md). Plugins can also supply a file named **routes.php** that contain custom routing logic, as defined in the [Laravel router service](https://laravel.com/docs/10.x/routing).

::: dir
├── plugins
|   └── acme  _← Author Name_
|       └── blog  _← Plugin Name_
|           ├── controllers
|           ├── models
|           ├── Plugin.php
|           └── `routes.php`  _← Routes File_
:::

Using this approach, routes are defined in PHP using the `Route` facade. Below is an example route that becomes available via **https://yoursite.tld/api_acme_blog/cleanup_posts** using a GET request.

```php
Route::get('api_acme_blog/cleanup_posts', function() {
    return Posts::cleanUp();
});
```

You may generate URLs to your routes using the `Url` facade.

```php
$url = Url::to('api_acme_blog/cleanup_posts');
```

## Basic Routing

To define routes, the PHP method will associate to the HTTP method, which supports `get`, `post`, `patch`, `put`, `options` and `delete`. The most basic routes simply accept a URI and a `Closure`.

```php
Route::get('/', function () {
    return 'Hello World';
});

Route::post('foo/bar', function () {
    return 'Hello World';
});

Route::put('foo/bar', function () {
    //
});

Route::delete('foo/bar', function () {
    //
});
```

### Registering Multiple Methods

Sometimes you may need to register a route that responds to multiple HTTP methods. You may do so using the `match` method.

```php
Route::match(['get', 'post'], '/', function () {
    return 'Hello World';
});
```

You may even register a route that responds to all HTTP methods using the `any` method.

```php
Route::any('foo', function () {
    return 'Hello World';
});
```

## Routing to a Class

For larger applications it is preferable to organize routes inside classes instead of a closure. The best place to put these classes is in the **handlers** directory. The route can be referenced as an array that takes the class name and method name. In this example the `/install` route is mapped to the `Installer` class and `install` method.

```php
Route::any('/install', [Installer::class, 'install']);
```

Next, define the class and the route inside. In this example the file is located in **app/handlers/Installer.php**.

```php
namespace App\Handlers;

class Installer extends \Illuminate\Routing\Controller
{
    /**
     * Route: /install
     */
    public function install()
    {
        return 'Welcome!';
    }
}
```

## Route Parameters

To capture segments of the URI within your route, you may do so by defining route parameters. For example, capturing a user's ID from the URL.

```php
Route::get('user/{id}', function ($id) {
    return 'User '.$id;
});
```

You may define as many route parameters as required by your route.

```php
Route::get('posts/{post}/comments/{comment}', function ($postId, $commentId) {
    //
});
```

Route parameters are always encased within singular curly brackets. The parameters will be passed into your route's `Closure` when the route is executed.

::: warning
Route parameters cannot contain the `-` character, use an underscore (`_`) instead.
:::

### Optional Parameters

Occasionally you may need to specify a route parameter, but make the presence of that route parameter optional. You may do so by placing a `?` mark after the parameter name:

```php
Route::get('user/{name?}', function ($name = null) {
    return $name;
});

Route::get('user/{name?}', function ($name = 'John') {
    return $name;
});
```

### Regular Expression Constraints

You may constrain the format of your route parameters using the `where` method on a route instance. The `where` method accepts the name of the parameter and a regular expression defining how the parameter should be constrained.

```php
Route::get('user/{name}', function ($name) {
    //
})->where('name', '[A-Za-z]+');

Route::get('user/{id}', function ($id) {
    //
})->where('id', '[0-9]+');

Route::get('user/{id}/{name}', function ($id, $name) {
    //
})->where(['id' => '[0-9]+', 'name' => '[a-z]+']);
```

## Named Routes

Named routes allow you to conveniently generate URLs or redirects for a specific route. You may specify a name for a route using the `as` array key when defining the route:

```php
Route::get('user/profile', ['as' => 'profile', function () {
    //
}]);
```

#### Route Groups & Named Routes

If you are using route groups (below), you may specify an `as` keyword in the route group attribute array, allowing you to set a common route name prefix for all routes within the group:

```php
Route::group(['as' => 'admin::'], function () {
    Route::get('dashboard', ['as' => 'dashboard', function () {
        // Route named "admin::dashboard"
    }]);
});
```

#### Generating URLs to Named Routes

Once you have assigned a name to a given route, you may use the route's name when generating URLs or redirects via the `Url::route` method:

```php
$url = Url::route('profile');

$redirect = Response::redirect()->route('profile');
```

If the route defines parameters, you may pass the parameters as the second argument to the `route` method. The given parameters will automatically be inserted into the URL:

```php
Route::get('user/{id}/profile', ['as' => 'profile', function ($id) {
    //
}]);

$url = Url::route('profile', ['id' => 1]);
```

## Route Groups

Route groups allow you to share route attributes across a large number of routes without needing to define those attributes on each individual route. Shared attributes are specified in an array format as the first parameter to the `Route::group` method.

### Sub-domain Routing

Route groups may also be used to route wildcard sub-domains. Sub-domains may be assigned route parameters just like route URIs, allowing you to capture a portion of the sub-domain for usage in your route or controller. The sub-domain may be specified using the `domain` key on the group attribute array:

```php
Route::group(['domain' => '{account}.example.tld'], function () {
    Route::get('user/{id}', function ($account, $id) {
        //
    });
});
```

### Route Prefixes

The `prefix` group array attribute may be used to prefix each route in the group with a given URI. For example, you may want to prefix all route URIs within the group with `admin`:

```php
Route::group(['prefix' => 'admin'], function () {
    Route::get('users', function () {
        // Matches The "/admin/users" URL
    });
});
```

You may also use the `prefix` parameter to specify common parameters for your grouped routes:

```php
Route::group(['prefix' => 'accounts/{account_id}'], function () {
    Route::get('detail', function ($account_id) {
        // Matches The accounts/{account_id}/detail URL
    });
});
```

### Route Middleware

Registering middleware inside your plugin's `boot()` method will register it globally for each request.
If you want to register middleware to one route at a time you should do it like this:

```php
Route::get('info', [\App\News::class, 'info'])->middleware(\Path\To\Your\Middleware::class);
```

For route groups it could be done like this:

```php
Route::group(['middleware' => \Path\To\Your\Middleware::class], function() {
    Route::get('info', [\App\News::class, 'info']);
});
```

And finally, if you want to assign a group of middleware to just one route you can do it like this

```php
Route::middleware([\Path\To\Your\Middleware::class])->group(function() {
    Route::get('info', [\App\News::class, 'info']);
});
```

::: tip
You can add more than one middleware in a group, only one is used in the above examples for convenience.
:::

## Global Middleware

To register a global middleware, you can extend the `Cms\Classes\CmsController` or `Backend\Classes\BackendController` controller class by using the following method.

```php
public function boot()
{
    \Cms\Classes\CmsController::extend(function($controller) {
        $controller->middleware(\App\Middleware::class);
    });
}
```

Alternatively, you can push it directly into the Kernel via the `boot()` registration method.

```php
public function boot()
{
    // Add a new middleware to beginning of the stack.
    $this->app[\Illuminate\Contracts\Http\Kernel::class]
        ->prependMiddleware(\App\Middleware::class);

    // Add a new middleware to end of the stack.
    $this->app[\Illuminate\Contracts\Http\Kernel::class]
        ->pushMiddleware(\App\Middleware::class);
}
```

## Throwing 404 Errors

There are two ways to manually trigger a 404 error from a route. First, you may use the `abort` helper. The `abort` helper simply throws a `Symfony\Component\HttpFoundation\Exception\HttpException` with the specified status code.

```php
App::abort(404);
```

You may also manually throw an instance of `October\Rain\Exception\NotFoundException`. More information on handling 404 exceptions and using custom responses for these errors may be found in the [errors & logging](../system/exceptions.md) section of the documentation.

#### See Also

::: also
* [Laravel Routing](https://laravel.com/docs/10.x/routing)
* [Eloquent API Resources](https://laravel.com/docs/10.x/eloquent-resources)
:::
---
subtitle: Perform scheduled tasks for just about anything.
---
# Task Scheduling

::: aside
See the [installation guide](../../setup/installation.md) for instructions on how to set up the scheduler task.
:::

In the past, developers have generated a Cron entry for each task they need to schedule. However, this can sometimes be a headache. Your task schedule is no longer in source control, and you must SSH into your server to add the Cron entries. The command scheduler allows you to fluently and expressively define your command schedule within the application itself, and only a single Cron entry is needed on your server.

<a id="oc-defining-schedules"></a>
## Defining Schedules

You may define all of your scheduled tasks by overriding the `registerSchedule` method inside the [plugin registration file](../extending.md). The method will take a single `$schedule` argument and is used for defining commands along with their frequency.

To get started, let's look at an example of scheduling a task. In this example, we will schedule a `Closure` to be called every day at midnight. Within the `Closure` we will execute a database query to clear a table:

```php
class Plugin extends PluginBase
{
    // ...

    public function registerSchedule($schedule)
    {
        $schedule->call(function () {
            Db::table('recent_users')->delete();
        })->daily();
    }
}
```

In addition to scheduling `Closure` calls, you may also schedule [console commands](../console-commands.md) and operating system commands. For example, you may use the `command` method to schedule a console command:

```php
$schedule->command('cache:clear')->daily();
```

The `exec` command may be used to issue a command to the operating system:

```php
$schedule->exec('node /home/acme/script.js')->daily();
```

### Schedule Frequency Options

Of course, there are a variety of schedules you may assign to your task:

Method  | Description
------------- | -------------
`->cron('* * * * *');`  |  Run the task on a custom Cron schedule
`->everyMinute();`  |  Run the task every minute
`->everyFiveMinutes();`  |  Run the task every five minutes
`->everyTenMinutes();`  |  Run the task every ten minutes
`->everyThirtyMinutes();`  |  Run the task every thirty minutes
`->hourly();`  |  Run the task every hour
`->daily();`  |  Run the task every day at midnight
`->dailyAt('13:00');`  |  Run the task every day at 13:00
`->twiceDaily(1, 13);`  |  Run the task daily at 1:00 & 13:00
`->weekly();`  |  Run the task every week
`->monthly();`  |  Run the task every month

These methods may be combined with additional constraints to create even more finely tuned schedules that only run on certain days of the week. For example, to schedule a command to run weekly on Monday:

```php
$schedule->call(function () {
    // Runs once a week on Monday at 13:00...
})->weekly()->mondays()->at('13:00');
```

Below is a list of the additional schedule constraints:

Method  | Description
------------- | -------------
`->weekdays();`  |  Limit the task to weekdays
`->sundays();`  |  Limit the task to Sunday
`->mondays();`  |  Limit the task to Monday
`->tuesdays();`  |  Limit the task to Tuesday
`->wednesdays();`  |  Limit the task to Wednesday
`->thursdays();`  |  Limit the task to Thursday
`->fridays();`  |  Limit the task to Friday
`->saturdays();`  |  Limit the task to Saturday
`->when(Closure);`  |  Limit the task based on a truth test

#### Truth Test Constraints

The `when` method may be used to limit the execution of a task based on the result of a given truth test. In other words, if the given `Closure` return `true`, the task will execute as long as no other constraining conditions prevent the task from running:

```php
$schedule->command('emails:send')->daily()->when(function () {
    return true;
});
```

### Preventing Task Overlaps

By default, scheduled tasks will be run even if the previous instance of the task is still running. To prevent this, you may use the `withoutOverlapping` method:

```php
$schedule->command('emails:send')->withoutOverlapping();
```

In this example, the `emails:send` console command will be run every minute if it is not already running. The `withoutOverlapping` method is especially useful if you have tasks that vary drastically in their execution time, preventing you from needing to predict exactly how long a given task will take.

## Task Output

The scheduler provides several convenient methods for working with the output generated by scheduled tasks. First, using the `sendOutputTo` method, you may send the output to a file for later inspection.

```php
$schedule->command('emails:send')
    ->daily()
    ->sendOutputTo($filePath);
```

Using the `emailOutputTo` method, you may e-mail the output to an e-mail address of your choice. Note that the output must first be sent to a file using the `sendOutputTo` method. Also before e-mailing the output of a task, you should configure [mail services](../../setup/mail-config.md).

```php
$schedule->command('foo')
    ->daily()
    ->sendOutputTo($filePath)
    ->emailOutputTo('foo@example.tld');
```

::: tip
The `emailOutputTo` and `sendOutputTo` methods are exclusive to the `command` method and are not supported for `call`.
:::

## Task Hooks

Using the `before` and `after` methods, you may specify code to be executed before and after the scheduled task is complete:

```php
$schedule->command('emails:send')
    ->daily()
    ->before(function () {
        // Task is about to start...
    })
    ->after(function () {
        // Task is complete...
    });
```

#### Pinging URLs

Using the `pingBefore` and `thenPing` methods, the scheduler can automatically ping a given URL before or after a task is complete. This method is useful for notifying an external service that your scheduled task is commencing or complete:

```php
$schedule->command('emails:send')
    ->daily()
    ->pingBefore($url)
    ->thenPing($url);
```
---
subtitle: October CMS comes with several basic exception types out of the box.
---
# Available Exceptions

### Application Exception

The `October\Rain\Exception\ApplicationException` class, aliased as `ApplicationException`, is the most common exception type that is used when a simple application condition has failed.

```php
throw new ApplicationException('You must be logged in to do that!');
```

The error message will be simplified and will never include any sensitive information like the PHP file and line number.

### System Exception

The `October\Rain\Exception\SystemException` class, aliased as `SystemException`, is used for errors that are critical to the system functioning and are always logged.

```php
throw new SystemException('Unable to contact the mail server API');
```

When this exception is thrown a detailed error message is shown with the file and line number where it occurred.

### Not Found Exception

The `October\Rain\Exception\NotFoundException` class, aliased as `NotFoundException`, is used for errors that occur when a missing record is encountered.

```php
throw new NotFoundException('Record not found');
```

When this exception is thrown the standard response will change to display the nearest not found page with a 404 status code added.

### Validation Exception

The `October\Rain\Exception\ValidationException` class, aliased as `ValidationException`, is used for errors that relate directly to a form submission and an invalid field. The message should contain an array with fields and error messages.

```php
throw new ValidationException(['username' => 'Sorry that username is already taken!']);
```

You can also pass an instance of the [validation service](../services/validation.md).

```php
$validation = Validator::make(...);

if ($validation->fails()) {
    throw new ValidationException($validation);
}
```

When this exception is thrown the [AJAX framework](./ajax.md) will provide this information in a usable format and focus the first invalid field.

### AJAX Exception

The `October\Rain\Exception\AjaxException` class, aliased as `AjaxException`, is considered a "smart error" and will return the HTTP code 406. This allows them to pass response contents as if they were a successful response.

```php
throw new AjaxException(['#flashMessages' => $this->renderPartial(...)]);
```

When this exception is thrown the [AJAX framework](./ajax.md) will follow the standard error workflow but will also refresh specified partials.

## Exception Handling

All exceptions are handled by the `October\Rain\Foundation\Exception\Handler` class. This class contains two methods: `report` and `render` that dictate if an error should be logged and how to respond to an error.

However, you may specify custom handlers if needed using the `App::error` method. Handlers are called based on the type-hint of the Exception they handle. For example, you may create a handler that only handles `RuntimeException` instances:

```php
App::error(function(RuntimeException $exception) {
    // Handle the exception...
});
```

If an exception handler returns a response, that response will be sent to the browser and no other error handlers will be called.

```php
App::error(function(InvalidUserException $exception) {
    return 'Sorry! Something is wrong with this account!';
});
```

To listen for PHP fatal errors, you may use check for the Error exception type:

```php
App::error(function(Error $exception) {
    //
});
```

If you have several exception handlers, they should be defined from most generic to most specific. So, for example, a handler that handles all exceptions of type `Exception` should be defined before a custom exception type such as `SystemException`.

### Where to Place Error Handlers

Error handler registrations generally fall under the category of bootstrap code. In other words, they prepare your application to actually handle requests, and usually need to be executed before a route or controller is actually called. The most common place is the `boot` method of a [plugin registration file](../extending.md). Alternatively, plugins can supply a file named **init.php** in the plugin directory that you can use to place error handler registrations.

## HTTP Exceptions

Some exceptions describe HTTP error codes from the server. For example, this may be a "page not found" error (404), an "unauthorized error" (401) or even a developer generated 500 error. In order to generate such a response from anywhere in your application, use the following.

```php
App::abort(404);
```

The `abort` method will immediately raise an exception which will be rendered by the exception handler. Optionally, you may provide the response text.

```php
App::abort(403, 'Unauthorized action.');
```

This method may be used at any time during the request's life cycle. There is also an accompanying [Twig filter for aborting requests](../../markup/function/abort.md).

### Custom Error Page

By default any errors will be shown with a detailed error page containing the file contents, line number and stack trace where the error occurred. You can display a custom error page by setting the configuration value `debug` to **false** in the `config/app.php` script and creating a page with the URL `/error`.
---
subtitle: Learn how to send mail and create templates.
---
# Sending Mail

This article describes how to build mail content, including using layouts and partials and then the methods used to send them. Basic Twig tags and expressions are supported in mail content. Markdown syntax is also supported, see the section on [using HTML in Markdown](../services/parser.md) for more details.

## Message Content

Mail messages can be sent in October CMS using either mail views or mail templates. A mail view is supplied by the application or plugin in the file system in the **/views** directory. Whereas a mail template is managed using the backend panel via **Settings → Mail Templates**.

Optionally, mail views can be registered in the [plugin registration file](../extending.md) with the `registerMailTemplates` method. This automatically seeds a mail template allowing them to be customized using the backend panel.

### Defining Templates in the Backend Panel

You can create mail templates stored in the database using backend panel via **Settings → Mail Templates**. The **code** given to template is a unique identifier and cannot be changed once created.

For example, if you create a template with code `my-template` you can send it using this PHP code:

```php
Mail::send('my-template', $data, function($message) {
    // ...
});
```

::: tip
If the mail template does not exist in the system, this code will attempt to find a mail view in the filesystem with the same code.
:::

### Defining Layouts in the Backend Panel

Mail layouts can be created by selecting **Settings → Mail Templates** and clicking the **Layouts** tab. These behave just like CMS layouts, they contain the scaffold for the mail message. Mail views and templates support the use of mail layouts.

By default, October CMS comes with two default mail layouts.

Layout | Code | Description
------------- | ------------- | -------------
Default | `default` | Used for public facing, frontend mail.
System | `system` | Used for internal, backend mail.

### Defining Views in the Filesystem

Mail views reside in the file system and the code used represents the path to the view file. For example sending mail with the code `author.plugin::mail.message` would use the content in following file.

::: dir
├── plugins
|   └── author  _← "author" Segment_
|       └── myplugin  _← "plugin" Segment_
|           └── `views`
|               └── mail  _← "mail" Segment_
|                   └── message.htm  _← "message" Segment_
:::

The content inside a mail view file can include up to 3 sections: **configuration**, **plain text**, and **HTML markup**. Sections are separated with the `==` sequence. For example:

::: cmstemplate
```ini
subject = "Your product has been added to October CMS project"
```
```twig
Hi {{ name }},

Good news! User {{ user }} just added your product "{{ product }}" to a project.

This message was sent using no formatting (plain text)
```
```twig
<p>Hi {{ name }},</p>

<p>
    <strong>Good news!</strong>
    User {{ user }} just added your product "{{ product }}" to a project.
</p>

<p>This email was sent using formatting (HTML)</p>
```
:::

The **plain text** section is optional and a view can contain only the **configuration** and **HTML markup** sections. Markup syntax is also supported as an alternative syntax.

::: cmstemplate
```ini
layout = "default"
subject = "Your product has been added to October CMS project"
```
```twig
Hi {{ name }},

**Good news!** User {{ user }} just added your product "{{ product }}" to a project.
```
:::

#### Configuration Section

The configuration section sets the mail view properties. The following configuration properties are supported.

Property | Description
------------- | -------------
**subject** | the mail message subject, required.
**layout** | the mail layout code or view, optional. Default value is `default`.

### Registering Templates, Layouts & Partials

::: aside
The **code** value in the backend panel will be the same as the mail view path. For example, `author.plugin:mail.message`.
:::

Mail views can be registered as default templates created in the backend panel. Templates are registered by overriding the `registerMailTemplates` method of the [plugin registration file](../extending.md). Templates can implement partials and layouts, similar to CMS themes, and these are registered with `registerMailLayouts` and `registerMailPartials` respectively.

```php
public function registerMailTemplates()
{
    return [
        // ...Templates defined here
    ];
}

public function registerMailLayouts()
{
    return [
        // ...Layouts defined here
    ];
}

public function registerMailPartials()
{
    return [
        // ...Partials defined here
    ];
}
```

In the backend panel, when a generated template is saved for the first time, the customized content will be used when sending mail for the assigned code. In this context, the registered mail views can be considered default or fallback views.

#### Registering a Template

The `templates` key in the registration array is used for registering views as mail templates. The method should return an array where the key is the template code and the value is the name of a [view path](../services/response-view.md). The template code is used to reference the template.

```php
public function registerMailTemplates()
{
    return [
        'rainlab.user:activate' => 'rainlab.user::mail.activate',
        'rainlab.user:restore' => 'rainlab.user::mail.restore',
    ];
}
```

Sending a message uses the template code, for example.

```php
Mail::send('rainlab.user:activate', ...);
```

#### Registering a Layout

The `registerMailLayouts` method override is used to register layouts and each layout needs a unique `code` to identify it, along with the default view file for the contents.

```php
public function registerMailLayouts()
{
    return [
        'marketing' => 'acme.blog::layouts.marketing',
        'notification' => 'acme.blog::layouts.notification',
    ];
}
```

The layout can now be referenced in templates using the `code` value.

::: cmstemplate
```ini
layout = "marketing"
```
```twig
Page contents...
```
:::

#### Registering a Partial

Like layouts, mail partials can be registered with the `registerMailPartials` method override and each partial needs a unique `code` to identify it, along with the default view file for the contents.

```php
public function registerMailPartials()
{
    return [
        'tracking' => 'acme.blog::partials.tracking',
        'promotion' => 'acme.blog::partials.promotion',
    ];
}
```

The partial can now be referenced in templates using the `{% partial %}` tag and `code` value.

```twig
{% partial 'tracking' %}
```

#### File-based Layouts

To reference a file-based layout, you may pass the view code to the **layout** property. For example, this mail view references a layout of `acme.blog::mail.custom-layout`.

```ini
layout = "acme.blog::mail.custom-layout"
subject = "Your product has been added to October CMS project"
==
...
```

Using the code above, it will attempt to load the layout content from the path **plugins/acme/blog/views/mail/custom-layout.htm** and these contents are an example.

```twig
<html>
<body>
    <h1>HTML Contents</h1>
    <div>
        {{ content|raw }}
    </div>
</body>
</html>
```

::: warning
The contents of file-based layouts cannot be edited in the admin panel.
:::

### Global Variables

You may register variables that are globally available to all mail templates with the `View::share` method.

```php
View::share('site_name', 'October CMS');
```

This code could be called inside the register or boot method of a [plugin registration file](../plugin/registration.md). Using the above example, the variable `{{ site_name }}` will be available inside all mail templates.

## Sending Mail

To send a message, use the `send` method on the `Mail` facade which accepts three arguments. The first argument is a unique mail code used to locate either the mail view or mail template. The second argument is an array of data you wish to pass to the view. The third argument is a `Closure` callback which receives a message instance, allowing you to customize the recipients, subject, and other aspects of the mail message.

```php
// These variables are available inside the message as Twig
$vars = ['name' => 'Joe', 'user' => 'Mary'];

Mail::send('acme.blog:message', $vars, function($message) {
    $message->to('admin@domain.tld', 'Admin Person');
    $message->subject('This is a reminder');
});
```

Since we are passing an array containing the `name` key in the example above, we could display the value within our e-mail view using the following Twig markup.

```twig
{{ name }}
```

::: warning
You should avoid passing a `message` variable in your message, this variable is always passed and allows the inline embedding of attachments.
:::

### Quick Sending

October CMS also includes an alternative method called `sendTo` that can simplify sending mail.

```php
// Send to address using no name
Mail::sendTo('admin@domain.tld', 'acme.blog:message', $params);

// Send using an object's properties
Mail::sendTo($user, 'acme.blog:message', $params);

// Send to multiple addresses
Mail::sendTo(['admin@domain.tld' => 'Admin Person'], 'acme.blog:message', $params);

// Alternatively send a raw message without parameters
Mail::rawTo('admin@domain.tld', 'Hello friend');
```

The first argument in `sendTo` is used for the recipients can take different value types.

Type | Description
------------- | -------------
String | a single recipient address, with no name defined.
Array | multiple recipients where the array key is the address and the value is the name.
Object | a single recipient object, where the *email* property is used for the address and the *name* is optionally used for the name.
Collection | a collection of recipient objects, as above.

The complete signature of `sendTo` is as follows.

```php
Mail::sendTo($recipient, $message, $params, $callback, $options);
```

- `$recipient` is defined as above.
- `$message` is the template name or message contents for raw sending.
- `$params` array of variables made available inside the template.
- `$callback` gets called with one parameter, the message builder as described for the `send` method (optional, defaults to null). If not a callable value, works as a substitute for the next options argument.
- `$options` custom sending options passed as an array (optional)

The following custom sending `$options` are supported.

Option | Description
------------- | -------------
**queue** | specifies whether to queue the message or send it directly, optional. Default: `false`.
**bcc** | specifies whether to add recipients as Bcc or regular To addresses. Default: `false`.

### Building the Message

As previously mentioned, the third argument given to the `send` method is a `Closure` allowing you to specify various options on the e-mail message itself. Using this Closure you may specify other attributes of the message, such as carbon copies, blind carbon copies, etc:

```php
Mail::send('acme.blog:welcome', $vars, function($message) {
    $message->from('us@example.tld', 'October');
    $message->to('foo@example.tld')->cc('bar@example.tld');
});
```

Here is a list of the available methods on the `$message` message builder instance.

```php
$message->from($address, $name = null);
$message->sender($address, $name = null);
$message->to($address, $name = null);
$message->cc($address, $name = null);
$message->bcc($address, $name = null);
$message->replyTo($address, $name = null);
$message->subject($subject);
$message->priority($level);
$message->attach($pathToFile, array $options = []);

// Attach a file from a raw $data string...
$message->attachData($data, $name, array $options = []);
```

#### Mailing Plain Text

By default, the view given to the `send` method is assumed to contain a mail view, where you may specify a plain text view to send in addition to the HTML view.

```php
Mail::send('acme.blog:message', $data, $callback);
```

Or, if you only need to send a plain text e-mail, you may specify this using the `text` key in the array:

```php
Mail::send(['text' => 'acme.blog:text'], $data, $callback);
```

#### Mailing Parsed Raw Strings

You may use the `raw` method if you wish to e-mail a raw string directly. This content will be parsed by Markdown.

```php
Mail::raw('Text to e-mail', function ($message) {
    //
});
```

Additionally this string will be parsed by Twig, if you wish to pass variables to this environment, use the `send` method instead, passing the content as the `raw` key.

```php
Mail::send(['raw' => 'Text to email'], $vars, function ($message) {
    //
});
```

#### Mailing Raw Strings

If you pass an array containing either `text` or `html` keys, this will be an explicit request to send mail. No layout or markdown parsing is used.

```php
Mail::raw([
    'text' => 'This is plain text',
    'html' => '<strong>This is HTML</strong>'
], function ($message) {
    //
});
```

### Sending Attachments

To add attachments to an e-mail, use the `attach` method on the `$message` object passed to your Closure. The `attach` method accepts the full path to the file as its first argument:

```php
Mail::send('acme.blog:welcome', $data, function ($message) {
    //

    $message->attach($pathToFile);
});
```

When attaching files to a message, you may also specify the display name and / or MIME type by passing an `array` as the second argument to the `attach` method:

```php
$message->attach($pathToFile, ['as' => $display, 'mime' => $mime]);
```

### Inline Attachments

#### Embedding an Image in Mail Content

Embedding inline images into your e-mails is typically cumbersome; however, there is a convenient way to attach images to your e-mails and retrieving the appropriate CID. To embed an inline image, use the `embed` method on the `message` variable within your e-mail view. Remember, the `message` variable is available to all of your mail views:

```twig
<body>
    Here is an image:

    <img src="{{ message.embed(pathToFile) }}">
</body>
```

If you are planning to use queued emails make sure that the path of the file is absolute. To achieve that you can simply use the [app filter](../../markup/filter/app.md):

```twig
<body>
    Here is an image:
    {% set pathToFile = 'storage/app/media/path/to/file.jpg'|app %}
    <img src="{{ message.embed(pathToFile) }}">
</body>
```

#### Embedding Raw Data in Mail Content

If you already have a raw data string you wish to embed into an e-mail message, you may use the `embedData` method on the `message` variable:

```twig
<body>
    Here is an image from raw data:

    <img src="{{ message.embedData(data, name) }}">
</body>
```

## Queueing Mail

### Queueing a Mail Message

Since sending mail messages can drastically lengthen the response time of your application, many developers choose to queue messages for background sending. This is easy using the built-in [unified queue API](../services/queue.md). To queue a mail message, use the `queue` method on the `Mail` facade:

```php
Mail::queue('acme.blog:welcome', $data, function ($message) {
    //
});
```

This method will automatically take care of pushing a job onto the queue to send the mail message in the background. Of course, you will need to [configure your queues](../services/queue.md) before using this feature.

### Delayed Message Queueing

If you wish to delay the delivery of a queued e-mail message, you may use the `later` method. To get started, simply pass the number of seconds by which you wish to delay the sending of the message as the first argument to the method.

```php
Mail::later(5, 'acme.blog:welcome', $data, function ($message) {
    //
});
```

### Pushing to Specific Queues

If you wish to specify a specific queue on which to push the message, you may do so using the `queueOn` and `laterOn` methods:

```php
Mail::queueOn('queue-name', 'acme.blog:welcome', $data, function ($message) {
    //
});

Mail::laterOn('queue-name', 5, 'acme.blog:welcome', $data, function ($message) {
    //
});
```

#### See Also

::: also
* [Mail Configuration](../../setup/mail-config.md)
:::
---
subtitle: Self-contained blocks of functionality solving different tasks.
---
# Widgets

Widgets are reusable controls that have a user interface and a backend controller (the widget class) that prepares the widget data and handles AJAX requests generated by the widget user interface.

## Generic Widgets

Widgets are the backend equivalent of [CMS Components](../../cms/themes/components.md). They are similar because they are modular bundles of functionality, supply partials and are named using aliases. The key difference is that backend widgets use YAML markup for their configuration and bind themselves to backend controllers manually.

Widget classes reside inside the **widgets** directory of the plugin directory. The inner directory name matches the name of the widget class written in lowercase. Widgets can supply assets and partials. An example widget directory structure looks like this:

::: dir
├── `widgets`
|   ├── form
|   |   ├── partials
|   |   |   └── _form.php  _← Partial File_
|   |   └── assets
|   |       ├── js
|   |       |   └── form.js  _← JavaScript File_
|   |       └── css
|   |           └── form.css  _← StyleSheet File_
|   └── Form.php  _← Widget Class_
:::

### Class Definition

The generic widget classes must extend the `Backend\Classes\WidgetBase` class. As any other plugin class, generic widget controllers should belong to the [plugin namespace](./plugins.md). The following is an example of a widget class definition.

```php
namespace Backend\Widgets;

use Backend\Classes\WidgetBase;

class Lists extends WidgetBase
{
    /**
     * @var string defaultAlias to identify this widget.
     */
    protected $defaultAlias = 'list';

    // ...
}
```

The widget class must contain a **render()** method for producing the widget markup by rendering a widget partial. Example:

```php
public function render()
{
    return $this->makePartial('list');
}
```

To pass variables to partials you can either add them to the `$vars` property.

```php
public function render()
{
    $this->vars['var'] = 'value';

    return $this->makePartial('list');
}
```

Alternatively you may pass the variables to the second parameter of the makePartial() method:

```php
public function render()
{
    return $this->makePartial('list', ['var' => 'value']);
}
```

## Binding Widgets to Controllers

::: aside
Binding to a controller is also required to make [AJAX handlers available](./ajax.md).
:::

A widget should be bound to a backend controller before you can start using it in a backend page or partial. Use the widget's `bindToController` method for binding it to a controller. The best place to initialize a widget is the controller's `beforeDisplay` method, which is called from the constructor.

For example, creating a new widget instance and binding it to the controller. Note the constructor takes the controller as the first argument.

```php
public function beforeDisplay()
{
    $myWidget = new MyWidgetClass($this);
    $myWidget->alias = 'myWidget';
    $myWidget->bindToController();
}
```

After binding the widget you can access it in the controller's view or partial by its alias using the `$this->widget` property.

```php
<?= $this->widget->myWidget->render() ?>
```

## Running Code Before AJAX Handlers

Sometimes you may want code to execute before an AJAX handler executes. Defining an `init` method in the widget allows code to run before every AJAX handler.

```php
function init()
{
    // From a widget class
}
```

#### See Also

::: also
* [Form Widgets](../forms/form-widgets.md)
* [Filter Widgets](../lists/filter-widgets.md)
* [Report Widgets](../backend/report-widgets.md)
:::
---
subtitle: Learn how to translate messages in the backend area.
---
# Localization

::: aside
The language strings defined here will only be loaded in the backend panel. For translating frontend content, visit the [Theme Localization article](../../cms/themes/settings.md).
:::

Plugins can have localization files inside **lang** subdirectory. Plugin localization files use the JSON format and detected by the system automatically in the backend panel. Using localization strings are supported natively in the backend user interface menus, form labels, etc.

## Active Language

The default language for your application is stored in the `config/app.php` configuration file's locale configuration option. You are free to modify this value to suit the needs of your application. Each user can set their preferred locale setting via the **User Menu → Backend Preferences**.

You can check the active language in PHP using the `App::getLocale` method and set the active language using `App::setLocale` that takes the language code as the first argument.

```php
App::getLocale();

App::setLocale('fr');
```

## Localization File Structure

Below is an example of the plugin's **lang** directory.

::: dir
├── plugins
|   └── acme
|       └── todo
|           └── `lang`
|               ├── en.json  _← Localization File_
|               └── fr.json  _← Localization File_
:::

Using JSON files for localization is the preferred method of translation where strings use the "default" translation of the string as the key. For example, if your application has a French translation, you should create a `lang/fr.json` file.

```json
{
    "I love programming.": "j'adore programmer"
}
```

::: tip
Laravel offers a PHP-based translation method as a supported alternative to using JSON. View the [Laravel Localization article](https://laravel.com/docs/10.x/localization) to learn more.
:::

## Accessing Localization Strings

The localization strings can be loaded with the `__()` helper function by passing the default translation of your string.

```php
echo __('I love programming.');
```

Replacing parameters in translation strings is possible by passing an array as the second argument. Every parameter is prefixed with a `:` character.

```php
echo __(':name loves programming.', ['name' => 'Jeff']);
```

### Pluralized Values

Different languages can have a variety of complex rules for pluralization. Using the `|` character, you may distinguish singular and plural forms of a string.

```json
{
    "There is one apple|There are many apples": "Il y a une pomme|Il y a beaucoup de pommes"
}
```

More complex pluralization rules can specify translation strings for multiple ranges of values.

```json
{
    "{0} There are none|[1,19] There are some|[20,*] There are many": "..."
}
```

The `trans_choice` function is used to process pluralized values.

```php
echo __('There is one apple|There are many apples', 3);
```

## Overriding Localization Strings

System users can override plugin localization strings without altering the plugins' files. This is done by adding localization files to the **lang** directory. For example, to override the French translations you should create the file in the following location:

::: dir
├── app
|   └── `lang`
|       └── fr.json  _← Override File_
:::

The file could contain only strings you want to override, there is no need to replace the entire file. Example:

```json
{
    "I love programming.": "Coding is the best!"
}
```

Some plugins may ship with their own PHP-based language files. You may override these in the same location. Use the complete language key in the JSON file, for example, to override the `rainlab.blog::lang.post_label` value.

```json
{
    "rainlab.blog::lang.post_label": "Article"
}
```

You may also use a nested folder structure to override a file using the PHP format. For example, a plugin name **Acme.Blog** places the file at `lang/acme/blog/en/lang.php`.

::: dir
├── app
|   └── lang
|       └── `acme`  _← Plugin Author_
|           └── `todo`  _← Plugin Name_
|               └── en
|                   └── lang.php  _← Override File_
:::

### Programatically Overriding Strings

You can override language strings in PHP by using the `Lang::set` method. This takes the language key and new translated value as the arguments.

```php
Lang::set('I love programming.', 'Coding is the best!');
```

By default this will override the active locale, the third argument can specify an explicit locale. The following example replaces the value for French.

```php
Lang::set('I love programming.', 'Le codage est le meilleur!', 'fr');
```

## Contributing Language Strings

October CMS uses a service called Crowdin to better manage translations for popular languages. It also performs automated machine translations using Google's translation API for all other languages. If you discover missing or incorrect translations in October CMS, please follow the instructions below.

### Using Crowdin

You may check to see if your language is supported by the Crowdin project using the link below. This service allows you to contribute translations using a streamlined interface.

- [October CMS Crowdin Project Page](https://crowdin.com/project/octobercms)

If your language does not appear on this page, please follow the GitHub instructions below. Languages are added to Crowdin when we notice a language is becoming more active on GitHub.

### Using GitHub

You may visit the [repository on GitHub](https://github.com/octobercms/october/tree/develop/modules) to suggest updates for your language using a pull request. The language files are found in the various modules, so you may need to check multiple files to find the correct language string. In this example, we will modify the Dutch language using the `nl` language code and we know the string is located in the Tailor module.

1. Open the [GitHub repository](https://github.com/octobercms/october/tree/develop/modules).
2. Click on **tailor**, then **lang** to open the language directory for Tailor
3. Click on the **nl.json** file to open the language file for Dutch
4. At the top right, click the pencil icon to **Edit this file**

In the file you will see the English version on the left side and the Dutch version on the right side, for example:

```json
{
  "Manage Entries": "Invoer beheren",
  "Create :name Entry": "Maak :name invoer"
}
```

When making the update, only modify the right side which contains the translated value. Some values may contain variables such as `:name` and these should be left intact. Once completed, click the **Commit changes** button to submit a new Pull Request. It will be reviewed by the team and included in subsequent releases.

::: tip
If the language key does not exist or you cannot find it, you may [contact us for assistance](https://octobercms.com/contact).
:::

#### See Also

::: also
* [Theme Localization](../../cms/themes/localization.md)
* [Laravel Localization](https://laravel.com/docs/10.x/localization)
:::
---
subtitle: Remix classes together with common functionality.
---
# Behaviors

Behaviors add the ability for classes to have private traits that are similar to [native PHP Traits](http://php.net/manual/en/language.oop5.traits.php), except they have some distinct benefits.

1. Behaviors use their own constructor.
1. Behaviors can have private or protected methods.
1. Methods and property names can conflict safely.
1. Classes can be extended with behaviors dynamically.

## Comparison to Traits

Where you might use a PHP trait like this.

```php
class MyClass
{
    use \October\Rain\UtilityFunctions;
    use \October\Rain\DeferredBinding;
}
```

A behavior is used in a similar fashion.

```php
class MyClass extends \October\Rain\Extension\Extendable
{
    public $implement = [
        \October\Rain\UtilityFunctions::class,
        \October\Rain\DeferredBinding::class,
    ];
}
```

Where you might define a trait like this.

```php
trait UtilityFunctions
{
    public function sayHello()
    {
        echo "Hello from " . get_class($this);
    }
}
```

A behavior is defined like this.

```php
class UtilityFunctions extends \October\Rain\Extension\ExtensionBase
{
    protected $parent;

    public function __construct($parent)
    {
        $this->parent = $parent;
    }

    public function sayHello()
    {
        echo "Hello from " . get_class($this->parent);
    }
}
```

The extended object is always passed as the first argument to the constructor. In summary, when using behaviors extend the following classes.

- Extend `October\Rain\Extension\ExtensionBase` to declare a class as a behavior.
- Extend `October\Rain\Extension\Extendable` as the class implementing the behavior.

## Extending Constructors

Any class that extends the `Extendable` class can have its constructor extended with the static `extend` method. The argument should pass a closure that will be called as part of the class constructor.

```php
MyClass::extend(function($controller) {
    //
});
```

### Soft Definition

If a behavior class does not exist, like a trait, a **class not found** error will be thrown. In some cases you may wish to suppress this error, for conditional implementation if a behavior is present in the system. You can do this by placing an `@` symbol at the beginning of the class name.
In the following example, if the class name `RainLab\Translate\Behaviors\TranslatableModel` does not exist, no error will be thrown.

```php
class User extends \October\Rain\Extension\Extendable
{
    public $implement = [
        '@'.\RainLab\Translate\Behaviors\TranslatableModel::class
    ];
}
```

## Dynamically Implementing a Behavior

This unique ability to extend constructors allows behaviors to be implemented dynamically, for example, use the `implementClassWith` method to implement the `RelationController` class in the `UsersController` class.

```php
UsersController::extend(function($controller) {
    $controller->implementClassWith(\Backend\Behaviors\RelationController::class);
});
```

::: tip
The `implementClassWith` method can be called multiple times safely, it will check if the class is already implementing the behavior and implement it.
:::

Use the `extendClassWith` method to extend an object after it has been constructed. The following example would dynamically extend a Model class using a class name stored in the database.

```php
public function afterFetch()
{
    $this->extendClassWith($this->class_type);
}
```

To check if an object has been extended with a behavior, you may use the `isClassExtendedWith` method on the object.

```php
$controller->isClassExtendedWith(\Backend\Behaviors\RelationController::class);
```

To specifically call a method from a behavior, use the `asExtension` method which takes the class base name or the fully qualified class as its argument.

```php
echo $controller->asExtension('RelationController')->otherMethod();
```

## Dynamically Creating Methods

Methods can be created to an extendable object by calling `addDynamicMethod` and passing a method name and callable object, like a `Closure`.

```php
MyModel::extend(function($model) {
    $model->addDynamicMethod('getTagsAttribute', function() use ($model) {
        return '...';
    });
});
```

### Checking the Existence of a Method

To check for the existence of a method in an `Extendable` class call the `methodExists` method - similar to the PHP `method_exists()` function. This will detect both standard methods, methods in behaviors and dynamic methods that have been added through a `addDynamicMethod` call.

```php
$post = new Post;
$post->methodExists('getTagsAttribute'); // true
$post->methodExists('missingMethod'); // false
```

### List All Available Methods

To retrieve a list of all available methods in an `Extendable` class, you can use the `getClassMethods` method. This method operates similar to the PHP `get_class_methods()` function in that it returns an array of available methods in a class, but in addition to defined methods in the class, it will also list any methods provided by an extension or through an `addDynamicMethod` call.

```php
$post = new Post;
$methods = $post->getClassMethods();

/**
 * $methods = [
 *   0 => '__construct',
 *   1 => 'extend',
 *   2 => 'getTagsAttribute',
 *   ...
 * ];
 */
```

## Usage Example

### Behavior / Extension class

```php
namespace MyNamespace\Behaviors;

class FormController extends \October\Rain\Extension\ExtensionBase
{
    /**
     * @var Controller controller is a reference to the extended object.
     */
    protected $controller;

    /**
     * __construct
     */
    public function __construct($controller)
    {
        $this->controller = $controller;
    }

    public function someMethod()
    {
        return "I come from the FormController Behavior!";
    }

    public function otherMethod()
    {
        return "You might not see me...";
    }
}
```

### Extending a Class

This `Controller` class will implement the `FormController` behavior and then the methods will become available (mixed in) to the class. We will override the `otherMethod` method.

```php
<?php namespace MyNamespace;

class Controller extends \October\Rain\Extension\Extendable
{
    /**
     * implement the FormController behavior
     */
    public $implement = [
        \MyNamespace\Behaviors\FormController::class
    ];

    public function otherMethod()
    {
        return "I come from the main Controller!";
    }
}
```

### Using the Extension

```php
$controller = new MyNamespace\Controller;

// Prints: I come from the FormController Behavior!
echo $controller->someMethod();

// Prints: I come from the main Controller!
echo $controller->otherMethod();

// Prints: You might not see me...
echo $controller->asExtension('FormController')->otherMethod();
```
---
subtitle: Learn where page content is stored and rendered.
---
# Rendering Views

Views reside in a directory that shares the same name as the controller.

::: dir
├── plugins
|   └── acme
|       └── blog
|           ├── controllers
|           |   ├── users  _← View Directory_
|           |   |   ├── `_partial.php`  _← Partial File_
|           |   |   └── `index.php`  _← View File_
|           |   └── Users.php  _← Controller Class_
|           └── Plugin.php
:::

## Partials

Backend partials are files with the extension **php** that reside in the [controller's view](./controllers.md) directory. The partial file names should start with the underscore: **_partial.php**. Partials can be rendered from a backend page or another partial. Use the controller's `makePartial` method to render a partial. The method takes two parameters - the partial name and the optional array of variables to pass to the partial. Example:

```php
<?= $this->makePartial('sidebar', ['showHeader' => true]) ?>
```

### Hint Partials

You can render informative panels in the backend, called hints, that the user can hide. The first parameter should be a unique key for the purposes of remembering if the hint has been hidden or not. The second parameter is a reference to a partial view. The third parameter can be some extra view variables to pass to the partial, in addition to some hint properties.

```php
<?= $this->makeHintPartial('my_hint_key', 'my_hint_partial', ['foo' => 'bar']) ?>
```

You can also disable the ability to hide a hint by setting the key value to a null value. This hint will always be displayed:

```php
<?= $this->makeHintPartial(null, 'my_hint_partial') ?>
```

The following properties are available:

Property | Description
------------- | -------------
**type** | Sets the color of the hint, supported types: danger, info, success, warning. Default: info.
**title** | Adds a title section to the hint.
**subtitle** | In addition to the title, adds a second line to the title section.
**icon** | In addition to the title, adds an icon to the title section.

### Checking if Hints are Hidden

If you're using hints, you may find it useful to check if the user has hidden them. This is easily done using the `isBackendHintHidden` method. It takes a single parameter, and that's the unique key you specified in the original call to `makeHintPartial`. The method will return true if the hint was hidden, false otherwise:

```php
<?php if ($this->isBackendHintHidden('my_hint_key')): ?>
    <!-- Do something when the hint is hidden -->
<?php endif ?>
```

## Layouts and Child Layouts

Backend layouts reside in an optional **layouts/** directory of a plugin. A custom layout is set with the `$layout` property of the controller object. It defaults to the system layout called  `default`.

```php
/**
 * @var string layout to use for the view.
 */
public $layout = 'mycustomlayout';
```

Layouts also provide the option to attach custom CSS classes to the BODY tag. This can be set with the `$bodyClass` property of the controller.

```php
/**
 * @var string bodyClass (CSS) to add to the layout.
 */
public $bodyClass = 'compact-container';
```

These body classes are available for the default layout:

- **compact-container** - uses no padding on all sides.
- **slim-container** - uses no padding left and right.
- **breadcrumb-flush** - tells the page breadcrumb to sit flush against the element below.

### Form with Sidebar

Layouts can also be used in the same way as partials, acting more like a global partial. The system provides an example of this called `form-with-sidebar` and demonstrates a novel way to implement a child layout structure.

Before using this layout style, ensure that your controller uses the body class `compact-container` by setting it in your controller's action method or constructor.

```php
$this->bodyClass = 'compact-container';
```

This layout uses two placeholders, a primary content area called **form-contents** and a complimentary sidebar called **form-sidebar**. Here is an example:

```php
<!-- Primary content -->
<?php Block::put('form-contents') ?>
    Main content
<?php Block::endPut() ?>

<!-- Complimentary sidebar -->
<?php Block::put('form-sidebar') ?>
    Side content
<?php Block::endPut() ?>

<!-- Layout execution -->
<?php Block::put('body') ?>
    <?= Form::open(['class'=>'layout stretch']) ?>
        <?= $this->makeLayout('form-with-sidebar') ?>
    <?= Form::close() ?>
<?php Block::endPut() ?>
```

The layout is executed in the final section by overriding the **body** placeholder used by every backend layout. It wraps everything with a `<form />` HTML tag and renders the child layout called **form-with-sidebar**. This file is located in **modules/backend/layouts/form-with-sidebar.php**.

## Extending the Layout

The `fireViewEvent` is used in several areas to [extend the backend area](../extending.md). The `backend.layout.extendHead` event can be used to extend the head element of the layout. The return value should contain the markup to include. The following adds a JavaScript file to every backend page.

```php
Event::listen('backend.layout.extendHead', function ($controller) {
    return '<script src="/app/assets/js/myscript.js"></script>';
});
```

The controller is available (first argument) to the event, this can be used to target specific controllers. The following adds specific CSS styles to the tailor entries controller only.

```php
Event::listen('backend.layout.extendHead', function ($controller) {
    if ($controller instanceof \Tailor\Controllers\Entries) {
        return '<styles> /* ... */ </styles>';
    }
});
```
---
subtitle: Discover how to use AJAX in the backend panel.
---
# AJAX

The backend panel uses the same [AJAX library as the CMS](../../cms/ajax/introduction.md) pages. The library is included and loaded automatically on the backend pages.

## Backend AJAX Handlers

The backend AJAX handlers can be defined in the controller class or widgets. In the controller class the AJAX handlers are defined as public methods with the name starting with "on" string: **onCreateTemplate**, **onGetTemplateList**, etc.

Backend AJAX handlers can return an array of data, throw an exception or redirect to another page. You can use `$this->vars` to set variables and the controller's `makePartial` method to render a partial and return its contents as a part of the response data.

```php
public function onOpenTemplate()
{
    if (post('someVar') !== 'someValue') {
        throw new ApplicationException('Invalid value');
    }

    $this->vars['foo'] = 'bar';

    return [
        'partialContents' => $this->makePartial('some-partial')
    ];
}
```

### Triggering AJAX Requests

The AJAX request can be triggered with the data attributes API or the JavaScript API. Please see the [frontend AJAX library](../ajax/introduction) for details. The following example shows how to trigger a request with a backend button.

```html
<button
    type="button"
    data-request="onDoSomething"
    class="btn btn-default">
    Do Something
</button>
```

## Behavior AJAX Handlers

Since behaviors will combine their methods to the parent controller, all AJAX handlers that are defined in a behavior are available to the controller. In some cases you may want to override an AJAX handler in the controller, you may do this by calling the `asExtension` method.

The controller AJAX handler takes priority, then requests the `Backend\Behaviors\FormController` behavior and calls its handler.

```php
function onDoSomething()
{
    // Custom logic here
    // ...

    // Call the extension handler
    return $this->asExtension('FormController')->doSomething();
}
```

## Widget AJAX Handlers

Widgets implement the same AJAX approach as the backend controllers. The AJAX handlers are public methods of the widget class with names starting with the **on** prefix. The only difference between the widget AJAX handlers and backend controller's AJAX handlers is that you should use the widget's `getEventHandler` method to return the widget's handler name when you refer to it in the widget partials.

```php
<a
    href="javascript:;"
    data-request="<?= $this->getEventHandler('onPaginate') ?>"
    title="Next page">Next</a>
```

When called from a widget class or partial the AJAX handler will target itself. For example, if the widget uses the alias of **mywidget** the handler will be targeted with `mywidget::onName`. The above would output the following attribute value:

```html
data-request="mywidget::onPaginate"
```

#### See Also

::: also
* [AJAX Framework Guide](../../cms/ajax/introduction.md)
:::
---
subtitle: Map the database table columns directly to a PHP object.
---
# Models

October CMS provides a beautiful and simple Active Record implementation for working with your database, based on [Eloquent by Laravel](http://laravel.com/docs/eloquent). Each database table has a corresponding "Model" which is used to interact with that table. Models allow you to query for data in your tables, as well as insert new records into the table.

Model classes reside in the **models** subdirectory of a plugin directory. An example of a model directory structure.

::: dir
├── plugins
|   └── acme
|       └── blog
|           ├── `models`
|           |   ├── post  _← Config Directory_
|           |   |   ├── fields.yaml  _← Config File_
|           |   |   └── columns.yaml  _← Config File_
|           |   └── Post.php  _← Model Class_
|           └── Plugin.php
:::

The model configuration directory could contain the model's [form field definitions](../../element/form-fields.md). The model configuration directory name matches the model class name written in lowercase.

## Defining Models

The `create:model` command generates the files needed for a new model. The first argument specifies the author and plugin name. The second argument specifies the model class name.

```bash
php artisan create:model Acme.Blog Post
```

In most cases, you should create one model class for each database table. All model classes must extend the `Model` class. The most basic representation of a model used inside a Plugin looks like this.

```php
namespace Acme\Blog\Models;

use Model;

class Post extends Model
{
    protected $table = 'acme_blog_posts';
}
```

The `$table` protected field specifies the database table corresponding the model. The table name is a snake case name of the author, plugin and pluralized record type name.

### Supported Properties

There are some standard properties that can be found on models, in addition to those provided by [model traits](traits.md). For example:

```php
class User extends Model
{
    protected $primaryKey = 'id';

    public $exists = false;

    protected $dates = ['last_seen_at'];

    public $timestamps = true;

    protected $jsonable = ['permissions'];

    protected $guarded = ['*'];
}
```

Property | Description
------------- | -------------
**$primaryKey** | primary key name used to identify the model.
**$incrementing** | boolean that if false indicates that the primary key is not an incrementing integer value.
**$exists** | boolean that if true indicates that the model exists.
**$dates** | values are converted to an instance of Carbon/DateTime objects after fetching.
**$timestamps** | boolean that if true will automatically set created_at and updated_at fields.
**$jsonable** | values are encoded as JSON before saving and converted to arrays after fetching.
**$fillable** | values are fields accessible to mass assignment.
**$guarded** | values are fields guarded from mass assignment.
**$visible** | values are fields made visible when [serializing the model data](../database/serialization.md).
**$hidden** | values are fields made hidden when [serializing the model data](../database/serialization.md).
**$connection** | string that contains the [connection name](../../setup/database-config.md) that's utilised by the model by default.

#### Primary Key

Models will assume that each table has a primary key column named `id`. You may define a `$primaryKey` property to override this convention.

```php
class Post extends Model
{
    protected $primaryKey = 'id';
}
```

#### Incrementing

Models will assume that the primary key is an incrementing integer value, which means that by default the primary key will be cast to an integer automatically. If you wish to use a non-incrementing or a non-numeric primary key you must set the public `$incrementing` property to false.

```php
class Message extends Model
{
    public $incrementing = false;
}
```

#### Timestamps

By default, a model will expect `created_at` and `updated_at` columns to exist on your tables. If you do not wish to have these columns managed automatically, set the `$timestamps` property on your model to `false`.

```php
class Post extends Model
{
    public $timestamps = false;
}
```

If you need to customize the format of your timestamps, set the `$dateFormat` property on your model. This property determines how date attributes are stored in the database, as well as their format when the model is serialized to an array or JSON.

```php
class Post extends Model
{
    protected $dateFormat = 'U';
}
```

#### Values stored as JSON

When attributes names are passed to the `$jsonable` property, the values will be serialized and deserialized from the database as JSON.

```php
class Post extends Model
{
    protected $jsonable = ['data'];
}
```

## Model Events

Models fire several events, allowing you to hook into various points in the model's life cycle. Events allow you to easily execute code each time a specific model class is saved or updated in the database. Events are defined by overriding special methods in the class, the following method overrides are available:

Event | Description
------------- | -------------
**beforeCreate** | before the model is saved, when first created.
**afterCreate** | after the model is saved, when first created.
**beforeSave** | before the model is saved, either created or updated.
**afterSave** | after the model is saved, either created or updated.
**beforeValidate** | before the supplied model data is validated.
**afterValidate** | after the supplied model data has been validated.
**beforeUpdate** | before an existing model is saved.
**afterUpdate** | after an existing model is saved.
**beforeDelete** | before an existing model is deleted.
**afterDelete** | after an existing model is deleted.
**beforeRestore** | before a soft-deleted model is restored.
**afterRestore** | after a soft-deleted model has been restored.
**beforeFetch** | before an existing model is populated.
**afterFetch** | after an existing model has been populated.

The following is an example of using an event.

```php
public function beforeCreate()
{
    $this->slug = Str::slug($this->name);
}
```

### Basic Usage

Whenever a new model is saved for the first time, the `beforeCreate` and `afterCreate` events will fire. If a model already existed in the database and the `save` method is called, the `beforeUpdate` / `afterUpdate` events will fire. However, in both cases, the `beforeSave` / `afterSave` events will fire.

For example, let's define an event listener that populates the `slug` attribute when a model is first created.

```php
public function beforeCreate()
{
    $this->slug = Str::slug($this->name);
}
```

Returning `false` from an event will cancel the `save` / `update` operation.

```php
public function beforeCreate()
{
    if (!$user->isValid()) {
        return false;
    }
}
```

It's possible to access old values using the `original` attribute. For example:

```php
public function afterUpdate()
{
    if ($this->title !== $this->original['title']) {
        // Title has changed
    }
}
```

You may find relationships created using [deferred bindings](../database/relations.md) (i.e: file attachments) are not available inside model events yet. To access them early, use the `withDeferred` database query method on the relation.

```php
public function beforeCreate()
{
    $avatar = $this->avatar()->withDeferred()->first();

    $gallery = $this->gallery()->withDeferred()->get();
}
```

You can externally bind to [local events](../services/event.md) for a single instance of a model using the `bindEvent` method. The event name should be the same as the method override name, prefixed with `model.`.

```php
$flight = new Flight;
$flight->bindEvent('model.beforeCreate', function() use ($model) {
    $model->slug = Str::slug($model->name);
});
```

## Extending Models

Since models are [equipped to use behaviors](./behaviors.md), they can be extended with the static `extend` method. The method takes a closure and passes the model object into it.

Inside the closure you can add relations to the model. Here we extend the `User` model to include a profile (has one) relationship referencing the `Profile` model.

```php
User::extend(function($model) {
    $model->hasOne['profile'] = [Profile::class, 'key' => 'user_id'];
});
```

This approach can also be used to bind to local events, the following code listens for the `model.beforeSave` event.

```php
User::extend(function($model) {
    $model->bindEvent('model.beforeSave', function() use ($model) {
        // ...
    });
});
```

Additionally, a few methods exist to extend protected model properties.

```php
User::extend(function($model) {
    // Add cast attributes
    $model->addCasts([
        'some_extended_field' => 'int',
    ]);

    // Add a date attribute
    $model->addDateAttribute('updated_at');

    // Adds fillable or jsonable fields
    $model->addFillable('first_name');
    $model->addJsonable('some_data');
});
```

Typically the best place to place code is within your [plugin registration file](../extending.md) `boot` method as this will be run on every request ensuring that the extensions you make to the model are available everywhere.

#### See Also

::: also
* [Querying a Model](../database/model.md)
* [Model Traits](../database/traits.md)
:::
---
subtitle: The foundation for adding new features to the CMS by extending it.
---
# Plugins

::: aside
Plugins are identified with a unique code, for example, a plugin called `Acme.Blog` is found in the directory **plugins/acme/blog**.
:::

This article describes plugins and their registration functions. The registration process allows plugins to declare their features such as CMS components or backend navigation and pages. Here are some examples of what a plugin can do.

1. Create database table structures and seed data.
1. Define [CMS components](../cms-components.md).
1. Define [user permissions](../backend/permissions.md).
1. Add [settings pages](../settings/settings.md), [navigation items](../backend/navigation.md), [lists](../lists/list-controller.md) and [forms](../forms/form-controller.md).
1. Alter [functionality of the core or other plugins](../extending.md).
1. Provide classes, [backend controllers](../system/controllers.md), views, assets and other files.

### Directory Structure

Plugins reside in the **plugins** directory of the application directory. An example of a plugin directory structure is below.

::: dir
├── `plugins`
|   └── acme  _← Author Name_
|       └── blog  _← Plugin Name_
|           ├── classes
|           ├── components
|           ├── controllers
|           ├── models
|           ├── updates
|           └── Plugin.php  _← Registration File_
:::

Not all plugin directories are required. The only required file is the **Plugin.php** described below. If your plugin provides only a single component, your plugin directory could be much simpler, like this.

::: dir
├── plugins
|   └── acme
|       └── blog
|           ├── `components`
|           └── Plugin.php
:::

### Plugin Namespaces

Plugin namespaces are essential, especially if you are going to publish your plugins on the [October CMS Marketplace](https://octobercms.com/plugins). When you register as an author on the Marketplace you will be asked for the author code which should be used as a root namespace for all your plugins. You can specify the author code only once, when you register. The default author code offered by the Marketplace consists of the author first and last name: JohnSmith. The code cannot be changed after you register. All your plugin namespaces should be defined under the root namespace, for example `JohnSmith\Blog`.

## Registration File

The `create:plugin` command generates a plugin folder and basic files for the plugin. The first argument specifies the author and plugin name.

```bash
php artisan create:plugin Acme.Blog
```

The **Plugin.php** file, called the plugin registration file, is an initialization script that declares a plugin's core functions and information. Registration files can provide the following:

1. Information about the plugin, its name, and author.
1. Registration methods for extending the CMS.

Registration scripts should use the plugin namespace. The registration script should define a class with the name `Plugin` that extends the `System\Classes\PluginBase` class. The only required method of the plugin registration class is `pluginDetails`. An example plugin registration file is below.

```php
namespace Acme\Blog;

class Plugin extends \System\Classes\PluginBase
{
    public function pluginDetails()
    {
        return [
            'name' => 'Blog Plugin',
            'description' => 'Provides some really cool blog features.',
            'author' => 'ACME Corporation',
            'icon' => 'icon-leaf'
        ];
    }

    public function registerComponents()
    {
        return [
            \Acme\Blog\Components\Post::class => 'blogPost'
        ];
    }
}
```

### Basic Plugin Information

The `pluginDetails` is a required method of the plugin registration class. It should return an array containing the following keys:

Key | Description
------------- | -------------
**name** | the plugin name, required.
**description** | the plugin description, required.
**author** | the plugin author name, required.
**icon** | a name of the plugin icon. The full list of available icons can be found in the [available icon documentation](../../element/available-icons.md). Any icon names provided by this font are valid, for example **icon-glass**, **icon-music**, optional.
**iconSvg** | an SVG icon to be used in place of the standard icon. The SVG icon should be a rectangle and can support colors, optional.
**homepage** | a link to the author's website address, optional.
**hint** | a shorter code used for [routing controller URLs](./controllers.md) in the admin panel, optional.

## Booting and Initialization

Plugin registration files can contain two methods `boot` and `register`. With these methods you can do anything you like, like register routes or attach handlers to events.

The `register` method is called immediately when the plugin is registered. The `boot` method is called right before a request is routed. So if your actions rely on another plugin, you should use the boot method. For example, inside the `boot` method you can extend models:

```php
public function boot()
{
    User::extend(function($model) {
        $model->hasOne['author'] = \Acme\Blog\Models\Author::class;
    });
}
```

Plugins may also supply a file named **init.php** that contains custom initialization logic. Below is some example content.

```php
App::before({
    // Logic when the request starts, after routes are registered
});

App::after({
    // Logic the request has finished, after the response is sent
});
```

## Dependency Definitions

A plugin can depend upon other plugins by defining a `$require` property in the plugin registration file, the property should contain an array of plugin names that are considered requirements. A plugin that depends on the **Acme.User** plugin can declare this requirement in the following way:

```php
namespace Acme\Blog;

class Plugin extends \System\Classes\PluginBase
{
    /**
     * @var array require these plugins
     */
    public $require = ['Acme.User'];

    // ...
}
```

Dependency definitions will affect how the plugin operates and how the update process applies migrations. The installation process will attempt to install any dependencies automatically, however if a plugin is detected in the system without any of its dependencies it will be disabled to prevent system errors.

Dependency definitions can be complex but care should be taken to prevent circular references. The dependency graph should always be directed and a circular dependency is considered a design error.

## Version History

It is good practice for plugins to maintain a change log that documents any changes or improvements in the code. In addition to writing notes about changes, this process has the useful ability to execute [migration and seed files](../database/structure.md) in their correct order.

The change log is stored in a YAML file called `version.yaml` inside the **updates** directory of a plugin, which co-exists with migration and seed files. This example displays a typical plugin updates directory structure:

::: dir
├── plugins
|   └── author
|       └── myplugin
|           ├── `updates`
|           |   ├── `version.yaml`  _← Version File_
|           |   ├── create_tables.php  _← Database Script_
|           |   ├── seed_the_database.php
|           |   └── create_another_table.php
|           └── Plugin.php
:::

### Plugin Dependencies

Updates are applied in a specific order, based on the defined dependencies in the plugin registration file. Plugins that are dependant will not be updated until all their dependencies have been updated first.

```php
namespace Acme\Blog;

class Plugin extends \System\Classes\PluginBase
{
    public $require = ['Acme.User'];
}
```

In the example above the **Acme.Blog** plugin will not be updated until the **Acme.User** plugin has been fully updated.

## Plugin Version File

The **version.yaml** file, called the Plugin Version File, contains the version comments and refers to database scripts in the correct order. Please read the [Database structure](../database/structure.md) article for information about the migration files. This file is required if you're going to submit the plugin to the [Marketplace](https://octobercms.com/help/site/marketplace). Here is an example of a plugin version file.

```yaml
v1.0.1: First version
v1.0.2: Second version
v1.0.3:
    - Update with a migration and seed
    - create_tables.php
    - seed_the_database.php
v2.0.0: Important update
v2.0.1: Latest version
```

::: tip
The `version.yaml` file should always use the first line for a text update that describes the changes and the remaining lines for update scripts. For more verbose updates, consider using a dedicated changelog file.
:::

As you can see above, there should be a key that represents the version number followed by the update message, which is either a string or an array containing update messages. For updates that refer to migration or seeding files, lines that are script file names can be placed in any position. An example of a comment with no associated update files.

```yaml
v1.0.1: A single comment that uses no update scripts.
```

### Important Updates

Sometimes a plugin needs to introduce features that will break websites already using the plugin. To prevent the changes from being deployed automatically, you should increase the **major** segment of the version string (`major.minor.patch`). An example of an important update comment is below.

```yaml
v2.1.0: This is an important update from v1 that contains breaking changes.
```

When tagging the new version `v2` from a version `v1` then the changes are not deployed as part of a regular update. The user must install the plugin again to receive the latest version via Composer.

### Migration and Seed Files

As previously described, updates also define when [migration and seed files](../database/structure.md) should be applied. An update line with a comment and updates:

```yaml
v1.1.1:
    - This update will execute the two scripts below.
    - some_upgrade_file.php
    - some_seeding_file.php
```

The update file name should use *snake_case* while the containing PHP class should use *CamelCase*. For a file named **some_upgrade_file.php** the corresponding class would be `SomeUpgradeFile`.

```php
<?php namespace Acme\Blog\Updates;

use Schema;
use October\Rain\Database\Updates\Migration;

/**
 * some_upgrade_file.php
 */
class SomeUpgradeFile extends Migration
{
    ///
}
```

#### See Also

::: also
* [Database Migrations and Seeding](../database/structure.md)
:::
---
subtitle: Programatically test and harden your business logic.
---
# Unit Testing

Individual plugin test cases can be performed using the `plugin:test` artisan command, followed by the plugin code. For example, the following command will run the tests found in **plugins/acme/demo** directory.

```bash
php artisan plugin:test acme.demo
```

::: tip
If you have `phpunit` installed globally, you can also call this from the plugin directory.
:::

## Creating Plugin Tests

The first step to testing plugins is to create a file called **phpunit.xml** in the base directory of the plugin. Here is an example of a file named **/plugins/acme/blog/phpunit.xml** for the `Acme.Blog` plugin.

```xml
<?xml version="1.0" encoding="UTF-8"?>
<phpunit
    backupGlobals="false"
    backupStaticAttributes="false"
    bootstrap="../../../modules/system/tests/bootstrap.php"
    colors="true"
    convertErrorsToExceptions="true"
    convertNoticesToExceptions="true"
    convertWarningsToExceptions="true"
    processIsolation="false"
    stopOnFailure="false"
>
    <testsuites>
        <testsuite name="Plugin Test Suite">
            <directory>./tests</directory>
            <exclude>./tests/browser</exclude>
        </testsuite>
    </testsuites>
    <php>
        <env name="APP_ENV" value="testing" />
        <env name="CACHE_DRIVER" value="array" />
        <env name="SESSION_DRIVER" value="array" />
        <env name="ACTIVE_THEME" value="test" />
        <env name="CONVERT_LINE_ENDINGS" value="true" />
        <env name="CMS_ROUTE_CACHE" value="true" />
        <env name="CMS_TWIG_CACHE" value="false" />
        <env name="ENABLE_CSRF" value="false" />
        <env name="DB_CONNECTION" value="sqlite" />
        <env name="DB_DATABASE" value=":memory:" />
    </php>
</phpunit>
```

## Creating a Test Class

The `create:test` command generates a test class. The first argument specifies the author and plugin name. The second argument specifies the test class name, which must end in **Test**.

```bash
php artisan create:test Acme.Blog UserTest
```

All tests should be placed in the **tests** directory that is used store the test classes. Class names should use a `Test` suffic and a namespace for the class is optional. The test class should extend the `PluginTestCase` base class and this is a special class that will set up the October CMS database stored in memory, as part of the `setUp` method.

```php
use Acme\Blog\Models\Post;

class PostTest extends PluginTestCase
{
    public function testCreateFirstPost()
    {
        $post = Post::create(['title' => 'Hi!']);
        $this->assertEquals(1, $post->id);
    }
}
```

## Registering and Booting Plugins

In the test environment, the plugin itself and any dependencies of the plugin are registered and booted automatically. This gives finer control over the testing environment and prevents other plugins in the system from interfering with things like event registration. You can disable automatic loading of the current plugin by setting the `autoRegister` property to `false`.

```php
/**
 * @var bool autoRegister feature disabled for this test.
 */
protected $autoRegister = false;
```

You can manually register and boot a plugin with the `loadPlugin` method. In some cases, you will need to migrate the plugin manually as well (see below).

```php
public function setUp(): void
{
    parent::setUp();

    // Runs register() and boot() methods
    $this->loadPlugin('Acme.Blog');
}
```

The following registration methods are available.

Method Name | Purpose
------------- | -------------
**loadAllPlugins()** | Loads all plugins found in the system.
**loadCurrentPlugin()** | Loads the current plugin and its dependencies.
**loadPlugin($code)** | Loads a single plugin using its code, eg: `Acme.Blog`.
**loadPlugins($codes)** | Loads multiple plugins as an array of codes.

## Working with the Database

By default, plugin tests will automatically migrate the database tables for core modules, the current plugin and its dependencies. This is the equivalent of running the following before each test.

```bash
php artisan october:migrate
php artisan plugin:refresh Acme.Blog
[php artisan plugin:refresh <dependency>, ...]
```

You may disable this feature by setting the `autoMigrate` property to false in the test class. This is applicable when the test does not make use of the database.

```php
class PostTest extends PluginTestCase
{
    /**
     * @var bool autoMigrate feature disabled for this test.
     */
    protected $autoMigrate = false;
}
```

You can manually migrate plugins with the `migratePlugin` method when setting up the test. The `migrateModules` method can also be used to make the system tables available.

```php
public function setUp(): void
{
    parent::setUp();

    // Migrate core modules
    $this->migrateModules();

    // Migrate the blog plugin
    $this->migratePlugin('Acme.Blog');
}
```

The following migration methods are available.

Method Name | Purpose
------------- | -------------
**migrateDatabase()** | Migrate the entire database, the same as `october:migrate`.
**migrateModules()** | Migrate only the core modules.
**migrateCurrentPlugin()** | Migrate the current plugin and its dependencies.
**migratePlugin($code)** | Migrates a specific plugin using its code, eg: `Acme.Blog`.

### Changing the Database

By default unit tests use SQLite stored in memory for the plugin testing environment. You can modify this setting in the `phpunit.xml` file. The values here are based on the `/config/database.php` configuration file.

```xml
<env name="DB_CONNECTION" value="sqlite" />
<env name="DB_DATABASE" value=":memory:" />
```
---
subtitle: Create pages that implement various features like forms and lists.
---
# Controllers

The October CMS backend implements an Model-View-Controller (MVC) pattern. This article describes how to develop backend controllers and how to configure controller behaviors.

Each controller is represented with a PHP script which resides in the the **/controllers** subdirectory of a Plugin directory. Controller views are `.php` files that reside in the controller view directory. The controller view directory name matches the controller class name written in lowercase. The view directory can also contain controller configuration files. An example of a controller directory structure:

::: dir
├── plugins
|   └── acme
|       └── blog
|           ├── `controllers`
|           |   ├── users  _← View Directory_
|           |   |   ├── config_form.yaml  _← Config File_
|           |   |   ├── _partial.php  _← Partial File_
|           |   |   └── index.php  _← View File_
|           |   └── Users.php  _← Controller Class_
|           └── Plugin.php
:::

:::tip
For a practical example of using backend controllers, check out the [Beyond Behaviors tutorial series](https://octobercms.com/support/article/ob-19).
:::

### Class Definition

The `create:controller` command generates a controller, configuration and view files. The first argument specifies the author and plugin name. The second argument specifies the controller class name.

```bash
php artisan create:controller Acme.Blog Posts
```

Controller classes must extend the `Backend\Classes\Controller` class. As any other plugin class, controllers should belong to the [plugin namespace](../system/plugins.md). The most basic representation of a Controller used inside a Plugin looks like this.

```php
namespace Acme\Blog\Controllers;

class Posts extends \Backend\Classes\Controller
{
    public function index()    // ← Action method
    {

    }
}
```

Usually each controller implements functionality for working with a single type of data - like blog posts or categories. All backend behaviors described below assume this convention.

### Controller Properties

The backend controller base class defines a number of properties that allow to configure the page appearance and manage the page security:

Property | Description
------------- | -------------
**$fatalError** | allows to store a fatal exception generated in an action method in order to display it in the view.
**$user** | contains a reference to the the backend user object.
**$suppressView** | allows to prevent the view display. Can be updated in the action method or in the controller constructor.
**$params** | an array of the routed parameters.
**$action** | a name of the action method being executed in the current request.
**$publicActions** | defines an array of actions available without the backend user authentication. Can be overridden in the class definition.
**$requiredPermissions** | permissions required to view this page. Can be set in the class definition or in the controller constructor. See [users & permissions](../backend/users.md) for details.
**$pageTitle** | sets the page title. Can be set in the action method.
**$bodyClass** | body class property used for customizing the layout. Can be set in the controller constructor or action method.
**$guarded** | controller specific methods which cannot be called as actions. Can be extended in the controller constructor.
**$layout** | specify a custom layout for the [controller views](../system/views.md).

## Initialization Logic

Controllers may perform initialization logic in the native `__construct` method.

::: warning
Logic inside the constructor is not protected and should not handle any sensitive logic.
```php
public function __construct()
{
    parent::__construct();
}
```
:::

The `beforeDisplay` method is called after the permission checks happen and most logic should be placed here. This includes initializing widgets and other shared components.

```php
public function beforeDisplay()
{
    // Initialize widgets, handle file uploads, etc.
}
```

## Actions, Views and Routing

Public controller methods, called **actions** are coupled to **view files** which represent the page corresponding the action. Backend view files use PHP syntax. Example of the **index.php** view file contents, corresponding to the `index` action method.

```html
<h1>Hello World</h1>
```

URL of this page is made up of the author name, plugin name, controller name and action name.

```text
admin/[author name]/[plugin name]/[controller name]/[action name]
```

For example, the class definition used at the beginning of this article is accessible via the following URL.

```text
https://example.tld/admin/acme/blog/users/index
```

If a [plugin is registered](./plugins.md) with a **hint** in the `pluginDetails` method, a shorter URL structure becomes available, which is useful for masking the author name in URLs.

```text
admin/[plugin hint]/[controller name]/[action name]
```

## Passing Data to Views

Use the controller's `$vars` property to pass any data directly to your view:

```php
$this->vars['myVariable'] = 'value';
```

The variables passed with the `$vars` property can now be accessed directly in your view:

```php
<p>The variable value is <?= $myVariable ?></p>
```

## Setting the Navigation Context

Plugins can register the backend navigation menus and submenus in the [plugin registration file](../backend/navigation.md). The navigation context determines what backend menu and submenu are active for the current backend page. You can set the navigation context with the `BackendMenu` class:

```php
BackendMenu::setContext('Acme.Blog', 'blog', 'categories');
```

The first parameter specifies the author and plugin names. The second parameter sets the menu code. The optional third parameter specifies the submenu code. Usually you call the `BackendMenu::setContext` in the controller constructor.

```php
namespace Acme\Blog\Controllers;

class Categories extends \Backend\Classes\Controller {

public function __construct()
{
    parent::__construct();

    BackendMenu::setContext('Acme.Blog', 'blog', 'categories');
}
```

You can set the title of the backend page with the `$pageTitle` property of the controller class (note that the form and list behaviors can do it for you):

```php
$this->pageTitle = 'Blog Categories';
```

## Overriding a Response

You can override responses in your backend controllers as a mechanism for making changes to the response of a HTTP request. For example, you may wish to specify a HTTP header for certain actions in your controller, or redirect users if they don't meet certain criteria.

Overriding a response is useful particularly when extending other controllers. However you may find it useful to call these methods locally.

```php
\Author\Plugin\Controllers\SomeController::extend(function($controller) {
    $controller->setResponseHeader('Test-Header', 'Test');
});
```

If you want to check the routed action or parameters, you can find these available in the controller `getAction` and `getParams` methods.

```php
Author\Plugin\Controllers\SomeController::extend(function($controller) {
    if ($controller->getAction() === 'index') {
        // Only do it for the index action
    }

    if ($controller->getParams()[0] ?? null) {
        // Only if first parameter exists
    }
});
```

To add a header to your response, you may call the `setResponseHeader` method.

```php
$this->setResponseHeader('Test-Header', 'Test');
```

To change the status code of a response, use the `setStatusCode` method.

```php
$this->setStatusCode(404);
```

To override the entire response, call the `setResponse` method, this will force the response regardless of what happens on the page's life cycle.

```php
$this->setResponse('Page Not Found');
```

You may also pass a `Response` object to this method.

```php
$this->setResponse(Response::make(...));
```

View the [Views & Responses article](../services/response-view.md) for more information on building responses.

#### See Also

::: also
* [Views and Responses](../services/response-view.md)
:::
---
subtitle: Extending Twig with custom filters and functions.
---
# Building Twig Tags

Custom Twig filters and functions can be registered in the CMS with the `registerMarkupTags` method of the [plugin registration class](../extend/extending.md). This article describes how to register your own Twig filters and functions that can be used in the CMS and mail templates.

```php
public function registerMarkupTags()
{
    return [
        'filters' => [
            // ...Filters defined here
        ],
        'functions' => [
            // ...Functions defined here
        ]
    ];
}
```

## Registering a Filter

The `filters` key in the registration array may be used for Twig filters. For example, the `|plural` filter can be mapped to the global PHP function `str_plural()` with the following value.

```php
'filters' => [
    'plural' => 'str_plural'
]
```

You may also pass a local method. For example, `|uppercase` can be mapped to the `$this->makeAllCaps()` method.

```php
'filters' => [
    'uppercase' => [$this, 'makeTextAllCaps']
]
```

This becomes available in Twig as the following.

```twig
{{ 'my text'|uppercase }}
```

## Registering a Function

Just like filters, the `functions` key can be used to create Twig function. For example, the function could map to a static method call of `Form::open()` instead.

```php
'functions' => [
    'form_open' => [Form::class, 'open']
]
```

Static calls also support wildcard definitions. In this example, a function call of `url_foobar()` will translate to a method call of `Url::foobar` and so on.

```php
'functions' => [
    'url_*' => [Url::class, '*'],
]
```

Passing a closure is also allowed for either definition.

```php
'functions' => [
    'hello_world' => function() { return 'Hello World!'; }
]
```

This is now available in Twig as the following.

```twig
{{ hello_world() }}
```
# Storage

October CMS provides a powerful filesystem abstraction thanks to Laravel and the wonderful [Flysystem](https://github.com/thephpleague/flysystem) PHP package. The Flysystem integration provides simple to use drivers for working with local filesystems and Amazon S3. Even better, it's amazingly simple to switch between these storage options as the API remains the same for each system.

## Configuration

The filesystem configuration file is located at `config/filesystems.php`. Within this file you may configure all of your "disks". Each disk represents a particular storage driver and storage location. Example configurations for each supported driver is included in the configuration file. So, simply modify the configuration to reflect your storage preferences and credentials.

Of course, you may configure as many disks as you like, and may even have multiple disks that use the same driver.

#### The Local Driver

When using the `local` driver, note that all file operations are relative to the `root` directory defined in your configuration file. By default, this value is set to the `storage/app` directory. Therefore, the following method would store a file in `storage/app/file.txt`:

```php
Storage::disk('local')->put('file.txt', 'Contents');
```

#### Other Driver Prerequisites

Before using the S3 driver, you will need to install the Flysystem S3 package via the Composer package manager.

```bash
composer require league/flysystem-aws-s3-v3 "^3.0"
```

The S3 driver configuration information is located in your `config/filesystems.php` configuration file. This file contains an example configuration array for an S3 driver. You are free to modify this array with your own S3 configuration and credentials.

## Basic Usage

### Obtaining Disk Instances

The `Storage` facade may be used to interact with any of your configured disks. For example, you may use the `put` method on the facade to store an avatar on the default disk. If you call methods on the `Storage` facade without first calling the `disk` method, the method call will automatically be passed to the default disk:

```php
$user = User::find($id);

Storage::put(
    'avatars/'.$user->id,
    file_get_contents(Request::file('avatar')->getRealPath())
);
```

When using multiple disks, you may access a particular disk using the `disk` method on the `Storage` facade. Of course, you may continue to chain methods to execute methods on the disk:

```php
$disk = Storage::disk('s3');

$contents = Storage::disk('local')->get('file.jpg')
```

### Retrieving Files

The `get` method may be used to retrieve the contents of a given file. The raw string contents of the file will be returned by the method:

```php
$contents = Storage::get('file.jpg');
```

The `exists` method may be used to determine if a given file exists on the disk:

```php
$exists = Storage::disk('s3')->exists('file.jpg');
```

#### File Meta Information

The `size` method may be used to get the size of the file in bytes:

```php
$size = Storage::size('file1.jpg');
```

The `lastModified` method returns the UNIX timestamp of the last time the file was modified:

```php
$time = Storage::lastModified('file1.jpg');
```

### Storing Files

The `put` method may be used to store a file on disk. You may also pass a PHP `resource` to the `put` method, which will use Flysystem's underlying stream support. Using streams is greatly recommended when dealing with large files:

```php
Storage::put('file.jpg', $contents);

Storage::put('file.jpg', $resource);
```

The `copy` method may be used to copy an existing file to a new location on the disk:

```php
Storage::copy('old/file1.jpg', 'new/file1.jpg');
```

The `move` method may be used to move an existing file to a new location:

```php
Storage::move('old/file1.jpg', 'new/file1.jpg');
```

#### Prepending / Appending to Files

The `prepend` and `append` methods allow you to easily insert content at the beginning or end of a file:

```php
Storage::prepend('file.log', 'Prepended Text');

Storage::append('file.log', 'Appended Text');
```

### Deleting Files

The `delete` method accepts a single filename or an array of files to remove from the disk:

```php
Storage::delete('file.jpg');

Storage::delete(['file1.jpg', 'file2.jpg']);
```

### Directories

#### Get All Files Within a Directory

The `files` method returns an array of all of the files in a given directory. If you would like to retrieve a list of all files within a given directory including all sub-directories, you may use the `allFiles` method:

```php
$files = Storage::files($directory);

$files = Storage::allFiles($directory);
```

#### Get All Directories Within a Directory

The `directories` method returns an array of all the directories within a given directory. Additionally, you may use the `allDirectories` method to get a list of all directories within a given directory and all of its sub-directories:

```php
$directories = Storage::directories($directory);

// Recursive...
$directories = Storage::allDirectories($directory);
```

#### Create a Directory

The `makeDirectory` method will create the given directory, including any needed sub-directories:

```php
Storage::makeDirectory($directory);
```

#### Delete a Directory

Finally, the `deleteDirectory` may be used to remove a directory, including all of its files, from the disk:

```php
Storage::deleteDirectory($directory);
```
# HTTP Client

The `Http` class provides features used for opening connections via the HTTP protocol. You can use it to make outgoing connections to other applications and services. This client is supplied by the Laravel framework and you can learn about all the possible features in the [Laravel documentation article](https://laravel.com/docs/10.x/http-client).

## Basic Usage

To make requests, the PHP method will assocaite to the HTTP method, which supports `get`, `post`, `patch`, `put`, `options` and `delete`. The following is an example of a basic `GET` request to a URL. The returned result will contain a response object.

```php
$response = Http::get('https://octobercms.com');
```

You can quickly and easily inspect the contents of a request by prefixing the method call with `dd()`. This will dump the contents of the request and terminate the execution.

```php
Http::dd()->get('https://octobercms.com');
```

## Handling the Response

The response object will provide methods that can be used to inspect the response.

```php
$result = Http::post('https://octobercms.com');
echo $result->body();                  // Outputs: <html><head><title>...
echo $result->status();                // Outputs: 200
echo $result->header('Content-Type');  // Outputs: text/html; charset=UTF-8
```

The object supports the following method calls.

Method Name | Return Type | Purpose
------------- | ------------- | -------------
**body()** | `string` | Get the body of the response.
**json($key)** | `array|mixed` | Get the JSON decoded body of the response as an array or scalar value.
**object()** | `object` | Get the JSON decoded body of the response as an object.
**collect($key)** | [Collection](./collection.md) | Get the JSON decoded body of the response as a collection.
**status()** | `int` | Get the status code of the response.
**ok()** | `bool` | Determine if the response code was "OK".
**successful()** | `bool` | Determine if the request was successful.
**redirect()** | `bool` | Determine if the response was a redirect.
**failed()** | `bool` | Determine if the response indicates a client or server error occurred.
**serverError()** | `bool` | Determine if the response indicates a server error occurred.
**clientError()** | `bool` | Determine if the response indicates a client error occurred.
**header($header)** | `string` | Get a header from the response.
**headers()** | `array` | Get the headers from the response.

## Sending Request Data

The `post`, `put` and `patch` methods support sending additional data with the request. By default the data is sent using `application/json` as the content type.

```php
Http::post('https://octobercms.com', [
    'name' => 'Jeff'
]);
```

To send the data using the `application/x-www-form-urlencoded` content type instead, call the `asForm` method before making the request.

```php
Http::asForm()->post('https://octobercms.com', [
    'name' => 'Jeff'
]);
```

Passing data when using a `get` request, the array will be included with the query string in the URL.

```php
Http::get('https://octobercms.com', [
    'page' => '1'
]);
```

The `withHeaders` method can be used to include custom headers with the request.

```php
Http::withHeaders([
    'Rest-Key' => '...'
])->post('https://octobercms.com', [
    'name' => 'Jeff'
]);
```

The `withBasicAuth` method is used to pass authentication credentials with the request.

```php
Http::withBasicAuth('user', 'password')->post('https://octobercms.com', [
    'name' => 'Jeff'
]);
```

## Error Handling

The HTTP client treats all responses as valid, including errors, so to determine if an error occured you should check with the `successful`, `failed`, `clientError`, or `serverError` methods.

```php
// Status code is >= 200 and < 300
$response->successful();

// Status code is >= 400
$response->failed();

// Response has a 400 level status code
$response->clientError();

// Response has a 500 level status code
$response->serverError();
```

You may also use the `onError` method to execute a callback if a client or server error occurs.

```php
$response->onError(callable $callback);
```

#### See Also

::: also
* [Laravel HTTP Client](https://laravel.com/docs/10.x/http-client)
:::
# Resizer

## Introduction

October CMS ships with an image resizer that lets you change the shape and size of supported images. To resize an image, use the `open` method on the `Resizer` facade to target a file path.

```php
$image = Resizer::open('path/to/image.jpg');
```

You may also pass an uploaded file from the [page request input](./request-input.md).

```php
$image = Resizer::open(Input::file('field_name'));
```

To resize the image, call the `resize` method on the object to perform the resize. The first argument is the image width, the second argument is the image height and the third argument is an array of resize parameters.

```php
$image->resize(800, 600, ['mode' => 'crop']);
```

The width and height arguments are also optional, for example, to use the existing width and only adjust the height, pass the second argument as `null`. This value is then calculated using original image ratio (automatic proportional scaling) based on the `mode` option.

```php
$image->resize(800, null, [...]);
```

Finally, use the `save` method to save the resized image to a new location.

```php
$image->save('path/to/new/file.jpg');
```

::: tip
There is also a `|resize` [markup filter](../../markup/filter/resize.md) that can be used for resizing images in your themes.
:::

### Resize Parameters

The following elements are supported in the options array are supported:

Key | Description | Default | Options
--- | --- | --- | ---
`mode` | How the image should be fitted to dimensions | `auto` | `exact`, `portrait`, `landscape`, `auto`, `fit`, or `crop`
`offset` | Offset the crop of the resized image | `[0,0]` | [left, top]
`quality` | Quality of the resized image | `90` | `0-100`
`sharpen` | Amount to sharpen the image | `0` | `0-100`

### Available Modes

The `mode` option allows you to specify how the image should be resized. The available modes are as follows:

Mode | Description
--- | ---
`auto` | Automatically choose between `portrait` and `landscape` based on the image's orientation
`exact` | Resize to the exact dimensions given, without preserving aspect ratio
`portrait` | Resize to the given height and adapt the width to preserve aspect ratio
`landscape` | Resize to the given width and adapt the height to preserve aspect ratio
`crop` | Crop to the given dimensions after fitting as much of the image as possible inside those
`fit` | Fit the image inside the given maximal dimensions, keeping the aspect ratio
# Collection

The `October\Rain\Support\Collection` class provides a fluent, convenient wrapper for working with arrays of data. For example, check out the following code. We'll create a new collection instance from the array, run the `strtoupper` function on each element, and then remove all empty elements.

```php
$collection = new October\Rain\Support\Collection(['stewie', 'brian', null]);

$collection = $collection
    ->map(function ($name) {
        return strtoupper($name);
    })
    ->reject(function ($name) {
        return empty($name);
    })
;
```

The `Collection` class allows you to chain its methods to perform fluent mapping and reducing of the underlying array. In general every `Collection` method returns an entirely new `Collection` instance.

## Creating Collections

As described above, passing an array to the constructor of the `October\Rain\Support\Collection` class will return a new instance for the given array. So, creating a collection is as simple as:

```php
$collection = new October\Rain\Support\Collection([1, 2, 3]);
```

By default, collections of [database models](../database/model.md) are always returned as `Collection` instances; however, feel free to use the `Collection` class wherever it is convenient for your application.

## Available Methods

For the remainder of this documentation, we'll discuss each method available on the `Collection` class. Remember, all of these methods may be chained for fluently manipulating the underlying array. Furthermore, almost every method returns a new `Collection` instance, allowing you to preserve the original copy of the collection when necessary.

You may select any method from this table to see an example of its usage:

<div class="content-list-p" markdown="1">

[all](#method-all)
[average](#method-average)
[avg](#method-avg)
[chunk](#method-chunk)
[collapse](#method-collapse)
[combine](#method-combine)
[concat](#method-concat)
[contains](#method-contains)
[containsStrict](#method-containsstrict)
[count](#method-count)
[countBy](#method-countBy)
[crossJoin](#method-crossjoin)
[dd](#method-dd)
[diff](#method-diff)
[diffAssoc](#method-diffassoc)
[diffKeys](#method-diffkeys)
[dump](#method-dump)
[duplicates](#method-duplicates)
[duplicatesStrict](#method-duplicatesstrict)
[each](#method-each)
[filter](#method-filter)
[first](#method-first)
[firstWhere](#method-first-where)
[flatMap](#method-flatmap)
[flatten](#method-flatten)
[flip](#method-flip)
[forget](#method-forget)
[forPage](#method-forpage)
[get](#method-get)
[groupBy](#method-groupby)
[has](#method-has)
[implode](#method-implode)
[intersect](#method-intersect)
[intersectByKeys](#method-intersectbykeys)
[isEmpty](#method-isempty)
[isNotEmpty](#method-isnotempty)
[join](#method-join)
[keyBy](#method-keyby)
[keys](#method-keys)
[last](#method-last)
[map](#method-map)
[mapInto](#method-mapinto)
[mapSpread](#method-mapspread)
[mapToGroups](#method-maptogroups)
[mapWithKeys](#method-mapwithkeys)
[max](#method-max)
[median](#method-median)
[merge](#method-merge)
[mergeRecursive](#method-mergerecursive)
[min](#method-min)
[mode](#method-mode)
[nth](#method-nth)
[only](#method-only)
[pad](#method-pad)
[partition](#method-partition)
[pipe](#method-pipe)
[pluck](#method-pluck)
[pop](#method-pop)
[prepend](#method-prepend)
[pull](#method-pull)
[push](#method-push)
[put](#method-put)
[random](#method-random)
[reduce](#method-reduce)
[reject](#method-reject)
[replace](#method-replace)
[replaceRecursive](#method-replacerecursive)
[reverse](#method-reverse)
[search](#method-search)
[shift](#method-shift)
[shuffle](#method-shuffle)
[skip](#method-skip)
[slice](#method-slice)
[some](#method-some)
[sort](#method-sort)
[sortBy](#method-sortby)
[sortByDesc](#method-sortbydesc)
[sortKeys](#method-sortkeys)
[sortKeysDesc](#method-sortkeysdesc)
[splice](#method-splice)
[split](#method-split)
[sum](#method-sum)
[take](#method-take)
[tap](#method-tap)
[times](#method-times)
[toArray](#method-toarray)
[toJson](#method-tojson)
[transform](#method-transform)
[union](#method-union)
[unique](#method-unique)
[uniqueStrict](#method-uniquestrict)
[unless](#method-unless)
[unlessEmpty](#method-unlessempty)
[unlessNotEmpty](#method-unlessnotempty)
[unwrap](#method-unwrap)
[values](#method-values)
[when](#method-when)
[whenEmpty](#method-whenempty)
[whenNotEmpty](#method-whennotempty)
[where](#method-where)
[whereStrict](#method-wherestrict)
[whereBetween](#method-wherebetween)
[whereIn](#method-wherein)
[whereInStrict](#method-whereinstrict)
[whereInstanceOf](#method-whereinstanceof)
[whereNotBetween](#method-wherenotbetween)
[whereNotIn](#method-wherenotin)
[whereNotInStrict](#method-wherenotinstrict)
[whereNotNull](#method-wherenotnull)
[whereNull](#method-wherenull)
[wrap](#method-wrap)
[zip](#method-zip)

</div>

## Method Listing

<a name="method-all"></a>
#### `all()`

The `all` method simply returns the underlying array represented by the collection:

```php
$collection = new Collection([1, 2, 3]);

$collection->all();

// [1, 2, 3]
```

<a name="method-average"></a>
#### `average()`

Alias for the [`avg`](#method-avg) method.

<a name="method-avg"></a>
#### `avg()`

The `avg` method returns the [average value](https://en.wikipedia.org/wiki/Average) of a given key:

```php
$average = new Collection([['foo' => 10], ['foo' => 10], ['foo' => 20], ['foo' => 40]])->avg('foo');

// 20

$average = new Collection([1, 1, 2, 4])->avg();

// 2
```

<a name="method-chunk"></a>
#### `chunk()`

The `chunk` method breaks the collection into multiple, smaller collections of a given size:

```php
$collection = new Collection([1, 2, 3, 4, 5, 6, 7]);

$chunks = $collection->chunk(4);

$chunks->toArray();

// [[1, 2, 3, 4], [5, 6, 7]]
```

This method is especially useful in [CMS pages](../cms/pages.md) when working with a grid system, such as [Bootstrap](https://getbootstrap.tld/css/#grid). Imagine you have a collection of models you want to display in a grid:

```twig
{% for chunk in products.chunk(3) %}
    <div class="row">
        {% for product in chunk %}
            <div class="col-4">{{ product.name }}</div>
        {% endfor %}
    </div>
{% endfor %}
```

<a name="method-collapse"></a>
#### `collapse()`

The `collapse` method collapses a collection of arrays into a flat collection:

```php
$collection = new Collection([[1, 2, 3], [4, 5, 6], [7, 8, 9]]);

$collapsed = $collection->collapse();

$collapsed->all();

// [1, 2, 3, 4, 5, 6, 7, 8, 9]
```

<a name="method-combine"></a>
#### `combine()`

The `combine` method combines the values of the collection, as keys, with the values of another array or collection.

```php
$collection = new Collection(['name', 'age']);

$combined = $collection->combine(['George', 29]);

$combined->all();

// ['name' => 'George', 'age' => 29]
```

<a name="method-concat"></a>
#### `concat()`

The `concat` method appends the given `array` or collection values onto the end of the collection:

```php
$collection = new Collection(['John Doe']);

$concatenated = $collection->concat(['Jane Doe'])->concat(['name' => 'Johnny Doe']);

$concatenated->all();

// ['John Doe', 'Jane Doe', 'Johnny Doe']
```

<a name="method-contains"></a>
#### `contains()`

The `contains` method determines whether the collection contains a given item:

```php
$collection = new Collection(['name' => 'Desk', 'price' => 100]);

$collection->contains('Desk');

// true

$collection->contains('New York');

// false
```

You may also pass a key / value pair to the `contains` method, which will determine if the given pair exists in the collection:

```php
$collection = new Collection([
    ['product' => 'Desk', 'price' => 200],
    ['product' => 'Chair', 'price' => 100],
]);

$collection->contains('product', 'Bookcase');

// false
```

Finally, you may also pass a callback to the `contains` method to perform your own truth test:

```php
$collection = new Collection([1, 2, 3, 4, 5]);

$collection->contains(function ($value, $key) {
    return $value > 5;
});

// false
```

The `contains` method uses "loose" comparisons when checking item values, meaning a string with an integer value will be considered equal to an integer of the same value. Use the [`containsStrict`](#method-containsstrict) method to filter using "strict" comparisons.

<a name="method-containsstrict"></a>
#### `containsStrict()`

This method has the same signature as the [`contains`](#method-contains) method; however, all values are compared using "strict" comparisons.

<a name="method-count"></a>
#### `count()`

The `count` method returns the total number of items in the collection:

```php
$collection = new Collection([1, 2, 3, 4]);

$collection->count();

// 4
```

<a name="method-countBy"></a>
#### `countBy()`

The `countBy` method counts the occurrences of values in the collection. By default, the method counts the occurrences of every element:

```php
$collection = new Collection([1, 2, 2, 2, 3]);

$counted = $collection->countBy();

$counted->all();

// [1 => 1, 2 => 3, 3 => 1]
```

However, you pass a callback to the `countBy` method to count all items by a custom value:

```php
$collection = new Collection(['alice@gmail.tld', 'bob@yahoo.tld', 'carlos@gmail.tld']);

$counted = $collection->countBy(function ($email) {
    return substr(strrchr($email, "@"), 1);
});

$counted->all();

// ['gmail.tld' => 2, 'yahoo.tld' => 1]
```

<a name="method-crossjoin"></a>
#### `crossJoin()`

The `crossJoin` method cross joins the collection's values among the given arrays or collections, returning a Cartesian product with all possible permutations:

```php
$collection = new Collection([1, 2]);

$matrix = $collection->crossJoin(['a', 'b']);

$matrix->all();

/*
    [
        [1, 'a'],
        [1, 'b'],
        [2, 'a'],
        [2, 'b'],
    ]
*/

$collection = new Collection([1, 2]);

$matrix = $collection->crossJoin(['a', 'b'], ['I', 'II']);

$matrix->all();

/*
    [
        [1, 'a', 'I'],
        [1, 'a', 'II'],
        [1, 'b', 'I'],
        [1, 'b', 'II'],
        [2, 'a', 'I'],
        [2, 'a', 'II'],
        [2, 'b', 'I'],
        [2, 'b', 'II'],
    ]
*/
```

<a name="method-dd"></a>
#### `dd()`

The `dd` method dumps the collection's items and ends execution of the script:

```php
$collection = new Collection(['John Doe', 'Jane Doe']);

$collection->dd();

/*
    Collection {
        #items: array:2 [
            0 => "John Doe"
            1 => "Jane Doe"
        ]
    }
*/
```

If you do not want to stop executing the script, use the [`dump`](#method-dump) method instead.

<a name="method-diff"></a>
#### `diff()`

The `diff` method compares the collection against another collection or a plain PHP `array`:

```php
$collection = new Collection([1, 2, 3, 4, 5]);

$diff = $collection->diff([2, 4, 6, 8]);

$diff->all();

// [1, 3, 5]
```

<a name="method-diffassoc"></a>
#### `diffAssoc()`

The `diffAssoc` method compares the collection against another collection or a plain PHP `array` based on its keys and values. This method will return the key / value pairs in the original collection that are not present in the given collection:

```php
$collection = new Collection([
    'color' => 'orange',
    'type' => 'fruit',
    'remain' => 6
]);

$diff = $collection->diffAssoc([
    'color' => 'yellow',
    'type' => 'fruit',
    'remain' => 3,
    'used' => 6,
]);

$diff->all();

// ['color' => 'orange', 'remain' => 6]
```

<a name="method-diffkeys"></a>
#### `diffKeys()`

The `diffKeys` method compares the collection against another collection or a plain PHP `array` based on its keys. This method will return the key / value pairs in the original collection that are not present in the given collection:

```php
$collection = new Collection([
    'one' => 10,
    'two' => 20,
    'three' => 30,
    'four' => 40,
    'five' => 50,
]);

$diff = $collection->diffKeys([
    'two' => 2,
    'four' => 4,
    'six' => 6,
    'eight' => 8,
]);

$diff->all();

// ['one' => 10, 'three' => 30, 'five' => 50]
```

<a name="method-dump"></a>
#### `dump()`

The `dump` method dumps the collection's items:

```php
$collection = new Collection(['John Doe', 'Jane Doe']);

$collection->dump();

/*
    Collection {
        #items: array:2 [
            0 => "John Doe"
            1 => "Jane Doe"
        ]
    }
*/
```

If you want to stop executing the script after dumping the collection, use the [`dd`](#method-dd) method instead.

<a name="method-duplicates"></a>
#### `duplicates()`

The `duplicates` method retrieves and returns duplicate values from the collection:

```php
$collection = new Collection(['a', 'b', 'a', 'c', 'b']);

$collection->duplicates();

// [2 => 'a', 4 => 'b']
```

If the collection contains arrays or objects, you can pass the key of the attributes that you wish to check for duplicate values:

```php
$employees = new Collection([
    ['email' => 'samantha@example.tld', 'position' => 'Developer'],
    ['email' => 'john@example.tld', 'position' => 'Designer'],
    ['email' => 'elaine@example.tld', 'position' => 'Developer'],
])

$employees->duplicates('position');

// [2 => 'Developer']
```

<a name="method-duplicatesstrict"></a>
#### `duplicatesStrict()`

This method has the same signature as the [`duplicates`](#method-duplicates) method; however, all values are compared using "strict" comparisons.

<a name="method-each"></a>
#### `each()`

The `each` method iterates over the items in the collection and passes each item to a callback:

```php
$collection->each(function ($item, $key) {
    //
});
```

If you would like to stop iterating through the items, you may return `false` from your callback:

```php
$collection->each(function ($item, $key) {
    if (/* some condition */) {
        return false;
    }
});
```

<a name="method-every"></a>
#### `every()`

The `every` method creates a new collection consisting of every n-th element:

```php
$collection = new Collection(['a', 'b', 'c', 'd', 'e', 'f']);

$collection->every(4);

// ['a', 'e']
```

You may optionally pass offset as the second argument:

```php
$collection->every(4, 1);

// ['b', 'f']
```

<a name="method-filter"></a>
#### `filter()`

The `filter` method filters the collection by a given callback, keeping only those items that pass a given truth test:

```php
$collection = new Collection([1, 2, 3, 4]);

$filtered = $collection->filter(function ($item) {
    return $item > 2;
});

$filtered->all();

// [3, 4]
```

For the inverse of `filter`, see the [reject](#method-reject) method.

<a name="method-first"></a>
#### `first()`

The `first` method returns the first element in the collection that passes a given truth test:

```php
new Collection([1, 2, 3, 4])->first(function ($value, $key) {
    return $value > 2;
});

// 3
```

You may also call the `first` method with no arguments to get the first element in the collection. If the collection is empty, `null` is returned:

```php
new Collection([1, 2, 3, 4])->first();

// 1
```

<a name="method-first-where"></a>
#### `firstWhere()`

The `firstWhere` method returns the first element in the collection with the given key / value pair:

```php
$collection = new Collection([
    ['name' => 'Regena', 'age' => null],
    ['name' => 'Linda', 'age' => 14],
    ['name' => 'Diego', 'age' => 23],
    ['name' => 'Linda', 'age' => 84],
]);

$collection->firstWhere('name', 'Linda');

// ['name' => 'Linda', 'age' => 14]
```

You may also call the `firstWhere` method with an operator:

```php
$collection->firstWhere('age', '>=', 18);

// ['name' => 'Diego', 'age' => 23]
```

Like the [where](#method-where) method, you may pass one argument to the `firstWhere` method. In this scenario, the `firstWhere` method will return the first item where the given item key's value is "truthy":

```php
$collection->firstWhere('age');

// ['name' => 'Linda', 'age' => 14]
```

<a name="method-flatmap"></a>
#### `flatMap()`

The `flatMap` method iterates through the collection and passes each value to the given callback. The callback is free to modify the item and return it, thus forming a new collection of modified items. Then, the array is flattened by a level:

```php
$collection = new Collection([
    ['name' => 'Sally'],
    ['school' => 'Harvard'],
    ['age' => 28]
]);

$flattened = $collection->flatMap(function ($values) {
    return array_map('strtoupper', $values);
});

$flattened->all();

// ['name' => 'SALLY', 'school' => 'HARVARD', 'age' => '28'];
```

<a name="method-flatten"></a>
#### `flatten()`

The `flatten` method flattens a multi-dimensional collection into a single dimension:

```php
$collection = new Collection(['name' => 'peter', 'languages' => ['php', 'javascript']]);

$flattened = $collection->flatten();

$flattened->all();

// ['peter', 'php', 'javascript'];
```

<a name="method-flip"></a>
#### `flip()`

The `flip` method swaps the collection's keys with their corresponding values:

```php
$collection = new Collection(['name' => 'peter', 'platform' => 'october']);

$flipped = $collection->flip();

$flipped->all();

// ['peter' => 'name', 'october' => 'platform']
```

<a name="method-forget"></a>
#### `forget()`

The `forget` method removes an item from the collection by its key:

```php
$collection = new Collection(['name' => 'peter', 'platform' => 'october']);

$collection->forget('name');

$collection->all();

// ['platform' => 'october']
```

> **Note**: Unlike most other collection methods, `forget` does not return a new modified collection; it modifies the collection it is called on.

<a name="method-forpage"></a>
#### `forPage()`

The `forPage` method returns a new collection containing the items that would be present on a given page number:

```php
$collection = new Collection([1, 2, 3, 4, 5, 6, 7, 8, 9])->forPage(2, 3);

$collection->all();

// [4, 5, 6]
```

The method requires the page number and the number of items to show per page, respectively.

<a name="method-get"></a>
#### `get()`

The `get` method returns the item at a given key. If the key does not exist, `null` is returned:

```php
$collection = new Collection(['name' => 'peter', 'platform' => 'october']);

$value = $collection->get('name');

// peter
```

You may optionally pass a default value as the second argument:

```php
$collection = new Collection(['name' => 'peter', 'platform' => 'october']);

$value = $collection->get('foo', 'default-value');

// default-value
```

You may even pass a callback as the default value. The result of the callback will be returned if the specified key does not exist:

```php
$collection->get('email', function () {
    return 'default-value';
});

// default-value
```

<a name="method-groupby"></a>
#### `groupBy()`

The `groupBy` method groups the collection's items by a given key:

```php
$collection = new Collection([
    ['account_id' => 'account-x10', 'product' => 'Bookcase'],
    ['account_id' => 'account-x10', 'product' => 'Chair'],
    ['account_id' => 'account-x11', 'product' => 'Desk'],
]);

$grouped = $collection->groupBy('account_id');

$grouped->toArray();

/*
    [
        'account-x10' => [
            ['account_id' => 'account-x10', 'product' => 'Bookcase'],
            ['account_id' => 'account-x10', 'product' => 'Chair'],
        ],
        'account-x11' => [
            ['account_id' => 'account-x11', 'product' => 'Desk'],
        ],
    ]
*/
```

In addition to passing a string `key`, you may also pass a callback. The callback should return the value you wish to key the group by:

```php
$grouped = $collection->groupBy(function ($item, $key) {
    return substr($item['account_id'], -3);
});

$grouped->toArray();

/*
    [
        'x10' => [
            ['account_id' => 'account-x10', 'product' => 'Bookcase'],
            ['account_id' => 'account-x10', 'product' => 'Chair'],
        ],
        'x11' => [
            ['account_id' => 'account-x11', 'product' => 'Desk'],
        ],
    ]
*/
```

<a name="method-has"></a>
#### `has()`

The `has` method determines if a given key exists in the collection:

```php
$collection = new Collection(['account_id' => 1, 'product' => 'Desk']);

$collection->has('email');

// false
```

<a name="method-implode"></a>
#### `implode()`

The `implode` method joins the items in a collection. Its arguments depend on the type of items in the collection.

If the collection contains arrays or objects, you should pass the key of the attributes you wish to join, and the "glue" string you wish to place between the values:

```php
$collection = new Collection([
    ['account_id' => 1, 'product' => 'Chair'],
    ['account_id' => 2, 'product' => 'Desk'],
]);

$collection->implode('product', ', ');

// Chair, Desk
```

If the collection contains simple strings or numeric values, simply pass the "glue" as the only argument to the method:

```php
new Collection([1, 2, 3, 4, 5])->implode('-');

// '1-2-3-4-5'
```

<a name="method-intersect"></a>
#### `intersect()`

The `intersect` method removes any values that are not present in the given `array` or collection:

```php
$collection = new Collection(['Desk', 'Sofa', 'Chair']);

$intersect = $collection->intersect(['Desk', 'Chair', 'Bookcase']);

$intersect->all();

// [0 => 'Desk', 2 => 'Chair']
```

As you can see, the resulting collection will preserve the original collection's keys.

<a name="method-intersectbykeys"></a>
#### `intersectByKeys()`

The `intersectByKeys` method removes any keys from the original collection that are not present in the given `array` or collection:

```php
$collection = new Collection([
    'serial' => 'UX301', 'type' => 'screen', 'year' => 2009
]);

$intersect = $collection->intersectByKeys([
    'reference' => 'UX404', 'type' => 'tab', 'year' => 2011
]);

$intersect->all();

// ['type' => 'screen', 'year' => 2009]
```

<a name="method-isempty"></a>
#### `isEmpty()`

The `isEmpty` method returns `true` if the collection is empty; otherwise `false` is returned:

```php
new Collection([])->isEmpty();

// true
```

<a name="method-isnotempty"></a>
#### `isNotEmpty()`

The `isNotEmpty` method returns `true` if the collection is not empty; otherwise, `false` is returned:

```php
new Collection([])->isNotEmpty();

// false
```

<a name="method-join"></a>
#### `join()`

The `join` method joins the collection's values with a string:

```php
new Collection(['a', 'b', 'c'])->join(', '); // 'a, b, c'
new Collection(['a', 'b', 'c'])->join(', ', ', and '); // 'a, b, and c'
new Collection(['a', 'b'])->join(', ', ' and '); // 'a and b'
new Collection(['a'])->join(', ', ' and '); // 'a'
new Collection([])->join(', ', ' and '); // ''
```

<a name="method-keyby"></a>
#### `keyBy()`

Keys the collection by the given key:

```php
$collection = new Collection([
    ['product_id' => 'prod-100', 'name' => 'chair'],
    ['product_id' => 'prod-200', 'name' => 'desk'],
]);

$keyed = $collection->keyBy('product_id');

$keyed->all();

/*
    [
        'prod-100' => ['product_id' => 'prod-100', 'name' => 'Chair'],
        'prod-200' => ['product_id' => 'prod-200', 'name' => 'Desk'],
    ]
*/
```

If multiple items have the same key, only the last one will appear in the new collection.

You may also pass your own callback, which should return the value to key the collection by:

```php
$keyed = $collection->keyBy(function ($item) {
    return strtoupper($item['product_id']);
});

$keyed->all();

/*
    [
        'PROD-100' => ['product_id' => 'prod-100', 'name' => 'Chair'],
        'PROD-200' => ['product_id' => 'prod-200', 'name' => 'Desk'],
    ]
*/
```

<a name="method-keys"></a>
#### `keys()`

The `keys` method returns all of the collection's keys:

```php
$collection = new Collection([
    'prod-100' => ['product_id' => 'prod-100', 'name' => 'Chair'],
    'prod-200' => ['product_id' => 'prod-200', 'name' => 'Desk'],
]);

$keys = $collection->keys();

$keys->all();

// ['prod-100', 'prod-200']
```

<a name="method-last"></a>
#### `last()`

The `last` method returns the last element in the collection that passes a given truth test:

```php
new Collection([1, 2, 3, 4])->last(function ($key, $value) {
    return $value < 3;
});

// 2
```

You may also call the `last` method with no arguments to get the last element in the collection. If the collection is empty then `null` is returned.

```php
new Collection([1, 2, 3, 4])->last();

// 4
```

<a name="method-map"></a>
#### `map()`

The `map` method iterates through the collection and passes each value to the given callback. The callback is free to modify the item and return it, thus forming a new collection of modified items:

```php
$collection = new Collection([1, 2, 3, 4, 5]);

$multiplied = $collection->map(function ($item, $key) {
    return $item * 2;
});

$multiplied->all();

// [2, 4, 6, 8, 10]
```

> **Note**: Like most other collection methods, `map` returns a new collection instance; it does not modify the collection it is called on. If you want to transform the original collection, use the [`transform`](#method-transform) method.

<a name="method-mapinto"></a>
#### `mapInto()`

The `mapInto()` method iterates over the collection, creating a new instance of the given class by passing the value into the constructor:

```php
class Currency
{
    /**
     * Create a new currency instance.
     *
     * @param  string  $code
     * @return void
     */
    function __construct(string $code)
    {
        $this->code = $code;
    }
}

$collection = new Collection(['AUD', 'USD', 'GBP']);

$currencies = $collection->mapInto(Currency::class);

$currencies->all();

// [Currency('AUD'), Currency('USD'), Currency('GBP')]
```

<a name="method-mapspread"></a>
#### `mapSpread()`

The `mapSpread` method iterates over the collection's items, passing each nested item value into the given callback. The callback is free to modify the item and return it, thus forming a new collection of modified items:

```php
$collection = new Collection([0, 1, 2, 3, 4, 5, 6, 7, 8, 9]);

$chunks = $collection->chunk(2);

$sequence = $chunks->mapSpread(function ($even, $odd) {
    return $even + $odd;
});

$sequence->all();

// [1, 5, 9, 13, 17]
```

<a name="method-maptogroups"></a>
#### `mapToGroups()`

The `mapToGroups` method groups the collection's items by the given callback. The callback should return an associative array containing a single key / value pair, thus forming a new collection of grouped values:

```php
$collection = new Collection([
    [
        'name' => 'John Doe',
        'department' => 'Sales',
    ],
    [
        'name' => 'Jane Doe',
        'department' => 'Sales',
    ],
    [
        'name' => 'Johnny Doe',
        'department' => 'Marketing',
    ]
]);

$grouped = $collection->mapToGroups(function ($item, $key) {
    return [$item['department'] => $item['name']];
});

$grouped->toArray();

/*
    [
        'Sales' => ['John Doe', 'Jane Doe'],
        'Marketing' => ['Johnny Doe'],
    ]
*/

$grouped->get('Sales')->all();

// ['John Doe', 'Jane Doe']
```

<a name="method-mapwithkeys"></a>
#### `mapWithKeys()`

The `mapWithKeys` method iterates through the collection and passes each value to the given callback. The callback should return an associative array containing a single key / value pair:

```php
$collection = new Collection([
    [
        'name' => 'John',
        'department' => 'Sales',
        'email' => 'john@example.tld'
    ],
    [
        'name' => 'Jane',
        'department' => 'Marketing',
        'email' => 'jane@example.tld'
    ]
]);

$keyed = $collection->mapWithKeys(function ($item) {
    return [$item['email'] => $item['name']];
});

$keyed->all();

/*
    [
        'john@example.tld' => 'John',
        'jane@example.tld' => 'Jane',
    ]
*/
```

<a name="method-max"></a>
#### `max()`

The `max` method returns the maximum value of a given key:

```php
$max = new Collection([['foo' => 10], ['foo' => 20]])->max('foo');

// 20

$max = new Collection([1, 2, 3, 4, 5])->max();

// 5
```

<a name="method-median"></a>
#### `median()`

The `median` method returns the [median value](https://en.wikipedia.org/wiki/Median) of a given key:

```php
$median = new Collection([['foo' => 10], ['foo' => 10], ['foo' => 20], ['foo' => 40]])->median('foo');

// 15

$median = new Collection([1, 1, 2, 4])->median();

// 1.5
```

<a name="method-merge"></a>
#### `merge()`

The `merge` method merges the given array or collection with the original collection. If a string key in the given items matches a string key in the original collection, the given items's value will overwrite the value in the original collection:

```php
$collection = new Collection(['product_id' => 1, 'price' => 100]);

$merged = $collection->merge(['price' => 200, 'discount' => false]);

$merged->all();

// ['product_id' => 1, 'price' => 200, 'discount' => false]
```

If the given items's keys are numeric, the values will be appended to the end of the collection:

```php
$collection = new Collection(['Desk', 'Chair']);

$merged = $collection->merge(['Bookcase', 'Door']);

$merged->all();

// ['Desk', 'Chair', 'Bookcase', 'Door']
```

<a name="method-mergerecursive"></a>
#### `mergeRecursive()`

The `mergeRecursive` method merges the given array or collection recursively with the original collection. If a string key in the given items matches a string key in the original collection, then the values for these keys are merged together into an array, and this is done recursively:

```php
$collection = new Collection(['product_id' => 1, 'price' => 100]);

$merged = $collection->mergeRecursive(['product_id' => 2, 'price' => 200, 'discount' => false]);

$merged->all();

// ['product_id' => [1, 2], 'price' => [100, 200], 'discount' => false]
```

<a name="method-min"></a>
#### `min()`

The `min` method returns the minimum value of a given key:

```php
$min = new Collection([['foo' => 10], ['foo' => 20]])->min('foo');

// 10

$min = new Collection([1, 2, 3, 4, 5])->min();

// 1
```

<a name="method-mode"></a>
#### `mode()`

The `mode` method returns the [mode value](https://en.wikipedia.org/wiki/Mode_(statistics)) of a given key:

```php
$mode = new Collection([['foo' => 10], ['foo' => 10], ['foo' => 20], ['foo' => 40]])->mode('foo');

// [10]

$mode = new Collection([1, 1, 2, 4])->mode();

// [1]
```

<a name="method-nth"></a>
#### `nth()`

The `nth` method creates a new collection consisting of every n-th element:

```php
$collection = new Collection(['a', 'b', 'c', 'd', 'e', 'f']);

$collection->nth(4);

// ['a', 'e']
```

You may optionally pass an offset as the second argument:

```php
$collection->nth(4, 1);

// ['b', 'f']
```

<a name="method-only"></a>
#### `only()`

The `only` method returns the items in the collection with the specified keys:

```php
$collection = new Collection(['product_id' => 1, 'name' => 'Desk', 'price' => 100, 'discount' => false]);

$filtered = $collection->only(['product_id', 'name']);

$filtered->all();

// ['product_id' => 1, 'name' => 'Desk']
```

For the inverse of `only`, see the [except](#method-except) method.

<a name="method-pad"></a>
#### `pad()`

The `pad` method will fill the array with the given value until the array reaches the specified size. This method behaves like the [array_pad](https://secure.php.net/manual/en/function.array-pad.php) PHP function.

To pad to the left, you should specify a negative size. No padding will take place if the absolute value of the given size is less than or equal to the length of the array:

```php
$collection = new Collection(['A', 'B', 'C']);

$filtered = $collection->pad(5, 0);

$filtered->all();

// ['A', 'B', 'C', 0, 0]

$filtered = $collection->pad(-5, 0);

$filtered->all();

// [0, 0, 'A', 'B', 'C']
```

<a name="method-partition"></a>
#### `partition()`

The `partition` method may be combined with the `list` PHP function to separate elements that pass a given truth test from those that do not:

```php
$collection = new Collection([1, 2, 3, 4, 5, 6]);

list($underThree, $equalOrAboveThree) = $collection->partition(function ($i) {
    return $i < 3;
});

$underThree->all();

// [1, 2]

$equalOrAboveThree->all();

// [3, 4, 5, 6]
```

<a name="method-pipe"></a>
#### `pipe()`

The `pipe` method passes the collection to the given callback and returns the result:

```php
$collection = new Collection([1, 2, 3]);

$piped = $collection->pipe(function ($collection) {
    return $collection->sum();
});

// 6
```

<a name="method-pluck"></a>
#### `pluck()`

The `pluck` method retrieves all of the collection values for a given key:

```php
$collection = new Collection([
    ['product_id' => 'prod-100', 'name' => 'Chair'],
    ['product_id' => 'prod-200', 'name' => 'Desk'],
]);

$plucked = $collection->pluck('name');

$plucked->all();

// ['Chair', 'Desk']
```

You may also specify how you wish the resulting collection to be keyed:

```php
$plucked = $collection->pluck('name', 'product_id');

$plucked->all();

// ['prod-100' => 'Desk', 'prod-200' => 'Chair']
```

<a name="method-pop"></a>
#### `pop()`

The `pop` method removes and returns the last item from the collection:

```php
$collection = new Collection([1, 2, 3, 4, 5]);

$collection->pop();

// 5

$collection->all();

// [1, 2, 3, 4]
```

<a name="method-prepend"></a>
#### `prepend()`

The `prepend` method adds an item to the beginning of the collection:

```php
$collection = new Collection([1, 2, 3, 4, 5]);

$collection->prepend(0);

$collection->all();

// [0, 1, 2, 3, 4, 5]
```

<a name="method-pull"></a>
#### `pull()`

The `pull` method removes and returns an item from the collection by its key:

```php
$collection = new Collection(['product_id' => 'prod-100', 'name' => 'Desk']);

$collection->pull('name');

// 'Desk'

$collection->all();

// ['product_id' => 'prod-100']
```

<a name="method-push"></a>
#### `push()`

The `push` method appends an item to the end of the collection:

```php
$collection = new Collection([1, 2, 3, 4]);

$collection->push(5);

$collection->all();

// [1, 2, 3, 4, 5]
```

<a name="method-put"></a>
#### `put()`

The `put` method sets the given key and value in the collection:

```php
$collection = new Collection(['product_id' => 1, 'name' => 'Desk']);

$collection->put('price', 100);

$collection->all();

// ['product_id' => 1, 'name' => 'Desk', 'price' => 100]
```

<a name="method-random"></a>
#### `random()`

The `random` method returns a random item from the collection:

```php
$collection = new Collection([1, 2, 3, 4, 5]);

$collection->random();

// 4 - (retrieved randomly)
```

You may optionally pass an integer to `random`. If that integer is more than `1`, a collection of items is returned:

```php
$random = $collection->random(3);

$random->all();

// [2, 4, 5] - (retrieved randomly)
```

<a name="method-reduce"></a>
#### `reduce()`

The `reduce` method reduces the collection to a single value, passing the result of each iteration into the subsequent iteration:

```php
$collection = new Collection([1, 2, 3]);

$total = $collection->reduce(function ($carry, $item) {
    return $carry + $item;
});

// 6
```

The value for `$carry` on the first iteration is `null`; however, you may specify its initial value by passing a second argument to `reduce`:

```php
$collection->reduce(function ($carry, $item) {
    return $carry + $item;
}, 4);

// 10
```

<a name="method-reject"></a>
#### `reject()`

The `reject` method filters the collection using the given callback. The callback should return `true` for any items it wishes to remove from the resulting collection:

```php
$collection = new Collection([1, 2, 3, 4]);

$filtered = $collection->reject(function ($item) {
    return $item > 2;
});

$filtered->all();

// [1, 2]
```

For the inverse of the `reject` method, see the [`filter`](#method-filter) method.

<a name="method-replace"></a>
#### `replace()`

The `replace` method behaves similarly to `merge`; however, in addition to overwriting matching items with string keys, the `replace` method will also overwrite items in the collection that have matching numeric keys:

```php
$collection = new Collection(['James', 'Scott', 'Dan']);

$replaced = $collection->replace([1 => 'Victoria', 3 => 'Finn']);

$replaced->all();

// ['James', 'Victoria', 'Dan', 'Finn']
```

<a name="method-replacerecursive"></a>
#### `replaceRecursive()`

This method works like `replace`, but it will recur into arrays and apply the same replacement process to the inner values:

```php
$collection = new Collection(['George', 'Scott', ['James', 'Victoria', 'Finn']]);

$replaced = $collection->replaceRecursive(['Charlie', 2 => [1 => 'King']]);

$replaced->all();

// ['Charlie', 'Scott', ['James', 'King', 'Finn']]
```

<a name="method-reverse"></a>
#### `reverse()`

The `reverse` method reverses the order of the collection's items:

```php
$collection = new Collection([1, 2, 3, 4, 5]);

$reversed = $collection->reverse();

$reversed->all();

// [5, 4, 3, 2, 1]
```

<a name="method-search"></a>
#### `search()`

The `search` method searches the collection for the given value and returns its key if found. If the item is not found, `false` is returned.

```php
$collection = new Collection([2, 4, 6, 8]);

$collection->search(4);

// 1
```

The search is done using a "loose" comparison. To use strict comparison, pass `true` as the second argument to the method:

```php
$collection->search('4', true);

// false
```

Alternatively, you may pass in your own callback to search for the first item that passes your truth test:

```php
$collection->search(function ($item, $key) {
    return $item > 5;
});

// 2
```

<a name="method-shift"></a>
#### `shift()`

The `shift` method removes and returns the first item from the collection:

```php
$collection = new Collection([1, 2, 3, 4, 5]);

$collection->shift();

// 1

$collection->all();

// [2, 3, 4, 5]
```

<a name="method-shuffle"></a>
#### `shuffle()`

The `shuffle` method randomly shuffles the items in the collection:

```php
$collection = new Collection([1, 2, 3, 4, 5]);

$shuffled = $collection->shuffle();

$shuffled->all();

// [3, 2, 5, 1, 4] (generated randomly)
```

<a name="method-skip"></a>
#### `skip()`

The `skip` method returns a new collection, without the first given amount of items:

```php
$collection = new Collection([1, 2, 3, 4, 5, 6, 7, 8, 9, 10]);

$collection = $collection->skip(4);

$collection->all();

// [5, 6, 7, 8, 9, 10]
```

<a name="method-slice"></a>
#### `slice()`

The `slice` method returns a slice of the collection starting at the given index:

```php
$collection = new Collection([1, 2, 3, 4, 5, 6, 7, 8, 9, 10]);

$slice = $collection->slice(4);

$slice->all();

// [5, 6, 7, 8, 9, 10]
```

If you would like to limit the size of the returned slice, pass the desired size as the second argument to the method:

```php
$slice = $collection->slice(4, 2);

$slice->all();

// [5, 6]
```

The returned slice will preserve keys by default. If you do not wish to preserve the original keys, you can use the [`values`](#method-values) method to reindex them.

<a name="method-some"></a>
#### `some()`

Alias for the [`contains`](#method-contains) method.

<a name="method-sort"></a>
#### `sort()`

The `sort` method sorts the collection:

```php
$collection = new Collection([5, 3, 1, 2, 4]);

$sorted = $collection->sort();

$sorted->values()->all();

// [1, 2, 3, 4, 5]
```

The sorted collection keeps the original array keys. In this example we used the [`values`](#method-values) method to reset the keys to consecutively numbered indexes.

For sorting a collection of nested arrays or objects, see the [`sortBy`](#method-sortby) and [`sortByDesc`](#method-sortbydesc) methods.

If your sorting needs are more advanced, you may pass a callback to `sort` with your own algorithm. Refer to the PHP documentation on [`usort`](http://php.net/manual/en/function.usort.php#refsect1-function.usort-parameters), which is what the collection's `sort` method calls under the hood.

<a name="method-sortby"></a>
#### `sortBy()`

The `sortBy` method sorts the collection by the given key:

```php
$collection = new Collection([
    ['name' => 'Desk', 'price' => 200],
    ['name' => 'Chair', 'price' => 100],
    ['name' => 'Bookcase', 'price' => 150],
]);

$sorted = $collection->sortBy('price');

$sorted->values()->all();

/*
    [
        ['name' => 'Chair', 'price' => 100],
        ['name' => 'Bookcase', 'price' => 150],
        ['name' => 'Desk', 'price' => 200],
    ]
*/
```

The sorted collection keeps the original array keys. In this example we used the [`values`](#method-values) method to reset the keys to consecutively numbered indexes.

You can also pass your own callback to determine how to sort the collection values:

```php
$collection = new Collection([
    ['name' => 'Desk', 'colors' => ['Black', 'Mahogany']],
    ['name' => 'Chair', 'colors' => ['Black']],
    ['name' => 'Bookcase', 'colors' => ['Red', 'Beige', 'Brown']],
]);

$sorted = $collection->sortBy(function ($product, $key) {
    return count($product['colors']);
});

$sorted->values()->all();

/*
    [
        ['name' => 'Chair', 'colors' => ['Black']],
        ['name' => 'Desk', 'colors' => ['Black', 'Mahogany']],
        ['name' => 'Bookcase', 'colors' => ['Red', 'Beige', 'Brown']],
    ]
*/
```

<a name="method-sortbydesc"></a>
#### `sortByDesc()`

This method has the same signature as the [`sortBy`](#method-sortby) method, but will sort the collection in the opposite order.

<a name="method-sortkeys"></a>
#### `sortKeys()`

The `sortKeys` method sorts the collection by the keys of the underlying associative array:

```php
$collection = new Collection([
    'id' => 22345,
    'first' => 'John',
    'last' => 'Doe',
]);

$sorted = $collection->sortKeys();

$sorted->all();

/*
    [
        'first' => 'John',
        'id' => 22345,
        'last' => 'Doe',
    ]
*/
```

<a name="method-sortkeysdesc"></a>
#### `sortKeysDesc()`

This method has the same signature as the [`sortKeys`](#method-sortkeys) method, but will sort the collection in the opposite order.

<a name="method-splice"></a>
#### `splice()`

The `splice` method removes and returns a slice of items starting at the specified index:

```php
$collection = new Collection([1, 2, 3, 4, 5]);

$chunk = $collection->splice(2);

$chunk->all();

// [3, 4, 5]

$collection->all();

// [1, 2]
```

You may pass a second argument to limit the size of the resulting chunk:

```php
$collection = new Collection([1, 2, 3, 4, 5]);

$chunk = $collection->splice(2, 1);

$chunk->all();

// [3]

$collection->all();

// [1, 2, 4, 5]
```

In addition, you can pass a third argument containing the new items to replace the items removed from the collection:

```php
$collection = new Collection([1, 2, 3, 4, 5]);

$chunk = $collection->splice(2, 1, [10, 11]);

$chunk->all();

// [3]

$collection->all();

// [1, 2, 10, 11, 4, 5]
```

<a name="method-splice"></a>
#### `splice()`

The `splice` method removes and returns a slice of items starting at the specified index:

```php
$collection = new Collection([1, 2, 3, 4, 5]);

$chunk = $collection->splice(2);

$chunk->all();

// [3, 4, 5]

$collection->all();

// [1, 2]
```

You may pass a second argument to limit the size of the resulting chunk:

```php
$collection = new Collection([1, 2, 3, 4, 5]);

$chunk = $collection->splice(2, 1);

$chunk->all();

// [3]

$collection->all();

// [1, 2, 4, 5]
```

In addition, you can pass a third argument containing the new items to replace the items removed from the collection:

```php
$collection = new Collection([1, 2, 3, 4, 5]);

$chunk = $collection->splice(2, 1, [10, 11]);

$chunk->all();

// [3]

$collection->all();

// [1, 2, 10, 11, 4, 5]
```

<a name="method-split"></a>
#### `split()`

The `split` method breaks a collection into the given number of groups:

```php
$collection = new Collection([1, 2, 3, 4, 5]);

$groups = $collection->split(3);

$groups->toArray();

// [[1, 2], [3, 4], [5]]
```

<a name="method-sum"></a>
#### `sum()`

The `sum` method returns the sum of all items in the collection:

```php
new Collection([1, 2, 3, 4, 5])->sum();

// 15
```

If the collection contains nested arrays or objects, you should pass a key to use for determining which values to sum:

```php
$collection = new Collection([
    ['name' => 'JavaScript: The Good Parts', 'pages' => 176],
    ['name' => 'JavaScript: The Definitive Guide', 'pages' => 1096],
]);

$collection->sum('pages');

// 1272
```

In addition, you may pass your own callback to determine which values of the collection to sum:

```php
$collection = new Collection([
    ['name' => 'Chair', 'colors' => ['Black']],
    ['name' => 'Desk', 'colors' => ['Black', 'Mahogany']],
    ['name' => 'Bookcase', 'colors' => ['Red', 'Beige', 'Brown']],
]);

$collection->sum(function ($product) {
    return count($product['colors']);
});

// 6
```

<a name="method-take"></a>
#### `take()`

The `take` method returns a new collection with the specified number of items:

```php
$collection = new Collection([0, 1, 2, 3, 4, 5]);

$chunk = $collection->take(3);

$chunk->all();

// [0, 1, 2]
```

You may also pass a negative integer to take the specified amount of items from the end of the collection:

```php
$collection = new Collection([0, 1, 2, 3, 4, 5]);

$chunk = $collection->take(-2);

$chunk->all();

// [4, 5]
```

<a name="method-tap"></a>
#### `tap()`

The `tap` method passes the collection to the given callback, allowing you to "tap" into the collection at a specific point and do something with the items while not affecting the collection itself:

```php
new Collection([2, 4, 3, 1, 5])
    ->sort()
    ->tap(function ($collection) {
        Log::debug('Values after sorting', $collection->values()->toArray());
    })
    ->shift();

// 1
```

<a name="method-times"></a>
#### `times()`

The static `times` method creates a new collection by invoking the callback a given amount of times:

```php
$collection = Collection::times(10, function ($number) {
    return $number * 9;
});

$collection->all();

// [9, 18, 27, 36, 45, 54, 63, 72, 81, 90]
```

<a name="method-toarray"></a>
#### `toArray()`

The `toArray` method converts the collection into a plain PHP `array`. If the collection's values are [database models](../database/model.md), the models will also be converted to arrays:

```php
$collection = new Collection(['name' => 'Desk', 'price' => 200]);

$collection->toArray();

/*
    [
        ['name' => 'Desk', 'price' => 200],
    ]
*/
```

> **Note**: `toArray` also converts all of its nested objects to an array. If you want to get the underlying array as is, use the [`all`](#method-all) method instead.

<a name="method-tojson"></a>
#### `toJson()`

The `toJson` method converts the collection into JSON:

```php
$collection = new Collection(['name' => 'Desk', 'price' => 200]);

$collection->toJson();

// '{"name":"Desk","price":200}'
```

<a name="method-transform"></a>
#### `transform()`

The `transform` method iterates over the collection and calls the given callback with each item in the collection. The items in the collection will be replaced by the values returned by the callback:

```php
$collection = new Collection([1, 2, 3, 4, 5]);

$collection->transform(function ($item, $key) {
    return $item * 2;
});

$collection->all();

// [2, 4, 6, 8, 10]
```

> **Note**: Unlike most other collection methods, `transform` modifies the collection itself. If you wish to create a new collection instead, use the [`map`](#method-map) method.

<a name="method-union"></a>
#### `union()`

The `union` method adds the given array to the collection. If the given array contains keys that are already in the original collection, the original collection's values will be preferred:

```php
$collection = new Collection([1 => ['a'], 2 => ['b']]);

$union = $collection->union([3 => ['c'], 1 => ['b']]);

$union->all();

// [1 => ['a'], 2 => ['b'], 3 => ['c']]
```

<a name="method-unique"></a>
#### `unique()`

The `unique` method returns all of the unique items in the collection. The returned collection keeps the original array keys, so in this example we'll use the [`values`](#method-values) method to reset the keys to consecutively numbered indexes:

```php
$collection = new Collection([1, 1, 2, 2, 3, 4, 2]);

$unique = $collection->unique();

$unique->values()->all();

// [1, 2, 3, 4]
```

When dealing with nested arrays or objects, you may specify the key used to determine uniqueness:

```php
$collection = new Collection([
    ['name' => 'iPhone 12', 'brand' => 'Apple', 'type' => 'phone'],
    ['name' => 'iPhone 13', 'brand' => 'Apple', 'type' => 'phone'],
    ['name' => 'Apple Watch', 'brand' => 'Apple', 'type' => 'watch'],
    ['name' => 'Galaxy S21', 'brand' => 'Samsung', 'type' => 'phone'],
    ['name' => 'Galaxy Gear', 'brand' => 'Samsung', 'type' => 'watch'],
]);

$unique = $collection->unique('brand');

$unique->values()->all();

/*
    [
        ['name' => 'iPhone 13', 'brand' => 'Apple', 'type' => 'phone'],
        ['name' => 'Galaxy S21', 'brand' => 'Samsung', 'type' => 'phone'],
    ]
*/
```

You may also pass your own callback to determine item uniqueness:

```php
$unique = $collection->unique(function ($item) {
    return $item['brand'].$item['type'];
});

$unique->values()->all();

/*
    [
        ['name' => 'iPhone 12', 'brand' => 'Apple', 'type' => 'phone'],
        ['name' => 'Apple Watch', 'brand' => 'Apple', 'type' => 'watch'],
        ['name' => 'Galaxy S21', 'brand' => 'Samsung', 'type' => 'phone'],
        ['name' => 'Galaxy Gear', 'brand' => 'Samsung', 'type' => 'watch'],
    ]
*/
```

The `unique` method uses "loose" comparisons when checking item values, meaning a string with an integer value will be considered equal to an integer of the same value. Use the [`uniqueStrict`](#method-uniquestrict) method to filter using "strict" comparisons.

<a name="method-uniquestrict"></a>
#### `uniqueStrict()`

This method has the same signature as the [`unique`](#method-unique) method; however, all values are compared using "strict" comparisons.

<a name="method-unless"></a>
#### `unless()`

The `unless` method will execute the given callback unless the first argument given to the method evaluates to `true`:

```php
$collection = new Collection([1, 2, 3]);

$collection->unless(true, function ($collection) {
    return $collection->push(4);
});

$collection->unless(false, function ($collection) {
    return $collection->push(5);
});

$collection->all();

// [1, 2, 3, 5]
```

For the inverse of `unless`, see the [`when`](#method-when) method.

<a name="method-unlessempty"></a>
#### `unlessEmpty()`

Alias for the [`whenNotEmpty`](#method-whennotempty) method.

<a name="method-unlessnotempty"></a>
#### `unlessNotEmpty()`

Alias for the [`whenEmpty`](#method-whenempty) method.

<a name="method-unwrap"></a>
#### `unwrap()`

The static `unwrap` method returns the collection's underlying items from the given value when applicable:

```php
Collection::unwrap(new Collection('John Doe'));

// ['John Doe']

Collection::unwrap(['John Doe']);

// ['John Doe']

Collection::unwrap('John Doe');

// 'John Doe'
```

<a name="method-values"></a>
#### `values()`

The `values` method returns a new collection with the keys reset to consecutive integers:

```php
$collection = new Collection([
    10 => ['product' => 'Desk', 'price' => 200],
    11 => ['product' => 'Desk', 'price' => 200]
]);

$values = $collection->values();

$values->all();

/*
    [
        0 => ['product' => 'Desk', 'price' => 200],
        1 => ['product' => 'Desk', 'price' => 200],
    ]
*/
```

<a name="method-when"></a>
#### `when()`

The `when` method will execute the given callback when the first argument given to the method evaluates to `true`:

```php
$collection = new Collection([1, 2, 3]);

$collection->when(true, function ($collection) {
    return $collection->push(4);
});

$collection->when(false, function ($collection) {
    return $collection->push(5);
});

$collection->all();

// [1, 2, 3, 4]
```

For the inverse of `when`, see the [`unless`](#method-unless) method.

<a name="method-whenempty"></a>
#### `whenEmpty()`

The `whenEmpty` method will execute the given callback when the collection is empty:

```php
$collection = new Collection(['michael', 'tom']);

$collection->whenEmpty(function ($collection) {
    return $collection->push('steve');
});

$collection->all();

// ['michael', 'tom']


$collection = new Collection();

$collection->whenEmpty(function ($collection) {
    return $collection->push('steve');
});

$collection->all();

// ['steve']

$collection = new Collection(['michael', 'tom']);

$collection->whenEmpty(function ($collection) {
    return $collection->push('steve');
}, function ($collection) {
    return $collection->push('prince');
});

$collection->all();

// ['michael', 'tom', 'prince']
```

For the inverse of `whenEmpty`, see the [`whenNotEmpty`](#method-whennotempty) method.

<a name="method-whennotempty"></a>
#### `whenNotEmpty()`

The `whenNotEmpty` method will execute the given callback when the collection is not empty:

```php
$collection = new Collection(['michael', 'tom']);

$collection->whenNotEmpty(function ($collection) {
    return $collection->push('steve');
});

$collection->all();

// ['michael', 'tom', 'steve']


$collection = new Collection();

$collection->whenNotEmpty(function ($collection) {
    return $collection->push('steve');
});

$collection->all();

// []


$collection = new Collection();

$collection->whenNotEmpty(function ($collection) {
    return $collection->push('steve');
}, function ($collection) {
    return $collection->push('prince');
});

$collection->all();

// ['prince']
```

For the inverse of `whenNotEmpty`, see the [`whenEmpty`](#method-whenempty) method.

<a name="method-where"></a>
#### `where()`

The `where` method filters the collection by a given key / value pair:

```php
$collection = new Collection([
    ['product' => 'Desk', 'price' => 200],
    ['product' => 'Chair', 'price' => 100],
    ['product' => 'Bookcase', 'price' => 150],
    ['product' => 'Door', 'price' => 100],
]);

$filtered = $collection->where('price', 100);

$filtered->all();

/*
    [
        ['product' => 'Chair', 'price' => 100],
        ['product' => 'Door', 'price' => 100],
    ]
*/
```

The `where` method uses "loose" comparisons when checking item values, meaning a string with an integer value will be considered equal to an integer of the same value. Use the [`whereStrict`](#method-wherestrict) method to filter using "strict" comparisons.

Optionally, you may pass a comparison operator as the second parameter.

```php
$collection = new Collection([
    ['name' => 'Jim', 'deleted_at' => '2019-01-01 00:00:00'],
    ['name' => 'Sally', 'deleted_at' => '2019-01-02 00:00:00'],
    ['name' => 'Sue', 'deleted_at' => null],
]);

$filtered = $collection->where('deleted_at', '!=', null);

$filtered->all();

/*
    [
        ['name' => 'Jim', 'deleted_at' => '2019-01-01 00:00:00'],
        ['name' => 'Sally', 'deleted_at' => '2019-01-02 00:00:00'],
    ]
*/
```

<a name="method-wherestrict"></a>
#### `whereStrict()`

This method has the same signature as the [`where`](#method-where) method; however, all values are compared using "strict" comparisons.

<a name="method-wherebetween"></a>
#### `whereBetween()`

The `whereBetween` method filters the collection within a given range:

```php
$collection = new Collection([
    ['product' => 'Desk', 'price' => 200],
    ['product' => 'Chair', 'price' => 80],
    ['product' => 'Bookcase', 'price' => 150],
    ['product' => 'Pencil', 'price' => 30],
    ['product' => 'Door', 'price' => 100],
]);

$filtered = $collection->whereBetween('price', [100, 200]);

$filtered->all();

/*
    [
        ['product' => 'Desk', 'price' => 200],
        ['product' => 'Bookcase', 'price' => 150],
        ['product' => 'Door', 'price' => 100],
    ]
*/
```

<a name="method-wherein"></a>
#### `whereIn()`

The `whereIn` method filters the collection by a given key / value contained within the given array:

```php
$collection = new Collection([
    ['product' => 'Desk', 'price' => 200],
    ['product' => 'Chair', 'price' => 100],
    ['product' => 'Bookcase', 'price' => 150],
    ['product' => 'Door', 'price' => 100],
]);

$filtered = $collection->whereIn('price', [150, 200]);

$filtered->all();

/*
    [
        ['product' => 'Desk', 'price' => 200],
        ['product' => 'Bookcase', 'price' => 150],
    ]
*/
```

The `whereIn` method uses "loose" comparisons when checking item values, meaning a string with an integer value will be considered equal to an integer of the same value. Use the [`whereInStrict`](#method-whereinstrict) method to filter using "strict" comparisons.

<a name="method-whereinstrict"></a>
#### `whereInStrict()`

This method has the same signature as the [`whereIn`](#method-wherein) method; however, all values are compared using "strict" comparisons.

<a name="method-whereinstanceof"></a>
#### `whereInstanceOf()`

The `whereInstanceOf` method filters the collection by a given class type:

```php
use App\User;
use App\Post;

$collection = new Collection([
    new User,
    new User,
    new Post,
]);

$filtered = $collection->whereInstanceOf(User::class);

$filtered->all();

// [App\User, App\User]
```

<a name="method-wherenotbetween"></a>
#### `whereNotBetween()`

The `whereNotBetween` method filters the collection within a given range:

```php
$collection = new Collection([
    ['product' => 'Desk', 'price' => 200],
    ['product' => 'Chair', 'price' => 80],
    ['product' => 'Bookcase', 'price' => 150],
    ['product' => 'Pencil', 'price' => 30],
    ['product' => 'Door', 'price' => 100],
]);

$filtered = $collection->whereNotBetween('price', [100, 200]);

$filtered->all();

/*
    [
        ['product' => 'Chair', 'price' => 80],
        ['product' => 'Pencil', 'price' => 30],
    ]
*/
```

<a name="method-wherenotin"></a>
#### `whereNotIn()`

The `whereNotIn` method filters the collection by a given key / value not contained within the given array:

```php
$collection = new Collection([
    ['product' => 'Desk', 'price' => 200],
    ['product' => 'Chair', 'price' => 100],
    ['product' => 'Bookcase', 'price' => 150],
    ['product' => 'Door', 'price' => 100],
]);

$filtered = $collection->whereNotIn('price', [150, 200]);

$filtered->all();

/*
    [
        ['product' => 'Chair', 'price' => 100],
        ['product' => 'Door', 'price' => 100],
    ]
*/
```

The `whereNotIn` method uses "loose" comparisons when checking item values, meaning a string with an integer value will be considered equal to an integer of the same value. Use the [`whereNotInStrict`](#method-wherenotinstrict) method to filter using "strict" comparisons.

<a name="method-wherenotinstrict"></a>
#### `whereNotInStrict()`

This method has the same signature as the [`whereNotIn`](#method-wherenotin) method; however, all values are compared using "strict" comparisons.

<a name="method-wherenotnull"></a>
#### `whereNotNull()`

The `whereNotNull` method filters items where the given key is not null:

```php
$collection = new Collection([
    ['name' => 'Desk'],
    ['name' => null],
    ['name' => 'Bookcase'],
]);

$filtered = $collection->whereNotNull('name');

$filtered->all();

/*
    [
        ['name' => 'Desk'],
        ['name' => 'Bookcase'],
    ]
*/
```

<a name="method-wherenull"></a>
#### `whereNull()`

The `whereNull` method filters items where the given key is null:

```php
$collection = new Collection([
    ['name' => 'Desk'],
    ['name' => null],
    ['name' => 'Bookcase'],
]);

$filtered = $collection->whereNull('name');

$filtered->all();

/*
    [
        ['name' => null],
    ]
*/
```

<a name="method-wrap"></a>
#### `wrap()`

The static `wrap` method wraps the given value in a collection when applicable:

```php
$collection = Collection::wrap('John Doe');

$collection->all();

// ['John Doe']

$collection = Collection::wrap(['John Doe']);

$collection->all();

// ['John Doe']

$collection = Collection::wrap(new Collection('John Doe'));

$collection->all();

// ['John Doe']
```

<a name="method-zip"></a>
#### `zip()`

The `zip` method merges together the values of the given array with the values of the original collection at the corresponding index:

```php
$collection = new Collection(['Chair', 'Desk']);

$zipped = $collection->zip([100, 200]);

$zipped->all();

// [['Chair', 100], ['Desk', 200]]
```
# Application

The inversion of control (IoC) container is a tool for managing class dependencies. Dependency injection is a method of removing hard-coded class dependencies. Instead, the dependencies are injected at run-time, allowing for greater flexibility as dependency implementations may be swapped easily.

#### Binding To The Container

There are two ways the IoC container can resolve dependencies: via Closure callbacks or automatic resolution. First, we'll explore Closure callbacks. First, a "type" may be bound into the container.

```php
App::bind('foo', function($app) {
    return new FooBar;
});
```

#### Resolving From The container

```php
$value = App::make('foo');
```

When the `App::make` method is called, the Closure callback is executed and the result is returned.

#### Binding a "shared" type into the container

Sometimes you may wish to bind something into the container that should only be resolved once, and the same instance should be returned on subsequent calls into the container:

```php
App::singleton('foo', function() {
    return new FooBar;
});
```

#### Binding an existing instance into the container

You may also bind an existing object instance into the container using the `instance` method:

```php
$foo = new Foo;

App::instance('foo', $foo);
```

#### Binding an interface to an implementation

In some cases, a class may depend on an interface implementation, not a "concrete type". When this is the case, the `App::bind` method must be used to inform the container which interface implementation to inject:

```php
App::bind('UserRepositoryInterface', 'DbUserRepository');
```

Now consider the following code:

```php
$users = App::make('UserRepositoryInterface');
```

Since we have bound the `UserRepositoryInterface` to a concrete type, the `DbUserRepository` will automatically be injected into this controller when it is created.

### Where to Register Bindings

IoC bindings, like [event handlers](./event.md), generally fall under the category of "bootstrap code". In other words, they prepare your application to actually handle requests, and usually need to be executed before a route or controller is actually called. The most common place is the `boot` method of a [plugin registration file](../extending.md). Alternatively, plugins can supply a file named **init.php** in the plugin directory that you can use to place IoC registration logic.

## Service Providers

Service providers are a great way to create libraries and perform group related IoC registrations in a single location. Within a service provider, you might register a custom authentication driver, register your application's repository classes with the IoC container, or even setup a custom Artisan command.

In fact, [plugin registration files](../system/plugins.md) inherit service providers and most of the core components include service providers. All of the registered service providers for your application are listed in the `providers` array of the `config/app.php` configuration file.

#### Defining a Service Provider

To create a service provider, simply extend the `October\Rain\Support\ServiceProvider` class and define a `register` method:

```php
use October\Rain\Support\ServiceProvider;

class FooServiceProvider extends ServiceProvider
{
    public function register()
    {
        $this->app->bind('foo', function() {
            return new Foo;
        });
    }
}
```

Note that in the `register` method, the application IoC container is available to you via the `$this->app` property. Once you have created a provider and are ready to register it with your application, simply add it to the `providers` array in your `app` configuration file.

#### Registering a Service Provider at Runtime

You may also register a service provider at run-time using the `App::register` method.

```php
App::register('FooServiceProvider');
```

## Application Events

#### Request Events

You can register special events before a request is routed using the `before` and `after` methods.

```php
App::before(function ($request) {
    // Code to execute before the request is routed
});

App::after(function ($request) {
    // Code to execute after the request is routed
});
```

#### Container Events

The service container fires an event each time it resolves an object. You may listen to this event using the `resolving` method.

```php
App::resolving(function ($object, $app) {
    // Called when container resolves object of any type...
});

App::resolving('foo', function ($fooBar, $app) {
    // Called when container resolves objects using hint "foo"...
});

App::resolving('Acme\Blog\Classes\FooBar', function ($fooBar, $app) {
    // Called when container resolves objects of type "FooBar"...
});
```

As you can see, the object being resolved will be passed to the callback, allowing you to set any additional properties on the object before it is given to its consumer.

## Application Helpers

#### Finding the Application Environment

You may use the `environment` method to discover the application environment as determined by the [environment configuration](../../setup/configuration.md).

```php
// production
App::environment();
```

#### Determine the Execution Context

It is possible to know if the current request is being performed in the administrative back-end area using the `runningInBackend` method.

```php
App::runningInBackend();
```

You may also use the `runningInConsole` method to check if the executing code is taking place inside the [command line interface](../console-commands.md):

```php
App::runningInConsole();
```
# Parser

October CMS uses several standards for processing markup, templates and configuration. Each has been carefully selected to serve their role in making your development process and learning curve as simple as possible. As an example, the [objects found in a theme](../../cms/themes/themes.md) use the Twig and INI format in their template structure. Each parser is described in more detail below.

## Markdown Parser

Markdown allows you to write easy-to-read and easy-to-write plain text format, which then converts to HTML. The `Markdown` facade is used for parsing Markdown syntax and is based on [GitHub flavored markdown](https://help.github.com/articles/github-flavored-markdown/). Some quick examples of markdown:

```md
This text is **bold**, this text is *italic*, this text is ~~crossed out~~.

# The largest heading (an <h1> tag)
## The second largest heading (an <h2> tag)
...
###### The 6th largest heading (an <h6> tag)
```

Use the `Markdown::parse` method to render Markdown to HTML:

```php
$html = Markdown::parse($markdown);
```

You may also use the `|md` filter for [parsing Markdown in your front-end markup](../../markup/filter/md.md).

```twig
{{ '**Text** is bold.'|md }}
```

### Using HTML in Markdown

Markdown is a superset of HTML so you can combine HTML and Markdown in the same template. When Markdown encounters any block-level HTML tag, the Markdown syntax will deactivate for all the content inside.

```html
<div>
    This **text** won't be parsed by *Markdown*
</div>
```

It is important to note that the Markdown parser will only accept one HTML node per line. In the example below, the second node is not included in the output.

```html
<!-- Output: <p>Foo</p> -->
<p>Foo</p><p>Bar</p>
```

When displaying complex HTML, especially via a Twig variable, you should wrap the variable in a single HTML node to make sure all the output is captured.

```twig
<div>
    {{ messageBody|raw }}
</div>
```

If you intentionally want to enable Markdown inside a block-level tag, you may do this by adding `markdown` attribute to the tag with a value of `1`.

```html
<div markdown="1">
    This **text** is now bold.
</div>
```

## Twig Template Parser

Twig is a simple but powerful template engine that parses HTML templates in to optimized PHP code, it the driving force behind [the front-end markup](../../markup/templating.md), [view content](./response-view.md) and [mail message content](../system/sending-mail.md).

The `Twig` facade is used for parsing Twig syntax, you may use the `Twig::parse` method to render Twig to HTML.

```php
$html = Twig::parse($twig);
```

The second argument can be used for passing variables to the Twig markup.

```php
$html = Twig::parse($twig, ['foo' => 'bar']);
```

The Twig parser can be extended to register custom features via [the plugin registration file](../twig-tags.md).

## Bracket Parser

October CMS also ships with a simple bracket template parser as an alternative to the Twig parser, currently used for passing variables to [theme content blocks](../../cms/themes/content.md). This engine is faster to render HTML and is designed to be more suitable for non-technical users. There is no facade for this parser so the fully qualified `October\Rain\Parse\Bracket` class should be used with the `parse` method.

```php
use October\Rain\Parse\Bracket;

$html = Bracket::parse($content, ['foo' => 'bar']);
```

The syntax uses singular *curly brackets* for rendering variables:

```
<p>Hello there, {foo}</p>
```

You may also pass an array of objects to parse as a variable.

```php
$html = Template::parse($content, ['likes' => [
    ['name' => 'Dogs'],
    ['name' => 'Fishing'],
    ['name' => 'Golf']
]]);
```

The array can be iterated using the following syntax:

```
<ul>
    {likes}
        <li>{name}</li>
    {/likes}
</ul>
```

## YAML Configuration Parser

YAML ("YAML Ain't Markup Language") is a configuration format, similar to Markdown it was designed to be an easy-to-read and easy-to-write format that converts to a PHP array. It is used practically everywhere for the back-end development of October CMS, such as [form field definitions](../../element/form-fields.md). An example of some YAML:

```yaml
receipt: Acme Purchase Invoice
date: 2015-10-02
user:
    name: Joe
    surname: Blogs
```

The `Yaml` facade is used for parsing YAML and you use the `Yaml::parse` method to render YAML to a PHP array:

```php
$array = Yaml::parse($yamlString);
```

Use the `parseFile` method to parse the contents of a file:

```php
$array = Yaml::parseFile($filePath);
```

The parser also supports operation in reverse, outputting YAML format from a PHP array. You may use the `render` method for this:

```php
$yamlString = Yaml::render($array);
```

## Initialization (INI) Configuration Parser

The INI file format is a standard for defining simple configuration files, commonly used by [components inside theme templates](../../cms/themes/components.md). It could be considered a cousin of the YAML format, although unlike YAML, it is incredibly simple, less sensitive to typos and does not rely on indentation. It supports basic key-value pairs with sections, for example:

```ini
receipt = "Acme Purchase Invoice"
date = "2015-10-02"

[user]
name = "Joe"
surname = "Blogs"
```

The `Ini` facade is used for parsing INI and you use the `Ini::parse` method to render INI to a PHP array:

```php
$array = Ini::parse($iniString);
```

Use the `parseFile` method to parse the contents of a file:

```php
$array = Ini::parseFile($filePath);
```

The parser also supports operation in reverse, outputting INI format from a PHP array. You may use the `render` method for this:

```php
$iniString = Ini::render($array);
```

### October Flavored INI

Traditionally, the INI parser used by the PHP function `parse_ini_string` is restricted to arrays that are 3 levels deep. For example:

```ini
level1Value = "foo"
level1Array[] = "bar"

[level1Object]
level2Value = "hello"
level2Array[] = "world"
level2Object[level3Value] = "stop here"
```

October has extended this functionality with *October flavored INI* to allow arrays of infinite depth, inspired by the syntax of HTML forms. Following on from the above example, the following syntax is supported:

```ini
[level1Object]
level2Object[level3Array][] = "Yay!"
level2Object[level3Object][level4Value] = "Yay!"
level2Object[level3Object][level4Array][] = "Yay!"
level2Object[level3Object][level4Object][level5Value] = "Yay!"
; ... to infinity and beyond!
```

## Dynamic Syntax Parser

Dynamic Syntax is a templating engine unique to October that fundamentally supports two modes of rendering. Parsing a template will produce two results, either a **view** or **editor** mode. Take this template text as an example, the inner part of the `{text}...{/text}` tags represents the default text for the **view** mode, while the inner attributes, `name` and `label`, are used as properties for the **editor** mode.

```
<h1>{text name="websiteName" label="Website Name"}Our wonderful website{/text}</h1>
```

There is no facade for this parser so the fully qualified `October\Rain\Parse\Syntax\Parser` class should be used with the `parse` method. The first argument of the `parse` method takes the template content as a string and returns a `Parser` object.

```php
use October\Rain\Parse\Syntax\Parser as SyntaxParser;

$syntax = SyntaxParser::parse($content);
```

### View Mode

Let's say we used the first example above as the template content, calling the `render` method by itself will render the template with the default text:

```php
echo $syntax->render();
// <h1>Our wonderful website</h1>
```

Just like any templating engine, passing an array of variables to the first argument of `render` will replace the variables inside the template. Here the default value of `websiteName` is replaced with our new value:

```php
echo $syntax->render(['websiteName' => 'October CMS']);
// <h1>October CMS</h1>
```

As a bonus feature, calling the `toTwig` method will output the template in a prepared state for rendering by the Twig engine.

```php
echo $syntax->toTwig();
// <h1>{{ websiteName }}</h1>
```

### Editor Mode

So far the Dynamic Syntax parser is not much different to a regular template engine, however the editor mode is where the utility of Dynamic Syntax becomes more apparent. The editor mode unlocks a new realm of possibility, for example, where [layouts inject custom form fields to pages](https://octobercms.com/plugin/rainlab-pages) that belong to them or for [dynamically built forms used in email campaigns](https://octobercms.com/plugin/responsiv-campaign).

To continue with the examples above, calling the `toEditor` method on the `Parser` object will return a PHP array of properties that define how the variable should be populated, by a form builder for example.

```php
$array = $syntax->toEditor();
// 'websiteName' => [
//     'label' => 'Website name',
//     'default' => 'Our wonderful website',
//     'type' => 'text'
// ]
```

You may notice the properties closely resemble the options found in [form field definitions](../../element/form-fields.md). This is intentional so the two features compliment each other. We could now easily convert the array above to YAML and write to a `fields.yaml` file:

```php
$form = [
    'fields' => $syntax->toEditor()
];

File::put('fields.yaml', Yaml::render($form));
```

### Supported Tags

There are various tag types that can be used with the Dynamic Syntax parser, these are designed to match common [form field types](../../element/form-fields.md).

#### Text

Single line input for smaller blocks of text.

```html
{text name="websiteName" label="Website Name"}Our wonderful website{/text}
```

#### Textarea

Multiple line input for larger blocks of text.

```html
{textarea name="websiteDescription" label="Website Description"}
    This is our vision for things to come
{/textarea}
```

#### Dropdown

Renders a dropdown form field.

```html
{dropdown name="dropdown" label="Pick one" options="One|Two"}{/dropdown}
```

Renders a dropdown form field with independent values and labels.

```html
{dropdown name="dropdown" label="Pick one" options="one:One|two:Two"}{/dropdown}
```

Renders a dropdown form field with an array returned by a static class method (the class must be a fully namespaced class).

```html
{dropdown name="dropdown" label="Pick one" options="Path\To\Class::method"}{/dropdown}
```

#### Radio

Renders a radio form field.

```html
{radio name="radio" label="Thoughts?" options="y:Yes|n:No|m:Maybe"}{/radio}
```

#### Variable

Renders the form field type exactly as defined in the `type` attribute. This tag will simply set a variable and will render in view mode as an empty string.

```html
{variable type="text" name="name" label="Name"}John{/variable}
```

#### Rich editor

Text input for rich content (WYSIWYG).

```html
{richeditor name="content" label="Main content"}Default text{/richeditor}
```

Renders in Twig as

```twig
{{ content|raw }}
```

#### Markdown

Text input for Markdown content.

```html
{markdown name="content" label="Markdown content"}Default text{/markdown}
```

Renders in Twig as

```twig
{{ content|md }}
```

#### Media finder

File selector for media library items. This tag value will contain the relative path to the file.

```html
{mediafinder name="logo" label="Logo"}defaultlogo.png{/mediafinder}
```

Renders in Twig as

```twig
{{ logo|media }}
```

#### File upload

File uploader input for files. This tag value will contain the full path to the file.

```html
{fileupload name="logo" label="Logo"}defaultlogo.png{/fileupload}
```

#### Color picker

Color picker widget for color selection. This tag will contain the selected hexadecimal value. You may optionally provide an `availableColors` attribute to define the available colours for selection.

```html
{colorpicker name="bg_color" label="Background colour" allowEmpty="true" availableColors="#ffffff|#000000"}{/colorpicker}
```

#### Repeater

Renders a repeating section with other fields inside.

```html
{repeater name="content_sections" prompt="Add another content section"}
    <h2>{text name="title" label="Title"}Title{/text}</h2>
    <p>{textarea name="content" label="Content"}Content{/textarea}</p>
{/repeater}
```

Renders in Twig as

```twig
{% for fields in repeater %}
    <h2>{{ fields.title }}</h2>
    <p>{{ fields.content|raw }}</p>
{% endfor %}
```

Calling `$syntax->toEditor` will return a different array for a repeater field:

```php
'repeater' => [
    'label' => 'Website name',
    'type' => 'repeater',
    'fields' => [

        'title' => [
            'label' => 'Title',
            'default' => 'Title',
            'type' => 'text'
        ],
        'content' => [
            'label' => 'Content',
            'default' => 'Content',
            'type' => 'textarea'
        ]

    ]
]
```

The repeater field also supports group mode, to be used with the dynamic syntax parser as follows:

```html
{variable name="sections" type="repeater" prompt="Add another section" tab="Sections"
        groups="$/author/plugin/repeater_fields.yaml"}{/variable}
```

This is an example of the repeater_fields.yaml group configuration file:

```yaml
quote:
    name: Quote
    description: Quote item
    icon: icon-quote-right
    fields:
        quote_position:
            span: auto
            label: Quote Position
            type: radio
            options:
                left: Left
                center: Center
                right: Right
        quote_content:
            span: auto
            label: Details
            type: textarea
```

For more information about the repeater group mode see [Repeater Widget](../../element/form/widget-repeater.md).
# Request & Input

## Basic Input

You may access all user input with a few simple methods. You do not need to worry about the HTTP verb for the request when using the `Input` facade, as input is accessed in the same way for all verbs. The global `input` [helper function](./helpers.md) is an alias for `Input::get`.

#### Retrieving an Input Value

```php
$name = Input::get('name');

$name = input('name');
```

#### Retrieving a Default Value if the Input Value is Absent

```php
$name = Input::get('name', 'Sally');
```

#### Determining if an Input Value is Present

```php
if (Input::has('name')) {
    //
}
```

#### Getting All Input for the Request

```php
$input = Input::all();
```

#### Getting Only Some of the Request Input

```php
$input = Input::only('username', 'password');

$input = Input::except('credit_card');
```

When working on forms with "array" inputs, you may use dot notation to access the arrays:

```php
$input = Input::get('products.0.name');
```

::: tip
Some JavaScript libraries such as Backbone may send input to the application as JSON. You may access this data via `Input::get` like normal.
:::

## Cookies

By default, all cookies created by the October CMS are encrypted and signed with an authentication code, meaning they will be considered invalid if they have been changed by the client. Cookies named in the `system.unencrypt_cookies` config key will not be encrypted.

#### Retrieving a Cookie Value

```php
$value = Cookie::get('name');
```

#### Attaching a New Cookie to a Response

```php
$response = Response::make('Hello World');

$response->withCookie(Cookie::make('name', 'value', $minutes));
```

#### Queueing a Cookie for the Next Response

If you would like to set a cookie before a response has been created, use the `Cookie::queue` method. The cookie will automatically be attached to the final response from your application.

```php
Cookie::queue($name, $value, $minutes);
```

#### Creating a Cookie That Lasts Forever

```php
$cookie = Cookie::forever('name', 'value');
```

#### Handling Cookies Without Encryption

If you don't want some cookies to be encrypted or decrypted, you can specify them in configuration. This is useful, for example, when you want to pass data from frontend to server side backend via cookies, and vice versa.

Add names of the cookies that should not be encrypted or decrypted to `unencrypt_cookies` parameter in the `config/system.php` configuration file.

```php
'unencrypt_cookies' => [
    'my_cookie',
],
```

Alternatively for plugins, you can also add these dynamically from `Plugin.php` of your plugin.

```php
public function boot()
{
    Config::push('system.unencrypt_cookies', 'my_cookie');
}
```

## Old Input

You may need to keep input from one request until the next request. For example, you may need to re-populate a form after checking it for validation errors.

#### Flashing Input to the Session

```php
Input::flash();
```

#### Flashing Only Some Input to the Session

```php
Input::flashOnly('username', 'email');

Input::flashExcept('password');
```

Since you often will want to flash input in association with a redirect to the previous page, you may easily chain input flashing onto a redirect.

```php
return Redirect::to('form')->withInput();

return Redirect::to('form')->withInput(Input::except('password'));
```

::: tip
You may flash other data across requests using the [Session](./session.md) class.
:::

#### Retrieving Old Data

Fetch individual input value.

```php
Input::old('username');
```

Fetch all old input values.

```php
$data = Input::old();
```

## Files

You can retrieve  uploaded files from the request using the `file` method on the `Input` facade or the global `files()` helper.

```php
$file = Input::file('photo');

$file = files('photo');
```

To determine if a file is present on the request, use the `hasFile` method.

```php
if (Input::hasFile('photo')) {
    //
}
```

In addition to checking if the file is present, you may verify that there were no problems uploading the file via the isValid method.

```php
if ($file->isValid()) {
    //
}
```

The returned file object has a variety of methods related to the uploaded file.

Method Name | Purpose
------------- | -------------
**move($destinationPath, $fileName)** | Moves the uploaded file to a local path
**store($folder, $disk)** | Stores the file using the [storage service](../../extend/services/storage.md).
**storeAs($folder, $name, $disk)** | Stores the file with a specific name using the [storage service](../../extend/services/storage.md).
**extension()** | Guesses the extension based on the file contents
**getRealPath()** | Returns the local path
**getClientOriginalName()** | Returns the original name
**getClientOriginalExtension()** | Returns the original extension
**getSize()** | Returns the size
**getMimeType()** | Returns the MIME type

An example of moving an uploaded file.

```php
$file->move($destinationPath);

$file->move($destinationPath, $fileName);
```

Examples of [storing an uploaded file](./storage.md) in a folder (first argument) and an optional disk (second argument).

```php
$file->store($folder);

$file->store($folder, 's3');
```

::: warning
The folder names `media`, `resources`, `uploads` or `public` are reserved.
:::

Examples of `storeAs` storing the file with a custom disk name (second argument). The `storePubliclyAs` stores the file with public visibility.

```php
$file->storeAs($folder, 'avatar');

$file->storeAs($folder, 'avatar', 's3');

$file->storePublicly($folder, 's3');

$file->storePubliclyAs($folder, 'avatar', 's3');
```

An example of retrieving the path to an uploaded file.

```php
$path = $file->getRealPath();
```

An example of retrieving the original name of an uploaded file.

```php
$name = $file->getClientOriginalName();
```

Retrieving the extension of an uploaded file.

```php
$extension = $file->getClientOriginalExtension();
```

Retrieving the size of an uploaded file.

```php
$size = $file->getSize();
```

Retrieving the MIME type of an uploaded file.

```php
$mime = $file->getMimeType();
```

## Request Information

The `Request` class provides many methods for examining the HTTP request for your application and extends the `Symfony\Component\HttpFoundation\Request` class. Here are some of the highlights.

#### Retrieving the Request URI

```php
$uri = Request::path();
```

#### Retrieving the Request Method

```php
$method = Request::method();

if (Request::isMethod('post')) {
    //
}
```

#### Determining if the Request Path Matches a Pattern

```php
if (Request::is('admin/*')) {
    //
}
```

#### Get the Request URL

```php
$url = Request::url();
```

#### Retrieve a Request URI Segment

```php
$segment = Request::segment(1);
```

#### Retrieving a Request Header

```php
$value = Request::header('Content-Type');
```

#### Retrieving Values from $_SERVER

```php
$value = Request::server('PATH_INFO');
```

#### Determining if the Request is Over HTTPS

```php
if (Request::secure()) {
    //
}
```

#### Determine if the Request is Using AJAX

```php
if (Request::ajax()) {
    //
}
```

#### Determine if the Request has JSON Content Type

```php
if (Request::isJson()) {
    //
}
```

#### Determine if the Request is Asking for JSON

```php
if (Request::wantsJson()) {
    //
}
```

#### Checking the Requested Response Format

The `Request::format` method will return the requested response format based on the HTTP Accept header:

```php
if (Request::format() == 'json') {
    //
}
```
# Site Manager

### Introduction

The global `Site` facade is included with October CMS to provide tools for working with [multisite implementations](../../cms/resources/multisite.md). All optional multisite features are enabled or disabled using the configuration file **config/multisite.php**.

```php
'features' => [
    'cms_maintenance_setting' => false,
    // ...
]
```

The `hasFeature` is used to check if a specific multisite feature is enabled.

```php
$useMultisite = Site::hasFeature('cms_maintenance_setting');
```

## Checking Site Configuration State

Use the `hasAnySite` to check if any enabled site is available.

```php
if (Site::hasAnySite()) {
    // ...
}
```

The `hasMultiSite` will return true if multiple site definitions are available.

```php
if (Site::hasMultiSite()) {
    // ...
}
```

The `hasSiteGroups` will return true if multiple site definitions are using grouped definitions.

```php
if (Site::hasSiteGroups()) {
    // ...
}
```

## Retrieving a Site

Requesting a site will return a `System\Models\SiteDefinition` instance, with available attributes loaded from the cache driver or database.

The `getPrimarySite` method returns the primary site definition, used as a fallback for every occasion.

```php
$site = Site::getPrimarySite();
```

The frontend theme has a selected site that is used when rendering CMS pages, the `getActiveSite` site will return this site.

```php
$site = Site::getActiveSite();
```

Likewise, the admin panel can select a site and this can be retrieved using the `getEditSite` method.

```php
$site = Site::getEditSite();
```

To look up a site by its unique ID, use the `getSiteFromId` with the identifier.

```php
$siteFour = Site::getSiteFromId(4);
```

To look up a site using its locale code, use the `getSiteForLocale` passing it the desired locale.

```php
$frenchSite = Site::getSiteForLocale('fr');
```

## Accessing Multiple Sites

If multiple sites are returned, it will be as a populated instance of the `October\Rain\Database\Collection` object.

List all the sites, including disabled sites, with the `listSites` method.

```php
$sites = Site::listSites();
```
List only enabled sites with the `listEnabled` method.

```php
$sites = Site::listEnabled();
```

List sites enabled in the admin panel using `listEditEnabled`.

```php
$sites = Site::listEditEnabled();
```

## Site Context

A site context is used to determine the active site, and this will restrict lookups to that site automatically. In some cases a global state is used to allow access to data across all states.

Use the `withContext` to change the context to a different site, passing it the ID of the desired site.

```php
Site::withContext(2, function() {
    // Models in site 2 are now available.
});
```

Activating the global context is performed using the `withGlobalContext` and passing it a closure.

```php
Site::withGlobalContext(function() {
    // All models are available in here.
});
```

Use the `hasGlobalContext` method to check if the global state is currently activated.

```php
$global = Site::hasGlobalContext();
```

#### See Also

::: also
* [Multisite](../../cms/resources/multisite.md)
* [Multisite Trait](../database/traits.md)
:::
# Helpers

October CMS includes a variety of "helper" PHP functions. Many of these functions are used internally by October itself, however, you are free to use them in your own plugins and applications if you find them useful.

### Arrays

<div class="content-list-p" markdown="1">

[array_add](#method-array-add)
[array_divide](#method-array-divide)
[array_dot](#method-array-dot)
[array_undot](#method-array-undot)
[array_except](#method-array-except)
[array_first](#method-array-first)
[array_flatten](#method-array-flatten)
[array_forget](#method-array-forget)
[array_get](#method-array-get)
[array_only](#method-array-only)
[array_pluck](#method-array-pluck)
[array_pull](#method-array-pull)
[array_set](#method-array-set)
[array_sort](#method-array-sort)
[array_sort_recursive](#method-array-sort-recursive)
[array_where](#method-array-where)
[head](#method-head)
[last](#method-last)

</div>

### Paths

<div class="content-list-p" markdown="1">

[Path Symbols](#path-symbols)
[app_path](#method-app-path)
[base_path](#method-base-path)
[config_path](#method-config-path)
[database_path](#method-database-path)
[plugins_path](#method-plugins-path)
[public_path](#method-public-path)
[storage_path](#method-storage-path)
[temp_path](#method-temp-path)
[themes_path](#method-themes-path)
[cache_path](#method-cache-path)

</div>

### Strings

<div class="content-list-p" markdown="1">

[camel_case](#method-camel-case)
[class_basename](#method-class-basename)
[e](#method-e)
[ends_with](#method-ends-with)
[snake_case](#method-snake-case)
[str_limit](#method-str-limit)
[starts_with](#method-starts-with)
[str_contains](#method-str-contains)
[str_finish](#method-str-finish)
[str_is](#method-str-is)
[str_plural](#method-str-plural)
[str_random](#method-str-random)
[str_singular](#method-str-singular)
[str_slug](#method-str-slug)
[studly_case](#method-studly-case)
[trans](#method-trans)
[trans_choice](#method-trans-choice)

</div>

### Miscellaneous

<div class="content-list-p" markdown="1">

[asset](#method-asset)
[config](#method-config)
[dd](#method-dd)
[env](#method-env)
[input](#method-input)
[get](#method-get)
[post](#method-post)
[files](#method-files)
[redirect](#method-redirect)
[request](#method-request)
[response](#method-response)
[route](#method-route)
[secure_asset](#method-secure-asset)
[trace_log](#method-trace-log)
[trace_sql](#method-trace-sql)
[url](#method-url)

</div>

## Arrays

<a name="method-array-add"></a>
#### `array_add()`

The `array_add` function adds a given key / value pair to the array if the given key doesn't already exist in the array:

```php
$array = array_add(['name' => 'Desk'], 'price', 100);

// ['name' => 'Desk', 'price' => 100]
```

<a name="method-array-divide"></a>
#### `array_divide()`

The `array_divide` function returns two arrays, one containing the keys, and the other containing the values of the original array:

```php
list($keys, $values) = array_divide(['name' => 'Desk']);

// $keys: ['name']

// $values: ['Desk']
```

<a name="method-array-dot"></a>
#### `array_dot()`

The `array_dot` function flattens a multi-dimensional array into a single level array that uses "dot" notation to indicate depth:

```php
$array = array_dot(['foo' => ['bar' => 'baz']]);

// ['foo.bar' => 'baz'];
```

<a name="method-array-undot"></a>
#### `array_undot()`

The `array_undot` function is the counter-part to the `array_dot` method. It will convert a dot-notated array into a standard associative array:

```php
$array = array_undot([
    'foo.bar' => 'baz'
]);

// [
//    'foo' => [
//        'bar' => 'baz'
//    ]
// ]
```

<a name="method-array-except"></a>
#### `array_except()`

The `array_except` method removes the given key / value pairs from the array:

```php
$array = ['name' => 'Desk', 'price' => 100];

$array = array_except($array, ['price']);

// ['name' => 'Desk']
```

<a name="method-array-first"></a>
#### `array_first()`

The `array_first` method returns the first element of an array passing a given truth test:

```php
$array = [100, 200, 300];

$value = array_first($array, function ($key, $value) {
    return $value >= 150;
});

// 200
```

A default value may also be passed as the third parameter to the method. This value will be returned if no value passes the truth test:

```php
$value = array_first($array, $callback, $default);
```

<a name="method-array-flatten"></a>
#### `array_flatten()`

The `array_flatten` method will flatten a multi-dimensional array into a single level.

```php
$array = ['name' => 'Joe', 'languages' => ['PHP', 'Ruby']];

$array = array_flatten($array);

// ['Joe', 'PHP', 'Ruby'];
```

<a name="method-array-forget"></a>
#### `array_forget()`

The `array_forget` method removes a given key / value pair from a deeply nested array using "dot" notation:

```php
$array = ['products' => ['desk' => ['price' => 100]]];

array_forget($array, 'products.desk');

// ['products' => []]
```

<a name="method-array-get"></a>
#### `array_get()`

The `array_get` method retrieves a value from a deeply nested array using "dot" notation:

```php
$array = ['products' => ['desk' => ['price' => 100]]];

$value = array_get($array, 'products.desk');

// ['price' => 100]
```

The `array_get` function also accepts a default value, which will be returned if the specific key is not found:

```php
$value = array_get($array, 'names.john', 'default');
```

<a name="method-array-only"></a>
#### `array_only()`

The `array_only` method will return only the specified key / value pairs from the given array:

```php
$array = ['name' => 'Desk', 'price' => 100, 'orders' => 10];

$array = array_only($array, ['name', 'price']);

// ['name' => 'Desk', 'price' => 100]
```

<a name="method-array-pluck"></a>
#### `array_pluck()`

The `array_pluck` method will pluck a list of the given key / value pairs from the array:

```php
$array = [
    ['developer' => ['name' => 'Brian']],
    ['developer' => ['name' => 'Stewie']]
];

$array = array_pluck($array, 'developer.name');

// ['Brian', 'Stewie'];
```

<a name="method-array-pull"></a>
#### `array_pull()`

The `array_pull` method returns and removes a key / value pair from the array:

```php
$array = ['name' => 'Desk', 'price' => 100];

$name = array_pull($array, 'name');

// $name: Desk

// $array: ['price' => 100]
```

<a name="method-array-set"></a>
#### `array_set()`

The `array_set` method sets a value within a deeply nested array using "dot" notation:

```php
$array = ['products' => ['desk' => ['price' => 100]]];

array_set($array, 'products.desk.price', 200);

// ['products' => ['desk' => ['price' => 200]]]
```

<a name="method-array-sort"></a>
#### `array_sort()`

The `array_sort` method sorts the array by the results of the given Closure:

```php
$array = [
    ['name' => 'Desk'],
    ['name' => 'Chair'],
];

$array = array_values(array_sort($array, function ($value) {
    return $value['name'];
}));

/*
    [
        ['name' => 'Chair'],
        ['name' => 'Desk'],
    ]
*/
```

<a name="method-array-sort-recursive"></a>
#### `array_sort_recursive()`

The `array_sort_recursive` function recursively sorts the array using the `sort` function:

```php
$array = [
    [
        'Brian',
        'Shannon',
        'Alec',
    ],
    [
        'PHP',
        'Ruby',
        'JavaScript',
    ],
];

$array = array_sort_recursive($array);

/*
    [
        [
            'Alec',
            'Brian',
            'Shannon',
        ],
        [
            'JavaScript',
            'PHP',
            'Ruby',
        ]
    ];
*/
```

<a name="method-array-where"></a>
#### `array_where()`

The `array_where` function filters the array using the given Closure:

```php
$array = [100, '200', 300, '400', 500];

$array = array_where($array, function ($value, $key) {
    return is_string($value);
});

// [1 => 200, 3 => 400]
```

<a name="method-head"></a>
#### `head()`

The `head` function simply returns the first element in the given array:

```php
$array = [100, 200, 300];

$first = head($array);

// 100
```

<a name="method-last"></a>
#### `last()`

The `last` function returns the last element in the given array:

```php
$array = [100, 200, 300];

$last = last($array);

// 300
```

## Paths

<a name="path-symbols"></a>
#### Path Symbols

Path prefix symbols can be used to create a dynamic path. For example, a path beginning with `~/` will create a path relative to the application:

```yaml
list: ~/plugins/acme/pay/models/invoiceitem/columns.yaml
```

These symbols are supported for creating dynamic paths:

Symbol | Description
------------- | -------------
`$` | Relative to the plugins directory
`~` | Relative to the application directory
`#` | Relative to the themes directory

<a name="method-app-path"></a>
#### `app_path()`

The `app_path` function returns the fully qualified path to the `app` directory:

```php
$path = app_path();
```

You may also use the `app_path` function to generate a fully qualified path to a given file relative to the application directory:

```php
$path = app_path('Http/Controllers/Controller.php');
```

<a name="method-base-path"></a>
#### `base_path()`

The `base_path` function returns the fully qualified path to the project root:

```php
$path = base_path();
```

You may also use the `base_path` function to generate a fully qualified path to a given file relative to the application directory:

```php
$path = base_path('vendor/bin');
```

<a name="method-config-path"></a>
#### `config_path($path = '')`

The `config_path` function returns the fully qualified path to the application configuration directory:

```php
$path = config_path();
```

You may also use the `config_path` function to generate a fully qualified path to a given file relative to the config directory:

```php
$path = config_path('dev/cms.php');
```

<a name="method-database-path"></a>
#### `database_path()`

The `database_path` function returns the fully qualified path to the application's database directory:

```php
$path = database_path();
```

<a name="method-plugins-path"></a>
#### `plugins_path($path = '')`

The `plugins_path` function returns the fully qualified path to the application plugin directory:

```php
$path = plugins_path();
```

You may also use the `plugins_path` function to generate a fully qualified path to a given file relative to the plugins directory:

```php
$path = plugins_path('author/plugin/routes.php');
```

<a name="method-public-path"></a>
#### `public_path()`

The `public_path` function returns the fully qualified path to the `public` directory:

```php
$path = public_path();
```

<a name="method-storage-path"></a>
#### `storage_path($path = '')`

The `storage_path` function returns the fully qualified path to the `storage` directory:

```php
$path = storage_path();
```

You may also use the `storage_path` function to generate a fully qualified path to a given file relative to the storage directory:

```php
$path = storage_path('app/file.txt');
```

<a name="method-temp-path"></a>
#### `temp_path($path = '')`

The `temp_path` function returns the fully qualified path to a writable directory for temporary files:

```php
$path = temp_path();
```

You may also use the `temp_path` function to generate a fully qualified path to a given file relative to the temp directory:

```php
$path = temp_path('app/file.txt');
```

<a name="method-themes-path"></a>
#### `themes_path($path = '')`

The `themes_path` function returns the fully qualified path to the `themes` directory:

```php
$path = themes_path();
```

You may also use the `themes_path` function to generate a fully qualified path to a given file relative to the themes directory:

```php
$path = themes_path('mytheme/file.txt');
```

<a name="method-cache-path"></a>
#### `cache_path($path = '')`

The `cache_path` function returns the fully qualified path to the application cache directory:

```php
$path = cache_path();
```

You may also use the `cache_path` function to generate a fully qualified path to a given file relative to the cache directory:

```php
$path = cache_path('cms/cachefile.json');
```

## Strings

<a name="method-camel-case"></a>
#### `camel_case()`

The `camel_case` function converts the given string to `camelCase`:

```php
$camel = camel_case('foo_bar');

// fooBar
```

<a name="method-class-basename"></a>
#### `class_basename()`

The `class_basename` returns the class name of the given class with the class' namespace removed:

```php
$class = class_basename('Foo\Bar\Baz');

// Baz
```

<a name="method-e"></a>
#### `e()`

The `e` function runs `htmlentities` over the given string:

```php
echo e('<html>foo</html>');

// &lt;html&gt;foo&lt;/html&gt;
```

<a name="method-ends-with"></a>
#### `ends_with()`

The `ends_with` function determines if the given string ends with the given value:

```php
$value = ends_with('This is my name', 'name');

// true
```

<a name="method-snake-case"></a>
#### `snake_case()`

The `snake_case` function converts the given string to `snake_case`:

```php
$snake = snake_case('fooBar');

// foo_bar
```

<a name="method-str-limit"></a>
#### `str_limit()`

The `str_limit` function limits the number of characters in a string. The function accepts a string as its first argument and the maximum number of resulting characters as its second argument:

```php
$value = str_limit('The CMS platform that gets back to basics.', 6);

// The CMS...
```

<a name="method-starts-with"></a>
#### `starts_with()`

The `starts_with` function determines if the given string begins with the given value:

```php
$value = starts_with('The cow goes moo', 'The');

// true
```

<a name="method-str-contains"></a>
#### `str_contains()`

The `str_contains` function determines if the given string contains the given value:

```php
$value = str_contains('The bird goes tweet', 'bird');

// true
```

<a name="method-str-finish"></a>
#### `str_finish()`

The `str_finish` function adds a single instance of the given value to a string:

```php
$string = str_finish('this/string', '/');

// this/string/
```

<a name="method-str-is"></a>
#### `str_is()`

The `str_is` function determines if a given string matches a given pattern. Asterisks may be used to indicate wildcards:

```php
$value = str_is('foo*', 'foobar');

// true

$value = str_is('baz*', 'foobar');

// false
```

<a name="method-str-plural"></a>
#### `str_plural()`

The `str_plural` function converts a string to its plural form. This function currently only supports the English language:

```php
$plural = str_plural('car');

// cars

$plural = str_plural('child');

// children
```

<a name="method-str-random"></a>
#### `str_random()`

The `str_random` function generates a random string of the specified length:

```php
$string = str_random(40);
```

<a name="method-str-singular"></a>
#### `str_singular()`

The `str_singular` function converts a string to its singular form. This function currently only supports the English language:

```php
$singular = str_singular('cars');

// car
```

<a name="method-str-slug"></a>
#### `str_slug()`

The `str_slug` function generates a URL friendly "slug" from the given string:

```php
$title = str_slug("October CMS", "-");

// october-cms
```

<a name="method-studly-case"></a>
#### `studly_case()`

The `studly_case` function converts the given string to `StudlyCase`:

```php
$value = studly_case('foo_bar');

// FooBar
```

<a name="method-trans"></a>
#### `trans()`

The `trans` function translates the given language line using your [localization files](../plugin/localization.md):

```php
echo trans('validation.required'):
```

<a name="method-trans-choice"></a>
#### `trans_choice()`

The `trans_choice` function translates the given language line with inflection:

```php
$value = trans_choice('foo.bar', $count);
```

## Miscellaneous

<a name="method-asset"></a>
#### `asset()`

Generate a URL for an asset using the current scheme of the request (HTTP or HTTPS):

```php
$url = asset('img/photo.jpg');
```

<a name="method-config"></a>
#### `config()`

The `config` function gets the value of a configuration variable. The configuration values may be accessed using "dot" syntax, which includes the name of the file and the option you wish to access. A default value may be specified and is returned if the configuration option does not exist:

```php
$value = config('app.timezone');

$value = config('app.timezone', $default);
```

The `config` helper may also be used to set configuration variables at runtime by passing an array of key / value pairs:

```php
config(['app.debug' => true]);
```

<a name="method-dd"></a>
#### `dd()`

The `dd` function dumps the given variable and ends execution of the script:

```php
dd($value);
```

<a name="method-env"></a>
#### `env()`

The `env` function gets the value of an environment variable or returns a default value:

```php
$env = env('APP_ENV');

// Return a default value if the variable doesn't exist...
$env = env('APP_ENV', 'production');
```

<a name="method-input"></a>
#### `input()`

The `input` function obtains an input item from all request values, including files.

```php
$value = input('key', $default = null)
```

<a name="method-get"></a>
#### `get()`

The `get` function obtains an input item from the request, restricted to GET variables only:

```php
$value = get('key', $default = null)
```

<a name="method-post"></a>
#### `post()`

The `post` function obtains an input item from the request, restricted to POST variables only:

```php
$value = post('key', $default = null)
```

<a name="method-files"></a>
#### `files()`

The `files` function obtains an file item from the request:

```php
$value = files('key', $default = null)
```

<a name="method-redirect"></a>
#### `redirect()`

The `redirect` function return an instance of the redirector to do [redirect responses](./response-view.md):

```php
return redirect('/home');
```

<a name="method-request"></a>
#### `request()`

The `request` function returns the current [request instance](./request-input.md):

```php
$referer = request()->header('referer');
```

<a name="method-response"></a>
#### `response()`

The `response` function creates a [response](./response-view.md) instance or obtains an instance of the response factory:

```php
return response('Hello World', 200, $headers);

return response()->json(['foo' => 'bar'], 200, $headers);
```

<a name="method-route"></a>
#### `route()`

The `route` function generates a URL for the given [named route](../system/routing.md):

```php
$url = route('routeName');
```

If the route accepts parameters, you may pass them as the second argument to the method:

```php
$url = route('routeName', ['id' => 1]);
```

<a name="method-secure-asset"></a>
#### `secure_asset()`

Generate a URL for an asset using HTTPS:

```php
echo secure_asset('foo/bar.zip', $title, $attributes = []);
```

<a name="method-trace-log"></a>
#### `trace_log()`

The `trace_log` function writes a trace message to the log file.

```php
trace_log('This code has passed...');
```

The function supports passing exceptions, arrays and objects:

```php
trace_log($exception);

trace_log($array);

trace_log($object);
```

You may also pass multiple arguments to trace multiple messages:

```php
trace_log($value1, $value2, $exception, '...');
```

<a name="method-trace-sql"></a>
#### `trace_sql()`

The `trace_sql` function enables database logging and begins to monitor all SQL output.

```php
trace_sql();

Db::table('users')->count();

// select count(*) as aggregate from users
```

<a name="method-url"></a>
#### `url()`

The `url` function generates a fully qualified URL to the given path:

```php
echo url('user/profile');

echo url('user/profile', [1]);
```
# Validation

The validator class is a simple, convenient facility for validating data and retrieving validation error messages via the `Validator` class. It is useful when processing form data submitted by the end user.

::: tip
When working with models, October CMS ships with a useful [Validation Trait](../database/traits.md) that implements the `Validator` class and supports the same rule definitions.
:::

Below is a list of all available validation rules:

<div class="content-list" markdown="1">

- [Accepted](#rule-accepted)
- [Active URL](#rule-active-url)
- [After (Date)](#rule-after)
- [Alpha](#rule-alpha)
- [Alpha Dash](#rule-alpha-dash)
- [Alpha Numeric](#rule-alpha-num)
- [Array](#rule-array)
- [Before (Date)](#rule-before)
- [Between](#rule-between)
- [Boolean](#rule-boolean)
- [Confirmed](#rule-confirmed)
- [Date](#rule-date)
- [Date Format](#rule-date-format)
- [Different](#rule-different)
- [Digits](#rule-digits)
- [Digits Between](#rule-digits-between)
- [E-Mail](#rule-email)
- [Exists (Database)](#rule-exists)
- [Image (File)](#rule-image)
- [In](#rule-in)
- [Integer](#rule-integer)
- [IP Address](#rule-ip)
- [Max](#rule-max)
- [MIME Types](#rule-mimes)
- [Min](#rule-min)
- [Not In](#rule-not-in)
- [Nullable](#rule-nullable)
- [Numeric](#rule-numeric)
- [Regular Expression](#rule-regex)
- [Required](#rule-required)
- [Required If](#rule-required-if)
- [Required Unless](#rule-required-unless)
- [Required With](#rule-required-with)
- [Required With All](#rule-required-with-all)
- [Required Without](#rule-required-without)
- [Required Without All](#rule-required-without-all)
- [Same](#rule-same)
- [Size](#rule-size)
- [String](#rule-string)
- [Timezone](#rule-timezone)
- [Unique (Database)](#rule-unique)
- [URL](#rule-url)

</div>

## Basic Usage

In most cases you should first capture the user input and pass it to the `make` method (first argument) and include the validation rules that should be applied to the data (second argument). In the following example, we capture the postback user input with the `post()` helper function.

```php
$data = post();

$validator = Validator::make($data, [
    'name' => 'required|min:5'
]);
```

Multiple rules may be delimited using either a "pipe" character, or as separate elements of an array.

```php
$validator = Validator::make($data, [
    'name' => ['required', 'min:5']
]);
```

To validate multiple fields, simply add them to the array.

```php
$data = [
    'name' => 'Joe',
    'password' => 'lamepassword',
    'email' => 'email@example.tld'
];

$validator = Validator::make($data, [
    'name' => 'required',
    'password' => 'required|min:8',
    'email' => 'required|email|unique:users'
]);
```

### Checking the Validation Results

Once a `Validator` instance has been created, the `fails` (or `passes`) method may be used to perform the validation.

```php
if ($validator->fails()) {
    // The given data did not pass validation
}
```

If validation has failed, you may retrieve the error messages from the validator.

```php
$messages = $validator->messages();
```

You may also access an array of the failed validation rules, without messages. To do so, use the `failed` method:

```php
$failed = $validator->failed();
```

### Validating Files

The `Validator` class provides several rules for validating files, such as `size`, `mimes`, and others. When validating files, you may simply pass them into the validator with your other data.

```php
$data = files() + post();

$validator = Validator::make($data, [...]);
```

::: warning
It is not recommended to use unfiltered `input()` values here since it contains GET values that can be used to potentially craft malicious links.
:::

## Throwing a Validation Exception

In most cases, you'll be validating user input submitted using a form, and if validation fails, throwing a `ValidationException` is a compatible action. As a shorter way to validate the form, you can use the `validate` method directly.

```php
$data = Validator::validate($data, $rules);
```

::: tip
The `validate` method returns filtered user data, the attributes and values that were validated.
:::

The above method performs the equivalent functionality as the following code. It also demonstrates how you can pass the validator instance directly to the [validation exception](../system/exceptions.md) (first argument).

```php
$validation = Validator::make($data, $rules);

if ($validation->fails()) {
    throw new ValidationException($validation);
}
```

### Validating the Request

Another option is to use the `Request` facade to perform validation on all user input. This removes the need to supply the data so you can just supply the rules (first argument). The `validate` method returns filtered user data, the attributes and values that were validated.

```php
$data = Request::validate($rules);
```

The return value from `validate` is filtered by the validation rules. If the field is not defined in the rules, it won't be included in this data.

## Working with Error Messages

After calling the `messages` method on a `Validator` instance, you will receive a `Illuminate\Support\MessageBag` instance, which has a variety of convenient methods for working with error messages.

#### Retrieving the first error message for a field

```php
echo $messages->first('email');
```

#### Retrieving all error messages for a field

```php
foreach ($messages->get('email') as $message) {
    //
}
```

#### Retrieving all error messages for all fields

```php
foreach ($messages->all() as $message) {
    //
}
```

#### Determining if messages exist for a field

```php
if ($messages->has('email')) {
    //
}
```

#### Retrieving an error message with a format

```php
echo $messages->first('email', '<p>:message</p>');
```

> **Note**: By default, messages are formatted using Bootstrap compatible syntax.

#### Retrieving all error messages with a format

```php
foreach ($messages->all('<li>:message</li>') as $message) {
    //
}
```

## Error Messages & Views

Once you have performed validation, you will need an easy way to get the error messages back to your views. This is conveniently handled by October CMS. Consider the following AJAX handler as an example:

```php
public function onRegister()
{
    $rules = [];

    $validator = Validator::make(input(), $rules);

    if ($validator->fails()) {
        return Redirect::to('register')->withErrors($validator);
    }
}
```

Note that when validation fails, we pass the `Validator` instance to the Redirect using the `withErrors` method. This method will flash the error messages to the session so that they are available on the next request.

October CMS will always check for errors in the session data, and automatically bind them to the view if they are available. **So, it is important to note that an `errors` variable will always be available in all of your pages, on every request**, allowing you to conveniently assume the `errors` variable is always defined and can be safely used. The `errors` variable will be an instance of `MessageBag`.

So, after redirection, you may utilize the automatically bound `errors` variable in your view:

```twig
{{ errors.first('email') }}
```

### Named Error Bags

If you have multiple forms on a single page, you may wish to name the `MessageBag` of errors. This will allow you to retrieve the error messages for a specific form. Simply pass a name as the second argument to `withErrors`.

```php
return Redirect::to('register')->withErrors($validator, 'login');
```

You may then access the named `MessageBag` instance from the `$errors` variable:

```twig
{{ errors.login.first('email') }}
```

## Available Validation Rules

Below are all available validation rules and their functions.

<a name="rule-accepted"></a>
#### accepted

The field under validation must be _yes_, _on_, or _1_. This is useful for validating "Terms of Service" acceptance.

<a name="rule-active-url"></a>
#### active_url

The field under validation must be a valid URL according to the `checkdnsrr` PHP function.

<a name="rule-after"></a>
#### after:_date_

The field under validation must be a value after a given date. The dates will be passed into the PHP `strtotime` function.

<a name="rule-alpha"></a>
#### alpha

The field under validation must be entirely alphabetic characters.

<a name="rule-alpha-dash"></a>
#### alpha_dash

The field under validation may have alpha-numeric characters, as well as dashes and underscores.

<a name="rule-alpha-num"></a>
#### alpha_num

The field under validation must be entirely alpha-numeric characters.

<a name="rule-array"></a>
#### array

The field under validation must be of type array.

<a name="rule-before"></a>
#### before:_date_

The field under validation must be a value preceding the given date. The dates will be passed into the PHP `strtotime` function.

<a name="rule-between"></a>
#### between:_min_,_max_

The field under validation must have a size between the given _min_ and _max_. Strings, numerics, and files are evaluated in the same fashion as the `size` rule.

<a name="rule-boolean"></a>
#### boolean

The field under validation must be able to be cast as a boolean. Accepted input are `true`, `false`, `1`, `0`, `"1"` and `"0"`.

<a name="rule-confirmed"></a>
#### confirmed

The field under validation must have a matching field of `foo_confirmation`. For example, if the field under validation is `password`, a matching `password_confirmation` field must be present in the input.

<a name="rule-date"></a>
#### date

The field under validation must be a valid date according to the `strtotime` PHP function.

<a name="rule-date-format"></a>
#### date_format:_format_

The field under validation must match the _format_ defined according to the `date_parse_from_format` PHP function.

<a name="rule-different"></a>
#### different:_field_

The given _field_ must be different than the field under validation.

<a name="rule-digits"></a>
#### digits:_value_

The field under validation must be _numeric_ and must have an exact length of _value_.

<a name="rule-digits-between"></a>
#### digits_between:_min_,_max_

The field under validation must have a length between the given _min_ and _max_.

<a name="rule-email"></a>
#### email

The field under validation must be formatted as an e-mail address.

<a name="rule-exists"></a>
#### exists:_table_,_column_

The field under validation must exist on a given database table.

#### Basic usage of exists rule

```php
'state' => 'exists:states'
```

#### Specifying a custom column name

```php
'state' => 'exists:states,abbreviation'
```

You may also specify more conditions that will be added as "where" clauses to the query:

```php
'email' => 'exists:staff,email,account_id,1'
```

Passing `NULL` as a "where" clause value will add a check for a `NULL` database value:

```php
'email' => 'exists:staff,email,deleted_at,NULL'
```

<a name="rule-image"></a>
#### image

The file under validation must be an image (jpeg, png, bmp, or gif)

<a name="rule-in"></a>
#### in:_foo_,_bar_,...

The field under validation must be included in the given list of values.

<a name="rule-integer"></a>
#### integer

The field under validation must have an integer value.

<a name="rule-ip"></a>
#### ip

The field under validation must be formatted as an IP address.

<a name="rule-max"></a>
#### max:_value_

The field under validation must be less than or equal to a maximum _value_. Strings, numerics, and files are evaluated in the same fashion as the [`size`](#rule-size) rule.

<a name="rule-mimes"></a>
#### mimes:_foo_,_bar_,...

The file under validation must have a MIME type corresponding to one of the listed extensions.

#### Basic usage of MIME rule

```php
'photo' => 'mimes:jpeg,bmp,png'
```

<a name="rule-min"></a>
#### min:_value_

The field under validation must have a minimum _value_. Strings, numerics, and files are evaluated in the same fashion as the [`size`](#rule-size) rule.

<a name="rule-not-in"></a>
#### not_in:_foo_,_bar_,...

The field under validation must not be included in the given list of values.

<a name="rule-nullable"></a>
#### nullable

The field under validation may be `null`. This is particularly useful when validating primitive such as strings and integers that can contain `null` values.

<a name="rule-numeric"></a>
#### numeric

The field under validation must have a numeric value.

<a name="rule-regex"></a>
#### regex:_pattern_

The field under validation must match the given regular expression.

**Note:** When using the `regex` pattern, it may be necessary to specify rules in an array instead of using pipe delimiters, especially if the regular expression contains a pipe character.

<a name="rule-required"></a>
#### required

The field under validation must be present in the input data.

<a name="rule-required-if"></a>
#### required_if:_field_,_value_,...

The field under validation must be present if the _field_ field is equal to any _value_.

<a name="rule-required-unless"></a>
#### required_unless:anotherfield,value,...

The field under validation must be present and not empty unless the anotherfield field is equal to any value.

<a name="rule-required-with"></a>
#### required_with:_foo_,_bar_,...

The field under validation must be present _only if_ any of the other specified fields are present.

<a name="rule-required-with-all"></a>
#### required_with_all:_foo_,_bar_,...

The field under validation must be present _only if_ all of the other specified fields are present.

<a name="rule-required-without"></a>
#### required_without:_foo_,_bar_,...

The field under validation must be present _only when_ any of the other specified fields are not present.

<a name="rule-required-without-all"></a>
#### required_without_all:_foo_,_bar_,...

The field under validation must be present _only when_ the all of the other specified fields are not present.

<a name="rule-same"></a>
#### same:_field_

The specified _field_ value must match the field's value under validation.

<a name="rule-size"></a>
#### size:_value_

The field under validation must have a size matching the given _value_. For string data, _value_ corresponds to the number of characters. For numeric data, _value_ corresponds to a given integer value. For files, _size_ corresponds to the file size in kilobytes.

<a name="rule-string"></a>
#### string:_value_

The field under validation must be a string type.

<a name="rule-timezone"></a>
#### timezone

The field under validation must be a valid timezone identifier according to the `timezone_identifiers_list` PHP function.

<a name="rule-unique"></a>
#### unique:_table_,_column_,_except_,_idColumn_

The field under validation must be unique on a given database table. If the `column` option is not specified, the field name will be used.

#### Basic usage of unique rule

```php
'email' => 'unique:users'
```

#### Specifying a custom column name

```php
'email' => 'unique:users,email_address'
```

#### Forcing a unique rule to ignore a given ID

```php
'email' => 'unique:users,email_address,10'
```

#### Adding additional where clauses

You may also specify more conditions that will be added as "where" clauses to the query:

```php
'email' => 'unique:users,email_address,NULL,id,account_id,1'
```

In the rule above, only rows with an `account_id` of `1` would be included in the unique check.

<a name="rule-url"></a>
#### url

The field under validation must be formatted as an URL.

::: tip
This function uses PHP's `filter_var` method.
:::

## Conditionally Adding Rules

In some situations, you may wish to run validation checks against a field **only** if that field is present in the input array. To quickly accomplish this, add the `sometimes` rule to your rule list:

```php
$v = Validator::make($data, [
    'email' => 'sometimes|required|email',
]);
```

In the example above, the `email` field will only be validated if it is present in the `$data` array.

#### Complex Conditional Validation

Sometimes you may wish to require a given field only if another field has a greater value than 100. Or you may need two fields to have a given value only when another field is present. Adding these validation rules doesn't have to be a pain. First, create a `Validator` instance with your _static rules_ that never change:

```php
$v = Validator::make($data, [
    'email' => 'required|email',
    'games' => 'required|numeric',
]);
```

Let's assume our web application is for game collectors. If a game collector registers with our application and they own more than 100 games, we want them to explain why they own so many games. For example, perhaps they run a game re-sell shop, or maybe they just enjoy collecting. To conditionally add this requirement, we can use the `sometimes` method on the `Validator` instance.

```php
$v->sometimes('reason', 'required|max:500', function($input) {
    return $input->games >= 100;
});
```

The first argument passed to the `sometimes` method is the name of the field we are conditionally validating. The second argument is the rules we want to add. If the `Closure` passed as the third argument returns `true`, the rules will be added. This method makes it a breeze to build complex conditional validations. You may even add conditional validations for several fields at once:

```php
$v->sometimes(['reason', 'cost'], 'required', function($input) {
    return $input->games >= 100;
});
```

::: tip
The `$input` parameter passed to your `Closure` will be an instance of `Illuminate\Support\Fluent` and may be used as an object to access your input and files.
:::

## Validating Arrays

Validating array based form input fields doesn't have to be a pain. You may use "dot notation" to validate attributes within an array. For example, if the incoming HTTP request contains a `photos[profile]` field, you may validate it like so:

```php
$validator = Validator::make(input(), [
    'photos.profile' => 'required|image',
]);
```

You may also validate each element of an array. For example, to validate that each e-mail in a given array input field is unique, you may do the following:

```php
$validator = Validator::make(input(), [
    'person.*.email' => 'email|unique:users',
    'person.*.first_name' => 'required_with:person.*.last_name',
]);
```

Likewise, you may use the `*` character when specifying your validation messages in your language files, making it a breeze to use a single validation message for array based fields:

```php
'custom' => [
    'person.*.email' => [
        'unique' => 'Each person must have a unique e-mail address',
    ]
],
```

You may also use "array notation" in your validation rules if you wish. These rules will be converted to "dot notation" automatically on validation.

```php
$validator = Validator::make(input(), [
    'photos[profile]' => 'required|image',
    'person[][email]' => 'email|unique:users',
]);
```

## Custom Error Messages

If needed, you may use custom error messages for validation instead of the defaults. There are several ways to specify custom messages. The following shows how to pass custom messages to the validator instance.

```php
$messages = [
    'required' => 'The :attribute field is required.',
];

$validator = Validator::make($input, $rules, $messages);
```

The `:attribute` placeholder will be replaced by the actual name of the field under validation. You may also utilize other placeholders in validation messages. The following shows some other validation placeholders you may encounter.

```php
$messages = [
    'same' => 'The :attribute and :other must match.',
    'size' => 'The :attribute must be exactly :size.',
    'between' => 'The :attribute must be between :min - :max.',
    'in' => 'The :attribute must be one of the following types: :values',
];
```

Sometimes you may wish to specify a custom error messages only for a specific field. The following will specify a custom message for the `email` attribute when using the **required** rule.

```php
$messages = [
    'email.required' => 'We need to know your e-mail address!',
];
```

### Specifying Custom Messages in Language Files

In some cases, you may wish to specify your custom messages in a language file instead of passing them directly to the `Validator`. To do so, add your messages to an array in the **lang/xx/validation.php** language file for your plugin.

```php
return  [
    'required' => 'We need to know your e-mail address!',
    'email.required' => 'We need to know your e-mail address!',
];
```

Then in your call to `Validator::make` use the `Lang:get` to use your custom files.

```php
Validator::make($formValues, $validations, Lang::get('acme.blog::validation'));
```

### Overriding Validation Messages Globally

The default message strings for the validator are located in the **modules/system/lang/xx/validation.php** file. We recommend opening this file to locate all the available messages.

The file contains an array of messages for each validation rule. There is a `custom` attribute for custom error messages using the "attribute.rule" naming convention, and a `attributes` attribute to store custom attribute names.

```php
return [
    'required' => 'The :attribute field is required!',
    // ...

    'custom' => [
        // ...
    ],

    'attributes' => [
        // ...
    ]
];
```

You can modify any of these values by creating a new file in the app directory, for example, for the `en` locale, create a file called **app/lang/system/en/validation.php**. The values inside this file will override the default values and you can include just the values you want modified.

```php
return [
    'required' => 'Sorry, we need that field (:attribute) you gave!',

    'attributes' => [
        'email' => 'email address'
    ],
];
```

## Custom Validation Rules

There are a variety of helpful validation rules, however, you may wish to specify some of your own. First you should decide if your rule should be registered globally, or use a local rule object.

### Globally Registered Rules

A globally registered rule can be shared throughout your application by registering it with a tag and rule class. This is typically done in the `register` method of a [plugin registration file](../extending.md) using the `registerValidationRule` helper method.

```php
public function register()
{
    $this->registerValidationRule('uppercase', UppercaseRule::class);
}
```

In this instance, we have created a rule tagged **uppercase** and referenced our rule class where it becomes available to specify as a rule everywhere.

```php
Validator::make($data, [
    'shoutout' => 'required|uppercase',
]);
```

#### Defining a Global Rule Class

A global rule class represents a single reusable validation rule for your models. At a minimum, the rule class must provide a `validate` method that determines if the validation rule passes. You may also specify an optional `message` method to return a custom error message.

```php
class UppercaseRule
{
    /**
     * validate determines if the validation rule passes.
     * @param string $attribute
     * @param mixed $value
     * @param array $params
     * @return bool
     */
    public function validate($attribute, $value, $params)
    {
        return strtoupper($value) === $value;
    }

    /**
     * message gets the validation error message.
     * @return string
     */
    public function message()
    {
        return 'The :attribute must be uppercase.';
    }
}
```

#### Passing Arguments to Rules

Global rules can support passing arguments along with their definition. For example, a rule called **betwixt** may require two values. Parameters can be passed to a rule by separating with a colon (`:`) and each parameter is seperated by a comma (`,`).

```php
$v = Validator::make($data, [
    'name' => 'betwixt:1,6',
]);
```

The parameters are then passed to the validate method and become available. The error message can also be processed by defining a `replace` method.

```php
class BetwixtRule
{
    /**
     * validate between start and end parameters.
     */
    public function validate($attribute, $value, $params)
    {
        [$start, $end] = $params;

        return strlen($value) > $start && strlen($value) < $end;
    }

    /**
     * message gets the validation error message.
     * @return string
     */
    public function message()
    {
        return 'The :attribute must be between :start and :end.';
    }

    /**
     * replace defines custom placeholder replacements.
     * @return string
     */
    public function replace($message, $attribute, $rule, $params)
    {
        [$start, $end] = $params;

        $message = str_replace(':start', $start, $message);

        $message = str_replace(':end', $end, $message);

        return $message;
    }
}
```

### Local Rule Objects

The [Laravel documentation on rule objects](https://laravel.com/docs/6.x/validation#using-rule-objects) describes in more detail how to define a rule class. Specifically, the rule must implement the `Illuminate\Contracts\Validation\Rule` contract which requires a `passes` method to be defined.

```php
class LowercaseRule implements \Illuminate\Contracts\Validation\Rule
{
    /**
     * passes checks if the rule is successful
     * @param  string  $attribute
     * @param  mixed  $value
     * @return bool
     */
    public function passes($attribute, $value)
    {
        return strtolower($value) === $value;
    }

    /**
     * message gets the validation error message.
     * @return string
     */
    public function message()
    {
        return 'The :attribute must be lowercase.';
    }
}
```

Once a rule is defined, it can be passed as an insatance to the `Validator` service.

```php
$v = Validator::make($data, [
    'name' => ['required', new LowercaseRule],
]);
```

You may also implement the rule object in models using the `beforeValidate` method override.

```php
public function beforeValidate()
{
    $this->rules['name'] = ['required', new LowercaseRule];
}
```

#### See Also

::: also
* [Laravel Validation Documentation](https://laravel.com/docs/10.x/validation)
:::
# Response & View

## Basic Responses

A response can be returned from almost PHP method that is used by the page. This includes all the CMS methods contained in the [Layout Execution Life Cycle](../../cms/themes/layouts.md) and [AJAX handler definitions](../../cms/ajax/handlers.md).

#### Returning strings from a CMS method

Returning a string from a CMS page, layout or component method will halt the process at this point and override the default behavior, so here it will display the "Hello World" string instead of displaying the page.

```php
public function onStart()
{
    return 'Hello World';
}
```

#### Returning strings from AJAX handlers

Returning a string from an AJAX handler will add the string to the response collection using the default key of `result`. Requested partials will still be included in the response.

```php
public function onDoSomething()
{
    return 'Hello World';
    // ['result' => 'Hello World']
}
```

#### Returning strings from routes

Returning a string from a [route definition](../system/routing.md) will act the same as a CMS method and display the string as the response.

```php
Route::get('/', function() {
    return 'Hello World';
});
```

#### Creating custom responses

For a more robust solution, returning a `Response` object providing a variety of methods for building HTTP responses. We will explore this topic further in this article.

```php
$contents = 'Page not found';
$statusCode = 404;
return Response::make($contents, $statusCode);
```

### Attaching Headers to Responses

Keep in mind that most response methods are chainable, allowing for the fluent building of responses. For example, you may use the `header` method to add a series of headers to the response before sending it back to the user:

```php
return Response::make($content)
    ->header('Content-Type', $type)
    ->header('X-Header-One', 'Header Value')
    ->header('X-Header-Two', 'Header Value');
```

A practical example of this could be returning an XML response:

```php
return Response::make($xmlString)->header('Content-Type', 'text/xml');
```

### Attaching Cookies to Responses

The `withCookie` method  allows you to easily attach cookies to the response. For example, you may use the withCookie method to generate a cookie and attach it to the response instance:

```php
return Response::make($content)->withCookie('name', 'value');
```

The `withCookie` method accepts additional optional arguments which allow you to further customize your cookie's properties:

```php
->withCookie($name, $value, $minutes, $path, $domain, $secure, $httpOnly)
```

## Other Response Types

The `Response` facade may be used to conveniently generate other types of response instances.

### View Responses

If you need access to the `Response` class methods, but want to return a view as the response content, you may use the `Response::view` method for convenience:

```php
return Response::view('acme.blog::hello')->header('Content-Type', $type);
```

### JSON Responses

The `json` method will automatically set the `Content-Type` header to application/json, as well as convert the given array into JSON using the `json_encode` PHP function:

```php
return Response::json(['name' => 'Steve', 'state' => 'CA']);
```

If you would like to create a JSONP response, you may use the `json` method in addition to `setCallback`:

```php
return Response::json(['name' => 'Steve', 'state' => 'CA'])
    ->setCallback(Input::get('callback'));
```

### File Downloads

The `download` method may be used to generate a response that forces the user's browser to download the file at the given path (first argument). The `download` method optionally accepts a file name (second argument), which will determine the file name that is seen by the user downloading the file, and an array of HTTP headers (third argument).

```php
return Response::download($pathToFile);

return Response::download($pathToFile, $name, $headers);

return Response::download($pathToFile)->deleteFileAfterSend(true);
```

::: tip
Symfony HttpFoundation, which manages file downloads, requires the file being downloaded to have an ASCII file name.
:::

#### Streamed Downloads

In some cases you may want to convert a string response to a downloadable response without having to write the contents to disk. Use the `streamDownload` method to solve this, the method accepts a callback (first argument), filename (second argument), and an optional array of headers (third argument).

```php
return Response::streamDownload(function() {
    echo 'CSV Contents...';
}, 'export.csv');
```

### File Responses

The `file` method is be used to display a file, such as an image or PDF, directly in the user's browser instead of initiating a download. This method accepts the path to the file (first argument) and an array of headers (second argument).

```php
return Response::file($pathToFile);

return Response::file($pathToFile, $headers);
```

## Redirects

Redirect responses are typically instances of the `Illuminate\Http\RedirectResponse` class, and contain the proper headers needed to redirect the user to another URL. The simplest way to generate a `RedirectResponse` instance is to use the `to` method on the `Redirect` facade.

```php
return Redirect::to('user/login');
```

### Returning a Redirect with Flash Data

Redirecting to a new URL and [flashing data to the session](./session.md) are typically done at the same time. So, for convenience, you may create a `RedirectResponse` instance and flash data to the session in a single method chain:

```php
return Redirect::to('user/login')->with('message', 'Login Failed');
```

::: tip
Since the `with` method flashes data to the session, you may retrieve the data using the typical `Session::get` method.
:::

#### Redirecting to the Previous URL

You may wish to redirect the user to their previous location, for example, after a form submission. You can do so by using the `back` method:

```php
return Redirect::back();

return Redirect::back()->withInput();
```

#### Redirecting to the Current Page

Sometimes you want to simply refresh the current page, you can do this using the `refresh` method:

```php
return Redirect::refresh();
```

## Response Macros

If you would like to define a custom response that you can re-use in a variety of your routes and controllers, you may use the `Response::macro` method:

```php
Response::macro('caps', function($value) {
    return Response::make(strtoupper($value));
});
```

The `macro` function accepts a name as its first argument, and a Closure as its second. The macro's Closure will be executed when calling the macro name on the `Response` class:

```php
return Response::caps('foo');
```

You may define your macros in the `boot` method of a [plugin registration file](../extending.md). Alternatively, plugins can supply a file named **init.php** in the plugin directory that you can use to place macro registrations.

## Views

Views are a great way to store system based presentation logic, such as markup used by an API or end point, or markup that is shared with the CMS and back-end areas. Views are also used by the [Mail service](../system/sending-mail.md) for providing default template content. Views are typically stored in the `views` directory of a plugin.

A simple view could look something like this:

```twig
<!-- View stored in plugins/acme/blog/views/greeting.htm -->

<html>
    <body>
        <h1>Hello, {{ name }}</h1>
    </body>
</html>
```

Views can also be parsed using PHP templating by using the `.php` extension:

```php
<!-- View stored in plugins/acme/blog/views/greeting.php -->

<html>
    <body>
        <h1>Hello, <?= $name ?></h1>
    </body>
</html>
```

This view may be returned to the browser using the `View::make` method:

```php
return View::make('acme.blog::greeting', ['name' => 'Charlie']);
```

The first argument is a "path hint" that contains the plugin name, separated by two colons `::`, followed by the view file name. The second argument passed to `View::make` is an array of data that should be made available to the view.

::: tip
The path hint is case sensitive and the plugin name should always be in lowercase.
:::

#### Passing Data to Views

```php
// Using conventional approach
$view = View::make('acme.blog::greeting')->with('name', 'Steve');

// Using magic methods
$view = View::make('acme.blog::greeting')->withName('steve');
```

In the example above the variable `name` would be accessible from the view, and would contain `Steve`. As above, if you want to pass an array of data, you may do so as the second argument given to the `make` method:

```php
$view = View::make('acme.blog::greeting', $data);
```

It is also possible to share a piece of data across all views:

```php
View::share('name', 'Steve');
```

#### Passing a Sub-view to a View

Sometimes you may wish to pass a view into another view. For example, given a sub-view stored at `plugins/acme/blog/views/child/view.php`, we could pass it to another view like so:

```php
$view = View::make('acme.blog::greeting')->nest('child', 'acme.blog::child.view');

$view = View::make('acme.blog::greeting')->nest('child', 'acme.blog::child.view', $data);
```

The sub-view can then be rendered from the parent view:

```twig
<html>
    <body>
        <h1>Hello!</h1>
        {{ child|raw }}
    </body>
</html>
```

#### Determining If a View Exists

If you need to check if a view exists, use the `View::exists` method:

```php
if (View::exists('acme.blog::mail.customer')) {
    //
}
```

#### See Also

::: also
* [Uploads & Downloads](../../cms/features/upload-download.md)
* [Laravel Responses](https://laravel.com/docs/10.x/responses)
:::
# Log

By default October is configured to create a single log file for your application which is stored in the `storage/logs` directory. You may write information to the logs using the `Log` facade.

```php
$user = User::find(1);
Log::info('Showing user profile for user: '.$user->name);
```

The logger provides the eight logging levels defined in [RFC 5424](https://datatracker.ietf.org/doc/html/rfc5424): **emergency**, **alert**, **critical**, **error**, **warning**, **notice**, **info** and **debug**.

```php
Log::emergency($error);
Log::alert($error);
Log::critical($error);
Log::error($error);
Log::warning($error);
Log::notice($error);
Log::info($error);
Log::debug($error);
```

#### Contextual Information

An array of contextual data may also be passed to the log methods. This contextual data will be formatted and displayed with the log message:

```php
Log::info('User failed to login.', ['id' => $user->id]);
```

### Helper Functions

There are some global helper methods available to make logging easier. The `trace_log` function is an alias for `Log::info` with support for using arrays and exceptions as the message.

```php
// Write a string value
$val = 'Hello world';
trace_log('The value is '.$val);

// Dump an array value
$val = ['Some', 'array', 'data'];
trace_log($val);

// Trace an exception
try {
    //
}
catch (Exception $ex) {
    trace_log($ex);
}
```

The `trace_sql` function enables database logging, when called it will log every command sent to the database. These records only appear in the `system.log` file and will not appear in the backend panel log as this is stored in the database and would result in a feedback loop.

```php
trace_sql();

Db::table('users')->count();

// select count(*) as aggregate from users
```
# Queue

Queues allow you to defer the processing of a time consuming task, such as sending an e-mail, until a later time, thus drastically speeding up the web requests to your application.

## Configuration

The queue configuration file is stored in `config/queue.php`. In this file you will find connection configurations for each of the queue drivers that are included, such as a database, [Beanstalkd](https://beanstalkd.github.io), [Amazon SQS](https://aws.amazon.com/sqs/), [Redis](https://redis.io), null, and synchronous (for local use) driver. The `null` queue driver simply discards queued jobs so they are never executed.

### Driver Prerequisites

The following dependencies are needed for the listed queue drivers. These dependencies may be installed via the Composer package manager.

Connection | Package
------------- | -------------
Amazon SQS | `aws/aws-sdk-php ~3.0`
Beanstalkd | `pda/pheanstalk ~4.0`
Redis      | `predis/predis ~1.0` or phpredis PHP extension

## Basic Usage

To push a new job onto the queue, use the `Queue::push` method.

```php
Queue::push(SendEmail::class, ['message' => $message]);
```

The first argument given to the `push` method is the name of the class that should be used to process the job. The second argument is an array of data that should be passed to the handler. A job handler could be defined as a file **app/SendEmail.php** like so.

```php
class SendEmail
{
    public function fire($job, $data)
    {
        //
    }
}
```

Notice the only method that is required is `fire`, which receives a `Job` instance as well as the array of `data` that was pushed onto the queue. If you want the job to use a method other than `fire`, you may specify the method when you push the job:

```php
Queue::push('SendEmail@send', ['message' => $message]);
```

#### Specifying a queue name for a job

You may also specify the queue / tube a job should be sent to:

```php
Queue::push('SendEmail@send', ['message' => $message], 'emails');
```

#### Delaying the execution of a job

Sometimes you may wish to delay the execution of a queued job. For instance, you may wish to queue a job that sends a customer an e-mail 15 minutes after sign-up. You can accomplish this using the `Queue::later` method:

```php
$date = Carbon::now()->addMinutes(15);

Queue::later($date, 'SendEmail', ['message' => $message]);
```

In this example, we're using the [Carbon](https://github.com/briannesbitt/Carbon) date library to specify the delay we wish to assign to the job. Alternatively, you may pass the number of seconds you wish to delay as an integer.

> **Note**: The Amazon SQS service has a delay limit of 900 seconds (15 minutes).

#### Queues and models

If your queued job takes a model in its data, only the identifier for the model will be serialized onto the queue. When the job is actually handled, the queue system will automatically re-retrieve the full model instance from the database. It's all totally transparent to your application and prevents issues that can arise from serializing full model instances.

#### Deleting a processed job

Once you have processed a job, it must be deleted from the queue, which can be done via the `delete` method on the `Job` instance:

```php
public function fire($job, $data)
{
    // Process the job...

    $job->delete();
}
```

#### Releasing a job back onto the queue

If you wish to release a job back onto the queue, you may do so via the `release` method:

```php
public function fire($job, $data)
{
    // Process the job...

    $job->release();
}
```

You may also specify the number of seconds to wait before the job is released:

```php
$job->release(5);
```

#### Checking the number of run attempts

If an exception occurs while the job is being processed, it will automatically be released back onto the queue. You may check the number of attempts that have been made to run the job using the `attempts` method:

```php
if ($job->attempts() > 3) {
    //
}
```

#### Accessing the job ID

You may also access the job identifier:

```php
$job->getJobId();
```

## Queueing closures

You may also push a Closure onto the queue. This is very convenient for quick, simple tasks that need to be queued:

#### Pushing a closure onto the queue

```php
Queue::push(function($job) use ($id) {
    Account::delete($id);

    $job->delete();
});
```

::: tip
Instead of making objects available to queued Closures via the `use` directive, consider passing primary keys and re-pulling the associated models from within your queue job. This often avoids unexpected serialization behavior.
:::

## Running the queue worker

October CMS includes some console commands that will process jobs in the queue. To process new jobs as they are pushed onto the queue, run the `queue:work` command:

```bash
php artisan queue:work
```

Once this task has started, it will continue to run until it is manually stopped. You may use a process monitor such as [Supervisor](#oc-supervisor-configuration) to ensure that the queue worker does not stop running.

Queue worker processes store the booted application state in memory. They will not recognize changes in your code after they have been started. When deploying changes, restart queue workers.

#### Processing a Single Job

To process only the first job on the queue, use the `--once` option:

```bash
php artisan queue:work --once
```

#### Specifying the Connection & Queue

You may also specify which queue connection the worker should utilize:

```bash
php artisan queue:work --once connection
```

You may pass a comma-delimited list of queue connections to the `work` command to set queue priorities:

```bash
php artisan queue:work --once --queue=high,low
```

In this example, jobs on the `high` queue will always be processed before moving onto jobs from the `low` queue.

#### Specifying the Job Timeout Parameter

You may also set the length of time (in seconds) each job should be allowed to run:

```bash
php artisan queue:work --once --timeout=60
```

#### Specifying Queue Sleep Duration

In addition, you may specify the number of seconds to wait before polling for new jobs:

```bash
php artisan queue:work --once --sleep=5
```

Note that the queue only "sleeps" if no jobs are on the queue. If more jobs are available, the queue will continue to work them without sleeping.

## Daemon Queue Worker

By default `queue:work` will process jobs without ever re-booting the framework. This results in a significant reduction of CPU usage when compared to the `queue:work --once` command, but at the added complexity of needing to drain the queues of currently executing jobs during your deployments.

To start a queue worker in daemon mode, simply omit the `--once` flag:

```bash
php artisan queue:work connection

php artisan queue:work connection --sleep=3

php artisan queue:work connection --sleep=3 --tries=3
```

You may use the `php artisan help queue:work` command to view all of the available options.

### Deploying with daemon queue workers

The simplest way to deploy an application using daemon queue workers is to put the application in maintenance mode at the beginning of your deployment. This can be done using the back-end settings area. Once the application is in maintenance mode, October will not accept any new jobs off of the queue, but will continue to process existing jobs.

The easiest way to restart your workers is to include the following command in your deployment script:

```bash
php artisan queue:restart
```

This command will instruct all queue workers to restart after they finish processing their current job.

::: tip
This command relies on the cache system to schedule the restart. By default, APCu does not work for CLI commands. If you are using APCu, add `apc.enable_cli=1` to your APCu configuration.
:::

### Coding for daemon queue workers

Daemon queue workers do not restart the platform before processing each job. Therefore, you should be careful to free any heavy resources before your job finishes. For example, if you are doing image manipulation with the GD library, you should free the memory with `imagedestroy` when you are done.

Similarly, your database connection may disconnect when being used by long-running daemon. You may use the `Db::reconnect` method to ensure you have a fresh connection.

<a id="oc-supervisor-configuration"></a>
## Supervisor Configuration

### Installing Supervisor

Supervisor is a process monitor for the Linux operating system, and will automatically restart your `queue:work` process if it fails. To install Supervisor on Ubuntu, you may use the following command:

```bash
sudo apt-get install supervisor
```

### Configuring Supervisor

Supervisor configuration files are typically stored in the `/etc/supervisor/conf.d` directory. Within this directory, you may create any number of configuration files that instruct supervisor how your processes should be monitored. For example, let's create a `october-worker.conf` file that starts and monitors a `queue:work` process.

```ini
[program:october-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /path/to/october/artisan queue:work --sleep=3 --tries=3
autostart=true
autorestart=true
user=october
numprocs=8
redirect_stderr=true
stdout_logfile=/path/to/october/worker.log
```

In this example, the `numprocs` directive will instruct Supervisor to run 8 `queue:work` processes and monitor all of them, automatically restarting them if they fail. Of course, you should change the `queue:work` portion of the command directive to reflect your desired queue connection. The `user` directive should be changed to the name of a user that has permission to run the command.

### Starting Supervisor

Once the configuration file has been created, you may update the Supervisor configuration and start the processes using the following commands:

```bash
sudo supervisorctl reread

sudo supervisorctl update

sudo supervisorctl start october-worker:*
```

For more information on Supervisor, consult the [Supervisor documentation](http://supervisord.org/index.html).

## Failed Jobs

Since things don't always go as planned, sometimes your queued jobs will fail. Don't worry, it happens to the best of us! There is a convenient way to specify the maximum number of times a job should be attempted. After a job has exceeded this amount of attempts, it will be inserted into a `failed_jobs` table. The failed jobs table name can be configured via the `config/queue.php` configuration file.

You can specify the maximum number of times a job should be attempted using the `--tries` switch on the `queue:work` command:

```bash
php artisan queue:work connection-name --tries=3
```

If you would like to register an event that will be called when a queue job fails, you may use the `Queue::failing` method. This event is a great opportunity to notify your team via e-mail or another third party service.

```php
Queue::failing(function($connection, $job, $data) {
    //
});
```

You may also define a `failed` method directly on a queue job class, allowing you to perform job specific actions when a failure occurs:

```php
public function failed($data)
{
    // Called when the job is failing...
}
```

The original array of `data` will also be automatically passed onto the failed method.

### Retrying Failed Jobs

To view all of your failed jobs, you may use the `queue:failed` Artisan command:

```bash
php artisan queue:failed
```

The `queue:failed` command will list the job ID, connection, queue, and failure time. The job ID may be used to retry the failed job. For instance, to retry a failed job that has an ID of 5, the following command should be issued:

```bash
php artisan queue:retry 5
```

If you would like to delete a failed job, you may use the `queue:forget` command:

```bash
php artisan queue:forget 5
```

To delete all of your failed jobs, you may use the `queue:flush` command:

```bash
php artisan queue:flush
```
# Event

## Basic Usage

The `Event` class provides a simple observer implementation, allowing you to subscribe and listen for events in your application. For example, you may listen for when a user signs in and update their last login date.

```php
Event::listen('auth.login', function($user) {
    $user->last_login = new DateTime;
    $user->save();
});
```

This is event made available with the `Event::fire` method which is called as part of the user sign in logic, thereby making the logic extensible.

```php
Event::fire('auth.login', [$user]);
```

::: tip
For a list of all events available in October CMS itself, see the [API documentation](https://octobercms.com/docs/api).
:::

## Subscribing to Events

The `Event::listen` method is primarily used to subscribe to events and can be done from anywhere within your application code. The first argument is the event name.

```php
Event::listen('acme.blog.myevent', ...);
```

The second argument can be a closure that specifies what should happen when the event is fired. The closure can accept optional some arguments, provided by the firing event.

```php
Event::listen('acme.blog.myevent', function($arg1, $arg2) {
    // Do something
});
```

You may also pass a reference to any callable object or a dedicated event class and this will be used instead.

```php
Event::listen('auth.login', [$this, 'LoginHandler']);
```

::: tip
The callable method can choose to specify all, some or none of the arguments. Either way the event will not throw any errors unless it specifies too many.
:::

### Where to Register Listeners

The most common place is the `boot` method of a [plugin registration file](../extending.md).

```php
class Plugin extends PluginBase
{
    // ...

    public function boot()
    {
        Event::listen(...);
    }
}
```

Alternatively, plugins can supply a file named **init.php** in the plugin directory that you can use to place event registration logic. For example:

```php
Event::listen(...);
```

Since none of these approaches is inherently "correct", choose an approach you feel comfortable with based on the size of your application.

### Subscribe Using Priority

You may also specify a priority as the third argument when subscribing to events. Listeners with higher priority will be run first, while listeners that have the same priority will be run in order of subscription.

```php
// Run first
Event::listen('auth.login', function() { ... }, 10);

// Run second
Event::listen('auth.login', function() { ... }, 5);
```

### Halting Events

Sometimes you may wish to stop the propagation of an event to other listeners. You may do so using by returning `false` from your listener:

```php
Event::listen('auth.login', function($event) {
    // Handle the event

    return false;
});
```

### Wildcard Listeners

When registering an event listener, you may use asterisks to specify wildcard listeners. Wildcard listeners receive the event name fired first, followed by the parameters passed through to the event as an array.

The following listener handles all events that begin with `foo.`.

```php
Event::listen('foo.*', function($event, $params) {
    // Handle the event...
});
```

You may use the `Event::firing` method to determine exactly which event was fired.

```php
Event::listen('foo.*', function($event, $params) {
    if (Event::firing() === 'foo.bar') {
        // ...
    }
});
```

## Firing Events

You may use the `Event::fire` method anywhere in your code to make the logic extensible. This means other developers, or even your own internal code, can "hook" to this point of code and inject specific logic. The first argument of should be the event name.

```php
Event::fire('myevent');
```

It is always a good idea to prefix event names with your plugin namespace code, this will prevent collisions with other plugins.

```php
Event::fire('acme.blog.myevent');
```

The second argument is an array of values that will be passed as arguments to the event listener subscribing to it.

```php
Event::fire('acme.blog.myevent', [$arg1, $arg2]);
```

The third argument specifies whether the event should be a halting event, meaning it should halt if a "non null" value is returned. This argument is set to false by default.

```php
Event::fire('acme.blog.myevent', [...], true);
```

If the event is halting, the first value returned with be captured.

```php
// Single result, event halted
$result = Event::fire('acme.blog.myevent', [...], true);
```

Otherwise it returns a collection of all the responses from all the events in the form of an array.

```php
// Multiple results, all events fired
$results = Event::fire('acme.blog.myevent', [...]);
```

## Passing Arguments by Reference

When processing or filtering over a value passed to an event, you may prefix the variable with `&` to pass it by reference. This allows multiple listeners to manipulate the result and pass it to the next one.

```php
Event::fire('cms.processContent', [&$content]);
```

When listening for the event, the argument also needs to be declared with the `&` symbol in the closure definition. In the example below, the `$content` variable will have "AB" appended to the result.

```php
Event::listen('cms.processContent', function (&$content) {
    $content = $content . 'A';
});

Event::listen('cms.processContent', function (&$content) {
    $content = $content . 'B';
});
```

### Queued Events

Firing Events can be deferred in [conjunction with queues](./queue.md). Use the `Event::queue` method to "queue" the event for firing but not fire it immediately.

```php
Event::queue('foo', [$user]);
```

You may use the `Event::flush` method to flush all queued events.

```php
Event::flush('foo');
```

## Using Classes as Listeners

In some cases, you may wish to use a class to handle an event rather than a Closure. Class event listeners will be resolved out of the [Application IoC container](./application.md), providing you with the full power of dependency injection on your listeners.

### Subscribe to Individual Methods

The event class can be registered with the `Event::listen` method like any other, passing the class name as a string.

```php
Event::listen('auth.login', LoginHandler::class);
```

By default, the `handle` method on the `LoginHandler` class will be called:

```php
class LoginHandler
{
    public function handle($data)
    {
        // ...
    }
}
```

If you do not wish to use the default `handle` method, you may specify the method name that should be subscribed.

```php
Event::listen('auth.login', [LoginHandler::class, 'onLogin']);
```

### Subscribe to Entire Class

Event subscribers are classes that may subscribe to multiple events from within the class itself. Subscribers should define a `subscribe` method, which will be passed an event dispatcher instance.

```php
class UserEventHandler
{
    /**
     * subscribe register the listeners for the subscriber.
     * @param  Illuminate\Events\Dispatcher  $events
     * @return array
     */
    public function subscribe($events)
    {
        $events->listen('auth.login', [static::class, 'userLogin']);

        $events->listen('auth.logout', [static::class, 'userLogout']);
    }

    /**
     * userLogin handles user login events.
     */
    public function userLogin($event)
    {
        // ...
    }

    /**
     * userLogout handles user logout events.
     */
    public function userLogout($event)
    {
        // ...
    }
}
```

Once the subscriber has been defined, it may be registered with the `Event::subscribe` method.

```php
Event::subscribe(new UserEventHandler);
```

You may also use the [Application IoC container](./application.md) to resolve your subscriber. To do so, simply pass the name of your subscriber to the `subscribe` method.

```php
Event::subscribe(UserEventHandler::class);
```

## Event Emitter Trait

Sometimes you want to bind events to a single instance of an object. You may use an alternative event system by implementing the `October\Rain\Support\Traits\Emitter` trait inside your class.

```php
class UserManager
{
    use \October\Rain\Support\Traits\Emitter;
}
```

This trait provides a method to listen for events with `bindEvent`.

```php
$manager = new UserManager;
$manager->bindEvent('user.beforeRegister', function($user) {
    // Check if the $user is a spammer
});
```

The `fireEvent` method is used to fire events.

```php
$manager = new UserManager;
$manager->fireEvent('user.beforeRegister', [$user]);
```

These events will only occur on the local object as opposed to globally.
# Cache

## Configuration

October CMS provides a unified API for various caching systems and the cache configuration is located at `config/cache.php`. In this file you may specify which cache driver you would like used by default throughout your application. Popular caching systems like [Memcached](http://memcached.org) and [Redis](https://redis.io) are supported out of the box.

The cache configuration file also contains various other options, which are documented within the file, so make sure to read over these options. By default, October CMS is configured to use the `file` cache driver which stores the serialized, cached objects in the filesystem. For larger applications, it is recommended that you use an in-memory cache such as Memcached or APC. You may even configure multiple cache configurations for the same driver.

### Cache Prerequisites

#### Database

The `database` cache driver uses the database in lieu of the file system. There is no other configuration required to use this type as the database structure is already available.

#### Memcached

Using the Memcached cache requires the [Memcached PECL package](http://pecl.php.net/package/memcached) to be installed. The default configuration uses TCP/IP based on [Memcached::addServer](http://php.net/manual/en/memcached.addserver.php).

```php
'memcached' => [
    'servers' => [
        [
            'host' => env('MEMCACHED_HOST', '127.0.0.1'),
            'port' => env('MEMCACHED_PORT', 11211),
            'weight' => 100,
        ],
    ],
],
```

You may also set the `host` option to a UNIX socket path. If you do this, the `port` option should be set to `0`.

```php
'memcached' => [
    [
        'host' => '/var/run/memcached/memcached.sock',
        'port' => 0,
        'weight' => 100
    ],
],
```

#### Redis

::: tip
Before using a Redis cache with Laravel, you will need to either install the PhpRedis PHP extension via PECL or install the `predis/predis` package (~1.0) via Composer.
:::

The Redis configuration for your application is located in the `config/database.php` configuration file. Within this file, you will see a `redis` array containing the Redis servers used by your application:

```php
'redis' => [

    'cluster' => false,

    'default' => [
        'host'     => '127.0.0.1',
        'port'     => 6379,
        'database' => 0,
    ],

],
```

You may define an `options` array value in your Redis connection definition, allowing you to specify a set of Predis [client options](https://github.com/nrk/predis/wiki/Client-Options).

If your Redis server requires authentication, you may supply a password by adding a `password` configuration item to your Redis server configuration array.

#### DynamoDB

Before using the DynamoDB cache driver, you should create a DynamoDB cache table to store all of the cached data, typically it is named `cache`. You can name the table anything based on the value of the `stores.dynamodb.table` configuration value within your application's `cache` configuration file.

```php
'dynamodb' => [
    'table' => env('DYNAMODB_CACHE_TABLE', 'cache'),
],
```

This table should also have a string partition key with a name that corresponds to the value of the `stores.dynamodb.attributes.key` configuration item within your application's cache configuration file. By default, the partition key should be named `key`.

## Cache Usage

While most caching is handled internally by October, the `Cache` facade provides some simple methods for caching your own data.

### Retrieving Items from the Cache

The `get` method on the `Cache` facade is used to retrieve items from the cache. If the item does not exist in the cache, `null` will be returned. If you wish, you may pass a second argument to the `get` method specifying the custom default value you wish to be returned if the item doesn't exist:

```php
$value = Cache::get('key');

$value = Cache::get('key', 'default');
```

You may even pass a `Closure` as the default value. The result of the `Closure` will be returned if the specified item does not exist in the cache. Passing a Closure allows you to defer the retrieval of default values from a database or other external service:

```php
$value = Cache::get('key', function() {
    return Db::table(...)->get();
});
```

#### Checking for Item Existence

The `has` method may be used to determine if an item exists in the cache:

```php
if (Cache::has('key')) {
    //
}
```

#### Incrementing / Decrementing Values

The `increment` and `decrement` methods may be used to adjust the value of integer items in the cache. Both of these methods optionally accept a second argument indicating the amount by which to increment or decrement the item's value:

```php
Cache::increment('key');

Cache::increment('key', $amount);

Cache::decrement('key');

Cache::decrement('key', $amount);
```

#### Retrieve or Update

Sometimes you may wish to retrieve an item from the cache, but also store a default value if the requested item doesn't exist. For example, you may wish to retrieve all users from the cache or, if they don't exist, retrieve them from the database and add them to the cache. You may do this using the `Cache::remember` method:

```php
$value = Cache::remember('users', $seconds, function() {
    return Db::table('users')->get();
});
```

If the item does not exist in the cache, the `Closure` passed to the `remember` method will be executed and its result will be placed in the cache.

You may also combine the `remember` and `forever` methods:

```php
$value = Cache::rememberForever('users', function() {
    return Db::table('users')->get();
});
```

#### Retrieve and Delete

If you need to retrieve an item from the cache and then delete it, you may use the `pull` method. Like the `get` method, `null` will be returned if the item does not exist in the cache:

```php
$value = Cache::pull('key');
```

### Storing Items in the Cache

You may use the `put` method on the `Cache` facade to store items in the cache. When you place an item in the cache, you will need to specify the number of seconds for which the value should be cached:

```php
Cache::put('key', 'value', $seconds);
```

Instead of passing the number of seconds until the item expires, you may also pass a PHP `DateTime` instance representing the expiration time of the cached item:

```php
$expiresAt = Carbon::now()->addMinutes(10);

Cache::put('key', 'value', $expiresAt);
```

> **Note**: We recommend using `DateTime` instances for defining all expiry lengths, in order to ensure compatibility with future versions of October CMS.

The `add` method will only add the item to the cache if it does not already exist in the cache store. The method will return `true` if the item is actually added to the cache. Otherwise, the method will return `false`:

```php
Cache::add('key', 'value', $seconds);
```

The `forever` method may be used to store an item in the cache permanently. These values must be manually removed from the cache using the `forget` method:

```php
Cache::forever('key', 'value');
```

### Removing Items from the Cache

You may remove items from the cache using the `forget` method on the `Cache` facade:

```php
Cache::forget('key');
```

You may clear the entire caching using the `flush` method:

```php
Cache::flush();
```

Flushing the cache **does not** respect the cache prefix and will remove all entries from the cache. Consider this carefully when clearing a cache which is shared by other applications.
# Session

Since HTTP driven applications are stateless, sessions provide a way to store information about the user across requests. October CMS ships with a variety of session interfaces available for use through a unified API. Support for popular services such as [Memcached](http://memcached.org), [Redis](https://redis.io), and databases is included out of the box.

## Configuration

The session configuration is stored in `config/session.php`. Be sure to review the documented options available to you in this file.

- `file` - sessions are stored in `storage/framework/sessions`.
- `cookie` - sessions are stored in secure, encrypted cookies.
- `database` - sessions are stored in a database used by your application.
- `memcached` / `redis` - sessions are stored in one of these fast, cache based stores.
- `array` - sessions are stored in a simple PHP array and will not be persisted across requests.

By default, October CMS is configured to use the `file` session driver, which will work well for the majority of applications. The `array` driver is typically used for running unit tests to prevent session data from persisting.

## Storing Data

Using the `Session` facade you may call a variety of functions to interact with the underlying data. For example, the `put` method stores a new piece of data in the session.

```php
Session::put('key', 'value');
```

::: warning
October CMS uses the `flash` session key internally, so you should avoid using this as a key name.
:::

The `push` method may be used to push a new value onto a session value that is an array. For example, if the `user.teams` key contains an array of team names, you may push a new value onto the array like so:

```php
Session::push('user.teams', 'developers');
```

## Retrieving Data

When you retrieve a value from the session, you may also pass a default value as the second argument to the `get` method. This default value will be returned if the specified key does not exist in the session. If you pass a `Closure` as the default value to the `get` method, the `Closure` will be executed and its result returned.

```php
$value = Session::get('key');

$value = Session::get('key', 'default');

$value = Session::get('key', function() { return 'default'; });
```

If you would like to retrieve all data from the session, you may use the `all` method.

```php
$data = Session::all();
```

The `has` method may be used to check if an item exists in the session. This method will return `true` if the item exists.

```php
if (Session::has('users')) {
    //
}
```

## Deleting Data

The `pull` method will retrieve and delete an item from the session.

```php
$value = Session::pull('key', 'default');
```

The `forget` method will remove a piece of data from the session. If you would like to remove all data from the session, you may use the `flush` method.

```php
Session::forget('key');

Session::flush();
```

## Regenerating the Session

If you need to regenerate the session ID, you may use the `regenerate` method.

```php
Session::regenerate();
```

To regenerate the session ID and remove all data from the session in a single statement, you may use the `invalidate` method.

```php
Session::invalidate();
```

## Flash Data

Sometimes you may wish to store items in the session only for the next request. You may do so using the `Session::flash` method. Data stored in the session using this method will only be available during the subsequent HTTP request, and then will be deleted. Flash data is primarily useful for short-lived status messages.

```php
Session::flash('key', 'value');
```

If you need to keep your flash data around for even more requests, you may use the `reflash` method, which will keep all of the flash data around for an additional request. If you only need to keep specific flash data around, you may use the `keep` method.

```php
Session::reflash();

Session::keep(['username', 'email']);
```

#### See Also

::: also
* [Laravel HTTP Session](https://laravel.com/docs/10.x/session)
:::
# Hash & Crypt

## Configuration

When you first installed October, a random key should have been generated for you. You can confirm this by checking the `key` option of your `config/app.php` configuration file. If the key remains unchanged, you should set it to a 32 character, random string. If this value is not properly set, all encrypted values will be insecure.

## Hashing

The `Hash` facade provides secure Bcrypt hashing for storing user passwords. Bcrypt is a great choice for hashing passwords because its "work factor" is adjustable, which means that the time it takes to generate a hash can be increased as hardware power increases.

You may hash a password by calling the `make` method on the `Hash` facade:

```php
$user = new User;
$user->password = Hash::make('mypassword');
$user->save();
```

Alternatively, models can implement the [Hashable trait](../database/traits.md) to automatically hash attributes.

#### Verifying a password against a hash

The `check` method allows you to verify that a given plain-text string corresponds to a given hash.

```php
if (Hash::check('plain-text', $hashedPassword)) {
    // The passwords match...
}
```

#### Checking if a password needs to be rehashed

The `needsRehash` function allows you to determine if the work factor used by the hasher has changed since the password was hashed:

```php
if (Hash::needsRehash($hashed)) {
    $hashed = Hash::make('plain-text');
}
```

## Encryption

You may encrypt a value using the `Crypt` facade. All encrypted values are encrypted using OpenSSL and the `AES-256-CBC` cipher. Furthermore, all encrypted values are signed with a message authentication code (MAC) to detect any modifications to the encrypted string.

For example, we may use the `encrypt` method to encrypt a secret and store it on a [database model](../database/model.md):

```php
$user = new User;
$user->secret = Crypt::encrypt('shhh no telling');
$user->save();
```

#### Decrypting a value

Of course, you may decrypt values using the `decrypt` method on the `Crypt` facade. If the value can not be properly decrypted, such as when the MAC is invalid, an `Illuminate\Contracts\Encryption\DecryptException` exception will be thrown:

```php
use Illuminate\Contracts\Encryption\DecryptException;

try {
    $decrypted = Crypt::decrypt($encryptedValue);
}
catch (DecryptException $ex) {
    //
}
```

Alternatively, models can implement the [Encryptable trait](../database/traits.md) to automatically encrypt and decrypt attributes.
# Form & HTML

## Introduction

October CMS provides various helpful functions with the `Html` facade, useful for dealing with HTML and forms. While most of the examples will use the PHP language all of these features translate directly to [Twig markup](../../markup/templating.md) with a simple conversion.

```
// PHP
<?= Form::open(..) ?>

// Twig
{{ form_open(...) }}
```

As you can see above, in Twig all functions prefixed with `form_` will bind directly to the `Form` facade and provide access to the methods using *snake_case*. See the [markup guide for more information](../../markup/function/form.md) on using the form helper in the front-end.

## Opening a Form

Forms can be opened with the `Form::open` method that passes an array of attributes as the first argument:

```php
<?= Form::open(['url' => 'foo/bar']) ?>
    //
<?= Form::close() ?>
```

By default, a `POST` method will be assumed, however, you are free to specify another method:

```php
Form::open(['url' => 'foo/bar', 'method' => 'put'])
```

::: tip
Since HTML forms only support `POST` and `GET`, `PUT` and `DELETE` methods will be spoofed by automatically adding a `_method` hidden field to your form.
:::

You may pass in regular HTML attributes as well:

```php
Form::open(['url' => 'foo/bar', 'class' => 'pretty-form'])
```

If your form is going to accept file uploads, add a `files` option to your array:

```php
Form::open(['url' => 'foo/bar', 'files' => true])
```

You may also open forms that point to handler methods in your page or components:

```php
Form::open(['request' => 'onSave'])
```

#### AJAX enabled forms

Likewise, AJAX enabled forms can be opened using the `Form::ajax` method where the first argument is the handler method name:

```php
Form::ajax('onSave')
```

The second argument of `Form::ajax` should contain the attributes:

```php
Form::ajax('onSave', ['confirm' => 'Are you sure?'])
```

You can also pass partials to update as another array:

```php
Form::ajax('onSave', ['update' => [
        'control-panel' => '#controlPanel',
        'layout/sidebar' => '#layoutSidebar'
    ]
])
```

::: tip
Most [data attributes from the AJAX framework](../../cms/ajax/attributes-api.md) are available here by dropping the `data-request-` prefix.
:::

## Form Tokens

#### CSRF protection

If you have [protection enabled](../../setup/configuration.md), using the `Form::open` method with `POST`, `PUT` or `DELETE` will automatically add a CSRF token to your forms as a hidden field. Alternatively, if you wish to generate the HTML for the hidden CSRF field, you may use the `token` method:

```php
<?= Form::token() ?>
```

#### Deferred binding session key

A session key used for [deferred binding](../database/relations.md) will be added to every form as a hidden field. If you want to generate this field manually, you may use the `sessionKey` method:

```php
<?= Form::sessionKey() ?>
```

## Form Model Binding

#### Opening a model form

You may want to populate a form based on the contents of a model. To do so, use the `Form::model` method:

```php
<?= Form::model($user, ['id' => 'userForm']) ?>
```

Now when you generate a form element, like a text input, the model's value matching the field's name will automatically be set as the field value. So for example, for a text input named `email`, the user model's `email` attribute would be set as the value. If there is an item in the Session flash data matching the input name, that will take precedence over the model's value. The priority looks like this:

1. Session flash data (old input)
2. Explicitly passed value
3. Model attribute data
4. Existing postback value

This allows you to quickly build forms that not only bind to model values, but easily re-populate if there is a validation error on the server. You can manually access these values using `Form::value`:

```php
<input type="text" name="name" value="<?= Form::value('name') ?>" />
```

You may pass a default value as the second argument:

```php
<?= Form::value('name', 'John Travolta') ?>
```

::: warning
When using `Form::model`, be sure to close your form with `Form::close`!
:::

## Labels

#### Generating a label element

```php
<?= Form::label('email', 'E-Mail Address') ?>
```

#### Specifying extra HTML attributes

```php
<?= Form::label('email', 'E-Mail Address', ['class' => 'awesome']) ?>
```

::: tip
After creating a label, any form element you create with a name matching the label name will automatically receive an ID matching the label name as well.
:::

## Text Fields

#### Generating A Text Input

```php
<?= Form::text('username') ?>
```

#### Specifying a default value

```php
<?= Form::text('email', 'emailaddress@example.tld') ?>
```

::: tip
The **hidden** and **textarea** methods have the same signature as the **text** method.
:::

#### Generating a password input

```php
<?= Form::password('password') ?>
```

#### Generating other inputs

```php
<?= Form::email($name, $value = null, $attributes = []) ?>
<?= Form::file($name, $attributes = []) ?>
```

## Checkboxes and Radio Buttons

#### Generating a checkbox or radio input

```php
<?= Form::checkbox('name', 'value') ?>

<?= Form::radio('name', 'value') ?>
```

#### Generating a checkbox or radio input that is checked

```php
<?= Form::checkbox('name', 'value', true) ?>

<?= Form::radio('name', 'value', true) ?>
```

## Number

#### Generating a number input

```php
<?= Form::number('name', 'value') ?>
```

## File Input

#### Generating a file input

```php
<?= Form::file('image') ?>
```

> **Note**: The form must have been opened with the `files` option set to `true`.

## Drop-down Lists

#### Generating a drop-down list

```php
<?= Form::select('size', ['L' => 'Large', 'S' => 'Small']) ?>
```

#### Generating a drop-down list with selected default

```php
<?= Form::select('size', ['L' => 'Large', 'S' => 'Small'], 'S') ?>
```

#### Generating a grouped list

```php
<?= Form::select('animal', [
    'Cats' => ['leopard' => 'Leopard'],
    'Dogs' => ['spaniel' => 'Spaniel'],
]) ?>
```

#### Generating a drop-down list with a range

```php
<?= Form::selectRange('number', 10, 20) ?>
```

#### Generating a drop-down list with a range, selected value and blank option

```php
<?= Form::selectRange('number', 10, 20, 2, ['emptyOption' => 'Choose...']) ?>
```

#### Generating a list with month names

```php
<?= Form::selectMonth('month') ?>
```

#### Generating a list with month names, selected value and blank option

```php
<?= Form::selectMonth('month', 2, ['emptyOption' => 'Choose month...']) ?>
```

## Buttons

#### Generating a Submit Button

```php
<?= Form::submit('Click Me!') ?>
```

::: tip
Need to create a button element? Try the **button** method. It has the same signature as **submit**.
:::

## Custom Macros

#### Registering a Form Macro

It's easy to define your own custom Form class helpers called "macros". Here's how it works. First, simply register the macro with a given name and a Closure:

```php
Form::macro('myField', function() {
    return '<input type="awesome">';
})
```

Now you can call your macro using its name:

#### Calling A Custom Form Macro

```php
<?= Form::myField() ?>
```
---
subtitle: Instructions for keeping your October CMS website up to date.
---
# Updating October CMS

The `october:update` command will request updates from the October gateway. It will update the core application and plugin files, then perform a database migration.

```bash
php artisan october:update
```

## Database Migration

The `october:migrate` command will perform a database migration, creating database tables and executing seed scripts, provided by the system and [plugin version history](../plugin/updates.md). The migration command can be run multiple times, it will only execute a migration or seed script once, which means only new changes are applied.

```bash
php artisan october:migrate
```

The `--rollback` option will reverse all migrations, dropping database tables and deleting data. Care should be taken when using this command. The [plugin refresh command](../resources/installing-packages.md) is a useful alternative for debugging a single plugin.

```bash
php artisan october:migrate --rollback
```

The `--skip-errors` option will ignore any exceptions that occur during the migration process. This can be useful in cases where tables already exist, but version information should still be applied.

```bash
php artisan october:migrate --skip-errors
```

## Bleeding Edge Updates

To receive bleeding edge updates of October CMS, change the minimum stability setting to `dev`.

```bash
composer config minimum-stability dev
```

Then target the `develop` branch in the composer.json file. For example:

```json
"october/all": "dev-develop",
"october/rain": "dev-develop",
```

The `develop` branch includes updates that are not released in the stable channel yet. There can be the latest bug fixes and features, but at the same time, it can contain unfinished work. Enabling bleeding edge updates is not recommended for production environments.

::: tip
The `dev-develop` notation may also apply to some plugins and themes.
:::

## Upgrade Guide from v1 and v2

If your starting point is October CMS 2.0, please observe the following guides when performing the upgrade.

- [October CMS v3.0 Upgrade Guide](https://octobercms.com/support/article/rn-30)
- [October CMS v3.1 Stable Release](https://octobercms.com/support/article/rn-32)

If your starting point is October CMS 1.0, please observe these guides before continuing with the above guides.

- [October CMS v2.0 Upgrade Guide](https://octobercms.com/support/article/rn-13)
- [October CMS v2.1 Stable Release](https://octobercms.com/support/article/rn-27)
---
subtitle: Learn how to install and manage plugins and themes.
---
# Installing Plugins & Themes

## Project Management

October CMS includes these commands for managing your project.

### Synchronize Project

`project:sync` installs all plugins and themes belonging to a project.

```bash
php artisan project:sync
```

<a id="oc-set-project"></a>
### Set Project

`project:set` sets the license key for the current installation.

```bash
php artisan project:set <license key>
```

## Plugin Management

October CMS includes a number of commands for managing plugins.

### Install Plugin

`plugin:install` - downloads and installs the plugin by its name. The next example will install a plugin called **AuthorName.PluginName**.

```bash
php artisan plugin:install AuthorName.PluginName
```

Use the `--want` option to install a specific plugin version.

```bash
php artisan plugin:install AuthorName.PluginName --want=1.0
```

You may install a plugin from a remote source using the `--from` option.

```bash
php artisan plugin:install AuthorName.PluginName --from=git@github.com:authorname/pluginname-plugin.git
```

Use the `--want` option to specify a target branch or version.

```bash
php artisan plugin:install AuthorName.PluginName --from=git@github.com:authorname/pluginname-plugin.git --want=dev-develop
```

Use the `--oc` option if your package name has the `oc` prefix.

```bash
php artisan plugin:install AuthorName.PluginName --from=git@github.com:authorname/pluginname-plugin.git --oc
```

### Check Dependencies

`plugin:check` - performs a system wide check of installed plugin dependencies. This command will spin over every theme and plugin that is currently installed and check to see if its dependencies are also installed. If it finds any missing requirements, it will attempt to install them.

```bash
php artisan plugin:check
```

### Refresh Plugin

`plugin:refresh` - destroys the plugin's database tables and recreates them. This command is useful for development.

```bash
php artisan plugin:refresh AuthorName.PluginName
```

Use the `--rollback` option to only destroy the database tables without recreating them.

```bash
php artisan plugin:refresh AuthorName.PluginName --rollback
```

You may also specify a version number with the `--rollback` option to stop at a specified version.

```bash
php artisan plugin:refresh AuthorName.PluginName --rollback=1.0.3
```

### List Plugins

`plugin:list` - Displays a list of installed plugins and their version numbers.

```bash
php artisan plugin:list
```

### Disable Plugin

`plugin:disable` - Disable an existing plugin.

```bash
php artisan plugin:disable AuthorName.PluginName
```

### Enable Plugin

`plugin:enable` - Enable a disabled plugin.

```bash
php artisan plugin:enable AuthorName.PluginName
```

### Remove Plugin

`plugin:remove` - destroys the plugin's database tables and deletes the plugin files from the filesystem.

```bash
php artisan plugin:remove AuthorName.PluginName
```

## Theme Management

October includes a number of commands for managing themes.

### Install Theme

`theme:install` - download and install a theme from the [Marketplace](https://octobercms.com/themes/). The following example will install the theme in `/themes/authorname-themename`

```bash
php artisan theme:install AuthorName.ThemeName
```

You may install a theme from a remote source using the `--from` option.

```bash
php artisan theme:install AuthorName.ThemeName --from=git@github.com:authorname/themename-theme.git
```

Use the `--want` option to specify a target branch or version.

```bash
php artisan theme:install AuthorName.ThemeName --from=git@github.com:authorname/themename-theme.git --want=dev-develop
```

Use the `--oc` option if your package name has the `oc` prefix.

```bash
php artisan theme:install AuthorName.ThemeName --from=git@github.com:authorname/oc-themename-theme.git --oc
```

### Check Protected

`theme:check` - performs a system wide check of themes to see if they should be flagged read-only and protected from changes. This command will spin over every theme and check if it has been installed with composer, if so, a [theme lock file](../cms/themes/child-themes.md) is added and a child theme is created.

```bash
php artisan theme:check
```

### List Themes

`theme:list` - list installed themes.

```bash
php artisan theme:list
```

### Enable Theme

`theme:use` - switch the active theme. The following example will switch to the theme in `/themes/rainlab-vanilla`

```bash
php artisan theme:use rainlab-vanilla
```

### Remove Theme

`theme:remove` - delete a theme. The following example will delete the directory `/themes/rainlab-vanilla`

```bash
php artisan theme:remove rainlab-vanilla
```

### Copy Theme

`theme:copy` - duplicates an existing theme to create a new one, including the creation of child themes.

```bash
php artisan theme:copy <source-theme> [destination-theme]
```
---
subtitle: Learn how to install October CMS with a local Docker environment.
---
# Installing with Laravel Sail

::: aside
Since the web server runs seperately from your operating system, commands are called using `sail artisan` instead of `php artisan`.
:::

[Laravel Sail](https://laravel.com/docs/10.x/sail) is a command-line interface for interacting with a local Docker development environment. It helps you get started by automating the process of setting up the web server and database. These instructions teach you how to use Sail and October CMS together to get up and running.

## Getting Started

The instructions to install Sail will differ depending on your operating system. Also a different build URL is used to install October CMS. By default this URL only installs the base environment with a MySQL service.

::: tip
Replace `example-app` with any directory name and this is where October CMS will be installed.
```bash
curl -s "https://octobercms.com/api/laravelsail/example-app" | bash
```
:::

With this different URL in mind, get started by following the specific Laravel guide for your operating system.

- [macOS](https://laravel.com/docs/10.x/installation#getting-started-on-macos)
- [Windows](https://laravel.com/docs/10.x/installation#getting-started-on-windows)
- [Linux](https://laravel.com/docs/10.x/installation#getting-started-on-linux)

Once everything is ready, you are prompted to run these commands to start the web server.

```bash
cd example-app
./vendor/bin/sail up
```

Next, open another console window, navigate to the same directory and run these commands to install October CMS. The database settings are preconfigured and ready to go.

```bash
./vendor/bin/sail artisan october:install
```

After the installation is complete, open the website using the `http://localhost` address.

#### See Also

::: also
* [Laravel Sail Documentation](https://laravel.com/docs/10.x/sail)
:::
---
subtitle: Learn how to set up services for sending mail.
---
# Mail Configuration

October CMS provides drivers for SMTP, Mailgun, SparkPost, Amazon SES and `sendmail`, allowing you to quickly get started sending mail through a local or cloud based service of your choice.

There are two ways to configure mail services, either using the admin panel via **Settings → Mail Settings** or by updating the default configuration values. In these examples we will update the file-based configuration values.

::: tip
​The mail settings screen in the admin panel will override the settings provided by the file-based configuration. Clicking the **Reset to Default** button will update the mail settings to the latest. If you do not click **Save** on this form, then the settings will continue to be sourced from the configuration files.
:::

## Driver Prerequisites

In most cases you can use the SMTP driver and it will be supported by most mailing providers. However, using the API-based drivers are often a simpler and faster approach.

### Mailgun driver

To use the Mailgun driver, install Symfony's Mailgun Mailer transport via Composer.

```bash
composer require symfony/mailgun-mailer symfony/http-client
```

Next, set the `driver` option in your `config/mail.php` configuration file to `mailgun`. Next, verify that your `config/services.php` configuration file contains the following options:

```php
'mailgun' => [
    'domain' => 'your-mailgun-domain',
    'secret' => 'your-mailgun-key',
    'endpoint' => 'api.mailgun.net', // api.eu.mailgun.net for EU
],
```

### Postmark Driver

To use the Postmark driver, install Symfony's Postmark Mailer transport via Composer.

```bash
composer require symfony/postmark-mailer symfony/http-client
```

Next, set the `default` option in your application's `config/mail.php` configuration file to postmark. After configuring your application's default mailer, verify that your `config/services.php` configuration file contains the following.

```php
'postmark' => [
    'token' => env('POSTMARK_TOKEN'),
],
```

### SES driver

To use the Amazon SES driver you must first install the Amazon AWS SDK for PHP. You may install this library via the Composer package manager.

```bash
composer require aws/aws-sdk-php
```

Next, set the `driver` option in your `config/mail.php` configuration file to `ses`. Then, verify that your `config/services.php` configuration file contains the following options:

```php
'ses' => [
    'key' => 'your-ses-key',
    'secret' => 'your-ses-secret',
    'region' => 'ses-region',  // e.g. us-east-1
],
```

## Mail & Local Development

When developing an application that sends e-mail, you probably don't want to actually send e-mails to live e-mail addresses. There are several ways to "disable" the actual sending of e-mail messages.

### Log Driver

One solution is to use the `log` mail driver during local development. This driver will write all e-mail messages to your log files for inspection. For more information on configuring your application per environment, check out the [configuration documentation](../setup/configuration.md).

### Universal To

Another solution is to set a universal recipient of all e-mails sent by the framework. This way, all the emails generated by your application will be sent to a specific address, instead of the address actually specified when sending the message. This can be done via the `to` option in your `config/mail.php` configuration file:

```php
'to' => [
    'address' => 'dev@example.tld',
    'name' => 'Dev Example'
],
```

### Pretend Mail Mode

You can dynamically disable sending mail using the `Mail::pretend` method. When the mailer is in pretend mode, messages will be written to your application's log files instead of being sent to the recipient.

```php
Mail::pretend();
```

#### See Also

::: also
* [Sending Mail](../extend/system/sending-mail.md)
* [SparkPost Plugin](https://github.com/rainlab/sparkpost-plugin)
:::
---
subtitle: Find out the purpose of each directory in the October CMS root folder
---
# Directory Structure

October CMS uses a modular structure where most programming features are found in either the modules or plugins directory.

## Root Directory

### App Directory

The `app` directory contains application specific code. The contents of this directory are explored in more detail after this section. In summary, this area contains business logic that doesn't belong in traditional plugins. Most of the plugin features are available in this directory.

### Bootstrap Directory

The `bootstrap` directory contains the app.php bootstrap script that loads the Laravel framework. The directory also contains the custom PHP class autoloader. Typically, files in this directory should not be modified.

### Config Directory

The `config` directory contains all the application configuration files. Each file controls how the application functions. Configuration files can be changed according to your application requirements. System updates do not modify the configuration files.

### Plugins Directory

The `plugins` directory packages that extend the core functionality of October CMS. Plugins can modify the platform by introducing new features. By default, the system loads all plugins found in the filesystem. Specific plugins can be disabled using the `system.disable_plugins` configuration parameter.

### Storage Directory

The `storage` directory contains log files, cache files, sessions and other files generated by October CMS. It includes several subdirectories:

* `app` - contains application-specific storage files, such as media files, file uploads and automatically generated resources, e.g. resized files and combined asset files.
* `framework` - used by the Laravel framework to store its generated files and caches.
* `cms` - used by the October CMS platform to store its generated files and caches.
* `logs` - contains the application's log files.
* `temp` - used to store temporary application files.

### Modules Directory

The `modules` directory contains the core packages of October CMS, providing core functionality that is common across the system. By default, modules are loaded automatically based on their presence in the file system. However, it is possible to specify which modules to load with the `system.load_modules` configuration parameter. The `system` module must be loaded at a minimum for the application to operate.

* `system` - defines the core functionality of October CMS and is a required module.
* `cms` - introduces functionality for rendering the frontend website theme. It is responsible for routing requests to pages, rendering pages and handling AJAX requests.
* `backend` - responsible for displaying the backend panel pages.
* `editor` - introduces a user interface for editing CMS templates in the backend panel.
* `media` - introduces a media file management user interface in the backend panel. It allows back-end users to upload media files like images or video files and include them in other places, for example, blog posts.
* `tailor` - introduces the October CMS Tailor features.

### Themes Directory

The `themes` directory contains subdirectories for front-end website CMS themes. CMS themes include template files for the website pages, layouts, partials, assets, and other files. The active theme is set using the `cms.active_theme` configuration parameter and can be overridden from the backend panel settings page.

### Vendor Directory

The `vendor` directory contains packages that are included via Composer. Some plugins can include the vendor directory as well. The system vendor directory takes priority over plugin-specific vendor directories.

## App Directory

The `app` directory contains application-specific files, including contents, assets and business logic that doesn't belong in a [traditional plugin](../extend/system/plugins.md). It includes a Service Provider file that is loaded by the default configuration.

### Assets Directory

The `app/assets` directory contains asset files, such as JavaScript, CSS and image files. This directory should be publically accessible to the website.

### Blueprints Directory

The `app/blueprints` directory contains [content blueprint](../cms/tailor/introduction.md) files used by Tailor.

### Others Directories

You may create any directory in here, just like a plugin, such as `models` or `controllers`. These will be autoloaded in the `App` namespace. For example, the file **app/models/Customer.php** will be available in PHP as `App\Models\Customer`.
---
subtitle: Learn how to configure and secure your server and tune up the application performance.
---
# Web Server Configuration

## Security & Performance

### Public Folder

In the default configuration, the October CMS directory sits at the root level for web access. For ultimate security in production environments, you should configure the web server to use a public folder to ensure only files in specific directories can be accessed.

First you will need to spawn a public folder using the `october:mirror` command:

```bash
php artisan october:mirror
```

It will create a new directory called `public` in the project's root directory. Inside the directory, the command creates symbolic links to assets and resources directories for all plugins, modules and themes existing in the project.

::: tip
In Apache, the server and virtual host document location is managed with the `DocumentRoot` directive.
:::

The web server configuration must be updated to point to the public directory instead of the project's root directory.

::: aside
In Windows operating systems, the `october:mirror` command can only be executed in a console running as administrator.
:::

The `october:mirror` command should be performed after each system update or when a new plugin is installed. You may instruct October CMS to run the command each time after updating the project with the Composer. The auto mirroring feature is managed with the `system.auto_mirror_public` configuration parameter.

### Improving Performance

This section describes steps that increase the application performance and is recommended for all production environments since it will drastically improve the page load time.

In the configuration, disable [debug mode](../setup/configuration.html#debug-mode) and enable the caching layers. For example, if you are using the `.env` file:

```ini
APP_DEBUG=false
CMS_ROUTE_CACHE=true
CMS_ASSET_CACHE=true
CMS_TWIG_CACHE=true
```

In the console, cache the system structure with these commands:

```bash
php artisan october:optimize

composer dump-autoload --optimize
```

### Shared Hosting Security

In shared hosting environments, extra steps must be done to protect your project files from other users that share the server with you.

::: warning
Consult with your hosting provider for suitable permission masks. The general rule is that the application files must not be accessible by other users. All files must be accessible and manageable by the owner user and the web server. Configuration files must be accessible by the owner user and web server, but the web server must not be able to change them.
:::

October CMS can automatically set permissions for new files and directories. The default permissions are managed with the `system.default_mask.file` and `system.default_mask.folder` configuration parameters. For example, if you are using the `.env` file to declare the environment variables:

```ini
DEFAULT_FILE_MASK=644
DEFAULT_FOLDER_MASK=755
```

### Using a Reverse Proxy

When using a reverse proxy, such as CloudFlare, the host server may use an insecure protocol internally and October CMS will reflect this when generating links. This can result in mixed links generated as `http://` and `https://` within the response. The `system.link_policy` setting can be used to force `secure` HTTPS links everywhere.

```ini
LINK_POLICY=secure
```

You may also `force` the application URL to be used strictly for every link, which is defined in the `app.url` configuration.

```ini
LINK_POLICY=force
```

### Safe Mode

Safe mode is an extra level of protection that prevents running arbitrary PHP code by disabling the PHP code section in the editor. Safe mode will also enable a secure Twig environment, which restricts unsafe method calls.

The `cms.safe_mode` parameter can be found in the `config/cms.php` file. By default, the value is loaded from the `CMS_SAFE_MODE` environment variable. Safe mode disables the [PHP code section](../cms/themes.md#php-code-section) in CMS templates.

The parameter can take one of the following values:

- `true` - safe mode is enabled
- `false` - safe mode is disabled
- `null` - safe mode is active if [debug mode](../setup/configuration.md#debug-mode) is disabled.

If you plan on using safe mode in production, you should also enable it for development to check that your theme works with the secure Twig environment. You may need to modify plugins to allow calling methods using the `October\Contracts\Twig\CallsAnyMethod` and `October\Contracts\Twig\CallsMethods` interfaces.

Alternatively, you can change to a more relaxed  Twig policy with the `cms.security_policy_v1` configuration value, which blocks unsafe methods instead.

```ini
CMS_SECURITY_POLICY_V1=true
```

## Server-specific Configuration

This section describes the configuration for various web servers.

::: details Apache
To run October CMS applications, the Apache server must have the following configuration:

* the [mod_rewrite module](https://httpd.apache.org/docs/2.4/mod/mod_rewrite.html) must be installed
* the [AllowOverride directive](https://httpd.apache.org/docs/2.4/mod/core.html#AllowOverride) for the application directory must have the `All` value.

In some cases you may need to uncomment the [RewriteBase directive](https://httpd.apache.org/docs/2.4/mod/mod_rewrite.html#rewritebase) in the project’s `.htaccess` file:

```text
# RewriteBase /
```

If you have installed October CMS to a subdirectory, add its name to the directive value. In this way, you can have URLs like example.tld/subdirectory/page.

```text
# RewriteBase /subdirectory/
```
:::

::: details Nginx
Use the following code in the server section of the Nginx site configuration. If you have installed October CMS into a subdirectory, replace the first `/` in location directives with the subdirectory name.

```text
location / {
    # Let October CMS handle everything by default.
    # The path not resolved by October CMS router will return October CMS's 404 page.
    # Everything that does not match with the allowlist below will fall into this.
    rewrite ^/.*$ /index.php last;
}

# Pass the PHP scripts to FastCGI server
location ~ ^/index.php {
    # Write your FPM configuration here

}

# Allowlist
location ~ ^/favicon\.ico { try_files $uri /index.php; }
location ~ ^/sitemap\.xml { try_files $uri /index.php; }
location ~ ^/robots\.txt { try_files $uri /index.php; }
location ~ ^/humans\.txt { try_files $uri /index.php; }

# Block all .dotfiles except well-known
location ~ /\.(?!well-known).* { deny all; }

## Let nginx return 404 if static file not exists
location ~ ^/storage/app/uploads/public { try_files $uri 404; }
location ~ ^/storage/app/media { try_files $uri 404; }
location ~ ^/storage/app/resources { try_files $uri 404; }
location ~ ^/storage/temp/public { try_files $uri 404; }

location ~ ^/modules/.*/assets { try_files $uri 404; }
location ~ ^/modules/.*/resources { try_files $uri 404; }
location ~ ^/modules/.*/behaviors/.*/assets { try_files $uri 404; }
location ~ ^/modules/.*/behaviors/.*/resources { try_files $uri 404; }
location ~ ^/modules/.*/widgets/.*/assets { try_files $uri 404; }
location ~ ^/modules/.*/widgets/.*/resources { try_files $uri 404; }
location ~ ^/modules/.*/formwidgets/.*/assets { try_files $uri 404; }
location ~ ^/modules/.*/formwidgets/.*/resources { try_files $uri 404; }
location ~ ^/modules/.*/reportwidgets/.*/assets { try_files $uri 404; }
location ~ ^/modules/.*/reportwidgets/.*/resources { try_files $uri 404; }

location ~ ^/plugins/.*/.*/assets { try_files $uri 404; }
location ~ ^/plugins/.*/.*/resources { try_files $uri 404; }
location ~ ^/plugins/.*/.*/behaviors/.*/assets { try_files $uri 404; }
location ~ ^/plugins/.*/.*/behaviors/.*/resources { try_files $uri 404; }
location ~ ^/plugins/.*/.*/reportwidgets/.*/assets { try_files $uri 404; }
location ~ ^/plugins/.*/.*/reportwidgets/.*/resources { try_files $uri 404; }
location ~ ^/plugins/.*/.*/formwidgets/.*/assets { try_files $uri 404; }
location ~ ^/plugins/.*/.*/formwidgets/.*/resources { try_files $uri 404; }
location ~ ^/plugins/.*/.*/widgets/.*/assets { try_files $uri 404; }
location ~ ^/plugins/.*/.*/widgets/.*/resources { try_files $uri 404; }

location ~ ^/themes/.*/assets { try_files $uri 404; }
location ~ ^/themes/.*/resources { try_files $uri 404; }
```
:::

::: details Lighttpd
Paste the following code in the Lighttpd sites configuration file and change the `host address` and `server.document-root` to match your project’s location.

```text
$HTTP["host"] =~ "domain.example.tld" {
    server.document-root = "/var/www/example/"

    url.rewrite-once = (
        "^/(plugins|modules/(system|backend|cms))/(([\w-]+/)+|/|)assets/([\w-]+/)+[-\w^&'@{}[\],$=!#().%+~/ ]+\.(jpg|jpeg|gif|png|svg|swf|avi|mpg|mpeg|mp3|flv|ico|css|js|woff|ttf)(\?.*|)$" => "$0",
        "^/(system|themes/[\w-]+)/assets/([\w-]+/)+[-\w^&'@{}[\],$=!#().%+~/ ]+\.(jpg|jpeg|gif|png|svg|swf|avi|mpg|mpeg|mp3|flv|ico|css|js|woff|ttf)(\?.*|)$" => "$0",
        "^/storage/app/uploads/public/[\w-]+/.*$" => "$0",
        "^/storage/app/media/.*$" => "$0",
        "^/storage/app/resources/.*$" => "$0",
        "^/storage/temp/public/[\w-]+/.*$" => "$0",
        "^/(favicon\.ico)$" => "$0",
        "(.*)" => "/index.php$1"
    )
}
```
:::

:::details Microsoft IIS
Use the following configuration in the `web.config` file to run October CMS on IIS:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <system.webServer>
        <rewrite>
            <rules>
                <clear />
                <rule name="October CMS to handle all non-allowlisted URLs" stopProcessing="true">
                    <match url="^(.*)$" ignoreCase="false" />
                    <conditions logicalGrouping="MatchAll">
                        <add input="{REQUEST_FILENAME}" matchType="IsFile" pattern="^/.well-known/*" negate="true" />
                        <add input="{REQUEST_FILENAME}" matchType="IsFile" pattern="^/storage/app/uploads/public/.*" negate="true" />
                        <add input="{REQUEST_FILENAME}" matchType="IsFile" pattern="^/storage/app/media/.*" negate="true" />
                        <add input="{REQUEST_FILENAME}" matchType="IsFile" pattern="^/storage/app/resources/.*" negate="true" />
                        <add input="{REQUEST_FILENAME}" matchType="IsFile" pattern="^/storage/temp/public/.*" negate="true" />
                        <add input="{REQUEST_FILENAME}" matchType="IsFile" pattern="^/themes/.*/(assets|resources)/.*" negate="true" />
                        <add input="{REQUEST_FILENAME}" matchType="IsFile" pattern="^/plugins/.*/(assets|resources)/.*" negate="true" />
                        <add input="{REQUEST_FILENAME}" matchType="IsFile" pattern="^/modules/.*/(assets|resources)/.*" negate="true" />
                    </conditions>
                    <action type="Rewrite" url="index.php" appendQueryString="true" />
                </rule>
            </rules>
        </rewrite>
    </system.webServer>
</configuration>
```
:::---
subtitle: Learn how to run scheduled tasks and queues.
---
# Setting Up the Scheduler

For scheduled tasks to operate correctly, add the following [Cron job](https://www.cyberciti.biz/faq/how-do-i-add-jobs-to-cron-under-linux-or-unix-oses/) to the server:

```bash
* * * * * php /october/artisan schedule:run >> /dev/null 2>&1
```

Be sure to replace `/october/artisan` with the absolute path to the artisan file in the October CMS installation directory. This cron job will call the command scheduler every minute. Then October CMS evaluates any scheduled tasks and runs the due tasks.

::: tip
When adding a crontab file to /etc/cron.d, specify a user name after `* * * * *`:

```bash
* * * * * alice php /october/artisan schedule:run >> /dev/null 2>&1
```
:::

## Setting Up Queue Workers

You may optionally set up a queue driver for processing [queued jobs](../extend/services/queue.md). The queue driver can be configured in the `config/queue.php` file.

For the database queue driver, you can set up a cron job running the command that invokes the first job available in the queue: `php artisan queue:work --once`.

```bash
* * * * * php /october/artisan queue:work --once >> /dev/null 2>&1
```

Alternatively, it is possible to run the queue as a daemon process with

```bash
php artisan queue:work
```

## Cron Without Command Line

If the cron table is not made available by your web host, you can instead call a public URL every X number of minutes. For example, if a plugin requires that you run the following command every 15 minutes.

```bash
php artisan campaign:run
```

This requires some PHP coding as a solution, using the `Artisan` facade along with a [routes file](../extend/system/routing.md) to build an endpoint that calls this command. For example, a **routes.php** file may contain the following.

```php
Route::get('/campaign-run', function () {
    return Artisan::call('campaign:run');
});
```

When opening the URL `/campaign-run` the artisan command will be called.

#### See Also

::: also
* [Task Scheduling](../extend/system/scheduling.md)
* [Queues](../extend/services/queue.md)
:::
---
subtitle: Deploy October CMS project to a private or shared server.
---
# Deployment

::: aside
When deploying a site to production, make sure that you have implemented the recommended [production configuration](./configuration.md).
:::

October CMS projects can be deployed using Composer with command line (shell) access, and the official Deploy plugin when shell access is limited.

## Deploying with Composer

That scenario applies if you have SSH access and have Composer installed on the target server. Deploying October CMS projects with Composer is the same as deploying any other Composer project:

* clone the project repository on the server.
* copy the `auth.json` file manually to the server.
* run `composer install` in the project directory.
* update the configuration files.

Keep in mind that the Composer's [auth.json](https://getcomposer.org/doc/articles/http-basic-authentication.md) file from your source October CMS installation must be added to the server. The file is automatically generated when you install October CMS for the first time. It includes the license key information and is required for authenticating Composer requests to the October CMS Gateway.

Alternatively, you can recreate the **auth.json** file with the `project:set` artisan command before running composer install.

```bash
php artisan project:set <license key>
```

## Deploying without Composer

If you don't have SSH access to the server or can't run Composer commands for any reason, there is an option to deploy an October CMS project using the official <LinkWithIcon text="Deploy Plugin" icon="https://d2f5cg397c40hu.cloudfront.net/storage/app/uploads/public/optimized/local/c99/b52/eb1c99b52eb1dde393bb7ef60e4c861b062.png" href="https://octobercms.com/plugin/rainlab-deploy"/>.

<VideoBlockLink src="https://www.youtube.com/watch?v=Lx9X3CfXwfw" title="Deploy Tutorial" description="This video describes how to deploy your project to a remote server without Composer." prompt="Watch the tutorial"/>

This Deploy plugin uses a local installation of October CMS to run composer commands on your own computer. The locally generated files are deployed to your server based on this installation. From there, October CMS has a one-click updater that can be used to update the installation directly on the server. If the one-click update fails, the deploy plugin can be used to repair an installation without command line access.

#### See Also

::: also
* [Production Configuration](../setup/configuration.md)
:::
---
subtitle: Learn how to configure and fine-tune October CMS.
---
# Common Configuration

All of the configuration files for October CMS are stored in the `config` directory. Each configuration parameter has inline documentation.

## Environment Configuration

Many of October CMS parameters can be configured using environment variables. Environment variables can be set on the server level, or defined for the [web application's virtual host](https://httpd.apache.org/docs/2.4/env.html).

::: aside
October CMS uses the [DotEnv library](https://github.com/vlucas/phpdotenv) to make it easy to manage environment variables.
:::

Environment variables can also be defined in the `.env` file that the installation script automatically creates in the project root directory. In a fresh installation of October CMS, the base directory contains a `.env.example` file that provides typical values for a local environment.

For example, the database connection can be specified with these variables:

```ini
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=database
DB_USERNAME=root
DB_PASSWORD=
```

Any variable in the `.env` file can be overridden by external environment variables defined on the server or virtual host level.

Configuration values are loaded in this order:

1. system environment variables
2. variables in the .env file
3. values in the configuration PHP files.

::: warning
Never add the `.env` file to source control. It would be a security risk in the event an intruder gains access to the repository.
:::

### Environment-Specific Configuration Files

If a configuration file must be loaded based on the current application environment, e.g. staging or production, you can use the server-level `APP_ENV` variable. Example Apache configuration:

```text
SetEnv APP_ENV "staging"
```

When the `APP_ENV` variable is defined, the platform attempts to load a .env file with the suffix matching the environment name. e.g. **.env.staging**. If the file does not exist, there will be no error. If both **.env.staging** and **.env** files exist, the **.env** file is completely ignored.

When using cached or [optimized configuration](./web-server-config.md), the `APP_CONFIG_CACHE` value can be specified in the **.env** file to change the cache file path. This will ensure each environment receives the correct cached configuration values.

```ini
APP_CONFIG_CACHE=storage/framework/config-staging.php
```

## Production Configuration

There are several important commonly used configuration parameters that should be established for production environments.

### Debug Mode

The `debug` parameter can be found in the `config/app.php` file, and should be disabled in production. By default, the value is loaded from the `APP_DEBUG` environment variable. After the installation, the debug mode is enabled in the `.env` file.

```ini
APP_DEBUG=false
```

When enabled, the debug mode shows detailed error messages when they occur, along with other debugging features. While useful during development, the debug mode must be disabled on a live production site. It prevents potentially sensitive information from being displayed to website visitors.

Features provided when debug mode is enabled:

- [detailed error messages](../cms/pages.md#error-page)
- failed user authentication provides a specific reason
- [combined assets](../markup/filter-theme.md) are not minified by default

### CSRF protection

October CMS provides a built-in [Cross-Site Request Forgery](https://owasp.org/www-community/attacks/csrf) prevention mechanism. When CSRF protection is enabled, October CMS stores a random token in the user's session. The [form opening tag](../extend/services/html.md#opening-a-form) and the [form token tag](../extend/services/html.md#form-tokens) add a hidden field with the token value to the form. For all POST, PUT or DELETE requests, the platform checks whether the submitted token value matches the one stored in the user session.

CSRF protection is enabled by default. The `enable_csrf_protection` parameter can be found in the `config/system.php` file. By default, the value is loaded from the `ENABLE_CSRF` environment variable.

### Public Folder

A [public folder](../setup/web-server-config.md) is recommended to be used in production environments to isolate the internal files from the public files. This is an extra layer of redundancy used in addition to the [web server configuration](../setup/web-server-config.md), which only exposes the index PHP file and static asset files.

### Setting a Fallback Theme

The [active CMS theme](../cms/themes/themes.md) is commonly sourced from the database. An issue that can occur in production environments is when the database connection fails, the demo theme or a general error screen is shown instead. To solve this, be sure to set a fallback theme in the file-based configuration.

The fallback active theme is set in the `config/cms.php` file and is loaded from the `ACTIVE_THEME` environment variable. Check to make sure this is set to a valid theme since this value will be used in the absence of a database.

```ini
ACTIVE_THEME=my-theme
```

### Disabling the Editor

One of the unique aspects of October CMS is its ability to make website updates safely in production, for example, making minor adjustments to HTML or quickly adding new pages. This is great for smaller applications, whereas larger applications may be more strict about production changes.

To disable production changes, you may remove the Editor using one of the following methods.

- load only required modules using the `system.load_modules` configuration
- do not deploy the Editor files found in the [modules directory](./directory-structure.md)
- use [permissions](../extend/backend/permissions.md) to prevent access to the Editor

::: tip
It is also a good idea to make the [app and themes directories](./directory-structure.md) read-only.
:::

Alternatively, [enable safe mode](../setup/web-server-config.md) to keep the Editor active in production. Safe mode allows updating HTML, CSS and other files, but blocks updating the PHP code section and any potentially unsafe Twig functions.

#### See Also

::: also
* [Web Server Configuration](../setup/web-server-config.md)
:::
---
subtitle: Learn how to configure the database layer.
---
# Database Configuration

The database configuration for your application is located in the `config/database.php` file. In this file you may define all of your database connections, as well as specify which connection should be used by default. Examples for all of the supported database systems are provided in this file.

## SQLite Configuration

SQLite databases use a single file on your filesystem. To create a new SQLite database, use the `touch` command.

```bash
touch storage/database.sqlite
```

After this you can configure your environment variables to use the database by placing the absolute path in the `DB_DATABASE` variable.

```text
DB_CONNECTION=sqlite
DB_DATABASE=/absolute/path/to/database.sqlite
```

## Read / Write Connections

Sometimes you may wish to use one database connection for SELECT statements, and another for INSERT, UPDATE, and DELETE statements. It is easy to specify which connection is used whether you are using raw queries, the query builder or a model.

To see how read / write connections should be configured, let's look at this example:

```php
'mysql' => [
    'read' => [
        'host' => '192.168.1.1',
    ],
    'write' => [
        'host' => '196.168.1.2'
    ],
    'driver'    => 'mysql',
    'database'  => 'database',
    'username'  => 'root',
    'password'  => '',
    'charset'   => 'utf8',
    'collation' => 'utf8_unicode_ci',
    'prefix'    => '',
],
```

Note that two keys have been added to the configuration array: `read` and `write`. Both of these keys have array values containing a single key: `host`. The rest of the database options for the `read` and `write` connections will be merged from the main `mysql` array.

We only need to place items in the `read` and `write` arrays if we wish to override the values in the main array. So, in this case, `192.168.1.1` will be used as the "read" connection, while `192.168.1.2` will be used as the "write" connection. The database credentials, prefix, character set, and all other options in the main `mysql` array will be shared across both connections.

<a id="oc-index-lengths-using-mysql-mariadb"></a>
## Index Lengths Using MySQL / MariaDB

By default, October CMS uses a `utf8mb4` character set. If running a version of MySQL older than v5.7.7 or MariaDB older than v10.2.2, you'll need to manually configure the default string length generated by migrations in order for MySQL to create indexes for them. To configure the default string length, add the following to your **config/database.php** configuration file under the key `connections.mysql`.

```php
'mysql' => [
    // ...
    'varcharmax' => 191,
],
```
---
subtitle: Learn how to install October CMS on a server.
---
# Installation

<VideoBlockLink src="https://www.youtube.com/watch?v=RHUwCvo7xng" title="Installation Tutorial" description="This video describes how to create a project, purchase a license and install October CMS for the first time." prompt="Watch the tutorial" />

## Minimum System Requirements

Before installing October CMS, ensure the target system meets the minimum requirements:

* PHP version 8.0.0 or higher
* Composer 2.0 or higher
* PDO PHP Extension
* cURL PHP Extension
* OpenSSL PHP Extension
* Mbstring PHP Extension
* ZipArchive PHP Extension
* GD PHP Extension
* SimpleXML PHP Extension.

Supported database servers:

* MySQL 5.7 or MariaDB 10.2. For older versions of MySQL or MariaDB, you may need to [configure the index lengths](../setup/database-config.md#oc-index-lengths-using-mysql-mariadb) to support the utf8mb4 character set.
* PostgreSQL 9.6
* SQLite 3.8.8.

Supported web servers:

* Apache
* Nginx
* Lighttpd
* Microsoft IIS

## Installing October CMS

::: aside
You should configure a virtual host on the web server to access the installation directory. For local development you can use [Laravel Sail](../resources/using-laravel-sail.md), [Valet](https://laravel.com/docs/valet), [Laragon](https://laragon.org/) or the built-in Laravel development server.
:::

October CMS is a PHP web application that uses [Composer](http://getcomposer.org/) to manage its dependencies. Ensure that Composer is installed before you begin. The [License Key](https://octobercms.com/help/site/projects#project-id) will be required to complete the installation.

To install the platform, initialize a project using the `create-project` command in the terminal. The following command creates a new project in a directory called *myoctober*:

```bash
composer create-project october/october myoctober
```

When the command finishes, enter the project directory:

```bash
cd myoctober
```

Run the installation command:

```bash
php artisan october:install
```

The last step is the migration command that will initialize the database. Alternatively, October CMS can initialize the database when you first access the backend panel.

```bash
php artisan october:migrate
```

When the process finishes, you can access the backend panel in a browser and create the administrator user profile. If you are using the built-in web server, you can launch it with the following command:

```bash
php artisan serve
```

::: warning
If you are installing the platform on a production web server, review the recommendations listed in the [Production Configuration](../setup/configuration.md#production-configuration) article.
:::

## Wizard Installation

<VideoBlockLink src="https://www.youtube.com/watch?v=ypyOiVCxaQg" title="Wizard Tutorial" description="This video guides you through the process of installing October CMS using the easy-to-use Wizard installer." prompt="Watch the tutorial" />

The wizard installation is an alternative way to install October CMS without using Composer. It is simpler than the command-line installation and doesn't require any special skills.

1. Prepare a directory on your server that is empty. It can be a sub-directory, domain root or a sub-domain.
1. [Download the installer archive file](https://octobercms.com/download).
1. Unpack the installer archive to the prepared directory.
1. Grant writing permissions on the installation directory and all its subdirectories and files.
1. Navigate to the `install.php` script in your web browser.
1. Follow the installation instructions.

![image](https://github.com/octobercms/docs/blob/develop/images/wizard-installer.png?raw=true)

## Troubleshooting Installation

Several typical issues can occur during or after installation.

::: details The installation freezes after entering the license key
It can happen in some environments when pasting the license key contents. Press the ENTER key several times to allow the installation process to continue.
:::

::: details An error "Unable to get local issuer certificate" is displayed during installation
The complete error may read `cURL error 60: SSL certificate problem: unable to get local issuer certificate`.

Download [this certificate file](https://curl.se/ca/cacert.pem) and save it as `cacert.pem`. Open your **php.ini** file and insert or edit the following line. You may need to restart Apache for the changes to take effect.
```
curl.cainfo = "/path/to/cacert.pem"
```
:::

::: details An error "Specified key was too long" is displayed during migration
The complete error may read `SQLSTATE[42000]: Syntax error or access violation: 1071 Specified key was too long; max key length is 767 bytes`

This can happen with older versions of MySQL or MariaDB. [Configuring the index lengths](../setup/database-config.md#index-lengths-using-mysql-mariadb) to support the utf8mb4 character set can help to resolve this issue.
:::

::: details A blank screen is displayed when opening the application
Check the permissions are set correctly on the /storage files and subdirectories. They must be writable for the web server.
:::

::: details Invalid security token error when logging in
Check to ensure no missing subdirectories in the storage/framework path. You may need to add the [sessions, cache and views directories](https://github.com/octobercms/october-private/tree/develop/storage/framework).
:::

::: details The backend panel displays "Page not found" (404)
If the application cannot find the database then a 404 page will be shown for the back-end. Try enabling [debug mode](../setup/configuration.md#debug-mode) to see the underlying error message.
:::

::: details An error 500 is displayed when updating the application
The request timeout on the web server should be increased or disabled. For example, Apache's FastCGI sometimes has the -idle-timeout option set to 30 seconds.
:::

::: details Zend OPcache API is restricted by "restrict_api" configuration directive
This issue can appear when internals try to use the OPcache internals. This can be disabled by setting the **force_bytecode_invalidation** configuration to `false` inside the **config/cms.php** file.
:::

::: details Invalid credentials (HTTP 403) for '...", aborting.
This error can appear in Composer when your project license has expired, try logging in to your account and check that the project has an active license. If the license is active, you can reset it with the `project:set` artisan command.
:::

#### See Also

::: also
* [Production Configuration](../setup/configuration.md#production-configuration)
:::
---
subtitle: Find errors and other log messages about your website.
---
# Errors & Logging

When you first start using October CMS, error and exception handling is already configured for you. There are two ways the event log can be accessed:

1. The event log can be viewed in the file system by opening the file `storage/logs/system.log`.
1. Alternatively it can be viewed via the backend panel by navigating to **Settings → Event Log**.

Log entries are always created when an error page is shown and for certain [exception types](../extend/system/exceptions.md).

## Configuration

#### Error Detail

The amount of error detail your application displays through the browser is controlled by the `debug` configuration option in your `config/app.php` configuration file. By default detailed error reporting is turned *on* so it is helpful to see detailed error information which can be useful for debugging and troubleshooting issues. When this feature is turned off, when there is a problem in a page, a generic error message will be displayed.

For local development, you should set the `debug` value to `true`. In your production environment, this value should always be `false`.

```php
/*
|--------------------------------------------------------------------------
| Application Debug Mode
|--------------------------------------------------------------------------
|
| When your application is in debug mode, detailed error messages with
| stack traces will be shown on every error that occurs within your
| application. If disabled, a simple generic error page is shown.
|
*/

'debug' => false,
```

#### Log File Modes

October CMS supports various drivers, including `single`, `daily`, `syslog` and `errorlog` logging modes. For example, if you wish to use daily log files instead of a single file, you should simply set the `default` value in your `config/logging.php` configuration file:

```php
'default' => env('LOG_CHANNEL', 'daily'),
```

#### See Also

::: also
* [Laravel Logging Documentation](https://laravel.com/docs/10.x/logging)
:::
---
subtitle: Learn how to define columns in a list structure.
---
# List Columns

List Columns are column definitions used by lists. These are referred to by the following areas.

- [Backend List Controller](../extend/lists/list-controller.md)
- [Backend Relation Controller](../extend/forms/relation-controller.md)

All list columns are identified as their individual **type** property.

```yaml
columns:
    mycolumn:
        type: number
        # ...
```

## Available Columns

The following list columns are available:

<div class="content-list-p" markdown="1">

[Text](./lists/column-text.md)
[Number](./lists/column-number.md)
[Image](./lists/column-image.md)
[Switch](./lists/column-switch.md)
[Summary](./lists/column-summary.md)
[Date & Time](./lists/column-datetime.md)
[Selectable](./lists/column-selectable.md)
[Linkage](./lists/column-linkage.md)
[Partial](./lists/column-partial.md)
[Color Picker](./lists/column-colorpicker.md)
[Currency](./lists/column-currency.md)

</div>

## Column Properties

For each column can specify these properties (where applicable):

Property | Description
------------- | -------------
**label** | a name when displaying the list column to the user.
**type** | defines how this column should be rendered.
**default** | specifies the default value for the column if value is empty.
**searchable** | include this column in the list search results. Default: `false`.
**invisible** | specifies if this column is hidden by default. Default: `false`.
**sortable** | specifies if this column can be sorted. Default: `true`.
**sortableDefault** | specifies if this column is sorted by default. This should only be used on a single sortable column. Supported values: `asc`, `desc`.
**clickable** | if set to false, disables the default click behavior when the column is clicked. Default: true.
**select** | defines a custom SQL select statement to use for the value. If a `relation` is specified, this refers to a column on the related database table.
**valueFrom** | defines a model attribute to use for the source value. If a `relation` is specified, this refers to the attribute of the relation and eager loads the relation.
**displayFrom** | defines a model attribute to use for the display value.
**relation** | defines a model relationship name as a source, used with `select` or `valueFrom`.
**relationCount** | display the number of related records as the column value. Must be used with the `relation` option. Default: `false`
**relationWith** | eager load the specified relation definition with the list query. Useful to improve performance of nested column selections.
**cssClass** | assigns a CSS class to the column container.
**headCssClass** | assigns a CSS class to the column header container.
**width** | sets the column width, can be specified in percents (10%) or pixels (50px). There could be a single column without width specified, it will be stretched to take the available space.
**align** | specifies the column alignment. Possible values are `left`, `right` and `center`.
**permissions** | the [permissions](../extend/backend/permissions.md) that the current backend user must have in order for the column to be used. Supports either a string for a single permission or an array of permissions of which only one is needed to grant access.
**order** | a numerical weight when determining the display order, default value increments at 100 points per column.
**after** | place this column after another existing column name using the display order (+1).
**before** | place this column before another existing column name using the display order (-1).
**tooltip** | adds an icon with a tooltip after the column label. See below for more detailed settings.

### Custom Value Selection

It is possible to change the source and display values for each column. If you want to source the column value from another column, do so with the `valueFrom` option.

```yaml
other_name:
    label: Something Great
    valueFrom: name
```

If you want to keep the source column value but display a different value from the model attribute, use the `displayFrom` option.

```yaml
status_code:
    label: Status
    displayFrom: status_label
```

This is mostly applicable when a [model accessor](../extend/database/mutators.md) is used to modify the display value. This is useful where you want to display a certain value, but sort and search by a different value.

```php
public function getStatusLabelAttribute()
{
    return title_case($this->status_code);
}
```

### Nested Column Selection

In some cases it makes sense to retrieve a column value from a nested data structure, such as a [model relationship](../extend/database/relations.md) column or a [jsonable array](../extend/system/models.md). The following example would look for the value in PHP equivalent of `$record->content->title` or `$record->content['title']` respectively.

```yaml
content[title]:
    name: Title
    sortable: false
```

The only drawback of doing this is the column cannot use searchable or sortable options. To make the column searchable, and for performance reasons, we recommend duplicating its value on the local database table using [model events](../extend/database/model.md). Alternatively, you can use the `relation` property described further below.

### Direct SQL Selection

The `select` property allows you to create a column using a custom select statement. Any valid SQL SELECT statement works here.

```yaml
full_name:
    label: Full Name
    select: concat(first_name, ' ', last_name)
```

### Related Column Selection

The `relation` property allows you to display related columns as part of the database query, allowing for searching and sorting of that column. The `relation` is set to the name of the [model relationship](../database/relations.md). In the next example the **name** value will be translated to the name attribute found in the related model (eg: `$model->name`).

```yaml
group_name:
    label: Group
    relation: groups
    select: name
```

To display a column that shows the number of related records, use the `relationCount` property.

```yaml
users_count:
    label: Users
    type: number
    relation: users
    relationCount: true
```

::: warning
Be careful not to name relations the same as existing database columns. For example, using a name `group_id` could break the group relation due to a naming conflict.
:::

### Tooltip

The `tooltip` property enhances list columns by adding an informational icon in the column header. Hovering over this icon displays a tooltip, offering additional context or details about the column. This feature aids in providing users with guidance or clarification for understanding column content.

```yaml
count:
    label: Count
    type: number
    tooltip: Number of users in the group
```

In addition to providing a tooltip `title`, you can also specify the `icon` ([available icons](../element/available-icons.md)) and the `placement` (`right`, `bottom`, `left`, default value is `top`) of the tooltip.

```yaml
count:
    label: Count
    type: number
    tooltip:
        title: Number of users in the group
        placement: bottom
        icon: icon-users
```
---
subtitle: Form Widget
shortname: Repeater
---
# Repeater Field

`repeater` - renders a repeating set of form fields using a related record or [jsonable attribute](../../extend/system/models.md).

```yaml
extra_information:
    type: repeater
    form:
        fields:
            added_at:
                label: Date Added
                type: datepicker
            details:
                label: Details
                type: textarea
```

The following [field properties](../form-fields.md) are supported and commonly used.

Property | Description
------------- | -------------
**label** | a name when displaying the form field to the user.
**default** | specifies a default array value, optional.
**comment** | places a descriptive comment below the field.
**form** | inline field definitions or a reference to form field definition file.
**prompt** | text to display for the create button. Default: Add new item.
**displayMode** | controls how the interface is displayed, as either **accordion** or **builder**. Default: `accordion`
**useTabs** | shows tabs when enabled, allowing fields to specify a `tab` property. Default `false`
**itemsExpanded** | if repeater items should be expanded by default when using accordion mode. Default: `true`.
**titleFrom** | name of field within items to use as the title for the collapsed item, optional.
**minItems** | minimum items required. Pre-displays those items when not using groups. For example if you set `minItems: 1` the first row will be displayed and not hidden.
**maxItems** | maximum number of items to allow within the repeater.
**groups** | references a group of form fields placing the repeater in group mode (see below). An inline definition can also be used.
**groupKeyFrom** | the group key attribute stored along with the saved data. Default: `_group`
**showReorder** | displays an interface for sorting items. Default: true
**showDuplicate** | displays an interface for cloning items. Default: true

The `titleFrom` property can be used to specify the value used when the repeater is collapsed.

```yaml
extra_information:
    type: repeater
    titleFrom: title_when_collapsed
    form:
        fields:
            # ...
            title_when_collapsed:
                label: This field is the title when collapsed
                type: text
```

The repeater fields supports the use of tabs by setting the `useTabs` property to `true`.

```yaml
extra_information:
    type: repeater
    useTabs: true
    form:
        added_at:
            label: Date added
            type: datepicker
            tab: Date
        details:
            label: Details
            type: textarea
            tab: Details
```

## Grouped Repeaters

The repeater field supports a group mode using `groups` that allows a custom set of fields to be chosen for each iteration.

```yaml
content:
    type: repeater
    prompt: Add content block
    groups: $/acme/blog/config/fields_repeater.yaml
```

This is an example of a group configuration file, which would be located in **/plugins/acme/blog/config/fields_repeater.yaml**. For better organization, the `groups` can specify one file per group definition.

```yaml
groups:
    textarea: $/acme/blog/config/fields_textarea.yaml
    quote: $/acme/blog/config/fields_quote.yaml
```

Alternatively, the definitions could be specified inline with the repeater. If the group key starts with an underscore (`_`) then it will be ignored.

```yaml
groups:
    textarea:
        name: Textarea
        description: Basic text field
        icon: icon-file-text-o
        fields:
            text_area:
                label: Text Content
                type: textarea
                size: large

    quote:
        name: Quote
        description: Quote item
        icon: icon-quote-right
        fields:
            quote_position:
                span: auto
                label: Quote Position
                type: radio
                options:
                    left: Left
                    center: Center
                    right: Right
            quote_content:
                span: auto
                label: Details
                type: textarea
```

Each group must specify a unique key and the definition supports the following options.

Option | Description
------------- | -------------
**name** | the name of the group.
**description** | a brief description of the group.
**icon** | defines an icon for the group, optional.
**titleFrom** | name of a field for the item title, optional.
**fields** | form fields belonging to the group.
**useTabs** | shows tabs for the group only, optional.

::: tip
The group key is stored along with the saved data as the `_group` attribute. This can be customized with the `groupKeyFrom` option.
:::

## Example of Using Related Records

The repeater form widget will automatically detect if the model attribute is a related field and use it. The following provides an example implementation that you may use. For example, if your model uses a `hasMany` relation that refers to a **RepeaterItem** model the repeater will use this related model for each item.

```php
public $hasMany = [
    'extra_information' => [
        RepeaterItem::class,
        'key' => 'parent_id',
        'delete' => true
    ],
];
```

A simple [database table schema](../../extend/database/structure.md) for the model can be defined that includes a reference to the parent model `id` and a serialized JSON `value` for dynamic attributes (see below).

```php
Schema::create('acme_blog_repeater_items', function($table) {
    $table->increments('id');
    $table->integer('parent_id')->unsigned()->nullable()->index();
    $table->mediumText('value')->nullable();
    $table->integer('sort_order')->nullable();
    $table->timestamps();
});
```

The model extends the `October\Rain\Database\ExpandoModel` base class to allow dynamic attributes set on the model and saved in the database, in JSON format. The model can [include attachments](../../extend/database/attachments.md) and any other related fields.

```php
use October\Rain\Database\ExpandoModel;

class RepeaterItem extends ExpandoModel
{
    use \October\Rain\Database\Traits\Sortable;

    public $table = 'acme_blog_repeater_items';

    protected $expandoPassthru = ['parent_id', 'sort_order'];

    public $attachMany = [
        'photos' => \System\Models\File::class,
    ];
}
```

Finally, the repeater item can be specified as a form field with accompanying form field definitions, including fields that use [model relationships](../../extend/database/relations.md).

```yaml
extra_information:
    type: repeater
    form:
        fields:
            title:
                label: title
            is_enabled:
                label: Enabled
                type: switch
            photos:
                label: Photos
                type: fileupload
                mode: image
```
---
subtitle: Form Widget
shortname: Data Table
---
# Data Table Field

`datatable` - renders an editable table of records, formatted as a grid. Cell content can be editable directly in the grid, allowing for the management of several rows and columns of information.

```yaml
data:
    type: datatable
    adding: true
    deleting: true
    columns: []
    recordsPerPage: false
    searching: false
```

::: tip
In order to use this with a model, the field should be defined in the [jsonable property](../../extend/system/models.md) or anything that can handle storing as an array.
:::

The following [field properties](../form-fields.md) are supported and commonly used.

Property | Description
------ | -----------
**label** | a name when displaying the form field to the user.
**default** | specifies a default string value, optional.
**comment** | places a descriptive comment below the field.
**adding** | allow records to be added to the data table. Default: `true`.
**btnAddRowLabel** | defines a custom label for the "Add Row Above" button.
**btnAddRowBelowLabel** | defines a custom label for the "Add Row Below" button.
**btnDeleteRowLabel** | defines a custom label for the "Delete Row" button.
**columns** | an array representing the column configuration of the data table. See the *Column configuration* section below.
**deleting** | allow records to be deleted from the data table. Default: `true`.
**dynamicHeight** | if `true`, the data table's height will extend or shrink depending on the records added, up to the maximum size defined by the `height` configuration value. Default: `false`.
**fieldName** | defines a custom field name to use in the POST data sent from the data table. Leave blank to use the default field alias.
**height** | the data table's height, in pixels. If set to `false`, the data table will stretch to fit the field container.
**keyFrom** | the data attribute to use for keying each record. This should usually be set to `id`. Only supports integer values.
**postbackHandlerName** | specifies the AJAX handler name in which the data table content will be sent with. When set to `null` (default), the handler name will be auto-detected from the request name used by the form which contains the data table. It is recommended to keep this as `null`.
**recordsPerPage** | the number of records to show per page. If set to `false`, the pagination will be disabled.
**searching** | allow records to be searched via a search box. Default: `false`.
**toolbar** | an array representing the toolbar configuration of the data table.

#### Column Configuration

The data table widget allows for the specification of columns as an array via the `columns` configuration variable. Each column should use the field name as a key, and the following configuration variables to set up the field.

Example:

```yaml
columns:
    id:
        type: string
        title: ID
        validation:
            integer:
                message: Please enter a number
    name:
        type: string
        title: Name
```

Option | Description
------ | -----------
**type** | the input type for this column's cells. Must be one of the following: `string`, `checkbox`, `dropdown` or `autocomplete`.
**options** | for `dropdown` and `autocomplete` columns only - this specifies the AJAX handler that will return the available options, as an array. The array key is used as the value of the option, and the array value is used as the option label.
**readOnly** | whether this column is read-only. Default: `false`.
**title** | defines the column's title.
**validation** | an array specifying the validation for the content of the column's cells. See the *Column validation* section below.
**width** | defines the width of the column, in pixels.

#### Column Validation

Column cells can be validated against the below types of validation. Validation should be specified as an array, with the type of validation used as a key, and an optional message specified as the `message` attrbute for that validation.

Validation | Description
---------- | -----------
**float** | Validates the data as a float. An optional boolean `allowNegative` attribute can be provided, allowing for negative float numbers.
**integer** | Validates the data as an integer. An optional boolean `allowNegative` attribute can be provided, allowing for negative integers.
**length** | Validates the data to be of a certain length. An integer `min` and `max` attribute must be provided, representing the minimum and maximum number of characters that must be entered.
**regex** | Validates the data against a regular expression. A string `pattern` attribute must be provided, defining the regular expression to test the data against.
**required** | Validates that the data must be entered before saving.
---
subtitle: Form UI
shortname: Section
---
# Section Field

The `section` UI element renders a section heading and subheading. The `label` and `comment` values are optional and contain the content for the heading and subheading.

```yaml
_section1:
    type: section
    label: User details
    comment: This section contains details about the user.
```

The following [field properties](../form-fields.md) are supported.

Property | Description
------------- | -------------
**label** | title text for the section.
**comment** | secondary text for the section.
**displayMode** | determines how to display the section, as either `simple` or `heading`. Default: `heading`

To display a simple comment instead of a heading in the section, set the `displayMode` property.

```yaml
_section1:
    type: section
    label: These fields are used to calculate some other fields.
    displayMode: simple
```
---
subtitle: Form Widget
shortname: Currency
---
# Currency Field

The `currency` form widget renders a field for entering a numeric currency value. This field uses the primary currency definition or the **Base Currency** setting selected [Site Definition](../../cms/resources/multisite.md) area.

::: tip
This field is introduced after installing the [Currency plugin](https://octobercms.com/plugin/responsiv-currency) available on the October CMS marketplace. You may install it with the following command.

```bash
php artisan plugin:install Responsiv.Currency
```
:::

To display a currency input, define a form field like this:

```yaml
total_amount:
    label: Total amount
    type: currency
```

Property | Description
------------- | -------------
**format** | an optional format when previewing the form field, either: `long`, `short` or `null`. Default: `null`.

Use the `format` property to change the format when displaying the form field in a preview context.

```yaml
total_amount:
    label: Total amount
    type: currency
    format: short
```

#### See Also

::: also
* [Currency Twig Filter](../../markup/filter/currency.md)
* [Currency List Column](../../element/lists/column-currency.md)
* [Currency Plugin Page](https://octobercms.com/plugin/responsiv-currency)
:::
---
subtitle: Form Widget
shortname: Code Editor
---
# Code Editor Field

`codeeditor` - renders a plaintext editor for formatted code or markup. Note the options may be inherited by the code editor preferences defined for the Administrator in the back-end.

```yaml
css_content:
    type: codeeditor
    size: huge
    language: html
```

The following [field properties](../form-fields.md) are supported and commonly used.

Property | Description
------------- | -------------
**label** | a name when displaying the form field to the user.
**default** | specifies a default string value, optional.
**comment** | places a descriptive comment below the field.
**language** | code language, for example, php, css, javascript, html. Default: `php`.
**showGutter** | shows a gutter with line numbers. Default: `true`.
**wrapWords** | breaks long lines on to a new line. Default `true`.
**fontSize** | the text font size. Default: 12.
---
subtitle: Form Widget
shortname: Date Picker
---
# Date Picker Field

`datepicker` - renders a text field used for selecting date and times.

```yaml
published_at:
    label: Published
    type: datepicker
    mode: date
```

The following [field properties](../form-fields.md) are supported and commonly used.

Property | Description
------------- | -------------
**label** | a name when displaying the form field to the user.
**default** | specifies a default string value, optional.
**comment** | places a descriptive comment below the field.
**mode** | the expected result, either `date`, `datetime` or `time`. Default: `datetime`.
**format** | provide an explicit date display format. Eg: `Y-m-d`
**minDate** | the minimum/earliest date that can be selected.
**maxDate** | the maximum/latest date that can be selected.
**yearRange** | number of years to show either side, or an array of upper/lower range, example `[1900,2015]`. Default: `10`.
**disableDays** | days that cannot be selected, can be a number to represent Sunday (`0`) to Saturday (`6`), or a specific date (`2024-10-01`).
**firstDay** | the first day of the week. Default: `0` (Sunday).
**twelveHour** | display a 12-hour clock for selecting time. Default: `false`
**showWeekNumber** | show week numbers at head of row. Default: `false`
**useTimezone** | convert the date and time from the backend specified timezone preference.

Use the `time` mode to display a time picker and toggle 24-hour or 12-hour display with the `twelveHour` property.

```yaml
birth_time:
    label: Time Born
    type: datepicker
    mode: time
    twelveHour: true
```

The `disableDays` property can be used to disable the selection of specific days.

```yaml
booking_date:
    label: Start Date
    type: datepicker
    mode: date
    disableDays:
        - 0 # Sundays
        - 6 # Saturdays
        - "2023-08-10" # Specific date
```
---
subtitle: Form Widget
shortname: Boxes
---
# Boxes Field

`boxes` - renders a box editor for building visual pages and works like a frontend page builder.

::: tip
This field is introduced after installing the [Boxes plugin](https://octobercms.com/plugin/offline-boxes) on the October CMS marketplace. Once licensed, you may install it with the following command.

```bash
php artisan plugin:install OFFLINE.Boxes
```
:::

To display the Boxes Editor in a Tailor backend form, define a form field like this:

```yaml
fields:
    boxes_content:
        label: Boxes Content
        span: adaptive  # This makes sure the Boxes Editor looks good in Tailor.
        type: boxes     # This loads the Boxes Editor.
```

In your frontend, you can then use the render method on your field to get the rendered HTML content:

::: cmstemplate
```ini
[section yourSectionVar]
handle = "Your\Handle"
entrySlug = "{{ :slug }}"
```
```twig
{{ yourSectionVar.boxes_content.render|raw }}
```
:::

#### See Also

::: also
* [Boxes Plugin Page](https://octobercms.com/plugin/offline-boxes)
:::
---
subtitle: Form Widget
shortname: Rich Editor / WYSIWYG
---
# Rich Editor / WYSIWYG Field

`richeditor` - renders a visual editor for rich formatted text, also known as a WYSIWYG editor.

```yaml
html_content:
    type: richeditor
    label: Contents
```

The following [field properties](../form-fields.md) are supported and commonly used.

Property | Description
------------- | -------------
**label** | a name when displaying the form field to the user.
**default** | specifies a default string value, optional.
**comment** | places a descriptive comment below the field.
**toolbarButtons** | buttons to show on the editor toolbar. Example: `bold|italic`
**size** | specifies a field size for fields that use it, for example, the textarea field. Options: `tiny`, `small`, `large`, `huge`, `giant`.
**showMargins** | set to `true` to include resizable document margins. Default: `false`.
**useLineBreaks** | uses line breaks instead of paragraph wrappers for each new line. Default `false`.
**editorOptions** | custom editor options used by the editor control as an array (advanced).

You may specify how large the field size should be with the `size` property.

```yaml
html_content:
    type: richeditor
    label: Contents
    size: huge
```

Use the `toolbarButtons` property to specify custom buttons.

```yaml
html_content:
    type: richeditor
    label: Contents
    toolbarButtons: bold|italic|underline
```

The double-pipe `||` character can be used to include a separator with the buttons.

```yaml
toolbarButtons: bold|italic|underline||insertPageLink||undo|redo||clearFormatting
```

The available toolbar buttons are:

<div class="content-list" markdown="1">

- fullscreen
- bold
- italic
- underline
- strikeThrough
- subscript
- superscript
- fontFamily
- fontSize
- color
- emoticons
- inlineStyle
- paragraphStyle
- paragraphFormat
- align
- formatOL
- formatUL
- outdent
- indent
- quote
- insertHR
- insertLink
- insertPageLink
- insertImage
- insertVideo
- insertAudio
- insertFile
- insertTable
- insertSnippet
- undo
- redo
- clearFormatting
- selectAll
- html

</div>

::: tip
The `|` character will insert a vertical separator line in the toolbar.
:::

## Registering a Custom Button

The following JavaScript code can be used to register a custom button as a command.

```js
oc.richEditorRegisterButton('insertCustomThing', {
    title: 'Insert Something',
    icon: '<i class="icon-star"></i>',
    undo: true,
    focus: true,
    refreshOnCallback: true,
    callback: function () {
        this.html.insert('<strong>My Custom Thing!</strong>');
    }
});
```

Then add the button to the default collection.

```js
oc.richEditorButtons.splice(0, 0, 'insertCustomThing');
```

When registering the JavaScript, it should come after the assets registered by the Rich Editor. You may extend the `RichEditor` class constructor to achieve this.

```php
\Backend\FormWidgets\RichEditor::extend(function($controller) {
    $controller->addJs('/plugins/october/test/assets/js/custom-button.js');
});
```

### Trigger a Modal from a Custom Button

Use the `oc.popup` JavaScript function to open a modal window.

```js
oc.popup({
    handler: 'onLoadPopup'
});
```

Use the `backend.ajax.beforeRunHandler` to register a global AJAX handler. The `makePartial` method can be called to render a partial with the modal contents inside.

```php
Event::listen('backend.ajax.beforeRunHandler', function ($controller, $handler) {
    if ($handler === 'onLoadPopup') {
        return $controller->makePartial('~/path/to/my/partials/_popup_form.php');
    }
});
```

## Advanced Editor Options

Use the `editorOptions` property to customize the editor options. This is an advanced property, since all options defined here are proxied directly to the editor control.

```yaml
html_content:
    type: richeditor
    editorOptions:
        imageDefaultWidth: 0
```

Some example options are listed below.

Option | Description
------ | -----------
**imageDefaultWidth** | Sets the default width of the image when it is inserted in the rich text editor. Setting it to `0` will not set any width. Default: `300`.
**imageDefaultAlign** | Sets the default image alignment when it is inserted in the rich text editor. Possible values are `left`, `center` and `right`. Default: `center`.
**imageDefaultDisplay** | Sets the default display for an image when is is inserted in the rich text. Possible options are: `inline` and `block`. Default: `block`
**imageResize** | Disables image resize when set to `false`. Default: `true`
**imagePaste** | Allows pasting images from clipboard. Default: `true`
---
subtitle: Form Widget
shortname: Color Picker
---
# Color Picker Field

`colorpicker` - renders controls to select a hexadecimal color value.

```yaml
color:
    label: Background
    type: colorpicker
```

The following [field properties](../form-fields.md) are supported and commonly used.

Property | Description
------------- | -------------
**label** | a name when displaying the form field to the user.
**default** | specifies a default string value, optional.
**comment** | places a descriptive comment below the field.
**availableColors** | list of available colors as an array.
**allowEmpty** | allows empty input value. Default: `false`
**allowCustom** | allows selection of a custom color. Default: `true`
**showAlpha** | displays an opacity slider and sets an 8-digit hex code. Default: `false`
**showInput** | displays a text input next to the color picker and disables available colors. Default: `false`

You may define preset colors by setting the `availableColors` property to an array value of hex colors. The `allowCustom` property can be used to disable the selection of a custom color, and this is optional.

```yaml
color:
    label: Background
    type: colorpicker
    availableColors: ['#000000', '#111111', '#222222']
    allowCustom: false
```

::: tip
If the `availableColors` field in not defined in the YAML file, the colorpicker uses a set of 20 default colors.
:::

Use the `showAlpha` property to include opacity in the color selection and this produces an 8-digit hex value.

```yaml
color:
    label: Background
    type: colorpicker
    showAlpha: true
```

Use the `showInput` property to display a text input next to the color. This mode will disable the available colors and make choosing and entering a custom hex color the primary focus.

```yaml
color:
    label: Primary Color
    type: colorpicker
    showInput: true
```

## Dynamic Available Colors

The available colors can be sourced from the model class by setting `availableColors` as a method name declared in the model class. This method should return an array of hex colors in the same format as in the example above. The first argument of this method is the field name, the second is the currect value of the field, and the third is the current data object for the entire form.

```yaml
color:
    label: Background
    type: colorpicker
    availableColors: myColorList
```

Supplying the available colors in the model class:

```php
public function myColorList($fieldName, $value, $formData)
{
    return ['#000000', '#111111', '#222222']
}
```
---
subtitle: Form Field
shortname: Balloon Selector
---
# Balloon Selector Field

The `balloon-selector` field renders a list, where only one item can be selected at a time.
Balloon selectors support the same methods for defining the options as the [dropdown field type](./field-dropdown.md).

```yaml
gender:
    type: balloon-selector
    label: Gender
    options:
        female: Female
        male: Male
```

The following [field properties](../form-fields.md) are commonly used.

Property | Description
------------- | -------------
**label** | a name when displaying the form field to the user.
**default** | a default value to use for new records.
**comment** | places a descriptive comment below the field.
**options** | available options for the dropdown, as an array.
**optionsMethod** | take options from a method defined on the model or as a static method, eg `Class::method`.

You may use the `default` property to set a default value, where the value is the key of the option.

```yaml
gender:
    type: balloon-selector
    label: Gender
    default: female
```

#### See Also

::: also
* [Dropdown Form Field](./field-dropdown.md)
:::
---
subtitle: Form Field
shortname: Checkbox
---
# Checkbox Field

The `checkbox` field renders a single checkbox.

```yaml
show_content:
    type: checkbox
    label: Display content
```

The following [field properties](../form-fields.md) are commonly used.

Property | Description
------------- | -------------
**label** | a name when displaying the form field to the user.
**default** | a default value to use for new records.
**comment** | text to display below the checkbox.

You may use the `default` property to check the checkbox by default.

```yaml
show_content:
    type: checkbox
    label: Display content
    default: true
```

Use the `comment` to display some accompanying text.

```yaml
is_active:
    type: checkbox
    label: Active
    comment: Check this box to make the record active.
```
---
subtitle: Form Widget
shortname: Markdown Editor
---
# Markdown Editor Field

`markdown` - renders a basic editor for markdown formatted text.

```yaml
md_content:
    type: markdown
    size: huge
```

The following [field properties](../form-fields.md) are supported and commonly used.

Property | Description
------------- | -------------
**label** | a name when displaying the form field to the user.
**default** | specifies a default string value, optional.
**comment** | places a descriptive comment below the field.
**sideBySide** | enables the side-by-side display mode by default. Default: `false`.

#### See Also

::: also
* [Markdown Parser Service](../../extend/services/parser.md)
:::
---
subtitle: Form Field
shortname: Password
---
# Password Field

The `password` field renders a single line password field and is used for capturing sensitive values, like passwords.

```yaml
user_password:
    label: Password
    type: password
```

The following [field properties](../form-fields.md) are commonly used.

Property | Description
------------- | -------------
**title** | title for the form field.
**comment** | places a descriptive comment below the field.

::: tip
Take a look at the [Sensitive form widget](./widget-sensitive.md) for a field that can capture and display sensitive values.
:::
---
subtitle: Form Field
shortname: Dropdown
---
# Dropdown Field

The `dropdown` field renders a dropdown with specified options. There are a number of ways to provide the dropdown options, most of them involve specify the `options` value.

```yaml
status_type:
    type: dropdown
    label: Blog Post Status
    options:
        draft: Draft
        published: Published
        archived: Archived
```

The following [field properties](../form-fields.md) are supported and commonly used.

Property | Description
------------- | -------------
**title** | title for the form field.
**placeholder** | text to display when the field is empty.
**default** | a default value to use for new records.
**comment** | places a descriptive comment below the field.
**options** | available options for the dropdown, as an array.
**optionsMethod** | take options from a method defined on the model or as a static method, eg `Class::method`.
**optionsPreset** | take options from a [preset list of defined options](../define-options.md).
**emptyOption** | text to display when allowing an empty option.
**showSearch** | allow the user to search options. Default: `true`.

Generally `options` are defined with key-value pair, where the value and label are independently specified.

```yaml
status_type:
    label: Blog Post Status
    type: dropdown
    options:
        draft: Draft
        published: Published
        archived: Archived
```

You may use the `default` property to set a default value, where the value is the key of the option.

```yaml
status_type:
    label: Blog Post Status
    type: dropdown
    default: published
```

To handle cases when there is no value set, you may specify an `emptyOption` value to include an empty option that can be reselected.

```yaml
status:
    label: Blog Post Status
    type: dropdown
    emptyOption: -- no status --
```

Alternatively you may use the `placeholder` option to use a "one-way" empty option that cannot be reselected.

```yaml
status:
    label: Blog Post Status
    type: dropdown
    placeholder: -- select a status --
```

By default the dropdown has a searching feature, allowing quick selection of a value. This can be disabled by setting the `showSearch` option to false.

```yaml
status:
    label: Blog Post Status
    type: dropdown
    showSearch: false
```

## Dynamic Options

The next approaches involve using the model class in your plugin or application codebase. If the `options` value is omitted, the framework expects a method with the name `get*FieldName*Options` to be defined in the model.

Using the example below, the model class is expected to have the `getStatusTypeOptions` method. The first argument of this method is the current value of this field and the second is the current data object for the entire form. This method should return an array of options in the format **key => label**.

```yaml
status_type:
    label: Blog Post Status
    type: dropdown
```

This is an example of the model class method that supplies the dropdown options. Notice that the method name matches the column name in _TitleCase_ format.

```php
public function getStatusTypeOptions($value, $formData)
{
    return ['all' => 'All', ...];
}
```

You may also define a catch-all method that works as a fallback in cases where the dedicated method name is not defined, which will be used for all dropdown field types for the model.

The first argument of this method is the field name, the second is the current value of the field, and the third is the current data object for the entire form. It should return an array of options in the format **key => label**.

```php
public function getDropdownOptions($fieldName, $value, $formData)
{
    if ($fieldName == 'status') {
        return ['all' => 'All', ...];
    }
    else {
        return ['' => '-- none --'];
    }
}
```

To use a custom method name, specify it explicitly in the `options` parameter and this will match exactly to the method name defined in the model.

In the next example the `listStatuses` method should be defined in the model class. This method receives all the same arguments as the `getDropdownOptions` method, and should return an array of options in the format **key => label**.

```yaml
status:
    label: Blog Post Status
    type: dropdown
    options: listStatuses
```

This is an example of the model class custom method that supplies the dropdown options.

```php
public function listStatuses($fieldName, $value, $formData)
{
    return ['published' => 'Published', ...];
}
```

To add a custom icon for every option rendered in the dropdown field, you may specify the options as a multidimensional array with the following format **key => [label-text, label-icon]**.

```php
public function listStatuses($fieldName, $value, $formData)
{
    return [
        'published' => ['Published', 'icon-check-circle'],
        'unpublished' => ['Unpublished', 'icon-minus-circle'],
        'draft' => ['Draft', 'icon-clock-o']
    ];
}
```

Displaying a custom color is also supported by specifying the options as an array with the format **key => [label-text, label-color]** where the color is a hex value beginning with a hash (`#`).

```php
public function listStatuses($fieldName, $value, $formData)
{
    return [
        'published' => ['Published', '#666666'],
        'unpublished' => ['Unpublished', '#ff9999'],
        'draft' => ['Draft', '#ff0000']
    ];
}
```

If you want to call a method on an external class, you may do it by calling a static method on any fully qualified object. Simply specify the `ClassName::method` syntax as a string in the `options` parameter.

```yaml
status:
    label: Blog Post Status
    type: dropdown
    options: MyAuthor\MyPlugin\Helpers\FormHelper::staticMethodOptions
```

This examples shows the static method defined on any helper class. The first argument is the Model object and the second argument is the form field definition.

```php
public static function staticMethodOptions($model, $formField)
{
    return ['published' => 'Published', ...];
}
```
---
subtitle: Form UI
shortname: Hint
---
# Hint Field

The `hint` UI element identical to the [partial element](./ui-partial.md) but renders inside a hint container that can be dismissed by the user.

```yaml
_hint1:
    type: hint
    path: content_field
```

The following [field properties](../form-fields.md) are supported.

Property | Description
------------- | -------------
**label** | title text for the section.
**comment** | secondary text for the section.
**mode** | visual display mode, as either: `tip`, `info`, `warning`, `danger`, `success`. Default: `info`.
**path** | path to a [partial view file](../../extend/system/views.md).

A hint supports content inline to the field. The `label` and `comment` values are optional and contain the content for the heading and subheading. You may also use Markdown syntax for the values.

```yaml
_tip1:
    type: hint
    mode: tip
    label: Pro Tip
    comment: Always check to make sure this field is populated.
```

The `mode` property supports the values: tip, info, warning, danger, success

```yaml
_warning1:
    type: hint
    mode: warning
    label: Always wash your hands
    comment: This is good for stopping the spread of germs.
```
---
subtitle: Form UI
shortname: Horizontal Rule
---
# Ruler Field

The `ruler` UI element simply renders a horizontal rule to break up the form contents.

```yaml
_ruler1:
    type: ruler
```
---
subtitle: Form Field
shortname: Switch
---
# Switch Field

The `switch` field renders a switch box. Similar to a [checkbox field](./field-checkbox.md) except displayed as a toggle switch.

```yaml
show_content:
    label: Display Content
    type: switch
```

The following [field properties](../form-fields.md) are supported and commonly used.

Property | Description
------------- | -------------
**label** | a name when displaying the form field to the user.
**default** | a default value to use for new records.
**comment** | text to display below the checkbox.

You may use the `default` property to enable the switch by default.

```yaml
show_content:
    label: Display Content
    type: switch
    default: true
```

Use the `comment` to display some accompanying text.

```yaml
show_content:
    label: Display Content
    type: switch
    comment: Flick this switch to display content
```

<!--
@deprecated
You may customize the switch text by passing an array to the `options` value with false and true labels.

```yaml
show_content:
    label: Display Content
    type: switch
    options:
        - Nope
        - Yeah
```
-->


#### See Also

::: also
* [Checkbox Form Field](./field-checkbox.md)
:::
---
subtitle: Form Widget
shortname: Record Finder
---
# Record Finder Field

`recordfinder` - renders a field with details of a related record. Expanding the field displays a popup list to search large amounts of records. Supported by singular relationships only.

```yaml
user:
    label: User
    type: recordfinder
    list: ~/plugins/rainlab/user/models/user/columns.yaml
```

The following [field properties](../form-fields.md) are supported and commonly used.

Property | Description
------------- | -------------
**label** | a name when displaying the form field to the user.
**default** | specifies a default string value, optional.
**comment** | places a descriptive comment below the field.
**keyFrom** | the name of column to use in the relation used for key. Default: `id`.
**nameFrom** | the column name to use in the relation used for displaying the name. Default: `name`.
**descriptionFrom** | the column name to use in the relation used for displaying a description. Default: `description`.
**title** | text to display in the title section of the popup.
**list** | a configuration array or reference to a list column definition file.
**filter** | a reference to a filter scopes definition file, see [backend list filters](../../extend/lists/filters.md).
**showSetup** | displays a setup button to configure the list columns and records per page. Default: `false`
**structure** | enables a read-only structured list for selecting records, see the [sorting records article](../../extend/lists/structures.md). Set to `false` to disable, otherwise enabled when the model uses a tree interface.
**defaultSort** | sets a default sorting column and direction when user preference is not defined. Supports a string or an array with keys `column` and `direction`. The direction can be `asc` for ascending (default) or `desc` for descending order.
**recordsPerPage** | records to display per page, use 0 for no pages. Default: `10`
**conditions** | specifies a raw where query statement to apply to the list model query.
**scope** | applies a [query scope method](../../extend/database/model.md) to the **related form model**, can be a model method name or a static PHP class method (`Class::method`). The first argument will contain the model that the widget will be attaching its value to, i.e. the parent model.
**searchMode** | defines the search strategy to either contain all words, any word or exact phrase. Supported options: all, any, exact. Default: `all`.
**searchScope** | specifies a [query scope method](../../extend/database/model.md) defined in the **related form model** to apply to the search query, the first argument will contain the search term.
**useRelation** | flag for using the name of the field as a relation name to interact with directly on the parent model. Default: `true`. Disable to return just the selected model's ID
**modelClass** | class of the model to use for listing records when `useRelation` is `false`
**popupSize** | change the size of the finder popup used, either: `giant`, `huge`, `large`, `small`, `tiny` or `adaptive`. Default: `huge`
**inlineOptions** | displays the field with buttons alongside the selected record, disable this mode if horizontal space is limited. Default: `true`.

You may limit the number of records per page using the `recordsPerPage` property.

```yaml
user:
    label: User
    type: recordfinder
    recordsPerPage: 10
```

Use the `title` property to change the title of the management form.

```yaml
user:
    label: User
    type: recordfinder
    title: Find A User
```

When a record is selected, the display attributes can be chosen from model attributes using the `nameFrom` and `descriptionFrom` properties.

```yaml
user:
    label: User
    type: recordfinder
    nameFrom: name
    descriptionFrom: email
```

If a [model structure](../../extend/lists/structures.md) is detected, then the list will display as a structure. This can be disabled or enabled explicitly with the **structure** property.

```yaml
user:
    label: User
    type: recordfinder
    structure: false
```

## Usage in Tailor

When the `recordfinder` field is used as a [content field in Tailor](../../cms/tailor/content-fields.md), it requires the `modelClass` property to be specified to define and locate the model relation.

```yaml
products:
    label: Products
    type: recordfinder
    modelClass: Acme\Test\Models\Product
    list: $/october/test/models/product/columns.yaml
```

When the `maxItems` is set to **1**, the relation is defined as a `belongsTo` relation. Otherwise, the relation is defined as `belongsToMany`.

```yaml
products:
    label: Products
    type: recordfinder
    modelClass: Acme\Test\Models\Tag
    maxItems: 1
```

The `inverse` property can be set to the relation name on the related model. This will change the relation definition to `hasOne`, `hasMany` or `belongsToMany` based on the `maxItems` setting and relation type of the related model.

```yaml
tags:
    label: Tags
    type: recordfinder
    modelClass: Acme\Test\Models\Tag
    inverse: tags
```

#### See Also

::: also
* [Tailor Models](../../cms/tailor/models.md)
* [Database Relations](../../extend/database/relations.md)
:::
---
subtitle: Form Field
shortname: Email
---
# Email Field

The `email` field renders a single line text box with the type of `email`, triggering an email-specialized keyboard in mobile browsers.

```yaml
user_email:
    label: Email Address
    type: email
```

The following [field properties](../form-fields.md) are commonly used.

Property | Description
------------- | -------------
**label** | a name when displaying the form field to the user.
**placeholder** | text to display in the field when it is empty.
**default** | specifies a default string value, optional.
**comment** | places a descriptive comment below the field.

## Server-side Validation

If you would like to validate this field on save to ensure that it is a properly-formatted email address. When working with tailor fields, use the `validation` property.

```yaml
user_email:
    label: Email Address
    type: email
    validation: email
```

When working with models, use the `$rules` property on your model, like so.

```php
public $rules = [
    'user_email' => ['email'],
];
```

For more information on model validation, please visit the [validation service article](../../extend/services/validation.md#rule-email).
---
subtitle: Form UI
shortname: Partial
---
# Partial Field

The `partial` UI element renders a partial, the `path` value can refer to a partial view file otherwise the field name is used as the partial name.

```yaml
content:
    label: Content
    type: partial
    path: field_content
```

The following [field properties](../form-fields.md) are supported.

Property | Description
------------- | -------------
**path** | path to a [partial view file](../../extend/system/views.md) or [view template code](../../extend/services/response-view.md), defaults to the field name with **field_** as a prefix.

When the `path` is set to an unqualified file name (a file name without a directory path and extension), the source path is determined to be in the model or controller directories. The following example will check for the partial file at **../models/mymodel/_field_for_content.php** or **../controllers/mycontroller/_field_for_content.php**.

```yaml
content:
    type: partial
    path: field_for_content
```

You may specify a fully qualified `path` to access partials outside the model or controller directories. This can be useful for sharing partials between definitions.

```yaml
content:
    type: partial
    path: $/acme/blog/partials/_field_content.php
```

## Accessing Variables

The following variables are available inside the partial when it is rendered.

- `$value` is the current field value, if found.
- `$model` is the [model used](../../extend/system/models.md) for the field
- `$field` is the configured class object `Backend\Classes\FormField`

Here is an some example contents of the **_field_content.php** file.

```php
<?php if ($model->is_active): ?>
    <p><?= $field->label ?> is active</p>
<?php endif ?>
```

## Using View Templates

You may pass a view template code as the `path` to access view service templates inside the plugin. The following code would be found at the path **plugins/acme/blog/views/formfields/content.php**.

```yaml
content:
    type: partial
    path: acme.blog::formfields.content
```

You may also place a partial in the app directory, for example, **app/views/formfields/content.php**.

```yaml
content:
    type: partial
    path: app::formfields.content
```

:::tip
The path must contain the `::` characters to activate the view service.
:::

#### See Also

::: also
* [Hint Form UI](./ui-hint.md)
* [Rendering Controller Views](../../extend/system/views.md)
* [Response & View Service](../../extend/services/response-view.md)
:::
---
subtitle: Form Field
shortname: Textarea
---
# Textarea Field

The `textarea` field renders a multiline text box.

```yaml
blog_contents:
    type: textarea
    label: Contents
```

The following [field properties](../form-fields.md) are supported and commonly used.

Property | Description
------------- | -------------
**title** | title for the form field.
**default** | specifies a default string value, optional.
**placeholder** | text to display when the field is empty.
**comment** | places a descriptive comment below the field.
**size** | the field size in height. Supported values: `tiny`, `small`, `large`, `huge`, `giant`. Default: `large`.

You may specify how large the field size should be with the `size` property.

```yaml
blog_contents:
    type: textarea
    label: Contents
    size: large
```

You may use the `default` property to set a default value.

```yaml
quote_content:
    type: textarea
    label: Details
    default: I like turtles
```

Use the `placeholder` property to assign some placeholder text.

```yaml
point_summary:
    type: textarea
    label: Point
    placeholder: Type some key points are you trying to make
```
---
subtitle: Form Field
shortname: Radio List
---
# Radio List Field

The `radio` field renders a list of radio options, where only one item can be selected at a time. Radio fields support the same methods for defining the options as the [dropdown field type](./field-dropdown.md).

```yaml
security_level:
    type: radio
    label: Access Level
    options:
        all: All
        registered: Registered only
        guests: Guests only
```

The following [field properties](../form-fields.md) are commonly used.

Property | Description
------------- | -------------
**label** | a name when displaying the form field to the user.
**default** | a default value to use for new records.
**options** | available options for the radio list, as an array.
**optionsMethod** | take options from a method defined on the model or as a static method, eg `Class::method`.
**cssClass** | used for setting the options as inline.
**inlineOptions** | display the options side-by-side instead of stacked.

You may use the `default` property to set a default value, where the value is the key of the option.

```yaml
security_level:
    type: radio
    label: Access Level
    default: guests
```

In addition to a simple arrays, radio lists support a secondary description as part of their `options`.

```yaml
security_level:
    type: radio
    label: Access Level
    options:
        all: [All, Guests and customers will be able to access this page.]
        registered: [Registered only, Only logged in member will be able to access this page.]
        guests: [Guests only, Only guest users will be able to access this page.]
```

To visually display the options side-by-side instead of stacked, set the `inlineOptions` property to a `true` value.

```yaml
security_level:
    type: radio
    label: Access Level
    inlineOptions: true
```

## Dynamic Options

Radio lists support the same methods for defining the options as the [dropdown field type](./field-dropdown.md).


In addition to these definitions, for radio lists, the method could return either the simple array: **key => value** or an array of arrays for providing the descriptions: **key => [label, description]**.

```php
public function listAccessLevels($fieldName, $value, $formData)
{
    return [
        'all' => ['All', 'Guests and customers will be able to access this page.'],
        // ...
    ];
}
```

#### See Also

::: also
* [Dropdown Form Field](./field-dropdown.md)
:::
---
subtitle: Form Field
shortname: Number
---
# Number Field

The `number` field renders a single line text box that takes numbers only.

```yaml
your_age:
    label: Your Age
    type: number
```

The following [field properties](../form-fields.md) are supported and commonly used.

Property | Description
------------- | -------------
**label** | a name when displaying the form field to the user.
**default** | specifies a default string value, optional.
**comment** | places a descriptive comment below the field.
**min** | the client-side minimum value, default `null`.
**max** | the client-side maximum value, default `null`.
**step** | the client-side step increment, default `any`.

You may use the `min` and `max` properties to constrain the input by minimum and maximum values. The following will only accept an input between 1 and 100.

```yaml
your_age:
    label: Your Age
    type: number
    min: 1
    max: 100
```

Use the `step` property to control the increments that the number can be increased or decreased by, this value defaults to **any**.

```yaml
your_age:
    label: Your Age
    type: number
    step: 10
```

## Server-side Validation

If you would like to validate this field server-side on save to ensure that it is numeric. When working with tailor fields, use the `validation` property.

```yaml
your_age:
    label: Your Age
    type: number
    validation: numeric
```

When working with models, use the `$rules` property on your model, like so.

```php
public $rules = [
    'your_age' => ['numeric'],
];
```

For more information on model validation, please visit the [validation service article](../../extend/services/validation.md#rule-numeric).
---
subtitle: Form Widget
shortname: Tag List
---
# Tag List Field

The `taglist` form widget renders a field for inputting a list of tags.

```yaml
tags:
    type: taglist
    separator: space
```

The following [field properties](../form-fields.md) are supported and commonly used.

Property | Description
------------- | -------------
**label** | a name when displaying the form field to the user.
**default** | specifies a default string value, optional.
**comment** | places a descriptive comment below the field.
**mode** | controls how the value is returned, either `string`, `array` or `relation`. Default: `string`
**separator** | separate tags with the specified character, either `comma` or `space`. Default: `comma`
**customTags** | allows custom tags to be entered manually by the user. Default: `true`
**options** | specifies an array for predefined options.
**optionsMethod** | specifies a method name for predefined options, defined on the model or as a static method, eg `Class::method`. Set to `true` to use model **get*Field*Options** method.
**nameFrom** | if relation mode is used, a model attribute name for displaying the tag name. Default: `name`
**useKey** | use the key instead of value for saving and reading data. Default: `false`

A tag list support the same methods for defining the options as the [dropdown field type](./field-dropdown.md).

```yaml
tags:
    type: taglist
    options:
        - Red
        - Blue
        - Orange
```

You may use the `mode` called **relation** where the field name is a [many-to-many relationship](../../extend/database/relations.md). This will automatically source and assign tags via the relationship. If custom tags are supported, they will be created before assignment.

```yaml
tags:
    type: taglist
    mode: relation
```

#### See Also

::: also
* [Dropdown Form Field](./field-dropdown.md)
:::
---
subtitle: Form Widget
shortname: Media Finder
---
# Media Finder Field

`mediafinder` - renders a field for selecting an item from the media manager library. Expanding the field displays the media manager to locate a file. The resulting selection is a string as the relative path to the file.

```yaml
whitepaper_file:
    label: Whitepaper PDF
    type: mediafinder
```

The following [field properties](../form-fields.md) are supported and commonly used.

Property | Description
------------- | -------------
**label** | a name when displaying the form field to the user.
**default** | specifies a default string value, optional.
**comment** | places a descriptive comment below the field.
**mode** | the expected file type, either `file`, `folder` or `image`. Default: `file`.
**imageWidth** | if using image type, the preview image will be displayed to this width, optional.
**imageHeight** | if using image type, the preview image will be displayed to this height, optional.
**maxItems** | maximum number of items that can be selected.
**thumbOptions** | additional [resize options](../../extend/services/resizer.md) for generating the thumbnail, or pass `false` to disable thumb generation.

Set the `mode` to **image** to display a preview of the selected image.

```yaml
background_image:
    label: Background Image
    type: mediafinder
    mode: image
```

You may set the `mode` to **folder** to only allow selecting a media folder path.

```yaml
media_folder:
    label: Media Folder
    type: mediafinder
    mode: folder
```

::: tip
Unlike the [File Upload form widget](./widget-fileupload.md), the Media Finder form widget stores its data as a string representing the path to the media files selected within the Media Library. It should associate to a normal attribute on your model.
:::

## Selecting Multiple Items

The media finder will attempt to guess if multiple items can be selected based on the [jsonable attribute](../../extend/system/models.md) in the model, which is a requirement for storing multiple items.

You may limit the number of items that can be selected using the `maxItems` property.

```yaml
media_gallery:
    label: Image
    type: mediafinder
    mode: image
    maxItems: 10
```
---
subtitle: Form Field
shortname: Text
---
# Text Field

The `text` field renders a single line text box. This is the default type used if no type is specified.

```yaml
blog_title:
    type: text
    label: Blog Title
```

The following [field properties](../form-fields.md) are commonly used.

Property | Description
------------- | -------------
**label** | a name when displaying the form field to the user.
**placeholder** | text to display in the field when it is empty.
**default** | specifies a default string value, optional.
**comment** | places a descriptive comment below the field.

You may use the `default` property to set a default value.

```yaml
quote_content:
    type: text
    label: Details
    default: I like turtles
```

Use the `placeholder` property to assign some placeholder text.

```yaml
point_summary:
    type: text
    label: Point
    placeholder: Type some key points are you trying to make
```
---
subtitle: Form Widget
shortname: Page Finder
---
# Page Finder Field

`pagefinder` - renders a field for selecting a page link. Expanding the field displays the picker to locate a page. The resulting selection is a string that contains the type and reference.

```yaml
featured_page:
    label: Featured Page
    type: pagefinder
```

The selected value is stored using the following format.

```
october://<TYPE>@link/<REFERENCE>?<PARAM>=<VALUE>
```

The following [field properties](../form-fields.md) are supported and commonly used.

Property | Description
------------- | -------------
**label** | a name when displaying the form field to the user.
**default** | specifies a default string value, optional.
**comment** | places a descriptive comment below the field.
**singleMode** | only allows items to be selected that resolve to a single URL. Default: `false`

::: tip
Resolve the `pagefinder` value in lists using the [linkage column type](../lists/column-linkage.md).
:::

## Linking to Pages

Use the [`|link` Twig filter](../../markup/filter/link.md) to convert the page finder value to a URL.

```twig
{{ featured_page|link }}
```

Use the [`|content` Twig filter](../../markup/tag/content.md) to process HTML markup and replace all links within the content.

```twig
{{ blog_html|content }}
```

## Creating New Page Types

Plugins can extend the page finder with new page types using the various events. The most common place to subscribe to an event is the `boot` method of the plugin registration file.

```php
public function boot()
{
    Event::listen('cms.pageLookup.listTypes', function() {
        // ...
    });

    Event::listen('cms.pageLookup.getTypeInfo', function($type) {
        // ...
    });

    Event::listen('cms.pageLookup.resolveItem', function($type, $item, $url, $theme) {
        // ...
    });
}
```

### Registering New Page Types

The `cms.pageLookup.listTypes` event handler returns a list of pages types supported by the plugin. The handler should return an associative array with the type codes in indexes and type names in values. It's highly recommended to use the plugin name in the type codes, to avoid conflicts with other page type providers. For example:

```php
Event::listen('cms.pageLookup.listTypes', function() {
    return [
        'blog-post' => 'Blog Post'
    ];
});
```

For pages types that support nested subitems, such as linking to all blog posts, the type name value should be an array where the last item is set to `true`. This will exclude it from scenarios where only one link can be selected. The following marks the **blog-posts** type with nesting support.

```php
Event::listen('cms.pageLookup.listTypes', function() {
    return [
        'blog-posts' => ['All Blog Posts', true]
    ];
});
```

### Returning Information About a Page Type

The `cms.pageLookup.getTypeInfo` event handler returns detailed information about the supported page types. The handler gets a single parameter - the page type code (one of the codes you registered with the `cms.pageLookup.listTypes` handler). The handler code must check whether the requested item type code belongs to the plugin. The handler should return an associative array in the following format.

```php
Event::listen('cms.pageLookup.getTypeInfo', function($type) {
    if ($type == 'blog-post') {
        return [
            'references' => [
                11 => 'News',
                12 => 'Tutorials',
                13 => 'Philosophy',
            ],
            'cmsPages' => Page::withComponent('blogPosts')->all()
        ];
    }
});
```

#### References

The `references` element is a list objects the page could refer to. For example, the **Blog Category** page type returns a list of the blog categories. Some object supports nesting, for example, complete page listings. Other objects don't support nesting, for example, blog categories. The format of the `references` value depends on whether the references have subitems or not. The format for references without subitems is the following.

```php
'references' => [
    'item-key' => 'Item title'
]
```

The format for references with subitems is the following.

```php
'references' => [
    'item-key' => [
        'title' => 'Item title',
        'items' => [...]
    ]
]
```

The following iterator could be used to generate references where a model has children.

```php
$iterator = function($records) use (&$iterator) {
    $result = [];
    foreach ($records as $record) {
        if (!$record->children) {
            $result[$record->id] = $record->title;
        }
        else {
            $result[$record->id] = [
                'title' => $record->title,
                'items' => $iterator($record->children)
            ];
        }
    }
    return $result;
};

return ['references' => $iterator($records)];
```

#### CMS Pages

The `cmsPages` is a list of CMS pages that can display objects supported by the page type. For example, for the **Blog Category** item type the page list contains pages that host the `blogPosts` component. That component can display a blog category contents. The `cmsPages` element should be an array of the `Cms\Classes\Page` objects.

The following `withComponent` method will find all pages that use the `blogPosts` component, for the active theme.

```php
'cmsPages' => Page::withComponent('blogPosts')->all();
```

Use `whereComponent` to find all pages using the `section` component where the property `entrySlug` is set to true.

```php
'cmsPages' => Page::whereComponent('section', 'entrySlug', true)->all();
```

Use `inTheme` to find pages in another theme by passing the theme code.

```php
'cmsPages' => Page::inTheme('demo')->withComponent('blogPosts')->all();
```

### Resolving Page Links

When the page finder generates links, every item should **resolved** by the plugin that supplies the item type. The process of resolving involves generating the real item URL, determining whether the item is active, and generating the subitems (if required).

The `cms.pageLookup.resolveItem` event handler resolves page information and returns the actual item URL, title, an indicator whether the item is currently active, and subitems, if any. The event handler takes four arguments:

- `$type` - the item type name. Plugins must only handle item types they provide and ignore other types.
- `$item` - the item object (`Cms\Models\PageLookupItem`). The item object represents the item configuration provided by the user. The object has the following properties: `title`, `type`, `reference`, `cmsPage`.
- `$url` - specifies the current absolute URL, in lower case. Always use the `Url::to()` helper to generate item links and compare them with the current URL.
- `$theme` - the current theme object (`Cms\Classes\Theme`).

The event handler should check for a matched `type` and return an array.

```php
Event::listen('cms.pageLookup.resolveItem', function($type, $item, $url, $theme) {
    if ($type === 'blog-post') {
        return [...];
    }

    if ($item->type == 'all-blog-posts') {
        return [...];
    }
});
```

The `url` and `isActive` elements are required for items that point to a specific page.

```php
return [
    'title' => 'Some Category',
    'url' => 'https://example.tld/blog/category/some-category',
    'isActive' => true
];
```

### Resolving Nested Page Links

It is also possible for a resolved page link to return multiple items. For example, an **All Pages** item type wouldn't have a specific page to point to since it can have multiple links.

In these cases, the resolver will request subitems when the `$item` argument has a `nesting` property set to true.

```php
Event::listen('cms.pageLookup.resolveItem', function($type, $item, $url, $theme) {
    // Resolve item
    $result = [...];

    // Subitems requested
    if ($item->nesting) {
        $result['items'] = [...];
    }

    return $result;
});
```

The items should be listed in the `items` element. The `items` element should only be provided for items marked as nested.

```php
return [
    'url' => 'https://example.tld/blog/category/another-category',
    'isActive' => true,
    'items' => [
        [
            'title' => 'Another category',
            'url' => 'https://example.tld/blog/category/another-category',
            'isActive' => true
        ],
        [
            'title' => 'News',
            'url' => 'https://example.tld/blog/category/news',
            'isActive' => false
        ]
    ]
];
```

### Resolving Other Site Links

It is possible for a resolved page link to return other sites that contain this page link. This is where the `$item` argument may contain a `sites` property that is set to true. The `Site` and `Cms` facades are helpful here, see the example below.

```php
Event::listen('cms.pageLookup.resolveItem', function($type, $item, $url, $theme) {
    // Resolve item
    $result = [...];

    $page = \Cms\Classes\Page::loadCached($theme, $item->reference);

    // Sites requested
    if ($item->sites) {
        $sites = [];
        if (Site::hasMultiSite()) {
            foreach (Site::listEnabled() as $site) {
                $url = Cms::siteUrl($page, $site, [
                    'id' => $record->id,
                    'slug' => $record->slug,
                    'fullslug' => $record->fullslug
                ]);

                $sites[] = [
                    'url' => $url,
                    'id' => $site->id,
                    'code' => $site->code,
                    'locale' => $site->hard_locale,
                ];
            }
        }
        $result['sites'] = $sites;
    }

    return $result;
});
```

The resulting item should contain a `sites` array with a site definition object, each with a set `url` on the object.

### Usage Example

The following is a basic example of resolving a page URL by looking up a model and page URL using the `Cms\Classes\Controller` class and `pageUrl` method. It also processes child items recursively using the `children` relationship on the model, when requested using `$item->nesting`.

```php
Event::listen('cms.pageLookup.resolveItem', function($type, $item, $url, $theme) {
    if ($type !== 'my-model') {
        return;
    }

    $model = MyModel::find($item->reference);
    if (!$model) {
        return;
    }

    $controller = new Controller($theme);

    $pageUrl = $controller->pageUrl($item->cmsPage, [
        'id' => $model->id,
        'slug' => $model->slug
    ]);

    $result = [
        'url' => $pageUrl,
        'isActive' => $pageUrl == $url,
        'title' => $model->title,
        'mtime' => $model->updated_at,
    ];

    if (!$item->nesting) {
        return $result;
    }

    $iterator = function($children) use (&$iterator, &$item, &$theme, $url, $controller, $model) {
        $branch = [];

        foreach ($children as $child) {
            $childUrl = $controller->pageUrl($item->cmsPage, [
                'id' => $model->id,
                'slug' => $model->slug
            ]);

            $childItem = [
                'url' => $childUrl,
                'isActive' => $childUrl == $url,
                'title' => $child->title,
                'mtime' => $child->updated_at,
            ];

            if ($child->children) {
                $childItem['items'] = $iterator($child->children);
            }

            $branch[] = $childItem;
        }

        return $branch;
    };

    $result['items'] = $iterator($model->children);

    return $result;
});
```

::: tip
As the resolving process occurs every time the frontend page is rendered, it is a good idea to cache all the information required for resolving items, if possible.
:::

---
subtitle: Form Widget
shortname: Sensitive
---
# Sensitive Field

`sensitive` - renders a revealable password field that can be used for sensitive information such as API keys or secrets, configuration values, etc. A sensitive field can be toggled visible and hidden at the user's request.

A sensitive field that contains a previously entered value will have the value replaced with a placeholder value on load, preventing the value from being guessed by length or copied. Upon revealing the value, the original value is retrieved by AJAX and populated into the field.

```yaml
api_secret:
    type: sensitive
    allowCopy: false
    hideOnTabChange: true
```

The following [field properties](../form-fields.md) are supported and commonly used.

Property | Description
------------- | -------------
**label** | a name when displaying the form field to the user.
**default** | specifies a default string value, optional.
**comment** | places a descriptive comment below the field.
**mode** | display mode for the widget, either `textarea` or `text`. Default: `text`
**allowCopy** | adds a "copy" action to the sensitive field, allowing the user to copy the password without revealing it. Default: `true`
**hiddenPlaceholder** | sets the placeholder text that is used to simulate a hidden, unrevealed value. You can change this to a long or short string to emulate different length values. Default: `__hidden__`
**hideOnTabChange** | if true, the sensitive field will automatically be hidden if the user navigates to a different tab, or minimizes their browser. Default: `true`
---
subtitle: Form Widget
shortname: Relation
---
# Relation Field

`relation` - renders either a dropdown or checkbox list according to the field relation type. Singular relationships display a dropdown, multiple relationships display a checkbox list. The label used for displaying each relation is sourced by the `nameFrom` or `select` definition.

```yaml
categories:
    label: Categories
    type: relation
```

The following [field properties](../form-fields.md) are supported and commonly used.

Property | Description
------------- | -------------
**label** | a name when displaying the form field to the user.
**comment** | places a descriptive comment below the field.
**nameFrom** | a model attribute name used for displaying the relation label. Default: `name`.
**excludeFrom** | a parent model attribute used to exclude related keys in the list, optional.
**select** | a custom SQL select statement to use for the name.
**emptyOption** | text to display when there is no available selections.
**conditions** | specifies a raw where query statement to apply to the model query.
**scope** | applies a [query scope method](../../extend/database/model.md) to the **related form model**, can be a model method name or a static PHP class method (`Class::method`).
**defaultSort** | sets a default sorting column and direction, supports a string for the column name or an array with keys `column` and `direction`. The direction can be `asc` for ascending (default) or `desc` for descending order.
**useController** | automatically detects if this field configured with [Relation Controller behavior](../../extend/forms/relation-controller.md) and use it. Default: `true`
**controller** | specifies an array to manually configure integration with the [Relation Controller behavior](../../extend/forms/relation-controller.md).

Use the `nameFrom` property to customize the label used for the related record.

```yaml
categories:
    label: Categories
    type: relation
    nameFrom: title
```

Alternatively, you may populate the label using a custom `select` statement. Any valid SQL statement works here.

```yaml
user:
    label: User
    type: relation
    select: concat(first_name, ' ', last_name)
```

## Applying Conditions

You can filter the available records using SQL or PHP conditions using the approaches below.

### SQL Query Condition

You may limit the related model using a raw SQL query using the `conditions` property.

```yaml
user:
    label: User
    type: relation
    conditions: is_featured = true
```

The value also supports simple parameters parsed from the parent model attributes. The parameter names begin with a colon (`:`) character.

```yaml
country:
    label: Country
    type: relation

state:
    label: State
    type: relation
    dependsOn: country
    conditions: custom_country_id = :country_id
```

### PHP Query Scopes

You can provide a model scope to use to filter the results with the `scope` property.

```yaml
user:
    label: User
    type: relation
    scope: withTrashed
```

The `scope` can be used to connect two related fields, for example, connecting a `Country` and `State` model, where the available states are filtered by the selected country. The `dependsOn` property enables [field dependencies](../../extend/forms/field-dependencies.md) and updates the `state` options when a `country` is selected.

```yaml
country:
    label: Country
    type: relation

state:
    label: State
    type: relation
    dependsOn: country
    scope: filterStates
```

The `scope` value **filterStates** translates to the `scopeFilterStates` method defined in the `State` model. The `$model` (second argument) supplied to the [model query scope](../../extend/database/model.md) lets you capture the selected country and filter the available options.

```php
public function scopeFilterStates($query, $model)
{
    if ($countryId = $model->country_id) {
        $query->where('country_id', $countryId);
    }
}
```

## Relation Controller Integration

If the controller implements the [Relation Controller behavior](../../extend/forms/relation-controller.md) and the field is defined there, then it will be displayed using this definition. Set the `useController` property to false to disable this functionality.

```yaml
countries:
    label: Categories
    type: relation
    useController: false
```

The `controller` property may be used to specify inline configuration.

```yaml
products:
    label: Products
    tab: Products
    type: relation
    controller:
        label: Product
        list: $/october/test/models/product/columns.yaml
        form: $/october/test/models/product/fields.yaml
```
---
subtitle: Form Widget
shortname: Nested Form
---
# Nested Form Field

`nestedform` - renders a nested form using a related record or [jsonable attribute](../../extend/system/models.md). Fields can be defined inline or using an external yaml file.

```yaml
content:
    type: nestedform
    showPanel: false
    form:
        fields:
            added_at:
                label: Date Added
                type: datepicker
            details:
                label: Details
                type: textarea
            title:
                label: This the title
                type: text
```

The following [field properties](../form-fields.md) are supported and commonly used.

Property | Description
------------- | -------------
**label** | a name when displaying the form field to the user.
**comment** | places a descriptive comment below the field.
**form** | inline field definitions or a reference to form field definition file.
**showPanel** | places the form inside a panel container. Default: `true`
**defaultCreate** | if a related record is not found, attempt to create one. Default: `false`

Pass a string to the `form` property to reference an external yaml file.

```yaml
profile:
    label: Profile
    type: nestedform
    form: $/october/demo/models/profile/fields.yaml
```

Like any other form, the nested form widget supports the use of tabs by placing the fields under the `tabs` or `secondaryTabs` properties of the `form` definition.

```yaml
tabbed_content:
    type: nestedform
    form:
        tabs:
            fields:
                # ...
```

#### See Also

::: also
* [Repeater Form Widget](./widget-repeater.md)
:::
---
subtitle: Form Field
shortname: Checkbox List
---
# Checkbox List Field

The `checkboxlist` field renders a list of checkboxes. Checkbox lists support the same methods for defining the options as the [dropdown field type](./field-dropdown.md) and also support secondary descriptions, found in the [radio field type](./field-radio.md).

```yaml
permissions:
    label: Permissions
    type: checkboxlist
    options:
        open_account: Open account
        close_account: Close account
        modify_account: Modify account
```

The following [field properties](../form-fields.md) are supported and commonly used.

Property | Description
------------- | -------------
**label** | a name when displaying the form field to the user.
**options** | available options for the list, as an array.
**optionsMethod** | take options from a method defined on the model or as a static method, eg `Class::method`.
**default** | a default value to use for new records.
**quickselect** | show the quick selection buttons.
**cssClass** | used for setting the options as inline.
**inlineOptions** | display the options side-by-side instead of stacked, when less than 10 options.
**placeholder** | a message to display when there are no records selected (preview context).

You may use the `default` property to set a default value, where the value is the key of the option.

```yaml
permissions:
    label: Permissions
    type: checkboxlist
    default: open_account
```

Options can be displayed inline with each other instead of in separate rows by setting the `inlineOptions` property to a `true` value. This only applies when there are less than 10 available options.

```yaml
permissions:
    type: checkboxlist
    inlineOptions: true
```

A quick select menu with "Select All" and "Select None" buttons will become visible when the list has greater than 10 items. To explicitly enable these buttons, use the `quickselect` option.

```yaml
permissions:
    type: checkboxlist
    quickselect: true
```

#### See Also

::: also
* [Dropdown Form Field](./field-dropdown.md)
* [Radio Form Field](./field-radio.md)
:::
---
subtitle: Form Widget
shortname: File Upload
---
# File Upload Field

`fileupload` - renders a file uploader for images or regular files.

```yaml
avatar:
    label: Avatar
    type: fileupload
    mode: image
    imageHeight: 260
    imageWidth: 260
```

The following [field properties](../form-fields.md) are supported and commonly used.

Property | Description
------------- | -------------
**label** | a name when displaying the form field to the user.
**default** | specifies a default string value, optional.
**comment** | places a descriptive comment below the field.
**mode** | the expected file type, either file or image. Default: `image`
**size** | for multiple uploads, the size of the container. Available options: tiny, small, large, huge, giant. Default: `large`
**imageWidth** | if using image type, the image will be resized to this width, optional
**imageHeight** | if using image type, the image will be resized to this height, optional
**fileTypes** | file extensions that are accepted by the uploader, optional. Eg: `zip,txt`
**mimeTypes** | MIME types that are accepted by the uploader, either as file extension or fully qualified name, optional. Eg: `bin,txt`
**maxFilesize** | file size in Mb that are accepted by the uploader, optional. Default: from "upload_max_filesize" param value
**maxFiles** | maximum number of files allowed to be uploaded
**useCaption** | allows a title and description to be set for the file. Default: `true`
**thumbOptions** | additional [resize options](../../extend/services/resizer.md) for generating the thumbnail, or pass `false` to disable thumb generation.
**deferredBinding** | use deferred binding when uploading a file, when available. Disable this to attach the file immediately on upload instead of when saving. Default: `true`

::: tip
Unlike the [Media Finder form widget](./widget-mediafinder.md), the File Upload form widget uses [database file attachments](../../extend/database/attachments.md) so the field name be that of an `attachOne` or `attachMany` relationship attribute on your associated model.
:::
---
subtitle: List of all the icons available to use.
widebar: false
---
# Available Icons

October CMS ships with its own icon library and also includes third-party libraries to make finding a suitable icon quick and easy.

## Phosphor Icons

The [Phosphor Icon pack](https://phosphoricons.com/) is available to use in the administration panel. This library provides a flexible collection of icons for everyday use.

```html
<i class="ph ph-laptop"></i>
```

When used as an icon definition, the icon name contains both the `ph` and `ph-` prefix.

```yaml
icon: ph ph-laptop
```

## October Icons

The **October Icon pack** is a custom icon library with icons of various descriptions. The pack is primarily used by the core features and may be updated from time to time.

```html
<i class="icon-october"></i>
```

When used as an icon definition, the icon name contains only the `icon-` prefix.

```yaml
icon: icon-october
```

### Available October Icons

<AvailableIcons />
---
subtitle: List Column
shortname: Partial
---
# Partial Column

The `partial` column will render the column content using a partial or view file. The `path` value can refer to a partial view file otherwise the column name is used as the partial name. The default scope for the view path is the controller's view path.

```yaml
content:
    label: Content
    type: partial
    path: content_column
```

The following properties are supported.

Property | Description
------------- | -------------
**path** | path to a [partial view file](../../extend/system/views.md) or [view template code](../../extend/services/response-view.md), defaults to the column name with **column_** as a prefix.

When the `path` is set to an unqualified file name (a file name without a directory path and extension), the source path is determined to be in the model or controller directories. The following example will check for the partial file at **../models/mymodel/_column_for_content.php** or **../controllers/mycontroller/_column_for_content.php**.

```yaml
content:
    type: partial
    path: column_for_content
```

You may specify a fully qualified `path` to access partials outside the model or controller directories. This can be useful for sharing partials between definitions.

```yaml
content:
    label: Content
    type: partial
    path: $/acme/blog/partials/_content_column.php
```

Inside the partial these variables are available.

- `$value` is the default cell value
- `$record` is the model used for the cell
- `$column` is the configured class object `Backend\Classes\ListColumn`

Here is an some example contents of the **_content_column.php** file.

```php
<?php if ($record->is_active): ?>
    <?= e($value) ?>
<?php endif ?>
```

## Using View Templates

You may pass a view template code as the `path` to access view service templates inside the plugin. The following code would be found at the path **plugins/acme/blog/views/listcolumns/content.php**.

```yaml
content:
    label: Content
    type: partial
    path: acme.blog::listcolumns.content
```

:::tip
The path must contain the `::` characters to activate the view service.
:::

#### See Also

::: also
* [Rendering Controller Views](../../extend/system/views.md)
* [Response & View Service](../../extend/services/response-view.md)
:::
---
subtitle: List Column
shortname: Text
---
# Text Column

`text` - displays a text column, aligned left.

```yaml
full_name:
    label: Full Name
    type: text
```
---
subtitle: List Column
shortname: Summary
---
# Summary Column

`summary` - generates a summary value, strips HTML and limits length to the closest word boundary.

```yaml
html_content:
    label: Content
    type: summary
```

The default summary length is 40 characters, you may adjust it with the `limitChars` option.

```yaml
html_content:
    label: Content
    type: summary
    limitChars: 100
```

To limit by word count instead, specify the `limitWords` option instead. You may also change the end suffix characters with the `endChars` option.

```yaml
html_content:
    label: Content
    type: summary
    limitWords: 10
    endChars: "..."
```
---
subtitle: List Column
shortname: Selectable
---
# Selectable Column

`selectable` - takes the column value and matches it to the value in the record's available options. Take the following array as an example, if the record value is set to `open` then the **Open** value is displayed in the column.

```php
['open' => 'Open', 'closed' => 'Closed']
```

The available options are defined based on [dropdown options](../define-options.md).

```yaml
status:
    label: Status
    type: selectable
```

The following properties are supported.

Property | Description
------------- | -------------
**options** | available options for the dropdown, as an array.
**optionsMethod** | take options from a method defined on the model or as a static method, eg `Class::method`.
**optionsPreset** | take options from a [preset list of defined options](../define-options.md).

The `options` value can specify options explicitly as an array.

```yaml
status:
    label: Status
    type: selectable
    options:
        pending: Pending
        active: Active
```

The `optionsPreset` can be used to extract the value from a [options preset definition](../define-options.md).

```yaml
icon:
    label: Icon
    type: selectable
    optionsPreset: phosphorIcons
```

#### See Also

::: also
* [Defining Options](../define-options.md)
* [Dropdown Form Field](../form/field-dropdown.md)
:::
---
subtitle: List Column
shortname: Image
---
# Image Column

The `image` column displays an image column with the option to resize the output.

```yaml
avatar:
    label: Avatar
    type: image
```

The following properties are supported.

Property | Description
------------- | -------------
**sortable** | disables sorting of the column. Default: `false`
**width** | image thumbnail width to use, optional.
**height** | image thumbnail height to use, optional.
**options** | [image resizer](../../extend/services/resizer.md) options.

Use the `sortable` property to disable sorting.

```yaml
avatar:
    label: Avatar
    type: image
    sortable: false
```

Use the `width` and `height` properties to specify a custom image size.

```yaml
avatar:
    label: Avatar
    type: image
    width: 150
    height: 150
```

Use the `options` property to specify the resizer options.

```yaml
avatar:
    label: Avatar
    type: image
    options:
        quality: 80
```

See the [image resizing article](../../extend/services/resizer.md) for more information on what options are supported.

#### See Also

::: also
* [Image Resizer](../../extend/services/resizer.md)
:::
---
subtitle: List Column
shortname: Number
---
# Number Column

`number` - displays a number column, aligned right.

```yaml
age:
    label: Age
    type: number
```

You may also specify a custom number format, for example currency **$99.00**.

```yaml
price:
    label: Price
    type: number
    format: "$%.2f"
```

::: tip
The `format` property follows the formatting rules of the [PHP sprintf() function](https://secure.php.net/manual/en/function.sprintf.php)
:::

## Counting Relations

The `number` column type is commonly used alongside the `relationCount` property to count the number of related records. The following definition will count the number of records associated to **users** relation of the model.

```yaml
users_count:
    label: Users
    type: number
    relation: users
    relationCount: true
```
---
subtitle: List Column
shortname: Switch
---
# Switch Column

`switch` - displays a on or off state for boolean columns.

```yaml
enabled:
    label: Enabled
    type: switch
```

You may customize the switch text by passing an array to the `options` value with false and true labels.

```yaml
enabled:
    label: Enabled
    type: switch
    options:
        - Nope
        - Yeah
```
---
subtitle: List Column
shortname: Linkage
---
# Linkage Column

The `linkage` column displays a hyperlink to the specified page.

```yaml
website:
    label: Website
    type: linkage
```

The following properties are supported.

Property | Description
------------- | -------------
**linkText** | text to display for the link, optional.
**attributes** | an array of HTML attributes to pass to the anchor element.

Use the `attributes` property to add custom HTML attributes.

```yaml
website:
    label: Website
    type: linkage
    attributes:
        target: _blank
```

::: tip
The `linkage` column type will automatically resolve [page finder link values](../form/widget-pagefinder.md).
:::

## Custom Link Text

By default, the value will be the URL to the linked location. For example, you may change the link text by returning an array value from the model.

```php
['https://octobercms.com', 'October CMS']
```

In your model, you may wish to use an attribute modifier to supply these values. The following creates a new `website_link` attribute on the model.

```php
public function getWebsiteLinkAttribute()
{
    return [$this->url, $this->name];
}
```

You may use the `displayFrom` property to keep sorting and searching intact on the database value. The following will search and sort using the `website` attribute and display the link using the `website_link` attribute.

```yaml
website:
    label: Website
    type: linkage
    displayFrom: website_link
```
---
subtitle: List Column
shortname: Currency
---
# Currency Column

`currency` - displays the value as a formatted currency

```yaml
total_amount:
    label: Loan amount
    type: currency
```

::: tip
This column is introduced after installing the [Currency plugin](https://octobercms.com/plugin/responsiv-currency) available on the October CMS marketplace. You may install it with the following command.

```bash
php artisan plugin:install Responsiv.Currency
```
:::

The following properties are supported.

Property | Description
------------- | -------------
**format** | provides a display format. Supported values: `long`, `short`, `null`.
**fromCode** | specify the source currency code.
**toCode** | specify the display currency code.
**site** | display the currency using the multisite definition context. Default: `false`

Use the `format` property to display the column value using a longer format.

```yaml
total_amount:
    label: Loan amount
    type: currency
    format: long
```

Set the `site` property to `true` if the model value is stored using the multisite definition. This will automatically set the `toCode` and `fromCode` values for the site definition.

```yaml
total_amount:
    label: Loan amount
    type: currency
    site: true
```

::: also
* [Currency Twig Filter](../../markup/filter/currency.md)
* [Currency Form Widget](../../element/form/widget-currency.md)
* [Currency Plugin Page](https://octobercms.com/plugin/responsiv-currency)
:::
---
subtitle: List Column
shortname: Date & Time
---
# Date & Time Column

`datetime` - displays the column value as a formatted date and time. The next example displays dates as **Thu, Dec 25, 1975 2:15 PM**.

```yaml
created_at:
    label: Date
    type: datetime
```

You may also specify a custom date format, for example **Thursday 25th of December 1975 02:15:16 PM**.

```yaml
created_at:
    label: Date
    type: datetime
    format: l jS \of F Y h:i:s A
```

The display value is automatically converted to the backend timezone preference, you may disable this using the `useTimezone` option.

```yaml
created_at:
    label: Date
    type: datetime
    useTimezone: false
```

::: tip
The `useTimezone` option also applies to other date and time related field types, including `date`, `time`, `timesince` and `timetense`.
:::

## Date

`date` - displays the column value as date format **M j, Y**.

```yaml
created_at:
    label: Date
    type: date
```

The backend timezone preference is not applied to this value by default. If the date includes a time, you may convert the timezone with the `useTimezone` option.

```yaml
created_at:
    label: Date
    type: date
    useTimezone: true
```

::: tip
The `date` and `time` columns do not apply backend timezone conversions by default since a date and time are both required for the conversion.
:::

## Time

`time` - displays the column value as time format **g:i A**.

```yaml
created_at:
    label: Date
    type: time
```

## Time Since

`timesince` - displays a human readable time difference from the value to the current time. Eg: **10 minutes ago**

```yaml
created_at:
    label: Date
    type: timesince
```

## Time Tense

`timetense` - displays 24-hour time and the day using the grammatical tense of the current date. Eg: **Today at 12:49**, **Yesterday at 4:00** or **18 Sep 2015 at 14:33**.

```yaml
created_at:
    label: Date
    type: timetense
```
---
subtitle: List Column
shortname: Color Picker
---
# Color Picker Column

`colorpicker` - displays a color from colorpicker column

```yaml
color:
    label: Background
    type: colorpicker
```
---
subtitle: Inspector Type
shortname: Object
---
# Object Inspector Type

The `object` inspector type allows defining an object with specific properties editable by users. Object properties are specified with the `properties` attribute. The value of the attribute is an array, which has the same structure as the inspector properties array.

This example above creates an object with three properties. Two of them are displayed as text fields and the third as a dropdown.

```php
public function defineProperties()
{
    return [
        'address' => [
            'title' => 'Address',
            'type' => 'object',
            'properties' => [
                'streetAddress' => [
                    'title' => 'Street Address',
                    'type' => 'string'
                ],
                'city' => [
                    'title' => 'City',
                    'type' => 'string'
                ],
                'country' => [
                    'title' => 'Country',
                    'type' => 'dropdown',
                    'options' => [
                        'us' => 'US',
                        'ca' => 'Canada'
                    ]
                ]
            ],
        ]
    ];
}
```

The generated output is an object, for example:

```json
"address": {
    "streetAddress": "321-210 Second ave",
    "city": "Springfield",
    "country": "us"
}
```

The following [configuration values](../inspector-types.md) are commonly used and supported.

Property | Description
------------- | -------------
**title** | title for the property.
**description** | a brief description of the property, optional.
**properties** | an array of nested property definitions.
**default** | an array of populated items by default containing keys and values.
**ignoreIfPropertyEmpty** | set to an array of values that should be excluded from the output if the value is empty.

::: warning
This type does not support the external parameter editor as specified by the `showExternalParam` property.
:::

The object properties can be of any type supported by inspector, including other objects. There's a way to exclude an object from Inspector values completely, if one of the object fields is empty. The field is identified with `ignoreIfPropertyEmpty` parameter. For example:

```php
public function defineProperties()
{
    return [
        'address' => [
            'title' => 'Address',
            'type' => 'object',
            'ignoreIfPropertyEmpty' => 'title',
            'properties' => [
                'streetAddress' => [
                    'title' => 'Street Address',
                    'type' => 'string'
                ],
                'city' => [
                    'title' => 'City',
                    'type' => 'string'
                ]
            ],
        ]
    ];
}
```

In the example above, if the street address is not specified, the object ("address") will be completely removed from the inspector output. If there are any validation rules defined on other object properties and the required property is empty, those rules will be ignored.

A `default` value for the editor, if specified, should be an object with the same properties as defined in the `properties` configuration parameter.

```php
public function defineProperties()
{
    return [
        'address' => [
            'title' => 'Address',
            'type' => 'object',
            'properties' => [/*...*/],
            'default' => [
                'streetAddress' => '321-210 Second ave',
                'city' => 'Springfield',
                'country' => 'us'
            ]
        ]
    ];
}
```
---
subtitle: Inspector Type
shortname: Object List
---
# Object List Inspector Type

The `objectList` inspector type allows users to create multiple objects with a pre-defined structure. For example, it could be used for creating a list of person, where each person has a name and address.

The properties of objects that can be created with the editor are defined with `itemProperties` parameter. The parameter should contain an array of properties, similar to an inspector configuration array. Another required parameter is `titleProperty`, which identifies a property that should be used as a title in inspector UI.

The array of properties defined with `itemProperties` supports all property types.

```php
public function defineProperties()
{
    return [
        'address' => [
            'title' => 'Address',
            'type' => 'objectList',
            'titleProperty' => 'fullName',
            'itemProperties' => [
                'fullName' => [
                    'title' => 'Full Name',
                    'type' => 'string'
                ],
                'address' => [
                    'title' => 'Address',
                    'type' => 'string'
                ]
            ]
        ]
    ];
}
```

By default the generated output is a non-associative array, for example:

```json
"people": [
    {"fullName": "John Smith", "address": "Palo Alto"},
    {"fullName": "Bart Simpson", "address": "Springfield"}
]
```

The following [configuration values](../inspector-types.md) are commonly used and supported.

Property | Description
------------- | -------------
**title** | title for the property.
**description** | a brief description of the property, optional.
**keyProperty** | use this property key as the title, found in the **itemProperties** definitions.
**titleProperty** | use this property name as the title, found in the **itemProperties** definitions.
**itemProperties** | an array of nested property definitions.

::: warning
The Object List inspector type doesn't support default values.
:::

If the result value should be an associative array (object), use the `keyProperty` configuration option. The option value should refer to a property that should be used as a key. The key property can use only the string or drop-down editors, its value should be unique and cannot be empty.

```php
public function defineProperties()
{
    return [
        'address' => [
            'title' => 'Address',
            'type' => 'objectList',
            'titleProperty' => 'fullName',
            'keyProperty' => 'login',
            'itemProperties' => [
                'fullName' => [
                    'title' => 'Full Name',
                    'type' => 'string'
                ],
                'login' => [
                    'title' => 'Login',
                    'type' => 'string'
                ],
                'address' => [
                    'title' => 'Address',
                    'type' => 'string'
                ]
            ]
        ]
    ];
}
```

The `login` property in the example above will be used as a key in the result value:

```json
"people": {
    "john": {"fullName": "John Smith", "address": "Palo Alto"},
    "bart": {"fullName": "Bart Simpson", "address": "Springfield"}
}
```
---
subtitle: Inspector Type
shortname: Autocomplete
---
# Autocomplete Inspector Type

The `autocomplete` inspector type works like the `string` editor, except it includes auto competion features. Available options can be specified statically with the `options` parameter or loaded dynamically.

```php
public function defineProperties()
{
    return [
        'condition' => [
            'title' => 'Condition',
            'type' => 'autocomplete',
            'options' => ['start' => 'Start', 'end' => 'End']
        ]
    ];
}
```

The generated output is an array value corresponding to the selected options, for example:

```json
"condition": "start"
```

The following [configuration values](../inspector-types.md) are commonly used.

Property | Description
------------- | -------------
**title** | title for the property.
**description** | a brief description of the property, optional.
**default** | specifies a default string value, optional.
**options** | array of options for dropdown properties, optional if defining a `get*PropertyName*Options` method.
**showExternalParam** | unsupported, and should be set to `false`.

::: warning
This type does not support the external parameter editor as specified by the `showExternalParam` property.
:::

## Dynamic Options

The `autocomplete` inspector type support the same methods for defining the options as the [dropdown inspector type](./type-dropdown.md).

```php
public function defineProperties()
{
    return [
        'sortColumn' => [
            'title' => 'Sort by Column',
            'type' => 'autocomplete',
            // ...
        ],
    ];
}

public function getSortColumnOptions()
{
    return [
        'create' => 'Create',
        'update' => 'Update',
        'delete' => 'Delete',
    ];
}
```

#### See Also

::: also
* [Dropdown Inspector Type](./type-dropdown.md)
:::
---
subtitle: Inspector Type
shortname: String List
---
# String List Inspector Type

The `stringList` inspector type allows users to enter lists of strings. The editor opens in a popup window and displays a text area. Each line of text represents an element in the result array. The optional `default` parameter should contain an array of strings.

```php
public function defineProperties()
{
    return [
        'items' => [
            'title' => 'Items',
            'type' => 'stringList',
            'default' => ['String 1', 'String 2']
        ]
    ];
}
```

The generated output is a string value corresponding to the selected option, for example:

```json
"items": ["String 1", "String 2", "String 3"]
```

The following [configuration values](../inspector-types.md) are commonly used.

Property | Description
------------- | -------------
**title** | title for the property.
**description** | a brief description of the property, optional.
**default** | specifies a default value as an array, optional.
---
subtitle: Inspector Type
shortname: Dictionary
---
# Dictionary Inspector Type

The `dictionary` inspector type allows the creation of key-value pairs with a simple user interface consisting of a table with two columns. The `default` parameter, if specified, should contain a key-value object.

```php
public function defineProperties()
{
    return [
        'options' => [
            'title' => 'Options',
            'type' => 'dictionary',
            'default' => ['option1' => 'Option 1'],
        ]
    ];
}
```

The generated output is a string value corresponding to the selected option, for example:

```json
"options": {"option1": "Option 1", "option2": "Option 2"}
```

The following [configuration values](../inspector-types.md) are commonly used.

Property | Description
------------- | -------------
**title** | title for the property.
**description** | a brief description of the property, optional.
**default** | specifies a default an array of keys and values, optional.

## Extra Validation

The `dictionary` editor supports validation for the entire set (`required` and `length` validators) and for keys and values separately. See the [validation descriptions](../inspector-types.md) for further details. The `validationKey` and `validationValue` define validation for keys and values, for example:

```php
public function defineProperties()
{
    return [
        'options' => [
            'title' => 'Options',
            'type' => 'dictionary',
            'validation' => [
                'required' => [
                    'message' => 'Please create options'
                ],
                'length' => [
                    'min' => [
                        'value' => 2,
                        'message' => 'Create at least two options.'
                    ]
                ]
            ],
            'validationKey' => [
                'regex' => [
                    'pattern' => '^[a-z]+$',
                    'message' => 'Keys can contain only lowercase Latin letters'
                ]
            ],
            'validationValue' => [
                'regex' => [
                    'pattern' => '^[a-zA-Z0-9]+$',
                    'message' => 'Values can contain only Latin letters and digits'
                ]
            ]
        ]
    ];
}
```
---
subtitle: Inspector Type
shortname: Checkbox
---
# Checkbox Inspector Type

The `checkbox` inspector type is represented with a checkbox in the interface. This property doesn't have any special parameters. The `default` parameter, if specified, should contain a boolean value or string values `true`, `false`, `1`, `0`.

```php
public function defineProperties()
{
    return [
        'enabled' => [
            'title' => 'Enabled',
            'type' => 'checkbox',
            'default' => true
        ]
    ];
}
```

The generated output is `0` (unchecked) or `1` (checked), for example:

```json
"enabled": 1
```

The following [configuration values](../inspector-types.md) are commonly used.

Property | Description
------------- | -------------
**title** | title for the property.
**description** | a brief description of the property, optional.
**default** | specifies a default as `true` or `false`, optional.
---
subtitle: Inspector Type
shortname: Text
---
# Text Inspector Type

The `text` inspector type allows entering multi-line long text values in a popup window. The editor doesn't have any specific parameters. The optional `default` parameter for the editor should contain a string.

```php
public function defineProperties()
{
    return [
        'description' => [
            'title' => 'Description',
            'type' => 'text',
            'default' => 'This is a default description'
        ]
    ];
}
```

The generated output is a string value corresponding to the selected option, for example:

```json
"description": "This is a description"
```

The following [configuration values](../inspector-types.md) are commonly used.

Property | Description
------------- | -------------
**title** | title for the property.
**description** | a brief description of the property, optional.
**default** | specifies a default string value, optional.
---
subtitle: Inspector Type
shortname: Set
---
# Set Inspector Type

The `set` inspector type is used to make multiple selections from the predefined options. The `set` inspector type support the same methods for defining the options as the [dropdown inspector type](./type-dropdown.md).

```php
public function defineProperties()
{
    return [
        'units' => [
            'title' => 'Select Muitple Units',
            'type' => 'set',
            'items' => [
                'metric' => 'Metric',
                'imperial' => 'Imperial'
            ]
        ]
    ];
}
```

The generated output is an array value corresponding to the selected options, for example:

```json
"units": ["metric", "imperial"]
```

The following [configuration values](../inspector-types.md) are commonly used and supported.

Property | Description
------------- | -------------
**title** | title for the property.
**description** | a brief description of the property, optional.
**items** | an array of available items as keys and values, optional if defining a `get*PropertyName*Options` method.
**default** | an array of selected items by default containing keys only.

The `default` parameter, if specified, should be an array listing item keys selected by default.

```php
public function defineProperties()
{
    return [
        'context' => [
            'title' => 'Context',
            'type' => 'set',
            'items' => [
                'create' => 'Create',
                'update' => 'Update',
                'preview' => 'Preview'
            ],
            'default' => ['create', 'update']
        ]
    ];
}
```

The specify the `items` dynamically, use create a method called `get*PropertyName*Options` defined in the model.

```php
public function getContextOptions()
{
    return ContextModel::pluck('name', 'code')->all();
}
```

#### See Also

::: also
* [Dropdown Inspector Type](./type-dropdown.md)
:::
---
subtitle: Inspector Type
shortname: Dropdown
---
# Dropdown Inspector Type

The `dropdown` inspector type is used to make a single from a set of predefined options. The option list for dropdown and set properties can be static or dynamic. Static options are defined with the `options` element of the property definition.

```php
public function defineProperties()
{
    return [
        'unit' => [
            'title' => 'Unit',
            'type' => 'dropdown',
            'default' => 'imperial',
            'placeholder' => 'Select units',
            'options' => ['metric' => 'Metric', 'imperial' => 'Imperial']
        ]
    ];
}
```

The generated output is a string value corresponding to the selected option, for example:

```json
"unit": "metric"
```

The following [configuration values](../inspector-types.md) are commonly used.

Property | Description
------------- | -------------
**title** | title for the property.
**description** | a brief description of the property, optional.
**default** | specifies a default string value, optional.
**options** | array of options for dropdown properties, optional if defining a `get*PropertyName*Options` method.

## Dynamic Options

The list of options could be fetched dynamically from the server when the Inspector is displayed. If the `options` parameter is omitted in a dropdown or set property definition the option list is considered dynamic. The component class must define a method returning the option list. The method should have a name in the following format: `get*PropertyName*Options`, where **Property** is the property name, for example: `getCountryOptions`. The method returns an array of options with the option values as keys and option labels as values. Example of a dynamic dropdown list definition.

```php
public function defineProperties()
{
    return [
        'country' => [
            'title' => 'Country',
            'type' => 'dropdown',
            'default' => 'us'
        ]
    ];
}

public function getCountryOptions()
{
    return ['us' => 'United states', 'ca' => 'Canada'];
}
```

Dynamic dropdown and set lists can depend on other properties. For example, the state list could depend on the selected country. The dependencies are declared with the `depends` parameter in the property definition. The next example defines two dynamic dropdown properties and the state list depends on the country.

```php
public function defineProperties()
{
    return [
        'country' => [
            'title' => 'Country',
            'type' => 'dropdown',
            'default' => 'us'
        ],
        'state' => [
            'title' => 'State',
            'type' => 'dropdown',
            'default' => 'dc',
            'depends' => ['country'],
            'placeholder' => 'Select a state'
        ]
    ];
}
```

In order to load the state list you should know what country is currently selected in the Inspector. The Inspector POSTs all property values to the `getPropertyOptions` handler, so you can do the following.

```php
public function getStateOptions()
{
    // Load the country property value from POST
    $countryCode = post('country');

    $states = [
        'ca' => ['ab' => 'Alberta', 'bc' => 'British columbia'],
        'us' => ['al' => 'Alabama', 'ak' => 'Alaska']
    ];

    return $states[$countryCode];
}
```

## Page List Properties

Sometimes components need to create links to the website pages. For example, the blog post list contains links to the blog post details page. In this case the component should know the post details page file name (then it can use the [page Twig filter](../../markup/filter/page.md)). October includes a helper for creating dynamic dropdown page lists. The next example defines the postPage property which displays a list of pages:

```php
public function defineProperties()
{
    return [
        'postPage' => [
            'title' => 'Post page',
            'type' => 'dropdown',
            'default' => 'blog/post'
        ]
    ];
}

public function getPostPageOptions()
{
    return Page::sortBy('baseFileName')->lists('baseFileName', 'baseFileName');
}
```
---
subtitle: Inspector Type
shortname: String
---
# String Inspector Type

The `string` inspector type allows entering a single line of a text and represented with a simple input text field. The editor doesn't have any specific parameters. The optional `default` parameter for the editor should contain a string.

```php
public function defineProperties()
{
    return [
        'firstName' => [
            'title' => 'First Name',
            'type' => 'string',
            'default' => 'John'
        ]
    ];
}
```

The generated output is a string value corresponding to the selected option, for example:

```json
"firstName": "Sam"
```

The following [configuration values](../inspector-types.md) are commonly used.

Property | Description
------------- | -------------
**title** | title for the property.
**description** | a brief description of the property, optional.
**default** | specifies a default string value, optional.
**showExternalParam** | specifies visibility of the external parameter editor for the property in the Inspector. Default: `true`.
---
subtitle: Learn how to filter lists using scopes.
---
# Filter Scopes

Filter Scopes are scope definitions used by filters, often in conjunction with a list. Similar to list columns these are referenced by the following areas:

- [Backend List Controller](../extend/lists/list-controller.md)
- [Backend Relation Controller](../extend/forms/relation-controller.md)

All filter scopes are identified as their individual **type** property.

```yaml
scopes:
    myscope:
        type: date
        # ...
```

## Available Scopes

The following filter scopes are available:

<div class="content-list-p" markdown="1">

[Checkbox](./filter/scope-checkbox.md)
[Switch](./filter/scope-switch.md)
[Text](./filter/scope-text.md)
[Number](./filter/scope-number.md)
[Dropdown](./filter/scope-dropdown.md)
[Group](./filter/scope-group.md)
[Date](./filter/scope-date.md)

</div>

## Scope Properties

For each scope you can specify these properties (where applicable).

Property | Description
------------- | -------------
**label** | a name when displaying the filter scope to the user.
**type** | defines how this scope should be displayed. Default: `group`.
**conditions** | enables or disables condition functions or specifies a raw where query statement to apply to each condition, see the scope type definition for details.
**modelClass** | class of the model to use as a data source and reference for local method calls.
**modelScope** | specifies a [query scope method](../extend/database/model.md) defined in the **list model** to apply to the list query. The first argument will contain the query object (as per a regular scope method) and the second argument will contain the scope definition, including its populated value(s).
**options** | options to use if filtering by multiple items, supplied as an array.
**optionsMethod** | request options from a method name defined on the model or as a static method call, eg `Class::method`.
**emptyOption** | an optional label for an intentional empty selection.
**default** | supply a default value for the filter, as either array, string or integer depending on the filter value.
**permissions** | the [permissions](../extend/backend/permissions.md) that the current backend user must have in order for the filter scope to be used. Supports either a string for a single permission or an array of permissions of which only one is needed to grant access.
**dependsOn** | a string or an array of other scope names that this scope depends on. When the other scopes are modified, this scope will reset.
**nameFrom** | a model attribute name used for displaying the filter label. Default: `name`.
**valueFrom** | defines a model attribute to use for the source value. Default comes from the scope name.
**order** | a numerical weight when determining the display order, default value increments at 100 points per scope.
**after** | place this scope after another existing scope name using the display order (+1).
**before** | place this scope before another existing scope name using the display order (-1).

### Applying Model Scopes

Most filters will apply their scoped constraints using sensible defaults. The `modelScope` property can be used to apply custom constraints to the filter query using a [model scope method definition](../extend/database/model.md).

```yaml
myfilter:
    label: My Filter
    type: group
    modelScope: applyMyFilter
```

In the above example, we expect a relation on the primary model called **myfilter** and a method defined named **scopeApplyMyFilter** on the related model. The second argument contains the second argument will contain the scope definition, including its populated value(s).

```php
public function scopeApplyMyFilter($query, $scope)
{
    return $query->whereIn('my_filter_attribute', (array) $scope->value);
}
```

The `modelScope` property can also be defined as a static PHP class method (`Class::method`).

```yaml
myfilter:
    label: My Filter
    type: group
    modelScope: "App\MyCustomClass::applyMyFilter"
```

In this example, the method should be declared statically on the specified class name.

```php
namespace App;

class MyCustomClass
{
    public static function applyMyFilter($query, $scope)
    {
        return $query->whereIn('my_filter_attribute', (array) $scope->value);
    }
}
```

### Scope Dependencies

The `dependsOn` property allows you to link multiple filters together. When a dependency is modified, the filter scope will reset to allow for new conditions. Take the following example of two scope definitions.

```yaml
country:
    label: Country
    type: group

state:
    label: State
    type: group
    dependsOn: country
    optionsMethod: getCityOptionsForFilter
```

The state scope depends on the value of the country scope, and the options are filtered in PHP using the **getCityOptionsForFilter** method. The first argument of this method will contain the entire set of scope definitions, including their current values.

```php
public function getCityOptionsForFilter($scopes = null)
{
    if ($scopes->country && ($countryIds = $scopes->country->value)) {
        return self::whereIn('country_id', $countryIds)->lists('name', 'id');
    }

    return self::lists('name', 'id');
}
```
---
subtitle: Content Field
shortname: Mixin
---
# Mixin Field

`mixin` - includes another set of fields.

```yaml
_include1:
    type: mixin
    source: <uuid|handle>
```

::: tip
When using a mixin, consider prefixing the field name with an underscore (\_) to make them easy to spot.
:::

To include a mixin, you may reference the `source` as the blueprint handle.

```yaml
_location_fields:
    type: mixin
    source: Fields\Location
```

For a more robust reference, you may also specify the UUID.

```yaml
_blog_fields:
    type: mixin
    source: 6d6a5efa-3ce7-4b9d-bddc-ac48867552cb
```

See the [Blueprints article](../../cms/tailor/blueprints.md) for more information on defining mixins.


#### See Also

::: also
* [Tailor Blueprints](../../cms/tailor/blueprints.md)
:::
---
subtitle: Content Field
shortname: Entries
---
# Entries Field

`entries` - links to other entries by UUID or handle.

```yaml
author:
    label: Author
    type: entries
    source: <uuid|handle>
```

The following properties are supported.

Property | Description
------------- | -------------
**source** | the related blueprint UUID or handle name.
**maxItems** | limits the number of entries that can be selected.
**displayMode** | modifies how the field is displayed. Supported values: `relation`, `recordfinder`, `taglist`, `controller`. Default: `relation`.
**conditions** | specifies a raw where query statement to apply to the model query.
**scope** | applies a [query scope method](../../extend/database/model.md) to the **related form model**, can be a model method name or a static PHP class method (`Class::method`).
**inverse** | when defined as an inverse relationship, the name of the related field in the source blueprint.

To limit the number of selectable items, use the `maxItems` property.

```yaml
author:
    type: entries
    maxItems: 1
```

To display a record finder instead of the typical control, use the `displayMode` property. This mode is only available when one item is selectable.

```yaml
author:
    type: entries
    displayMode: recordfinder
```

When multiple items are available, the `displayMode` supports selecting items using a tag list.

```yaml
author:
    type: entries
    displayMode: taglist
```

## Applying Conditions

You can restrict the related query using SQL or PHP using the approaches below. In the examples, the related record has a field called `is_featured` that renders as a checkbox. We can limit the related records to only those that have this checkbox marked.

### SQL Query Condition

You may limit the related model using a raw SQL query using the `conditions` property.

```yaml
categories:
    label: Categories
    type: entries
    source: Blog\Category
    conditions: is_featured = true
```

### PHP Query Scopes

You may limit the related query using a PHP method with the `scope` property.

```yaml
basic_entries:
    label: Basic Entry
    type: entries
    source: Basic\Entry
    scope: App\Classes\ScopeHelper::applyScope
```

This would refer to the `App\Classes\ScopeHelper` class that may look a file located in **app/classes/ScopeHelper.php**, for example.

```php
namespace App\Classes;

class ScopeHelper
{
    public static function applyScope($query)
    {
        return $query->where('is_featured', true);
    }
}
```

## Defining the Inverse Relation

In some cases you may wish to access the relationship in reverse, such as finding all posts that belong to a certain category. The `inverse` property can be used to link the relationship in the opposite direction, where the property value is set to the field name in the source blueprint.

For example, if a **Blog\Post** blueprint has a `categories` relationship already defined.

```yaml
categories:
    type: entries
    source: Blog\Category
```

The **Blog\Category** blueprint can include a `posts` field as the `inverse` of the `categories` field found in the source blueprint (above). The field can be excluded from forms by setting the `hidden` value to `true`, and this is optional.

```yaml
posts:
    type: entries
    source: Blog\Post
    inverse: categories
    hidden: true
```

## List Column Display

By default, the entries field will display as a hyperlink to the related record.

### Display as a Counter

To display the list column to show a counter of related records, you may use the following [column configuration](../list-columns.md). The `relation` property should be set to the field name, with `relationCount` set to `true` and a `number` column type.

```yaml
categories:
    label: Categories
    type: entries
    # ...
    column:
        relation: categories
        relationCount: true
        type: number
```

## Advanced Record Management

To create, update and delete items within the form, set the `displayMode` to controller to show an advanced management mode, powered by [Relation Controller behavior](../../extend/forms/relation-controller.md).

```yaml
author:
    type: entries
    displayMode: controller
```

If the blueprint has `navigation` set to `false` then the default buttons will show **Create** and **Delete**. If the navigation is defined, then the buttons show **Add** and **Remove**. You may customize the buttons with the `toolbarButtons` property.

```yaml
author:
    type: entries
    toolbarButtons: create|add|remove|delete
```

The various messages used in the relation controller are taken from the source blueprint `customMessages`, property, and you may also modify them using the `customMessages` on the field definition.

```yaml
author:
    type: entries
    customMessages:
        buttonCreate: New Author
        titleUpdateForm: Update Author
        titleCreateForm: Create Author
```

#### See Also

::: also
* [Nested Items Content Field](./field-nesteditems.md)
:::
---
subtitle: Content Field
shortname: Nested Items
---
# Nested Items Field

`nesteditems` - creates nested records belonging exclusively to the current record.

```yaml
items:
    label: Menu Items
    type: nesteditems
    span: adaptive
    form:
        fields:
            title:
                label: Title
                type: text
```

<VideoBlockLink src="https://www.youtube.com/watch?v=vhs9U3_BHqg" title="Nested Items Tutorial" description="This video demonstrates how to implement the Nested Items content field using step by step instructions." prompt="Watch the tutorial" />

The following properties are supported.

Property | Description
------------- | -------------
**label** | a name when displaying the form field to the user.
**default** | specifies a default array value, optional.
**comment** | places a descriptive comment below the field.
**form** | inline form field definitions.
**maxDepth** | displays an interface for reordering records, specifying the maximum depth. Set to `0` for unlimited depth.
**customMessages** | customize the messages used in the user interface.

Like any other form, nested items support the use of tabs by placing the fields under the `tabs` or `secondaryTabs` properties of the `form` definition.

```yaml
tabbed_content:
    type: nesteditems
    form:
        tabs:
            fields:
                # ...
```

The `customMessages` property is used to modify the various messages used on the field definition. The available messages are shared with the [Relation Controller behavior](../../extend/forms/relation-controller.md) messages.

```yaml
author:
    type: nesteditems
    customMessages:
        buttonCreate: New Author
        titleUpdateForm: Update Author
        titleCreateForm: Create Author
```

#### See Also

::: also
* [Entries Content Field](./field-entries.md)
* [Repeater Form Field](../form/widget-repeater.md)
:::
---
subtitle: Learn how to define component properties.
---
# Inspector Types

Inspector Types are property types used by CMS components. These are referenced by the following areas:

- [CMS Component Classes](../extend/cms-components.md)

All inspector types are identified as their individual **type** property.

```php
public function defineProperties()
{
    return [
        'maxItems' => [
            'title' => 'Max Items',
            'type' => 'string'
        ]
    ];
}
```

## Available Types

The following inspector types are available:

<div class="content-list-p" markdown="1">

[String](./inspector/type-string.md)
[String List](./inspector/type-stringlist.md)
[Text](./inspector/type-text.md)
[Autocomplete](./inspector/type-autocomplete.md)
[Checkbox](./inspector/type-checkbox.md)
[Dropdown](./inspector/type-dropdown.md)
[Dictionary](./inspector/type-dictionary.md)
[Object](./inspector/type-object.md)
[Object List](./inspector/type-objectlist.md)
[Set](./inspector/type-set.md)

</div>

## Available Configuration

The property parameters are defined with an array with the following keys.

Key | Description
------------- | -------------
**title** | required, the property title, it is used by the component Inspector in the CMS backend.
**description** | required, the property description, it is used by the component Inspector in the CMS backend.
**default** | optional, the default property value to use when the component is added to a page or layout in the CMS backend.
**type** | specifies the property type, which defines how the property is displayed in the Inspector.
**validation** | optional, specifies validation rules for the property value (see below).
**placeholder** | optional placeholder for string and dropdown properties.
**options** | optional array of options for dropdown properties.
**optionsMethod** | specify a method name on the component class to source options.
**depends** | an array of property names a dropdown property depends on. See the [dropdown type](./inspector/type-dropdown.md) for more information.
**group** | an optional group name. Groups create sections in the Inspector simplifying the user experience. Use a same group name in multiple properties to combine them.
**showExternalParam** | specifies visibility of the external parameter editor for the property in the Inspector. Default: `true`.
**ignoreIfDefault** | set to `true` to exclude the output from the array if the selection matches default value. Default: `false`
**ignoreIfEmpty** | set to `true` to exclude the output from the array if the selection has an empty value. Default: `false`
**sortOrder** | specify a custom position as an integer for the property in the available list.

## Validation Rules

Inspector types support several validation rules that can be applied to properties. Validation rules can be applied to top-level properties as well as to internal property definitions of object and object list editors.

```php
public function defineProperties()
{
    return [
        'name' => [
            'title' => 'Name',
            'type' => 'string',
            'validation' => [
                'required' => [
                    'message' => 'The Name field is required'
                ],
                'regex' => [
                    'message' => 'The Name field can contain only Latin letters.',
                    'pattern' => '^[a-zA-Z]+$'
                ]
            ]
        ]
    ];
}
```

The key value in the `validation` object refers to a validator (see below). Validators are configured with objects, which properties depend on a validator. One property - `message` is common for all validators.

### Required Validator

The `required` validator checks if a value is not empty. The validator can be used with any editor, including complex editors (sets, dictionaries, object lists, etc.). Example:

```php
public function defineProperties()
{
    return [
        'name' => [
            'title' => 'Name',
            'type' => 'string',
            'validation' => [
                'required' => [
                    'message' => 'The Name field is required'
                ]
            ]
        ]
    ];
}
```

### Regex Validator

The `regex` validator validates string values with a regular expression. The validator can be used only with string-typed editors. Example:


```php
public function defineProperties()
{
    return [
        'name' => [
            'title' => 'Name',
            'type' => 'string',
            'validation' => [
                'regex' => [
                    'message' => 'The Name field can contain only Latin letters',
                    'pattern' => '^[a-z]+$',
                    'modifiers' => 'i'
                ]
            ]
        ]
    ];
}
```

The regular expression is specified with the required `pattern` parameter. The `modifiers` parameter is optional and can be used for setting regular expression modifiers.

### Integer Validator

The `integer` validator checks if the value is integer and can optionally validate if the value is within a specific interval. The validator can be used only with string-typed editors. Example:


```php
public function defineProperties()
{
    return [
        'numOfColumns' => [
            'title' => 'Number of Columns',
            'type' => 'string',
            'validation' => [
                'integer' => [
                    'message' => 'The Number of Columns field should contain an integer value',
                    'allowNegative' => true,
                    'min' => [
                        'value' => -10,
                        'message' => 'The number of columns should not be less than -10.'
                    ],
                    'max' => [
                        'value' => 10,
                        'message' => 'The number of columns should not be greater than 10.'
                    ]
                ]
            ]
        ]
    ];
}
```

Supported parameters:

* `allowNegative` - optional, determines if negative values are allowed. By default negative values are not allowed.
* `min` - optional object, defines the minimum allowed value and error message. Object fields:
    * `value` - defines the minimum value.
    * `message` - optional, defines the error message.
* `max` - optional object, defines the maximum allowed value and error message. Object fields:
    * `value` - defines the maximum value.
    * `message` - optional, defines the error message.

### Float Validator

The `float` validator checks if the value is a floating point number. The parameters for this validator match the parameters of the **integer** validator described above. Example:

```php
public function defineProperties()
{
    return [
        'amount' => [
            'title' => 'Amount',
            'type' => 'string',
            'validation' => [
                'float' => [
                    'message' => 'The Amount field should contain a positive floating point value'
                ]
            ]
        ]
    ];
}
```

Valid floating point number formats:

* 10
* 10.302
* -10 (if `allowNegative` is `true`)
* -10.84 (if `allowNegative` is `true`)

### Length Validator

The `length` validator checks if a string, array or object is not shorter or longer than specified values. This validator can work with the string, text, set, string list, dictionary and object list editors. In multiple-value editors (set, string list, dictionary and object list) it validates the number of items created in the editor.

::: tip
The `length` validator doesn't validate empty values. For example, if it's applied to a set editor, and the set is empty, the validation will pass regardless of the `min` and `max` parameter values. Use the `required` validator together with the `length` validator to make sure that the value is not empty before the length validation is applied.
:::

```php
public function defineProperties()
{
    return [
        'name' => [
            'title' => 'Name',
            'type' => 'string',
            'validation' => [
                'length' => [
                    'min' => [
                        'value' => 2,
                        'message' => 'The name should not be shorter than two letters.'
                    ],
                    'max' => [
                        'value' => 10,
                        'message' => 'The name should not be longer than 10 letters.'
                    ]
                ]
            ]
        ]
    ];
}
```

Supported parameters:

* `min` - optional object, defines the minimum allowed length and error message. Object fields:
    * `value` - defines the minimum value.
    * `message` - optional, defines the error message.
* `max` - optional object, defines the maximum allowed length and error message. Object fields:
    * `value` - defines the maximum value.
    * `message` - optional, defines the error message.
---
subtitle: Defining the options property used across many definitions.
---
# Defining Options

Commonly, you may encounter the **options**, **optionsMethod** or **optionsPreset** property, this article describes in more detail how to configure options.

## Option Arrays

The `options` property should specify the options directly as part of the definition as a key-value pair, where the value and label are independently specified.

```yaml
options:
    draft: Draft
    published: Published
    archived: Archived
```

The keys can be integers with their label.

```yaml
options:
    1: Simple
    2: Complex
```

In addition to a simple arrays, some fields such as [radio lists](./form/field-radio.md) support specifying a description as part of their `options` values. This is where the value is defined as another array with the syntax `key: [label, description]`.

```yaml
options:
    all: [All, Guests and customers will be able to access this page.]
    registered: [Registered only, Only logged in member will be able to access this page.]
    guests: [Guests only, Only guest users will be able to access this page.]
```

Other fields, such as [dropdown fields](./form/field-dropdown.md) support specifying an icon, image or color as part of their `options` values. If the second item in the array starts with a `#` then it is considered a color, and if the value contains a `.` then it is considered an image, otherwise it is considered an icon class.

```yaml
options:
    red: [Color, '#ff0000']
    icon: [Icon, 'oc-icon-calendar']
    image: [Image, '/path/to/image.png']
```

## Option Methods

The `optionsMethod` property specifies a callable PHP method that can be used to request the available options. Typically the method name will refer to a method local to the associated model.

```yaml
optionsMethod: getMyOptionsFromModel
```

The method name can also be a static method on any object.

```yaml
optionsMethod: MyAuthor\MyPlugin\Helpers\FormHelper::getMyStaticMethodOptions
```

## Option Presets

The `optionsPreset` property specifies a preset code that can be used to request the available options.

```yaml
optionsPreset: icons
```

The following presets are available:

Preset | Description
------ | -----------
**icons** | Lists available icon names (eg: `icon-calendar`)
**phosphorIcons** | Lists available icon names (eg: `ph ph-calendar`)
**locales** | Lists available locales (eg: `en-au`)
**flags** | Lists locales with their icons as flags (eg: `[en-au, flag-au]`)
**timezones** | Lists available timezones (eg: `Australia/Sydney`)
---
subtitle: Learn about the different form field types.
---
# Form Fields

Form Fields, Form UI and Form Widgets are field definitions used by forms, such as a text input. These are commonly referred to by the following areas:

- [CMS Theme Settings](../cms/themes/settings.md)
- [Tailor Content Fields](../cms/tailor/content-fields.md)
- [Backend Form Controller](../extend/forms/form-controller.md)
- [Backend Relation Controller](../extend/forms/relation-controller.md)

All form fields are identified as their individual **type** property.

```yaml
fields:
    myfield:
        type: textarea
        # ...
```

Form Fields contain generic and simple fields. Form UI is for user interface elements that can be included in forms to help with the layout design. Form Widgets will often introduce more complex functionality, it is common for plugins to provide their own custom form widgets. Tailor Fields are fields that are only available inside tailor blueprints.

## Available Fields

The following form fields are available:

<div class="content-list-p" markdown="1">

[Mixin](./content/field-mixin.md)
[Entries](./content/field-entries.md)
[Text](./form/field-text.md)
[Number](./form/field-number.md)
[Password](./form/field-password.md)
[Email](./form/field-email.md)
[Textarea](./form/field-textarea.md)
[Dropdown](./form/field-dropdown.md)
[Radio List](./form/field-radio.md)
[Balloon Selector](./form/field-balloon.md)
[Checkbox](./form/field-checkbox.md)
[Checkbox List](./form/field-checkboxlist.md)
[Switch](./form/field-switch.md)
[Code Editor](./form/widget-codeeditor.md)
[Color Picker](./form/widget-colorpicker.md)
[Data Table](./form/widget-datatable.md)
[Date Picker](./form/widget-datepicker.md)
[File Upload](./form/widget-fileupload.md)
[Markdown Editor](./form/widget-markdown.md)
[Media Finder](./form/widget-mediafinder.md)
[Nested Form](./form/widget-nestedform.md)
[Record Finder](./form/widget-recordfinder.md)
[Relation](./form/widget-relation.md)
[Repeater](./form/widget-repeater.md)
[Rich Editor](./form/widget-richeditor.md)
[Page Finder](./form/widget-pagefinder.md)
[Sensitive](./form/widget-sensitive.md)
[Tag List](./form/widget-taglist.md)
[Currency](./form/widget-currency.md)
[Boxes](./form/widget-boxes.md)
[Section](./form/ui-section.md)
[Hint](./form/ui-hint.md)
[Ruler](./form/ui-ruler.md)
[Partial](./form/ui-partial.md)

</div>

## Field Properties

For each field you can specify these common properties, where applicable.

Property | Description
------------- | -------------
**label** | a name when displaying the form field to the user.
**type** | defines how this field should be rendered. Default: `text`.
**span** | aligns the form field to one side. Options: `auto`, `left`, `right`, `row`, `full`. Default: `full`.
**spanClass** | used with the span `row` property to display the form as a Bootstrap grid, for example, `spanClass: col-4`.
**size** | specifies a field size for fields that use it, for example, the textarea field. Options: `tiny`, `small`, `large`, `huge`, `giant`.
**placeholder** | if the field supports a placeholder value.
**comment** | places a descriptive comment below the field.
**commentAbove** | places a comment above the field.
**commentHtml** | allow HTML markup inside the comment. Options: `true`, `false`.
**default** | specify the default value for the field. For `dropdown`, `checkboxlist`, `radio` and `balloon-selector` widgets, you may specify an option key here to have it selected by default.
**defaultFrom** | takes the default value from the value of another model attribute.
**tab** | assigns the field to a tab.
**cssClass** | assigns a CSS class to the field container.
**autoFocus** | flags the field to be focused when the form loads. Default: `false`.
**readOnly** | prevents the field from being modified. Options: `true`, `false`.
**disabled** | prevents the field from being modified and excludes it from the saved data. Options: `true`, `false`.
**hidden** | hides the field from the view and excludes it from the saved data. Options: `true`, `false`.
**stretch** | specifies if this field stretches to fit the parent height.
**context** | specifies what context should be used when displaying the field. Context can also be passed by using an `@` symbol in the field name, for example, `name@update`.
**dependsOn** | an array of other field names this field [depends on](../extend/forms/field-dependencies.md), when the other fields are modified, this field will update.
**changeHandler** | the name of an AJAX handler to call when the field value is changed, optional.
**trigger** | specify conditions for this field using trigger events.
**preset** | allows the field value to be initially set by the value of another field, converted using the input preset converter.
**required** | places a red asterisk next to the field label to indicate it is required. Be sure to use the [validation trait on the model](../extend/database/traits.md) as this is not enforced by the form controller.
**attributes** | specify custom HTML attributes to add to the form field element.
**containerAttributes** | specify custom HTML attributes to add to the form field container.
**order** | a numerical weight when determining the display order, default value increments at 100 points per field.
**permissions** | the [permissions](../extend/backend/permissions.md) that the current backend user must have in order for the field to be used. Supports either a string for a single permission or an array of permissions of which only one is needed to grant access.

### Tab Properties

An example of specifying field definitions in tabs.

```yaml
tabs:
    fields:
        username:
            type: text
            label: Username
            tab: User

        groups:
            type: relation
            label: Groups
            tab: Groups
```

For each tab definition, namely `tabs` and `secondaryTabs`, you can specify these properties.

Property | Description
------------- | -------------
**stretch** | specifies if this tab stretches to fit the parent height.
**defaultTab** | the default tab to assign fields to. Default: Misc.
**activeTab** | selected tab when the form first loads, name or index. Default: `1`
**icons** | assign icons to tabs using tab names as the key.
**lazy** | array of tabs to be loaded dynamically when clicked. Useful for tabs that contain large amounts of content.
**identifiers** | array of custom HTML identifiers for targeting the tab. Useful for showing and hiding tabs using JavaScript.
**linkable** | determines if the tabs can be linked using URL fragments. Default: `true`
**cssClass** | assigns a CSS class to the tab container.
**paneCssClass** | assigns a CSS class to an individual tab pane. Value is an array, key is tab index or label, value is the CSS class. It can also be specified as a string, in which case the value will be applied to all tabs.

An example applying properties to tabs.

```yaml
tabs:
    stretch: true
    defaultTab: User
    cssClass: text-blue

    lazy:
        - Groups

    paneCssClass:
        1: first-tab
        2: second-tab

    icons:
        User: icon-user
        Groups: icon-group

    identifiers:
        User: userTab

    fields:
        # [...]
```

### Custom Field Types

There are various native field types that can be used for the **type** setting. It is also possible to render a field directly by specifying the PHP class name of a [form field widget](../extend/forms/form-widgets.md).

```yaml
blog_content:
    type: Backend\FormWidgets\RichEditor
    size: huge
```

### Nested Field Selection

```yaml
avatar[name]:
    label: Avatar
    comment: will be saved in the Avatar table
```

The above example would fetch and save the value in PHP equivalent of `$record->avatar->name` or `$record->avatar['name']` respectively.

### Field Facades

Sometimes you may need to display a field while preventing it from being submitted. A field can be defined as a facade by adding an underscore (\_) before the name of the field. These fields are purged automatically and no longer saved to the model, such as with the following `_map` field.

```yaml
address:
    label: Title
    type: text

_map:
    label: Point your address on the map
    type: mapviewer
```

## Field Conditions

Sometimes you may want to manipulate the value or appearance of a form field under certain conditions, for example, you may want to hide an input if a checkbox is ticked or preset the value of another field.

### Trigger Events

Trigger Events are defined with the `trigger` form field property and is a simple browser based solution that uses JavaScript. It allows you to change elements attributes such as visibility or value, based on another elements' state. Here is a sample definition:

```yaml
is_delayed:
    label: Send later
    comment: Place a tick in this box if you want to send this message at a later time.
    type: checkbox

send_at:
    label: Send date
    type: datepicker
    cssClass: field-indent
    trigger:
        action: show
        field: is_delayed
        condition: checked
```

In the above example the `send_at` form field will only be shown if the `is_delayed` field is checked. In other words, the field will show (action) if the other form input (field) is checked (condition).

The `trigger` definition specifies these properties.

Property | Description
------------- | -------------
**action** | defines the action applied to this field when the condition is met. Supported values: `show`, `hide`, `enable`, `disable`, `empty`, `fill[somevalue]`.
**field** | reference to the other field name that triggers the action. Example: `color` or `color[]`.
**condition** | determines the condition the specified field should satisfy for the condition to be considered `true`. Supported values: `checked`, `unchecked`, `value[somevalue]`.

#### Multiple Actions

You may combine multiple actions by separating them with a pipe `|` symbol. The following will both display and empty the input when the trigger condition is met.

```yaml
trigger:
    action: show|empty
    condition: checked
    field: name
```

#### Multiple Value Conditions

When using the `value[]` condition, you may look for multiple values by passing extra values after the first one, which takes the format `value[][]`.

```yaml
trigger:
    action: show
    condition: value[csv][csv_custom]
    field: file_format
```

#### Wildcard Value Conditions

You may check the `value[]` condition matches multiple possible values using a wildcard character (`*`), for example, **foo\*** matches anything that starts with "foo", and **\*bar** matches anything that ends with "bar".

```yaml
trigger:
    action: show
    condition: value[*.mp4]
    field: file_name
```

#### Multiple Field Values

Some fields, such as [Checkbox List](./form/field-checkboxlist.md) and [Tag List](./form/widget-taglist.md), will store their values as an array. When referencing these fields, the field name should use an array suffix (`[]`) to look at all possible values. For example, if a `colors` field name supports multiple values, the field name `colors[]` should be used as a reference.

```yaml
trigger:
    action: show
    condition: value[red][green]
    field: colors[]
```

#### Referencing Parent Fields

Normally the field name refers to a field in the same level form. For example, if this field is in a [repeater widget](./form/widget-repeater.md), only fields in that same repeater widget will be checked. However, if the field name is preceded by a caret symbol `^` like: `^parent_field`, it will refer to a repeater widget or form one level higher than the field itself.

In the example below, the `colors` field will be shown when the `type` field is set to **Complex**.

```yaml
fields:
    type:
        label: Type
        type: dropdown
        options:
            1: Simple
            2: Complex

    content:
        label: Content
        type: nestedform
        form:
            fields:
                colors:
                    label: Colors
                    type: colorpicker
                    trigger:
                        action: show
                        field: ^type
                        condition: value[2]
```

::: tip
Additionally, if more than one caret `^` is used, it will refer that many levels higher: `^^grand_parent_field`, `^^^grand_grand_parent_field`, etc.
:::

### Input Preset Converter

The input preset converter is defined with the `preset` form field property and allows you to convert text entered into an element to a URL, slug or file name value in another input element.

In this example we will automatically fill out the `url` field value when a user enters text in the `title` field. If the text **Hello world** is typed in for the Title, the URL will follow suit with the converted value of **/hello-world**. This behavior will only occur when the destination field (`url`) is empty and untouched.

```yaml
title:
    label: Title

url:
    label: URL
    preset:
        field: title
        type: url
```

Alternatively, the `preset` value can also be a string that refers to the **field** only, the `type` option will then default to **slug**.

```yaml
slug:
    label: Slug
    preset: title
```

The following options are available for the `preset` option:

Option | Description
------------- | -------------
**field** | defines the other field name to source the value from.
**type** | specifies the conversion type. See below for supported values.
**prefixInput** | optional, prefixes the converted value with the value found in the supplied input element using a CSS selector.

Following are the supported types:

Type | Description
------------- | -------------
**exact** | copies the exact value
**slug** | formats the copied value as a slug
**url** | same as slug but prefixed with a /
**camel** | formats the copied value with camelCase
**file** | formats the copied value as a file name with whitespace replaced with dashes
---
subtitle: Filter Scope
shortname: Dropdown
---
# Dropdown Scope

`dropdown` - filter using a single selection of multiple items.

```yaml
status:
    type: dropdown
    options:
        pending: Pending
        active: Active
        closed: Closed
```

The following properties are available for the filter.

Property | Description
------------- | -------------
**options** | available options for the filter, as an array.
**optionsMethod** | take options from a method defined on the model or as a static method, eg `Class::method`.
**conditions** | a custom SQL select statement to use for the filter.
**emptyOption** | text to display when there is no available selections.
**modelScope** | applies a [query scope method](../../extend/database/model.md) to the filter query, can be a model method name or a static PHP class method (`Class::method`). The first argument will contain the model query that the widget will be attaching its value to, i.e. the parent model.

You may pass custom SQL to the conditions as a string where `:value` contains the filtered value.

```yaml
status:
    type: dropdown
    conditions: status = :value
    # ...
```

The dropdown filter does not display a label, the `emptyOption` property can be used to set the default state.

```yaml
status:
    type: dropdown
    emptyOption: Select Status
    # ...
```

## PHP Interface

You may define a custom `modelScope` in the model using the following example.

```yaml
status:
    label: Status
    type: dropdown
    modelScope: applyStatusCode
    options:
        active: Active
        deleted: Deleted
```

The **scopeApplyStatusCode** method definition where the value is found in `$scope->value`.

```php
public function scopeApplyStatusCode($query, $scope)
{
    if ($scope->value === 'active') {
        return $query->withoutTrashed();
    }

    if ($scope->value === 'deleted') {
        return $query->onlyTrashed();
    }
}
```

You may dynamically supply options by passing a model method to the `optionsMethod` property.

```yaml
status:
    label: Status
    type: dropdown
    optionsMethod: getStatusOptions
```

The **getStatusOptions** method definition.

```php
public function getStatusOptions()
{
    return [
        'active' => 'Active',
        'deleted' => 'Deleted',
    ];
}
```
---
subtitle: Filter Scope
shortname: Text
---
# Text Scope

`text` - filter using a plain text input with either `exact` or `contains` condition logic.

```yaml
username:
    label: Username
    type: text
```

The following properties are available for the filter.

Property | Description
------------- | -------------
**conditions** | for each condition, set to `true` or `false` to make it available, or as a string, can be custom SQL statement for selected conditions. Default: `true`.
**modelScope** | applies a [query scope method](../../extend/database/model.md) to the filter query, can be a model method name or a static PHP class method (`Class::method`). The first argument will contain the model that the widget will be attaching its value to, i.e. the parent model.

The following `conditions` are available for filtering.

Condition | Description
------------- | -------------
**equals** | is matching the exact text
**contains** | contains the text

To only allow finding the exact text pass **equals** as a `condition`. To find results that contain any part of the text pass **contains** to the conditions instead.

```yaml
username:
    label: Username
    type: text
    conditions:
        equals: true
```

You may pass custom SQL to the conditions as a string where `:value` contains the filtered value.

```yaml
username:
    label: Username
    type: text
    conditions:
        equals: username = :value
        contains: username like %:value%
```

## PHP Interface

You may define a custom `modelScope` in the model using the following example.

```yaml
username:
    label: Username
    type: text
    modelScope: textFilter
```

The **scopeTextFilter** method definition where the value is found in `$scope->value`.

```php
function scopeTextFilter($query, $scope)
{
    if ($scope->condition === 'equals') {
        $query->where('username', $scope->value);
    }
    else {
        $query->where('username', 'LIKE', "%{$scope->value}%");
    }
}
```
---
subtitle: Filter Scope
shortname: Checkbox
---
# Checkbox Scope

`checkbox` - used as a binary checkbox to apply a predefined condition or query to the list, either on or off. Use 0 for off and 1 for on for default value

```yaml
is_published:
    label: Hide Published
    type: checkbox
    conditions: is_published <> true
```

The following properties are available for the filter.

Property | Description
------------- | -------------
**default** | set to true to make the filter checked by default. Default `false`.
**conditions** | a custom SQL select statement to use for the filter.

You may set `default` value to make the filter checked by default.

```yaml
is_published:
    label: Hide Published
    type: checkbox
    default: 1
```
---
subtitle: Filter Scope
shortname: Date
---
# Date Scope

`date` - filer using a date value using `equals`, `between`, `before` and `after` condition logic.

```yaml
created_at:
    label: Created
    type: date
```

The following properties are available for the filter.

Property | Description
------------- | -------------
**minDate** | the minimum/earliest date that can be selected.
**maxDate** | the maximum/latest date that can be selected.
**firstDay** | the first day of the week. Default: `0` (Sunday).
**showWeekNumber** | show week numbers at head of row. Default: `false`
**useTimezone** | convert the date and time from the backend specified timezone preference. Default: `true`
**conditions** | for each condition, set to `true` or `false` to make it available, or as a string, can be custom SQL statement for selected conditions. Default: `true`.

The following `conditions` are available for filtering.

Condition | Description
------------- | -------------
**equals** | is within the selected date from start to end of day
**notEquals** | is not within the selected date from start to end of day
**between** | is between the two selected dates
**before** | is before the selected date
**after** | is after the selected date

The filtered value is automatically converted to the backend timezone preference, you may disable this using the `useTimezone` option.

```yaml
created_at:
    label: Created
    type: date
    useTimezone: false
```

To only allow finding the exact date pass **equals** as a `condition`. To find results that contain any part of the text pass **between**, **before** or **after** to the conditions instead.

```yaml
created_at:
    label: Created
    type: date
    conditions:
        equals: true
```

You may pass a `default` value, ensuring it is wrapped in quotes to represent a string. The default can be set to **now** to specify the current date.

```yaml
created_at:
    label: Created
    type: date
    default: '2020-01-02'
```

You may set the `minDate` and `maxDate` to determine the minimum and maximum available date range.

```yaml
created_at:
    label: Date
    type: date
    minDate: '2001-01-23'
    maxDate: '2030-10-13'
```

You may pass custom SQL to the conditions as a string with supporting values.

```yaml
created_at:
    label: Created
    type: date
    conditions:
        before: created_at <= :value
        between: created_at >= :after AND created_at <= :before
```

The following parameters are supported.

- `:value`: selected date formatted as `Y-m-d 00:00:00`
- `:valueDate`: selected date formatted as `Y-m-d`
- `:before`: before date formatted as `Y-m-d 00:00:00`
- `:beforeDate`: before date formatted as `Y-m-d`
- `:after`: afterwards date formatted as `Y-m-d 00:00:00`
- `:afterDate`: afterwards date formatted as `Y-m-d`

## PHP Interface

For access in PHP, you may define a custom `modelScope` in the model using the following example.

```yaml
created_at:
    label: Created
    type: date
    modelScope: dateFilter
```

The **scopeDateFilter** method definition with values found in `$scope->value`, `$scope->before` and `$scope->after`.

```php
function scopeDateFilter($query, $scope)
{
    if ($scope->condition === 'equals') {
        $query->where('created_at', $scope->value);
    }
    elseif ($scope->condition === 'notEquals') {
        $query->where('created_at', '<>', $scope->value);
    }
    elseif ($scope->condition === 'between') {
        $query
            ->where('created_at', '>=', $scope->after)
            ->where('created_at', '<=', $scope->before);
    }
    elseif ($scope->condition === 'after') {
        $query->where('created_at', '>=', $scope->value);
    }
    else {
        $query->where('created_at', '<=', $scope->value);
    }
}
```
---
subtitle: Filter Scope
shortname: Group
---
# Group Scope

`group` - filter using a group of multiple items, usually by a related model or an array of predefined options.

To filter by a model, specify the `modelClass` and `nameFrom` properties to specify which model and attribute to use.

```yaml
roles:
    label: Role
    type: group
    nameFrom: name
    modelClass: October\Test\Models\Role
```

The following properties are available for the filter.

Property | Description
------------- | -------------
**options** | available options for the filter, as an array.
**optionsMethod** | take options from a method defined on the model or as a static method, eg `Class::method`.
**conditions** | a custom SQL select statement to use for the filter.
**nameFrom** | the column name to use in the model class, used for displaying the name. Default: `name`.
**modelClass** | class of the model to use for the available filter records.
**modelScope** | applies a [model scope method](../filter-scopes.md) to the filter query.

To filter by an array, specify an `options` property.

```yaml
status:
    label: Role
    type: group
    options:
        developer: Developer
        publisher: Publisher
```

You may pass custom SQL to the conditions as a string where `:value` contains the filtered value.

```yaml
status:
    label: Role
    type: group
    conditions: role in (:value)
    # ...
```

You may also pass a `default` value as an array with selected keys.

```yaml
status:
    # ...
    default:
        - developer
        - publisher
```

## PHP Interface

You may define a custom `modelScope` in the model using the following example.

```yaml
roles:
    label: Role
    type: group
    nameFrom: name
    modelClass: October\Test\Models\Role
    modelScope: groupFilter
```

The **scopeGroupFilter** method definition where the value is found in `$scope->value`.

```php
public function scopeGroupFilter($query, $scope)
{
    return $query->whereHas('roles', function($q) use ($scope) {
        $q->whereIn('id', $scope->value);
    });
}
```

You may dynamically supply options by passing a model method to the `optionsMethod` property.

```yaml
roles:
    label: Role
    type: group
    nameFrom: name
    modelClass: October\Test\Models\Role
    optionsMethod: getRoleGroupOptions
```

The **getRoleGroupOptions** method definition.

```php
public function getRoleGroupOptions()
{
    return $this->whereNull('parent_id')->pluck('name', 'id')->all();
}
```
---
subtitle: Filter Scope
shortname: Switch
---
# Switch Scope

`switch` - used as a switch to toggle between two predefined conditions or queries to the list, either indeterminate, on or off.

```yaml
is_approved:
    label: Approved
    type: switch
    conditions:
        - is_approved <> true
        - is_approved = true
```

The following properties are available for the filter.

Property | Description
------------- | -------------
**default** | set to `1` or `2` to make the filter checked by default. Default `0`.
**select** | an array with custom SQL select statement to use for the filter, included for when the conditions is indeterminate (first item) and is checked (second item).

You may set `default` value to set the default filter value. Use `0` for off, `1` for indeterminate and `2` for on for default value.

```yaml
is_approved:
    label: Approved
    type: switch
    default: 1
```
---
subtitle: Filter Scope
shortname: Number
---
# Number Scope

`number` - filter using a numeric value using `exact`, `between`, `greater` and `lesser` condition logic.

```yaml
age:
    label: Age
    type: number
    conditions:
        greater: true
```

The following properties are available for the filter.

Property | Description
------------- | -------------
**default** | specifies a default value for the filter.
**conditions** | for each condition, set to `true` or `false` to make it available, or as a string, can be custom SQL statement for selected conditions. Default: `true`.
**modelScope** | applies a [query scope method](../../extend/database/model.md) to the filter query, can be a model method name or a static PHP class method (`Class::method`). The first argument will contain the model that the widget will be attaching its value to, i.e. the parent model.

The following `conditions` are available for filtering.

Condition | Description
------------- | -------------
**exact** | is matching the exact number
**between** | is between two supplied numbers
**greater** | is greater than the supplied number
**lesser** | is less than the supplied number

You may set `default` value to set the default filter value.

```yaml
age:
    label: Age
    type: number
    default: 14
```

You may pass custom SQL to the conditions as a string where `:value`, `:min` and `:max` contain the filtered values.

```yaml
age:
    label: Age
    type: number
    conditions:
        greater: age >= :value
        between: age >= :min and age <= :max
```

## PHP Interface

You may define a custom `modelScope` in the model using the following example.

```yaml
age:
    label: Age
    type: number
    modelScope: numberFilter
```

The **scopeNumberFilter** method definition with values found in `$scope->value`, `$scope->min` and `$scope->max`.

```php
function scopeNumberFilter($query, $scope)
{
    if ($scope->condition === 'equals') {
        $query->where('age', $scope->value);
    }
    elseif ($scope->condition === 'between') {
        $query
            ->where('age', '>=', $scope->min)
            ->where('age', '<=', $scope->max);
    }
    elseif ($scope->condition === 'greater') {
        $query->where('age', '>=', $scope->value);
    }
    else {
        $query->where('age', '<=', $scope->value);
    }
}
```
# October CMS 3.0

<Redirect to="setup/installation" />
---
subtitle: Twig Property
---
# this.site

You can access the active site via `this.site` and it returns the object `System\Models\SiteDefinition` [current site definition](../../cms/resources/multisite.md).

## Retrieving Data From the Site

```twig
{{ this.site.id }}
{{ this.site.name }}
{{ this.site.code }}
{{ this.site.locale }}
{{ this.site.timezone }}
{{ this.site.theme }}
```

## Checking the Active Site

```twig
{% if this.site.code === 'english' %}
    <h1>Only display for English</h1>
{% endif %}
```

## Getting the Current Selected Locale

The `locale` attribute will return the current locale if it is specified, or return an empty value when none is specified.

```twig
<html lang="{{ this.site.locale }}">
```

Use the `hard_locale` attribute to always return a locale value, which uses the default locale when none is specified.

```twig
<html lang="{{ this.site.hard_locale }}">
```
---
subtitle: Twig Property
---
# this.layout

You can access the current layout object via `this.layout` and it returns the object `Cms\Classes\Layout`.

## Properties

`this.layout` has the following properties.

### id

Converts the layout file name and folder name to a CSS friendly identifier.

```twig
<body class="layout-{{ this.layout.id }}">
```

If the layout file was **default.htm** this would generate a class name of `layout-default`.

### description

The layout description as defined by the configuration.

```twig
<meta name="description" content="{{ this.layout.description }}">
```
---
subtitle: Twig Property
---
# this.param

You can access the current URL parameters via `this.param` and it returns a PHP array.

## Accessing Page Parameters

This example demonstrates how to access the `tab` URL parameter in a page.

::: cmstemplate
```ini
url = "/account/:tab"
```
```twig
{% if this.param.tab == 'details' %}

    <p>Here are all your details</p>

{% elseif this.param.tab == 'history' %}

    <p>You are viewing a blast from the past</p>

{% endif %}
```
:::

If the parameter name is also a variable, then array syntax can be used.

::: cmstemplate
```ini
url = "/account/:post_id"
```
```twig
{% set name = 'post_id' %}

<p>The post ID is: {{ this.param[name] }}</p>
```
:::
---
subtitle: Twig Property
---
# this.controller

You can access the current controller object via `this.controller` and it returns the object `Cms\Classes\Controller`.
---
subtitle: Twig Property
---
# this.theme

You can access the current theme object via `this.theme` and it returns the object `Cms\Classes\Theme`, a reference to the [theme customization object](../../cms/themes/settings.md).

## Properties

`this.theme` will provide direct access to form field values, defined by any theme customization. It also has the following properties natively.

### id

Converts the theme directory name to a CSS friendly identifier.

```twig
<body class="theme-{{ this.theme.id }}">
```

If the theme directory was **website** this would generate a class name of `theme-website`.

### config

An array containing all the theme configuration values found in the `theme.yaml` file.

```twig
<meta name="description" content="{{ this.theme.config.description }}">
```
---
subtitle: Twig Property
---
# this.environment

You can access the current environment object via `this.environment` and it returns a string that references the [current environment configuration](../../setup/configuration.md).

## Example

The following example will display a banner if the website is running in the test environment:

```twig
{% if this.environment == 'test' %}

    <div class="banner">Test Environment</div>

{% endif %}
```
---
subtitle: Twig Property
---
# this.request

Allows access to the current request object, including request method.

## this.request.method

You can access the current request method object via `this.request.method` and it returns the HTTP verb in uppercase.

```twig
{% if this.request.method == 'GET' %}
    <!-- Do GET Logic -->
{% elseif this.request.method == 'POST' %}
    <!-- Do POST Logic -->
{% endif %}
```

## this.request.ajax

To check if the current request uses the AJAX header, access the `this.request.ajax` property.

```twig
{% if this.request.ajax %}
    Request was submitted via AJAX
{% endif %}
```

## this.request.pjax

To check if the current request was made using the [Turbo Router](../../cms/ajax/turbo-router.md), access the `this.request.pjax` property.

```twig
{% if this.request.pjax %}
    Page was loaded via PJAX
{% endif %}
```

## this.request.pjaxCached

Use the `this.request.pjaxCached` property to also check if the [Turbo Router](../../cms/ajax/turbo-router.md) request had a cached snapshot coming before it.

```twig
{% if this.request.pjaxCached %}
    Page was loaded via PJAX with a snapshot
{% endif %}
```
---
subtitle: Twig Property
---
# this.session

You can access the current session manager via `this.session` and it returns the object `Illuminate\Session\Store` [current session configuration](../../extend/services/session.md).

## this.session.get()

You can retrieve data from the session by passing the key name to `this.session.get` as the first argument.

```twig
{{ this.session.get('key') }}
```

You may also pass a default value as the second argument.

```twig
{{ this.session.get('key', 'default') }}
```

## this.session.has()

The `this.session.has` method can determine if an item exists in the session.

```twig
{% if this.session.has('key') %}
    <h1>We found key in the session</h1>
{% endif %}
```

## this.session.put()

The `this.session.put` method is used to store session data.

```twig
{% do this.session.put('my-preference', 'value') %}
```

## this.session.forget()

The `this.session.forget` will delete a single key (first argument) from the session.

```twig
{% do this.session.forget('key') %}
```

To remove all the session data, use `this.session.flush` instead.

```twig
{% do this.session.flush() %}
```

#### See Also

::: also
* [Session Service](../../extend/services/session.md)
:::
---
subtitle: Twig Property
---
# this.page

You can access the current page object via `this.page` and it returns the object `Cms\Classes\Page`. This object can also be accessed in the [PHP code of a page](../../cms/themes/pages.md) as `$this->page`.

## Properties

`this.page` has the following properties.

### layout

Reference to the layout name used by this page, if defined. Not to be confused with `this.layout`.

```twig
{{ this.page.layout }}
```

### id

Converts the page file name and folder name to a CSS friendly identifier.

```twig
<body class="page-{{ this.page.id }}">
```

If the page file was **home/index.htm** this would generate a class name of `page-home-index`.

### title

The page title as defined by the configuration.

```twig
<h1>{{ this.page.title }}</h1>
```

### description

The page description as defined by the configuration.

```twig
<p>{{ this.page.description }}</p>
```

### meta_title

An alternative `title` field, usually more descriptive for SEO purposes.

```twig
<title>{{ this.page.meta_title }}</title>
```

### meta_description

An alternative `description` field, usually more descriptive for SEO purposes.

```twig
<meta name="description" content="{{ this.page.meta_description }}">
```

### hidden

Hidden pages are accessible only by logged-in back-end users.

```twig
{% if this.page.hidden %}
    <p>Note to other admins: We are currently working on this page.</p>
{% endif %}
```

### fileName

Page file name in the theme with extension.

### baseFileName

Page file name in the theme without the extension.
---
subtitle: Twig Function
---
# ajaxHandler()

The `ajaxHandler()` function runs an AJAX handler inside Twig and prepares a `Cms\Classes\AjaxResponse` response object. An example of calling an **onResetPassword** handler.

```twig
{% set result = ajaxHandler('onResetPassword') %}
```

The following properties can be expected in the resulting object.

Property | Data
------------- | -------------
**data** | data set or returned by the handler, also available by directly calling the object.
**error** | an error was thrown during the handler execution.
**flash** | flash messages set by the handler.
**redirect** | the handler returned a redirect.

## Accessing Data

Variables assigned to the page are available to the resulting object. Take the following AJAX handler definition.

```php
function onResetPassword()
{
    $this['someVariable'] = 'someValue';
}
```

Next is an, an example of calling the **onResetPassword** handler.

```twig
{% set result = ajaxHandler('onResetPassword') %}
```

The **data** variables returned from the handler or set on the page during the handler call will be available via resulting variable.

```twig
{{ result.someVariable }}
```

## Using Responses

When [building APIs in your theme](../../cms/resources/building-apis.md), the response can be passed directly to  the `response()` [Twig function](./response.md).

```twig
{% do response(ajaxHandler('onResetPassword')) %}
```

When returning as a response, the data will be available in JSON as the **data** property.

```json
{
    "data": {}
}
```

The page variables are not included with the response for security reasons. Call the `withPageVars` method to include them with the response.

```twig
{% do response(ajaxHandler('onResetPassword').withPageVars()) %}
```

The `withVars` method can be used to include additional data with the response.

```twig
{% do response(ajaxHandler('onResetPassword').withVars({ 'token': 'foobar' })) %}
```

## Handling Errors

If an exception occurs during the handler, the error message will be available in the **error.message** property. If the error is a `ValidationException` then the invalid fields can be found in the **error.fields** property.

```twig
{% if result.error %}
    An error occurred: {{ result.error.message }}
{% endif %}
```

If an exception occurs, the error information will be available as the **error** property.

```json
{
    "error": {
        "message": "An error occurred"
    }
}
```

When returning a response from an AJAX handler, the following status codes are used for the exception type.

Exception | Status Code
------------- | -------------
`ValidationException` | 422 Unprocessable Entity
`ApplicationException` | 400 Bad Request
`Exception` | 500 Internal Server Error

## Handling Redirects

If the AJAX handler caused a redirect, this will be available on the **redirect** property and can be returned directly. For example

```php
function onRedirect()
{
    return Redirect::to('https://octobercms.com');
}
```

The following will redirect to the browser as a response.

```twig
{% do response(ajaxHandler('onTest')) %}
```

The object contains the **redirect** messages alongside the data.

```json
{
    "data": {},
    "redirect": "https://octobercms.com"
}
```

## Handling Flash Messages

If flash messages were used, these will be available in the **flash** property. Take the following handler as an example.

```php
function onTest()
{
    Flash::success('Test successful');
}
```

Calling the handler and sending as a response.

```twig
{% do response(ajaxHandler('onTest')) %}
```

The output contains the **flash** messages alongside the data.

```json
{
    "data": {},
    "flash": {
        "success": "Test successful"
    }
}
```

#### See Also

::: also
* [Building API Resources](../../cms/resources/building-apis.md)
:::
---
subtitle: Twig Function
---
# pager()

The `pager()` function is used to handle [paginated records](../../extend/database/pagination.md) (first argument). It returns an object containing details about the records, including the page numbers and next / previous links. When treated as a string, it will render default HTML markup.

Once you have retrieved the results, you may display the results and render the page links using the `pager()` Twig function.

```twig
<div class="container">
    {% for user in users %}
        {{ user.name }}
    {% endfor %}
</div>

{{ pager(users) }}
```

The following configurable options are supported (second argument).

Option | Description
------------- | -------------
**template** | specify a default template or [view name](../../extend/services/response-view.md). Example: `app::my-custom-view`
**partial** | specify a [partial name](../../cms/themes/partials.md) in the theme (CMS only). Example: `my-partial`
**withQuery** | include any existing query parameters with the generated links. Default: `false`
**appends** | an optional array of values to include in the query parameters.
**fragment** | an optional fragment string to include in the URLs.

## Modifying the URL

Use the `withQuery` to preserve the existing query string in the URL.

```twig
{{ pager(records, { withQuery: true }) }}
```

You may add to the query string of pagination links using the `appends` method. For example, to append `&sort=votes` to each pagination link, you should make the following call to `appends`.

```twig
{{ pager(records, { appends: { sort: 'votes' } }) }}
```

If you wish to append a "hash fragment" to the pagination URLs, you may use the `fragment` method. For example, to append `#foo` to the end of each pagination link, make the following call to the `fragment` method.

```twig
{{ pager(records, { fragment: 'foo' }) }}
```

## Accessing Pager Variables

Setting the `pager()` function to a variable extracts the paginated links and meta data from a paginated query. This is particularly useful when [building API endpoints](../../cms/resources/building-apis.md) (JSON) but it can also be used to access the variables within Twig.

Starting with a paginated collection.

```twig
{% set records = postModel.paginate(3) %}
```

The `pager()` function will return an extracted object.

```twig
{% set paginator = pager(records) %}
```

Where each variable can be accessed.

```twig
<a href="{{ paginator.links.first }}"></a>
```

The returned object is divided in to **links** and **meta** with the following attributes.

Attribute | Description
------------- | -------------
**links.first** | URL to the first page
**links.last** | URL to the last page
**links.prev** | URL to the previous page
**links.next** | URL to the next page
**meta.path** | URL to the current page
**meta.per_page** | Number of records per page
**meta.total** | Total records found
**meta.current_page** | The current page number
**meta.last_page** | The last page number
**meta.from** | Starting record number
**meta.to** | Ending record number

An example in JSON format.

```json
{
    "links": {
        "first": "https://yoursite.tld/api/blog/posts?page=1",
        "last": "https://yoursite.tld/api/blog/posts?page=1",
        "prev": null,
        "next": null
    },
    "meta": {
        "path": "https://yoursite.tld/api/blog/posts",
        "per_page": 3,
        "total": 2,
        "current_page": 1,
        "last_page": 1,
        "from": 1,
        "to": 2
    }
}
```

## Rendering the Pager

When rendering the `pager()` function directly, accessing it as a string, it will render a default system template for displaying paginated links.

```twig
{{ pager(records) }}
```

The companion `ajaxPager()` function will render a AJAX-enabled pagination template (see AJAX template below). Ideally, this should be used inside an [AJAX partial](../tag/ajax-partial.md).

```twig
{{ ajaxPager(records) }}
```

### Default Template

The `default` template renders the default pagination template. It is used by default with the `paginate()` method on a database query.

```html
<ul class="pagination">
    <li class="page-item first">
        <span class="page-link">&larr;</span>
    </li>
    <li class="page-item">
        <a class="page-link" href="?page=1">1</a>
    </li>
    <li class="page-item last">
        <a class="page-link" href="?page=2">&rarr;</a>
    </li>
</ul>
```

File Location: `~/modules/system/views/pagination/default.htm`

### Simple Template

The `simple` template renders pagination with only next and previous buttons. It is used by default with the `simplePaginate()` method on a database query.

```html
<ul class="pagination">
    <li class="page-item first">
        <span class="page-link">&larr;</span>
    </li>
    <li class="page-item last">
        <a class="page-link" href="?page=2">&rarr;</a>
    </li>
</ul>
```

File Location: `~/modules/system/views/pagination/simple.htm`

### AJAX Template

The `ajax` template renders AJAX paginated records. It is used by default with the `paginate()` method on a database query and the `ajaxPager()` function.

```html
<ul class="pagination">
    <li class="page-item first">
        <span class="page-link">&larr;</span>
    </li>
    <li class="page-item">
        <a
            class="page-link"
            data-request="onAjax"
            data-request-data="{ page: 1 }"
            data-request-update="{ _self: true }">1</a>
    </li>
    <li class="page-item last">
        <a
            class="page-link"
            data-request="onAjax"
            data-request-data="{ page: 2 }"
            data-request-update="{ _self: true }">&rarr;</a>
    </li>
</ul>
```

File Location: `~/modules/system/views/pagination/ajax.htm`

## Using Custom Markup

::: tip
Visit the [Pagination feature article](../../cms/features/pagination.md) for instructions on how to use custom pagination markup.
:::

#### See Also

::: also
* [Building API Resources](../../cms/resources/building-apis.md)
* [CMS Pagination](../../cms/features/pagination.md)
* [Model Pagination](../../extend/database/pagination.md)
:::
---
subtitle: Twig Function
---
# dump()

The `dump()` function dumps information about a template variable. This is useful when debugging a template that does not behave as expected.

```twig
{{ dump(user) }}
```

You can inspect several variables by passing them as additional arguments:

```twig
{{ dump(user, categories) }}
```

If you don't pass any value, all variables from the current context are dumped:

```twig
{{ dump() }}
```

## d()

The `d()` function acts as shorter syntax for debugging in Twig. It will show less detail about the object but makes the values easier to see all at once. It will recursively dump provided variables in the same manner as the `dd()` PHP function.

```twig
{{ d(user) }}
```

You may also pass multiple variables in the arguments.

```twig
{{ d(variable1, variable2) }}
```

The `dd()` function is an alternative that will dump the values and then terminate the process.

```twig
{{ dd('dump and die') }}
```

::: warning
The `dump()` and `d()` functions are not available when [safe mode is enabled](../../setup/configuration.md).
:::
---
subtitle: Twig Function
---
# form()

Functions prefixed with `form_` perform tasks that are useful when dealing with forms. The helper maps directly to the `Form` PHP class and its methods. For example:

```twig
{{ form_close() }}
```

The above is the PHP equivalent of the following:

```php
<?= Form::close() ?>
```

> **Note**: Methods in *camelCase* should be converted to *snake_case*.

## form_open()

Outputs a standard `<form>` opening tag along with the `_session_key` and `_token` hidden fields for CSRF protection. If you are using the [AJAX Framework](../../cms/ajax/introduction.md), it is recommended that you use `form_ajax()` instead.

```twig
{{ form_open() }}
```

Attributes can be passed in the first argument.

```twig
{{ form_open({ class: 'form-horizontal' }) }}
```

The above example would output as the following:

```html
<form class="form-horizontal">
```

There are some special options that can also be used alongside the attributes.

```twig
{{ form_open({ request: 'onUpdate' }) }}
```

The function support the following options:

Option | Description
------------- | -------------
**method** | Request method. Corresponds to the **method** FORM tag attribute. Eg: POST, GET, PUT, DELETE
**request** | A handler name to execute on the server when the form is posted. See the [AJAX handlers](../../cms/ajax/handlers.md) article for details about event handlers.
**url** | Specifies URL to post the form to. Corresponds to the **action** FORM tag attribute.
**files** | Determines whether the form will submit files. Accepted values: **true** and **false**.
**model** | A model object for the form model binding.

## form_ajax()

Outputs an AJAX enabled FORM opening tag. The first parameter of the `form_ajax()` function is the AJAX handler name. The handler can be defined in the layout or page PHP section code, it can also be defined in a component. You may find more information about AJAX in the [AJAX Framework](../ajax/introduction.md) article.

```twig
{{ form_ajax('onUpdate') }}
```

Attributes can be passed in the second argument.

```twig
{{ form_ajax('onSave', { class: 'form-horizontal'}) }}
```

The above example would output as the following:

```html
<form data-request="onSave" class="form-horizontal">
```

There are some special options that can also be used alongside the attributes.

```twig
{{ form_ajax('onDelete', { data: { id: 2 }, confirm: 'Really delete this record?' }) }}

{{ form_ajax('onRefresh', { update: { statistics: '#statsPanel' } }) }}
```

> **Note**: When attempting to reference a component's alias with `__SELF__` as an argument to `form_ajax()` you must first build the string you wish to use outside of the call itself. Example:

```twig
{% set targetPartial = "'" ~ __SELF__ ~ "::statistics': '#statsPanel'" %}
{{ form_ajax('onUpdate', { update: targetPartial }) }}
```

The function support the following options:

Option | Description
------------- | -------------
**success** | JavaScript string to execute on successful result.
**error** | JavaScript string to execute on failed result.
**confirm** | A confirmation message to display before sending the request.
**redirect** | On successful result, redirect to a URL.
**update** | An array of partials to update on success in the following format: { 'partial': '#element' }.
**data** | Extra data to include with the request in the following format: { 'myvar': 'myvalue' }.

## form_close()

Outputs a standard FORM closing tag. This tag is generally available to provide consistency in usage.

```twig
{{ form_close() }}
```

The above example would output as the following:

```html
</form>
```

## Passing Attributes to the Generated Element

You can pass additional attributes to the `Form::open()` method by passing an array of attribute names and values to be rendered on the final generated `<form>` element.

```php
<?= Form::open(array('id' => 'example', 'class' => 'something')) ?>
    // ..
<?= Form::close() ?>
```

The above example would output the following:

```html
<form method="POST" action="" accept-charset="UTF-8" id="example" class="something">

</form>
```
---
subtitle: Twig Function
---
# config()

You may access configuration values using the `config()` helper function. It returns the current value from the configuration store.

The following example will output the value currently stored in `app.locale`.

```twig
{{ config('app.locale') }}
```

The above is the PHP equivalent of the following:

```php
<?= Config::get('app.locale') ?>
```

## env()

As companion function called `env()` can be used to access environment variables.

The following example would output the value currently stored in `APP_ENV` environment variable. Second argument is default value, when ENV key does not exists.

```twig
{{ env('APP_ENV', 'production') }}
```

The above is the PHP equivalent of the following:

```php
<?= env('APP_ENV', 'production') ?>
```

::: warning
The `config()` and `env()` functions are not available when [safe mode is enabled](../../setup/configuration.md).
:::
---
subtitle: Twig Function
---
# str()

Functions prefixed with `str_` perform tasks that are useful when dealing with strings. The helper maps directly to the `Str` PHP class and its methods. For example:

```twig
{{ str_camel() }}
```

The above is the PHP equivalent of the following:

```php
<?= Str::camel() ?>
```

::: warning
Methods in *camelCase* should be converted to *snake_case*.
:::

You may also apply the string functions as a Twig filter.

```twig
{{ ''|str_camel }}
```

## str_limit()

Limit the number of characters in a string.

```twig
{{ str_limit('The quick brown fox...', 100) }}
```

To add a suffix when limit is applied, pass it as the third argument. Defaults to `...`.

```twig
{{ str_limit('The quick brown fox...', 100, '... Read more!') }}
```

## str_words()

Limit the number of words in a string.

```twig
{{ str_words('The quick brown fox...', 100) }}
```

To add a suffix when limit is applied, pass it as the third argument. Defaults to `...`.

```twig
{{ str_words('The quick brown fox...', 100, '... Read more!') }}
```

## str_replace

Replace all occurrences of the search string with the replacement string.

```twig
// Outputs: Bob
{{ 'Alice'|str_replace('Alice', 'Bob') }}
```

## str_camel()

Convert a value to *camelCase*.

```twig
// Outputs: helloWorld
{{ str_camel('hello world') }}
```

## str_studly()

Convert a value to *StudlyCase*.

```twig
// Outputs: HelloWorld
{{ str_studly('hello world') }}
```

## str_snake()

Convert a value to *snake_case*.

```twig
// Outputs: hello_world
{{ str_snake('hello world') }}
```

The second argument can supply a delimiter.

```twig
// Outputs: hello---world
{{ str_snake('hello world', '---') }}
```

## str_plural()

Gets the plural form of an English word.

```twig
// Outputs: chickens
{{ str_plural('chicken') }}
```

## str_upper()

Makes a string uppercase.

```twig
// Outputs: Hello I'm JACK
Hello I'm {{ 'Jack'|str_upper }}
```

## str_lower()

Makes a string lowercase.

```twig
// Outputs: Hello I'm jack
Hello I'm {{ 'JACK'|str_lower }}
```

## str_ucfirst()

Makes a string's first character uppercase.

```twig
// Outputs: Hello I'm Jack
Hello I'm {{ 'jack'|str_ucfirst }}
```

## str_lcfirst()

Makes a string's first character lowercase.

```twig
// Outputs: Hello I'm jack
Hello I'm {{ 'Jack'|str_lcfirst }}
```

## str_repeat()

Repeats a string.

```twig
// Outputs: We are the best best best!
We are the {{ 'best '|str_repeat(3) }}!
```

## str_pad_both

Pads a string to a certain length with another string from both sides.

```twig
// Outputs: ooxxxoo
{{ 'xxx'|str_pad_both(7, 'o') }}
```

## str_pad_left

Pads a string to a certain length with another string from left side.

```twig
// Outputs: ooxxx
{{ 'xxx'|str_pad_left(5, 'o') }}
```

## str_pad_right

Pads a string to a certain length with another string from right side.

```twig
// Outputs: xxxoo
{{ 'xxx'|str_pad_right(5, 'o') }}
```

## str_reverse

Reverses a string.

```twig
// Outputs: !dlrow olleH
{{ 'Hello world!'|str_reverse }}
```
---
subtitle: Twig Function
---
# collect()

The `collect()` function provides a nicer interface for building arrays in Twig. Twig is intentionally minimalist as a view layer and building an array requires a continuous merge process.

Take the following example to build an array using the native Twig `|merge` filter:

```twig
{% set array = [] %}
{% for item in items %}
    {% set array = array|merge([{ title: item.title, ... }]) %}
{% endfor %}
```

Using the `collect()` function returns [a collection object](../../extend/services/collection.md) that lets you push elements instead. The above example can be achieve using the `push` method.

```twig
{% set array = collect() %}
{% for item in items %}
    {% do array.push({ title: item.title, ... }) %}
{% endfor %}
```

Passing an array as the first argument will initialize the collection with items prepopulated.

```twig
{% set array = collect([
    { title: item.title, ... },
    { title: item.title, ... }
]) %}
```

## shuffle

The `shuffle()` method shuffles the collection.

```twig
{{ collect(songs).shuffle() }}
```

In a foreach loop.

```twig
{% for fruit in collect(['apple', 'banana', 'orange']).shuffle() %}
    {{ fruit }}
{% endfor %}
```

## sortBy

The `sortBy()` and `sortByDesc` methods can sort a collection by given field (key).

```twig
collect(data).sortBy('age')
```

For example:

```twig
// Output: John David
{% set data = [{'name': 'David', 'age': 31}, {'name': 'John', 'age': 28}] %}

{% for item in collect(data).sortBy('age') %}
    {{ item.name }}&nbsp;
{% endfor %}
```

#### See Also

::: also
* [Building API Resources](../../cms/resources/building-apis.md)
:::
---
subtitle: Twig Function
---
# response()

The `response()` function overrides the page from being displayed and returns a response, usually in the form of JSON payload.

```twig
{% do response({ foo: 'bar' }) %}
```

The above call will return a response with a `application/json` content type.

```json
{
    "foo": "bar"
}
```

By default a status code of `200` will be used. You may specify any status code by passing it as the second argument.

```twig
{% do response('Bad Request', 400) %}
```

You may also pass custom headers as the third argument.

```twig
{% do response('Bad Request', 400, {'X-Failure-Reason': 'Not wearing shoes'}) %}
```

<!--
## resource()

The `resource()` function converts a resource to a consistent response type and should be used when handling models or collections.

```twig
{% do response(resource(model)) %}
```

All data returned will be wrapped in the **data** attribute automatically or if placed there explicitly. Wrapping the response provides a consistent interface.

```json
{
    "data": {}
}
```

If a resource support pagination, the output will be specially crafted to include a **links** and **meta** attribute.

```json
{
    "data": {},
    "links": {
        "first": "...",
        "last": "...",
        "prev": "...",
        "next": "..."
    },
    "meta": {}
}
```

Resources are resolved using a resolver that developers can use to customize their output. It's possible to construct a response with multiple resource resolvers.

```twig
{% do response({
    user: resource(user),
    posts: resource(user.posts)
}) %}
```
-->

#### See Also

::: also
* [Building API Resources](../../cms/resources/building-apis.md)
:::
---
subtitle: Twig Function
---
# carbon()

The `carbon()` function can be used to handle dates and times using Twig, prepared with a [Carbon object](https://carbon.nesbot.com/docs/) and all its available functions.

The supplied value will be automatically converted to the current timezone depending on the `cms.timezone` configuration setting, which can be set using a [site definition](../../cms/resources/multisite.md).

To output the current date time value:

```twig
{{ carbon('now') }}
```

To specify a custom value:

```
{{ carbon('2024-01-01 02:13:23') }}
```

## format

The `format` method can be used to apply various formats.

```twig
Meeting starts at {{ carbon(event.start_at).format('H:i') }} in Johannesburg.
```

## formatLocalized

Format a local time/date according to locale settings, this is the equivalent to `strftime` in PHP.

```twig
{{ carbon(article.created_at).formatLocalized('%d.%m.%Y %H:%M:%S') }}
```

## diffForHumans

The `diffForHumans` method will render the difference between a date and now in human readible text.

```twig
{{ carbon(post.published_at).diffForHumans() }}
```

## Cache Busting URLs

You can use the format to produce cache busting URLs.

```twig
// Outputs: 10.26.22.22.53.31
carbon('now').format('m.d.y.H.i.s')
```

Then build the URL like the following.

```twig
<img src="{{ 'assets/images/image_file.jpg'|theme }}?{{ carbon('now').format('m.d.y.H.i.s') }}" alt="" />
```

## Date Format Cheat Sheet

The following values are available when formatting dates and times. You can use these codes with the `format` method.

Day Format  | Example
----------- | -------------
`d` | 01 through 31
`D` | Mon through Sun
`j` | 1 through 31
`l` | Sunday through Saturday
`N` | 1 (Monday) to 7 (Sunday)
`S` | st, nd, rd, th
`w` | 0 (Sunday) through 6 (Saturday)
`z` | 0 through 365

Week Format  | Example
------------ | -------------
`W` | 42 (42nd week in year)

Month Format  | Example
------------- | -------------
`F` | January through December
`m` | 01 through 12
`M` | Jan through Dec
`n` | 1 through 12
`t` | 28 through 31

Year Format  | Example
------------ | -------------
`Y` | 1985, 1991, 2012, 2014, ...
`y` | 85, 91, 12, 14, ...
`o` | Same as `Y`, except based on week ending
`L` | 1 (leap year), 0 otherwise

Time Format  | Example
------------ | -------------
`a` | am or pm
`A` | AM or PM
`B` | 000 through 999
`g` | 1 through 12
`G` | 0 through 23
`h` | 01 through 12
`H` | 01 through 23
`i` | 00 through 59
`u` | 123456 (microseconds)

Timezone Format  | Example
---------------- | -------------
`e` | UTC, GMT, Atlantic/Azores
`I` | 1 (daylight), 0 otherwise
`O` | +0200
`P` | +02:00
`T` | EST, MDT, ...
`Z` | -43200 through 50400 (timezone offset)

Date & Time Format  | Example
----------------- | -------------
`c` | 2004-02-12T15:19:21+00:00
`r` | Thu, 21 Dec 2000 16:01:07 +0200
`U` | Seconds since Jan 1 1970 00:00:00 GMT
---
subtitle: Twig Function
---
# redirect()

The `redirect()` function redirects the response to a URL or theme page.

To perform a redirect, pass the first argument as the destination, as either a CMS page name or a URL address.

```twig
{% if record.notFound %}
    {% do redirect('404') %}
{% endif %}
```

Page parameters can be passed as the second argument.

```twig
{% do redirect('docs', { slug: 'home' }) %}
```

To redirect to a URL pass the fully qualified address instead of the page name.

```twig
{% do redirect('https://octobercms.com') %}
```

To include a redirect code, such as `302` (temporary) or `301` (permanent), use the second or third argument. The default is code `302`.

```twig
{% do redirect('https://octobercms.com', 301) %}
```
---
subtitle: Twig Function
---
# abort()

The `abort()` function aborts the successful request path by changing the response code and contents. This is useful for setting a custom HTTP code or displaying the 404 page when a record is not found.

```twig
{% if record.notFound %}
    {% do abort(404) %}
{% endif %}
```

To set the response code and display the theme 404 page, use the `404` code.

```twig
{% do abort(404) %}
```

Any other code will display the error page, with an optional message as the second argument.

```twig
{% do abort(403, 'Access Denied') %}
```

To set the HTTP code in the header without changing the response contents, pass `false` as the second argument.

```twig
{% do abort(404, false) %}
```
---
subtitle: Twig Function
---
# html()

Functions prefixed with `html_` perform tasks that are useful when dealing with HTML markup. The helper maps directly to the `Html` PHP class and its methods. For example:

```twig
{{ html_strip() }}
```

The above is the PHP equivalent of the following:

```php
<?= Html::strip() ?>
```

::: warning
Methods in *camelCase* should be converted to *snake_case*.
:::

You may also apply the HTML functions as a Twig filter.

```twig
{{ ''|html_strip }}
```

## html_strip()

Removes HTML from a string.

```twig
// Outputs: Hello world
{{ '<strong>Hello world</strong>'|html_strip }}
```

You may pass the first argument as allowable tags.

```twig
// Outputs: <p>Text</p>
{{ '<p><b>Text</b></p>'|html_strip('<p>') }}
```

## html_limit()

Limits HTML with specific length with a proper tag handling.

```twig
{{ '<p>Post content...</p>'|html_limit(100) }}
```

To add a suffix when limit is applied, pass it as the second argument. Defaults to `...`.

```twig
{{ '<p>Post content...</p>'|html_limit(100, '... Read more!') }}
```

## html_clean()

Cleans HTML to prevent most XSS attacks.

```twig
{{ '<script>window.location = "http://google.com"</script>'|html_clean }}
```

## html_email()

Obfuscates an e-mail address to prevent spam-bots from sniffing it.

```twig
{{ 'me@mysite.tld'|html_email }}
```

For example:

```twig
<a href="mailto: {{ 'me@mysite.tld'|html_email }}">Email me</a>

<!-- The above will output -->
<a href="mailto: &#109;&#97;&#105;&#108;&#x74;o&#x3a;&#97;&#64;b.&#x63;">Email me</a>
```

## html_mailto()

Outputs a complete anchor link with obfuscated email.

```twig
{{ 'me@mysite.tld'|html_mailto }}
```
# Markup Guide

<Redirect to="templating" />
---
subtitle: Learn about using Twig templating to display dynamic content.
---
# Templating

October CMS extends the [Twig template language](https://twig.symfony.com/doc/) with a number of functions, tags, filters and variables. These extensions allow you to use the CMS features and access the page environment information inside your templates.

## Variables

Template variables are printed on the page using *double curly brackets*.

```twig
{{ variable }}
```

Variables can also represent *expressions*.

```twig
{{ isAjax ? 'Yes' : 'No' }}
```

Variables can be concatenated with the `~` character.

```twig
{{ 'Your name: ' ~ name }}
```

October provides global variables under the `this` variable, as listed under the **Variables** section.

## Tags

Tags are a unique feature to Twig and are wrapped with `{% %}` characters.

```twig
{% tag %}
```

Tags provide a more fluent way to describe template logic.

```twig
{% if stormCloudComing %}
    Stay inside
{% else %}
    Go outside and play
{% endif %}
```

The `{% set %}` tag can be used to set variables inside the template.

```twig
{% set activePage = 'blog' %}
```

Tags can take on many different syntaxes and are listed under the **Tags** section.

## Filters

Filters act as modifiers to variables for a single instance and are applied using a *pipe symbol* followed by the filter name.

```twig
{{ 'string'|filter }}
```

Filters can take arguments like a function.

```twig
{{ price|currency('USD') }}
```

Filters can be applied in succession.

```twig
{{ 'October Glory'|upper|replace({'October': 'Morning'}) }}
```

Filters are listed under the **Filters** section.

## Functions

Functions allow logic to be executed and the return result acts as a variable.

```twig
{{ function() }}
```

Functions can take arguments.

```twig
{{ dump(variable) }}
```

Functions are listed under the **Functions** section.

## Access logic

::: v-pre
The most important thing to learn about Twig is how it accesses the PHP layer. For convenience sake `{{ foo.bar }}` does the following checks on a PHP object:
:::

1. Check if `foo` is an array and `bar` a valid element.
1. If not, and if `foo` is an object, check that `bar` is a valid property.
1. If not, and if `foo` is an object, check that `bar` is a valid method (even if bar is the constructor - use `__construct()` instead).
1. If not, and if `foo` is an object, check that `getBar` is a valid method.
1. If not, and if `foo` is an object, check that `isBar` is a valid method.
1. If not, return a `null` value.

## Unsupported features

There are some features offered by Twig that are not supported by October CMS. They are listed below next to the equivalent feature.

Tag | Equivalent
------------- | -------------
`{% extend %}` | Use [Layouts](../cms/themes/layouts.md) or `{% placeholder %}`
`{% include %}` | Use `{% partial %}` or `{% content %}`
---
subtitle: Twig Filter
---
# |app

The `|app` filter returns an address relative to the public path of the website. The result is an absolute URL, including the domain name and protocol, to the location specified in the filter parameter. The filter can be applied to any path.

```twig
<link rel="icon" href="{{ '/favicon.ico'|app }}" />
```

If the website address is __https://octobercms.com__ the above example would output the following:

```html
<link rel="icon" href="https://octobercms.com/favicon.ico" />
```

It can also be used for static URLs:

```twig
<a href="{{ '/about-us'|app }}">
    About Us
</a>
```

The above would output:

```html
<a href="https://octobercms.com/about-us">
    About us
</a>
```

> **Note**: The `|page` filter is recommended for linking to other pages.
---
subtitle: Twig Filter
---
# |trans

The `|trans` and `|trans_choice` filters translate the value passed in using the applications localization configuration. The localization strings can be loaded by passing the default translation of your string.

```twig
{{ 'I love programming.'|trans }};
```

Replacing parameters in translation strings is possible by passing an array as the first argument. Every parameter is prefixed with a `:` character.

```twig
{{ ':name loves programming.'|trans({ name: 'Jeff' }) }}
```

## Pluralization

The `trans_choice` function is used to process pluralized values.

```twig
{{ 'There is one apple|There are many apples'|trans_choice(3) }}
```

The second argument can contain the parameters.

```twig
{{ '{1} :value minute ago|[2,*] :value minutes ago'|trans_choice(5, { value: 5 }) }}
```

## Shorter Syntax

The `_` and `__` filters are interchangable with the `trans` and `trans_choice` filters.

```twig
{{ 'I love programming.'|_ }}

{{ '{1} :value minute ago|[2,*] :value minutes ago'|__(1, { value: 1 }) }}
```

#### See Also

::: also
* [CMS Theme Localization](../../cms/themes/settings.md)
* [Laravel Localization](https://laravel.com/docs/10.x/localization)
:::
---
subtitle: Twig Filter
---
# |default

The `|default` filter returns the value passed as the first argument if the filtered value is undefined or empty, otherwise the filtered value is returned.

```twig
{{ variable|default('The variable is not defined') }}

{{ variable.foo|default('The foo property on variable is not defined') }}

{{ variable['foo']|default('The foo key in variable is not defined') }}

{{ ''|default('The variable is empty') }}
```

When using the `default` filter on an expression that uses variables in some method calls, be sure to use the `default` filter whenever a variable can be undefined:

```twig
{{ variable.method(foo|default('bar'))|default('bar') }}
```
---
subtitle: Twig Filter
---
# |resize

The `|resize` filter attempts to resize the provided image source using the provided resizing configuration and outputs a URL to the resized image.

```twig
{{ 'image.jpg'|resize(100, 100) }}
```

The filter accepts three arguments: `|resize(width, height, options)`.

If the filter can resize the provided image, then a URL to the image resizer (eg: `/resize/filename.png`) is returned. For subsequent requests, a direct URL to the resized image is returned. If the filter is unable to process the provided image, then it will instead return the original URL unmodified.

This will resize a banner.jpg media image to 1920 x 1080 ratio.

```twig
<img src="{{ 'banner.jpg'|media|resize(1920, 1080) }}" />
```

You can also pass a third options argument. This example will crop the image instead.

```twig
<img src="{{ 'banner.jpg'|resize(800, 600, { mode: 'crop' }) }}" />
```

See the [image resizer article](../../extend/services/resizer.md) for more information on the available `options` parameters.

## Custom Filenames

The resizer will assign a random filename to resized images by default. You may use the original filename by passing the `true` to `filename` option to the resizer.

```twig
<img src="{{ 'banner.jpg'|resize(800, 600, { filename: true }) }}" />
```

The `filename` option also supports a custom filename as a string. The filename should not contain an extension since the original one is used.

```twig
<img src="{{ 'banner.jpg'|resize(800, 600, { filename: 'my-seo-friendly-name' }) }}" />
```

You may modify the extension with the `extension` option. This process will attempt to convert from one file type to another, for example, converting a JPG to a PNG file.

```twig
<img src="{{ 'banner.jpg'|resize(800, 600, {
    filename: 'my-seo-friendly-name',
    extension: 'png'
}) }}" />
```

## Available Sources

You may reference images from multiple sources, including the following paths:

- `/app`
- `/plugins`
- `/themes`
- `/modules`
- `/storage/app/uploads`
- `/storage/app/media`

For example:

```twig
{{ '/plugins/acme/blog/assets/images/someimage.png'|resize(...) }}
```

## PHP Interface

You may resize images in PHP using the `System\Classes\ResizeImages` and `resize` method. The return value is a URL location to the resized image.

```php
ResizeImages::resize('path/to/asset.jpg');
```

The method accepts a width (second argument), height (third argument) and [resizer options](../../extend/services/resizer.md) (fourth argument).

```php
ResizeImages::resize('path/to/asset.jpg', 800, 600, ['mode' => 'crop']);
```

#### See Also

::: also
* [Resizer Service](../../extend/services/resizer.md)
:::
---
subtitle: Twig Filter
---
# |currency

The `|currency` filter is used to display a currency value.

```twig
{{ 100|currency }}
```

::: tip
This Twig filter is introduced after installing the [Currency plugin](https://octobercms.com/plugin/responsiv-currency) available on the October CMS marketplace. You may install it with the following command.

```bash
php artisan plugin:install Responsiv.Currency
```
:::

The filter takes an options argument, as an array that supports various values.

Option | Description
------ | -----------
**to** | To a given currency code
**from** | From a currency code
**format** | Display format. Options: long, short, null.
**site** | Set to `true` to use currency codes from the site definition. Default: `false`.

For example, to convert an amount from USD to AUD.

```php
{{ 1000|currency({ from: 'USD', to: 'AUD' }) }}
```

If you want to use the base and display currency from the site definition, set the **site** option to `true`.

```php
{{ 1000|currency({ site: true }) }}
```

To display a currency in `long` or `short` format.

```php
// $10.00
{{ 1000|currency({ format: '' }) }}

// $10.00 USD
{{ 1000|currency({ format: 'long' }) }}

// $10
{{ 1000|currency({ format: 'short' }) }}
```

## PHP Interface

You may interact with the currency functions via the global `Currency` facade.

For example, to convert an amount from USD to AUD:

```php
Currency::format(1000, ['from' => 'USD', 'to' => 'AUD']);
```

To display a currency in long or short format

```php
// $10.00 USD
Currency::format(1000, ['format' => 'long']);

// $10
Currency::format(1000, ['format' => 'short']);
```


#### See Also

::: also
* [Currency Form Widget](../../element/form/widget-currency.md)
* [Currency List Column](../../element/lists/column-currency.md)
* [Currency Plugin Page](https://octobercms.com/plugin/responsiv-currency)
:::
---
subtitle: Twig Filter
---
# |raw

Output variables in October CMS are automatically escaped, the `|raw` filter marks the value as being "safe" and will not be escaped if `raw` is the last filter applied.

```twig
{# This variable won't be escaped #}
{{ variable|raw }}
```

Be careful when using the `raw` filter inside expressions:

```twig
{% set hello = '<strong>Hello</strong>' %}
{% set hola = '<strong>Hola</strong>' %}

{{ false ? '<strong>Hola</strong>' : hello|raw }}

{# The above will not render the same as #}
{{ false ? hola : hello|raw }}

{# But renders the same as #}
{{ (false ? hola : hello)|raw }}
```
---
subtitle: Twig Filter
---
# |theme

The `|theme` filter returns an address relative to the active theme path of the website. The result is an absolute URL, including domain and protocol, to the asset specified in the filter parameter. Theme assets usually reside in the **assets** subdirectory of a theme directory.

```twig
<script type="text/javascript" src="{{ 'assets/js/menu.js'|theme }}"></script>
```

If the website address is __https://octobercms.com__ and the active theme is called `website` the above example would output the following:

```html
<script type="text/javascript" src="http://october.com/themes/website/assets/js/menu.js"></script>
```

## Combining CSS and JavaScript

The filter can also be used to combine assets of the same type by passing an array of files.

```twig
<link href="{{ [
    'assets/css/styles1.css',
    'assets/css/styles2.css'
]|theme }}" rel="stylesheet">
```

> **Note**: You can enable the assets minification with the `enableAssetMinify` parameter in the `config/cms.php` script. By default the minification is disabled.

### Combiner Aliases

The asset combiner supports common aliases that substitute file paths, these will begin with the `@` symbol. For example the [AJAX framework assets](../../cms/ajax/introduction.md) can be included in the combiner.

```twig
<script src="{{ [
    '@framework.extras',
    'assets/javascript/app.js'
]|theme }}"></script>
```

The following aliases are supported:

Alias | Description
------------- | -------------
`@framework` | AJAX framework extras, subsitute for `{% framework %}` tag (JavaScript)
`@framework.extras` | AJAX framework extras, subsitute for `{% framework extras %}` tag (JavaScript, CSS)
`@framework.turbo` | AJAX framework turbo, subsitute for `{% framework turbo %}` tag (JavaScript)
`@framework.bundle` | AJAX framework bundle, subsitute for `{% framework extras turbo %}` tag (JavaScript, CSS)

:: tip
The same alias can be used for JavaScript or CSS, for example `@framework.extras`. At least one other reference with a CSS or JS file extension is needed in the array to determine which to use.
:::

### External Combiner Paths

In some cases you may wish to combine a file outside the theme, this is achieved by prefixing the path with a symbol to create a dynamic path. For example, a path beginning with `~/` will create a path relative to the application:

```twig
<script src="{{ ['~/modules/system/assets/js/framework.js']|theme }}"></script>
```

These symbols are supported for creating dynamic paths:

Symbol | Description
------------- | -------------
`~` | Relative to the application directory
`$` | Relative to the plugins directory
`#` | Relative to the themes directory
---
subtitle: Twig Filter
---
# |link

The `|link` filter returns a link generated using the `october://` output schema of a [page finder form widget](../../element/form/widget-pagefinder.md). The result is a public URL to the page specified by the form widget.

```twig
<a href="{{ 'october://cms-page@link/about'|link }}" />
```

::: tip
If you are looking to parse HTML for multiple links and resolve them as HTTP links in the output, see the [`|content` Twig filter](../tag/content.md).
:::

## link()

The complimentary `link()` function is used to extract more detailed information about a link.

```twig
{% set resolved = link('october://cms-page@link/about') %}

{{ resolved.url }}
```

The following properties can be expected in the resulting object.

Property | Data
------------- | -------------
**url** | the public URL to the page.
**mtime** | the modification time of the page link.
**title** | a human readable title for the link, optional.
**items** | an array containing generated child items, optional.
**isActive** | set to true if the link is currently active.

You may request nested child items by passing the `nesting` option to `true` (second argument), which populates the `items` property on the result.

```twig
{% set resolved = link('october://...', { nesting: true }) %}

{% for subitem in resolved.items %}
    {{ subitem.url }}
{% endfor %}
```

You may request other site URLs by passing the `sites` option to `true`, which populates the `sites` property on the result.

```twig
{% set resolved = link('october://...', { sites: true }) %}

{% for site in resolved.sites %}
    {{ site.url }}
{% endfor %}
```

## PHP Interface

You may resolve links in PHP using the `Cms\Classes\PageManager` class. The `url` method returns a string to the public URL.

```php
Cms\Classes\PageManager::url('october://cms-page@link/about');
```

The `resolve` method returns a detailed `Cms\Models\PageLookupItem` object.

```php
$page = Cms\Classes\PageManager::resolve('october://cms-page@link/about');

echo $page->url;
```

#### See Also

::: also
* [Page Finder Form Widget](../../element/form/widget-pagefinder.md)
:::
---
subtitle: Twig Filter
---
# |media

The `|media` filter returns an address relative to the public path of the [media manager library](../../cms/media/introduction.md). The result is a URL to the media file specified in the filter parameter.

```twig
<img src="{{ 'banner.jpg'|media }}" />
```

If the media manager address is __https://cdn.octobercms.com__ the above example would output the following:

```html
<img src="https://cdn.octobercms.com/banner.jpg" />
```

## PHP Interface

You may generate URLs in PHP using the `Media\Classes\MediaLibrary` class and `url` method.

```php
MediaLibrary::url('relative/path/to/asset.jpg');
```
---
subtitle: Twig Filter
---
# |md

The `|md` filter converts the value from Markdown to HTML format.

```twig
{{ '**Text** is bold.'|md }}
```

The above will output the following:

```html
<strong>Text</strong> is bold.
```

See the [Markdown Parser article](../../extend/services/parser.md) for more details on using Markdown.

## |md_safe

The `|md_safe` filter will parse Markdown with safe mode enabled, that completely escapes all HTML except for basic HTML generated by Markdown syntax. In short, it means HTML markup is escaped plus defence against where the Markdown syntax offers scripting capabilities. Only specific "safe" HTML protocols can be used, for example, `https://`, `ftps://`, `mailto:`, etc.

The following JavaScript will not execute:

```twig
{{ '<a href="javascript:alert(1)">click me</a>'|md_safe }}
```

## |md_clean

The `md_clean` filter will parse Markdown with more HTML support than `|md_safe` because it uses a sanitizer to remove any potentially dangerous code.

```twig
{{ '<script>alert(1)</script>'|md_clean }}
```

#### See Also

::: also
* [Markdown Parser article](../../extend/services/parser.md)
:::
---
subtitle: Twig Filter
---
# |page

The `|page` filter creates a link to a page using a page file name, without an extension, as a parameter. For example, if there is the about.htm page you can use the following code to generate a link to it:

```twig
<a href="{{ 'about'|page }}">About Us</a>
```

Remember that if you refer a page from a subdirectory you should specify the subdirectory name:

```html
<a href="{{ 'contacts/about'|page }}">About Us</a>
```

::: tip
The [Themes documentation](../../cms/themes/themes.md) has more details on subdirectory usage.
:::

To access the link to a certain page from the PHP section, you can use `$this->pageUrl('page-name-without-extension')`.

::: cmstemplate
```ini
```
```php
<?
function onStart()
{
    $this['newsPage'] = $this->pageUrl('blog/overview');
}
?>
```
```twig
{{ newsPage }}
```
:::

You can create a link to the current page by filtering the `this` variable.

```twig
<a href="{{ this|page }}">Refresh page</a>
```

To get the link to the current page in PHP, call the `$this->pageUrl()` method without any arguments.

::: cmstemplate
```ini
```
```php
<?
function onStart()
{
    $this['currentUrl'] = $this->pageUrl();
}
?>
```
```twig
{{ currentUrl }}
```
:::

## Reverse Routing

When linking to a page that has URL parameters defined, the `|page` filter supports reverse routing by passing an array as the first argument.

::: cmstemplate
```ini
url = "/blog/post/:post_id"
```
```twig
[...]
```
:::

Given the above content is found in a CMS page file **post.htm** you can link to this page using:

```twig
<a href="{{ 'post'|page({ post_id: 10 }) }}">
    Blog post #10
</a>
```

If the website address is __https://octobercms.com__ the above example would output the following:

```html
<a href="https://octobercms.com/blog/post/10">
    Blog post #10
</a>
```

## Persistent URL Parameters

If a URL parameter is already presented in the environment, the `|page` filter will use it automatically.

```ini
url = "/blog/post/:post_id"

url = "/blog/post/edit/:post_id"
```

If there are two pages, **post.htm** and **post-edit.htm**, with the above URLs defined, you can link to either page without needing to define the `post_id` parameter.

```twig
<a href="{{ 'post-edit'|page }}">
    Edit this post
</a>
```

When the above markup appears on the **post.htm** page, it will output the following:

```html
<a href="https://octobercms.com/blog/post/edit/10">
    Edit this post
</a>
```

The `post_id` value of *10* is already known and has persisted across the environments. You can disable this functionality by passing the 2nd argument as `false`:

```twig
<a href="{{ 'post'|page(false) }}">
    Unknown blog post
</a>
```

Or by defining a different value:

```twig
<a href="{{ 'post'|page({ post_id: 6 }) }}">
    Blog post #6
</a>
```
---
subtitle: Twig Tag
---
# {% flash %}

::: aside
View the [Flash Messages article](../../cms/features/flash-messages.md) to learn more about using flash messages.
:::

The `{% flash %}` and `{% endflash %}` tags will render any flash messages stored in the user session, set by the `Flash` PHP class. The `message` variable inside will contain the flash message text and the markup inside will repeat for multiple flash messages.

```twig
<ul>
    {% flash %}
        <li>{{ message }}</li>
    {% endflash %}
</ul>
```

You can use the `type` variable that represents the flash message type &mdash; **success**, **error**, **info** or **warning**.

```twig
{% flash %}
    <div class="alert alert-{{ type }}">
        {{ message }}
    </div>
{% endflash %}
```

You can also specify the `type` to filter flash messages of a given type. The next example will show only **success** messages, if there is an **error** message it won't be displayed.

```twig
{% flash success %}
    <div class="alert alert-success">{{ message }}</div>
{% endflash %}
```

## Setting Flash Messages to a Twig Variable

In any template you can set the flash messages to a variable with the `flash()` function. This lets you manipulate the output before display. The function returns an array with one flash message per type.

```twig
{% set messages = flash() %}
```

The first argument can specify the message type, which returns the message as a string.

```twig
{% set successMessage = flash('success') %}
```

If the first argument is set to **all** it will return an array of types, each type is an array of all flash messages.

```twig
{% set allMessages = flash('all') %}
```

#### See Also

::: also
* [Flash Messages](../../cms/features/flash-messages.md)
:::
---
subtitle: Twig Tag
---
# {% content %}

The `{% content %}` tag will display a [CMS content block](../../cms/themes/content.md) on the page. To display content block called **contacts.htm** you pass the file name after the `content` tag quoted as a string.

```twig
{% content "contacts.htm" %}
```

A content block inside a subdirectory can be rendered in the same way.

```twig
{% content "sidebar/content.htm" %}
```

::: tip
The [Themes documentation](../../cms/themes/themes.md) has more details on subdirectory usage.
:::

Content blocks can be rendered as plain text:

```twig
{% content "readme.txt" %}
```

You can also use Markdown syntax:

```twig
{% content "changelog.md" %}
```

Content blocks can also be used in combination with [layout placeholders](../../cms/themes/layouts.md).

```twig
{% put sidebar %}
    {% content 'sidebar-content.htm' %}
{% endput %}
```

## Variables

You can pass variables to content blocks by specifying them after the file name:

```twig
{% content "welcome.htm" name=user.name %}
```

You can also assign new variables for use in the content:

```twig
{% content "location.htm" city="Vancouver" country="Canada" %}
```

Inside the content, variables can be accessed using a basic syntax using singular *curly brackets*:

```
<p>Country: {country}, city: {city}.</p>
```

You can also pass a collection of variables as a simple array:

```twig
{% content "welcome.htm" likes=[
    {name:'Dogs'},
    {name:'Fishing'},
    {name:'Golf'}
] %}
```

The collection of variables is accessed by using an opening and closing set of brackets:

```
<ul>
    {likes}
        <li>{name}</li>
    {/likes}
</ul>
```

> **Note**: Twig syntax is not supported in Content blocks, consider using a [CMS partial](../cms/partials.md) instead.

## Setting Contents to a Twig Variable

In any template you can set the contents to a variable with the `content()` function. This lets you manipulate the output before display. Remember to use the `|raw` filter to prevent output escaping.

```twig
{% set welcomeContent = content('welcome.htm') %}

{{ welcomeContent|raw }}
```

You may also pass variables to the content as the second argument.

```twig
{% set welcomeContent = content('welcome.htm', { foo: 'bar' }) %}
```

## Checking a Content File Exists

The `hasContent()` function can be used to check if a content exists without rendering the contents. To prevent the rendering of the content, pass the second argument as false and it will return true or false if the content file is found.

```twig
{% if hasContent('welcome.htm') %}
    {% content 'welcome.htm' %}
{% else %}
    <p>Welcome content not found!</p>
{% endif %}
```

## Parsing Content as a String

When using the `{% content %}` tag, it will resolve [CMS snippets](../../cms/themes/snippets.md) and links created by the [page finder form widget](../../element/form/widget-pagefinder.md) automatically.

Similarly, the `|content` filter can be used to parse a HTML string for multiple content objects and resolve them in the output.

```twig
{{ post.content|content }}
```

The `|md` filter can also be used to parse Markdown content found in a string.

```twig
{{ post.markdown_content|md|content }}
```

#### See Also

::: also
* [CMS Snippets](../../cms/themes/snippets.md)
* [Link Twig Filter](../../markup/filter/link.md)
* [Markdown Twig Filter](../../markup/filter/md.md)
:::
---
subtitle: Twig Tag
---
# {% macro %}

The `{% macro %}` tag allows you to define custom functions in your templates, similar to regular programming languages.

```twig
{% macro input() %}
    ...
{% endmacro %}
```

Alternatively you can include the name of the macro after the end tag for better readability:

```twig
{% macro input() %}
    ...
{% endmacro input %}
```

The following example defines a function called `input()` that takes 4 arguments, the associated values are accessed as variables within the markup inside.

```twig
{% macro input(name, value, type, size) %}
    <input
        type="{{ type|default('text') }}"
        name="{{ name }}"
        value="{{ value|e }}"
        size="{{ size|default(20) }}" />
{% endmacro %}
```

> **Note**: Macro arguments don't specify default values and are always considered optional.

## Calling Macros

Before a macro can be used it needs to be "imported" first using the `{% import %}` tag. If the macro is defined in the same template, the special `_self` variable can be used.

```twig
{% import _self as form %}
```

Here the macro functions are assigned to the `form` variable, available to be called like any other function.

```twig
<p>{{ form.input('username') }}</p>
<p>{{ form.input('password', null, 'password') }}</p>
```

Macros can be defined in [a theme partial](../../cms/themes/partials.md) and imported by name. To import the macros from a partial called **macros/form.htm**, simply pass the name after the `import` tag quoted as a string.

```twig
{% import 'macros/form' as form %}
```

Alternatively you may import macros from a [system view file](../../extend/services/response-view.md) and these will be accepted. To import from **plugins/acme/blog/views/macros.htm** simply pass the path hint instead.

```twig
{% import 'acme.blog::macros' as form %}
```

## Nested Macros

When you want to use a macro inside another macro from the same template, you need to import it locally.

```twig
{% macro input(name, value, type, size) %}
    <input
        type="{{ type|default('text') }}"
        name="{{ name }}"
        value="{{ value|e }}"
        size="{{ size|default(20) }}" />
{% endmacro %}

{% macro wrapped_input(name, value, type, size) %}
    {% import _self as form %}

    <div class="field">
        {{ form.input(name, value, type, size) }}
    </div>
{% endmacro %}
```

## Context Variable

Macros don't have access to the current page variables.

```twig
<!-- October CMS -->
{{ site_name }}

{% macro myFunction() %}
    <!-- NULL -->
    {{ site_name }}
{% endmacro %}
```

You may pass the variables to the function using the special `_context` variable.

```twig
{% macro myFunction(vars) %}
    {{ vars.site_name }}
{% endmacro %}

{% import _self as form %}

<!-- October CMS -->
{{ form.myFunction(_context) }}
```
---
subtitle: Twig Tag
---
# {% if %}

The `{% if %}` and `{% endif %}` tags will represent an expression and is comparable with the if statements of PHP. In the simplest form you can use it to test if an expression evaluates to `true`:

```twig
{% if online == false %}
    <p>The website is in maintenance mode.</p>
{% endif %}
```

You can also test if an array is not empty:

```twig
{% if users %}
    <ul>
        {% for user in users %}
            <li>{{ user.username }}</li>
        {% endfor %}
    </ul>
{% endif %}
```

> **Note**: If you want to test if the variable is defined, use `{% if users is defined %}` instead.

You can also use `not` to check for values that evaluate to `false`:

```twig
{% if not user.subscribed %}
    <p>You are not subscribed to our mailing list.</p>
{% endif %}
```

For multiple expressions `{% elseif %}` and `{% else %}` can be used:

```twig
{% if kenny.sick %}
    Kenny is sick.
{% elseif kenny.dead %}
    You killed Kenny! You bastard!!!
{% else %}
    Kenny looks okay so far.
{% endif %}
```

## Expression Rules

The rules to determine if an expression is true or false are the same as in PHP, here are the edge cases rules:

Value | Boolean evaluation
------------- | -------------
*empty string* | false
*numeric zero* | false
*whitespace-only string* | true
*empty array* | false
*null* | false
*non-empty array* | true
*object* | true
---
subtitle: Twig Tag
---
# {% partial %}

The `{% partial %}` tag will parse a [CMS partial](../../cms/themes/partials.md) and render the partial contents on the page. To display a partial called **footer.htm**, simply pass the name after the `partial` tag quoted as a string.

```twig
{% partial "footer" %}
```

A partial inside a subdirectory can be rendered in the same way.

```twig
{% partial "sidebar/menu" %}
```

::: tip
The [Themes documentation](../../cms/themes/themes.md) has more details on subdirectory usage.
:::

The partial name can also be a variable:

```twig
{% set tabName = "profile" %}
{% partial tabName %}
```

## Variables

You can pass variables to partials by specifying them after the partial name:

```twig
{% partial "blog-posts" posts=posts %}
```

You can also assign new variables for use in the partial:

```twig
{% partial "location" city="Vancouver" country="Canada" %}
```

Inside the partial, variables can be accessed like any other markup variable:

```twig
<p>Country: {{ country }}, city: {{ city }}.</p>
```

## Passing Markup as a Variable

It is possible to pass markup to a partial using the `body` attribute.

```twig
{% partial "card" body %}
    This is the card contents
{% endpartial %}
```

The contents are then available as the `body` variable.

```twig
{{ body|raw }}
```

### Composable Partials

Composable partials are possible when combined with the `{% placeholder %}` [Twig tag](./placeholder.md). The following partial defines a `header` and a `body` section where HTML content can be added.

```twig
<div class="header">
    {% placeholder header %}
</div>
<div class="body">
    {{ body|raw }}
</div>
```

Next, you can include the `{% put %}` tag inside the `body` to compose the partial result with two HTML content sections.

```twig
{% partial "card" body %}
    {% put header %}
        <h2>This is the card header</h2>
    {% endput %}
    <p>This is the card contents</p>
{% endpartial %}
```

## Setting Partial Contents to a Twig Variable

In any template you can set the partial contents to a variable with the `partial()` function. This lets you manipulate the output before display. Remember to use the `|raw` filter to prevent output escaping.

```twig
{% set cardPartial = partial('my-cards/card') %}

{{ cardPartial|raw }}
```

You may also pass variables to the partial as the second argument.

```twig
{% set cardPartial = partial('my-cards/card', { foo: 'bar' }) %}
```

## Checking a Partial Exists

The `hasPartial()` function can be used to check if a partial exists without rendering the contents, it will return true or false if the partial is found.

```twig
{% if hasPartial('my-cards/card') %}
    {% partial 'my-cards/card' %}
{% else %}
    <p>Card not found!</p>
{% endif %}
```
---
subtitle: Twig Tag
---
# {% verbatim %}

The `{% verbatim %}` tag marks entire sections as being raw text that should not be parsed.

```twig
{% verbatim %}<p>Hello, {{ name }}</p>{% endverbatim %}
```

The above will render in the browser exactly as:

```twig
<p>Hello, {{ name }}</p>
```

For example, AngularJS uses the same templating syntax so you can decide which variables to use for each.

```twig
<p>Hello {{ name }}, this is parsed by Twig</p>

{% verbatim %}
    <p>Hello {{ name }}, this is parsed by AngularJS</p>
{% endverbatim %}
```
---
subtitle: Twig Tag
---
# {% for %}

The `{% for %}` and `{% endfor %}` tags will loop over each value in a collection. A collection can be either an array or an object implementing the `Traversable` interface.

```twig
<ul>
    {% for user in users %}
        <li>{{ user.username }}</li>
    {% endfor %}
</ul>
```

You can also access both keys and values:

```twig
<ul>
    {% for key, user in users %}
        <li>{{ key }}: {{ user.username }}</li>
    {% endfor %}
</ul>
```

If the collection is empty, you can render a replacement block by using else:

```twig
<ul>
    {% for user in users %}
        <li>{{ user.username }}</li>
    {% else %}
        <li><em>There are no users found</em></li>
    {% endfor %}
</ul>
```

## Looping a Collection

If you do need to iterate over a collection of numbers, you can use the `..` operator:

```twig
{% for i in 0..10 %}
    - {{ i }}
{% endfor %}
```

The above snippet of code would print all numbers from 0 to 10.

It can also be useful with letters:

```twig
{% for letter in 'a'..'z' %}
    - {{ letter }}
{% endfor %}
```

The `..` operator can take any expression at both sides:

```twig
{% for letter in 'a'|upper..'z'|upper %}
    - {{ letter }}
{% endfor %}
```

## Adding a Condition

Unlike in PHP there is no function to `break` or `continue` in a loop, however you can still filter the collection. The following example skips all the `users` that are not active.

```twig
<ul>
    {% for user in users %}
        {% if user.active %}
            <li>{{ user.username }}</li>
        {% endif %}
    {% endfor %}
</ul>
```

## The Loop Variable

Inside of a `for` loop block you can access some special variables:

Variable | Description
------------- | -------------
`loop.index` | The current iteration of the loop. (1 indexed)
`loop.index0` | The current iteration of the loop. (0 indexed)
`loop.revindex` |  The number of iterations from the end of the loop (1 indexed)
`loop.revindex0` | The number of iterations from the end of the loop (0 indexed)
`loop.first` | True if first iteration
`loop.last` |  True if last iteration
`loop.length` | The number of items in the collection
`loop.parent` | The parent context

```twig
{% for user in users %}
    {{ loop.index }} - {{ user.username }}
{% endfor %}
```
---
subtitle: Twig Tag
---
# {% component %}

The `{% component %}` tag will parse the default markup content for a [CMS component](../../cms/themes/components.md) and display it on the page. Not all components provide default markup, the documentation for the plugin will guide in the correct usage.

```twig
{% component "blogPosts" %}
```

This will render the component partial with a fixed name of **default.htm** and is essentially an alias for the following:

```twig
{% partial "blogPosts::default" %}
```

## Variables

Some components support passing variables to them at render time.

```twig
{% component "blogPosts" postsPerPage="5" %}
```

## Customizing Components

In most cases the `{% component %}` tag is not needed and the markup is provided as a usage example for the component API. Components are intended to be customized, this can be done in two ways:

1. Moving the default markup to a partial
1. Overriding component partials using the theme

The [CMS Components article](../../cms/themes/components.md) outlines the process of customizing default markup.

#### See Also

::: also
* [CMS Components](../../cms/themes/components.md)
:::
---
subtitle: Twig Tag
---
# {% placeholder %}

The `{% placeholder %}` tag will render a placeholder section which is generally [used inside Layouts](../../cms/themes/layouts.md). This tag will return any placeholder contents that have been added using the `{% put %}` tag, or any default content that is defined (optional).

```twig
{% placeholder name %}
```

Content can then be injected into the placeholder in any subsequent page or partial.

```twig
{% put name %}
    <p>Place this text in the name placeholder</p>
{% endput %}
```

## Default Placeholder Content

Placeholders can have default content that can be either replaced or complemented by a page. If the `{% put %}` tag for a placeholder with default content is not defined on a page, the default placeholder content is displayed. Example placeholder definition in the layout template:

```twig
{% placeholder sidebar default %}
    <p><a href="/contacts">Contact us</a></p>
{% endplaceholder %}
```

The page can inject more content to the placeholder. The `{% default %}` tag specifies a place where the default placeholder content should be displayed. If the tag is not used the placeholder content is completely replaced.

```twig
{% put sidebar %}
    <p><a href="/services">Services</a></p>
    {% default %}
{% endput %}
```

## Checking a Placeholder Exists

In a layout template you can check if a placeholder content exists by using the `hasPlaceholder()` function. This lets you to generate different markup depending on whether the page provides a placeholder content. Example:

```twig
{% if hasPlaceholder('sidemenu') %}
    <!-- Markup for a page with a sidebar -->
    <div class="row">
        <div class="col-md-3">
            {% placeholder sidemenu %}
        </div>
        <div class="col-md-9">
            {% page %}
        </div>
    </div>
{% else %}
    <!-- Markup for a page without a sidebar -->
    {% page %}
{% endif %}
```

## Using Placeholders as Variables

Placeholders can be useful for setting inherited variables, such as the active link in page navigation. The `{% put %}` tag allows you to set values directly. For example, setting the `activeNav` value to **home** inside a page template.

```twig
{% put activeNav = 'home' %}
```

The variable can be accessed inside the layout template using the `placeholder()` function. From this, we can determine the active link based on the value set by the page.

```twig
{% set active = placeholder('activeNav') %}

<ul>
    <li class="{{ active == 'home' ? 'active' }}">Home</li>
    <li class="{{ active == 'blog' ? 'active' }}">Blog</li>
    <li class="{{ active == 'contact' ? 'active' }}">Contact</li>
</ul>
```

A default value (second argument) can be supplied as a fallback.

```twig
{% set active = placeholder('activeNav', 'home') }} %}
```

## Custom Attributes

The `placeholder` tag accepts two optional attributes &mdash; `title` and `type`. The `title` attribute is not used by the CMS itself, but could be used by other plugins. The type attribute manages the placeholder type. There are two types supported at the moment &mdash; **text** and **html**. The content of text placeholders is escaped before it's displayed. The title and type attributes should be defined after the placeholder name and the `default` attribute, if it's presented. Example:

```twig
{% placeholder ordering title="Ordering information" type="text" %}
```

Example of a placeholder with a default content, title and type attributes.

```twig
{% placeholder ordering default title="Ordering information" type="text" %}
    There is no ordering information for this product.
{% endplaceholder %}
```

## System Placeholders

October CMS defines static placeholders that are used by the system. Packages will use these placeholders to inject their dependencies to the page, either using the PHP or Twig interface.

### {% scripts %}

The `{% scripts %}` tag inserts JavaScript file references to scripts injected by the application. The tag is commonly defined before the closing BODY tag.

```twig
<body>
    ...
    {% scripts %}
</body>
```

> **Note**: This tag should appear once only in a given page cycle to prevent duplicated references.

#### Injecting Scripts

Links to JavaScript files can be programmatically injected in PHP either by [components](../../extend/cms-components.md) or [pages](../../cms/themes/pages.md).

```php
function onStart()
{
    $this->addJs('assets/js/app.js');
}
```

You can also inject raw markup to the `{% scripts %}` tag by using the **scripts** anonymous placeholder [in the layout](../../cms/themes/layouts.md). Use the `{% put %}` tag in pages or layouts to add content to the placeholder.

```twig
{% put scripts %}
    <script type="text/javascript" src="/themes/demo/assets/js/menu.js"></script>
{% endput %}
```

### {% styles %}

The `{% styles %}` tag renders CSS links to stylesheet files injected by the application. The tag is commonly defined in the HEAD section of a page or layout.

```twig
<head>
    ...
    {% styles %}
</head>
```

> **Note**: This tag should appear once only in a given page cycle to prevent duplicated references.

#### Injecting Styles

Links to StyleSheet files can be programmatically injected in PHP either by [components](../../extend/cms-components.md) or [pages](../../cms/themes/pages.md).

```php
function onStart()
{
    $this->addCss('assets/css/hello.css');
}
```

You can also inject raw markup to the `{% styles %}` tag by using the **styles** anonymous placeholder [in the layout](../../cms/themes/layouts.md). Use the `{% put %}` tag in pages or layouts to add content to the placeholder.

```twig
{% put styles %}
    <link href="/themes/demo/assets/css/page.css" rel="stylesheet" />
{% endput %}
```

### {% meta %}

The `{% meta %}` tag renders meta content, such as open graph information. The tag is commonly defined in the HEAD section of a page or layout, placed before the styles and scripts.

```twig
<head>
    {% meta %}
    ...
</head>
```

> **Note**: This tag should appear once only in a given page cycle to prevent duplicated references.

#### Injecting Meta Data

You can inject raw markup to the `{% meta %}` tag by using the **meta** anonymous placeholder [in the layout](../../cms/themes/layouts.md). Use the `{% put %}` tag in pages or layouts to add content to the placeholder.

```twig
{% put meta %}
    <meta name="turbo-visit-control" content="error">
{% endput %}
```
---
subtitle: Twig Tag
---
# {% page %}

The `{% page %}` tag renders the contents of a [page](../../cms/themes/pages.md) into a layout template. See [layouts](../../cms/themes/layouts.md) for a basic example.

The `{% page %}` tag parses the raw markup from a page template. A page template may inject content both into placeholder(s) as well as define raw markup.

::: cmstemplate
```ini
description="example layout"
```
```twig
<html>
    <head>
        {% placeholder head %}
    </head>
    <body>
        {% page %}
        ...
```
:::

Placing content in the `head` placeholder.

::: cmstemplate
```ini
description="example page"
```
```twig
{% put head %}
    <meta name="foo" content="bar">
{% endput %}

<p>My content.</p>
```
:::

The page rendered with the template would result in:

```html
<html>
    <head>
        <meta name="foo" content="bar">
    </head>
    <body>
        <p>My content.</p>
        ...
```
---
subtitle: Twig Tag
---
# {% ajaxPartial %}

::: aside
This tag extends the [`{% partial %}` Twig tag](./partial.md).
:::

The `{% ajaxPartial %}` tag renders partial contents on the page and includes support for [AJAX handlers](../../cms/ajax/introduction.md), self-updating and short update syntax. This is commonly referred to as a self-updating partial.

```twig
{% ajaxPartial "contact-form" %}
```

The partial contents are wrapped with a specific HTML tag on the first load only. Subsequent updates of the partial via AJAX do not include the wrapper tag.

```html
<div data-ajax-partial="contact-form">
    ... Contents go here ...
</div>
```

## Short Update Syntax

When an AJAX partial is used, you no longer need to specify a selector to update it. Just pass `true` to the [data attributes API](../../cms/ajax/attributes-api.md) when using the `data-request-update` attribute.

```html
<button
    data-request="onRefresh"
    data-request-update="{ contact-form: true }">
    Refresh
</button>
```

You may also update the partial from inside itself using `_self` as the partial name.

```html
<button
    data-request="onRefresh"
    data-request-update="{ _self: true }">
    Refresh
</button>
```

You may also pass the `^` symbol to prepend and the `@` symbol to append content to the container instead of replacing it.

```html
<button
    data-request="onRefresh"
    data-request-update="{ _self: '@' }">
    Append
</button>
```

## Lazy Loading Partials

The `{% ajaxPartial %}` accepts a `lazy` attribute that will defer rendering the content until the page loads.

```twig
{% ajaxPartial "posts" lazy %}
```

The `lazy body` attributes allow specifying the initial content before loading, followed by the `{% endpartial %}` tag.

```twig
{% ajaxPartial 'posts' lazy body %}
    <p>Loading posts...</p>
{% endpartial %}
```

## Calling AJAX Handlers

When calling an AJAX handler from inside an AJAX partial, a capturing page life cycle (see below) is triggered that enables the use of AJAX handlers within the requested partials.

The following example shows how to submit a simple contact form using a self-updating partial.

::: cmstemplate
```ini
description = "Self Updating Partial"
```
```php
<?
function onSubmitContactForm()
{
    $this['submitted'] = true;
}
?>
```
```twig
{% if submitted %}
    <p>Thank you for contacting us!</p>
{% endif %}

<button
    data-request="onSubmitContactForm"
    data-request-update="{ _self: true }">
    Submit
</button>
```
:::

Partials that use [CMS components](../../cms/themes/components.md) will also have their AJAX handlers made available.

::: cmstemplate
```ini
[contactForm]
```
```html
<button
    data-request="contactForm::onSubmit"
    data-request-update="{ _self: true }">
    Submit
</button>
```
:::

### Capture Lifecycle

When calling a handler from an AJAX partial, it will trigger a different lifecycle, called the capture lifecycle. ​The capture lifecycle renders the entire page, however it renders the contents into the void. This way, the page is initialized completely, including all the used partials and AJAX handlers.

Since it counts as a complete page render, this may mean the `onRun` [component method](../../extend/cms-components.md) is called when an AJAX partial handler is used. ​You can use `Request::ajax()` [helper method](../../extend/services/request-input.md) to determine if the request is occurring as the result of an AJAX request.
---
subtitle: Learn how to build a simple API using CMS Pages.
---
# Building API Endpoints

::: aside
View the [routing article](../../extend/system/routing.md) if you prefer to define API routes using PHP instead.
:::

When working with client-side frameworks such as Vue.js or React, it will be necessary to consume server-side APIs. These can be defined using your theme where each page represents an API endpoint.

The page represents a transformation layer that sits between your CMS Components and the JSON responses that are returned to your application. Most objects, such as models and collections, support JSON serialization and can be returned directly as a response.

## Sending a Response

In the simplest form, an API resource can be composed by returning a Twig variable using the `response()` [Twig function](../../markup/function/response.md). This function overrides the page contents and returns a custom response to the browser.

::: cmstemplate
```ini
url = "/api/foobar"
```
```twig
{% do response({ foo: 'bar' }) %}
```
:::

The above call will return a response with a `application/json` content type.

```json
{ "foo": "bar" }
```

In most cases you will be converting component variables to a response.

```twig
{% do response({
    id: post.id,
    title: post.title,
    email: post.author.email,
    created_at: post.created_at,
    updated_at: post.updated_at
}) %}
```

### Collections

The `collect()`[Twig function](../../markup/function/collect.md) builds a collection for a response. The `push` method is used to push items on to the collection and it can be used to customize each result.

```twig
{% set result = collect() %}

{% for post in posts %}
    {% do result.push({
        id: post.id,
        title: post.title,
        email: post.author.email,
        created_at: post.created_at,
        updated_at: post.updated_at
    }) %}
{% endfor %}

{% do response(result) %}
```

## Conditions

All Twig conditions can be used in the markup to affect the response and the last response call is the one that will be sent to the browser.

### Checking the HTTP Method

Use the `this.request.method` [Twig property](../../markup/property/this-request.md) to check the request method.

```twig
{% if this.request.method == 'GET' %}
    <!-- Do GET Logic -->
{% else %}
    <!-- Method Unsupported -->
{% endif %}
```

### Aborting the Request

The `abort()` [Twig function](../../markup/function/abort.md) can be used to abort the request with a 404 response.

```twig
{% if post %}
    {% do response(post) %}
{% else %}
    {% do abort(404) %}
{% endif %}
```

## Working with Pages and Layouts

Since the API is defined in the Markup section of the page or layout, all components and life-cycle events are available.

### Using Layouts as Middleware

Middleware allows you to apply common logic to multiple endpoints, such as checking authentication or throttling requests. A [CMS layout with priority mode](../themes/layouts.md) can be used to apply logic to multiple pages and the layout logic executes before the page logic.

Remember to include the [`{% page %}` Twig tag](../../markup/tag/page.md) so the page logic is included. For example, a layout named **api.htm** can have any conditional logic.

::: cmstemplate
```ini
description = "API Authentication"
is_priority = 1
```
```twig
{% if someCondition %}
    {% page %}
{% else %}
    {% do response({ message: 'Condition not met' }, 400) %}
{% endif %}
```
:::

Every page that uses the layout will have the conditions of the layout applied.

::: cmstemplate
```ini
layout = "api"
```
```twig
{% do response({ success: true }) %}
```
:::

::: warning
Always use [priority mode in the layout](../themes/layouts.md) to ensure the layout contents run first.
:::

### Calling AJAX Handlers

In some cases you may wish to call an AJAX handler of a component or inside the page. This is possible using the [`ajaxHandler()` Twig function](../../markup/function/ajax-handler.md).

::: cmstemplate
```ini
url = "/api/signin

[account]
```
```twig
{% set result = ajaxHandler('onSignin') %}

{% if result.error %}
    {% do response({ message: 'Login Failed' }, 401) %}
{% else %}
    {% do response({ success: true }) %}
{% endif %}
```
:::

You may also call a handler and pass it directly as a response. The response includes variables set on the page and array values returned by the function.

```twig
{% do response(ajaxHandler('onSubmitPost')) %}
```

It will also handle redirects automatically. See the [Twig function article](../../markup/function/ajax-handler.md) for more details.

## Working with Resources

When working with models and collections, it is recommended to return data wrapped in the **data** attribute. Wrapping the response provides a consistent interface.

### Models & Collections

Returning a model resource.

::: cmstemplate
```ini
url = "/api/blog/post/:slug"

[section post]
handle = "Blog\Post"
entrySlug = "{{ :slug }}"
```
```twig
{% if post %}
    {% do response({
        data: post
    }) %}
{% else %}
    {% do abort(404) %}
{% endif %}
```
:::

Returning a collection resource.

::: cmstemplate
```ini
url = "/api/blog/posts"

[collection posts]
handle = "Blog\Post"
```
```twig
{% do response({
    data: posts
}) %}
```
:::

### Pagination

When responding with a paginated collection, it is recommended to use the `pager()` [Twig function](../../markup/function/pager.md) to construct the response using the **links** and **meta** attributes.

```twig
{% set posts = blog.paginate(3) %}

{% set pager = pager(posts) %}

{% do response({
    data: posts,
    links: pager.links,
    meta: pager.meta
}) %}
```

The above will output the following JSON format.

```json
{
    "data": {},
    "links": {
        "first": "https://yoursite.tld/api/blog/posts?page=1",
        "last": "https://yoursite.tld/api/blog/posts?page=1",
        "prev": null,
        "next": null
    },
    "meta": {
        "path": "https://yoursite.tld/api/blog/posts",
        "per_page": 3,
        "total": 2,
        "current_page": 1,
        "last_page": 1,
        "from": 1,
        "to": 2
    }
}
```

## Usage Examples

These are some practical examples of how snippets can be used.

### Returning Users with Avatar Thumbnails

The following example sets the `users` variable to all the users found in the [User plugin](https://octobercms.com/plugin/rainlab-user). The `avatar` relationship is eager loaded after the fact and then the `avatar_thumb` attribute is set as a thumb URL for each user if an avatar is found.

::: cmstemplate
```ini
## pages/api/users.htm
url = "/api/users"
```
```php
function onStart()
{
    $this['users'] = \RainLab\User\Models\User::all();
}
```
```twig
{# Load up the avatar relation #}
{% do users.load('avatar') %}

{# Set the 'avatar_thumb' attribute on each user #}
{% for user in users %}
    {% do user.setAttribute(
        'avatar_thumb',
        user.avatar.getThumbUrl(100, 100, {mode: 'crop'})|default(null)
    ) %}
{% endfor %}

{# Respond with the user #}
{% do response({
    data: users
}) %}
```
:::

#### See Also

::: also
* [Response Twig Function](../../markup/function/response.md)
* [AJAX Handler Twig Function](../../markup/function/ajax-handler.md)
:::
---
subtitle: Learn how to translate content using multiple sites
---
# Multisite

<VideoBlockLink src="https://www.youtube.com/watch?v=_kX7P3SEHg8" title="Multisite Demo" description="This video demonstrates how to create multilingual sites with October CMS Multisite." prompt="Watch the demonstration" />

The multisite feature lets you manage multiple websites from a single October CMS installation and assign content dependent on the domain name. For example, an e-commerce store with different country-specific sub-sites. You can also use it to manage translations for a localized website.

## Managing Sites

You can create sites by visiting the admin panel's **Settings → Manage Sites** page. Every installation includes a primary site that acts as the default site for every request.

The following configuration defines each site:

- **Enabled** - determines if you can access the site on the front end and admin panel.
- **Name** - specifies the site name.
- **Unique Code** - specifies a unique site code for lookup using APIs.
- **Theme** - the CMS theme to use when this site is active.
- **Locale** - the application locale used for this site.
- **Timezone** - the timezone to use for this site.
- **Custom application URL** - the URL to use when this site is active, for things like mail templates or when the link policy forces the URL.
- **Use a CMS route prefix** - defines a prefix to include before every page route. It can identify this site when using a shared hostname.
- **Define matching hostnames** - matches the site using specific hostnames. You should enable this for production sites for security reasons. Wildcard values are supported, e.g.: `*.mydomain.tld`.
- **Display a color for this site** - when enabled, displays a banner at the top of the admin panel. Useful to identify the active site or distinguish different environments, for example, red for development, green for staging and no color for production.

When you create more than one site, each can be selected in the admin panel using the site selection dropdown menu.

## Site Picker Component

The `sitePicker` component lets you manage links to other sites. The best place to include this is in your page or layout template.

::: cmstemplate
```ini
[sitePicker]
```
```twig
{% set availableSites = sitePicker.sites %}
```
:::

View the [Site Picker component](../components/sitepicker.md) article to learn how to display site URLs and generating alternative page links.

## Browser Language Detection

October CMS is configured to automatically detect a matching site based on the browser's preferred language when the following conditions are met.

- All sites in the group have a prefix set
- There are no other sites matching the base URL

For example, if the primary site is **English** with a route prefix of `/en` and another site **French** has a prefix of `/fr` then the following behavior can be observed.

Base URL | Behavior
-------- | --------
https://yoursite.tld/en | Displays the **English** site
https://yoursite.tld/fr | Displays the **French** site
https://yoursite.tld | Redirect based on language preference

When the user visits the base URL, their preferred language is automatically detected and will be redirected to a matching site. The matching site is based on its locale value and if no match is found then the primary site is used.

::: tip
You can modify this behavior using the `redirect_policy` value found in the **config/cms.php** file.
:::

## Site Groups

In its initial state, multisite is helpful in creating multiple websites in a single language, or a single website using multiple languages. Grouping sites allow you to extend this concept further to create multiple sites with multiple languages. Create site groups by navigating to **Settings → Manage Sites → Manage Site Groups**, and once a group is created, a group selection field should appear for each site.

In practical terms, each site group represents a website and site definitions belonging to the group represent the site in an alternative language. The following example shows a grouped site configuration for a website about cats and dogs with two languages for each.

Site Group | Site Name
---------- | -----------
Dogs       | English
Dogs       | French
Cats       | English
Cats       | French

Grouped sites will only replicate fields within their specific group. For example, if a [Tailor blueprint](../tailor/introduction.md) uses the `multisite: sync` option, the records will only synchronize across sites in the same group.

## Role Restrictions

Site definitions can restrict their visibility based on the administrator role, which allows you to use dedicated administrator roles to manage a specific sites. To enable the multisite role restrictions feature:

1. Navigate to **Manage Sites** and select a site definition
2. Place check in the **Define administrator roles** checkbox.
3. Select the roles allowed to view the site.
4. Click **Save**.

When enabled, the site will only be visible in the backend panel to administrators that are specified in the field. For example, to create a site that is only accessible to Developers, select the **Developer** role in the field.

## Multisite Features

There are some core features that are not multisite-enabled by default, such as the mail configuration. You may selectively enable multisite features using the **config/multisite.php** file found under the `features` section. The following feature keys are available to use with multiple site definitions.

Feature | Description
------- | --------------------------
`cms_maintenance_setting` | Maintenance Mode Settings are unique for each site
`backend_mail_setting` | Mail Settings are unique for each site
`system_asset_combiner` | Asset combiner cache keys are unique to the site

### Disabling Multisite

You may disable the multisite features entirely by setting the `enabled` configuration to a `false` value.

```php
'enabled' => false
```

## PHP Interface

The [site service](../../extend/services/site.md) includes the global `Site` facade that provides tools for working with multisite. For example, the following code locates a model in the context of the site with ID **2**.

```php
$model = Site::withContext(2, function() {
    return Model::find(1);
});
```

Read the [Site Service article](../../extend/services/site.md) to learn more.

#### See Also

::: also
* [Multisite Features](https://octobercms.com/features/multisite)
* [Theme Localization](../themes/localization.md)
* [Site Picker Component](../components/sitepicker.md)
* [Multisite Trait](../../extend/database/traits.md)
* [Site Service](../../extend/services/site.md)
:::
---
subtitle: Dynamically load content in to a modal window
---
# Modals

Modals can be displayed using the AJAX framework by performing a partial update that targets the modal's content element. When the element has a pending update the `data-ajax-updating` attribute will be attached to it, and this is used to display a loading state while the content loads.

::: tip
In the following examples, we will use the [Modal component](https://getbootstrap.com/docs/5.2/components/modal/) provided by [Bootstrap 5](https://getbootstrap.com).
:::

## Modal Content

The modal content is specified inside the **my-modal-content.htm** partial.

```html
<div class="modal-content">
    <div class="modal-header">
        <h5 class="modal-title">
            Modal Title
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
        <p>Modal body text goes here.</p>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Close
        </button>
        <button type="button" class="btn btn-primary">
            Save changes
        </button>
    </div>
</div>
```

## Modal Trigger

The button to trigger the modal is paired with an AJAX request to request the partial and load the contents in to the element with the ID named `siteModalContent`.

```html
<button
    type="button"
    class="btn btn-primary"
    data-request="onAjax"
    data-request-update="{ 'my-modal-content': '#siteModalContent' }"
    data-bs-toggle="modal"
    data-bs-target="#siteModal">
    Launch demo modal
</button>
```

## Modal Container

The following modal definition is generic and can be added to any page or layout. It contains two `modal-dialog` elements. The first is used as the target container for the partial contents, and the second is used to show a loading state while the request loads.

```html
<div class="modal" id="siteModal">
    <div class="modal-dialog modal-dialog-centered" id="siteModalContent">
        <!-- Partial Contents Will Go Here -->
    </div>

    <div class="modal-dialog modal-dialog-centered modal-loading">
        <div class="spinner-border text-light mx-auto"></div>
    </div>
</div>
```

For the loading status, a stylesheet is used to show the loading dialog during an AJAX request, which is decided by the `data-ajax-updating` attribute. This attribute is added to an element when it is a candidate for a partial update and a request is pending.

```css
.modal-dialog[data-ajax-updating],
.modal-dialog:not([data-ajax-updating]) + .modal-loading {
    display: none;
}
```

#### See Also

::: also
* [Bootstrap 5 Modals](https://getbootstrap.com/docs/5.2/components/modal/)
:::
---
subtitle: Learn how to redirect to another page or URL.
---
# Redirects

In some cases you may wish to redirect the user to a new page after submitting a form, or any AJAX request.

```html
<form data-request="onSignup">
    <div>
        <label>Email</label>
        <input name="email" />
    </div>

    <button data-attach-loading>
        Sign Up
    </button>
</form>
```

Inside your [AJAX handler](../ajax/handlers.md), you may return a `Redirect` [response type](../../extend/services/response-view.md) where the `to` method accepts a relative or absolute URL (first argument).

```php
function onSignup()
{
    return Redirect::to('/signup-complete');
}
```

You may use the `refresh` method to refresh the current page. The use of [flash messages](./flash-messages.md) is also supported.

```php
function onSignup()
{
    Flash::success('Signup complete!');

    return Redirect::refresh();
}
```

## Redirecting to a CMS Page

The `Cms` facade and `redirect` method can be used to redirect to specific CMS page (first argument) and any optional route parameters (second argument).

```php
function onRedirect()
{
    return Cms::redirect('blog/post', ['slug' => 'foobar']);
}
```

You may use the `pageUrl` method to return the URL as a string instead.

```php
$postPage = Cms::pageUrl('blog/post', ['slug' => 'foobar']);
```

## Redirects in Twig

The [`redirect()` Twig function](../../markup/function/redirect.md) can be used to redirect the user from within the page markup.

```php
function onSignup()
{
    $this['success'] = true;
}
```

This function accepts a URL or a CMS page name.

```twig
{% if success %}
    {% do redirect('/signup-complete') %}
{% endif %}
```

## Redirects in AJAX

The [AJAX framework](../ajax/introduction.md) supports redirects with the `data-request-redirect` attribute. The attribute value should specify a URL location to redirect after a successful AJAX request completes.

```html
<button
    data-request="onAjax"
    data-request-redirect="/signup-complete">
    Save and Redirect
</button>
```

The [turbo router](../ajax/turbo-router.md) supports historical redirects with the `data-browser-redirect-back` attribute. The attribute can be attached to any hyperlink or AJAX request element, overriding a redirect response, and only triggers when there is a previous browser history state.

```html
<button
    data-request="onRedirect"
    data-browser-redirect-back>
    Save and Back
</button>
```

The attribute value can also be used on hyperlinks.

```html
<a
    href="/home"
    data-browser-redirect-back>
    Go Back
</a>
```

::: warning
The `data-browser-redirect-back` attribute should be used in combination with a traditional redirect as fallback location.
:::

#### See Also

::: also
* [Redirect Twig function](../../markup/function/redirect.md)
* [Responses and Views](../../extend/services/response-view.md)
:::
---
subtitle: Validate form submissions using the AJAX framework.
---
# Validation

Validating forms checks the user input against a set of predefined rules.

## Performing Validation

To enable validation features, include the `data-request-validate` attribute on a HTML form tag. The following is a minimal example of form validation.

```html
<form data-request="onSubmit" data-request-validate>
    <div>
        <label>Name</label>
        <input name="name" />
    </div>

    <button data-attach-loading>
        Submit
    </button>
</form>
```

Inside your [AJAX handler](../ajax/handlers.md), you may throw a [validation exception](../../extend/system/exceptions.md) using the `ValidationException` class to make a field invalid. The supplied array (first argument) should use field names for the keys and the error messages for the values.

```php
function onSubmit()
{
    if (!post('name')) {
        throw new ValidationException(['name' => 'You must give a name!']);
    }
}
```

When the AJAX framework encounters the `ValidationException`, it will automatically focus the first invalid field and display error messages, if configured.

### Validating a Single Field

In some cases you may want to validate a single field when the value changes. By including the `data-track-input` attribute alongside the `data-request` attribute, the AJAX framework will submit a request when a user types something in to the field.

```html
<form data-request-validate>
    <div>
        <label>Username</label>
        <input name="username" data-request="onCheckUsername" data-track-input />
    </div>
</form>
```

A dedicated AJAX handler can be used to validate the field. If no exception is thrown, it can be considered valid.

```php
function onCheckUsername()
{
    if (true) {
        throw new ValidationException(['username' => 'Username is taken!']);
    }
}
```

## Using the Validation Service

::: aside
View the [Validation article](../../extend/services/validation.md) to learn about the different rules you can use here.
:::

For more complex validation, you may use the `Request` facade to apply rules to the user input in bulk. The `validate` method performs validation using the specified rules (first argument), and returns the attributes and values that were validated as an array. It also throws a `ValidationException` if the validation fails.

```php
function onSubmit()
{
    $data = Request::validate([
        'name' => 'required',
        'email' => 'required|email',
    ]);

    // The code will not reach here if validation fails

    Flash::success('Jobs done!');
}
```

### Custom Error Messages & Attributes

To change the deafult validation messages, you may pass custom messages to the `validate` method. The keys in the messages array (third argument) follow the `attribute.rule` format.

```php
$messages = [
    'email.required' => 'Please type something for the email...',
    'email.email' => 'That email is not an email...!'
];

$data = Request::validate($rules, $messages);
```

If you want to keep the default validation messages, and only change the `:attribute` name used, pass custom attributes as an array (fourth argument).

```php
$attributeNames = [
    'email' => 'e-mail address'
];

$data = Request::validate($rules, [], $attributeNames);
```

## Displaying Error Messages

Inside the form, you may display the first error message by using the `data-validate-error` attribute on a container element. The content inside the container will be set to the error message and the element will be made visible.

```html
<div data-validate-error></div>
```

To display multiple error messages, include an element with the `data-message` attribute. In this example the paragraph tag will be duplicated and set with content for each message that exists.

```html
<div class="alert alert-danger" data-validate-error>
    <p data-message></p>
</div>
```

### Displaying Errors with Fields

If you prefer to show validation messages for individual fields, define an element that uses the `data-validate-for` attribute, passing the field name as the value.

```html
<!-- Input field -->
<input name="phone" />

<!-- Validation message for the field -->
<div data-validate-for="phone"></div>
```

If the element is left empty, it will be populated with the validation text from the server. Otherwise you can specify any text you like and it will be displayed instead.

```html
<div data-validate-for="phone">
    Oops.. phone number is invalid!
</div>
```

### Displaying Errors with Flash Messages

When using validation features in combination with the [`data-request-flash` attribute](./flash-messages.md), the validation errors take priority and suppress the flash message. To display both at the same time, set the attribute to a wildcard (`*`) to display all flash message types, including validation.

```html
<form
    data-request-validate
    data-request-flash="*">
```

## Working with JavaScript

To implement custom functionality for the error messages, hook into the `ajax:invalid-field` event to display the field and `ajax:promise` to reset the form on a new submission. The JavaScript events used are found in the [AJAX JavaScript API](../ajax/javascript-api.md).

```js
addEventListener('ajax:invalid-field', function(event) {
    const { element, fieldName, errorMsg, isFirst } = event.detail;
    element.classList.add('has-error');
});

addEventListener('ajax:promise', function(event) {
    event.target.closest('form').querySelectorAll('.has-error').forEach(function(el) {
        el.classList.remove('has-error');
    });
});
```

## Complete Usage Example

Below is a complete example of form validation. It calls the `onSubmitForm` event handler that triggers a loading submit button, performs validation on the form fields, then displays a successful flash message.

The `data-request-flash` attribute is used to [enable flash messages](./flash-messages.md) for successful messages and display the validation message. The `data-attach-loading` attribute is used to display a [loading indicator](./loaders.md) and prevent double submissions from misclicks.

```html
<form
    data-request="onSubmitForm"
    data-request-validate
    data-request-flash>
    <div>
        <label>Username</label>
        <input name="username"
            data-request="onCheckUsername"
            data-track-input
            data-attach-loading />
        <span data-validate-for="username"></span>
    </div>

    <div>
        <label>Email</label>
        <input name="email" />
        <span data-validate-for="email"></span>
    </div>

    <button data-attach-loading>
        Submit
    </button>

    <div class="alert alert-danger" data-validate-error>
        <p data-message></p>
    </div>
</form>
```

The `onSubmitForm` AJAX event handler looks at the POST data sent by the client and applies some rules to the validator. If the validation fails, a `ValidationException` is thrown, otherwise a `Flash::success` message is returned.

The `onCheckUsername` checks to see if a username is available, currently hard-coded to prevent names **admin** and **jeff** from being entered. It is checked twice, when the user types something in and when the user submits the form.

```php
function onSubmitForm()
{
    $data = Request::validate([
        'username' => 'required',
        'email' => 'required|email',
    ]);

    $this->onCheckUsername();

    Flash::success('Jobs done!');
}

function onCheckUsername()
{
    $username = strtolower(trim(post('username')));
    $isTaken = in_array($username, ['admin', 'jeff']);

    if ($isTaken) {
        throw new ValidationException(['username' => 'Username is taken!']);
    }
}
```

#### See Also

::: also
* [Validation service](../../extend/services/validation.md)
* [Validation trait](../../extend/database/traits.md)
:::
---
subtitle: Display a message about the outcome of a request.
---
# Flash Messages

Flash Messages are a handy way to let the user know the outcome of a request, either as a sucess or failure. Simply use the `Flash` facade to display a message after the request finishes. Flash messages are usually set inside [AJAX handlers](../ajax/handlers.md), inside [Component logic](../../extend/cms-components.md) or inside the page or layout [PHP section](../themes/themes.md).

```php
function onSave()
{
    // Sets a successful message
    Flash::success('Settings successfully saved!');

    // Sets an error message
    Flash::error('Something went wrong...');

    // Sets a warning message
    Flash::warning('Please confirm your email address soon');

    // Sets an informative message
    Flash::info('The export is still processing. Please try again in a minute.');
}
```

Flash messages will disappear after an interval of 3 seconds. Clicking on a flash message will stop it from disappearing.

## Built-in Flash Messages

The AJAX framework has built-in support for flash messages, simply specify the `data-request-flash` attribute on a form to enable the use of flash messages on completed AJAX requests.

```html
<form
    data-request="onSuccess"
    data-request-flash>
    <!-- ... -->
</form>
```

To ensure flash messages are also displayed when the browser is redirected, you should render a [inline flash message](../../markup/tag/flash.md) when the page loads by placing this code in your page or layout.

```twig
{% flash %}
    <p
        data-control="flash-message"
        data-type="{{ type }}"
        data-interval="5">
        {{ message }}
    </p>
{% endflash %}
```

To only display a specific flash message type, you may pass the value to the attribute &mdash; **success**, **error**, **info**, **warning** or **validate**. Multiple values are separated by commas.

```html
<form data-request-flash="success,warning"></form>
```

When using [validation features](./validation.md) in combination with the `data-request-flash` attribute, the validation errors take priority and suppress the flash message. To display both at the same time, include the **validate** type with the attribute.

```html
<form
    data-request-validate
    data-request-flash="success,error,validate">
```

### Loading Flash Message

The `data-request-message` attribute can be used to display a flash progress message while the request runs. This is great particularly for long running processes.

```html
<button
    data-request="onSubmit"
    data-request-message="Please wait while we process your request...">
    Submit
</button>
```

### Styling the Flash Message

To change the appearance of the flash message, target the `.oc-flash-message` CSS class.

```css
.oc-flash-message.success {
    background: green;
}
.oc-flash-message.error {
    background: red;
}
.oc-flash-message.warning {
    background: orange;
}
.oc-flash-message.info {
    background: aqua;
}
.oc-flash-message.loading {
    background: aqua;
}
```

## Custom Flash Messages

::: aside
See the [Flash Twig Tag article](../../markup/tag/flash.md) to learn more about the `{% flash %}` tag.
:::

To display inline flash messages or completely change the default flash message markup, create a new partial in your theme with the custom content. For example, create a new partial named **flash-messages.htm** and paste in the following content.

```twig
{% flash %}
    <div class="alert alert-{{ type }}">
        {{ message }}
    </div>
{% endflash %}
```

Next, include the partial in your form as [a self-updating partial](../../markup/tag/ajax-partial.md) using the `{% ajaxPartial %}` tag. Referencing the partial name in `data-request-update` will automatically update this partial and disable the in-built flash messages.

```twig
<form>
    {% ajaxPartial 'flash-messages' %}

    <label>Title</label>
    <input name="title" />

    <button
        data-request="onSave"
        data-request-update="{ flash-messages: true }">
        Save
    </button>
</form>
```

Alternatively, you can include the partial inside a layout, and update it globally instead of adding the `data-request-flash` every element. Add the `ajax-request-update` meta tag in the head section of the page, and set the content attribute to [update the partial globally](../ajax/update-partials.md).

```html
<head>
    <meta name="ajax-request-update" content="{ flash-messages: true }" />
</head>
<body>
    <!-- Updates with every AJAX request -->
    {% ajaxPartial 'flash-messages' %}
</body>
```

## Working with JavaScript

Use the `oc.flashMsg` function to display a flash message using JavaScript. A type can be specified as either `success`, `error` or `warning`. An optional `interval` can be specified to control how long the flash message is displayed in seconds.

```js
oc.flashMsg({
    message: 'Record has been successfully saved. This message will disappear in 1 second.',
    type: 'success',
    interval: 1
});
```

#### See Also

::: also
* [Flash Twig Tag](../../markup/tag/flash.md)
:::
---
subtitle: Learn how to display pagination links.
---
# Pagination

October CMS includes pagination features out of the box, it integrates with standard templates and offers complete flexibility for custom markup. Paginated records are integrated closely with [model pagination queries](../../extend/database/pagination.md) and the [`pager()` Twig function](../../markup/function/pager.md).

## Paginating Data

A paginated set of data can come from [Component logic](../../extend/cms-components.md), inside the page or layout [PHP section](../themes/themes.md), or from [a Tailor component](../tailor/components.md). The following is an example of a page requesting paginated data from a Tailor component, stepping through the records at **10** per page.

::: cmstemplate
```ini
url = "/blog"

[collection]
handle = "Blog\Post"
```
```twig
{% set posts = collection.paginate(10) %}
```
:::

Now the `posts` variable is available. We can loop through each record and display the pagination links.

```twig
<div>
    {% for post in posts %}
        <h2>{{ post.title }}</h2>
    {% endfor %}
</div>

<nav>
    {{ pager(posts) }}
</nav>
```

### Multiple Pagination Instances

By default the pagination will take the current page number from the `?page` query string, so the same page number will be used when displaying two or more sets of paginated data. To solve this problem, use the `paginateCustom` method and specify a unique parameter name.

::: cmstemplate
```ini
url = "/blog"

[collection blog]
handle = "Blog\Post"

[collection category]
handle = "Blog\Category"
```
```twig
{% set posts = blog.paginateCustom(10, 'postPage') %}

{% set comments = comments.paginateCustom(10, 'commentPage') %}
```
:::

Set the `withQuery` option to preserve the page number for other pagination instances (optional).

```twig
{{ pager(categories, { withQuery: true }) }}
```

This results in the query string containing both page numbers, for example,<br>`?postPage=1&commentPage=2`.

### Using Custom Pagination Markup

To use custom pagination markup, start with the file locations below and copy the contents to a partial inside your theme.

Template | Detail
------------- | -------------
`default` | Renders the default pagination template.<br>Location: `~/modules/system/views/pagination/default.htm`
`simple` | Renders pagination with only next and previous buttons.<br>Location: `~/modules/system/views/pagination/simple.htm`
`ajax` | Renders AJAX paginated records.<br>Location: `~/modules/system/views/pagination/ajax.htm`

Then render as a partial by passing the `partial` option to the pager.

```twig
{{ pager(records, { partial: 'my-custom-pagination' }) }}
```

## AJAX Pagination

Use the `ajaxPager()` Twig function to update paginated records dynamically using AJAX. The partial should display the records and include the pager inside, for example, a partial named **latest-posts.htm** with the following contents.

```twig
<div>
    {% for post in posts %}
        <h2>{{ post.title }}</h2>
    {% endfor %}
</div>

<nav>
    {{ ajaxPager(posts) }}
</nav>
```

Then render the partial on the page using the [`{% ajaxPartial %}` Twig tag](../../markup/tag/ajax-partial.md).

::: cmstemplate
```ini
url = "/blog"

[collection blog]
handle = "Blog\Post"
```
```twig
{% set posts = blog.paginate(10) %}

<h3>Latest Posts</h3>
{% ajaxPartial 'latest-posts' %}
```
:::

Alternatively, you can encapsulate all the logic inside the partial to make it completely portable.

::: cmstemplate
```ini
[collection blog]
handle = "Blog\Post"
```
```twig
{% set posts = blog.paginate(10) %}

<div>
    {% for post in posts %}
        <h2>{{ post.title }}</h2>
    {% endfor %}
</div>

<nav>
    {{ ajaxPager(posts) }}
</nav>
```
:::

The partial can then be rendered anywhere on a page or layout without any additional configuration.

::: cmstemplate
```ini
url = "/blog"
```
```twig
{% ajaxPartial 'latest-posts' %}
```
:::

## Load More Pagination

A load more button, sometimes called an infinite loader, is a method of displaying records in a stack instead of across multiple pages.

This approach uses an AJAX partial to append the new content along with a self-destructing button. For example, a partial named **load-more-posts.htm** with the following contents.

```twig
{% set posts = blog.paginate(10) %}

<div>
    {% for post in posts %}
        <h2>{{ post.title }}</h2>
    {% endfor %}
</div>

{% if posts.hasMorePages %}
    <button
        data-request="onAjax"
        data-request-update="{ _self: '@' }"
        data-request-success="this.remove()"
        data-request-data="{ page: {{ posts.currentPage + 1 }} }"
        data-attach-loading>
        Load More
    </button>
{% endif %}
```

The button element leverages a combination of AJAX data attributes to perform [a self-update in append mode](../ajax/update-partials.md), passing the next page number as data and removing itself upon completion.

The partial should be rendered using  [`{% ajaxPartial %}` Twig tag](../../markup/tag/ajax-partial.md).

::: cmstemplate
```ini
url = "/blog"
```
```twig
{% ajaxPartial 'load-more-posts' %}
```
:::

#### See Also

::: also
* [Model Pagination](../../extend/database/pagination.md)
* [Pager Twig function](../../markup/function/pager.md)
:::
---
subtitle: Used for lazy loading and repeating updates.
---
# Polling

Polling is a technique used to defer or repeat an AJAX update by including the `data-auto-submit` attribute on a request element. This feature should be used sparingly since it can increase server load at scale, and to mitigate this, the attribute only triggers when the user's browser window is active.

## Lazy Loading Requests

Lazy loading defers the display of content until after the page has loaded. This is useful for heavy operations that may slow down the initial page load. Add the `lazy` attribute to the `{% ajaxPartial %}` tag.

In the following example, the **posts** partial will be updated after the page has finished loading.

```twig
{% ajaxPartial 'posts' lazy %}
```

This outputs a partial with initial content that includes a `data-auto-submit` data attribute, which performs the AJAX request to update itself after the page loads. The attribute is not included in subsequent requests.

```html
<div
    data-request="onAjax"
    data-request-update="{ _self: true }"
    data-auto-submit></div>
```

When using the `lazy body` attributes, you can specify the initial content to display while the content is loading. Followed by the `{% endpartial %}` tag.

```twig
{% ajaxPartial 'posts' lazy body %}
    <p>Loading posts...</p>
{% endpartial %}
```

## Polling Requests

For repeated requests to update content, you can set the `data-auto-submit` to a value (in milliseconds) to perform an automatic request after a delay. For example, a partial rendered with `{% ajaxPartial %}` and contains the following markup.

```twig
<div>
    {% set launchDate = carbon('2025-01-01') %}
    {% set days = launchDate.diffInDays %}
    {% set hours = launchDate.subDays(days).diffInHours %}
    {% set minutes = launchDate.subHours(hours).diffInMinutes %}
    {% set seconds = launchDate.subMinutes(minutes).diffInSeconds %}

    <h2>
        Launch in...
        {{ days }} days,
        {{ hours }} hours,
        {{ minutes }} minutes,
        {{ seconds }} seconds
    </h2>
</div>

<div
    data-request="onAjax"
    data-request-update="{ _self: true }"
    data-auto-submit="2000"></div>
```

This partial displays a countdown timer and includes a "div" element to automatically update itself. The resulting update also contains the element, so the request is repeated continuously every 2 seconds.

The polling can be stopped by not including the element in subsequent requests, for example the following would stop polling if the `launchDone` variable is set to true.

```twig
{% if not launchDone %}
    <div
        data-request="onAjax"
        data-request-update="{ _self: true }"
        data-auto-submit="2000"></div>
{% endif %}
```
---
subtitle: Easily handle uploading files.
---
# File Uploads

October CMS provides simple features for uploading files through form submissions. The feature is opt-in to the AJAX framework for the best performance.

## Uploading Files

To enable file uploads on a form, include the `data-request-files` attribute on a HTML form tag. The following is a minimal example uploading a file.

```html
<form data-request="onUploadFiles" data-request-files>
    <div>
        <label>Single File</label>
        <input name="single_file" type="file">
    </div>

    <button data-attach-loading>
        Upload
    </button>
</form>
```

::: aside
View the [request and input article](../../extend/services/request-input.md) to learn more about the available methods on the `files()` function.
:::

Inside your [AJAX handler](../ajax/handlers.md), use the `files()` helper function to access the uploaded file, and call the `store` method to save the file to [a storage disk](../../extend/services/storage.md). The resulting value is the local file path to the saved file.

The following stores the upload in the **storage/app/userfiles** directory using a generated file name.

```php
function onUploadFiles()
{
    $filePath = files('single_file')->store('userfiles');

    // ...

    Flash::success('File saved');
}
```

### Uploading Multiple Files

When the `multiple` attribute is included with the file input, the `files()` helper will return an array instead.

```html
<div>
    <label>Multi File</label>
    <input name="multi_file[]" type="file" multiple>
</div>
```

```php
function onUploadFiles()
{
    $filePaths = [];

    foreach (files('multi_file') as $file) {
        $filePaths[] = $file->store('userfiles');
    }

    // ...

    Flash::success('File saved');
}
```

### Validating File Uploads

Just like [regular form validation](./validation.md), files can be validated using the `Request` facade and `validate` method. Use the `.*` suffix when validating multiple items. The following checks that the uploaded file is an image and not greater than 1MB in size.

```php
function onUploadFiles()
{
    Request::validate([
        'single_file' => 'required|image|max:1024',
        'multi_file.*' => 'required|image|max:1024',
    ]);

    Flash::success('Files are valid!');
}
```

## Uploading to Models

When working with models that are configured to use [file attachments](../../extend/database/attachments.md), including Tailor models that use the [File upload widget](../../element/form/widget-fileupload.md), you save file uploads directly on the model.

The simplest approach is to set the attribute on the model directly using the `files()` helper. This supports singular and multiple file uploads.

```php
function onUploadFiles()
{
    $model = new MyModel;

    $model->avatar = files('single_file');

    $model->save();

    // ...

    Flash::success('File saved');
}
```

You may also set the attribute to a `System\Models\File` model object directly for various use cases.

```php
$model->avatar = (new File)->fromFile('/path/to/somefile.jpg');

$model->avatar = (new File)->fromData('Some content', 'sometext.txt');

$model->avatar = (new File)->fromUrl('https://example.tld/path/to/avatar.jpg');
```

See the [file attachments article](../../extend/database/attachments.md) to learn more about working with model-based file attachments.

#### See Also

::: also
* [Requests and Input](../../extend/services/request-input.md)
* [Storage Disks](../../extend/services/storage.md)
* [File Attachments](../../extend/database/attachments.md)
:::
---
subtitle: Easily handle downloading files.
---
# File Downloads

October CMS provides simple features for downloading files in responses. The feature is opt-in to the AJAX framework for the best performance.

## Download Buttons

To enable file downloads, include the `data-request-download` attribute on a HTML form or button tag. The following is a minimal example of downloading a file.

```html
<button data-request="onExport" data-request-download>
    Download
</button>
```

If the `data-request-download="..."` attribute is set on the request trigger, the filename in this attribute will be given to the downloaded file. The following produces a file named **data.csv**.

```html
<button data-request="onExport" data-request-download="data.csv">
    Download Document
</button>
```

To open the file in a new browser window, typically used for previewing PDFs, set the `data-browser-target` attribute to `_blank`.

```html
<button data-request="onExport" data-request-download data-browser-target="_blank">
    Open in New Window
</button>
```

::: tip
When the download attribute is used, the response can be a download or a [regular AJAX update](../ajax/update-partials.md).
:::

## Download Responses

Inside your [AJAX handler](../ajax/handlers.md), you may return a [file download](../../extend/services/response-view.md) `Response` type where the `download` method accepts the local disk file path.

```php
public function onExport()
{
    return Response::download(base_path('app/files/installer.zip'));
}
```

To convert a string to a downloadable response without having to write the contents to disk, use the `streamDownload` method, which accepts a callback (first argument) and filename (second argument).

```php
public function onExport()
{
    return Response::streamDownload(function() {
        echo 'CSV Contents...';
    }, 'export.csv');
}
```

You may also use the [storage service](../../extend/services/storage.md) to download files from the media library or any storage engine. Use the `Storage` facade and `disk` method to specify the disk name (first argument), then chain the `download` method with the file name to download (first argument).

```php
public function onExport()
{
    return Storage::disk('media')->download('archive.zip');
}
```

When working with [model file attachments](../../extend/database/attachments.md), you may call the `download` method on the file object.

```php
public function onDownload()
{
    // ...

    return $model->avatar->download();
}
```


## Usage Example

The following example shows a CMS page that can be used to download a [model file attachment](../../extend/database/attachments.md) with a custom file name. It takes the attachment `id` and `disk_name` parameters to validate the file, before returning the response to the browser with a custom file name taken from the `file_name` parameter (optional).

::: cmstemplate
```ini
## pages/download-file.htm

title = "Download File"
url = "/download-file/:id/:disk_name/:file_name?"
layout = "default"
```
```php
function onStart()
{
    $file = System\Models\File::find($this->param('id'));
    if (!$file || !$file->isPublic()) {
        throw new NotFoundException;
    }

    if ($file->disk_name !== $this->param('disk_name')) {
        throw new NotFoundException;
    }

    $customFileName = $this->param('file_name');
    if ($customFileName) {
        $file->file_name = $customFileName;
    }

    return $file->download();
}
```
```twig
```
:::

You may then link to this page in Twig with the following markup, where the `file` variable is an instance of `System\Models\File`.

```twig
{{ 'download-file'|page({
    id: file.id,
    disk_name: file.disk_name,
    file_name: 'my-custom-name.png'
}) }}
```

::: tip
If you intend to display the file inline, as an image for example, call the `$file->output()` method instead.
:::

#### See Also

::: also
* [Responses and Views](../../extend/services/response-view.md)
:::
---
subtitle: Indicate that the page is currently loading.
---
# Loading Indicators

When the AJAX framework makes a request to the server, it is a good idea to display a loading indicator since the page may not update immediately. There are several approaches and standard loading indicators to make it clear when an AJAX request has been triggered and is in progress.

## Progress Bar

A prominent feature of the AJAX framework is a progress bar that is displayed on the top of the page when an AJAX request runs. The progress bar listens for an AJAX request and will appear when a request takes longer than 300ms and hides again when the request is complete.

To disable the progress bar for a request, set the `data-request-progress-bar` attribute to `false`.

```html
<button
    data-request="onDoSomething"
    data-request-progress-bar="false">
    Do something
</button>
```

In JavaScript, set the `progressBar` option of an AJAX request to `false`.

```js
oc.ajax('onSilentRequest', { progressBar: false });
```

To disable the progress bar globally, set the `visibility` style to `hidden` using a StyleSheet.

```css
.oc-progress-bar {
    visibility: hidden;
}
```

You may display the progress bar using JavaScript using the `oc.progressBar` object and `show` / `hide` functions.

```js
oc.progressBar.show();

oc.progressBar.hide();
```

## Loading Button

When submitting forms, users can accidentally click the button twice and cause a double submission, and this is solved using a loading button. During AJAX requests, button elements that have the `data-attach-loading` attribute will be disabled, and a CSS class `oc-attach-loader` added. This class will spawn a loading spinner on button and anchor elements using the `:after` CSS selector.

```html
<a href="#"
    data-request="onDoSomething"
    data-attach-loading>
    Do Something
</a>
```

When a button exists inside a form that contain the `oc-attach-loader` attribute will display the loading indicator.

```html
<form data-request="onSubmit">
    <button data-attach-loading>
        Submit
    </button>
</form>
```

Since inputs do not support the `:after` CSS selector, they have a new element inserted after them instead. The element is removed once the AJAX request is complete. This is useful when working with the `data-track-input` attribute that watches the input for changes and submits the AJAX request.

```html
<input name="username"
    data-request="onCheckUsername"
    data-track-input
    data-attach-loading />
```

You can manually add the loader to a button using the `oc.attachLoader` object and `show` / `hide` functions passing the element selector or object as the first argument.

```js
oc.attachLoader.show('.my-element');

oc.attachLoader.hide('.my-element');
```

## Toggling Elements

You can use the `data-request-loading` attribute to make an element visible during an AJAX request. The value is a CSS selector that uses display `block` and `none` attributes to manage the element visibility.

```html
<button
    data-request="onPay"
    data-request-loading=".is-loading">
    Pay Now
</button>

<div style="display:none" class="is-loading">
    Processing Payment...
</div>
```

### Detecting Global Requests

You can detect when a global AJAX request is in progress by checking the `data-ajax-progress` attribute on the HTML element. Expressed in a StyleSheet as the following.

```css
html[data-ajax-progress] {
    /* Display loading indicators */
}
```

The attribute is also added to form elements.

```css
form[data-ajax-progress] {
    /* The form is loading */
}
```

### Targeting Specific Handlers

In some cases you may want to show a loading indicator for a specific [AJAX handler event](../ajax/handlers.md), the `data-ajax-progress` attribute will contain the most recent handler name, and this can be used to target a specific request.

```html
<form>
    <button data-request="onPay">Pay Now</button>
    <button data-request="onCancel">Cancel</button>

    <div class="is-payment-loading">
        Processing Payment...
    </div>
</form>
```

This can be targeted using a StyleSheet attribute value selector.

```css
.is-payment-loading {
    display: none;
}

form[data-ajax-progress=onPay] .is-payment-loading {
    display: block;
}
```

## Working with JavaScript

For more complex scenarios, you can hook in to the [AJAX JavaScript API](../ajax/javascript-api.md) using the `ajax:promise` and `ajax:always` events. These events can be attached to the document, form or target elements.

```js
formElement.addEventListener('ajax:promise', function() {
    // A new request has started
});

formElement.addEventListener('ajax:always', function() {
    // A request has ended
});
```

The following example will disable all inputs inside a form while the request is running.

```js
addEventListener('ajax:promise', function(event) {
    event.target.closest('form').querySelectorAll('input').forEach(function(el) {
        el.disabled = true;
    });
});

addEventListener('ajax:always', function() {
    event.target.closest('form').querySelectorAll('input').forEach(function(el) {
        el.disabled = false;
    });
});
```
# Tailor Components

This page has moved to a new section. Redirecting...

<Redirect to="../components/section" />
---
subtitle: Tailor website content to your exact requirements.
---
# Introduction

<VideoBlockLink src="https://www.youtube.com/watch?v=_WMH4mlMdjk" title="Tailor Tutorial" description="This video describes how to quickly create a complete blog solution with Tailor." prompt="Watch the tutorial" />

Tailor is a feature that defines file-based content structures used by your website, such as a company blog or team page. Tailor automatically generates a backend user interface for managing records and provides CMS Components for displaying and linking records on the frontend.

When using Tailor you can skip the traditional plugin development workflow and go straight to defining content. Fields are defined simply as blueprint templates and content is stored in special database tables. The blueprint template can also specify navigation and other modifiers.

## Directory Structure

Blueprints are YAML files that reside in the **app/blueprints** directory by default.
Below you can see an example blueprint directory structure. Each blueprint can reside in any directory and any file name can be used. Blueprints can be organised in subdirectories of any nesting depth.

::: dir
├── app
|   └── `blueprints`  _← Blueprints Start Here_
|       ├── blog
|       │   └── blog.yaml
|       │   └── author.yaml
|       ├── about
|       │   └── about.yaml
|       ├── wiki
|       │   └── article.yaml
:::

## Blueprint Types

The blueprint **type** property determines how the blueprint should be implemented. There are several types available and most blueprints will specify [form field definitions](../../element/form-fields.md).

Type | Description
------------- | -------------
Entry | the standard content structure that supports drafts.
Global | a single record in the database and is often used for settings and configuration.
Mixin | defines reusable field definitions that can be imported and mixed in with other field definitions.

Each blueprint type is described in more detail in the [Blueprints article](./blueprints.md).

## Blueprint Structure

::: aside
Blueprints are 100% portable. They use internal identifiers and can reside in any directory with any file name.
:::

Blueprints are defined using the YAML syntax and will always contain three identifiers, a unique UUID, a user-friendly handle and the blueprint type. The filename and folder of a blueprint is used to organise blueprints and is not used as an identifier. All other properties are defined in the blueprint's relevant documentation article.

```yaml
uuid: edcd102e-0525-4e4d-b07e-633ae6c18db6
handle: Blog\Post
type: entry
name: Post

fields:
    # [...]
```

The blueprint **handle** is a human-readable approach to referencing a blueprint object. Using the above blueprint as a reference, we can reference the entries using the handle.

::: tip
Handles follow a similar naming convention to PHP namespaces and can be organised with the backslash `\` separator.
:::

```ini
[section blog]
handle = "Blog\Post"
```

The blueprint **uuid** is a unique identifier used when blueprints reference other blueprints. For example, when a field references a mixin. When first creating a blueprint, you can choose to not include a UUID and one will be magically created for you on the first migration.

```yaml
_blog_content:
    source: edcd102e-0525-4e4d-b07e-633ae6c18db6
    type: mixin
```

## Integration with Multisite

Blueprints do not use [multisite capabilities](../resources/multisite.md) by default. You may use the `multisite` property to enable this. When enabled, records can be unique to each configured site.

```yaml
handle: Blog\Post
type: entry
# ...
multisite: true
```

When multisite is enabled, all fields in the blueprint become translatable. To keep the same value for a field, set the `translatable` property to false. In this example, when saving the record the **name** field will be copied to every site when it is saved.

```yaml
# ...
multisite: true

fields:
    name:
        label: Full Name
        type: text
        translatable: false
```

You may also set the value to **sync** to keep the records synchronized across sites, which is helpful for categories and tags. When using sync, each record will always exist on every site, although the content can be different.

```yaml
multisite: sync
```

When using [Site Groups](../resources/multisite.md), the records will be propagated to all sites within that group. This can be changed by setting the `multisite` property to **all** to sync within all sites.

```yaml
multisite: all
```

Setting to **locale** will sync the records to all sites that share the same locale.

```yaml
multisite: locale
```

## Migrating Blueprints

Blueprints and their structure are migrated in the database during the normal database migration process. When a change is made manually to a blueprint file, you should run the `tailor:migrate` command to update the database tables.

```bash
php artisan tailor:migrate
```

::: tip
Blueprints are cached when debug mode is turned off. The migration command can also be used to clear the blueprint cache.
:::

### Refreshing Content

You may delete all the content managed by Tailor using the `tailor:refresh` command.

```bash
php artisan tailor:refresh
```

To refresh a single blueprint use the `--blueprint` option and specify its handle.

```bash
php artisan tailor:refresh --blueprint="Blog\Post"
```

### Propagating Content

When using the **sync** option for multisite, you may retroactively propagate records using the `tailor:propagate` command.

```bash
php artisan tailor:propagate
```

To propagate a single blueprint use the `--blueprint` option and specify its handle.

```bash
php artisan tailor:propagate --blueprint="Blog\Category"
```

### Pruning Content

As a general rule Tailor will never drop table columns and delete content. If a field is removed, the column will be renamed instead of dropped. For example, an old field named `content` may appear as `x_content_fb418fac` in the database table. Tables for old blueprints are also kept in case they are ever restored.

You may prune unused database columns with the `tailor:prune` command. This command will also drop tables that no longer have an associated blueprint.

```bash
php artisan tailor:prune
```

You may only prune fields using the `--fields` modifier. To only prune tables, use the `--tables` modifier.

```bash
php artisan tailor:prune --fields
php artisan tailor:prune --tables
```

To prune a single blueprint use the `--blueprint` option and specify its handle.

```bash
php artisan tailor:prune --blueprint="Blog\Post"
```
---
subtitle: The menu items for managing the content in the admin panel.
---
# Defining Navigation

In the backend area, entries will be listed under the Content menu item with globals listed under the Settings menu item (by default). You may control this behavior using the **navigation** property in the blueprint file. The following code will set an icon and specify the order of appearance.

```yaml
navigation:
    icon: icon-pencil
    order: 200
```

The following properties are supported by the `navigation` and `primaryNavigation` definition.

Property | Description
------------- | -------------
**label** | specifies the menu label localization string key, required.
**order** | a numerical weight when determining the display order.
**parent** | links the navigation item to a parent item using a blueprint handle.
**icon** | an icon name from the [October CMS icon collection](../../element/available-icons.md), optional.
**iconSvg** | an SVG icon to be used in place of the standard icon, the SVG icon should be a rectangle and can support colors, optional.

To place an item in the Settings area, set the **parent** to `settings`. The **category** definition can be a string or a settings constant reference, eg. `CATEGORY_COLLECTIONS`.

```yaml
navigation:
    parent: settings
    category: Collections
```

To place an item in the Content area, set the **parent** to `content`.

```yaml
navigation:
    parent: content
```

To place the item as a primary navigation item. A **primaryNavigation** definition is needed.

```yaml
primaryNavigation:
    label: Blog
    icon: icon-copy
    order: 500

navigation:
    label: Main Menu Item
```

To place the item as a secondary navigation item. The **parent** property should specify the UUID or handle of a primary navigation item.

```yaml
navigation:
    parent: <handle|uuid>
```

To disable the secondary navigation, define the **primaryNavigation** for a single blueprint without it being a parent for any other blueprints.

```yaml
primaryNavigation:
    label: Page
    icon: icon-magic
    order: 500
```

You may also completely disable the navigation by setting the **navigation** property to `false`.

```yaml
navigation: false
```

## Extra Navigation

Use the `extraNavigation` property to register custom navigation items to include with the blueprint. The value is an array matching the `sideMenu` definition found in the [backend navigation specification](../../extend/backend/navigation.md). The following example includes two a section and divider using custom display types, the `order` property is used to align the items in the correct order.

```yaml
navigation:
    label: Authors
    parent: Blog\Post
    icon: icon-user
    order: 230

extraNavigation:
    _authors_section:
        itemType: section
        label: Authors
        order: 210

    _authors_ruler:
        itemType: ruler
        order: 220
```

#### See Also

::: also
* [Backend Navigation](../../extend/backend/navigation.md)
:::
---
subtitle: The available models provided by Tailor.
---
# Models

This article describes how to interact with Tailor using PHP and the available models.

## Entry Record

The `Tailor\Models\EntryRecord` model is used to store content for an entry.

### Available Attributes

In addition to your defined form fields, the following attributes can be found on the retrieved model.

Attribute | Description
-------- | -------------
**id** | The Primary Key found in the database.
**blueprint_uuid** | The UUID of the associated blueprint.
**content_group** | The content group name, if used.
**title** | A title descriptor for the entry, for example, **My Blog Post**.
**slug** | A slug identifier for the entry, for example, `my-blog-post`.
**is_enabled** | Determines if the entry is currently visible.
**created_at** | The creation date for the entry.
**updated_at** | The last updated date for the entry.
**expired_at** | The expiry date for the entry.
**published_at** | The published date for the entry.
**published_at_date** | The published date, or if none is specified, the creation date.

#### Structure Entries

If an entry type is a `structure`, it will have some extra attributes.

Attribute | Description
-------- | -------------
**fullslug** | A slug identifier that includes parent slugs, for example, `parent-slug/child-slug`.
**parent** | The parent record for this entry, if available.
**children** | The child records for this entry, if available.

#### Stream Entries

If an entry type is a `stream`, it will have some extra attributes.

Attribute | Description
-------- | -------------
**published_at_day** | The numerical day the entry was published.
**published_at_month** | The numerical month the entry was published.
**published_at_year** | The numerical year the entry was published.

### Retrieving Multiple Entries

To work with an entry using PHP, you may use the `Tailor\Models\EntryRecord` model and call the `inSection` static method, passing the handle to return a prepared [database model query](../../extend/database/query.md). Alternatively, you can look it up using the UUID and the `inSectionUuid` method.

The following `get` method query returns [a collection of records](../../extend/services/collection.md).

```php
$records = EntryRecord::inSection('Blog\Post')->get();

$records = EntryRecord::inSectionUuid('a63fabaf-7c0b-4c74-b36f-7abf1a3ad1c1')->get();
```

### Retrieving a Single Entry

Combined with the `where` constraint, you may find a single record with the `first` method. The following will find an entry where the slug is equal to **first-post**.

```php
$record = EntryRecord::inSection('Blog\Post')->where('slug', 'first-post')->first();
```

If an [entry type](../tailor/blueprints.md) is set to `single`, you can use the `findSingleForSection` method to look up the entry. Likewise, the `findSingleForSectionUuid` can be used for looking up by the UUID. These methods will ensure a record exists during lookup.

```php
$record = EntryRecord::findSingleForSection('Homepage');

$record = EntryRecord::findSingleForSectionUuid('3328c303-7989-462e-b866-27e7037ba275');
```

### Inserting & Updating Entries

The `inSection` method can be used to create records dynamically. The following will create a new blog post entry. The same code can be used to update an existing record after retrieving it first.

```php
$post = EntryRecord::inSection('Blog\Post');
$post->title = 'Imported Post';
$post->save();
```

## Global Record

The `Tailor\Models\GlobalRecord` model is used to store content for a global.

### Available Attributes

In addition to the defined form fields, the following attributes can be found on the retrieved model.

Attribute | Description
-------- | -------------
**id** | The Primary Key found in the database.
**blueprint_uuid** | The UUID of the associated blueprint.

### Retrieving a Global Record

To look up a global using PHP, you may use the `Tailor\Models\GlobalRecord` model and call the `findForGlobal` static method, passing the handle. Alternatively, you can look it up using the UUID and the `findForGlobalUuid` method.

```php
GlobalRecord::findForGlobal('Blog\Config');

GlobalRecord::findForGlobalUuid('7b193500-ac0b-481f-a79c-2a362646364d');
```

## Working With Related Fields

Related fields can include [repeater fields](../../element/form/widget-repeater.md) and [entries fields](../../element/content/field-entries.md), and there are some extra steps needed to read and write to these fields.

### Eager Loading Relations

When reading related fields, you can eager load them on the collection using the `load` method. This method makes the related content available as a single query and is best for performance.

The following eager loads the **categories** field and adds it to the result, along with an example of passing multiple related fields.

```php
$records->load('categories');

$records->load(['categories', 'author']);
```

### Creating Related Fields

When writing related fields, you can call the relation name as a method to return the relationship definition, then a subsequent `create()` method can be called, which returns the newly created relation.

The following locates the first blog post in the **Blog\Post** section and then creates an associated category.

```php
$post = EntryRecord::inSection('Blog\Post')->first();

$post->categories()->create(['title' => 'Test', 'price' => '100']);
```

Use the `make()` method to create a new empty model instance.

```php
$category = $post->categories()->make();
```

If the category already exists, use the `add()` method instead. The following adds the first blog category to the first blog post.

```php
$post = EntryRecord::inSection('Blog\Post')->first();
$category = EntryRecord::inSection('Blog\Category')->first();

$post->categories()->add($category);
```

::: tip
View the [relations article](../../extend/database/relations.md) to learn more about model relationships.
:::

## Extending Model Constructors

Similar to [extending regular models](../../extend/extending.md), you may extend the `EntryRecord` model constructor using the `extendInSection` method to target a specific blueprint. The `extendInSectionUuid` method can also be used for more precise targeting.

```php
EntryRecord::extendInSection('Blog\Post', function($model) {
    $model->bindEvent('model.afterDelete', function () use ($model) {
        // Model has been deleted!
    });
});
```

The `GlobalRecord` model constructor also supports extension using the `extendInGlobal` and `extendInGlobalUuid` methods to target a specific blueprint.

```php
GlobalRecord::extendInGlobal('Blog\Config', function($model) {
    $model->bindEvent('model.beforeSave', function () use ($model) {
        // Model has been saved!
    });
});
```

::: tip
The `extendInSectionUuid` and `extendInGlobalUuid` methods will not throw an exception if the blueprint is not found.
:::

## Extending Tailor Models

In some cases you may want to combine tailor models with [regular database models](../../extend/system/models.md).

### Associating Tailor to Regular Models

The `recordfinder` form field introduces a relation definition to a regular model, for example a model defined by a plugin. The **modelClass** should refer to the model class and the **list** property is required for singular relations, as specified by **maxItems**.

```yaml
products:
    label: Products
    type: recordfinder
    modelClass: Acme\Test\Models\Product
    list: $/acme/test/models/product/columns.yaml
    maxItems: 1
```

Learn more about the [record finder form widget here](../../element/form/widget-recordfinder.md).

### Associating Regular Models to Tailor

Since all tailor models share the same model class, some additional attributes are needed in your relationship definitions. The `Tailor\Traits\BlueprintRelationModel` implements these attributes to reference tailor models, supporting Belongs To and Belongs To Many relationships.

When the trait `BlueprintRelationModel` is implemented in your models, you can supply a `blueprint` property along with the blueprint UUID referencing the tailor blueprint. The following will establish a Belongs To relationship to the `Tailor\Models\EntryRecord` class called **author**.

```php
class Product extends Model
{
    use \Tailor\Traits\BlueprintRelationModel;

    public $belongsTo = [
        'author' => [
            \Tailor\Models\EntryRecord::class,
            'blueprint' => '6947ff28-b660-47d7-9240-24ca6d58aeae'
        ]
    ];
}
```

### Building a Custom Content Field

You may also make reference to a regular model using a implementation specific field type, for example, a customer content field may be hard coded to a `Customer` model class. This involves creating a custom tailor field that will give complete access to the model and database tables.

Inside the content field class definition, the `extendModelObject` method allows the content field to extend the record model, along with `extendDatabaseTable` to add a column to the database table.

```php
class MyContentField extends ContentFieldBase
{
    public function extendModelObject($model)
    {
        $model->belongsTo[$this->fieldName] = MyOtherModel::class;
    }

    public function extendDatabaseTable($table)
    {
        $table->integer($this->fieldName . '_id')->nullable();
    }
}
```

This requires a little more effort to get things working, but the results are a simple field **type** definition with minimal configuration.

```yaml
myfield:
    label: My Field
    type: mycontentfield
```

Learn more about building [custom tailor fields here](../../extend/tailor-fields.md).

#### See Also

::: also
* [RecordFinder Form Field](../../element/form/widget-recordfinder.md)
* [Building Tailor Fields](../../extend/tailor-fields.md)
:::
---
subtitle: Get started by defining form fields for your content.
---
# Content Fields

::: aside
You may build custom content fields by [extending tailor](../../extend/tailor-fields.md).
:::

Content Fields are the cornerstone of the Tailor module and define how a field should be configured and displayed. These definitions are often found under the **fields** property of a blueprint.

```yaml
fields:
    name:
        label: Full Name
        type: text
```

::: tip
A complete list of available fields can be found in the [Backend Elements section](../../element/form-fields.md).
:::

For each field you can specify these common properties, where applicable.

Property | Description
------------- | -------------
**label** | a name when displaying the form field to the user.
**shortLabel** | a shorter label to use in lists and filters.
**type** | defines how this field should be rendered, see [form field definitions](../../element/form-fields.md). Default: text.
**span** | aligns the form field to one side. Options: auto, left, right, row, full, adaptive. Default: `full`.
**spanClass** | used with the span `row` option to display the form as a Bootstrap grid, for example, `spanClass: col-4`.
**size** | specifies a field size for fields that use it, for example, the textarea field.
**placeholder** | if the field supports a placeholder value.
**comment** | places a descriptive comment below the field.
**commentAbove** | places a comment above the field.
**commentHtml** | allow HTML markup inside the comment. Default: `false`.
**default** | specify the default value for the field. For `dropdown`, `checkboxlist`, `radio` and `balloon-selector` widgets, you may specify an option key here to have it selected by default.
**tab** | assigns the field to a tab.
**validation** | defines validation rules for the form field, see [the validation article](../../extend/services/validation.md) for rule definitions.
**trigger** | specify conditions for this field using [trigger events](../../element/form-fields.md).
**preset** | allows the field value to be initially set by the value of another field, converted using the [input preset converter](../../element/form-fields.md).
**translatable** | disables translation for this field when using the `multisite` in the blueprint definition.

## List and Filter Properties

When it comes to displaying a field in a list or filter, each field has its own default settings. You may override these settings on a per field basis and this is suitable for minor adjustments. For more complex use cases, we recommend defining columns and scopes separately from the fields (see below).

Property | Description
------------- | -------------
**column** | defines how to display the field in a list, see [list column definitions](../../element/list-columns.md).
**scope** | defines how to display the field in a filter, see [filter scope definitions](../../element/filter-scopes.md).

### Field Configuration

An example can be specifying a different label for each using the `column` or `scope` properties of the field.

```yaml
myfield:
    label: Form Label
    column:
        label: List Label
    scope:
        label: Filter Label
```

If the are set to `false` then the field will disable and prevent it from being displayed.

```yaml
myfield:
    label: Form Label
    column: false
    scope: false
```

The `column` type can be set to `invisible` to make it hidden from the list by default.

```yaml
myfield:
    label: Form Label
    column: invisible
```

### External Configuration

You may define the scopes and columns separately from the form fields by using the `columns` and `scopes` property in the blueprint. When using external configuration, the default view will be replaced by only the defined fields.

```yaml
scopes:
    myfield:
        label: Filter Label
        # [...]

columns:
    myfield:
        label: List Label
        # [...]

fields:
    myfield:
        label: Form Label
        # [...]
```

List columns have short-hand values that can be used. Passing a string will replace the label, passing `true` will include the default column, passing `false` will remove the column and passing `invisible` will make the column invisible.

```yaml
columns:
    myfield: List Label   # New Label
    myfield: true         # Shown
    myfield: false        # Hidden
    myfield: invisible    # Invisible
```

Filter scopes have a similar short-hand values to the list columns that can be used.

```yaml
scopes:
    myfield: Filter Label # New Label
    myfield: true         # Shown
    myfield: false        # Hidden
```

## Form Field Validation

You may specify validation rules for form fields using the `validation` field property, see [the validation article](../../extend/services/validation.md) for rule definitions.

```yaml
fields:
    myfield:
        label: Featured Text
        validation: "required|min:15"
```

Validation rules can also be defined externally in the blueprint file using the `validation` blueprint property. This allows you to set custom attribute names and validation messages.

```yaml
validation:
    rules:
        myfield: "required|min:15"
    attributeNames:
        myfield: My Field
    customMessages:
        myfield.min: "My field has to be at least 15 characters long"

fields:
    myfield:
        label: Form Label
        # [...]
```

The `unique` validation rule is automatically configured and does not require a table name to be specified.

```yaml
unique_field:
    label: Unique Field
    validation: unique
```

The `required` validation rule supports **create** and **update** modifiers to only apply when a model is created or updated respectively. The following is only required when the model does not already exist.

```yaml
password:
    label: Password
    validation: "required:create"
```

## Modifying Core Fields

Each blueprint record has several core fields as [defined by attributes on the model](./models.md). You can modify these fields under certain conditions.

An Entry is enabled by default; however, you can modify this by specifying a new default value for the `is_enabled` field.

```yaml
fields:
    is_enabled:
        default: false
```

The `title` field placeholder is generated based on the blueprint name; however, you can customize this to something more useful depending on the use case. For example, _First and Last Name_, _Event Title_ or _Location Name_.

```yaml
fields:
    title:
        placeholder: Event Title
```

In some cases the `title` field may not be required, such as using a [single blueprint](./blueprints.md),you may set the `hidden` property to `true`. Hiding the title will disable the in-built validation for this field.

```yaml
fields:
    title:
        hidden: true
```

#### See Also

::: also
* [Defining Form Fields](../../element/form-fields.md)
* [Building Tailor Fields](../../extend/tailor-fields.md)
:::
---
subtitle: The template structure for your website content.
---
# Blueprints

## Entry

An entry blueprint is the standard content structure used to define areas of your website. The content structures and entries can be organised in different ways as we describe in more detail here.

The `entry` type supports multiple entries and should be used when no other variant applies.

```yaml
handle: Team\Member
type: entry
name: Team Member

fields:
    name:
        label: First Name
        type: text
```

The following properties are supported by the entry blueprint.

Property | Description
-------- | -------------
**handle** | A meaningful and unique code to identify the entry.
**type** | The blueprint type which can be a variant of `entry`, `single`, `structure` or `stream`.
**name** | The label to display when working with this entry.
**fields** | form fields belonging to the group, see [backend form fields](../../element/form-fields.md).
**groups** | references a group of form fields placing the entry in group mode (see below).
**structure** | structure configuration supplied when using the `structure` type.
**drafts** | enables drafts for this entry. Default: `false`
**softDeletes** | enables soft deletion for this entry. Default: `true`
**multisite** | enables multisite for this entry, sync records between group, locale or all sites. Supported values: `true`, `false`, `sync`, `locale`, `all`. Default: `false`
**pagefinder** | includes blueprint type in the [pagefinder form widget](../../element/form/widget-pagefinder.md), supported values: `true`, `false`, `item`, `list` or array (see below). Default: `true`
**customMessages** | customize the messages used in the user interface (see below).
**showExport** | displays a toolbar button for exporting records. Default: `true`.
**showImport** | displays a toolbar button for importing records. Default: `true`.

### Entry Variants

While an entry type has no specific behavior, there are also several variants that can be used for organising content. The following types are variants of an entry.

- **entry** is a basic entry for common purposes.
- **single** is a single entry with dedicated fields, eg: Contact Us Page.
- **structure** is a defined structure of entries, eg: Documentation Pages.
- **stream** is a stream of time stamped entries, eg: Blog Posts.

#### Single Entries

The `single` type will force a single entry for each section definition. This is useful for one-off content, such as a Home page or Contact Us page. The following defines a **Homepage** section with a Welcome Message (`welcome_message`) text field.

```yaml
handle: Homepage
type: single
name: Homepage Content

fields:
    welcome_message:
        label: Welcome Message
        type: text
```

#### Structure Entries

The `structure` type allows multiple structured entries, allowing for parent-child relationships to exist. This is useful for nested content, such as a Documentation section. Entries of the type `structure` are sortable. Their sort order can be adjusted by dragging them in the list view. The following defines a **Documentation** tree section with an Article Content (`article_content`) markdown field.

```yaml
handle: Docs\Article
type: structure
name: Documentation Article

fields:
    content:
        label: Article Content
        type: markdown
```

By default structures support unlimited nesting, however, you may specify a maximum depth for the tree using `maxDepth` in the `structure` property. In the next example there can only be a top level and a second level.

```yaml
# ...
type: structure

structure:
    maxDepth: 2
    # ...
```

The following values are supported by the `structure` property.

Property | Description
-------- | -------------
**maxDepth** | Maximum depth for the structure. Default: `0` for unlimited.
**treeExpanded** | if tree nodes should be expanded by default. Default: `true`
**showReorder** | displays an interface for reordering records. Default: `true`
**showSorting** | allows sorting records, disables the structure when sorted. Default: `true`

#### Stream Entries

The `stream` type is used for time-based entries that are often listed in chronological order. This is useful for publishing recent activity, such as a Blog section. The following defines a **Blog** feed section with a Post Content (`content`) rich editor field.

```yaml
handle: Blog\Post
type: stream
name: Blog Post

fields:
    content:
        label: Post Content
        type: richeditor
```

### Content Groups

All entries optionally support the ability to define multiple content groups for a section. For example, a blog section may have a regular post and a featured post, and these are two entry groups.

Entry groups are defined by the **groups** property in the section blueprint file and different **fields** can be specified for each type. The selected group value is available as the `content_group` attribute on the record.

```yaml
handle: Blog\Post
type: stream
name: Blog Post

groups:
    regular_post:
        name: Regular Post
        fields:
            # ...

    featured_post:
        name: Featured Post
        fields:
            # ...
```

::: tip
It is recommended to use [mixin blueprints](#mixin) to group common field definitions.
:::

### Custom Messages

Specify the `customMessages` property to override the default messages used by the interface. The values can be plain text or can refer to a [localization string](../../extend/system/localization.md).

```yaml
customMessages:
    buttonCreate: Create New Event
```

The following messages are available to override as custom messages.

::: details View the list of available messages
Message | Default Message
------------- | -------------
**buttonCreate** | Create :name Entry
**titleIndexList** | Manage :name Entries
**titleCreateForm** | Create :name
**titleUpdateForm** | Update :name
**pagefinderItemType** | :name Entry
**pagefinderListType** | All :name Entries
:::

### Page Finder Configuration

By default, all entries are included in the [page finder](../../element/form/widget-pagefinder.md) lookup values. This can be disabled by setting the **pagefinder** to `false`.

```yaml
pagefinder: false
```

You may restrict the page finder context to only allow locating the page as a single `item` (e.g. Blog Post) or a `list` of items (e.g. All Blog Posts), or when set to `all` will display both.

```yaml
pagefinder: item
pagefinder: list
```

The page finder will automatically resolve the `id`, `code`, `slug` and `fullslug` attributes and use them as replacements in the [page URL parameters](../themes/pages.md). You may specify custom **replacements** as an array using the **pagefinder** properties, including the optional **context** from above.

```yaml
pagefinder:
    context: list
    replacements: []
```

Each replacement key should match a URL parameter name and use a dot notation path to the attribute value. Take the following URL example for a blog post page.

```ini
url = "/blog/post/:author/:category/:slug/:id"
```

The following **replacements** will set the `:author` parameter to the related author slug attribute value, and the `:category` parameter to the first related categories slug attribute value.

```yaml
pagefinder:
    replacements:
        author: author.slug
        category: categories.0.slug
```

## Global

Globals are used to define globally available content for your website. The field values are often used in [CMS layouts](../../cms/themes/layouts.md) and contain settings, such as social networking links.

The following defines a **Footer Config** global with a Facebook Link (`facebook_link`) text field.

```yaml
handle: Site\Footer
type: global
name: Footer Config

fields:
    facebook_link:
        label: Facebook Link
        type: text
```

The following properties are supported by the global blueprint.

Property | Description
-------- | -------------
**handle** | A meaningful and unique code to identify the entry.
**name** | The label to display when working with this entry.
**fields** | form fields belonging to the group, see [backend form fields](../../element/form-fields.md).
**multisite** | enables multisite for this entry, supported values: `true`, `false`. Default: `false`
**formSize** | the settings form size, supported values: `tiny`, `small`, `medium`, `large`, `huge`, `giant`, `adaptive`. Default: `huge`.

## Mixin

Mixins are groups of fields that are used to avoid repetition when defining content structures. For example, a Location field may be used in several places, yet we can define it once using a mixin definition.

The following defines a **Location** collection with Country (`country_code`) and State (`state_code`) text fields.

```yaml
handle: Fields\Location
type: mixin
name: Location

fields:
    country_code:
        label: Country
        type: text

    state_code:
        label: State
        type: text
```

The following properties are supported by the mixin blueprint.

Property | Description
-------- | -------------
**handle** | A meaningful and unique code to identify the entry.
**name** | The label to display when working with this entry.
**fields** | form fields belonging to the group, see [backend form fields](../../element/form-fields.md).

::: tip
Consider prefixing the mixin file and field names with an underscore (\_) to make the blueprint type easy to find. For example: `_location_fields.yaml`
:::

### Using the Mixin

To include these fields in your entries, like any other form field, use the `type` of **mixin** and reference the UUID or handle in the `source` property.

```yaml
_location_fields:
    type: mixin
    source: Fields\Location
```

See the [Mixin field](../../element/content/field-mixin.md) for more information on using mixins.

#### See Also

::: also
* [Mixin Content Field](../../element/content/field-mixin.md)
:::
---
subtitle: Inject assets, variables and headers to the page.
---
# Resources

The `resources` component can create new variables, add headers and inject assets to the page. The resources component can be used on any page, layout or partial.

## Available Properties

The following properties are supported by the component.

Property | Description
-------- | -------------
**js** | Array of JavaScript files in the theme **assets/js** folder
**less** | Array of LESS files in the theme **assets/less** folder
**scss** | Array of SCSS files in the theme **assets/scss** folder
**css** | Array of Stylesheet files in the theme **assets/css** folder
**vars** | Includes variables available on the page or layout.
**headers** | Includes headers with the page response.

## Basic Usage

The following example uses the `vars` property to create a new variable called **activeNav** and this variable becomes available to the page life-cycle, this includes layouts for that page or partials that are used on the page. The variable is accessed using the `{{ activeNav }}` Twig variable.

::: cmstemplate
```ini
[resources]
vars[activeNav] = 'blog'
```
```twig
{% if activeNav == 'blog' %}
    <p>The blog is active!</p>
{% endif %}
```
:::

## Injecting Variables

The resources component lets you define any number of variables on the page. These become available to the layout as a usual Twig variable.

```ini
[resources]
vars[activeNav] = 'blog'
```

You may also use parameters from the page cycle. In the following example the `activeNav` variable will contain the value found inside the `:slug` page route.

```ini
url = "mypage/:slug"

[resources]
vars[activeNav] = '{{ :slug }}'
```

This concept also works for component variables. The following example looks up the author by the `:slug` found in the page route and then assigns the `author.id` to the **authorIdPage** page variable.

```ini
url = "/author/:slug"

[section author]
handle = "Blog\Author"
entrySlug = "{{ :slug }}"

[resources]
vars[authorIdPage] = 'Author ID is: {{ author.id }}'
```

## Injecting Assets

If a layout includes the standard `{% scripts %}` and `{% styles %}` tags, then it is possible to inject assets to these placeholders. The assets will be bundled and combined to a single script/style reference.

Assets loaded using the resources component should be in a specific folder inside the theme as described in the available properties. An example could be a partial named **blocks/carousel.htm**

::: cmstemplate
```ini
[resources]
css[] = "blocks/carousel.css"
scss[] = "blocks/carousel.scss"
less[] = "blocks/carousel.less"
js[] = "blocks/carousel.js"
```
```html
<!-- Carousel Contents Here -->
```
:::

Now when the partial is loaded on the page, the scripts and stylesheets will be injected to the layout. The assets should be located in the **assets/js/blocks/carousel.js** and **assets/less/blocks/carousel.less** directories respectively.

```twig
<!-- Assets for the carousel are injected automatically -->
{% partial 'blocks/carousel' %}
```

::: tip
Using the partial twice on the page will only inject the assets once.
:::

## Using Custom Headers

As an example of defining custom headers, you may wish to render XML content on a page instead of HTML content. This is possible by injecting a `Content-Type` header in to the page and giving it a value of **text/xml**. This header value will be sent with the response when the page loads.

::: cmstemplate
```ini
url = "/blog/rss"

[resources]
headers[Content-Type] = 'text/xml'
```
```xml
<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <!-- RSS contents here -->
</rss>
```
---
subtitle: Adds a collection of model records to the page.
---
# Collection

The `collection` component displays a collection of entries on the page. The collection component can be used on any page, layout or partial.

## Available Properties

The following properties are supported by the component.

Property | Description
-------- | -------------
**handle** | The handle of the [entry blueprint](../tailor/blueprints.md).
**recordsPerPage** | Number of records to display on a single page. Leave empty to disable pagination.
**pageNumber** | This value is used to determine what page the user is on.
**sortColumn** | Column name the records should be ordered by.
**sortDirection** | Direction the records should be ordered by. Supported values are `asc` and `desc`.

## Basic Usage

The following adds a collection of **Blog\Post** entries to the page. The collection is accessed in Twig by looping the default `collection` variable.

::: cmstemplate
```ini
[collection]
handle = "Blog\Post"
```
```twig
{% for post in collection %}
    <h1>{{ post.title }}</h1>
{% endfor %}
```
:::

When multiple collections are used on the same page, the component can be assigned a name **posts** using the component alias and this is the variable name that becomes available to the page. The following collection is accessed using the `posts` variable instead.

::: cmstemplate
```ini
[collection posts]
handle = "Blog\Post"
```
```twig
{% for post in posts %}
    <h1>{{ post.title }}</h1>
{% endfor %}
```
:::

Use the `is empty` or `is not empty` expression to check if a collection has at least one record available to display.

```twig
{% if posts is not empty %}
    {# ... #}
{% endif %}
```

## Performing Queries

When accessing the component variable using a method it will switch to a [database model query](../../extend/database/query.md). For example, to only show entries that have a field `color` with the value **blue** use the `where` query method. Using the `{% set %}` Twig tag will assign the result to a new variable.

```twig
{% set bluePosts = posts.where('color', 'blue').get() %}
```

To show only posts that have a related author, you can use the `whereRelation` query method. To complete the query, proceed with the `get()` method. The following lists posts that are assigned to the `author` with a slug set to **bella-vista**.

```twig
{% set authorPosts = posts.whereRelation('author', 'slug', 'bella-vista').get() %}
```

### Accessing the Entry Type

To filter records by their entry type, perform a `where()` query using the `content_group` attribute. The following will list posts that use the entry type code **featured_post**.

```twig
{% set featuredPosts = posts.where('content_group', 'featured_post').get() %}
```

### Paginating Records

You could also apply pagination to the collection with the `paginate()` method instead. The following will paginate the posts at **10** per page and displays the paginated navigation.

```twig
{% set authorPosts = posts.whereRelation(...).paginate(10) %}

{{ pager(authorPosts) }}
```

::: tip
See the [Pagination feature](../features/pagination.md) to learn more about paging records.
:::

### Searching Records

To search records, use the [`searchWhere()` method](../../extend/database/query.md) to perform a search query on a column's value. The following will search for records the supplied term and columns using a case insensitive query.

```twig
{% set foundPages = pages.searchWhere(searchTerm, ['title', 'content']).get() %}
```

You may also use the [`searchWhereRelation()` method](../../extend/database/relations.md) to search related records, where the relation name is included in the method for querying the relationship existence.

```twig
{% set foundPages = pages.searchWhereRelation(searchTerm, 'author', ['title']).get() %}
```

## Eager Loading Related Records

In some cases, and for performance reasons, you may wish to eager load related records. Use the `load` method on the collection, passing the relation name. In the next example, the `categories` relation will be loaded with every post in the collection.

```twig
{% do authorPosts.load('categories') %}
```

## Counting Records

Let's assume you want to display a list of blog categories and count the number of posts in each category. First, define the [inverse relation](../../element/content/field-entries.md) on the category blueprint as **posts**.

```yaml
posts:
    type: entries
    source: Blog\Post
    inverse: categories
    hidden: true
```

Then, call the `withCount` function on the collection component, followed by `get` to return a collection of category records. This will create an attribute on each category called **post_count**.

```twig
{% set categories = collection.withCount('posts').get() %}
{% for category in categories %}
    <h5>{{ category.title }} ({{ category.post_count }} posts)</h5>
{% endfor %}
```

#### See Also

::: also
* [Pagination](../features/pagination.md)
* [Model Queries](../../extend/database/model.md)
* [Database Relationships](../../extend/database/relations.md)
:::
---
subtitle: Tools for working with multiple site definitions
---
# Site Picker

The `sitePicker` component provides tools for working with [Multisite configuration](../resources/multisite.md) for your website. The best place to include this is in your page or layout template.

## Basic Usage

::: cmstemplate
```ini
[sitePicker]
```
```twig
{% set availableSites = sitePicker.sites %}
```
:::

The following is an example of displaying a dropdown that switches between sites. It is used in conjunction with the `this.site` [Twig property](../../markup/property/this-site.md).

```twig
<select class="form-control" onchange="window.location.assign(this.value)">
    {% for site in sitePicker.sites %}
        <option value="{{ site.url }}" {{ this.site.code == site.code ? 'selected' }}>
            {{ site.name }}
        </option>
    {% endfor %}
</select>
```

Another example is generating alternative page links using meta tags

```twig
{% for site in sitePicker.sites %}
    <link rel="alternate" hreflang="{{ site.locale }}" href="{{ site.url }}" />
{% endfor %}
```

## Loading Sites for a Different Page

By default, the `sites` property will return sites configured for the current page and the `url` will resolve to the current page. The `pageSites()` function can be used to locate sites for a different page, where the first argument is the CMS page name.

In the example below, each site will have a `url` set to the CMS page found in **pages/blog/index.htm**. If the page is not found, then the result will be an empty array.

::: cmstemplate
```ini
[sitePicker]
```
```twig
{% set otherSites = sitePicker.pageSites('blog/index') %}
```
:::

## Translating URL Parameters

By default, the `sitePicker` component isn't aware of model parameters in the URL, such as page slugs and identifiers. The `cms.sitePicker.overrideParams` [global event](../../extend/services/event.md) is used to override the URL parameters to their translated versions. A good place to put this event is inside the `init` or the `onRun` method of a [CMS Component class](../../extend/cms-components.md).

For example, if the model implements the [`Multisite` trait](../../extend/database/traits.md), the `newOtherSiteQuery` method is used to locate the model for the proposed site and modify the URL parameters.

```php
$myModel = MyModel::find(1);
$otherModels = $myModel->newOtherSiteQuery()->get();

Event::listen('cms.sitePicker.overrideParams', function($page, $params, $currentSite, $proposedSite) use ($otherModels) {
    $otherModel = $otherModels->where('site_id', $proposedSite->id)->first();
    if ($otherModel) {
        $params['id'] = $otherModel->id;
        $params['slug'] = $otherModel->slug;
        $params['fullslug'] = $otherModel->fullslug;
    }
    return $params;
});
```

#### See Also

::: also
* [Multisite](../resources/multisite.md)
:::
---
subtitle: Adds global configuration to the page.
---
# Global

The `global` component makes a global record available to the page, layout or partial. The global component can be used on any page, layout or partial.

## Available Properties

The following properties are supported by the component.

Property | Description
-------- | -------------
**handle** | The handle of the [global blueprint](../tailor/blueprints.md).

## Basic Usage

The following adds a global using the handle **Blog\Config** to the page. The component is assigned a name of **blogConfig** using the component alias and this is the variable name that becomes available to the page. The page access the `about_this_blog` text field and displays it on the page.

::: cmstemplate
```ini
[global blogConfig]
handle = "Blog\Config"
```
```twig
<p>{{ blogConfig.about_this_blog }}</p>
```
:::
---
subtitle: Define a website section with a dedicated URL.
---
# Section

The `section` component defines a website section with a supporting entry. This section will be used when previewing the entry from the backend panel.

## Available Properties

The following properties are supported by the component.

Property | Description
-------- | -------------
**handle** | The handle of the [entry blueprint](../tailor/blueprints.md).
**identifier** | Use this identifier key to look up the entry, supported values are `slug`, `fullslug` or `id`. Default: `slug`
**value** | Use this identifier value to use to look up the entry, optional. Leave empty to use the identifier key as the URL parameter name. Can be set to a hard coded value, or a custom parameter, eg: `{{ :slug }}`
**isDefault** | Make this the default page when previewing the entry. Default: `true`.

## Basic Usage

The following creates a section for the **Blog\Author** entry and locates it using the default `:slug` [URL parameter](../themes/pages.md). The author name is displayed as a title by accessing the `{{ section.title }}` Twig variable.

::: cmstemplate
```ini
url = "author/:slug"

[section]
handle = "Blog\Author"
```
```twig
<h1>Posts by {{ section.title }}</h1>
```
:::

When multiple sections are used on the same page, the component alias can be used to assign a different the variable name available to the page. The following component alias **author** makes the title available using the `{{ author.title }}` Twig variable instead.

::: cmstemplate
```ini
[section author]
handle = "Blog\Author"
```
```twig
<h1>Posts by {{ author.title }}</h1>
```
:::

## Changing the Lookup Identifier

The default identifier is `slug` and this can be changed by changing the `identifier` property, for example, locating a record using the `id` column instead. Notice that the page URL also changes to use an `:id` parameter name.

```ini
url = "author/:id"

[section]
handle = "Blog\Author"
identifier = "id"
```

You may hard code the identifier lookup using the `value` property, for example, setting it to **7** will show the record with a static lookup.

```ini
url = "author/ceo"

[section]
handle = "Blog\Author"
identifier = "id"
value = 7
```

The `value` property also accepts external parameters, the following uses the **foobar** URL parameter to look up the record.

```ini
url = "author/:foobar"

[section]
handle = "Blog\Author"
identifier = "id"
value = "{{ :foobar }}"
```

::: warning
Previewing links and using the [Page Finder widget](../../element/form/widget-pagefinder.md) do not support identifiers with custom values.
:::

## Checking Record Existence

In most cases you will want to display a 404 page when a record cannot be found. This is possible by using an `{% if %}` statement combined with the `abort(404)` function.

```twig
{% if author is empty %}
    {% do abort(404) %}
{% endif %}
```

::: tip
The [`abort()` Twig function](../../markup/function/abort.md) is used to show a 404 page when the record is not found.
:::

## Accessing the Entry Type

When using the [Content Groups](./blueprints.md) feature of the entry blueprint, you may access the group code using the `content_group` attribute. For example, a post may have a content group of **regular_post** and **markdown_post** where the content is handled differently.

```twig
{% if post.content_group == 'markdown_post' %}
    <!-- Render content as Markdown -->
    {{ post.content|md }}
{% else %}
    <!-- Render content as HTML -->
    {{ post.content|raw }}
{% endif %}
```

## Using the Full Slug

If the entry type is a `structure`, then it will have a **fullslug** attribute available. To use the full slug in the page URL it should be defined as a [wildcard URL parameter](../themes/pages.md). The `identifier` property of the component should be set to **fullslug**.

```ini
url = "/wiki/:fullslug*"

[section article]
handle = "Wiki\Article"
identifier = "fullslug"
```

As an alternative approach, we recommend targeting the **id** and placing it at the end of the URL instead. This allows the record to be moved around freely without breaking links in your website. The following example shows how to achieve this with a redirect for any previously used URLs.

::: cmstemplate
```ini
url = "/wiki/:fullslug*/:id"

[section article]
handle = "Wiki\Article"
identifier = "id"
```
```twig
{% if article is empty %}
    {% do abort(404) %}
{% elseif article.fullslug != this.param.fullslug %}
    {% do redirect(this|page({ fullslug: article.fullslug }), 301) %}
{% endif %}

<!-- Contents here -->
```
:::

::: tip
The [`redirect()` Twig function](../../markup/function/redirect.md) is used for a permanent 301 redirect when the slug does not match. The [`|page` Twig filter](../../markup/filter/page.md) supplies the current page and rewrites the `fullslug` URL parameter to the correct match.
:::
---
subtitle: Populate blueprints and database records with sample content.
---
# Seeding Themes

Themes support the ability to import sample content from seed scripts, including database content and [Tailor blueprints](../../cms/tailor/introduction.md). A specific folder inside the theme called **seeds** is used along with a directory structure to provide the content.

## Directory Structure

Below you can see an example seed directory structure. The **blueprints** directory contains any blueprint templates used by the theme, these are imported automatically to the **app/blueprints** directory with a nested directory called **mywebsite**. The **data.yaml** file contains instructions on how to import the content in to the database.

::: dir
├── themes
|   └── mywebsite
|       └── `seeds`  _← Theme Seed Directory_
|           ├── blueprints
|           |   └── post.yaml  _← Blueprint File_
|           ├── lang
|           |   └── en.json  _← Language File_
|           ├── data
|           |   └── blog-posts.json  _← Data File_
|           └── data.yaml  _← Seeding Script_
:::

## Importing Blueprints

::: aside
Since blueprints do not depend on any specific file or directory structure, they can be moved around freely.
:::

When importing blueprints, simply place the blueprint files in the **blueprints** directory. It does not use any configuration, when seeding all blueprints are simply copied to the **app/blueprints** directory. A new directory is created inside that has the same name as the theme. The blueprints are placed inside this new directory.

## Importing Languages

As an optional feature, languages can be imported to the **app/lang** directory by placing the [JSON language files](../../extend/system/localization.md) in the **lang** directory. This makes it possible to translate labels and other descriptions inside blueprints. If a language file already exists in the application language directory, then the language strings will be merged together.

## Importing Data

The **data.yaml** file contains a specific format used for importing content in to the database. In the example below, two sets of data are imported to the database for Tailor entry content.

```yaml
-
    name: Blog Post Data
    class: Tailor\Models\RecordImport
    file: seeds/data/blog-posts.json
    attributes:
        file_format: json
        blueprint_uuid: edcd102e-0525-4e4d-b07e-633ae6c18db6
-
    name: Blog Category Data
    class: Tailor\Models\RecordImport
    file: seeds/data/blog-categories.json
    attributes:
        file_format: json
        blueprint_uuid: b022a74b-15e6-4c6b-9eb9-17efc5103543
```

The YAML file should define an array where each item in the array supports the following properties.

Property | Description
------------- | -------------
**name** | gives the import step a name to display to the user.
**class** | refers to a model that extends the interface of `Backend\Models\ImportModel`.
**file** | refers to the JSON data file that contains the content to import.
**attributes** | a list of attributes to set on the Import Model before importing.

### Example Data File

The following is an example of a JSON file that can be used to import blog categories. Each item in the JSON array produces an imported record in the database with the supplied attributes. Providing an **id** attribute allows records to link across multiple imports.

```json
[
    {
        "id": 1,
        "title": "Announcements",
        "slug": "announcements"
    },
    {
        "id": 2,
        "title": "News",
        "slug": "news"
    }
]
```

## Seeding a Theme

The `theme:seed` artisan command is used to seed a theme.

```bash
php artisan theme:seed <theme name>
```

You may also use the `--root` option to instruct the command to import the blueprints in to the root directory instead of in a nested directory.

```bash
php artisan theme:seed <theme name> --root
```

:::tip
You may also seed a theme using the admin panel by navigating to **Settings → Frontend Theme → Manage → Seed Content**.
:::
---
subtitle: Override a theme by creating a child version.
---
# Child Themes

Child themes allow for the possibility of theme inheritence. A good use of this is when you have a third party theme or a theme that is in read-only mode. A child theme will reference a parent and use it as a fallback source.

If a page named `home.htm` exists in the parent theme but not the child, it treats it the same as if it did; the URL is active, and you can open the page like normal. When saving the page in the backend area, a new file is created in the child theme to override the contents.

To enable this feature for a theme, navigate to **Settings → Frontend Theme**, select **Edit Properties** and select a parent from the **Parent Theme** dropdown list.

## Theme Lock File

When installing a theme from a third party using Composer, it is important to note that when the theme is updated, all the files can be overwritten. This could result in any customizations made to the theme being lost. As a safety mechanism, a file called `.themelock` is included to protect a theme from any changes that may be lost during a system update.

When the file `.themelock` is present in the theme directory:

- The theme can only be selected as a parent theme
- The theme does not appear in the backend UI
- The theme cannot be selected as active

## Creating a New Child Theme

The `theme:copy` command can be used to create new themes, including child themes. The following command creates a new theme called `demo-copy` from the source theme `demo` by copying the directory and its contents. The `.themelock` file will be removed during this process.

```bash
php artisan theme:copy demo demo-copy
```

To create a child theme that inherits the parent theme, specify the `--child` option.

```bash
php artisan theme:copy demo demo-child --child
```
---
subtitle: Learn how to customize the theme management features.
---
# Theme Settings

The theme directory could include the **theme.yaml**, **version.yaml** and **assets/images/theme-preview.png** files. These files are optional for the local development but required for themes published on the October CMS Marketplace.

## Theme Information File

The theme information file **theme.yaml** contains the theme description, the author name, URL of the author's website and some other information. The file should be placed to the theme root directory:

::: dir
├── themes
|   └── website
|       ├── pages
|       ├── layouts
|       ├── partials
|       ├── content
|       ├── assets
|       └── `theme.yaml`  _← Information File_
:::

The following fields are supported in the **theme.yaml** file:

Field | Description
------------- | -------------
**name** | specifies the theme name, required.
**author** | specifies the author name, required.
**homepage** | specifies the author website URL, required.
**description** | the theme description, required.
**previewImage** | custom preview image, path relative to the theme directory, eg: `assets/images/preview.png`, optional.
**code** | the theme code, optional. The value is used on the October CMS marketplace for initializing the theme code value.
**authorCode** | the theme author code, optional. The value is used on the October CMS marketplace for defining the theme owner.
**form** | a configuration array or reference to a form field definition file, used for theme customization, optional.
**require** | an array of plugin names used for theme dependencies, optional.

Example of the theme information file:

```yaml
name: "October CMS Demo"
description: "Demonstrates the basic concepts of the front-end theming."
author: "October CMS"
homepage: "https://octobercms.com"
code: "Demo"
authorCode: "Acme"
```

## Version File

The theme version file **version.yaml** defines the current theme version and the change log. The file should be placed to the theme root directory.

::: dir
├── themes
|   └── website
|       ├── ...
|       └── theme.yaml
|       └── `version.yaml`  _← Version File_
:::

The file contains the following format.

```yaml
v1.0.1: Theme initialization
v1.0.2: Added more features
v1.0.3: Some features are removed
```

## Theme Preview Image

The theme preview image is used in the back-end theme selector. The image file **theme-preview.png** should be placed to the theme's **assets/images** directory:

::: dir
├── themes
|   └── website
|       ├── ...
|       └── assets
|           └── images
|               └── `theme-preview.png`  _← Preview Image_
:::

The image width should be at least 600px. The ideal aspect ratio is 1.5, for example 600x400px.

## Theme Dependencies

A theme can depend on plugins by defining a **require** option in the theme information file, the option should supply an array of plugin names that are considered requirements. A theme that depends on **Acme.Blog** and **Acme.User** can define this requirement like so:

```yaml
name: "October CMS Demo"
# [...]

require:
    - "Acme.User"
    - "Acme.Blog"
```

When the theme is installed for the first time, the system will attempt to install the required plugins at the same time. For a streamlined experience, consider [adding these plugins to the composer depedency list](../../extend/resources/publishing-packages.md) as well.

## Theme Customization

Themes can support configuration values by defining a `form` key in the theme information file. This key should contain a configuration array or reference to a form field definition file, see [form field definitions](../../element/form-fields.md) for more information.

The following is an example of how to define a website name configuration field called **site_name**:

```yaml
name: My Theme
# [...]

form:
    fields:
        site_name:
            label: Site name
            comment: The website name as it should appear on the front-end
            default: My Amazing Site!
```

The value can then be accessed inside any of the Theme templates using the [global Twig variable](../../markup/property/this-theme.md) called `this.theme`.

```twig
<h1>Welcome to {{ this.theme.site_name }}!</h1>
```

You may also define the configuration in a separate file, where the path is relative to the theme. The following definition will source the form fields from the file **config/fields.yaml** inside the theme.

```yaml
name: My Theme
# [...]

form: config/fields.yaml
```

**themes/demo/config/fields.yaml**:

```yaml
fields:
    site_name:
        label: Site name
        comment: The website name as it should appear on the front-end
        default: My Amazing Site!
```

### Using Theme Data in CSS

Sometimes you want to include a visual preference inside your theme stylesheet. You may use CSS custom properties (variables) to make these values available. In the following example, we will use a [Color Picker field type](../../element/form/widget-colorpicker.md) to specify a custom link color.

```yaml
form:
    fields:
        # [...]

        link_color:
            label: Link color
            type: colorpicker
```

Using the above example we can define a [CMS partial](./partials.md) that passes the selected value to CSS using a local stylesheet. The partial is then included in the [theme layout](./layouts.md) inside the `<head>` tag.

```html
<style>
    :root {
        --my-color: {{ this.theme.link_color }};
    }
</style>
```

::: tip
Custom property names are case sensitive so `--my-color` will be treated as a separate custom property to `--My-color`.
:::

Now inside your stylesheet the custom property can be used anywhere by specifying the custom property name inside the `var()` function, in place of a regular property value.

```css
a {
    color: var(--my-color);
}
```

### Using Theme Data with Combined Assets

Assets combined using the `|theme` [filter and combiner](../markup/filter-theme.md) can have values passed to supporting filters, such as the LESS filter. Simply specify the `assetVar` option when defining the form field, the value should contain the desired variable name.

```yaml
form:
    fields:
        # [...]

        link_color:
            label: Link color
            type: colorpicker
            assetVar: 'link-color'
```

In the above example, the color value selected will be available inside the less file as `@link-color`. Assuming we have the following stylesheet reference:

```twig
<link href="{{ ['assets/less/theme.less']|theme }}" rel="stylesheet">
```

Using some example content inside **themes/yourtheme/assets/less/theme.less**:

```less
a { color: @link-color }
```
---
subtitle: Bridge the gap between developers and publishers.
---
# Snippets

Snippets are blocks inserted into the [rich editor](../../element/form/widget-richeditor.md) or [markdown editor](../../element/form/widget-markdown.md), and configured with the [inspector tool](../../element/inspector-types.md). When the feature is available, an insert snippets button is shown in toolbar, and selecting a snippet will insert it into the editor.

Snippets can be defined as [partials](./partials.md) or [components](./components.md), allowing developers to define reusable and configurable pieces of content. There are many possible applications and examples of using snippets:

- Embedded videos - output a configured YouTube video or Twitch streams.
- Google Maps snippet - outputs a map centered on specific coordinates with predefined zoom factor. That snippet would be great for pages that explain directions.
- Universal commenting system - allows visitors to post comments to any page.
- Third-party integrations - for example with Yelp or TripAdvisor for displaying extra information on a page.

When including snippets in your page content, the [`|content` Twig filter](../../markup/tag/content.md) is needed to process and render the snippets as part of the output.

```twig
{{ blog_html|content }}
```

## Creating Snippets from Partials

Partial-based snippets provide simpler functionality and usually are just containers for HTML markup, or markup generated with Twig in a snippet.

To create snippet from a partial, open a partial in the Editor and click the **Snippet** button. From here, you can enter the snippet code, name and description in the partial form.

The snippet properties are optional and can be defined with the grid control on the partial settings form. The table has the following columns.

Column         | Description
-------------- | -----------
Property Title | specifies the property title, visible to the end user in the snippet inspector popup window.
Code           | specifies the property code, used for accessing the property values in the partial markup.
Type           | the property type, available types are `string`, `dropdown` and `checkbox`.
Default        | the default property value, for checkbox properties use `0` and `1` values.
Options        | the option list for the dropdown properties.

When defining **options**, list should have the following format: `key:Value | key2:Value`. The keys represent the internal option value, and values represent the string that users see in the drop-down list. The pipe character separates individual options. Example: `us:US | ca:Canada`. The key is optional, if it's omitted (`US | Canada`), the internal option value will be zero-based integer (`0`, `1`, ...). It's recommended to always use explicit option keys. The keys can contain only Latin letters, digits and characters `-` and `_`.

Any property defined in the property list can be accessed within the partial markdown as a usual variable, for example:

```twig
The country name is {{ country }}
```

In addition, properties can be passed to the partial components using [external property values](../themes/components.md).

## Creating Snippets from Components

Any [CMS component](./components.md) can be registered as a snippet using the `registerPageSnippets` method in your plugin class in the [registration file](../../extend/system/plugins.md). The API for registering a snippet is similar to the one for [registering components](../../extend/cms-components.md). The method should return an array with class names in keys and aliases in values.

```php
public function registerPageSnippets()
{
    return [
        \RainLab\Weather\Components\Weather::class => 'weather'
    ];
}
```

::: tip
The same component can be registered with `registerPageSnippets` and `registerComponents` to be used in CMS pages and content editors.
:::

To enable the use of AJAX handlers, snippets can be rendered using an [AJAX partial](../../markup/tag/ajax-partial.md). You may enable this by setting `snippetAjax` to `true` in the [component class definition](../../extend/cms-components.md).

```php
public function componentDetails()
{
    return [
        // ...
        'snippetAjax' => true
    ];
}
```

## Usage Examples

These are some practical examples of how snippets can be used.

### Viewing a Tailor Record

The following snippet displays a blog post summary from a tailor entry record. It includes a [section component](../components/section.md) and sets the lookup `value` from the `post_id` snippet property using external property values.

The publisher sets the **Blog Post ID** for the blog post, and it outputs a link to the blog post as a card element.


::: cmstemplate
```ini
## partials/snippets/blog-post-reference.htm

[viewBag]
snippetCode = "blogPostReference"
snippetName = "Blog Post Reference"
snippetDescription = "Display a reference to a blog post"
snippetProperties[post_id][title] = "Blog Post ID"
snippetProperties[post_id][type] = "string"

[section post]
handle = "Blog\Post"
identifier = "id"
value = "{{ post_id }}"
```
```twig
{% if post is not empty %}
    <div class="card shadow-sm">
        <div class="card-body">
            <h4>{{ post.title }}</h4>
        </div>
        <div class="card-footer">
            <div class="d-flex justify-content-between align-items-center">
                <a href="{{ 'blog/post'|page({ slug: post.slug }) }}" class="stretched-link">
                    {{ post.categories.first.title|default('') }}
                </a>
                <small class="text-muted">{{ post.published_at_date|date('j M Y') }}</small>
            </div>
        </div>
    </div>
{% else %}
    <!-- Post Missing: Unable to Find an Entry -->
{% endif %}
```
:::

### Embedding a YouTube Video

The following snippet implements a YouTube embed video as a [CMS partial](./partials.md). It includes a method for extracting the YouTube code from a browser URL and converting a time string to seconds.

The publisher sets the **Video URL** and **Start At** snippet values, and it outputs a standard YouTube embed code using an inline frame element.

::: cmstemplate
```ini
## partials/snippets/youtube-video.htm

[viewBag]
snippetCode = "youtubeVideo"
snippetName = "YouTube Video"
snippetDescription = "Embed a Youtube Video on the page"
snippetProperties[url][title] = "Video URL"
snippetProperties[url][type] = "string"
snippetProperties[start_at][title] = "Start At"
snippetProperties[start_at][type] = "string"
```
```php
// Converts https://www.youtube.com/watch?v=k_H2zJ7UZfs to k_H2zJ7UZfs
function urlToCode($link = '')
{
    $parts = parse_url($link);
    if (isset($parts['query'])) {
        parse_str($parts['query'], $qs);
        if (isset($qs['v'])){
            return $qs['v'];
        }
        elseif (isset($qs['vi'])){
            return $qs['vi'];
        }
    }
    if (isset($parts['path'])){
        $path = explode('/', trim($parts['path'], '/'));
        return $path[count($path)-1];
    }
    return null;
}

// Converts 15:00 to 900
function timeToSeconds($time = '')
{
    $parts = explode(':', $time);
    if (count($parts) === 3) {
        return $parts[0] * 3600 + $parts[1] * 60 + $parts[2];
    }
    elseif (count($parts) === 2) {
        return $parts[0] * 60 + $parts[1];
    }
    return $time ?: 0;
}
```
```twig
{% if url %}
    <iframe
        width="560"
        height="315"
        src="https://www.youtube.com/embed/{{ this.urlToCode(url) }}?start={{ this.timeToSeconds(start_at) }}"
        title="YouTube video player"
        frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        allowfullscreen></iframe>
{% else %}
    <!-- Video URL Missing -->
{% endif %}
```
:::

### Basic Contact Form

The next snippet displays a basic contact form and provides a way to handle the submission logic, it does not include code for [validating the form](../features/validation.md) and [sending the email](../../extend/system/sending-mail.md).

The snippet has no properties, the publisher only needs to include the widget on the page, and it outputs a contact form with a success message. The `snippetAjax` attribute is set to `1` to enable the use of AJAX handlers.

::: cmstemplate
```ini
## partials/snippets/contact-form.htm

[viewBag]
snippetCode = "contactForm"
snippetName = "Contact Form"
snippetDescription = "Display a contact form"
snippetAjax = 1
```
```php
function onSubmitContact()
{
    $this['submitted'] = true;
}
```
```twig
{% if not submitted %}
    <h3>Tell us what you think!</h3>
    <form data-request="onSubmitContact" data-request-update="{ _self: true }">
        <div class="row">
            <div class="col-md-6">
                <div class="form-floating mb-3">
                    <input name="name" type="text" class="form-control">
                    <label>Name</label>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-floating mb-3">
                    <input name="email" type="email" class="form-control">
                    <label>Email Address</label>
                </div>
            </div>
        </div>
        <div class="mb-3 form-floating">
            <textarea class="form-control h-100"></textarea>
            <label>Message</label>
        </div>
        <div class="form-buttons d-flex pt-2">
            <div>
                <button type="submit" class="btn btn-primary btn-pill">Submit</button>
            </div>
        </div>
    </form>
{% else %}
    <div class="alert alert-success">
        Thanks for contacting us!
    </div>
{% endif %}
```
:::

#### See Also

::: also
* [CMS Partials](./partials.md)
* [Developing Components](../../extend/cms-components.md)
:::
---
subtitle: Learn how to translate messages inside CMS themes.
---
# Localization

::: aside
View the [Multisite article](../resources/multisite.md) to learn how to set the active language for your website.
:::

Themes can provide localization keys through files placed in the **lang** subdirectory of the theme's directory. These localization keys are registered automatically and can be used inside the theme contents or as backend form labels similar to [plugin localization](../../extend/system/localization.md).

### Localization File Structure

Below is an example of the theme's **lang** directory.

::: dir
├── themes
|   └── website
|       └── `lang`  _← Localization Directory_
|           ├── en.json  _← Localization File_
|           └── fr.json  _← Localization File_
:::

The localization file is a JSON file where strings use the "default" translation of the string as the key. For example, if your application has a French translation, you should create a `lang/fr.json` file.

```json
{
    "I love programming.": "j'adore programmer"
}
```

You are also able to define code-based keys by using the complete language key in the JSON file, for example, `theme.options.website_name` for the **acme** theme can be used.

```json
{
    "theme.options.website_name": "October CMS"
}
```

Language strings can be accessed in your theme files using the `trans` Twig filter.

::: tip
View [the markup guide](../../markup/filter/trans.md) to learn more about translation in Twig.
```twig
<!-- j'adore programmer -->
{{ 'I love programming.'|trans }}

<!-- October CMS -->
{{ 'theme.options.website_name'|trans }}
```
:::

#### See Also

::: also
* [Multisite](../resources/multisite.md)
* [Plugin Localization](../../extend/system/localization.md)
:::
---
subtitle: Dedicated files for storing and updating page content.
---
# Content Blocks

Content Blocks can be text, HTML or [Markdown](http://daringfireball.net/projects/markdown/syntax) blocks that are edited separately from the page or layout. They're designed to hold static content only and support basic templating variables. [Partials](./partials.md) are more flexible and should be used for generating dynamic content.

## Introduction

Content blocks files reside in the **/content** subdirectory of a theme directory. The following extensions are supported for content files.

Extension | Description
------------- | -------------
**html** | Used for HTML markup (WYSIWYG editor).
**htm** | Used for HTML markup (code editor).
**txt** | Used for plain text.
**md** | Used for Markdown syntax.

The extension affects a content block's display mode in the back-end user interface, either with a WYSIWYG editor, code editor or markdown editor. It also determines rendering the blocks on the website; for example, Markdown blocks will convert to HTML before display.

## Rendering Content Blocks

Use the `{% content 'file.htm' %}` tag to render a content block in a [page](./pages.md), [partial](./partials.md) or [layout](./layouts.md).

This example shows a complete page rendering a content block.

::: cmstemplate
```ini
url = "/contacts"
```
```twig
<div class="contacts">
    {% content 'contacts.html' %}
</div>
```
:::

Another example rendering some markdown with the `md` extension.

```twig
{% content 'my-markdown.md' %}
```

## Passing Variables to Content Blocks

Sometimes you may need to pass variables to a content block from the external code. While content blocks do not support Twig markup, they do support using variables with basic syntax. You can pass variables to content blocks by specifying them after the content block name in the `{% content %}` tag.

Passing the variable called `name` with a value **John** to the content block.

```twig
{% content 'welcome.htm' name='John' %}
```

Inside the content block, variables can be accessed using singular *curly brackets*.

```html
<h1>This is a demo for {name}</h1>
```

::: tip
More information on variable use can be found in the [Markup guide](../../markup/tag/content.md).
:::

### Global Variables

You may register variables that are globally available to all content blocks with the `View::share` method.

```php
View::share('site_name', 'October CMS');
```

A common area to place this method is inside the register or boot method of a [plugin registration file](../../extend/system/plugins.md). Using the above example, the variable `{site_name}` will be available inside all content blocks.

```html
<p>Welcome to {site_name}</p>
```

#### See Also

::: also
* [Content Twig Tag](../../markup/tag/content.md)
:::
---
subtitle: Define a URL for each page on your website.
---
# Pages

Every website serves up at least one page and in October CMS, a page is represented with page template. Page template files reside in the **pages** directory in your theme. Page file names do not affect the routing, but it's a good idea to name your pages according to the page's function. The files should have the **htm** extension.

The Configuration and Twig template sections are required for pages, but the PHP section is optional. Below, you can see the simplest home page example.

::: cmstemplate
```ini
url = "/"
```
```twig
<h1>Hello, world!</h1>
```
:::

## Page Configuration

Page configuration is defined in the configuration Section of the page template file. The page configuration defines the page parameters, required for the routing and rendering the page and its [Components](./components.md), which are explained in another article. The following configuration parameters are supported for pages:

Parameter | Description
------------- | -------------
**url** | the page URL, required. The URL syntax is described below.
**title** | the page title, required.
**layout** | the page [layout](./layouts.md), optional. If specified, should contain the name of the layout file, without extension, for example: `default`.
**description** | the page description for the back-end interface, optional.
**hidden** | hidden pages are accessible only by logged-in back-end users, optional.

### URL Syntax

The page URL is defined with the **url** configuration parameter. URLs should start with the forward slash character, and can contain parameters. URLs without parameters are fixed and strict. In the following example, the page URL is `/blog`.

::: tip
The page URL is case-insensitive by default.

```ini
url = "/blog"
```
:::


URLs with parameters are more flexible. A page with the URL pattern defined in the following example would be displayed for any address like `/blog/post/something`. URL parameters can be accessed by October components or from the page PHP code section.

```ini
url = "/blog/post/:post_id"
```

This is how you can access the URL parameter from the page's PHP section (see the Dynamic Pages section for more details).

::: cmstemplate
```ini
url = "/blog/post/:post_id"
```
```php
function onStart()
{
    $postId = $this->param('post_id');
}
```
```twig
```
:::

Parameter names should be compatible with PHP variable names. To make a parameter optional, add a question mark after its name:

```ini
url = "/blog/post/:post_id?"
```

Parameters in the middle of the URL cannot be optional. In the next example, the `:post_id` parameter is marked as optional, but is processed as required.

```ini
url = "/blog/:post_id?/comments"
```

Optional parameters can have default values which are used as fallback values in case the real parameter value is not presented in the URL. Default values cannot contain any asterisks, pipe symbols, or question marks. The default value is specified after the **question mark**. In the next example, the `category_id` parameter would be `10` for the URL `/blog/category`.

```ini
url = "/blog/category/:category_id?10"
```

You can also use regular expressions to validate parameters. To add a validation expression, add a pipe symbol after the parameter name, or a question mark, and specify the expression. The forward slash symbol is not allowed in these expressions. Examples:

```ini
url = "/blog/:post_id|^[0-9]+$/comments" ; this will match /blog/10/comments

url = "/blog/:post_id|^[0-9]+$" ; this will match /blog/3

url = "/blog/:post_name?|^[a-z0-9\-]+$" ; this will match /blog/my-blog-post
```

It is possible to use a special *wildcard* parameter by placing an **asterisk** after the parameter. Unlike regular parameters, wildcard parameters can match one or more URL segments. A URL can only ever contain a single wildcard parameter, cannot use regular expressions, or be followed by an optional parameter.

```ini
url = "/blog/:category*/:slug"
```

Wildcard parameters themselves can be made optional by preceding the asterisk with the `?` character however.

```ini
url = "/blog/:slug?*"
```

For example, a URL like `/color/:color/make/:make*/edit` will match `/color/brown/make/volkswagen/beetle/retro/edit` and extract the following parameter values:

- color: `brown`
- make: `volkswagen/beetle/retro`

::: tip
Subdirectories do not affect page URLs - the URL is defined only with the **url** parameter.
:::

## Dynamic Pages

Inside the Twig section of a page template, you can use any [functions, filters, and tags provided by October CMS](../../markup/templating.md). Any dynamic page requires **variables** and variables may be prepared by the page or layout PHP section, or by [Components](./components.md). In this article, we describe how to prepare variables in the PHP section.

### Page Execution Life Cycle

There are special functions that can be defined in the PHP section of pages and layouts: `onInit`, `onStart`, and `onEnd`. The `onInit` function is executed when all components are initialized and before AJAX requests are handled. The `onStart` function is executed during the beginning of the page execution. The `onEnd` function is executed before the page is rendered and after the page [components](./components.md) are executed. In the `onStart` and `onEnd` functions, you can inject variables into the Twig environment. Use the `$this` with array notation to pass variables to the page.

::: cmstemplate
```ini
url = "/"
```
```php
function onStart()
{
    $this['hello'] = "Hello world!";
}
```
```twig
<h3>{{ hello }}</h3>
```
:::

The next example is more complicated. It shows how to load a blog post collection from the database, and display on the page (the `Acme\Blog` plugin is imaginary).

::: cmstemplate
```ini
url = "/blog"
```
```php
use Acme\Blog\Classes\Post;

function onStart()
{
    $this['posts'] = Post::orderBy('created_at', 'desc')->get();
}
```
```twig
<h2>Latest posts</h2>
<ul>
    {% for post in posts %}
        <h3>{{ post.title }}</h3>
        {{ post.content }}
    {% endfor %}
</ul>
```
:::

The default variables and Twig extensions provided by October CMS are described in the [Markup Guide](../../markup/templating.md). The sequence that the handlers are executed in is described by the [Dynamic Layouts section](./layouts.md).

### Sending a Custom Response

All methods defined in the execution life cycle have the ability to halt the process and return a response - simply return a response from the life cycle function. The example below will not load any page contents, and instead return the string *Hello world!* to the browser:

```php
function onStart()
{
    return 'Hello world!';
}
```

A more useful example might be triggering a redirect using the `Redirect` facade:

```php
public function onStart()
{
    return Redirect::to('http://google.com');
}
```

### Handling Forms

You can handle standard forms with handler methods defined in the page or layout PHP section (handling the AJAX requests is explained in the [AJAX Framework](../ajax/introduction.md) article). Use the `form_open()` [Twig function](../../markup/function/form.md) to define a form that refers to an event handler.

```html
<form data-request="onHandleForm">
    <div>
        <label>Please enter a string</label>
        <input name="value"/>
    </div>

    <button data-attach-loading>
        Submit
    </button>
</form>

<p>Last submitted value: {{ lastValue }}</p>
```

The `onHandleForm` function can be defined in the page or layout PHP section.

```php
function onHandleForm()
{
    $this['lastValue'] = post('value');
}
```

The handler loads the value with the `post` function and initializes the page's `lastValue` attribute variable which is displayed below the form in the first example.

::: tip
If a handler with the same name is defined in the page layout, the page, and a [page component](./components.md), October CMS will execute the page handler. If a handler is defined in a component and a layout, the layout handler will be executed. The handler precedence is: page, layout, component.
:::

If you want to refer to a handler defined in a specific component, use the component's name or alias in the handler reference:

```html
<form data-request="myComponent::onHandleForm">...</form>
```

## 404 Page

If the theme contains a page with the URL `/404`, it is displayed when the system can't find a requested page.

## Error Page

By default, any errors will be shown with a detailed error page containing the file contents, line number, and stack trace where the error occurred. You can display a custom error page by setting the configuration value `debug` to **false** in the `config/app.php` script, and creating a page with the URL `/error`.

## Setting the Page Title

Setting the page title can be done inside PHP, using the Page Object, or inside Twig, using the [placeholder tag](../../markup/tag/placeholder.md).

### Using Page Properties

The properties of a page can be accessed in the PHP code section or [Components](./components.md) by referencing `$this->page`. The following sets the `meta_title` attribute to a new value.

```php
function onEnd()
{
    $this->page->meta_title = 'A different page title';
}
```

The `{{ this.page }}` variable can be accessed in Twig using the `this.page` variable. For example, to return the `meta_title` attribute inside a layout.

```twig
<title>{{ this.page.meta_title }}</title>
```

::: tip
More information on `this.page` can be found in [the Markup guide](../../markup/property/this-page.md).
:::

### Using Placeholder Variables

The `{% put %}` tag allows you to store a value inside a placeholder variable. The following sets the `pageTitle` variable.

```twig
{% put pageTitle = 'Yet another page title' %}
```

The `placeholder()` Twig function is used to access the variable inside the layout.

```twig
<title>{{ placeholder('pageTitle') }}</title>
```

A default value (second argument) can be supplied as a fallback.

```twig
<title>{{ placeholder('pageTitle', this.page.meta_title) }}</title>
```

::: tip
More information on the placeholder tag can be found in [placeholder tag article](../../markup/tag/placeholder.md).
:::

## Injecting Page Assets Programmatically

If needed, you can inject assets (CSS and JavaScript files) into pages with the controller's `addCss` and `addJs` methods. It could be done in the `onStart` function defined in the PHP section of a page or [layout template](./layouts.md).

```php
function onStart()
{
    $this->addCss('assets/css/hello.css');
    $this->addJs('assets/js/app.js');
}
```

If the path specified in the `addCss` and `addJs` method argument begins with a slash (/), it will be relative to the website root. If the asset path does not begin with a slash, it is relative to the theme.

Injected assets can be combined by passing them as an array:

```php
function onStart()
{
    $this->addCss(['assets/css/hello.css', 'assets/css/goodbye.css']);
    $this->addJs(['assets/js/app.js', 'assets/js/nav.js']);
}
```

LESS and SCSS assets can be injected and compiled using the combiner.

```php
function onStart()
{
    $this->addCss(['assets/less/base.less']);
}
```

The second argument of `addCss` and `addJs` allows you to provide additional attributes to your injected assets:

```php
function onStart()
{
    $this->addJs(['assets/js/app.js', 'assets/js/nav.js'], ['defer' => true]);
}
```

In order to output the injected assets on pages or [layouts](./layouts.md), use the `{% styles %}` and `{% scripts %}` tags. Example:

```twig
<head>
    ...
    {% styles %}
</head>
<body>
    ...
    {% scripts %}
</body>
```

::: tip
More information on `{% styles %}` and `{% scripts %}` tags can be found at [the Markup guide](../../markup/tag/placeholder.md).
:::
---
subtitle: Configurable controllers that can be attached to any page, partial or layout.
---
# Components

Components are a key feature of building scalable and modern solutions with October CMS. Each component implements some functionality that extends your website. Components can output HTML markup on a page, but it is not necessary - other important features of components are [handling AJAX requests](../ajax/introduction.md), handling form postbacks and handling the page execution cycle, that allows to inject variables to pages or implement the website security.

This article describes the components basics and doesn't explain how to use [components with AJAX](../ajax/handlers.md), [developing components](../../extend/cms-components.md) as part of plugins, or the [components included](../components/section.md) with October CMS.

## Introduction

Components can be found in the Editor in the admin panel. You can add components to your pages, partials and layouts by clicking the Components toolbar button on any open document. If you use a text editor you can attach a component to a page or layout by adding its name to the configuration section of the template file. The next example demonstrates how to add a demo To-Do component to a page.

::: cmstemplate
```ini
title = "Components demonstration"
url = "/components"

[demoTodo]
maxItems = 20
```
```twig
<!-- HTML Content Here -->
```
:::

This initializes the component with the properties that are defined in the component section. Many components have properties, but it is not a requirement. Some properties are required, and some properties have default values. If you are not sure what properties are supported by a component, refer to the documentation provided by the developer, or use the Inspector in the Editor admin panel. The Inspector opens when you click a component in the page or layout component panel.

::: aside
If two components with the same name are assigned to a page and layout together, the page component will take priority.
:::

When you refer a component, it automatically creates a page variable that matches the component name (`demoTodo` in the previous example). Components that provide HTML markup can be rendered on a page with the `{% component %}` tag, like the following.

```twig
{% component 'demoTodo' %}
```

::: warning
Using components inside partials has limited functionality, this is described in more detail in the [Dynamic Partials section](./partials.md) of the documentation.
:::

## Components Aliases

If there are two plugins that register components with the same name, you can attach a component by using its fully qualified class name and assigning it an *alias*.

```ini
[October\Demo\Components\Todo demoTodoAlias]
maxItems = 20
```

The first parameter in the section is the class name, the second is the component alias name that will be used when attached to the page. If you specified a component alias you should use it everywhere in the page code when you refer to the component. Note that the next example refers to the component alias:

```twig
{% component 'demoTodoAlias' %}
```

The aliases also allow you to define multiple components of the same class on a same page by using the short name first and an alias second. This lets you to use multiple instances of a same component on a page.

```ini
[demoTodo todoA]
maxItems = 10
[demoTodo todoB]
maxItems = 20
```

## Using External Property Values

By default property values are initialized in the Configuration section where the component is defined, and the property values are static, like this:

```ini
[demoTodo]
maxItems = 20
==
...
```

::: v-pre
However there is a way to initialize properties with values loaded from external parameters - URL parameters or [partial](partials.md) parameters (for components defined in partials). Use the `{{ paramName }}` syntax for values that should be loaded from partial variables:
:::

```ini
[demoTodo]
maxItems = {{ maxItems }}
==
...
```

Assuming that in the example above the component **demoTodo** is defined in a partial, it will be initialized with a value loaded from the **maxItems** partial variable:

```twig
{% partial 'my-todo-partial' maxItems='10' %}
```

You may use dot notation to retrieve a deeply nested value from an external parameter:

```ini
[demoTodo]
maxItems = {{ data.maxItems }}
==
...
```

::: v-pre
To load a property value from the URL parameter, use the `{{ :paramName }}` syntax, where the name starts with a colon (`:`), for example.
:::

```ini
[demoTodo]
maxItems = {{ :maxItems }}
==
...
```

The page that the component belongs to should have a corresponding [URL parameter](pages.md) defined.

```ini
url = "/todo/:maxItems"
```

In the October back-end you can use the Inspector tool for assigning external values to component properties. In the Inspector you don't need to use the curly brackets to enter the parameter name. Each field in the Inspector has an icon on the right side, which opens the external parameter name editor. Enter the parameter name as `paramName` for partial variables or `:paramName` for URL parameters.

## Passing Variables to Components

Components can be designed to use variables at the time they are rendered, similar to [Partial variables](./partials.md), they can be specified after the component name in the `{% component %}` tag. The specified variables will explicitly override the value of the [component properties](../../extend/cms-components.md), including external property values.

In this example, the **maxItems** property of the component will be set to *7* at the time the component is rendered:

```twig
{% component 'demoTodoAlias' maxItems='7' %}
```

## Customizing Default Markup

::: aside
The default markup in a component is boilerplate code, with the aim to provide a simple example of how it can be used.
:::

There are two ways to customize the default markup of a component:

- copy the default markup in to your theme
- override a component partial one at a time

Overriding a component partial has a very limited subset of uses. In most cases, converting a component's partial to a CMS partial is much easier, and there is little difference in doing it this way.

As an example, take a look at a blog component rendered like this.

::: cmstemplate
```ini
[blog]
```
```twig
{% component 'blog' %}
```
:::

The code above is effectively the same as doing this.

::: cmstemplate
```ini
[blog]
```
```twig
{% partial 'blog::default' %}
```
:::

If you copy the **default.htm** partial from the component to your theme as a **blog-default.htm** partial, you can render it the same way.

::: cmstemplate
```ini
[blog]
```
```twig
{% partial 'blog-default' %}
```
:::

Here we can see it simple to use CMS partials to customize the content, and it demonstrates the true power of components. There are only rare cases where the theme should override components partials and this is covered in more detail below.

### Moving Default Markup to a Partial

Each component will have an entry point partial called **default.htm** that is rendered when the `{% component %}` tag is called, in the following example we will assume the component is called **blogPost**.

::: cmstemplate
```ini
url = "blog/post"

[blogPost]
```
```twig
{% component "blogPost" %}
```
:::

The output will be rendered from the plugin directory **components/blogpost/default.htm**. You can copy all the markup from this file and paste it directly in the page or to a new partial, called **blog-post.htm** for example.

```twig
<h1>{{ __SELF__.post.title }}</h1>
<p>{{ __SELF__.post.description }}</p>
```

Inside the markup you may notice references to a variable called `__SELF__`, this refers to the component object and should be replaced with the component alias used on the page, in this example it is `blogPost`.

```twig
<h1>{{ blogPost.post.title }}</h1>
<p>{{ blogPost.post.description }}</p>
```

This is the only change needed to allow the default component markup to work anywhere inside the theme. Now the component markup can be customized and rendered using the theme partial.

```twig
{% partial 'blog-post' %}
```

This process can be repeated for all other partials found in the component partial directory.

### Overriding Component Partials

All component partials can be overridden using the theme partials. This is useful when a component has a strict implementation and introduces as an option to configure specific areas of its markup.

As an example, if a component called **channel** uses the **title.htm** partial.

::: cmstemplate
```ini
url = "mypage"

[channel]
```
```twig
{% component "channel" %}
```
:::

We can override the partial by creating a file in our theme called **partials/channel/title.htm**.

The file path segments are broken down like this:

Segment | Description
------------- | -------------
**partials** | the theme partials directory
**channel** | the component alias (a partial subdirectory)
**title.htm** | the component partial to override

The partial subdirectory name can be customized to anything by simply assigning the component an alias of the same name. For example, by assigning the **channel** component with a different alias **foobar** the override directory is also changed.

::: cmstemplate
```ini
[channel foobar]
```
```twig
{% component "foobar" %}
```
:::

Now we can override the **title.htm** partial by creating a file in our theme called **partials/foobar/title.htm** instead.

## The "View Bag" Component

::: aside
The viewBag component is hidden in the backend panel and is only available for file-based editing. It can also be used by other plugins to store data.
:::

There is a special component included in October CMS called `viewBag` that can be used on any page or layout. It allows ad hoc properties to be defined and accessed inside the markup area easily as variables. A good usage example is defining an active menu item inside a page.

::: cmstemplate
```ini
title = "About"
url = "/about.html"
layout = "default"

[viewBag]
activeMenu = "about"
```
```twig
<p>Page content...</p>
```
:::

Any property defined for the component is then made available inside the page, layout, or partial markup using the `viewBag` variable. For example, in this layout the **active** class is added to the list item if the `viewBag.activeMenu` value is set to **about**.

::: cmstemplate
```ini
description = "Default layout"
```
```twig
...

<!-- Main navigation -->
<ul>
    <li class="{{ viewBag.activeMenu == 'about' ? 'active' }}">About</li>
    ...
</ul>
```
:::

### AJAX Handlers and Partials

Components may introduce [AJAX handlers](../ajax/introduction.md) and [partials](./partials.md) to the a theme's life cycle, using a prefix of the component name and two `::` symbols. For example, all the AJAX handlers defined by components are available globally.

```html
data-request="onMyComponentHandler"
```

However, if there is a conflict in naming, the fully qualified name can be used.

```html
data-request="componentName::onMyComponentHandler"
```

Partials rendered from outside the component must use their fully qualified name.

```twig
{% partial 'componentName::component-partial' %}
```

Read more on [component development](../../extend/cms-components.md) to learn about component partials.

#### See Also

::: also
* [CMS Component Development](../../extend/cms-components.md)
:::
---
subtitle: Define the scaffold for your website pages.
---
# Layouts

Layouts define a common scaffold for your pages, which usually means everything that repeats on every page, such as a header and a footer. They will almost always contain HTML code such as HEAD, TITLE and BODY tags.

Layout template files reside in the **layouts** directory in your theme. Layout template files should have the **htm** extension. Inside the layout file you should use the `{% page %}` tag to output the page content. Next is an example of the simplest possible layout.

```twig
<html>
    <body>
        {% page %}
    </body>
</html>
```

::: aside
Remember that if you refer a layout from a subdirectory you should specify the subdirectory name.
:::

To use a layout for a [page](./pages.md), the page should refer the layout file name (without extension) in the configuration section. Below is an example page template using the **default.htm** layout.

::: cmstemplate
```ini
url = "/"
layout = "default"
```
```twig
<p>Hello, world!</p>
```
:::

When this page is requested its content is merged with the layout, or more precisely - the layout's `{% page %}` tag is replaced with the page content. The previous examples would generate the following markup:

```html
<html>
    <body>
        <p>Hello, world!</p>
    </body>
</html>
```

Note that you can [render partials](./partials.md) in layouts. This lets you to share the common markup elements between different layouts. For example, you can have a partial that outputs the website CSS and JavaScript links. This approach simplifies the resource management - if you want to add a JavaScript reference you should modify a single partial instead of editing all the layouts.

The configuration section is optional for layouts. The supported configuration parameters are **name** and **description**. The parameters are optional and used in the back-end user interface. Example layout template with a description:

::: cmstemplate
```ini
description = "Basic layout example"
```
```twig
<html>
    <body>
        {% page %}
    </body>
</html>
```
:::

## Using a Dynamic Page Title

The `meta_title` and `meta_description` properties of a [page](pages.md) support parsing variables from the page life cycle. The following layout template will set the page title based on the value of the active page.

```html
<html>
    <head>
        <title>{{ this.page.meta_title }} - October CMS</title>
    </head>
    <body>
        {% page %}
    </body>
<html>
```

The page template can then define its title using Twig-like variable syntax using values that are available in the global environment, in this case the **post.title** value is used.

```ini
url = "/blog"
meta_title = "{{ post.title }} - Blog"
```

> **Note**: Only basic Twig variables are supported. Filters, tags and functions cannot be used.

## Placeholders

Placeholders allow pages to inject content to the layout. Placeholders are defined in the layout templates with the `{% placeholder %}` tag. The next example shows a layout template with a placeholder **head** defined in the HTML HEAD section.

```twig
<html>
    <head>
        {% placeholder head %}
    </head>
    ...
</html>
```

Pages can inject content to placeholders with the `{% put %}` and `{% endput %}` tags. The following example demonstrates a simple page template which injects a CSS link to the placeholder **head** defined in the previous example.

::: cmstemplate
```ini
url = "/my-page"
layout = "default"
```
```twig
{% put head %}
    <link href="/themes/demo/assets/css/page.css" rel="stylesheet">
{% endput %}

<p>The page content goes here.</p>
```
:::

More information on placeholders can be found [in the Markup guide](../markup/tag-placeholder.md).

## Dynamic Layouts

Layouts, like pages, can use any Twig features. Please refer to the [Dynamic Pages section](pages.md) of the documentation for details.

### Layout Execution Life Cycle

Inside the layout's PHP section you can define the following functions for handling the page execution life cycle: `onInit`, `onStart`, `onBeforePageStart` and `onEnd`.

The `onInit` function is executed when all components are initialized and before AJAX requests are handled. The `onStart` function is executed in the beginning of the page processing. The `onBeforePageStart` function is executed after the layout [components](./components.md) ran, but before the page's `onStart` function is executed. The `onEnd` function is executed after the page is rendered. The sequence the handlers are executed is following:

1. Layout `onInit()` function.
1. Page `onInit()` function.
1. Layout `onStart()` function.
1. Layout components `onRun()` method.
1. Layout `onBeforePageStart()` function.
1. Page `onStart()` function.
1. Page components `onRun()` method.
1. Page `onEnd()` function.
1. Layout `onEnd()` function.

### Method and Variable Access

The nearest context is used when accessing variables and methods inside partials, pages and layouts. Take the following [PHP code section](./themes.md) definition.

```php
function onStart()
{
    $this['myVariable'] = 'foo';
}

function myMethod()
{
    return 'bar';
}
```

In the above example, accessing `myVariable` or `this.myMethod()` inside Twig will check the existence in the following order:

1. Partial
1. Page
1. Layout

### Priority Layouts

Layouts can specify an `is_priority` attribute in their settings to activate priority mode. In normal circumstances, the layout contents render after the page contents. This allows the page to manipulate layout properties, like the title or meta description. Visually the order looks like this.

```text
Layout (3) ← Page (1) → Partials (2)
```

In priority mode, the layout uses a more natural load order where the `{% page %}` tag renders inline with the layout contents. However, there is no support for placeholders when using this mode. The priority layout load order looks more like this.

```text
Layout (1) → Page (2) → Partials (3)
```

This is particularly useful when [building API endpoints](../resources/building-apis.md). In the following example, the page logic will not run since the page tag is never called.

::: cmstemplate
```ini
description = "API Layout"
is_priority = 1
```
```twig
{% if false %}
    {% page %}
{% endif %}
```
:::

#### See Also

::: also
* [Page Twig Tag](../../markup/tag/page.md)
:::
---
subtitle: Store theme content changes in the database instead of the file system.
---
# Database-driven Themes

In some cases you may not have access to write to the filesystem to make changes to the theme. Database-driven themes allows you to store all changes to CMS templates in the database.

:::aside
Assets files like images and stylesheets do not save in the database and cannot be modified without access to the filesystem.
:::

To enable this feature for a single theme, navigate to **Settings → Frontend Theme**, select **Edit Properties** and check the checkbox called **Save Changes in Database**.

Alternatively you can enable this feature globally for all themes with the config item `cms.database_templates` or using the environment variable.

```text
CMS_DB_TEMPLATES=true
```

## Importing from Database to Filesystem

The `theme:copy` command can be used to copy the database version of the theme to the filesystem. Simply call the command with the `--import-db` option.

```bash
php artisan theme:copy demo --import-db
```

To delete all the database templates at the same time, use the `--purge-db` option.

```bash
php artisan theme:copy demo --import-db --purge-db
```
---
subtitle: Reuse chunks of HTML code anywhere in website.
---
# Partials

Partials are powerful elements that can repeat HTML on different pages or layouts, for example, a page footer used across different [page layouts](./layouts.md). Partials are also a powerful tool for dynamically [updating the page content with AJAX](../ajax/update-partials.md).

Partial templates files reside in the **partials** directory in your theme. Partial files should have the **htm** extension. Next is an example of the simplest possible partial.

```html
<p>This is a partial</p>
```

A configuration section is optional for partials and can contain the optional **description** parameter that is displayed in the backend user interface. This example shows a partial with a description defined.

::: cmstemplate
```ini
description = "Demo partial"
```
```html
<p>This is a partial</p>
```
:::

The partial configuration section can also contain component definitions. The [Components article](./components.md) explains components in more detail.

## Rendering Partials

::: aside
Remember that if you refer a partial from a subdirectory you should specify the subdirectory name.
:::

The `{% partial "partial-name" %}` Twig tag renders a partial. The tag has a single required parameter - the partial file name without the extension. The `{% partial %}` tag can be used inside a page, layout or another partial. The following is an example of a page referring to a partial.

```twig
<div class="sidebar">
    {% partial "sidebar-contacts" %}
</div>
```

## Passing Variables to Partials

You will find that you often need to pass variables to a partial from the external code. This makes partials even more useful. For example, you can have a partial that renders a list of blog posts. If you can pass the post collection to the partial, the same partial could be used on the blog archive page, on the blog category page and so on. You can pass variables to partials by specifying them after the partial name in the `{% partial %}` tag.

```twig
<div class="sidebar">
    {% partial "blog-posts" posts=posts %}
</div>
```

You can also provide new variables for use in the partial.

```twig
<div class="sidebar">
    {% partial "sidebar-contacts" city="Vancouver" country="Canada" %}
</div>
```

Inside the partial, variables can be accessed like any other markup variable.

```twig
<p>Country: {{ country }}, city: {{ city }}.</p>
```

### Variable Scope

The partial contents will have access to the variables from the current context and the additional ones provided.

```twig
{% partial "mypartial" foo="bar" %}
```

In the following example, the `foo` variable will be available inside the `mypartial` partial template.

```twig
{% set foo = "bar" %}
{% partial "mypartial" %}
```

You can disable access to the context by appending the `only` keyword. In this example, only the `foo` variable will be accessible.

```twig
{% partial "mypartial" foo="bar" only %}
```

In the next example, no variables will be accessible.

```twig
{% partial "mypartial" only %}
```

### Parsing Markup as a Variable

It is possible to pass markup to a partial by adding the `body` attribute to the partial tag.

```twig
{% partial "card" body %}
    This is the card contents
{% endpartial %}
```

The contents are available inside the partial as the `body` variable.

```twig
{{ body|raw }}
```

Combined with the [placeholder markup tag](../../markup/tag/placeholder.md), this lets you build composable partials.

```twig
{% partial "card" image="img.jpg" body %}
    {% put header %}
        <h2>This is the card header</h2>
    {% endput %}
    This is the card contents
{% endpartial %}
```

The **card** partial is composed of two content areas and an image variable.

```twig
<div class="header">
    <div class="image">
        <img src="{{ image }}" />
    </div>
    {% placeholder header %}
</div>
<div class="body">
    {{ body|raw }}
</div>
```

## Dynamic Partials

Partials, like pages, can use any Twig features. Please refer to the [Dynamic Pages section](pages.md) of the documentation for details.

### Partial Execution Life Cycle

There are special functions that can be defined in the PHP section of partials: `onStart` and `onEnd`. The `onStart` function is executed before the partial is rendered and before the [partial components](./components.md) are executed. The `onEnd` function is executed before the partial is rendered and after the partial components are executed. In the `onStart` and `onEnd` functions you can inject variables to the Twig environment. Use the `$this` with array notation to pass variables to the page.

::: cmstemplate
```ini
```
```php
<?
function onStart()
{
    $this['hello'] = "Hello world!";
}
?>
```
```twig
<h3>{{ hello }}</h3>
```
:::

Externally assigned variables to the partial can be accessed in PHP using the `$this` object.

::: cmstemplate
```ini
```
```php
<?
function onStart()
{
    $this['location'] = $this->city . ', ' . $this->country;
}
?>
```
```twig
<p>{{ location }} is the same as {{ city }}, {{ country }}.</p>
```
:::

The templating language provided by October CMS is described in the [Markup Guide](../../markup/templating.md). The overall sequence the handlers are executed is described in the [Dynamic Layouts section](./layouts.md) of the documentation.

### Calling AJAX Handlers in Partials

Since they are instantiated late, during the time the page is rendered, some limitations apply to the life cycle of regular partials. To overcome this, you may use the `{% ajaxPartial %}` to allow AJAX handlers to be called inside your partial.

```twig
{% ajaxPartial "contact-form" %}
```

::: tip
See the [AJAX Partial Twig Tag article](../../markup/tag/ajax-partial.md) to learn more about the `{% ajaxPartial %}` tag.
:::

When calling a handler from within an AJAX partial, the life cycle operates differently compared to a regular AJAX handler.

1. The handler runs after the partial's `onEnd` function.
1. The complete page life cycle runs, including logic in the layout, page and parent partials.
1. All variables are available during the request, including variables set using Twig.
1. The partial life cycle functions do not support returning any values.

#### See Also

::: also
* [Partial Twig Tag](../../markup/tag/partial.md)
* [AJAX Partial Twig Tag](../../markup/tag/ajax-partial.md)
:::
---
subtitle: Build your website using a simple file structure.
---
# Themes

::: aside
The active theme is set with the `active_theme` item in the `config/cms.php` file or via the  **Settings → Frontend Theme** backend panel. The backend setting overrides the value in the `config/cms.php` file.
:::

Themes are completely file-based and can be managed with any version control system, for example, Git. This page gives you a high-level description of October CMS themes. You will find more details about pages, partials, layouts and content files in the corresponding articles below.

Themes are directories that reside in the **themes** directory by default. Themes can contain the following objects:

Object | Description
------------- | -------------
[Pages](./pages.md) | represent the website pages.
[Partials](./partials.md) | contain reusable chunks of HTML markup.
[Layouts](./layouts.md) | define the page scaffold.
[Content Files](./content.md) | text, HTML, or [Markdown](http://daringfireball.net/projects/markdown/syntax) blocks that can be edited separately from the page or layout.
**Asset Files** | are resource files like images, CSS, and JavaScript files.

## Directory Structure

Below, you can see an example theme directory structure. Each theme represents a separate directory, and generally, one theme is active to display the website. This example demonstrates the **website** theme directory.

::: dir
├── themes
|   └── website  _← Theme Starts Here_
|       ├── `pages`
|       │   └── index.htm
|       ├── `layouts`
|       │   └── default.htm
|       ├── `partials`
|       │   └── sidebar.htm
|       ├── `content`
|       │   └── footer-contacts.md
|       └── `assets`
|           ├── css
|           |   └── my-styles.css
|           ├── js
|           └── images
:::

### Subdirectories

October CMS supports a depth of five subdirectories for **pages**, **partials**, **layouts** and **content** files, while the **assets** directory can have an unlimited depth. This approach simplifies the organization of large websites. In the example directory structure below, the **pages** and **partials** directories contain the **blog** subdirectory, and the **content** directory contains the **home** subdirectory.

::: dir
├── themes
|   └── website
|       ├── pages
|       │   ├── index.htm
|       │   └── `blog`  _← Page Subdirectory_
|       │       ├── index.htm
|       │       └── category.htm
|       ├── layouts
|       │   └── default.htm
|       ├── partials
|       │   ├── sidebar.htm
|       │   └── `blog`  _← Partial Subdirectory_
|       │       └── category-list.htm
|       ├── content
|       │   ├── footer-contacts.md
|       │   └── `home`  _← Content Subdirectory_
|       │       └── intro.md
|       └── assets
:::

To refer to a template in a subdirectory, specify the subdirectory's name before the template's name. For example, rendering the **category-list** partial from a **blog** subdirectory.

::: tip
The template paths are always absolute. If in a partial you render another partial from the same subdirectory, you still need to specify the subdirectory's name.

```twig
{% partial "blog/category-list" %}
```
:::

## Template Structure

Pages, partials and layout templates can include up to 3 sections: **configuration**, **PHP code**, and **Twig markup**. Sections are separated with the `==` sequence.

::: cmstemplate
```ini
url = "/blog"
layout = "default"
```
```php
function onStart()
{
    $this['posts'] = [...];
}
```
```twig
<h3>Blog archive</h3>
{% for post in posts %}
    <h4>{{ post.title }}</h4>
    {{ post.content }}
{% endfor %}
```
:::

### Configuration Section

The configuration section sets the template parameters. Supported configuration parameters are specific for different CMS templates and described in their corresponding documentation articles. The configuration section uses the simple [INI format](http://en.wikipedia.org/wiki/INI_file), where string parameter values are enclosed within quotes. Example configuration section for a page template:

```ini
url = "/blog"
layout = "default"

[component]
parameter = "value"
```

### PHP Code Section

The code in the PHP section executes every time before the template is rendered. The PHP section is optional for all CMS templates and its contents depend on the template type where it is defined. The PHP code section can contain optional open and close PHP tags to enable syntax highlighting in text editors. The open and close tags should always be specified on a different line to the section separator `==`.

::: cmstemplate
```ini
url = "/blog"
layout = "default"
```
```php
<?
function onStart()
{
    $this['posts'] = [...];
}
?>
```
```twig
<h3>Blog archive</h3>
{% for post in posts %}
    <h4>{{ post.title }}</h4>
    {{ post.content }}
{% endfor %}
```
:::

In the PHP section, you can only define functions and refer to namespaces with the PHP `use` keyword. No other PHP code is allowed in the PHP section. This is because the PHP section is converted to a PHP class when the page is parsed. Here is an example of using a namespace reference.

::: cmstemplate
```ini
url = "/blog"
layout = "default"
```
```php
<?
use Acme\Blog\Classes\Post;

function onStart()
{
    $this['posts'] = Post::get();
}
?>
```
```twig
```
:::

As a general way of setting variables, you should use the array access method on `$this`, although for simplicity you can use **object access as read-only**, for example:

```php
// Write via array
$this['foo'] = 'bar';

// Read via array
echo $this['foo'];

// Read-only via object
echo $this->foo;
```

When defining functions, they become available as methods via the `$this` property in PHP and `this` variable in Twig. The following example defines a **doSomething** function and calls the method in both places.

::: cmstemplate
```ini
url = "/"
```
```php
function onStart()
{
    $this['foo'] = $this->doSomething();
}

function doSomething()
{
    return 'bar';
}
```
```twig
<h3>{{ this.doSomething() }}</h3>
```
:::

### Twig Markup Section

The Twig section defines the markup to be rendered by the template. In the Twig section, you can use functions, tags, and filters [provided by October CMS](../../markup/templating.md), all the [native Twig features](https://twig.symfony.com/doc/), or [those provided by plugins](../../extend/twig-tags.md). The content of the Twig section depends on the template type (page, layout, or partial). You can find more information about specific Twig objects further in the documentation.

::: tip
More information can be found in [the Markup guide](../../markup/templating.md).
:::

## Theme Logging

Since layouts and pages store most of the data in flat files, you or your clients can lose content accidentally. For example, switching the layout of a page will modify the scaffold of the page and, as such, will result in data loss.

October CMS can record every change made to a theme called Theme Logging, and this feature is disabled by default. To enable Theme Logging, go to **Settings → Log Settings** and enable **Log Theme Changes**.

You may now view the theme changelog via **Settings → Theme Log** where you can observe an overview of each change. You can use this information to decide the appropriate action to aid the regression of these changes, if necessary.

#### See Also

::: also
* [CMS Markup Guide](../../markup/templating.md)
:::
---
subtitle: Build observable HTML controls tethered to JavaScript.
---
# Hot Controls

October CMS includes a simple implementation of [MutationObserver](https://developer.mozilla.org/en-US/docs/Web/API/MutationObserver), where you can define HTML controls that detect when they are added or removed from the page. Now it's possible to initialize or uninitialize controls that are added or removed via [AJAX](./update-partials.md) or [turbo router](./turbo-router.md) updates.

## Registering an Observable Control

::: aside
This function can be called multiple times and it will take the **last seen definition**.
:::

In its basic form, the `oc.registerControl` JavaScript function is used to define a unique control name (first argument) and class definition (second argument) that extends the `oc.ControlBase` base class.

```js
oc.registerControl('hello', class extends oc.ControlBase {
    // ...
});
```

The control name is used to link to a DOM element representing the control, using the `data-control` attribute. For example, a control registered with the name **hello** monitors the page for any element with the `data-control="hello"` attribute attached to it.

```html
<div data-control="hello"></div>
```

The `connect` and `disconnect` methods within the class definition are triggered whenever the control is added or removed from the page. This can occur at any time, as the observer continuously monitors for DOM changes.

```js
class extends oc.ControlBase {
    connect() {
        // Element has appeared in DOM
    }

    disconnect() {
        // Element was removed from DOM
    }
}
```

## Initializing a Control

The `init` method allows you to load the default configuration for the control and configure its child elements.

```js
class extends oc.ControlBase {
    init() {
        // Establish the control before running logic
    }
}
```

::: tip
The `init` method is called once per control and `connect` is called every time the control is added or removed from the DOM, for example, when moving the element to a new location.
:::

### Configuration

All `data-` attributes on the control element make up its available configuration.

```html
<div data-control="hello" data-favorite-color="red"></div>
```

Configuration values can be accessed via the `this.config` property. The data attributes are converted from to camelCase, without the `data-` prefix, for example, the `data-favorite-color` attribute is accessed as `this.config.favoriteColor`.

```js
class extends oc.ControlBase {
    init() {
        this.favoriteColor = this.config.favoriteColor || 'green';
    }

    connect() {
        console.log(`Favorite color? ${this.favoriteColor}!`);
    }
}
```

### Child Elements

Any selector, whether CSS or data attributes, can be used to select child elements within the parent control class.

```html
<div data-control="hello">
    <input class="name" disabled />
</div>
```

The parent control element is available via `this.element`. Any child element can be selected with `querySelector` for a single element, or `querySelectorAll` for multiple elements.

```js
class extends oc.ControlBase {
    init() {
        this.$name = this.element.querySelector('input.name');
    }

    connect() {
        this.$name.value = 'Jeff';
        this.$name.disabled = false;
    }
}
```

## Referencing Other Controls

The `oc.fetchControl` function is used to return a control instance from an existing control element, this accepts a selector string, or an element directly. The resulting instance support method calls or accessing properties found on the control class definition.

```js
const searchControl = oc.fetchControl(element);
```

You may also pass a selector string, along with the control name as the second argument (optional). This is useful when multiple controls are bound to the same element and you want to clarify the exact identifier.

```js
const searchControl = oc.fetchControl('[data-control=search]', 'search');
```

The `oc.importControl` function can be used to return a control class that has been registered, which can be useful for calling static methods on the class. The function accepts the control identifier as a string.

```js
const searchControlClass = oc.importControl('search');
```

The `oc.observeControl` function is used to immediately resolve a control instance and attach it to the element. This is useful when an element does not have the `data-control` attribute and you want to attach it without waiting for the observer events.

```js
const searchControl = oc.observeControl(element, 'search');
```

## Working with Events

Observable controls can bind events either locally or globally. Local events are automatically unbound, while global events need to be manually unbound using the `disconnect` method.

### Local Events

You can bind a local event handler using the `listen` function, and these handlers will automatically unbind. To bind a listener to the control element itself, pass the event name and the event handler function to the `listen` function.

```js
class extends oc.ControlBase {
    connect() {
        this.listen('dblclick', this.onDoubleClick);
    }

    onDoubleClick() {
        console.log('You double clicked my control!');
    }
}
```

To bind a local event handler to a child element, pass the event name, CSS selector, and event handler function.

```js
class extends oc.ControlBase {
    connect() {
        this.listen('click', '.toolbar-find-button', this.onClickFindButton);
    }

    onClickFindButton() {
        console.log('You clicked the find button inside the control!');
    }
}
```

You may also bind to a DOM object, pass the event name, HTML element, and the event handler function.

```js
class extends oc.ControlBase {
    init() {
        this.$name = this.element.querySelector('input.name');
    }

    connect() {
        this.listen('click', this.$name, this.onClickNameInput);
    }

    onClickNameInput() {
        console.log('You clicked the name input inside the control!');
    }
}
```

### Global Events

Global events can be attached and removed using the `addEventListener` and `removeEventListener` native JavaScript functions. The event handler (second argument) refers to the class method of the same control instance. The `proxy` method is called to bind the current context to the function call.

```js
class extends oc.ControlBase {
    connect() {
        addEventListener('keydown', this.proxy(this.onKeyDown));
    }

    disconnect() {
        removeEventListener('keydown', this.proxy(this.onKeyDown));
    }

    onKeyDown(event) => {
        if (event.key === 'Escape') {
            // Escape button was pressed
        }
    }
}
```

::: tip
To prevent memory leaks, it is important to unbind global events so they are captured by garbage collection.
:::

### Dispatching Events

Controls can dispatch events by passing an event name to the `dispatch` function. The event is triggered on the DOM element and the event name is prefixed with the control name. In the following example, if the control is registered with a name **hello**, the event will be named **hello:ready**.

```js
oc.registerControl('hello', class extends oc.ControlBase {
    connect() {
        this.dispatch('ready');
    }
});
```

Now you can listen when the control is connected and grab the object using `oc.fetchControl` on the event target.

```js
addEventListener('hello:ready', function(ev) {
    const helloControl = oc.fetchControl(ev.target);
});
```

The second argument contains options where you may pass `detail` to the event, the following detail data is accessible via **ev.detail.foo** in the listener.

```js
this.dispatch('ready', { detail: {
    foo: 'bar'
}});
```

You may also specify a different `target` where the default is the attached element.

```js
this.dispatch('ready', { target: window });
```

Setting the `prefix` to false will make the event name global, the following triggers an event name of **hello-ready** instead of **hello:hello-ready**.

```js
this.dispatch('hello-ready', { prefix: false });
```

## Usage Examples

### Vanilla JS Example

The following example demonstrates a basic HTML form that includes a name input and a greeting button. The control class initializes the input and output elements, and then listens for the click event on the Greet button. When the Greet button is clicked, the output element displays a greeting that includes the entered name.

```html
<div data-control="hello-world">
    <input type="text" class="name" />

    <button class="greet">
        Greet
    </button>

    <span class="output">
    </span>
</div>

<script>
oc.registerControl('hello-world', class extends oc.ControlBase {
    init() {
        this.$name = this.element.querySelector('input.name');
        this.$output = this.element.querySelector('span.output');
    }

    connect() {
        this.listen('click', 'button.greet', this.onGreet);
    }

    onGreet() {
        this.$output.textContent = `Hello, ${this.$name.value}!`;
    }
});
</script>
```

### Google Maps Example

The following example shows a simple implementation of a third-party JavaScript library, such as Google Maps API. The library `Map` is initialized on the control `div` element when it is seen on the page. When the control is removed from the page, it prevents memory leaks by calling `destroy` on the map instance and setting the property to `null`.

```html
<div data-control="google-map"></div>

<script>
oc.registerControl('google-map', class extends oc.ControlBase {
    connect() {
        this.map = new Map(this.element, {
            center: { lat: -34.397, lng: 150.644 },
            zoom: 8
        });
    }

    disconnect() {
        this.map.destroy();
        this.map = null;
    }
});
</script>
```

### Vue.js Example

The next example shows how you can bring your own technology to build dynamic user interfaces, in this case [using Vue.js](https://vuejs.org/guide/essentials/event-handling.html) as a technology. The Vue instance, or ViewModel (vm) is created and disposed as needed.

```html
<div data-control="my-vue-control">
    <div data-vue-template>
        <button @click="greet">Greet</button>
    </div>
</div>

<script>
oc.registerControl('my-vue-control', class extends oc.ControlBase {
    connect() {
        this.vm = new Vue({
            el: this.element.querySelector('[data-vue-template]'),
            data: {
                name: 'October CMS'
            },
            methods: {
                greet: this.greet
            }
        });
    }

    disconnect() {
        this.vm.$destroy();
    }

    greet(event) {
        alert('Hello ' + this.name + '!')
    }
});
</script>
```

You can also use hot controls to initialize Vue components using the `Vue.component` method, making them available to your controls. The following becomes available as `<my-vue-component></my-vue-component>` within Vue, however, it is important that these templates are registered before they are used by other controls.

```html
<div data-control="my-vue-component">
    <button @click="greet">Greet</button>
</div>

<script>
oc.registerControl('my-vue-component', class extends oc.ControlBase {
    init() {
        Vue.component('my-vue-component', {
            template: this.element,
            methods: {
                greet: this.greet
            }
        });
    }

    connect() {
        this.element.style.display = 'none';
    }

    greet(event) {
        alert('Hello!');
    }
});
</script>
```
---
subtitle: Learn more about the updating your content dynamically.
---
# Updating Partials

When a handler executes it may prepare partials that are updated on the page, either by pushing or pulling, which can be rendered with some supplied variables.

## Pulling Partial Updates

The client browser may request partials to be updated from the server when it performs an AJAX request, which is considered *pulling a content update*.

Using the [`{% partial %}` tag](../../markup/tag/partial.md), the following code renders the **mytime** partial inside a `#myDiv` element on the page when calling the `onRefreshTime` [event handler](./handlers.md).

```twig
<div id="myDiv">
    {% partial 'mytime' %}
</div>
```

The [data attributes API](./attributes-api.md) uses the `data-request-update` attribute.

```html
<!-- Attributes API -->
<button
    data-request="onRefreshTime"
    data-request-update="{ mytime: '#myDiv' }">
    Go
</button>
```

The [JavaScript API](./javascript-api.md) uses the `update` configuration option:

```js
// JavaScript API
oc.request('#mybutton', 'onRefreshTime', {
    update: { mytime: '#myDiv' }
});
```

### Self-Updating Partials

The [`{% ajaxPartial %}` tag](../../markup/tag/ajax-partial.md) is dedicated to rendering AJAX partials.

```twig
{% ajaxPartial 'mytime' %}
```

When using this tag, the contents are wrapped in a container for you, so you can update the partial by name alone. Simply pass the `true` value instead of a container selector.

```html
<button
    data-request="onRefreshTime"
    data-request-update="{ mytime: true }">
    Go
</button>
```

You may also use the partial name `_self` for updating a partial from within itself.

```js
{ _self: true }
```

::: tip
See the [AJAX Partial Twig Tag article](../../markup/tag/ajax-partial.md) to learn more about the `{% ajaxPartial %}` tag.
:::

### Global Partial Updates

In some cases, such as with [flash messages](../../cms/features/flash-messages.md), you may wish to include a specific partial update with every response. To merge an update definition with every AJAX request, add the `ajax-request-update` meta tag in the head section of the page, and set the content attribute to an update definition.

```html
<head>
    <meta name="ajax-request-update" content="{ flash-messages: true }" />
</head>
```

## Update Definition

The definition of what should be updated is specified as a JSON-like object where:

- the left side (key) is the **partial name**
- the right side (value) is the **target element** to update

The following will request to update the `#myDiv` element with **mypartial** contents.

```js
{ mypartial: '#myDiv' }
```

::: tip
The selector must start with a `#` or `.` character to be valid.
:::

Multiple partials are separated by commas.

```js
{ firstpartial: '#myDiv', secondpartial: '#otherDiv' }
```

If the partial name contains a slash or a dash, it is important to 'quote' the left side.

```js
{ 'folder/mypartial': '#myDiv', 'my-partial': '#myDiv' }
```

The target element will always be on the right side since it can also be a HTML element in JavaScript.

```js
{ 'folder/mypartial': document.getElementById('myDiv') }
```

### Appending and Prepending Content

If the selector string is prepended with the `@` symbol, the content received from the server will be appended to the element, instead of replacing the existing content.

If the selector string is prepended with the `^` symbol, the content will be prepended instead.

```js
{ 'folder/append-partial': '@#myDiv' }

{ 'folder/prepend-partial': '^#myDiv' }
```

Alternatively, you may add the `data-ajax-update-mode` attribute to the target element.

```html
<div id="myDiv" data-ajax-update-mode="append"></div>

<div id="myDiv" data-ajax-update-mode="prepend"></div>
```

### Using Custom HTML Selectors

If the selector string begins with an `=` symbol, then you can use any custom HTML selector to target an element.

```js
{ 'folder/append': '=[data-field-name="address"]' }
```

## Pushing Partial Updates

Comparatively, [AJAX handlers](./handlers.md) can push content updates to the client-side browser from the server-side. To push an update the handler returns an array where the key is a HTML element to update (using a simple CSS selector) and the value is the content to update.

::: aside
The key name must start with an identifier `#` or class `.` character to trigger a content update.
:::

The following example will update an element on the page with the id **myDiv** using the contents found inside the partial **mypartial**. The `onRefreshTime` handler calls the `renderPartial` method to render the partial contents in PHP.

```php
function onRefreshTime()
{
    return [
        '#myDiv' => $this->renderPartial('mypartial')
    ];
}
```

## Passing Variables to Partials

Depending on the execution context, an [AJAX event handler](./handlers.md) makes variables available to partials differently.

- Use `$this[]` inside a page or layout [PHP section](../themes/themes.md).
- Use `$this->page[]` inside a [component class](../themes/components.md).
- Use `$this->vars[]` in the [backend area](../../extend/system/controllers.md).

These examples will provide the **result** variable to a partial for each context:

```php
// From page or layout PHP code section
$this['result'] = 'Hello world!';

// From a component class
$this->page['result'] = 'Hello world!';

// From a backend controller or widget
$this->vars['result'] = 'Hello world!';
```

This value can then be accessed using Twig in the partial:

```twig
<!-- Hello world! -->
{{ result }}
```
---
subtitle: October CMS ships with a simple and lean AJAX framework.
---
# Introduction

October CMS includes an AJAX framework that brings a full suite of capabilities, allowing you to load data from the server without refreshing the browser. The same library can be used in CMS themes and anywhere in the admin panel.

The AJAX framework comes in two flavors, you may either use [the JavaScript API](./javascript-api.md) or [the data attributes API](./attributes-api.md). The data attributes API doesn't require any JavaScript knowledge to use AJAX with October CMS.

## Including the Framework

::: aside
The AJAX framework is optional in your CMS theme and you can always include your preferred framework instead.
:::

When working with your [CMS theme](../../cms/themes/themes.md), using the library is as simple as including it with a Twig tag. Place the `{% framework %}` tag anywhere inside your page or layout. This adds a reference to the October CMS frontend JavaScript library, for example.

```twig
{% framework %}
```

### Extra Features

The `{% framework %}` tag supports an optional **extras** parameter that includes additional StyleSheet and JavaScript files, for extra features including [form validation](../features/validation.md), [loading indicators](../features/loaders.md), and [flash messages](../features/flash-messages.md).

```twig
{% framework extras %}
```

You may also include the **turbo** parameter to enable [turbo-charged routing](./turbo-router.md) on every page.

```twig
{% framework extras turbo %}
```

## How AJAX Requests Work

A page can issue an AJAX request either prompted by data attributes or by using JavaScript. Each request invokes an **event handler** -- also called an [AJAX handler](./handlers.md) -- on the server and can update page elements using partials. AJAX requests work best with forms, since the form data is automatically sent to the server. Here is request workflow:

1. The client browser issues an AJAX request by providing the handler name and other optional parameters.
2. The server finds the [AJAX handler](./handlers.md) and executes it.
3. The handler executes the required business logic and updates the environment by injecting page variables.
4. The server [renders partials](./update-partials.md) requested by the client with the `update` option.
5. The server sends the response, containing the rendered partials markup.
6. The client-side framework updates page elements with the partials data received from the server.

## Usage Example

Below is a simple example that uses the data attributes API to define an AJAX enabled form. The form will issue an AJAX request to the **onTest** handler and requests that the result container be updated with the **mypartial** partial markup.

::: tip
The form data for `value1` and `value2` are automatically sent with the AJAX request.

```html
<!-- AJAX enabled form -->
<form data-request="onTest" data-request-update="{ mypartial: '#myDiv' }">

    <!-- Input two values -->
    <input name="value1"> + <input name="value2">

    <!-- Action button -->
    <button type="submit">Calculate</button>

</form>

<!-- Result container -->
<div id="myDiv"></div>
```
:::

The **mypartial** partial contains markup that reads the `result` variable.

```twig
<p>The answer is {{ result }}</p>
```

The **onTest** handler method accessed the form data using the `input` [helper method](../../extend/services/helpers.md) and the result is passed to the `result` page variable.

```php
function onTest()
{
    $this->page['result'] = input('value1') + input('value2');
}
```

The example could be read like this: "When the form is submitted, issue an AJAX request to the **onTest** handler. When the handler finishes, render the **mypartial** partial and inject its contents to the **#myDiv** element."

#### See Also

::: also
* [JavaScript API](./javascript-api.md)
* [Data Attributes API](./attributes-api.md)
:::
---
subtitle: Interact with handlers using JavaScript code.
---
# JavaScript API

The JavaScript API is more powerful than the data attributes API. The `oc.request` method can be used with any element that is inside a form, or on a form element. When the method is used with an element inside a form, it is forwarded to the form.

The `oc.request` takes the target element and AJAX handler name as the first and second arguments. The target element can be a selector string or a HTML element. For example:

```html
<form onsubmit="oc.request(this, 'onProcess'); return false;">
    ...
```

The third argument of the `oc.request` method is an options object. The following options are specific for the October CMS framework.

Option | Description
------------- | -------------
**update** | an object, specifies a list partials and page elements (as CSS selectors) to update: `{'partial': '#select'}`. The selector string should start with a `#` or `.` character, except you may also prepend it with `@` to append contents to the element, `^` to prepend, `!` to replace with and `=` to use any CSS selector.
**confirm** | the confirmation string. If set, a confirmation dialog is displayed before the request is sent. If the user clicks the Cancel button, the request cancels.
**data** | an optional object specifying data to be sent to the server along with the form data: `{var: 'value'}`. You may also include files to be uploaded in this object by using [`Blob` objects](https://developer.mozilla.org/en-US/docs/Web/API/Blob). To specify the filename of any `Blob` objects, simply set the `filename` property on the `Blob` object. (Eg. `var blob = new Blob(variable); blob.filename = 'test.txt'; var data = {uploaded_file: blob};`)
**query** | an optional object specifying data to be added to the current URL query string.
**headers** | an optional object specifying header values to be sent to the server with the request.
**redirect** | string specifying an URL to redirect the browser to after the successful request.
**beforeUpdate** | a callback function to execute before page elements are updated. The `this` variable inside the function resolves to the request content - an object containing 2 properties: `handler` and `options` representing the original request() parameters.
**afterUpdate** | a callback function identical to `beforeUpdate` except it executes after the page elements are updated.
**success** | a callback function to execute in case of a successful request. If this option is supplied it overrides the default framework functionality: the elements are not updated, the `beforeUpdate` and `afterUpdate` callbacks are not triggered, the `ajax:update` and `ajax:update-complete` events are not triggered. To call the default framework functionality, use `this.success(...)` inside your function.
**error** | a callback function execute in case of an error. By default the alert message is displayed. If this option is overridden the alert message won't be displayed.
**complete** | a callback function execute in case of a success or an error.
**cancel** | a callback function execute in case the user aborts the request or cancels it via a confirmation dialog.
**form** | a form element to use for sourcing the form data sent with the request, either passed as a selector string or a form element.
**flash** | when true, instructs the server to clear and send any flash messages with the response. default: `false`
**files** | when true, the request will accept file uploads using the `FormData` interface. default: `false`
**download** | when true, file downloads are accepted with a `Content-Disposition` response. When a string, the downloaded filename can be specified. default: `false`
**bulk** | when true, the request be sent as JSON for bulk data transactions. default: `false`
**browserValidate** | when true, browser-based client side validation will be performed on the request before submitting. Only applies to requests triggered in the context of a `<form>` element.
**message** | displays a progress message with the specified text, shown while the request is running. This option is used by the [flash messages features](../features/flash-messages.md).
**loading** | an optional string or object to be displayed when a request runs. The string should be a CSS selector for an element or the object should support the `show()` and `hide()` functions to manage the visibility.
**progressBar** | enable the [progress bar](../features/loaders.md) when an AJAX request occurs.

The **beforeUpdate**, **afterUpdate**, **success**, **error**, and **complete** options all take functions with three arguments: the data object received from the server, the HTTP status code and the XHR object.

```js
success: function(data, responseCode, xhr) { }
```

You may also override some of the request logic by passing new functions as options. These logic handlers are available.

Handler | Description
------------- | -------------
**handleConfirmMessage(message, promise)** | called when requesting confirmation from the user.
**handleErrorMessage(message)** | called when an error message should be displayed.
**handleValidationMessage(message, fields)** | focuses the first invalid field when validation is used.
**handleFlashMessage(message, type)** | called when a flash message is provided using the **flash** option (see above).
**handleRedirectResponse(url)** | called when the browser should redirect to another location.

## Usage Examples

Request a confirmation before the `onDelete` request is sent.

```js
oc.request('#myform', 'onDelete', {
    confirm: 'Are you sure?',
    redirect: '/dashboard'
});
```

Run `onCalculate` handler and inject the rendered **calcresult** partial into the page element with the **result** CSS class.

```js
oc.request('#myform', 'onCalculate', {
    update: { calcresult: '.result' }
})
```

Run `onCalculate` handler with some extra data.

```js
oc.request('#myform', 'onCalculate', { data: { value: 55 } })
```

Run `onCalculate` handler and run some custom code before the page elements update.

```js
oc.request('#myform', 'onCalculate', {
    update: { calcresult: '.result' },
    beforeUpdate: function() { /* do something */ }
})
```

Run `onCalculate` handler and if successful, run some custom code after the page elements are updated.

```js
oc.request('#myform', 'onCalculate', {
    afterUpdate: function() { /* do something */ }
})
```

Use the `oc.ajax` method to execute a request without a FORM element.

```js
oc.ajax('onCalculate', {
    success: function() {
        console.log('Finished!');
    }
})
```

Run `onCalculate` handler and if successful, run some custom code after the default `success` function is done.

```js
oc.request('#myform', 'onCalculate', {
    success: function(data) {
        this.success(data).done(function() {
            // ... do something after parent success() is finished ...
        });
    }
})
```

## Global AJAX Events

The AJAX framework triggers events on the updated elements, triggering element, form, and window object. The events are triggered regardless of which API was used - the data attributes API or the JavaScript API.

Extra details are available on the `event.detail` property of the event handler. Unless otherwise specified, the handler details are the `context` object, the `data` object received from the server, the `responseCode` and the `xhr` object.

Event | Description
------------- | -------------
**ajax:before-send** | triggered on the window object before sending the request. The handler details provide the `context` object.
**ajax:before-update** | triggered on the form object directly after the request is complete, but before the page is updated.
**ajax:update** | triggered on a page element after it has been updated with the framework.
**ajax:update-complete** | triggered on the window object after all elements are updated by the framework.
**ajax:request-success** | triggered on the form object after the request is successfully completed. The handler gets 5 parameters: the event object, the context object, the data object received from the server, the status text string, and the XHR object.
**ajax:request-error** | triggered on the form object if the request encounters an error.
**ajax:error-message** | triggered on the window object if the request encounters an error. The handler has a `message` detail with the error message returned from the server.
**ajax:confirm-message** | triggered on the window object when `confirm` option is given. The handler has a `message` detail with a text message assigned to the handler as part of `confirm` option. A `promise` detail is also provided to defer or cancel the outcome, this is useful for implementing custom confirm logic/interface instead of native javascript confirm box.

These events are fired on the triggering element:

Event | Description
------------- | -------------
**ajax:setup** | triggered before the request is formed. The handler details provide the `context` object, allowing options to be modified via the `context.options` property.
**ajax:promise** | triggered directly before the AJAX request is sent. The handler details provide the `context` object.
**ajax:fail** | triggered finally if the AJAX request fails.
**ajax:done** | triggered finally if the AJAX request was successful.
**ajax:always** | triggered regardless if the AJAX request fails or was successful.

## Usage Examples

Executes JavaScript code when the `ajax:update` event is triggered on an element.

```js
document.querySelector('#result').addEventListener('ajax:update', function() {
    console.log('Updated!');
});
```

Execute a single request that shows a Flash Message using logic handler.

```js
oc.ajax('onDoSomething', {
    flash: true,
    handleFlashMessage: function(message, type) {
        oc.flashMsg({ message: message, type: type });
    }
});
```

Applies configurations to all AJAX requests globally.

```js
addEventListener('ajax:setup', function(event) {
    const { options } = event.detail.context;

    // Enable AJAX handling of Flash messages on all AJAX requests
    options.flash = true;

    // Disable the progress bar for all AJAX requests
    options.progressBar = false;

    // Handle Error Messages by triggering a flashMsg of type error
    options.handleErrorMessage = function(message) {
        oc.flashMsg({ message: message, type: 'error' });
    }

    // Handle Flash Messages by triggering a flashMsg of the message type
    options.handleFlashMessage = function(message, type) {
        oc.flashMsg({ message: message, type: type });
    }
});
```

Using a supplied `promise` from the event detail.

```js
addEventListener('ajax:confirm-message', function(event) {
    const { message, promise } = event.detail;

    // Prevent default behavior
    event.preventDefault();

    // Handle promise
    if (confirm(message)) {
        promise.resolve();
    }
    else {
        promise.reject();
    }
});
```

Animating an element after a specific AJAX handler completes its update.

```js
addEventListener('ajax:update-complete', function(event) {
    const { handler } = event.detail.context;

    // If the handler is either of the following
    if (['onRemoveFromCart', 'onAddToCart'].includes(handler)) {

        // Run an animation for 2 seconds
        var el = document.querySelector('#miniCart');
        el.classList.add('animate-shockwave');
        setTimeout(function() { el.classList.remove('animate-shockwave'); }, 2000);
    }
});
```
# Extra Features

This page has moved to a new section. Redirecting...

<Redirect to="../features/validation" />
---
subtitle: Learn how links are routed using the AJAX framework.
---
# Turbo Router

Turbo routing is an implementation of PJAX (push state and AJAX) that gives the performance benefits of a single page application without the added complexity of a client-side framework. When you click a link, the page is automatically swapped client-side without the cost of a full page load.

```twig
{% framework turbo %}
```

## Routing Links

You may programmatically visit a link with the following.

```js
oc.visit(location);
```

To replace the current URL without adding it to the navigation history, similar to `window.history.replaceState`, set the `action` option to **replace**.

```js
oc.visit(location, { action: 'replace' });
```

To check if the turbo router is enabled and should be used.

```js
if (oc.useTurbo && oc.useTurbo()) {
    // Use PJAX
}
```

## Disable Routing

To disable PJAX routing on a specific page, you may trigger a full reload by including the `turbo-visit-control` meta tag in the head section of the page with the `reload` value. This will disable the feature for incoming requests only.

```html
<head>
    <meta name="turbo-visit-control" content="reload" />
</head>
```

To completely disable PJAX in your website, set the value to `disable`. This will disable the feature for all incoming and outgoing requests.

```html
<meta name="turbo-visit-control" content="disable" />
```

## Disable for Specific Links

By default, all internal HTML links will be routed using PJAX, but you can disable this by marking links or their parent container with `data-turbo="false"`. Links that are disabled are handled normally by the browser.

```html
<a href="/" data-turbo="false">Disabled</a>
```

You may re-enable when an ancestor has disabled:

```html
<div data-turbo="false">
    <a href="/" data-turbo="true">Enabled</a>
</div>
```

## Disable Visit Scrolling

Every visit scrolls to the top of the page like most links in a browser. However, in some cases preserving the scroll position is useful, such as situations where links act like filters. You may disable visit scrolling using the `data-turbo-no-scroll` attribute on the link element.

```html
<a href="/" data-turbo-no-scroll>Filter</a>
```

## Persisting Page Elements

In some cases you may want to include static elements on the page, these are elements that should not be refreshed when the page updates. Use the `data-turbo-permanent` attribute on the parent element. The element must also supply and `id` attribute so the original page can be matched with the new page, including event listeners.

```html
<div id="main-navigation" data-turbo-permanent>...</div>
```

## Setting a Root Path

By default, PJAX is used for all links within the same domain name and a visit to any other URL will fallback to a full page load. In some cases, your application may live in a subdirectory and the links should only apply to the root path.

For example, if you website lives in `/app` and you don't want the links to apply to a different site in `/docs` then you may restrict the links to a root path. You may set the root path by including the `turbo-root` meta tag in the page's head section.

```html
<head>
    <meta name="turbo-root" content="/app">
</head>
```

## Native Error Pages

When using PJAX and the server responds with an error code, such as 404 or 500 status, the complete html element is replaced, including scripts and stylesheets. This prevents accidentally replacing the body element with content not produced by the same application code.

You may disable this behavior by including the `turbo-visit-control` meta tag in the head section of the page with the `error` value. This will tell the turbo router that the error page content is produced by the native application.

```html
<meta name="turbo-visit-control" content="error">
```

## Page Caching

With caching enabled, the turbo router speeds up a website's performance by displaying revisited pages without accessing the network, making the website feel faster. When clicking a link, the contents are shown from the browser's local storage while the page requests the background. The latest page shows when the network request is complete, meaning the page renders twice.

### Listening for the Cache Event

You may listen to the `page:before-cache` event if you need to prepare the document before it enters the cache. You can use this for things like resetting forms, collapsing UI elements or tearing down any third-party controls, so the page is ready to be displayed again.

```js
addEventListener('page:before-cache', function() {
    // Close any open submenus, etc.
});
```

### Detecting a Cached Page Load

You can detect when the page contents are sourced from the cache with the `data-turbo-preview` attribute on the HTML element. Expressed in JavaScript as the following.

```js
if (document.documentElement.hasAttribute('data-turbo-preview')) {
    // Page shown is loaded from cache
}
```

Or using a StyleSheet with the following.

```css
html[data-turbo-preview] {
    /* Hide overlays from previous view */
}
```

### Disabling the Cache

You can disable the page cache for individual pages by using the `turbo-cache-control` meta tag in the page's head section. Settings this value to **no-cache** will disable the cache entirely. You can also set this to **no-preview** to keep the cached version when navigating using the browser's Back and Forward buttons.

```html
<head>
    <meta name="turbo-cache-control" content="no-cache">
</head>
```

## Working with JavaScript

When working with PJAX, the page contents may load dynamically, which differs from the usual browser behavior. To overcome this, use the `render` event handler is called every time the page loads, including [AJAX updates](./update-partials.md).

```js
addEventListener('render', function() {
    // Page has rendered something new
});
```

The `oc.pageReady` function is used call code when the page and scripts are ready. The function returns a promise that is resolved after all the page scripts have loaded, or immediately if they are already loaded.

```js
oc.pageReady().then(() => {
    // Page has finished loading scripts
});
```

The `oc.waitFor` is another useful function that will wait for an object or variable to exist. The function returns a promise that is resolved when the variable is found.

```js
oc.waitFor(() => window.propName).then(() => [
    // window.propName is now available
]);
```

The second argument provides a timeout interval in milliseconds, the following will stop waiting after two seconds.

```js
oc.waitFor(() => window.propName, 2000).then(() => {
    console.log('Found the variable!')
}).catch(() => {
    console.error('Gave up waiting...')
});
```

### Inline Script Elements

The turbo router maintains the scripts within the `<head>` tag of the page by comparing the differences. If you use script tags in the `<body>` tag then the script will be executed every time the page renders, which may be undesirable.

You may include `data-turbo-eval="false"` to only allow the script to be executed on the first page load. The script will not be called for any PJAX requests.

```html
<body>
    <script data-turbo-eval="false" src="{{ ['@framework.bundle']|theme }}"></script>
</body>
```
::: tip
If you are placing scripts in the `<body>` tag for performance reasons, consider moving it to the `<head>` tag and using `<script defer>` instead.
:::

To execute inline JavaScript code only once, regardless of first page load or PJAX request, set a unique value to the `data-turbo-eval-once` attribute. The unique value (e.g `myAjaxPromise`) is used to determine if the script has been seen before.

```html
<script data-turbo-eval-once="myAjaxPromise">
    // This script will run once only
    addEventListener('ajax:promise', function(event) {
        //
    });
</script>
```

### Making Controls Idempotent

::: aside
October CMS provides a complimentary library that is used to make building [idempotent controls](./hot-controls.md) easy.
:::

When a page visit occurs and JavaScript components are initialized, it is important that these function are idempotent. In simple terms, an idempotent function is safe to apply multiple times without changing the result beyond its initial application.

One technique for making a function idempotent is to keep track of whether you've already performed it by adding a value to the `dataset` property on each processed element. This is useful for external scripts.

```js
addEventListener('page:loaded', function() {
    // Find my control
    var myControl = document.querySelector('.my-control');

    // Check if control has already been initialized
    if (!myControl.dataset.hasMyControl) {
        myControl.dataset.hasMyControl = true;

        // Initialize since this is the first time
        initializeMyControl(myControl);
    }
});
```

As general advice, a simpler approach is to allow the function to run multiple times and apply idempotence techniques internally. For example, check to see if a menu divider already exists first before creating a new one.

### Disposing Controls

In some cases you may bind global events for a specific page only, for example, binding a hot key to a certain action.

```js
addEventListener('keydown', myKeyDownFunction);
```

To prevent this event from leaking to other pages, you should remove the event using the `page:unload` method, which will destroy any events and controls. The event can be used once to dispose of controls and events safely.

```js
addEventListener('page:unload', function() {
    removeEventListener('keydown', myKeyDownFunction);
}, { once: true });
```

::: tip
October CMS includes a complimentary library for [building disposable controls](./hot-controls.md).
:::

### Pause Rendering

If you would like to animate some elements like dropdowns or off-canvas menus before loading a new page, you can pause the `page:before-render` event by preventing the default behavior and resuming it with the `resume()` function in the event detail.

```js
addEventListener('page:before-render', async (event) => {
    event.preventDefault();

    await animateOut();

    event.detail.resume();
});
```

::: warning
Keep in mind that the **page:before-render** event may fire twice, once from cache and once again after requesting the new page content.
:::

## Global Events

The AJAX framework triggers several events during the navigation life cycle and page responses. The events are usually triggered on the `document` object with details available on the `event.detail` property.

Event | Description
------------- | -------------
**render** | triggered when the page updates via PJAX or AJAX.
**page:click** | triggered when a turbo-routed link is clicked.
**page:before-visit** | triggered before visiting a location, except when navigating using browser history.
**page:visit** | triggered after a clicked visit starts.
**page:request-start** | triggered before the request for a page.
**page:request-end** | triggered after the page request ends.
**page:before-cache** | triggered before a page is cached.
**page:before-render** | triggered before the page content is rendered.
**page:render** | triggered after the page is rendered. This is fired twice, once from cache and once again after requesting the new page content.
**page:load** | triggered once after the initial page load and again every time a page is visited.
**page:loaded** | identical to `page:load` except will wait for all newly added scripts to load.
**page:updated** | similar to `DOMContentLoaded` except triggered only when a page is visited.
**page:unload** | called when a previously loaded page should be disposed.

## Usage Examples

The following JavaScript will run every time a page loads, including scripts.

```js
addEventListener('page:loaded', function() {
    // ...
});
```

## Working with Hot Reloading

In some cases, the turbo router may interfere when you are developing your website with hot reloading or browser sync technology, such as with [Laravel Mix](https://laravel-mix.com/) in development mode using `laravel-mix & browsersync`. To overcome this add the following code to your webpack `browserSync` configuration.

```js
snippetOptions: {
    rule: {
        match: /<\/head>/i,
        fn: function (snippet, match) {
            return '<meta name="turbo-visit-control" content="disable" />';
        }
   }
}
```

#### See Also

::: also
* [Observable Controls](./hot-controls.md)
:::
---
subtitle: Design your API and update the page dynamically.
---
# Event Handlers

AJAX event handlers are API endpoints for the AJAX framework to communicate with the server. They can respond with raw data, redirect the browser or dynamically update partials on the page.

## AJAX Handlers

To create an AJAX handler, define it as a PHP function the page, partial or layout PHP section, or [inside CMS components](../themes/components.md). Handler names should use the `onSomething` pattern, for example, `onName`. All handlers support the use of [updating partials](./update-partials.md) as part of the AJAX request.

```php
function onSubmitContactForm()
{
    // ...
}
```

::: tip
If two handlers with the same name are defined in a page and layout together, the page handler will take priority. The handlers defined in components have the lowest priority.
:::

### Calling a Handler

Every AJAX request should specify a handler name, either using the [data attributes API](../ajax/attributes-api.md) or the [JavaScript API](../ajax/javascript-api.md). When the request is made, the server will search all the registered handlers and locate the first one it finds.

```html
<!-- Attributes API -->
<button data-request="onSubmitContactForm">Go</button>

<!-- JavaScript API -->
<script> oc.ajax('onSubmitContactForm') </script>
```

Handlers defined by pages, layouts and components are all registered automatically. If you are calling a handler from inside a partial, use the [`{% ajaxPartial %}` Twig tag](../../markup/tag/ajax-partial.md), which adjusts the page cycle to register its handlers.

### Form Serialization

When an AJAX request occurs inside a HTML form tag, all the input values of the form are available to the handler. In the example below, the `first_name` value will be sent with the request.

```html
<form id="myForm">
    <input name="first_name" />
    <button data-request="onSubmitContactForm">Go</button>
</form>
```

The JavaScript API support this logic with the `oc.request` function.

```html
<script> oc.request('#myForm', 'onSubmitContactForm') </script>
```

You may use the `input()` PHP function to access the variable.

```php
function onSubmitContactForm()
{
    $firstName = input('first_name');
}
```

### Generic Handler

Sometimes you may need to make an AJAX request for the sole purpose of updating page contents, not needing to execute any code. You may use the `onAjax` handler for this purpose. This handler is available everywhere without needing to write any code.

```html
<button data-request="onAjax">Do nothing</button>
```

### Component Handlers

If two components register the same handler name, it is advised to prefix the handler with the [component short name or alias](../../cms/themes/components.md). If a component uses an alias of **mycomponent** the handler can be targeted with `mycomponent::onName`.

```html
<button data-request="mycomponent::onSubmitContactForm">Go</button>
```

See the [Component Development article](../../extend/cms-components.md) to learn more.

## Redirects in AJAX Handlers

If you need to redirect the browser to another location, return the `Redirect` response object from the AJAX handler. The framework will redirect the browser as soon as the response is returned from the server. Example AJAX handler with a redirect.

```php
function onRedirectMe()
{
    return Redirect::to('http://google.com');
}
```

## Returning Data from AJAX Handlers

The response from an AJAX handler can serve as consumable API by returning structured data. If an AJAX handler returns an array, you can access its elements in the `success` event handler. Example AJAX handler that returns a data object.

```php
function onFetchDataFromServer()
{
    // Some server-side code

    return [
        'totalUsers' => 1000,
        'totalProjects' => 937
    ];
}
```

The data can be fetched with the data attributes API.

```html
<form data-request="onHandleForm" data-request-success="console.log(data)">
```

The same with the JavaScript API.

```html
<form onsubmit="oc.request(this, 'onHandleForm', {
        success: function(data) {
            console.log(data);
        }
    }); return false"
>
```

## Running Code Before Handlers

Sometimes you may want code to execute before a handler executes. Defining an `onInit` function as part of the [Layout Execution Life Cycle](../../cms/themes/layouts.md) allows code to run before every AJAX handler.

```php
function onInit()
{
    // From a page or layout PHP code section
}
```

You may define an `init` method inside a [CMS component class](../../extend/cms-components.md).

```php
function init()
{
    // From a component or widget class
}
```

## Throwing an AJAX Exception

You may throw an [AJAX exception](../../extend/system/exceptions.md) using the `AjaxException` class to treat the response as an error while retaining the ability to send response contents as normal. Simply pass the response contents as the first argument of the exception.

```php
throw new AjaxException([
    'error' => 'Not enough questions',
    'questionsNeeded' => 2
]);
```

These errors are handled by the AJAX framework.

```html
<form data-request="onHandleForm" data-request-error="console.log(data)">
```

The same with the JavaScript API.

```html
<form onsubmit="oc.request(this, 'onHandleForm', {
        error: function(data) {
            console.log(data);
        }
    }); return false"
>
```

::: tip
When throwing this exception type [partials will be updated](./update-partials.md) as normal.
:::

## Dispatching Browser Events

::: aside
Dispatched events are triggered in an AJAX response after the request completes and before partials are updated.
:::

You may dispatch JavaScript events from AJAX handlers using the `dispatchBrowserEvent` method. This method takes any event name (first argument) and detail variables to pass to the event (second argument), the variables must be compatible with JSON serialization.

```php
function onPerformAction()
{
    $this->dispatchBrowserEvent('app:update-profile');

    $this->dispatchBrowserEvent('app:update-profile', ['name' => 'Jeff']);
}
```

In the browser, use the `addEventListener` to listen for the dispatched event when the AJAX request completes. The event variables are available via the `event.detail` object.

```js
addEventListener('app:update-profile', function (event) {
    alert('Profile updated with name: ' + event.detail.name);
});
```

For example, if you want to show an alert that a document has already been updated by another user, you could dispatch an event to the browser and throw an `AjaxException` to halt the process.

::: tip
`AjaxException` and `ValidationException` are halting exceptions that support dispatched events.
```php
public function onUpdate()
{
    $this->dispatchBrowserEvent('app:stale-document');

    throw new AjaxException;
}
```
:::

You can listen to this event in the browser using a generic listener. This example prompts the user before resubmitting the request with a `force` flag set in the data.

```js
addEventListener('app:stale-document', function (event) {
    if (confirm('Another user has updated this document, proceed?')) {
        oc.request(event.target, 'onUpdate', { data: {
            force: true
        }});
    }
});
```

To prevent the partials from updating as part of the response, call `preventDefault()` on the event object.

```js
addEventListener('app:stale-document', function (event) {
    event.preventDefault();
});
```
---
subtitle: Interact with handlers using HTML attributes.
---
# Data Attributes API

The data attributes API lets you issue AJAX requests without any JavaScript. In many cases the data attributes API is less verbose than the JavaScript API - you write less code to get the same result. The supported AJAX data attributes are:

data-request Attribute | Description
------------- | -------------
**data-request** | specifies the AJAX handler name.
**data-request-confirm** | specifies a confirmation message. A confirmation dialog is displayed before the request is sent. If the user clicks the Cancel button the request isn't sent.
**data-request-redirect** | specifies a URL to redirect the browser after the successful AJAX request.
**data-request-url** | specifies a URL to which the request is sent. default: `window.location.href`
**data-request-update** | specifies a list of partials and page elements (CSS selectors) to update. The format is as follows: `partial: selector, partial: selector`. Usage of quotes is required in some cases, for example: `'my-partial': '#myelement'`. The selector string should start with a `#` or `.` character, except you may also prepend it with `@` to append contents to the element, `^` to prepend, `!` to replace with and `=` to use any CSS selector.
**data-request-data** | specifies additional POST parameters to be sent to the server. The format is following: `var: value, var: value`. Use quotes if needed: `var: 'some string'`. The attribute can be used on the triggering element, for example on the button that also has the `data-request` attribute, on the closest element of the triggering element and on the parent form element. The framework merges values of the `data-request-data` attributes. If the attribute on different elements defines parameters with the same name, the framework uses the following priority: the triggering element `data-request-data`, the closer parent elements `data-request-data`, the form input data.
**data-request-query** | specifies additional GET parameters to be sent to the server and added to the current URL query string.
**data-request-before-update** | specifies JavaScript code to execute directly before the page contents are updated.
**data-request-success** | specifies JavaScript code to execute after the request is successfully completed. The `data` variable is available in this function containing the response data.
**data-request-error** | specifies JavaScript code to execute if the request encounters an error. The `data` variable is available in this function containing the response data.
**data-request-complete** | specifies JavaScript code to execute if the request is successfully completed or encounters an error. The `data` variable is available in this function containing the response data.
**data-request-cancel** | specifies JavaScript code to execute if the user aborts the request or cancels it via a confirmation dialog.
**data-request-message** | displays a progress message with the specified text, shown while the request is running. This option is used by the [flash messages features](../features/flash-messages.md).
**data-request-loading** | specifies a CSS selector for an element to be displayed while the request runs. You can use this option to show an AJAX loading indicator. The feature uses CSS display `block` and `none` attributes to manage the element visibility.
**data-request-progress-bar** | enable the [progress bar](../features/loaders.md) when an AJAX request occurs.
**data-request-form** | explicitly specify a form element to use for sourcing the form data. If this is unspecified, the closest form to the triggering element is used, including if the element itself is a form.
**data-request-flash** | when included, instructs the server to clear and send any flash messages with the response. This option is used by the [flash messages features](../features/flash-messages.md).
**data-request-files** | when specified the request will accept file uploads using the `FormData` interface.
**data-request-download** | when specified file downloads are accepted with a `Content-Disposition` response. This attribute can be added anonymously or set to the downloaded filename.
**data-request-bulk** | when specified the request be sent as JSON for bulk data transactions.
**data-browser-target** | when specified with `data-request-download` the output will target this window, for example `_blank`.
**data-browser-validate** | when specified browser-based client side validation will run on the request before it submits.
**data-auto-submit** | automatically triggers an AJAX request on elements that also have the `data-request` attribute. The request submits when the browser window is active using the [Page Visibility API](https://developer.mozilla.org/en-US/docs/Web/API/Page_Visibility_API). The optional attribute value can define the interval, in milliseconds, the framework waits before it sends the request.
**data-track-input** | can be applied to a text, number, or password input field that also has the `data-request` attribute. When defined, the input field automatically sends an AJAX request when a user types something in the field. The optional attribute value can define the interval, in milliseconds, the framework waits before it sends the requests.

When the `data-request` attribute is specified for an element, the element triggers an AJAX request when a user interacts with it. Depending on the type of element, the request is triggered on the following events:

Element | Event
------------- | -------------
**Forms** | when the form is submitted.
**Links, buttons** | when the element is clicked.
**Text, number, and password fields** | when the text is changed and only if the `data-track-input` attribute is presented.
**Dropdowns, checkboxes, radios** | when the element is selected.

## Usage Examples

Trigger the `onCalculate` handler when the form is submitted. Update the element with the identifier "result"` with the **calcresult** partial.

```html
<form data-request="onCalculate" data-request-update="{ calcresult: '#result' }">
```

Request a confirmation when the Delete button is clicked before the request is sent.

```html
<form ... >
    ...
    <button data-request="onDelete" data-request-confirm="Are you sure?">Delete</button>
```

Redirect to another page after the successful request.

```html
<form data-request="onLogin" data-request-redirect="/admin">
```

Show a popup window after the successful request.

```html
<form data-request="onLogin" data-request-success="alert('Yay!')">
```

Send a POST parameter `mode` with a value `update`.

```html
<form data-request="onUpdate" data-request-data="{ mode: 'update' }">
```

Send a POST parameter `id` with value `7` across multiple elements.

```html
<div data-request-data="{ id: 7 }">
    <button data-request="onDelete">Delete</button>
    <button data-request="onSave">Update</button>
</div>
```

Send a GET parameter `page` with value `6` on the current request.

```html
<button data-request="onSetPage" data-request-query="{ page: 6 }">
    Page 6
</button>
```

Show a [flash message](../features/flash-messages.md) while the request is loading.

```html
<button data-request="onUpdate" data-request-message="Loading...">
    Save Changes
</button>
```

Including [file uploads](../../extend/services/request-input.md) with a request.

```html
<form data-request="onSubmit" data-request-files>
    <input type="file" name="photo" accept="image/*" />
    <button type="submit">Submit</button>
</form>
```

Including [file downloads](../../extend/services/response-view.md) with a response.

```html
<button data-request="onDownloadFile" data-request-download>
    Download
</button>
```

To specify a custom filename and open the download in a new window, such as previewing a PDF.

```html
<button
    data-request="onDownloadFile"
    data-request-download="sample.pdf"
    data-browser-target="_blank">
    Download
</button>
```
# Providers

Media Manager uses the Local Disk provider by default. You need to install the Flysystem S3 package before you can use Amazon S3 features.

```bash
composer require league/flysystem-aws-s3-v3 "^3.0"
```

After you change Media Manager configuration, you should reset its cache. You can do that with pressing the **Refresh** button in the Media Manager toolbar.

## Local Disk

By default Media Manager works with the **storage/app/media** subdirectory of the installation directory. In order to use Amazon S3, you should update the system configuration found in the **config/filesystems.php** config file and follow the instructions found in this article.

```php
'media' => [
    'driver' => 'local',
    'root' => storage_path('app/media'),
    'url' => '/storage/app/media',
    'visibility' => 'public',
    'throw' => false,
],
```

## Configuring Amazon S3 access

To use Amazon S3 with October CMS, you should create S3 bucket, folder in the bucket and API user.

Sign up for Amazon AWS account or sign in with your existing account to AWS Console. Open S3 management panel. Create a new bucket and assign it any name (the name of the bucket will be a part of your public file URLs).

By default files in S3 buckets cannot be accessed directly. To make the bucket public, return to the bucket list and click the bucket. Click **Properties** button in the right sidebar. Expand **Permissions** tab. Click **Edit bucket policy** link. Paste the following code to the policy popup window. Replace the bucket name with your actual bucket name:

```json
{
    "Version": "2008-10-17",
    "Id": "Policy1397632521960",
    "Statement": [
        {
            "Sid": "Stmt1397633323327",
            "Effect": "Allow",
            "Principal": {
                "AWS": "*"
            },
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::BUCKETNAME/*"
        }
    ]
}
```

Click **Save** button to apply the policy. The policy gives public read-only access to all folders and directories in the bucket. If you're going to use the bucket for other needs, it's possible to setup a public access to a specific folder in the bucket, just specify the directory name in the **Resource** value:

```
"arn:aws:s3:::BUCKETNAME/media/*"
```

You should also create an API user that October CMS will use for managing the bucket files. In AWS console go to IAM section. Go to Users tab and create a new user. The user name doesn't matter. Make sure that "Generate an access key for each user" checkbox is checked when you create a new user. After AWS creates a user, it allows you to see the security credentials - the user **Access Key ID** and **Secret Access Key**. Copy the keys and put them into a temporary text file.

Return to the user list and click the user you just created. In the **Permissions** section click **Attach Policy** button. Select **AmazonS3FullAccess** policy in the list and click **Attach Policy** button.

Now you have all the information to update October CMS configuration. Open **config/filesystems.php** script and find the **disks** section. It already contains media configuration, you need to change the `driver` to **s3** and replace the API credentials and bucket information parameters:

Parameter | Value
------------- | -------------
**driver** | the storage driver to use, local or s3.
**key** | the **Access Key ID** value of the user that you created before.
**secret** | the **Secret Access Key** value of the user that you created fore.
**bucket** | your bucket name.
**region** | the bucket region code, see below.
**url** | the public path of the folder in the bucket, see below.

You can find the bucket region in S3 management console, in the bucket properties. The Properties tab displays the region name, for example Oregon. S3 driver configuration requires a bucket code. Use this table to find code for your bucket. You can also take a look at [AWS documentation](http://docs.aws.amazon.com/general/latest/gr/rande.html#s3_region).

Region | Code
------------- | -------------
**US East (Ohio)** | us-east-2
**US East (N. Virginia)** | us-east-1
**US West (N. California)** | us-west-1
**US West (Oregon)** | us-west-2
**Asia Pacific (Hong Kong)** | ap-east-1
**Asia Pacific (Mumbai)** | ap-south-1
**Asia Pacific (Osaka-Local)** | ap-northeast-3
**Asia Pacific (Seoul)** | ap-northeast-2
**Asia Pacific (Singapore)** | ap-southeast-1
**Asia Pacific (Sydney)** | ap-southeast-2
**Asia Pacific (Tokyo)** | ap-northeast-1
**Canada (Central)** | ca-central-1
**China (Beijing)** | cn-north-1
**China (Ningxia)** | cn-northwest-1
**EU (Frankfurt)** | eu-central-1
**EU (Ireland)** | eu-west-1
**EU (London)** | eu-west-2
**EU (Paris)** | eu-west-3
**EU (Stockholm)** | eu-north-1
**South America (São Paulo)** | sa-east-1
**Middle East (Bahrain)** | me-south-1

To obtain the URL of the folder, open AWS console and go to S3 section. Navigate to the bucket and click the folder you created before. Upload any file to the folder and click the file. Click **Properties** button in the right sidebar. The file URL is in the **Link** parameter. Copy the URL and remove the file name and the trailing slash from it.

Example configuration after update:

```php
'disks' => [
    // ...
    'media' => [
        'driver' => 's3',
        'key'    => 'XXXXXXXXXXXXXXXXXXXX',
        'secret' => 'xxxXxXX+XxxxxXXxXxxxxxxXxxXXXXXXXxxxX9Xx',
        'region' => 'us-west-2',
        'bucket' => 'my-bucket',
        'url' => 'https://s3-us-west-2.amazonaws.com/your-bucket-name',
        'visibility' => 'public',
        'throw' => false
    ],
    // ...
]
```

Save the **config/filesystems.php** script and congratulations! Now you're ready to use Amazon S3 with October CMS. Note that you can also configure Amazon CloudFront CDN  to work with your bucket. This topic is not covered in this document, please refer to [CloudFront documentation](http://aws.amazon.com/cloudfront/). After you configure CloudFront, you will need to update the **url** parameter in the filesystems configuration.

## Troubleshooting

The most common issue with using remote services is the SSL connection problem. If you get SSL errors, make sure that your server has fresh SSL certificates of public Certificate Authorities (CA).
# Introduction

October CMS ships with a media manager built in, making it easy to publish larger assets such as video and photos. These assets can then be inserted to your pages and content files via the user interface.

![image](https://github.com/octobercms/docs/blob/develop/images/media-manager.png?raw=true)

## Linking to Media

In most cases the complete URL will be used when inserting media assets in to your content. However, it is also possible to generate these URLs from their relative paths in the media directory using the `|media` [Twig filter](../../markup/filter/media.md).

```twig
{{ 'relative/path/to/asset.jpg'|media }}
```

::: tip
View the [Media filter article](../../markup/filter/media.md) to learn more.
:::

## Configuration Options

There are several options that allow you to fine-tune the Media Manager, which are defined in **config/media.php** file.

```php
/*
|--------------------------------------------------------------------------
| Ignored Files and Patterns
|--------------------------------------------------------------------------
|
| The media manager wil ignore file names and patterns specified here
|
*/

'ignore_files' => ['.svn', '.git', '.DS_Store', '.AppleDouble'],

'ignore_patterns' => ['^\..*'],
```

The configuration that specifies where media files are kept is in the system configuration file, see the [Providers article](./providers.md) on using third party providers such as Amazon S3.

## Audio and Video Players

By default the system uses HTML5 audio and video tags to render audio and video files:

```html
<video src="video.mp4" controls></video>
```

or

```html
<audio src="audio.mp3" controls></audio>
```

This behavior can be overridden. If there are **oc-audio-player.htm** and **oc-video-player.htm** CMS partials, they will be used for displaying audio and video contents. Inside the partials use the variable **src** to output a link to the source file. Example:

```html
<video src="{{ src }}" width="320" height="200" controls preload></video>
```

If you don't want to use HTML5 player you can provide any other markup in the partials. There's a [third-party script](https://html5media.info/) that enables support of HTML5 video and audio tags in older browsers.

As the partials are written with Twig, you can automate adding alternative video sources based on a naming convention. For example, if there's a convention that there's always a smaller resolution video for each full resolution video, and the smaller resolution file has extension "iphone.mp4", the generated markup could look like this:

```twig
<video controls>
    <source
        src="{{ src }}"
        media="only screen and (min-device-width: 568px)"></source>
    <source
        src="{{ src|replace({'.mp4': '.iphone.mp4'}) }}"
        media="only screen and (max-device-width: 568px)"></source>
</video>
```

## Events

The Media Manager provides [a few events](../../extend/extending.md) that you can listen for in order to improve extensibility.

Event | Description | Parameters
------------- | ------------- | -------------
**folder.delete** | Called when a folder is deleted | `(string) $path`
**file.delete** | Called when a file is deleted | `(string) $path`
**folder.rename** | Called when a folder is renamed | `(string) $originalPath`, `(string) $newPath`
**file.rename** | Called when a file is renamed | `(string) $originalPath`, `(string) $newPath`
**folder.create** | Called when a folder is created | `(string) $newFolderPath`
**folder.move** | Called when a folder is moved | `(string) $path`, `(string) $dest`
**file.move** | Called when a file is moved | `(string) $path`, `(string) $dest`
**file.upload** | Called when a file is uploaded | `(string) $filePath`, `(\Symfony\Component\HttpFoundation\File\UploadedFile) $uploadedFile`

To hook into these events, either extend the `Media\Widgets\MediaManager` class directly.

```php
Media\Widgets\MediaManager::extend(function($widget) {
    $widget->bindEvent('file.rename', function ($originalPath, $newPath) {
        // Update custom references to path here
    });
});
```

Or listen globally via the `Event` facade (each event is prefixed with `media.` and will be passed the instantiated `Media\Widgets\MediaManager` object as the first parameter).

```php
Event::listen('media.file.rename', function($widget, $originalPath, $newPath) {
    // Update custom references to path here
});
```
